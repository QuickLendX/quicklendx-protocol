<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","lib.rs"],"content":"#![no_std]\nuse soroban_sdk::{contract, contractimpl, vec, Env, String, Vec};\n\n#[contract]\npub struct Contract;\n\n// This is a sample contract. Replace this placeholder with your own contract logic.\n// A corresponding test example is available in `test.rs`.\n//\n// For comprehensive examples, visit \u003chttps://github.com/stellar/soroban-examples\u003e.\n// The repository includes use cases for the Stellar ecosystem, such as data storage on\n// the blockchain, token swaps, liquidity pools, and more.\n//\n// Refer to the official documentation:\n// \u003chttps://developers.stellar.org/docs/build/smart-contracts/overview\u003e.\n#[contractimpl]\nimpl Contract {\n    pub fn hello(env: Env, to: String) -\u003e Vec\u003cString\u003e {\n        vec![\u0026env, String::from_str(\u0026env, \"Hello\"), to]\n    }\n}\n\nmod test;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","analytics.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::invoice::{InvoiceCategory, InvoiceStatus};\nuse soroban_sdk::{contracttype, symbol_short, Address, Bytes, BytesN, Env, String, Vec};\n\n/// Time period for analytics reports\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum TimePeriod {\n    Daily,\n    Weekly,\n    Monthly,\n    Quarterly,\n    Yearly,\n    AllTime,\n}\n\n/// Platform metrics structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct PlatformMetrics {\n    pub total_invoices: u32,\n    pub total_investments: u32,\n    pub total_volume: i128,\n    pub total_fees_collected: i128,\n    pub active_investors: u32,\n    pub verified_businesses: u32,\n    pub average_invoice_amount: i128,\n    pub average_investment_amount: i128,\n    pub platform_fee_rate: i128,\n    pub default_rate: i128,\n    pub success_rate: i128,\n    pub timestamp: u64,\n}\n\n/// User behavior analytics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct UserBehaviorMetrics {\n    pub user_address: Address,\n    pub total_invoices_uploaded: u32,\n    pub total_investments_made: u32,\n    pub total_bids_placed: u32,\n    pub average_bid_amount: i128,\n    pub average_investment_amount: i128,\n    pub success_rate: i128,\n    pub default_rate: i128,\n    pub last_activity: u64,\n    pub preferred_categories: Vec\u003cInvoiceCategory\u003e,\n    pub risk_score: u32,\n}\n\n/// Financial analytics structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct FinancialMetrics {\n    pub total_volume: i128,\n    pub total_fees: i128,\n    pub total_profits: i128,\n    pub average_return_rate: i128,\n    pub volume_by_category: Vec\u003c(InvoiceCategory, i128)\u003e,\n    pub volume_by_period: Vec\u003c(TimePeriod, i128)\u003e,\n    pub fee_breakdown: Vec\u003c(String, i128)\u003e,\n    pub profit_margins: Vec\u003c(String, i128)\u003e,\n    pub currency_distribution: Vec\u003c(Address, i128)\u003e,\n}\n\n/// Performance tracking metrics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct PerformanceMetrics {\n    pub platform_uptime: u64,\n    pub average_settlement_time: u64,\n    pub average_verification_time: u64,\n    pub dispute_resolution_time: u64,\n    pub system_response_time: u64,\n    pub transaction_success_rate: i128,\n    pub error_rate: i128,\n    pub user_satisfaction_score: u32,\n    pub platform_efficiency: i128,\n}\n\n/// Business report structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct BusinessReport {\n    pub report_id: BytesN\u003c32\u003e,\n    pub business_address: Address,\n    pub period: TimePeriod,\n    pub start_date: u64,\n    pub end_date: u64,\n    pub invoices_uploaded: u32,\n    pub invoices_funded: u32,\n    pub total_volume: i128,\n    pub average_funding_time: u64,\n    pub success_rate: i128,\n    pub default_rate: i128,\n    pub category_breakdown: Vec\u003c(InvoiceCategory, u32)\u003e,\n    pub rating_average: Option\u003cu32\u003e,\n    pub total_ratings: u32,\n    pub generated_at: u64,\n}\n\n/// Investor report structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvestorReport {\n    pub report_id: BytesN\u003c32\u003e,\n    pub investor_address: Address,\n    pub period: TimePeriod,\n    pub start_date: u64,\n    pub end_date: u64,\n    pub investments_made: u32,\n    pub total_invested: i128,\n    pub total_returns: i128,\n    pub average_return_rate: i128,\n    pub success_rate: i128,\n    pub default_rate: i128,\n    pub preferred_categories: Vec\u003c(InvoiceCategory, u32)\u003e,\n    pub risk_tolerance: u32,\n    pub portfolio_diversity: i128,\n    pub generated_at: u64,\n}\n\n/// Enhanced investor analytics structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvestorAnalytics {\n    pub investor_address: Address,\n    pub tier: crate::verification::InvestorTier,\n    pub risk_level: crate::verification::InvestorRiskLevel,\n    pub risk_score: u32,\n    pub investment_limit: i128,\n    pub total_invested: i128,\n    pub total_returns: i128,\n    pub successful_investments: u32,\n    pub defaulted_investments: u32,\n    pub success_rate: i128,\n    pub average_investment_size: i128,\n    pub portfolio_diversity_score: u32,\n    pub preferred_categories: Vec\u003c(InvoiceCategory, u32)\u003e,\n    pub last_activity: u64,\n    pub account_age: u64,\n    pub compliance_score: u32,\n    pub generated_at: u64,\n}\n\n/// Investor performance metrics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvestorPerformanceMetrics {\n    pub total_investors: u32,\n    pub verified_investors: u32,\n    pub pending_investors: u32,\n    pub rejected_investors: u32,\n    pub investors_by_tier: Vec\u003c(crate::verification::InvestorTier, u32)\u003e,\n    pub investors_by_risk: Vec\u003c(crate::verification::InvestorRiskLevel, u32)\u003e,\n    pub total_investment_volume: i128,\n    pub average_investment_size: i128,\n    pub platform_success_rate: i128,\n    pub average_risk_score: u32,\n    pub top_performing_investors: Vec\u003cAddress\u003e,\n    pub generated_at: u64,\n}\n\n/// Analytics storage structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AnalyticsData {\n    pub platform_metrics: PlatformMetrics,\n    pub performance_metrics: PerformanceMetrics,\n    pub last_updated: u64,\n    pub data_points: Vec\u003c(u64, PlatformMetrics)\u003e,\n}\n\npub struct AnalyticsStorage;\n\nimpl AnalyticsStorage {\n    fn platform_metrics_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"plt_met\"),)\n    }\n\n    fn performance_metrics_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"perf_met\"),)\n    }\n\n    fn user_behavior_key(user: \u0026Address) -\u003e (soroban_sdk::Symbol, Address) {\n        (symbol_short!(\"usr_beh\"), user.clone())\n    }\n\n    fn business_report_key(report_id: \u0026BytesN\u003c32\u003e) -\u003e (soroban_sdk::Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"biz_rpt\"), report_id.clone())\n    }\n\n    fn investor_report_key(report_id: \u0026BytesN\u003c32\u003e) -\u003e (soroban_sdk::Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"inv_rpt\"), report_id.clone())\n    }\n\n    fn investor_analytics_key(investor: \u0026Address) -\u003e (soroban_sdk::Symbol, Address) {\n        (symbol_short!(\"inv_anal\"), investor.clone())\n    }\n\n    fn investor_performance_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"inv_perf\"),)\n    }\n\n    fn analytics_data_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"analytics\"),)\n    }\n\n    pub fn store_platform_metrics(env: \u0026Env, metrics: \u0026PlatformMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::platform_metrics_key(), metrics);\n    }\n\n    pub fn get_platform_metrics(env: \u0026Env) -\u003e Option\u003cPlatformMetrics\u003e {\n        env.storage().instance().get(\u0026Self::platform_metrics_key())\n    }\n\n    pub fn store_performance_metrics(env: \u0026Env, metrics: \u0026PerformanceMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::performance_metrics_key(), metrics);\n    }\n\n    pub fn get_performance_metrics(env: \u0026Env) -\u003e Option\u003cPerformanceMetrics\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::performance_metrics_key())\n    }\n\n    pub fn store_user_behavior(env: \u0026Env, user: \u0026Address, behavior: \u0026UserBehaviorMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::user_behavior_key(user), behavior);\n    }\n\n    pub fn store_business_report(env: \u0026Env, report: \u0026BusinessReport) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::business_report_key(\u0026report.report_id), report);\n    }\n\n    pub fn get_business_report(env: \u0026Env, report_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBusinessReport\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::business_report_key(report_id))\n    }\n\n    pub fn store_investor_report(env: \u0026Env, report: \u0026InvestorReport) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::investor_report_key(\u0026report.report_id), report);\n    }\n\n    pub fn get_investor_report(env: \u0026Env, report_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvestorReport\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::investor_report_key(report_id))\n    }\n\n    pub fn store_investor_analytics(env: \u0026Env, investor: \u0026Address, analytics: \u0026InvestorAnalytics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::investor_analytics_key(investor), analytics);\n    }\n\n    pub fn get_investor_analytics(env: \u0026Env, investor: \u0026Address) -\u003e Option\u003cInvestorAnalytics\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::investor_analytics_key(investor))\n    }\n\n    pub fn store_investor_performance(env: \u0026Env, metrics: \u0026InvestorPerformanceMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::investor_performance_key(), metrics);\n    }\n\n    pub fn get_investor_performance(env: \u0026Env) -\u003e Option\u003cInvestorPerformanceMetrics\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::investor_performance_key())\n    }\n\n    pub fn generate_report_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let sequence = env.ledger().sequence();\n        let _combined = timestamp.wrapping_add(sequence as u64);\n        let bytes = Bytes::new(env);\n        let hash = env.crypto().sha256(\u0026bytes);\n        BytesN::from_array(\u0026env, \u0026hash.to_array())\n    }\n}\n\n/// Analytics calculation functions\npub struct AnalyticsCalculator;\n\nimpl AnalyticsCalculator {\n    /// Calculate comprehensive platform metrics\n    pub fn calculate_platform_metrics(env: \u0026Env) -\u003e Result\u003cPlatformMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Get all invoices by status\n        let pending_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Pending);\n        let verified_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Verified);\n        let funded_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Funded);\n        let paid_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Paid);\n        let defaulted_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Defaulted);\n\n        let total_invoices = (pending_invoices.len()\n            + verified_invoices.len()\n            + funded_invoices.len()\n            + paid_invoices.len()\n            + defaulted_invoices.len()) as u32;\n\n        // Calculate total volume\n        let mut total_volume = 0i128;\n        for invoice_id in [\n            \u0026pending_invoices,\n            \u0026verified_invoices,\n            \u0026funded_invoices,\n            \u0026paid_invoices,\n            \u0026defaulted_invoices,\n        ]\n        .iter()\n        {\n            for id in invoice_id.iter() {\n                if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026id) {\n                    total_volume = total_volume.saturating_add(invoice.amount);\n                }\n            }\n        }\n\n        // Calculate total investments by counting funded invoices\n        let total_investments = funded_invoices.len() as u32;\n\n        // Calculate total fees collected\n        let mut total_fees = 0i128;\n        for invoice_id in paid_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if let Some(investment) =\n                    crate::investment::InvestmentStorage::get_investment_by_invoice(\n                        env,\n                        \u0026invoice_id,\n                    )\n                {\n                    let (_, platform_fee) =\n                        crate::profits::calculate_profit(env, investment.amount, invoice.amount);\n                    total_fees = total_fees.saturating_add(platform_fee);\n                }\n            }\n        }\n\n        // Count active investors (simplified - would need proper tracking)\n        let active_investors = 0u32; // Placeholder - would need investor tracking\n\n        // Count verified businesses\n        let verified_businesses =\n            crate::verification::BusinessVerificationStorage::get_verified_businesses(env);\n        let verified_businesses_count = verified_businesses.len() as u32;\n\n        // Calculate averages\n        let average_invoice_amount = if total_invoices \u003e 0 {\n            total_volume.saturating_div(total_invoices as i128)\n        } else {\n            0\n        };\n\n        let average_investment_amount = if total_investments \u003e 0 {\n            let mut total_invested = 0i128;\n            for invoice_id in funded_invoices.iter() {\n                if let Some(investment) =\n                    crate::investment::InvestmentStorage::get_investment_by_invoice(\n                        env,\n                        \u0026invoice_id,\n                    )\n                {\n                    total_invested = total_invested.saturating_add(investment.amount);\n                }\n            }\n            total_invested.saturating_div(total_investments as i128)\n        } else {\n            0\n        };\n\n        // Get platform fee rate\n        let platform_fee_config = crate::profits::PlatformFee::get_config(env);\n        let platform_fee_rate = platform_fee_config.fee_bps;\n\n        // Calculate default rate\n        let _current_timestamp = env.ledger().timestamp();\n        let default_rate = if total_investments \u003e 0 {\n            let defaulted_count = defaulted_invoices.len() as u32;\n            (defaulted_count.saturating_mul(10000)).saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        // Calculate success rate\n        let success_rate = if total_investments \u003e 0 {\n            let successful_count = paid_invoices.len() as u32;\n            (successful_count.saturating_mul(10000)).saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        Ok(PlatformMetrics {\n            total_invoices,\n            total_investments,\n            total_volume,\n            total_fees_collected: total_fees,\n            active_investors,\n            verified_businesses: verified_businesses_count,\n            average_invoice_amount,\n            average_investment_amount,\n            platform_fee_rate,\n            default_rate,\n            success_rate,\n            timestamp: current_timestamp,\n        })\n    }\n\n    /// Calculate user behavior metrics\n    pub fn calculate_user_behavior_metrics(\n        env: \u0026Env,\n        user: \u0026Address,\n    ) -\u003e Result\u003cUserBehaviorMetrics, QuickLendXError\u003e {\n        let _current_timestamp = env.ledger().timestamp();\n\n        // Get user's invoices\n        let user_invoices = crate::invoice::InvoiceStorage::get_business_invoices(env, user);\n        let total_invoices_uploaded = user_invoices.len() as u32;\n\n        // Get user's investments (simplified - would need proper tracking)\n        let total_investments_made = 0u32; // Placeholder - would need investor tracking\n\n        // Get user's bids (simplified - would need proper tracking)\n        let total_bids_placed = 0u32;\n        let total_bid_amount = 0i128;\n\n        let average_bid_amount = if total_bids_placed \u003e 0 {\n            total_bid_amount.saturating_div(total_bids_placed as i128)\n        } else {\n            0\n        };\n\n        let average_investment_amount = 0i128; // Placeholder\n\n        // Calculate success and default rates (simplified)\n        let preferred_categories = Vec::new(env);\n\n        let success_rate = 0i128; // Placeholder\n\n        let default_rate = 0i128; // Placeholder\n\n        // Calculate risk score based on default rate and investment patterns\n        let risk_score = if default_rate \u003e 1000 {\n            // \u003e 10%\n            100\n        } else if default_rate \u003e 500 {\n            // \u003e 5%\n            75\n        } else if default_rate \u003e 200 {\n            // \u003e 2%\n            50\n        } else {\n            25\n        };\n\n        // Find last activity\n        let mut last_activity = 0u64;\n        for invoice_id in user_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.created_at \u003e last_activity {\n                    last_activity = invoice.created_at;\n                }\n            }\n        }\n\n        Ok(UserBehaviorMetrics {\n            user_address: user.clone(),\n            total_invoices_uploaded,\n            total_investments_made,\n            total_bids_placed,\n            average_bid_amount,\n            average_investment_amount,\n            success_rate,\n            default_rate,\n            last_activity,\n            preferred_categories,\n            risk_score,\n        })\n    }\n\n    /// Calculate financial metrics\n    pub fn calculate_financial_metrics(\n        env: \u0026Env,\n        period: TimePeriod,\n    ) -\u003e Result\u003cFinancialMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let (start_date, end_date) = Self::get_period_dates(current_timestamp, period.clone());\n\n        let mut total_volume = 0i128;\n        let mut total_fees = 0i128;\n        let mut total_profits = 0i128;\n        let mut volume_by_category = Vec::new(env);\n        let mut currency_distribution = Vec::new(env);\n\n        // Initialize category tracking\n        let categories = [\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ];\n\n        for category in categories.iter() {\n            volume_by_category.push_back((category.clone(), 0i128));\n        }\n\n        // Get all invoices in the period by combining all statuses\n        let mut all_invoices = Vec::new(env);\n        for status in [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n        ]\n        .iter()\n        {\n            let invoices = crate::invoice::InvoiceStorage::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                all_invoices.push_back(invoice_id);\n            }\n        }\n        for invoice_id in all_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.created_at \u003e= start_date \u0026\u0026 invoice.created_at \u003c= end_date {\n                    total_volume = total_volume.saturating_add(invoice.amount);\n\n                    // Update category volume\n                    for i in 0..volume_by_category.len() {\n                        let (cat, vol) = volume_by_category.get(i).unwrap();\n                        if cat == invoice.category {\n                            volume_by_category.set(i, (cat, vol.saturating_add(invoice.amount)));\n                            break;\n                        }\n                    }\n\n                    // Track currency distribution\n                    let mut found_currency = false;\n                    for i in 0..currency_distribution.len() {\n                        let (curr, amount): (Address, i128) = currency_distribution.get(i).unwrap();\n                        if curr == invoice.currency {\n                            currency_distribution\n                                .set(i, (curr, amount.saturating_add(invoice.amount)));\n                            found_currency = true;\n                            break;\n                        }\n                    }\n                    if !found_currency {\n                        currency_distribution.push_back((invoice.currency.clone(), invoice.amount));\n                    }\n\n                    // Calculate fees and profits for paid invoices\n                    if invoice.status == InvoiceStatus::Paid {\n                        if let Some(investment) =\n                            crate::investment::InvestmentStorage::get_investment_by_invoice(\n                                env,\n                                \u0026invoice_id,\n                            )\n                        {\n                            let (profit, platform_fee) = crate::profits::calculate_profit(\n                                env,\n                                investment.amount,\n                                invoice.amount,\n                            );\n                            total_fees = total_fees.saturating_add(platform_fee);\n                            total_profits = total_profits.saturating_add(profit);\n                        }\n                    }\n                }\n            }\n        }\n\n        // Calculate average return rate\n        let average_return_rate = if total_volume \u003e 0 {\n            total_profits\n                .saturating_mul(10000)\n                .saturating_div(total_volume)\n        } else {\n            0\n        };\n\n        // Create fee breakdown\n        let mut fee_breakdown = Vec::new(env);\n        fee_breakdown.push_back((String::from_str(env, \"platform_fees\"), total_fees));\n\n        // Create profit margins\n        let mut profit_margins = Vec::new(env);\n        profit_margins.push_back((String::from_str(env, \"gross_profit\"), total_profits));\n        profit_margins.push_back((\n            String::from_str(env, \"net_profit\"),\n            total_profits.saturating_sub(total_fees),\n        ));\n\n        // Create volume by period (simplified for this implementation)\n        let mut volume_by_period = Vec::new(env);\n        volume_by_period.push_back((period, total_volume));\n\n        Ok(FinancialMetrics {\n            total_volume,\n            total_fees,\n            total_profits,\n            average_return_rate,\n            volume_by_category,\n            volume_by_period,\n            fee_breakdown,\n            profit_margins,\n            currency_distribution,\n        })\n    }\n\n    /// Calculate performance metrics\n    pub fn calculate_performance_metrics(env: \u0026Env) -\u003e Result\u003cPerformanceMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Calculate average settlement time (simplified)\n        let total_settlement_time = 0u64;\n        let settlement_count = 0u32;\n\n        let average_settlement_time = if settlement_count \u003e 0 {\n            total_settlement_time.saturating_div(settlement_count as u64)\n        } else {\n            0\n        };\n\n        // Calculate average verification time (simplified)\n        let total_verification_time = 0u64;\n        let verification_count = 0u32;\n\n        let average_verification_time = if verification_count \u003e 0 {\n            total_verification_time.saturating_div(verification_count as u64)\n        } else {\n            0\n        };\n\n        // Calculate dispute resolution time\n        let mut total_dispute_time = 0u64;\n        let mut dispute_count = 0u32;\n        let invoices_with_disputes = crate::defaults::get_invoices_with_disputes(env);\n\n        for invoice_id in invoices_with_disputes.iter() {\n            if let Some(dispute) =\n                crate::defaults::get_dispute_details(env, \u0026invoice_id).unwrap_or(None)\n            {\n                if dispute.resolved_at \u003e 0 {\n                    let resolution_time = dispute.resolved_at.saturating_sub(dispute.created_at);\n                    total_dispute_time = total_dispute_time.saturating_add(resolution_time);\n                    dispute_count += 1;\n                }\n            }\n        }\n\n        let dispute_resolution_time = if dispute_count \u003e 0 {\n            total_dispute_time.saturating_div(dispute_count as u64)\n        } else {\n            0\n        };\n\n        // Calculate transaction success rate\n        let mut total_transactions = 0u32;\n        let mut successful_transactions = 0u32;\n        for status in [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n        ]\n        .iter()\n        {\n            let count =\n                crate::invoice::InvoiceStorage::get_invoices_by_status(env, status).len() as u32;\n            total_transactions += count;\n            if *status == InvoiceStatus::Paid {\n                successful_transactions = count;\n            }\n        }\n        let transaction_success_rate = if total_transactions \u003e 0 {\n            (successful_transactions.saturating_mul(10000)).saturating_div(total_transactions)\n                as i128\n        } else {\n            0\n        };\n\n        // Calculate error rate (simplified)\n        let defaulted_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Defaulted);\n        let error_rate = if total_transactions \u003e 0 {\n            (defaulted_invoices.len() as u32)\n                .saturating_mul(10000)\n                .saturating_div(total_transactions) as i128\n        } else {\n            0\n        };\n\n        // Calculate user satisfaction score (based on ratings)\n        let mut total_rating = 0u32;\n        let mut rating_count = 0u32;\n        let _invoices_with_ratings =\n            crate::invoice::InvoiceStorage::get_invoices_with_ratings_count(env);\n\n        // Get paid invoices for rating calculation\n        let paid_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Paid);\n        for invoice_id in paid_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if let Some(avg_rating) = invoice.average_rating {\n                    total_rating = total_rating.saturating_add(avg_rating);\n                    rating_count += 1;\n                }\n            }\n        }\n\n        let user_satisfaction_score = if rating_count \u003e 0 {\n            total_rating.saturating_div(rating_count)\n        } else {\n            0\n        };\n\n        // Calculate platform efficiency\n        let platform_efficiency = {\n            let fee_config = crate::profits::PlatformFee::get_config(env);\n            fee_config.fee_bps\n        };\n\n        Ok(PerformanceMetrics {\n            platform_uptime: current_timestamp, // Simplified - would need more complex tracking\n            average_settlement_time,\n            average_verification_time,\n            dispute_resolution_time,\n            system_response_time: 0, // Would need system-level tracking\n            transaction_success_rate,\n            error_rate,\n            user_satisfaction_score,\n            platform_efficiency,\n        })\n    }\n\n    /// Generate business report\n    pub fn generate_business_report(\n        env: \u0026Env,\n        business: \u0026Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cBusinessReport, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let (start_date, end_date) = Self::get_period_dates(current_timestamp, period.clone());\n        let report_id = AnalyticsStorage::generate_report_id(env);\n\n        // Get business invoices in the period\n        let all_invoices = crate::invoice::InvoiceStorage::get_business_invoices(env, business);\n        let mut invoices_uploaded = 0u32;\n        let mut invoices_funded = 0u32;\n        let mut total_volume = 0i128;\n        let mut total_funding_time = 0u64;\n        let mut successful_invoices = 0u32;\n        let mut defaulted_invoices = 0u32;\n        let mut category_breakdown = Vec::new(env);\n        let mut total_rating = 0u32;\n        let mut rating_count = 0u32;\n\n        // Initialize category tracking\n        let categories = [\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ];\n\n        for category in categories.iter() {\n            category_breakdown.push_back((category.clone(), 0u32));\n        }\n\n        for invoice_id in all_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.created_at \u003e= start_date \u0026\u0026 invoice.created_at \u003c= end_date {\n                    invoices_uploaded += 1;\n                    total_volume = total_volume.saturating_add(invoice.amount);\n\n                    // Update category breakdown\n                    for i in 0..category_breakdown.len() {\n                        let (cat, count) = category_breakdown.get(i).unwrap();\n                        if cat == invoice.category {\n                            category_breakdown.set(i, (cat, count.saturating_add(1)));\n                            break;\n                        }\n                    }\n\n                    // Track funding and success\n                    if invoice.status == InvoiceStatus::Funded\n                        || invoice.status == InvoiceStatus::Paid\n                    {\n                        invoices_funded += 1;\n                        if let Some(investment) =\n                            crate::investment::InvestmentStorage::get_investment_by_invoice(\n                                env,\n                                \u0026invoice_id,\n                            )\n                        {\n                            let funding_time =\n                                investment.funded_at.saturating_sub(invoice.created_at);\n                            total_funding_time = total_funding_time.saturating_add(funding_time);\n                        }\n                    }\n\n                    match invoice.status {\n                        InvoiceStatus::Paid =\u003e successful_invoices += 1,\n                        InvoiceStatus::Defaulted =\u003e defaulted_invoices += 1,\n                        _ =\u003e {}\n                    }\n\n                    // Track ratings\n                    if let Some(avg_rating) = invoice.average_rating {\n                        total_rating = total_rating.saturating_add(avg_rating);\n                        rating_count += 1;\n                    }\n                }\n            }\n        }\n\n        let average_funding_time = if invoices_funded \u003e 0 {\n            total_funding_time.saturating_div(invoices_funded as u64)\n        } else {\n            0\n        };\n\n        let success_rate = if invoices_uploaded \u003e 0 {\n            (successful_invoices.saturating_mul(10000)).saturating_div(invoices_uploaded) as i128\n        } else {\n            0\n        };\n\n        let default_rate = if invoices_uploaded \u003e 0 {\n            (defaulted_invoices.saturating_mul(10000)).saturating_div(invoices_uploaded) as i128\n        } else {\n            0\n        };\n\n        let rating_average = if rating_count \u003e 0 {\n            Some(total_rating.saturating_div(rating_count))\n        } else {\n            None\n        };\n\n        Ok(BusinessReport {\n            report_id,\n            business_address: business.clone(),\n            period,\n            start_date,\n            end_date,\n            invoices_uploaded,\n            invoices_funded,\n            total_volume,\n            average_funding_time,\n            success_rate,\n            default_rate,\n            category_breakdown,\n            rating_average,\n            total_ratings: rating_count,\n            generated_at: current_timestamp,\n        })\n    }\n\n    /// Generate investor report\n    pub fn generate_investor_report(\n        env: \u0026Env,\n        investor: \u0026Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cInvestorReport, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let (start_date, end_date) = Self::get_period_dates(current_timestamp, period.clone());\n        let report_id = AnalyticsStorage::generate_report_id(env);\n\n        // Get investor's investments in the period (simplified)\n        let all_investments: Vec\u003ccrate::investment::Investment\u003e = Vec::new(env); // Placeholder - would need proper tracking\n        let mut investments_made = 0u32;\n        let mut total_invested = 0i128;\n        let mut total_returns = 0i128;\n        let mut successful_investments = 0u32;\n        let mut defaulted_investments = 0u32;\n        let mut preferred_categories = Vec::new(env);\n\n        // Initialize category tracking\n        let categories = [\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ];\n\n        for category in categories.iter() {\n            preferred_categories.push_back((category.clone(), 0u32));\n        }\n\n        for investment in all_investments.iter() {\n            if investment.funded_at \u003e= start_date \u0026\u0026 investment.funded_at \u003c= end_date {\n                investments_made += 1;\n                total_invested = total_invested.saturating_add(investment.amount);\n\n                if let Some(invoice) =\n                    crate::invoice::InvoiceStorage::get_invoice(env, \u0026investment.invoice_id)\n                {\n                    // Update category preferences\n                    for i in 0..preferred_categories.len() {\n                        let (cat, count) = preferred_categories.get(i).unwrap();\n                        if cat == invoice.category {\n                            preferred_categories.set(i, (cat, count.saturating_add(1)));\n                            break;\n                        }\n                    }\n\n                    match invoice.status {\n                        InvoiceStatus::Paid =\u003e {\n                            successful_investments += 1;\n                            let (profit, _) = crate::profits::calculate_profit(\n                                env,\n                                investment.amount,\n                                invoice.amount,\n                            );\n                            total_returns = total_returns\n                                .saturating_add(investment.amount.saturating_add(profit));\n                        }\n                        InvoiceStatus::Defaulted =\u003e defaulted_investments += 1,\n                        _ =\u003e {}\n                    }\n                }\n            }\n        }\n\n        let average_return_rate = if total_invested \u003e 0 {\n            let profit = total_returns.saturating_sub(total_invested);\n            profit.saturating_mul(10000).saturating_div(total_invested)\n        } else {\n            0\n        };\n\n        let success_rate = if investments_made \u003e 0 {\n            (successful_investments.saturating_mul(10000)).saturating_div(investments_made) as i128\n        } else {\n            0\n        };\n\n        let default_rate = if investments_made \u003e 0 {\n            (defaulted_investments.saturating_mul(10000)).saturating_div(investments_made) as i128\n        } else {\n            0\n        };\n\n        // Calculate risk tolerance based on investment patterns\n        let risk_tolerance = if default_rate \u003e 1000 {\n            // \u003e 10%\n            100\n        } else if default_rate \u003e 500 {\n            // \u003e 5%\n            75\n        } else if default_rate \u003e 200 {\n            // \u003e 2%\n            50\n        } else {\n            25\n        };\n\n        // Calculate portfolio diversity (simplified)\n        let portfolio_diversity = if investments_made \u003e 0 {\n            let unique_categories = preferred_categories\n                .iter()\n                .filter(|(_, count)| *count \u003e 0)\n                .count() as u32;\n            (unique_categories.saturating_mul(10000)).saturating_div(investments_made) as i128\n        } else {\n            0\n        };\n\n        Ok(InvestorReport {\n            report_id,\n            investor_address: investor.clone(),\n            period,\n            start_date,\n            end_date,\n            investments_made,\n            total_invested,\n            total_returns,\n            average_return_rate,\n            success_rate,\n            default_rate,\n            preferred_categories,\n            risk_tolerance,\n            portfolio_diversity,\n            generated_at: current_timestamp,\n        })\n    }\n\n    /// Get period dates based on time period\n    pub fn get_period_dates(current_timestamp: u64, period: TimePeriod) -\u003e (u64, u64) {\n        match period {\n            TimePeriod::Daily =\u003e {\n                let day_start = current_timestamp.saturating_sub(24 * 60 * 60);\n                (day_start, current_timestamp)\n            }\n            TimePeriod::Weekly =\u003e {\n                let week_start = current_timestamp.saturating_sub(7 * 24 * 60 * 60);\n                (week_start, current_timestamp)\n            }\n            TimePeriod::Monthly =\u003e {\n                let month_start = current_timestamp.saturating_sub(30 * 24 * 60 * 60);\n                (month_start, current_timestamp)\n            }\n            TimePeriod::Quarterly =\u003e {\n                let quarter_start = current_timestamp.saturating_sub(90 * 24 * 60 * 60);\n                (quarter_start, current_timestamp)\n            }\n            TimePeriod::Yearly =\u003e {\n                let year_start = current_timestamp.saturating_sub(365 * 24 * 60 * 60);\n                (year_start, current_timestamp)\n            }\n            TimePeriod::AllTime =\u003e (0, current_timestamp),\n        }\n    }\n\n    /// Calculate comprehensive investor analytics\n    pub fn calculate_investor_analytics(\n        env: \u0026Env,\n        investor: \u0026Address,\n    ) -\u003e Result\u003cInvestorAnalytics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Get investor verification data\n        let verification = crate::verification::InvestorVerificationStorage::get(env, investor)\n            .ok_or(QuickLendXError::KYCNotFound)?;\n\n        // Calculate success rate\n        let total_investments =\n            verification.successful_investments + verification.defaulted_investments;\n        let success_rate = if total_investments \u003e 0 {\n            (verification.successful_investments.saturating_mul(10000))\n                .saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        // Calculate average investment size\n        let average_investment_size = if total_investments \u003e 0 {\n            verification\n                .total_invested\n                .saturating_div(total_investments as i128)\n        } else {\n            0\n        };\n\n        // Calculate portfolio diversity score (simplified)\n        let portfolio_diversity_score = if total_investments \u003e 0 {\n            // In a real implementation, this would analyze category distribution\n            let diversity = if total_investments \u003e 10 {\n                80\n            } else if total_investments \u003e 5 {\n                60\n            } else {\n                40\n            };\n            diversity\n        } else {\n            0\n        };\n\n        // Calculate account age\n        let account_age = current_timestamp.saturating_sub(verification.submitted_at);\n\n        // Calculate compliance score based on various factors\n        let mut compliance_score = 100u32;\n\n        // Reduce score for defaults\n        if verification.defaulted_investments \u003e 0 {\n            let default_rate =\n                (verification.defaulted_investments * 100) / total_investments.max(1);\n            compliance_score = compliance_score.saturating_sub(default_rate);\n        }\n\n        // Reduce score for high risk\n        if verification.risk_score \u003e 75 {\n            compliance_score = compliance_score.saturating_sub(20);\n        } else if verification.risk_score \u003e 50 {\n            compliance_score = compliance_score.saturating_sub(10);\n        }\n\n        // Get preferred categories (simplified - would need actual investment data)\n        let preferred_categories = Vec::new(env);\n\n        Ok(InvestorAnalytics {\n            investor_address: investor.clone(),\n            tier: verification.tier,\n            risk_level: verification.risk_level,\n            risk_score: verification.risk_score,\n            investment_limit: verification.investment_limit,\n            total_invested: verification.total_invested,\n            total_returns: verification.total_returns,\n            successful_investments: verification.successful_investments,\n            defaulted_investments: verification.defaulted_investments,\n            success_rate,\n            average_investment_size,\n            portfolio_diversity_score,\n            preferred_categories,\n            last_activity: verification.last_activity,\n            account_age,\n            compliance_score,\n            generated_at: current_timestamp,\n        })\n    }\n\n    /// Calculate investor performance metrics for the platform\n    pub fn calc_investor_perf_metrics(\n        env: \u0026Env,\n    ) -\u003e Result\u003cInvestorPerformanceMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Get investor counts by status\n        let verified_investors =\n            crate::verification::InvestorVerificationStorage::get_verified_investors(env);\n        let pending_investors =\n            crate::verification::InvestorVerificationStorage::get_pending_investors(env);\n        let rejected_investors =\n            crate::verification::InvestorVerificationStorage::get_rejected_investors(env);\n\n        let total_investors =\n            verified_investors.len() + pending_investors.len() + rejected_investors.len();\n\n        // Calculate investors by tier\n        let mut investors_by_tier = Vec::new(env);\n        let tiers = [\n            crate::verification::InvestorTier::Basic,\n            crate::verification::InvestorTier::Silver,\n            crate::verification::InvestorTier::Gold,\n            crate::verification::InvestorTier::Platinum,\n            crate::verification::InvestorTier::VIP,\n        ];\n\n        for tier in tiers.iter() {\n            let tier_investors =\n                crate::verification::InvestorVerificationStorage::get_investors_by_tier(\n                    env,\n                    tier.clone(),\n                );\n            investors_by_tier.push_back((tier.clone(), tier_investors.len() as u32));\n        }\n\n        // Calculate investors by risk level\n        let mut investors_by_risk = Vec::new(env);\n        let risk_levels = [\n            crate::verification::InvestorRiskLevel::Low,\n            crate::verification::InvestorRiskLevel::Medium,\n            crate::verification::InvestorRiskLevel::High,\n            crate::verification::InvestorRiskLevel::VeryHigh,\n        ];\n\n        for risk_level in risk_levels.iter() {\n            let risk_investors =\n                crate::verification::InvestorVerificationStorage::get_investors_by_risk_level(\n                    env,\n                    risk_level.clone(),\n                );\n            investors_by_risk.push_back((risk_level.clone(), risk_investors.len() as u32));\n        }\n\n        // Calculate total investment volume and average\n        let mut total_investment_volume = 0i128;\n        let mut total_investments = 0u32;\n        let mut total_risk_score = 0u32;\n        let mut successful_investments = 0u32;\n\n        for investor in verified_investors.iter() {\n            if let Some(verification) =\n                crate::verification::InvestorVerificationStorage::get(env, \u0026investor)\n            {\n                total_investment_volume =\n                    total_investment_volume.saturating_add(verification.total_invested);\n                let investor_total =\n                    verification.successful_investments + verification.defaulted_investments;\n                total_investments = total_investments.saturating_add(investor_total);\n                total_risk_score = total_risk_score.saturating_add(verification.risk_score);\n                successful_investments =\n                    successful_investments.saturating_add(verification.successful_investments);\n            }\n        }\n\n        let average_investment_size = if total_investments \u003e 0 {\n            total_investment_volume.saturating_div(total_investments as i128)\n        } else {\n            0\n        };\n\n        let platform_success_rate = if total_investments \u003e 0 {\n            (successful_investments.saturating_mul(10000)).saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        let average_risk_score = if verified_investors.len() \u003e 0 {\n            total_risk_score.saturating_div(verified_investors.len() as u32)\n        } else {\n            0\n        };\n\n        // Get top performing investors (simplified)\n        let mut top_performing_investors = Vec::new(env);\n        for investor in verified_investors.iter() {\n            if let Some(verification) =\n                crate::verification::InvestorVerificationStorage::get(env, \u0026investor)\n            {\n                if verification.successful_investments \u003e 5 \u0026\u0026 verification.risk_score \u003c 30 {\n                    top_performing_investors.push_back(investor);\n                    if top_performing_investors.len() \u003e= 10 {\n                        break;\n                    }\n                }\n            }\n        }\n\n        Ok(InvestorPerformanceMetrics {\n            total_investors: total_investors as u32,\n            verified_investors: verified_investors.len() as u32,\n            pending_investors: pending_investors.len() as u32,\n            rejected_investors: rejected_investors.len() as u32,\n            investors_by_tier,\n            investors_by_risk,\n            total_investment_volume,\n            average_investment_size,\n            platform_success_rate,\n            average_risk_score,\n            top_performing_investors,\n            generated_at: current_timestamp,\n        })\n    }\n}\n","traces":[{"line":178,"address":[12071456],"length":1,"stats":{"Line":0}},{"line":179,"address":[12071464],"length":1,"stats":{"Line":0}},{"line":182,"address":[12073152],"length":1,"stats":{"Line":0}},{"line":183,"address":[12073160],"length":1,"stats":{"Line":0}},{"line":186,"address":[12069056,12069215,12069221],"length":1,"stats":{"Line":0}},{"line":187,"address":[12069077],"length":1,"stats":{"Line":0}},{"line":190,"address":[12070041,12069872,12070035],"length":1,"stats":{"Line":0}},{"line":191,"address":[12069893],"length":1,"stats":{"Line":0}},{"line":194,"address":[12070835,12070841,12070672],"length":1,"stats":{"Line":0}},{"line":195,"address":[12070693],"length":1,"stats":{"Line":0}},{"line":198,"address":[12072565,12072559,12072400],"length":1,"stats":{"Line":0}},{"line":199,"address":[12072421],"length":1,"stats":{"Line":0}},{"line":202,"address":[12073472],"length":1,"stats":{"Line":0}},{"line":203,"address":[12073480],"length":1,"stats":{"Line":0}},{"line":206,"address":[12069232],"length":1,"stats":{"Line":0}},{"line":207,"address":[12069240],"length":1,"stats":{"Line":0}},{"line":210,"address":[12072840,12072846,12072576],"length":1,"stats":{"Line":0}},{"line":211,"address":[12072620],"length":1,"stats":{"Line":0}},{"line":213,"address":[12072646],"length":1,"stats":{"Line":0}},{"line":216,"address":[12071428,12071168,12071434],"length":1,"stats":{"Line":0}},{"line":217,"address":[12071275,12071335,12071203],"length":1,"stats":{"Line":0}},{"line":220,"address":[12074072,12074078,12073808],"length":1,"stats":{"Line":0}},{"line":221,"address":[12073852],"length":1,"stats":{"Line":0}},{"line":223,"address":[12073878],"length":1,"stats":{"Line":0}},{"line":226,"address":[12073124,12073130,12072864],"length":1,"stats":{"Line":0}},{"line":227,"address":[12072899],"length":1,"stats":{"Line":0}},{"line":229,"address":[12073031,12072971],"length":1,"stats":{"Line":0}},{"line":232,"address":[12070864,12071146,12071152],"length":1,"stats":{"Line":0}},{"line":233,"address":[12070921],"length":1,"stats":{"Line":0}},{"line":235,"address":[12070947],"length":1,"stats":{"Line":0}},{"line":238,"address":[12071488,12071761,12071767],"length":1,"stats":{"Line":0}},{"line":239,"address":[12071532],"length":1,"stats":{"Line":0}},{"line":241,"address":[12071604,12071558],"length":1,"stats":{"Line":0}},{"line":244,"address":[12070064,12070342,12070348],"length":1,"stats":{"Line":0}},{"line":245,"address":[12070112],"length":1,"stats":{"Line":0}},{"line":247,"address":[12070249,12070189],"length":1,"stats":{"Line":0}},{"line":250,"address":[12072065,12072071,12071792],"length":1,"stats":{"Line":0}},{"line":251,"address":[12071836],"length":1,"stats":{"Line":0}},{"line":253,"address":[12071862,12071908],"length":1,"stats":{"Line":0}},{"line":256,"address":[12070646,12070652,12070368],"length":1,"stats":{"Line":0}},{"line":257,"address":[12070416],"length":1,"stats":{"Line":0}},{"line":259,"address":[12070493,12070553],"length":1,"stats":{"Line":0}},{"line":262,"address":[12073792,12073504,12073786],"length":1,"stats":{"Line":0}},{"line":263,"address":[12073561],"length":1,"stats":{"Line":0}},{"line":265,"address":[12073587],"length":1,"stats":{"Line":0}},{"line":268,"address":[12072374,12072096,12072380],"length":1,"stats":{"Line":0}},{"line":269,"address":[12072144],"length":1,"stats":{"Line":0}},{"line":271,"address":[12072221,12072281],"length":1,"stats":{"Line":0}},{"line":274,"address":[12074366,12074096,12074360],"length":1,"stats":{"Line":0}},{"line":275,"address":[12074140],"length":1,"stats":{"Line":0}},{"line":277,"address":[12074166],"length":1,"stats":{"Line":0}},{"line":280,"address":[12073450,12073184,12073444],"length":1,"stats":{"Line":0}},{"line":281,"address":[12073219],"length":1,"stats":{"Line":0}},{"line":283,"address":[12073351,12073291],"length":1,"stats":{"Line":0}},{"line":286,"address":[12069264,12069848,12069854],"length":1,"stats":{"Line":0}},{"line":287,"address":[12069286],"length":1,"stats":{"Line":0}},{"line":288,"address":[12069395],"length":1,"stats":{"Line":0}},{"line":289,"address":[12069510],"length":1,"stats":{"Line":0}},{"line":290,"address":[12069527],"length":1,"stats":{"Line":0}},{"line":291,"address":[12069545,12069609],"length":1,"stats":{"Line":0}},{"line":292,"address":[12069744],"length":1,"stats":{"Line":0}},{"line":301,"address":[12089837,12086688,12091060],"length":1,"stats":{"Line":0}},{"line":302,"address":[12086779],"length":1,"stats":{"Line":0}},{"line":305,"address":[12086896],"length":1,"stats":{"Line":0}},{"line":307,"address":[12086924],"length":1,"stats":{"Line":0}},{"line":309,"address":[12086998],"length":1,"stats":{"Line":0}},{"line":311,"address":[12087069],"length":1,"stats":{"Line":0}},{"line":313,"address":[12087140],"length":1,"stats":{"Line":0}},{"line":316,"address":[12087302,12087687,12087211,12087442,12087373,12087339,12087410,12087479,12087514],"length":1,"stats":{"Line":0}},{"line":317,"address":[12087274],"length":1,"stats":{"Line":0}},{"line":318,"address":[12087325],"length":1,"stats":{"Line":0}},{"line":319,"address":[12087396],"length":1,"stats":{"Line":0}},{"line":320,"address":[12087465],"length":1,"stats":{"Line":0}},{"line":323,"address":[12087547],"length":1,"stats":{"Line":0}},{"line":324,"address":[12087724,12087579],"length":1,"stats":{"Line":0}},{"line":331,"address":[12087664],"length":1,"stats":{"Line":0}},{"line":333,"address":[12087865,12090586,12090682],"length":1,"stats":{"Line":0}},{"line":334,"address":[12090781,12090850],"length":1,"stats":{"Line":0}},{"line":335,"address":[12090908,12091029],"length":1,"stats":{"Line":0}},{"line":341,"address":[12087894],"length":1,"stats":{"Line":0}},{"line":344,"address":[12087922],"length":1,"stats":{"Line":0}},{"line":345,"address":[12087962,12088081],"length":1,"stats":{"Line":0}},{"line":346,"address":[12088180,12090140],"length":1,"stats":{"Line":0}},{"line":347,"address":[12090310],"length":1,"stats":{"Line":0}},{"line":353,"address":[12090356,12090461],"length":1,"stats":{"Line":0}},{"line":355,"address":[12090493],"length":1,"stats":{"Line":0}},{"line":361,"address":[12086752],"length":1,"stats":{"Line":0}},{"line":364,"address":[12088221],"length":1,"stats":{"Line":0}},{"line":366,"address":[12088308,12088236],"length":1,"stats":{"Line":0}},{"line":369,"address":[12088344,12088315],"length":1,"stats":{"Line":0}},{"line":370,"address":[12088353,12088424],"length":1,"stats":{"Line":0}},{"line":372,"address":[12088320],"length":1,"stats":{"Line":0}},{"line":375,"address":[12088404,12088466],"length":1,"stats":{"Line":0}},{"line":376,"address":[12088468],"length":1,"stats":{"Line":0}},{"line":377,"address":[12088557,12088653,12088508],"length":1,"stats":{"Line":0}},{"line":378,"address":[12089906],"length":1,"stats":{"Line":0}},{"line":384,"address":[12090065,12089944],"length":1,"stats":{"Line":0}},{"line":387,"address":[12088784],"length":1,"stats":{"Line":0}},{"line":389,"address":[12088442],"length":1,"stats":{"Line":0}},{"line":393,"address":[12088531],"length":1,"stats":{"Line":0}},{"line":394,"address":[12088864],"length":1,"stats":{"Line":0}},{"line":397,"address":[12088914,12088961],"length":1,"stats":{"Line":0}},{"line":398,"address":[12089094,12089065,12089211],"length":1,"stats":{"Line":0}},{"line":399,"address":[12089133,12089104],"length":1,"stats":{"Line":0}},{"line":400,"address":[12089145],"length":1,"stats":{"Line":0}},{"line":402,"address":[12089070],"length":1,"stats":{"Line":0}},{"line":406,"address":[12089237,12089697,12089122],"length":1,"stats":{"Line":0}},{"line":407,"address":[12089619,12089247],"length":1,"stats":{"Line":0}},{"line":408,"address":[12089631],"length":1,"stats":{"Line":0}},{"line":410,"address":[12089213],"length":1,"stats":{"Line":0}},{"line":413,"address":[12089377],"length":1,"stats":{"Line":0}},{"line":416,"address":[12089281],"length":1,"stats":{"Line":0}},{"line":417,"address":[12089297],"length":1,"stats":{"Line":0}},{"line":420,"address":[12089313],"length":1,"stats":{"Line":0}},{"line":421,"address":[12089329],"length":1,"stats":{"Line":0}},{"line":423,"address":[12089345],"length":1,"stats":{"Line":0}},{"line":424,"address":[12089361],"length":1,"stats":{"Line":0}},{"line":430,"address":[12102546,12101280,12102540],"length":1,"stats":{"Line":0}},{"line":434,"address":[12101416],"length":1,"stats":{"Line":0}},{"line":437,"address":[12101530],"length":1,"stats":{"Line":0}},{"line":438,"address":[12101540,12101596],"length":1,"stats":{"Line":0}},{"line":441,"address":[12101323],"length":1,"stats":{"Line":0}},{"line":444,"address":[12101603],"length":1,"stats":{"Line":0}},{"line":445,"address":[12101334],"length":1,"stats":{"Line":0}},{"line":450,"address":[12101614],"length":1,"stats":{"Line":0}},{"line":453,"address":[12101358],"length":1,"stats":{"Line":0}},{"line":456,"address":[12101651],"length":1,"stats":{"Line":0}},{"line":458,"address":[12101382],"length":1,"stats":{"Line":0}},{"line":460,"address":[12101658],"length":1,"stats":{"Line":0}},{"line":466,"address":[12101682],"length":1,"stats":{"Line":0}},{"line":469,"address":[12101684],"length":1,"stats":{"Line":0}},{"line":473,"address":[12101686],"length":1,"stats":{"Line":0}},{"line":477,"address":[12101697],"length":1,"stats":{"Line":0}},{"line":478,"address":[12101785,12101878,12101722],"length":1,"stats":{"Line":0}},{"line":479,"address":[12102411,12101974],"length":1,"stats":{"Line":0}},{"line":480,"address":[12102465,12102538],"length":1,"stats":{"Line":0}},{"line":481,"address":[12102522],"length":1,"stats":{"Line":0}},{"line":486,"address":[12102106],"length":1,"stats":{"Line":0}},{"line":487,"address":[12102012],"length":1,"stats":{"Line":0}},{"line":491,"address":[12102023],"length":1,"stats":{"Line":0}},{"line":495,"address":[12102039],"length":1,"stats":{"Line":0}},{"line":496,"address":[12102047],"length":1,"stats":{"Line":0}},{"line":497,"address":[12102095],"length":1,"stats":{"Line":0}},{"line":502,"address":[12091088,12094032,12096526],"length":1,"stats":{"Line":0}},{"line":506,"address":[12091151],"length":1,"stats":{"Line":0}},{"line":507,"address":[12091308],"length":1,"stats":{"Line":0}},{"line":509,"address":[12091375],"length":1,"stats":{"Line":0}},{"line":510,"address":[12091399],"length":1,"stats":{"Line":0}},{"line":511,"address":[12091423],"length":1,"stats":{"Line":0}},{"line":512,"address":[12091447],"length":1,"stats":{"Line":0}},{"line":513,"address":[12091484,12091532],"length":1,"stats":{"Line":0}},{"line":516,"address":[12091540],"length":1,"stats":{"Line":0}},{"line":526,"address":[12091689,12091609],"length":1,"stats":{"Line":0}},{"line":527,"address":[12091830,12096478],"length":1,"stats":{"Line":0}},{"line":531,"address":[12091855],"length":1,"stats":{"Line":0}},{"line":532,"address":[12091969],"length":1,"stats":{"Line":0}},{"line":539,"address":[12091874],"length":1,"stats":{"Line":0}},{"line":541,"address":[12092126],"length":1,"stats":{"Line":0}},{"line":542,"address":[12096183,12096279,12096116],"length":1,"stats":{"Line":0}},{"line":543,"address":[12096354,12096466],"length":1,"stats":{"Line":0}},{"line":546,"address":[12092271,12092152],"length":1,"stats":{"Line":0}},{"line":547,"address":[12092370,12094082],"length":1,"stats":{"Line":0}},{"line":548,"address":[12094201,12094144],"length":1,"stats":{"Line":0}},{"line":549,"address":[12094322,12094211],"length":1,"stats":{"Line":0}},{"line":552,"address":[12094346],"length":1,"stats":{"Line":0}},{"line":553,"address":[12094535,12094575],"length":1,"stats":{"Line":0}},{"line":554,"address":[12094682],"length":1,"stats":{"Line":0}},{"line":555,"address":[12094744],"length":1,"stats":{"Line":0}},{"line":561,"address":[12094542],"length":1,"stats":{"Line":0}},{"line":562,"address":[12094829,12095332,12094558],"length":1,"stats":{"Line":0}},{"line":563,"address":[12094970,12094996],"length":1,"stats":{"Line":0}},{"line":564,"address":[12095124,12095200],"length":1,"stats":{"Line":0}},{"line":566,"address":[12095235,12095337],"length":1,"stats":{"Line":0}},{"line":567,"address":[12095482],"length":1,"stats":{"Line":0}},{"line":571,"address":[12094977],"length":1,"stats":{"Line":0}},{"line":572,"address":[12095503,12095552],"length":1,"stats":{"Line":0}},{"line":576,"address":[12095526,12095664],"length":1,"stats":{"Line":0}},{"line":577,"address":[12095723],"length":1,"stats":{"Line":0}},{"line":585,"address":[12095773],"length":1,"stats":{"Line":0}},{"line":586,"address":[12095789],"length":1,"stats":{"Line":0}},{"line":588,"address":[12095934],"length":1,"stats":{"Line":0}},{"line":589,"address":[12096003],"length":1,"stats":{"Line":0}},{"line":597,"address":[12092447,12092395],"length":1,"stats":{"Line":0}},{"line":598,"address":[12092591,12092449],"length":1,"stats":{"Line":0}},{"line":600,"address":[12092536],"length":1,"stats":{"Line":0}},{"line":602,"address":[12092423],"length":1,"stats":{"Line":0}},{"line":606,"address":[12092513],"length":1,"stats":{"Line":0}},{"line":607,"address":[12092617,12092684],"length":1,"stats":{"Line":0}},{"line":610,"address":[12092803],"length":1,"stats":{"Line":0}},{"line":611,"address":[12092818,12092885],"length":1,"stats":{"Line":0}},{"line":612,"address":[12093138],"length":1,"stats":{"Line":0}},{"line":613,"address":[12092996],"length":1,"stats":{"Line":0}},{"line":614,"address":[12093023],"length":1,"stats":{"Line":0}},{"line":618,"address":[12093241],"length":1,"stats":{"Line":0}},{"line":619,"address":[12093248],"length":1,"stats":{"Line":0}},{"line":621,"address":[12093655],"length":1,"stats":{"Line":0}},{"line":622,"address":[12093335],"length":1,"stats":{"Line":0}},{"line":623,"address":[12093351],"length":1,"stats":{"Line":0}},{"line":624,"address":[12093367],"length":1,"stats":{"Line":0}},{"line":625,"address":[12093383],"length":1,"stats":{"Line":0}},{"line":626,"address":[12093399],"length":1,"stats":{"Line":0}},{"line":627,"address":[12093455],"length":1,"stats":{"Line":0}},{"line":628,"address":[12093503],"length":1,"stats":{"Line":0}},{"line":629,"address":[12093551],"length":1,"stats":{"Line":0}},{"line":630,"address":[12093599],"length":1,"stats":{"Line":0}},{"line":635,"address":[12101256,12098288,12100693],"length":1,"stats":{"Line":0}},{"line":636,"address":[12098387],"length":1,"stats":{"Line":0}},{"line":639,"address":[12098347],"length":1,"stats":{"Line":0}},{"line":640,"address":[12098493],"length":1,"stats":{"Line":0}},{"line":645,"address":[12098504],"length":1,"stats":{"Line":0}},{"line":649,"address":[12098359],"length":1,"stats":{"Line":0}},{"line":650,"address":[12098516],"length":1,"stats":{"Line":0}},{"line":655,"address":[12098527],"length":1,"stats":{"Line":0}},{"line":659,"address":[12098547],"length":1,"stats":{"Line":0}},{"line":660,"address":[12098559],"length":1,"stats":{"Line":0}},{"line":661,"address":[12098586],"length":1,"stats":{"Line":0}},{"line":663,"address":[12098674,12098770,12098607],"length":1,"stats":{"Line":0}},{"line":664,"address":[12100943,12098869],"length":1,"stats":{"Line":0}},{"line":667,"address":[12101035,12101230],"length":1,"stats":{"Line":0}},{"line":668,"address":[12101158,12101085],"length":1,"stats":{"Line":0}},{"line":669,"address":[12101166],"length":1,"stats":{"Line":0}},{"line":670,"address":[12101199,12101235],"length":1,"stats":{"Line":0}},{"line":675,"address":[12098916,12098894],"length":1,"stats":{"Line":0}},{"line":676,"address":[12098918,12099022],"length":1,"stats":{"Line":0}},{"line":678,"address":[12098904],"length":1,"stats":{"Line":0}},{"line":682,"address":[12098957],"length":1,"stats":{"Line":0}},{"line":683,"address":[12098968],"length":1,"stats":{"Line":0}},{"line":684,"address":[12099048],"length":1,"stats":{"Line":0}},{"line":691,"address":[12098979],"length":1,"stats":{"Line":0}},{"line":693,"address":[12100707,12099198],"length":1,"stats":{"Line":0}},{"line":695,"address":[12100849,12100796],"length":1,"stats":{"Line":0}},{"line":696,"address":[12100874,12100831,12100894],"length":1,"stats":{"Line":0}},{"line":697,"address":[12100887],"length":1,"stats":{"Line":0}},{"line":700,"address":[12099352,12099208,12099242],"length":1,"stats":{"Line":0}},{"line":701,"address":[12099244,12099301],"length":1,"stats":{"Line":0}},{"line":704,"address":[12099218],"length":1,"stats":{"Line":0}},{"line":708,"address":[12099275],"length":1,"stats":{"Line":0}},{"line":710,"address":[12099569,12099388,12099354],"length":1,"stats":{"Line":0}},{"line":711,"address":[12099398,12099547],"length":1,"stats":{"Line":0}},{"line":712,"address":[12099503],"length":1,"stats":{"Line":0}},{"line":713,"address":[12099518],"length":1,"stats":{"Line":0}},{"line":715,"address":[12099364],"length":1,"stats":{"Line":0}},{"line":719,"address":[12099417],"length":1,"stats":{"Line":0}},{"line":720,"address":[12099428],"length":1,"stats":{"Line":0}},{"line":721,"address":[12099439,12099586],"length":1,"stats":{"Line":0}},{"line":725,"address":[12099593],"length":1,"stats":{"Line":0}},{"line":727,"address":[12099698,12099631,12099794],"length":1,"stats":{"Line":0}},{"line":728,"address":[12100449,12099893],"length":1,"stats":{"Line":0}},{"line":729,"address":[12100671,12100542,12100503],"length":1,"stats":{"Line":0}},{"line":730,"address":[12100633,12100556],"length":1,"stats":{"Line":0}},{"line":731,"address":[12100640,12100673],"length":1,"stats":{"Line":0}},{"line":736,"address":[12099939,12099918],"length":1,"stats":{"Line":0}},{"line":737,"address":[12099941,12100000],"length":1,"stats":{"Line":0}},{"line":739,"address":[12099928],"length":1,"stats":{"Line":0}},{"line":744,"address":[12099989],"length":1,"stats":{"Line":0}},{"line":745,"address":[12100009],"length":1,"stats":{"Line":0}},{"line":748,"address":[12100155],"length":1,"stats":{"Line":0}},{"line":750,"address":[12100092],"length":1,"stats":{"Line":0}},{"line":751,"address":[12100100],"length":1,"stats":{"Line":0}},{"line":752,"address":[12100108],"length":1,"stats":{"Line":0}},{"line":754,"address":[12100116],"length":1,"stats":{"Line":0}},{"line":755,"address":[12100132],"length":1,"stats":{"Line":0}},{"line":756,"address":[12100148],"length":1,"stats":{"Line":0}},{"line":762,"address":[12075424,12077599,12078932],"length":1,"stats":{"Line":0}},{"line":767,"address":[12075498],"length":1,"stats":{"Line":0}},{"line":768,"address":[12075639],"length":1,"stats":{"Line":0}},{"line":769,"address":[12075706],"length":1,"stats":{"Line":0}},{"line":772,"address":[12075751],"length":1,"stats":{"Line":0}},{"line":773,"address":[12075807],"length":1,"stats":{"Line":0}},{"line":774,"address":[12075818],"length":1,"stats":{"Line":0}},{"line":775,"address":[12075829],"length":1,"stats":{"Line":0}},{"line":776,"address":[12075853],"length":1,"stats":{"Line":0}},{"line":777,"address":[12075865],"length":1,"stats":{"Line":0}},{"line":778,"address":[12075876],"length":1,"stats":{"Line":0}},{"line":779,"address":[12075895],"length":1,"stats":{"Line":0}},{"line":780,"address":[12075946],"length":1,"stats":{"Line":0}},{"line":781,"address":[12075957],"length":1,"stats":{"Line":0}},{"line":784,"address":[12075968],"length":1,"stats":{"Line":0}},{"line":794,"address":[12076116,12076037],"length":1,"stats":{"Line":0}},{"line":795,"address":[12076257,12078907],"length":1,"stats":{"Line":0}},{"line":798,"address":[12076290,12076409],"length":1,"stats":{"Line":0}},{"line":799,"address":[12077649,12076508],"length":1,"stats":{"Line":0}},{"line":800,"address":[12077768,12077711],"length":1,"stats":{"Line":0}},{"line":801,"address":[12077778,12077858],"length":1,"stats":{"Line":0}},{"line":802,"address":[12077809,12077928],"length":1,"stats":{"Line":0}},{"line":805,"address":[12077952],"length":1,"stats":{"Line":0}},{"line":806,"address":[12078152,12078100],"length":1,"stats":{"Line":0}},{"line":807,"address":[12078205],"length":1,"stats":{"Line":0}},{"line":808,"address":[12078254],"length":1,"stats":{"Line":0}},{"line":814,"address":[12078115,12078305],"length":1,"stats":{"Line":0}},{"line":815,"address":[12078311,12078363],"length":1,"stats":{"Line":0}},{"line":817,"address":[12078337,12078426,12078456],"length":1,"stats":{"Line":0}},{"line":818,"address":[12078496],"length":1,"stats":{"Line":0}},{"line":824,"address":[12078538,12078611],"length":1,"stats":{"Line":0}},{"line":826,"address":[12078619],"length":1,"stats":{"Line":0}},{"line":830,"address":[12078369],"length":1,"stats":{"Line":0}},{"line":831,"address":[12078738,12078690],"length":1,"stats":{"Line":0}},{"line":832,"address":[12078712,12078772],"length":1,"stats":{"Line":0}},{"line":837,"address":[12078802,12078874,12078670],"length":1,"stats":{"Line":0}},{"line":838,"address":[12078816],"length":1,"stats":{"Line":0}},{"line":839,"address":[12078879,12078845],"length":1,"stats":{"Line":0}},{"line":845,"address":[12076555,12076533],"length":1,"stats":{"Line":0}},{"line":846,"address":[12076557,12076616],"length":1,"stats":{"Line":0}},{"line":848,"address":[12076543],"length":1,"stats":{"Line":0}},{"line":851,"address":[12076650,12076754,12076596],"length":1,"stats":{"Line":0}},{"line":852,"address":[12076697,12076652],"length":1,"stats":{"Line":0}},{"line":854,"address":[12076626],"length":1,"stats":{"Line":0}},{"line":857,"address":[12076678,12076884,12076780],"length":1,"stats":{"Line":0}},{"line":858,"address":[12076782,12076827],"length":1,"stats":{"Line":0}},{"line":860,"address":[12076756],"length":1,"stats":{"Line":0}},{"line":863,"address":[12076808,12076897,12077032],"length":1,"stats":{"Line":0}},{"line":864,"address":[12077014,12076899],"length":1,"stats":{"Line":0}},{"line":866,"address":[12076886],"length":1,"stats":{"Line":0}},{"line":869,"address":[12077234],"length":1,"stats":{"Line":0}},{"line":870,"address":[12076939],"length":1,"stats":{"Line":0}},{"line":871,"address":[12077003],"length":1,"stats":{"Line":0}},{"line":875,"address":[12077094],"length":1,"stats":{"Line":0}},{"line":876,"address":[12077102],"length":1,"stats":{"Line":0}},{"line":877,"address":[12077109],"length":1,"stats":{"Line":0}},{"line":878,"address":[12077125],"length":1,"stats":{"Line":0}},{"line":879,"address":[12077133],"length":1,"stats":{"Line":0}},{"line":880,"address":[12077149],"length":1,"stats":{"Line":0}},{"line":881,"address":[12077165],"length":1,"stats":{"Line":0}},{"line":882,"address":[12077213],"length":1,"stats":{"Line":0}},{"line":883,"address":[12077227],"length":1,"stats":{"Line":0}},{"line":889,"address":[12081595,12078976,12082711],"length":1,"stats":{"Line":0}},{"line":894,"address":[12079050],"length":1,"stats":{"Line":0}},{"line":895,"address":[12079191],"length":1,"stats":{"Line":0}},{"line":896,"address":[12079258],"length":1,"stats":{"Line":0}},{"line":899,"address":[12079295],"length":1,"stats":{"Line":0}},{"line":900,"address":[12079351],"length":1,"stats":{"Line":0}},{"line":901,"address":[12079362],"length":1,"stats":{"Line":0}},{"line":902,"address":[12079386],"length":1,"stats":{"Line":0}},{"line":903,"address":[12079410],"length":1,"stats":{"Line":0}},{"line":904,"address":[12079421],"length":1,"stats":{"Line":0}},{"line":905,"address":[12079440],"length":1,"stats":{"Line":0}},{"line":908,"address":[12079487],"length":1,"stats":{"Line":0}},{"line":918,"address":[12079556,12079635],"length":1,"stats":{"Line":0}},{"line":919,"address":[12082686,12079776],"length":1,"stats":{"Line":0}},{"line":922,"address":[12079928,12079809],"length":1,"stats":{"Line":0}},{"line":923,"address":[12079989,12081627],"length":1,"stats":{"Line":0}},{"line":924,"address":[12081637,12081729],"length":1,"stats":{"Line":0}},{"line":925,"address":[12081674,12081813],"length":1,"stats":{"Line":0}},{"line":927,"address":[12081872],"length":1,"stats":{"Line":0}},{"line":931,"address":[12081977,12081922],"length":1,"stats":{"Line":0}},{"line":932,"address":[12082178,12082110],"length":1,"stats":{"Line":0}},{"line":933,"address":[12082231],"length":1,"stats":{"Line":0}},{"line":934,"address":[12082280],"length":1,"stats":{"Line":0}},{"line":939,"address":[12082125],"length":1,"stats":{"Line":0}},{"line":941,"address":[12082462,12082345,12082408],"length":1,"stats":{"Line":0}},{"line":944,"address":[12082415],"length":1,"stats":{"Line":0}},{"line":945,"address":[12082431],"length":1,"stats":{"Line":0}},{"line":947,"address":[12082515,12082621],"length":1,"stats":{"Line":0}},{"line":948,"address":[12082541],"length":1,"stats":{"Line":0}},{"line":950,"address":[12082646,12082367],"length":1,"stats":{"Line":0}},{"line":957,"address":[12080075,12080023],"length":1,"stats":{"Line":0}},{"line":958,"address":[12080167,12080077],"length":1,"stats":{"Line":0}},{"line":959,"address":[12080192],"length":1,"stats":{"Line":0}},{"line":961,"address":[12080051],"length":1,"stats":{"Line":0}},{"line":964,"address":[12080331,12080435,12080132],"length":1,"stats":{"Line":0}},{"line":965,"address":[12080378,12080333],"length":1,"stats":{"Line":0}},{"line":967,"address":[12080307],"length":1,"stats":{"Line":0}},{"line":970,"address":[12080359,12080461,12080586],"length":1,"stats":{"Line":0}},{"line":971,"address":[12080529,12080463],"length":1,"stats":{"Line":0}},{"line":973,"address":[12080437],"length":1,"stats":{"Line":0}},{"line":977,"address":[12080489,12080632],"length":1,"stats":{"Line":0}},{"line":979,"address":[12080621],"length":1,"stats":{"Line":0}},{"line":980,"address":[12080678,12080588],"length":1,"stats":{"Line":0}},{"line":982,"address":[12080667],"length":1,"stats":{"Line":0}},{"line":983,"address":[12080634,12080691],"length":1,"stats":{"Line":0}},{"line":985,"address":[12080693],"length":1,"stats":{"Line":0}},{"line":987,"address":[12080680],"length":1,"stats":{"Line":0}},{"line":991,"address":[12080738,12080991,12080704],"length":1,"stats":{"Line":0}},{"line":992,"address":[12080899],"length":1,"stats":{"Line":0}},{"line":993,"address":[12080756],"length":1,"stats":{"Line":0}},{"line":994,"address":[12080861],"length":1,"stats":{"Line":0}},{"line":995,"address":[12080876],"length":1,"stats":{"Line":0}},{"line":996,"address":[12080913],"length":1,"stats":{"Line":0}},{"line":998,"address":[12080714],"length":1,"stats":{"Line":0}},{"line":1001,"address":[12081198],"length":1,"stats":{"Line":0}},{"line":1002,"address":[12080771],"length":1,"stats":{"Line":0}},{"line":1003,"address":[12080835],"length":1,"stats":{"Line":0}},{"line":1007,"address":[12081040],"length":1,"stats":{"Line":0}},{"line":1008,"address":[12081047],"length":1,"stats":{"Line":0}},{"line":1009,"address":[12081063],"length":1,"stats":{"Line":0}},{"line":1010,"address":[12081079],"length":1,"stats":{"Line":0}},{"line":1011,"address":[12081095],"length":1,"stats":{"Line":0}},{"line":1012,"address":[12081111],"length":1,"stats":{"Line":0}},{"line":1013,"address":[12081127],"length":1,"stats":{"Line":0}},{"line":1014,"address":[12081175],"length":1,"stats":{"Line":0}},{"line":1015,"address":[12081182],"length":1,"stats":{"Line":0}},{"line":1021,"address":[12074480],"length":1,"stats":{"Line":0}},{"line":1022,"address":[12074510],"length":1,"stats":{"Line":0}},{"line":1024,"address":[12074541,12074815,12074733],"length":1,"stats":{"Line":0}},{"line":1025,"address":[12074797],"length":1,"stats":{"Line":0}},{"line":1028,"address":[12074573,12074857,12074980],"length":1,"stats":{"Line":0}},{"line":1029,"address":[12074959],"length":1,"stats":{"Line":0}},{"line":1032,"address":[12075121,12074998,12074605],"length":1,"stats":{"Line":0}},{"line":1033,"address":[12075100],"length":1,"stats":{"Line":0}},{"line":1036,"address":[12075139,12074637,12075262],"length":1,"stats":{"Line":0}},{"line":1037,"address":[12075241],"length":1,"stats":{"Line":0}},{"line":1040,"address":[12075280,12075401,12074669],"length":1,"stats":{"Line":0}},{"line":1041,"address":[12075380],"length":1,"stats":{"Line":0}},{"line":1043,"address":[12074706],"length":1,"stats":{"Line":0}},{"line":1048,"address":[12098258,12096560,12098264],"length":1,"stats":{"Line":0}},{"line":1052,"address":[12096626],"length":1,"stats":{"Line":0}},{"line":1055,"address":[12096739,12096778,12096846],"length":1,"stats":{"Line":0}},{"line":1056,"address":[12096752,12096832],"length":1,"stats":{"Line":0}},{"line":1059,"address":[12096957,12096915],"length":1,"stats":{"Line":0}},{"line":1061,"address":[12096950,12097129,12097041],"length":1,"stats":{"Line":0}},{"line":1062,"address":[12097107,12097043],"length":1,"stats":{"Line":0}},{"line":1063,"address":[12097085],"length":1,"stats":{"Line":0}},{"line":1065,"address":[12097017],"length":1,"stats":{"Line":0}},{"line":1069,"address":[12097070,12097155],"length":1,"stats":{"Line":0}},{"line":1070,"address":[12097223,12097161],"length":1,"stats":{"Line":0}},{"line":1072,"address":[12097177],"length":1,"stats":{"Line":0}},{"line":1074,"address":[12097131],"length":1,"stats":{"Line":0}},{"line":1078,"address":[12097355,12097206,12097252],"length":1,"stats":{"Line":0}},{"line":1080,"address":[12097315,12097258],"length":1,"stats":{"Line":0}},{"line":1081,"address":[12097304],"length":1,"stats":{"Line":0}},{"line":1082,"address":[12097297,12097328],"length":1,"stats":{"Line":0}},{"line":1083,"address":[12097330],"length":1,"stats":{"Line":0}},{"line":1085,"address":[12097317],"length":1,"stats":{"Line":0}},{"line":1087,"address":[12097341],"length":1,"stats":{"Line":0}},{"line":1089,"address":[12097241],"length":1,"stats":{"Line":0}},{"line":1093,"address":[12097273,12097362],"length":1,"stats":{"Line":0}},{"line":1096,"address":[12097370],"length":1,"stats":{"Line":0}},{"line":1099,"address":[12097558,12097381],"length":1,"stats":{"Line":0}},{"line":1100,"address":[12097526,12097410],"length":1,"stats":{"Line":0}},{"line":1102,"address":[12097551,12097508],"length":1,"stats":{"Line":0}},{"line":1106,"address":[12097391,12097665],"length":1,"stats":{"Line":0}},{"line":1107,"address":[12097658,12097575],"length":1,"stats":{"Line":0}},{"line":1108,"address":[12097563,12097652],"length":1,"stats":{"Line":0}},{"line":1109,"address":[12097618],"length":1,"stats":{"Line":0}},{"line":1113,"address":[12097611],"length":1,"stats":{"Line":0}},{"line":1115,"address":[12097936],"length":1,"stats":{"Line":0}},{"line":1116,"address":[12097680],"length":1,"stats":{"Line":0}},{"line":1117,"address":[12097727],"length":1,"stats":{"Line":0}},{"line":1118,"address":[12097738],"length":1,"stats":{"Line":0}},{"line":1119,"address":[12097746],"length":1,"stats":{"Line":0}},{"line":1120,"address":[12097753],"length":1,"stats":{"Line":0}},{"line":1121,"address":[12097769],"length":1,"stats":{"Line":0}},{"line":1122,"address":[12097785],"length":1,"stats":{"Line":0}},{"line":1123,"address":[12097801],"length":1,"stats":{"Line":0}},{"line":1124,"address":[12097809],"length":1,"stats":{"Line":0}},{"line":1125,"address":[12097817],"length":1,"stats":{"Line":0}},{"line":1126,"address":[12097833],"length":1,"stats":{"Line":0}},{"line":1127,"address":[12097849],"length":1,"stats":{"Line":0}},{"line":1128,"address":[12097860],"length":1,"stats":{"Line":0}},{"line":1129,"address":[12097908],"length":1,"stats":{"Line":0}},{"line":1131,"address":[12097921],"length":1,"stats":{"Line":0}},{"line":1137,"address":[12082752,12086665,12085873],"length":1,"stats":{"Line":0}},{"line":1140,"address":[12082797],"length":1,"stats":{"Line":0}},{"line":1143,"address":[12082946],"length":1,"stats":{"Line":0}},{"line":1145,"address":[12082967],"length":1,"stats":{"Line":0}},{"line":1147,"address":[12083034],"length":1,"stats":{"Line":0}},{"line":1150,"address":[12083090,12083153,12083304],"length":1,"stats":{"Line":0}},{"line":1154,"address":[12083297],"length":1,"stats":{"Line":0}},{"line":1155,"address":[12083322],"length":1,"stats":{"Line":0}},{"line":1163,"address":[12083454,12083375],"length":1,"stats":{"Line":0}},{"line":1167,"address":[12083603],"length":1,"stats":{"Line":0}},{"line":1169,"address":[12086608,12086545],"length":1,"stats":{"Line":0}},{"line":1173,"address":[12083636],"length":1,"stats":{"Line":0}},{"line":1174,"address":[12083643],"length":1,"stats":{"Line":0}},{"line":1181,"address":[12083688,12083767],"length":1,"stats":{"Line":0}},{"line":1185,"address":[12083907],"length":1,"stats":{"Line":0}},{"line":1187,"address":[12086445,12086382],"length":1,"stats":{"Line":0}},{"line":1191,"address":[12083921],"length":1,"stats":{"Line":0}},{"line":1192,"address":[12083945],"length":1,"stats":{"Line":0}},{"line":1193,"address":[12083956],"length":1,"stats":{"Line":0}},{"line":1194,"address":[12083967],"length":1,"stats":{"Line":0}},{"line":1196,"address":[12084113,12083994],"length":1,"stats":{"Line":0}},{"line":1197,"address":[12084212,12085977],"length":1,"stats":{"Line":0}},{"line":1200,"address":[12086156],"length":1,"stats":{"Line":0}},{"line":1201,"address":[12086035],"length":1,"stats":{"Line":0}},{"line":1202,"address":[12086225,12086172],"length":1,"stats":{"Line":0}},{"line":1204,"address":[12086207,12086250],"length":1,"stats":{"Line":0}},{"line":1205,"address":[12086257],"length":1,"stats":{"Line":0}},{"line":1206,"address":[12086322],"length":1,"stats":{"Line":0}},{"line":1207,"address":[12086293],"length":1,"stats":{"Line":0}},{"line":1211,"address":[12084271,12084237],"length":1,"stats":{"Line":0}},{"line":1212,"address":[12084273,12084341],"length":1,"stats":{"Line":0}},{"line":1214,"address":[12084247],"length":1,"stats":{"Line":0}},{"line":1217,"address":[12084383,12084482,12084319],"length":1,"stats":{"Line":0}},{"line":1218,"address":[12084431,12084385],"length":1,"stats":{"Line":0}},{"line":1220,"address":[12084359],"length":1,"stats":{"Line":0}},{"line":1223,"address":[12084488,12084416,12084504],"length":1,"stats":{"Line":0}},{"line":1224,"address":[12084506,12084571],"length":1,"stats":{"Line":0}},{"line":1226,"address":[12084493],"length":1,"stats":{"Line":0}},{"line":1230,"address":[12084544],"length":1,"stats":{"Line":0}},{"line":1231,"address":[12084685,12084781,12084618,12085887],"length":1,"stats":{"Line":0}},{"line":1232,"address":[12084954,12084888],"length":1,"stats":{"Line":0}},{"line":1235,"address":[12085008,12085054],"length":1,"stats":{"Line":0}},{"line":1236,"address":[12085064],"length":1,"stats":{"Line":0}},{"line":1237,"address":[12085195],"length":1,"stats":{"Line":0}},{"line":1244,"address":[12085540],"length":1,"stats":{"Line":0}},{"line":1246,"address":[12085255],"length":1,"stats":{"Line":0}},{"line":1247,"address":[12085274],"length":1,"stats":{"Line":0}},{"line":1248,"address":[12085293],"length":1,"stats":{"Line":0}},{"line":1249,"address":[12085341],"length":1,"stats":{"Line":0}},{"line":1250,"address":[12085389],"length":1,"stats":{"Line":0}},{"line":1251,"address":[12085437],"length":1,"stats":{"Line":0}},{"line":1252,"address":[12085453],"length":1,"stats":{"Line":0}},{"line":1253,"address":[12085469],"length":1,"stats":{"Line":0}},{"line":1254,"address":[12085485],"length":1,"stats":{"Line":0}},{"line":1255,"address":[12085492],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":506},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","audit.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::invoice::{Invoice, InvoiceStatus};\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env, String, Vec};\n\n/// Audit operation types\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum AuditOperation {\n    InvoiceCreated,\n    InvoiceUploaded,\n    InvoiceVerified,\n    InvoiceFunded,\n    InvoicePaid,\n    InvoiceDefaulted,\n    InvoiceStatusChanged,\n    InvoiceRated,\n    BidPlaced,\n    BidAccepted,\n    BidWithdrawn,\n    EscrowCreated,\n    EscrowReleased,\n    EscrowRefunded,\n    PaymentProcessed,\n    SettlementCompleted,\n}\n\n/// Audit log entry structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AuditLogEntry {\n    pub audit_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub operation: AuditOperation,\n    pub actor: Address,\n    pub timestamp: u64,\n    pub old_value: Option\u003cString\u003e,\n    pub new_value: Option\u003cString\u003e,\n    pub amount: Option\u003ci128\u003e,\n    pub additional_data: Option\u003cString\u003e,\n    pub block_height: u32,\n    pub transaction_hash: Option\u003cBytesN\u003c32\u003e\u003e,\n}\n\n/// Audit operation filter\n#[contracttype]\n#[derive(Clone, Debug)]\npub enum AuditOperationFilter {\n    Any,\n    Specific(AuditOperation),\n}\n\n/// Audit query filters\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AuditQueryFilter {\n    pub invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    pub operation: AuditOperationFilter,\n    pub actor: Option\u003cAddress\u003e,\n    pub start_timestamp: Option\u003cu64\u003e,\n    pub end_timestamp: Option\u003cu64\u003e,\n}\n\n/// Audit statistics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AuditStats {\n    pub total_entries: u32,\n    pub operations_count: Vec\u003c(AuditOperation, u32)\u003e,\n    pub unique_actors: u32,\n    pub date_range: (u64, u64),\n}\n\nimpl AuditLogEntry {\n    /// Create a new audit log entry\n    pub fn new(\n        env: \u0026Env,\n        invoice_id: BytesN\u003c32\u003e,\n        operation: AuditOperation,\n        actor: Address,\n        old_value: Option\u003cString\u003e,\n        new_value: Option\u003cString\u003e,\n        amount: Option\u003ci128\u003e,\n        additional_data: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let audit_id = Self::generate_audit_id(env);\n        let timestamp = env.ledger().timestamp();\n        let block_height = env.ledger().sequence();\n\n        Self {\n            audit_id,\n            invoice_id,\n            operation,\n            actor,\n            timestamp,\n            old_value,\n            new_value,\n            amount,\n            additional_data,\n            block_height,\n            transaction_hash: None, // Could be populated if available\n        }\n    }\n\n    /// Generate unique audit ID\n    fn generate_audit_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let sequence = env.ledger().sequence();\n        let counter_key = symbol_short!(\"aud_cnt\");\n        let counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add audit prefix\n        id_bytes[0] = 0xAD; // 'A' for Audit\n        id_bytes[1] = 0x1F; // 'U' for aUdit\n                            // Embed timestamp\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed sequence\n        id_bytes[10..14].copy_from_slice(\u0026sequence.to_be_bytes());\n        // Embed counter\n        id_bytes[14..22].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining with pattern\n        for i in 22..32 {\n            id_bytes[i] = ((timestamp + sequence as u64 + counter + 0xAD1F) % 256) as u8;\n        }\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    /// Validate audit log entry integrity\n    pub fn validate_integrity(\u0026self, env: \u0026Env) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        // Check timestamp is not in future\n        if self.timestamp \u003e env.ledger().timestamp() {\n            return Ok(false);\n        }\n\n        // Check block height is valid\n        if self.block_height \u003e env.ledger().sequence() {\n            return Ok(false);\n        }\n\n        // Validate operation-specific data\n        match self.operation {\n            AuditOperation::InvoiceFunded | AuditOperation::PaymentProcessed =\u003e {\n                if self.amount.is_none() || self.amount.unwrap() \u003c= 0 {\n                    return Ok(false);\n                }\n            }\n            AuditOperation::InvoiceStatusChanged =\u003e {\n                if self.old_value.is_none() || self.new_value.is_none() {\n                    return Ok(false);\n                }\n            }\n            _ =\u003e {}\n        }\n\n        Ok(true)\n    }\n}\n\n/// Audit storage and management\npub struct AuditStorage;\n\nimpl AuditStorage {\n    /// Store an audit log entry\n    pub fn store_audit_entry(env: \u0026Env, entry: \u0026AuditLogEntry) {\n        // Store individual entry\n        env.storage().instance().set(\u0026entry.audit_id, entry);\n\n        // Add to invoice audit trail\n        Self::add_to_invoice_audit_trail(env, \u0026entry.invoice_id, \u0026entry.audit_id);\n\n        // Add to operation index\n        Self::add_to_operation_index(env, \u0026entry.operation, \u0026entry.audit_id);\n\n        // Add to actor index\n        Self::add_to_actor_index(env, \u0026entry.actor, \u0026entry.audit_id);\n\n        // Add to timestamp index\n        Self::add_to_timestamp_index(env, entry.timestamp, \u0026entry.audit_id);\n\n        // Add to global entries list\n        Self::add_to_all_audit_entries(env, \u0026entry.audit_id);\n    }\n\n    /// Get audit entry by ID\n    pub fn get_audit_entry(env: \u0026Env, audit_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cAuditLogEntry\u003e {\n        env.storage().instance().get(audit_id)\n    }\n\n    /// Get audit trail for an invoice\n    pub fn get_invoice_audit_trail(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"inv_aud\"), invoice_id.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get audit entries by operation type\n    pub fn get_audit_entries_by_operation(\n        env: \u0026Env,\n        operation: \u0026AuditOperation,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"op_aud\"), operation.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get audit entries by actor\n    pub fn get_audit_entries_by_actor(env: \u0026Env, actor: \u0026Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"act_aud\"), actor.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Query audit logs with filters\n    pub fn query_audit_logs(\n        env: \u0026Env,\n        filter: \u0026AuditQueryFilter,\n        limit: u32,\n    ) -\u003e Vec\u003cAuditLogEntry\u003e {\n        let mut results = Vec::new(env);\n        let mut count = 0u32;\n\n        // Start with invoice-specific entries if invoice_id is provided\n        let audit_ids = if let Some(invoice_id) = \u0026filter.invoice_id {\n            Self::get_invoice_audit_trail(env, invoice_id)\n        } else if let AuditOperationFilter::Specific(operation) = \u0026filter.operation {\n            Self::get_audit_entries_by_operation(env, operation)\n        } else if let Some(actor) = \u0026filter.actor {\n            Self::get_audit_entries_by_actor(env, actor)\n        } else {\n            // Get all audit entries (expensive operation)\n            Self::get_all_audit_entries(env)\n        };\n\n        for audit_id in audit_ids.iter() {\n            if count \u003e= limit {\n                break;\n            }\n\n            if let Some(entry) = Self::get_audit_entry(env, \u0026audit_id) {\n                // Apply filters\n                if Self::matches_filter(\u0026entry, filter) {\n                    results.push_back(entry);\n                    count += 1;\n                }\n            }\n        }\n\n        results\n    }\n\n    /// Get audit statistics\n    pub fn get_audit_stats(env: \u0026Env) -\u003e AuditStats {\n        let all_entries = Self::get_all_audit_entries(env);\n        let total_entries = all_entries.len() as u32;\n\n        let operations_count = Vec::new(env);\n        let mut unique_actors: Vec\u003cAddress\u003e = Vec::new(env);\n        let mut min_timestamp = u64::MAX;\n        let mut max_timestamp = 0u64;\n\n        for audit_id in all_entries.iter() {\n            if let Some(entry) = Self::get_audit_entry(env, \u0026audit_id) {\n                // Track unique actors\n                if !unique_actors.iter().any(|a| a == entry.actor) {\n                    unique_actors.push_back(entry.actor.clone());\n                }\n\n                // Update timestamp range\n                if entry.timestamp \u003c min_timestamp {\n                    min_timestamp = entry.timestamp;\n                }\n                if entry.timestamp \u003e max_timestamp {\n                    max_timestamp = entry.timestamp;\n                }\n            }\n        }\n\n        AuditStats {\n            total_entries,\n            operations_count,\n            unique_actors: unique_actors.len() as u32,\n            date_range: (min_timestamp, max_timestamp),\n        }\n    }\n\n    /// Validate audit log integrity for an invoice\n    pub fn validate_invoice_audit_integrity(\n        env: \u0026Env,\n        invoice_id: \u0026BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let audit_trail = Self::get_invoice_audit_trail(env, invoice_id);\n\n        for audit_id in audit_trail.iter() {\n            if let Some(entry) = Self::get_audit_entry(env, \u0026audit_id) {\n                if !entry.validate_integrity(env)? {\n                    return Ok(false);\n                }\n            } else {\n                return Ok(false); // Missing audit entry\n            }\n        }\n\n        Ok(true)\n    }\n\n    // Helper methods\n    fn add_to_invoice_audit_trail(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"inv_aud\"), invoice_id.clone());\n        let mut trail = Self::get_invoice_audit_trail(env, invoice_id);\n        trail.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026trail);\n    }\n\n    fn add_to_operation_index(env: \u0026Env, operation: \u0026AuditOperation, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"op_aud\"), operation.clone());\n        let mut entries = Self::get_audit_entries_by_operation(env, operation);\n        entries.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026entries);\n    }\n\n    fn add_to_actor_index(env: \u0026Env, actor: \u0026Address, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"act_aud\"), actor.clone());\n        let mut entries = Self::get_audit_entries_by_actor(env, actor);\n        entries.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026entries);\n    }\n\n    fn add_to_timestamp_index(env: \u0026Env, timestamp: u64, audit_id: \u0026BytesN\u003c32\u003e) {\n        let day_key = timestamp / 86400; // Group by day\n        let key = (symbol_short!(\"ts_aud\"), day_key);\n        let mut entries: Vec\u003cBytesN\u003c32\u003e\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env));\n        entries.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026entries);\n    }\n\n    fn add_to_all_audit_entries(env: \u0026Env, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = symbol_short!(\"all_aud\");\n        let mut all: Vec\u003cBytesN\u003c32\u003e\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env));\n        all.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026all);\n    }\n\n    fn get_all_audit_entries(env: \u0026Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = symbol_short!(\"all_aud\");\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    fn matches_filter(entry: \u0026AuditLogEntry, filter: \u0026AuditQueryFilter) -\u003e bool {\n        if let Some(invoice_id) = \u0026filter.invoice_id {\n            if entry.invoice_id != *invoice_id {\n                return false;\n            }\n        }\n\n        match \u0026filter.operation {\n            AuditOperationFilter::Any =\u003e {}\n            AuditOperationFilter::Specific(operation) =\u003e {\n                if entry.operation != *operation {\n                    return false;\n                }\n            }\n        }\n\n        if let Some(actor) = \u0026filter.actor {\n            if entry.actor != *actor {\n                return false;\n            }\n        }\n\n        if let Some(start_ts) = filter.start_timestamp {\n            if entry.timestamp \u003c start_ts {\n                return false;\n            }\n        }\n\n        if let Some(end_ts) = filter.end_timestamp {\n            if entry.timestamp \u003e end_ts {\n                return false;\n            }\n        }\n\n        true\n    }\n}\n\n/// Audit trail helper functions\npub fn log_invoice_operation(\n    env: \u0026Env,\n    invoice_id: BytesN\u003c32\u003e,\n    operation: AuditOperation,\n    actor: Address,\n    old_value: Option\u003cString\u003e,\n    new_value: Option\u003cString\u003e,\n    amount: Option\u003ci128\u003e,\n    additional_data: Option\u003cString\u003e,\n) {\n    let entry = AuditLogEntry::new(\n        env,\n        invoice_id,\n        operation,\n        actor,\n        old_value,\n        new_value,\n        amount,\n        additional_data,\n    );\n\n    AuditStorage::store_audit_entry(env, \u0026entry);\n}\n\n/// Log invoice creation\npub fn log_invoice_created(env: \u0026Env, invoice: \u0026Invoice) {\n    log_invoice_operation(\n        env,\n        invoice.id.clone(),\n        AuditOperation::InvoiceCreated,\n        invoice.business.clone(),\n        None,\n        Some(String::from_str(env, \"Invoice created\")),\n        Some(invoice.amount),\n        Some(invoice.description.clone()),\n    );\n}\n\n/// Log invoice status change\npub fn log_invoice_status_change(\n    env: \u0026Env,\n    invoice_id: BytesN\u003c32\u003e,\n    actor: Address,\n    _old_status: InvoiceStatus,\n    _new_status: InvoiceStatus,\n) {\n    let old_value = String::from_str(env, \"Status changed\");\n    let new_value = String::from_str(env, \"Status updated\");\n\n    log_invoice_operation(\n        env,\n        invoice_id,\n        AuditOperation::InvoiceStatusChanged,\n        actor,\n        Some(old_value),\n        Some(new_value),\n        None,\n        None,\n    );\n}\n\n/// Log invoice funding\npub fn log_invoice_funded(env: \u0026Env, invoice_id: BytesN\u003c32\u003e, investor: Address, amount: i128) {\n    log_invoice_operation(\n        env,\n        invoice_id,\n        AuditOperation::InvoiceFunded,\n        investor,\n        None,\n        Some(String::from_str(env, \"Funded\")),\n        Some(amount),\n        None,\n    );\n}\n\n/// Log payment processing\npub fn log_payment_processed(\n    env: \u0026Env,\n    invoice_id: BytesN\u003c32\u003e,\n    actor: Address,\n    amount: i128,\n    payment_type: String,\n) {\n    log_invoice_operation(\n        env,\n        invoice_id,\n        AuditOperation::PaymentProcessed,\n        actor,\n        None,\n        Some(String::from_str(env, \"Payment processed\")),\n        Some(amount),\n        Some(payment_type),\n    );\n}\n","traces":[{"line":75,"address":[15264076,15264146,15262944],"length":1,"stats":{"Line":1}},{"line":85,"address":[15263131],"length":1,"stats":{"Line":1}},{"line":86,"address":[15263192,15263240],"length":1,"stats":{"Line":2}},{"line":87,"address":[15263350],"length":1,"stats":{"Line":1}},{"line":105,"address":[15262338,15260416,15262344],"length":1,"stats":{"Line":1}},{"line":106,"address":[15260471],"length":1,"stats":{"Line":1}},{"line":107,"address":[15260604],"length":1,"stats":{"Line":1}},{"line":108,"address":[15260718],"length":1,"stats":{"Line":1}},{"line":109,"address":[15260771,15260822],"length":1,"stats":{"Line":2}},{"line":110,"address":[15261079],"length":1,"stats":{"Line":1}},{"line":112,"address":[15261334],"length":1,"stats":{"Line":1}},{"line":114,"address":[15261354],"length":1,"stats":{"Line":1}},{"line":115,"address":[15261362],"length":1,"stats":{"Line":1}},{"line":117,"address":[15261370],"length":1,"stats":{"Line":1}},{"line":119,"address":[15261556],"length":1,"stats":{"Line":1}},{"line":121,"address":[15261730],"length":1,"stats":{"Line":1}},{"line":123,"address":[15262302,15261886],"length":1,"stats":{"Line":2}},{"line":124,"address":[15262048,15262312,15262148],"length":1,"stats":{"Line":2}},{"line":126,"address":[15262086],"length":1,"stats":{"Line":1}},{"line":130,"address":[15262368,15262915,15262921],"length":1,"stats":{"Line":0}},{"line":132,"address":[15262401,15262577],"length":1,"stats":{"Line":0}},{"line":133,"address":[15262588],"length":1,"stats":{"Line":0}},{"line":137,"address":[15262529,15262603,15262727],"length":1,"stats":{"Line":0}},{"line":138,"address":[15262741],"length":1,"stats":{"Line":0}},{"line":142,"address":[15262681],"length":1,"stats":{"Line":0}},{"line":144,"address":[15262770,15262853],"length":1,"stats":{"Line":0}},{"line":145,"address":[15262903],"length":1,"stats":{"Line":0}},{"line":149,"address":[15262786],"length":1,"stats":{"Line":0}},{"line":150,"address":[15262825],"length":1,"stats":{"Line":0}},{"line":156,"address":[15262753],"length":1,"stats":{"Line":0}},{"line":165,"address":[15253876,15253882,15253552],"length":1,"stats":{"Line":1}},{"line":167,"address":[15253594],"length":1,"stats":{"Line":1}},{"line":170,"address":[15253753],"length":1,"stats":{"Line":1}},{"line":173,"address":[15253778],"length":1,"stats":{"Line":1}},{"line":176,"address":[15253806],"length":1,"stats":{"Line":2}},{"line":179,"address":[15253834],"length":1,"stats":{"Line":2}},{"line":182,"address":[15253859],"length":1,"stats":{"Line":1}},{"line":186,"address":[15251050,15251044,15250832],"length":1,"stats":{"Line":0}},{"line":187,"address":[15250877,15250959],"length":1,"stats":{"Line":0}},{"line":191,"address":[15256352,15256942,15256948],"length":1,"stats":{"Line":1}},{"line":192,"address":[15256401],"length":1,"stats":{"Line":1}},{"line":193,"address":[15256600],"length":1,"stats":{"Line":1}},{"line":195,"address":[15256729],"length":1,"stats":{"Line":1}},{"line":196,"address":[12250449,12250432],"length":1,"stats":{"Line":3}},{"line":200,"address":[15259494,15258944,15259488],"length":1,"stats":{"Line":2}},{"line":204,"address":[15258995],"length":1,"stats":{"Line":1}},{"line":205,"address":[15259146],"length":1,"stats":{"Line":2}},{"line":207,"address":[15259275],"length":1,"stats":{"Line":1}},{"line":208,"address":[12250593,12250576],"length":1,"stats":{"Line":5}},{"line":212,"address":[15258336,15258922,15258928],"length":1,"stats":{"Line":2}},{"line":213,"address":[15258385],"length":1,"stats":{"Line":1}},{"line":214,"address":[15258580],"length":1,"stats":{"Line":2}},{"line":216,"address":[15258709],"length":1,"stats":{"Line":1}},{"line":217,"address":[12250528,12250545],"length":1,"stats":{"Line":5}},{"line":221,"address":[15253435,15253523,15252320],"length":1,"stats":{"Line":0}},{"line":226,"address":[15252374],"length":1,"stats":{"Line":0}},{"line":227,"address":[15252413],"length":1,"stats":{"Line":0}},{"line":230,"address":[15252424],"length":1,"stats":{"Line":0}},{"line":231,"address":[15252580,15252485],"length":1,"stats":{"Line":0}},{"line":232,"address":[15252497,15252618],"length":1,"stats":{"Line":0}},{"line":233,"address":[15252683,15252634],"length":1,"stats":{"Line":0}},{"line":234,"address":[15252695,15252646],"length":1,"stats":{"Line":0}},{"line":235,"address":[15252738,15252711],"length":1,"stats":{"Line":0}},{"line":238,"address":[15252731,15252743],"length":1,"stats":{"Line":0}},{"line":241,"address":[15252808,15252598,15252904],"length":1,"stats":{"Line":0}},{"line":242,"address":[15252961],"length":1,"stats":{"Line":0}},{"line":246,"address":[15253081,15253397,15253011],"length":1,"stats":{"Line":0}},{"line":248,"address":[15253176,15253254,15253367],"length":1,"stats":{"Line":0}},{"line":249,"address":[15253276],"length":1,"stats":{"Line":0}},{"line":250,"address":[15253369,15253336],"length":1,"stats":{"Line":0}},{"line":255,"address":[15253446],"length":1,"stats":{"Line":0}},{"line":259,"address":[15252303,15251072,15251833],"length":1,"stats":{"Line":0}},{"line":260,"address":[15251102],"length":1,"stats":{"Line":0}},{"line":261,"address":[15251191,15251130],"length":1,"stats":{"Line":0}},{"line":263,"address":[15251203],"length":1,"stats":{"Line":0}},{"line":264,"address":[15251223],"length":1,"stats":{"Line":0}},{"line":265,"address":[15251280],"length":1,"stats":{"Line":0}},{"line":266,"address":[15251292],"length":1,"stats":{"Line":0}},{"line":268,"address":[15251381,15251474,15251317],"length":1,"stats":{"Line":0}},{"line":269,"address":[15251883,15251570],"length":1,"stats":{"Line":0}},{"line":271,"address":[12250208,12250235],"length":1,"stats":{"Line":0}},{"line":272,"address":[15252144],"length":1,"stats":{"Line":0}},{"line":276,"address":[15252250,15252196],"length":1,"stats":{"Line":0}},{"line":277,"address":[15252234],"length":1,"stats":{"Line":0}},{"line":279,"address":[15252286,15252214],"length":1,"stats":{"Line":0}},{"line":280,"address":[15252270],"length":1,"stats":{"Line":0}},{"line":288,"address":[15251653],"length":1,"stats":{"Line":0}},{"line":289,"address":[15251717],"length":1,"stats":{"Line":0}},{"line":294,"address":[15260399,15259520,15260362],"length":1,"stats":{"Line":0}},{"line":298,"address":[15259564],"length":1,"stats":{"Line":0}},{"line":300,"address":[15259733,15259582,15259643],"length":1,"stats":{"Line":0}},{"line":301,"address":[15259829,15259929],"length":1,"stats":{"Line":0}},{"line":302,"address":[15260320,15260088,15260016],"length":1,"stats":{"Line":0}},{"line":303,"address":[15260252],"length":1,"stats":{"Line":0}},{"line":306,"address":[15260028],"length":1,"stats":{"Line":0}},{"line":310,"address":[15259851],"length":1,"stats":{"Line":0}},{"line":314,"address":[15258317,15257696,15258323],"length":1,"stats":{"Line":1}},{"line":315,"address":[15257742],"length":1,"stats":{"Line":1}},{"line":316,"address":[15257946],"length":1,"stats":{"Line":1}},{"line":317,"address":[15258055,15257995],"length":1,"stats":{"Line":2}},{"line":318,"address":[15258095],"length":1,"stats":{"Line":1}},{"line":321,"address":[15255584,15254992,15255578],"length":1,"stats":{"Line":1}},{"line":322,"address":[15255051],"length":1,"stats":{"Line":1}},{"line":323,"address":[15255207],"length":1,"stats":{"Line":1}},{"line":324,"address":[15255316,15255256],"length":1,"stats":{"Line":3}},{"line":325,"address":[15255356],"length":1,"stats":{"Line":1}},{"line":328,"address":[15253904,15254527,15254521],"length":1,"stats":{"Line":1}},{"line":329,"address":[15253950],"length":1,"stats":{"Line":2}},{"line":330,"address":[15254150],"length":1,"stats":{"Line":1}},{"line":331,"address":[15254259,15254199],"length":1,"stats":{"Line":3}},{"line":332,"address":[15254299],"length":1,"stats":{"Line":1}},{"line":335,"address":[15256328,15255600,15256322],"length":1,"stats":{"Line":1}},{"line":336,"address":[15255656],"length":1,"stats":{"Line":2}},{"line":337,"address":[15255671],"length":1,"stats":{"Line":1}},{"line":341,"address":[15255850],"length":1,"stats":{"Line":2}},{"line":342,"address":[12250401,12250384],"length":1,"stats":{"Line":3}},{"line":343,"address":[15256051],"length":1,"stats":{"Line":1}},{"line":344,"address":[15256106],"length":1,"stats":{"Line":2}},{"line":347,"address":[15257665,15257671,15256976],"length":1,"stats":{"Line":2}},{"line":348,"address":[15257014],"length":1,"stats":{"Line":1}},{"line":352,"address":[15257192],"length":1,"stats":{"Line":2}},{"line":353,"address":[12250480,12250497],"length":1,"stats":{"Line":3}},{"line":354,"address":[15257393],"length":1,"stats":{"Line":1}},{"line":355,"address":[15257448],"length":1,"stats":{"Line":2}},{"line":358,"address":[15254970,15254544,15254976],"length":1,"stats":{"Line":0}},{"line":359,"address":[15254574],"length":1,"stats":{"Line":0}},{"line":360,"address":[15254618],"length":1,"stats":{"Line":0}},{"line":362,"address":[15254752],"length":1,"stats":{"Line":0}},{"line":363,"address":[12250336,12250353],"length":1,"stats":{"Line":0}},{"line":366,"address":[15250432],"length":1,"stats":{"Line":0}},{"line":367,"address":[15250456],"length":1,"stats":{"Line":0}},{"line":368,"address":[15250506],"length":1,"stats":{"Line":0}},{"line":369,"address":[15250566],"length":1,"stats":{"Line":0}},{"line":373,"address":[15250524],"length":1,"stats":{"Line":0}},{"line":375,"address":[15250592],"length":1,"stats":{"Line":0}},{"line":376,"address":[15250597],"length":1,"stats":{"Line":0}},{"line":377,"address":[15250654],"length":1,"stats":{"Line":0}},{"line":382,"address":[15250618,15250670],"length":1,"stats":{"Line":0}},{"line":383,"address":[15250675],"length":1,"stats":{"Line":0}},{"line":384,"address":[15250708],"length":1,"stats":{"Line":0}},{"line":388,"address":[15250728,15250697],"length":1,"stats":{"Line":0}},{"line":389,"address":[15250737],"length":1,"stats":{"Line":0}},{"line":390,"address":[15250763],"length":1,"stats":{"Line":0}},{"line":394,"address":[15250783,15250751],"length":1,"stats":{"Line":0}},{"line":395,"address":[15250792],"length":1,"stats":{"Line":0}},{"line":400,"address":[15250816],"length":1,"stats":{"Line":0}},{"line":405,"address":[15271019,15270560],"length":1,"stats":{"Line":1}},{"line":426,"address":[15270957],"length":1,"stats":{"Line":1}},{"line":430,"address":[15264800,15265434,15265496],"length":1,"stats":{"Line":1}},{"line":433,"address":[15264865],"length":1,"stats":{"Line":1}},{"line":435,"address":[15264896,15264961],"length":1,"stats":{"Line":2}},{"line":436,"address":[15264969],"length":1,"stats":{"Line":1}},{"line":437,"address":[15264985,15265058],"length":1,"stats":{"Line":2}},{"line":438,"address":[15265114],"length":1,"stats":{"Line":1}},{"line":439,"address":[15265138,15265216],"length":1,"stats":{"Line":2}},{"line":444,"address":[15272356,15271728,15272322],"length":1,"stats":{"Line":2}},{"line":451,"address":[15271888,15271778],"length":1,"stats":{"Line":3}},{"line":452,"address":[15271896],"length":1,"stats":{"Line":1}},{"line":456,"address":[15271976],"length":1,"stats":{"Line":2}},{"line":458,"address":[15272019],"length":1,"stats":{"Line":1}},{"line":459,"address":[15272062],"length":1,"stats":{"Line":2}},{"line":460,"address":[15272157],"length":1,"stats":{"Line":1}},{"line":462,"address":[15272205],"length":1,"stats":{"Line":2}},{"line":467,"address":[15264730,15264256,15264767],"length":1,"stats":{"Line":3}},{"line":470,"address":[15264332],"length":1,"stats":{"Line":3}},{"line":472,"address":[15264366],"length":1,"stats":{"Line":3}},{"line":473,"address":[15264409],"length":1,"stats":{"Line":3}},{"line":474,"address":[15264425,15264508],"length":1,"stats":{"Line":6}},{"line":476,"address":[15264556],"length":1,"stats":{"Line":3}},{"line":481,"address":[15271040,15271623,15271688],"length":1,"stats":{"Line":2}},{"line":490,"address":[15271137],"length":1,"stats":{"Line":2}},{"line":492,"address":[15271171],"length":1,"stats":{"Line":2}},{"line":493,"address":[15271214],"length":1,"stats":{"Line":2}},{"line":494,"address":[15271230,15271318],"length":1,"stats":{"Line":4}},{"line":496,"address":[15271366],"length":1,"stats":{"Line":2}}],"covered":98,"coverable":175},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","backup.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::invoice::Invoice;\nuse soroban_sdk::{contracttype, symbol_short, BytesN, Env, String, Vec};\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Backup {\n    pub backup_id: BytesN\u003c32\u003e,\n    pub timestamp: u64,\n    pub description: String,\n    pub invoice_count: u32,\n    pub status: BackupStatus,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum BackupStatus {\n    Active,\n    Archived,\n    Corrupted,\n}\n\npub struct BackupStorage;\n\nimpl BackupStorage {\n    /// Generate a unique backup ID\n    pub fn generate_backup_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"bkup_cnt\");\n        let counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add backup prefix\n        id_bytes[0] = 0xB4; // 'B' for Backup\n        id_bytes[1] = 0xC4; // 'C' for baCkup\n                            // Embed timestamp\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter\n        id_bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes\n        for i in 18..32 {\n            id_bytes[i] = ((timestamp + counter + 0xB4C4) % 256) as u8;\n        }\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    /// Store a backup record\n    pub fn store_backup(env: \u0026Env, backup: \u0026Backup) {\n        env.storage().instance().set(\u0026backup.backup_id, backup);\n    }\n\n    /// Get a backup by ID\n    pub fn get_backup(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBackup\u003e {\n        env.storage().instance().get(backup_id)\n    }\n\n    /// Update a backup record\n    pub fn update_backup(env: \u0026Env, backup: \u0026Backup) {\n        env.storage().instance().set(\u0026backup.backup_id, backup);\n    }\n\n    /// Get all backup IDs\n    pub fn get_all_backups(env: \u0026Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = symbol_short!(\"backups\");\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Add backup to the list of all backups\n    pub fn add_to_backup_list(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) {\n        let mut backups = Self::get_all_backups(env);\n        backups.push_back(backup_id.clone());\n        env.storage()\n            .instance()\n            .set(\u0026symbol_short!(\"backups\"), \u0026backups);\n    }\n\n    /// Remove backup from the list (when archived or corrupted)\n    pub fn remove_from_backup_list(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) {\n        let backups = Self::get_all_backups(env);\n        let mut new_backups = Vec::new(env);\n        for id in backups.iter() {\n            if id != *backup_id {\n                new_backups.push_back(id);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026symbol_short!(\"backups\"), \u0026new_backups);\n    }\n\n    /// Store invoice data for a backup\n    pub fn store_backup_data(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, invoices: \u0026Vec\u003cInvoice\u003e) {\n        let key = (symbol_short!(\"bkup_data\"), backup_id.clone());\n        env.storage().instance().set(\u0026key, invoices);\n    }\n\n    /// Get invoice data from a backup\n    pub fn get_backup_data(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cVec\u003cInvoice\u003e\u003e {\n        let key = (symbol_short!(\"bkup_data\"), backup_id.clone());\n        env.storage().instance().get(\u0026key)\n    }\n\n    /// Validate backup data integrity\n    pub fn validate_backup(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let backup = Self::get_backup(env, backup_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        let data =\n            Self::get_backup_data(env, backup_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Check if count matches\n        if data.len() as u32 != backup.invoice_count {\n            return Err(QuickLendXError::StorageError);\n        }\n\n        // Check each invoice has valid data\n        for invoice in data.iter() {\n            if invoice.amount \u003c= 0 {\n                return Err(QuickLendXError::StorageError);\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Clean up old backups (keep only the last N)\n    pub fn cleanup_old_backups(env: \u0026Env, max_backups: u32) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let backups = Self::get_all_backups(env);\n        let max_backups: usize = max_backups.try_into().unwrap();\n\n        if backups.len() \u003c= max_backups.try_into().unwrap() {\n            return Ok(());\n        }\n\n        // Create a vector of tuples (backup_id, timestamp) for sorting\n        let mut backup_timestamps = Vec::new(env);\n        for backup_id in backups.iter() {\n            if let Some(backup) = Self::get_backup(env, \u0026backup_id) {\n                backup_timestamps.push_back((backup_id, backup.timestamp));\n            }\n        }\n\n        // Sort by timestamp (oldest first) using bubble sort\n        // This is a simple sorting algorithm that works well for small lists\n        let len = backup_timestamps.len();\n        for i in 0..len {\n            for j in 0..len - i - 1 {\n                if backup_timestamps.get(j).unwrap().1 \u003e backup_timestamps.get(j + 1).unwrap().1 {\n                    let temp = backup_timestamps.get(j).unwrap().clone();\n                    backup_timestamps.set(j, backup_timestamps.get(j + 1).unwrap().clone());\n                    backup_timestamps.set(j + 1, temp);\n                }\n            }\n        }\n\n        // Remove oldest backups until we're under the limit\n        while backup_timestamps.len() \u003e max_backups.try_into().unwrap() {\n            if let Some((oldest_id, _)) = backup_timestamps.first() {\n                Self::remove_from_backup_list(env, \u0026oldest_id);\n                backup_timestamps.remove(0);\n            }\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":27,"address":[12854384,12855927,12855933],"length":1,"stats":{"Line":0}},{"line":28,"address":[12854439],"length":1,"stats":{"Line":0}},{"line":29,"address":[12854556],"length":1,"stats":{"Line":0}},{"line":30,"address":[12854609,12854660],"length":1,"stats":{"Line":0}},{"line":31,"address":[12854917],"length":1,"stats":{"Line":0}},{"line":33,"address":[12855172],"length":1,"stats":{"Line":0}},{"line":35,"address":[12855192],"length":1,"stats":{"Line":0}},{"line":36,"address":[12855200],"length":1,"stats":{"Line":0}},{"line":38,"address":[12855208],"length":1,"stats":{"Line":0}},{"line":40,"address":[12855376],"length":1,"stats":{"Line":0}},{"line":42,"address":[12855532,12855891],"length":1,"stats":{"Line":0}},{"line":43,"address":[12855783,12855901,12855695],"length":1,"stats":{"Line":0}},{"line":46,"address":[12855729],"length":1,"stats":{"Line":0}},{"line":50,"address":[12851025,12850832,12851031],"length":1,"stats":{"Line":0}},{"line":51,"address":[12850870],"length":1,"stats":{"Line":0}},{"line":55,"address":[12850810,12850592,12850804],"length":1,"stats":{"Line":0}},{"line":56,"address":[12850637,12850719],"length":1,"stats":{"Line":0}},{"line":60,"address":[12851056,12851255,12851249],"length":1,"stats":{"Line":0}},{"line":61,"address":[12851094],"length":1,"stats":{"Line":0}},{"line":65,"address":[12851280,12851706,12851712],"length":1,"stats":{"Line":0}},{"line":66,"address":[12851310],"length":1,"stats":{"Line":0}},{"line":67,"address":[12851354],"length":1,"stats":{"Line":0}},{"line":69,"address":[12851488],"length":1,"stats":{"Line":0}},{"line":70,"address":[12851543],"length":1,"stats":{"Line":0}},{"line":74,"address":[12854366,12853920,12854360],"length":1,"stats":{"Line":0}},{"line":75,"address":[12853963],"length":1,"stats":{"Line":0}},{"line":76,"address":[12853973,12854030],"length":1,"stats":{"Line":0}},{"line":77,"address":[12854063],"length":1,"stats":{"Line":0}},{"line":79,"address":[12854094,12854135],"length":1,"stats":{"Line":0}},{"line":83,"address":[12859575,12858624,12859370],"length":1,"stats":{"Line":0}},{"line":84,"address":[12858663],"length":1,"stats":{"Line":0}},{"line":85,"address":[12858686],"length":1,"stats":{"Line":0}},{"line":86,"address":[12858756,12858814,12858904,12859529],"length":1,"stats":{"Line":0}},{"line":87,"address":[12859000,12859421],"length":1,"stats":{"Line":0}},{"line":88,"address":[12859439],"length":1,"stats":{"Line":0}},{"line":91,"address":[12859042],"length":1,"stats":{"Line":0}},{"line":93,"address":[12859076,12859120],"length":1,"stats":{"Line":0}},{"line":97,"address":[12853893,12853424,12853887],"length":1,"stats":{"Line":0}},{"line":98,"address":[12853464],"length":1,"stats":{"Line":0}},{"line":99,"address":[12853653,12853697],"length":1,"stats":{"Line":0}},{"line":103,"address":[12852283,12852289,12851728],"length":1,"stats":{"Line":0}},{"line":104,"address":[12851777],"length":1,"stats":{"Line":0}},{"line":105,"address":[12852020,12851976,12852102],"length":1,"stats":{"Line":0}},{"line":109,"address":[12853377,12853405,12852304],"length":1,"stats":{"Line":0}},{"line":110,"address":[12852343],"length":1,"stats":{"Line":0}},{"line":112,"address":[12852754,12853399,12852689],"length":1,"stats":{"Line":0}},{"line":116,"address":[12853003,12852950],"length":1,"stats":{"Line":0}},{"line":117,"address":[12853035],"length":1,"stats":{"Line":0}},{"line":121,"address":[12853028,12853064,12853160],"length":1,"stats":{"Line":0}},{"line":122,"address":[12853218],"length":1,"stats":{"Line":0}},{"line":123,"address":[12853324],"length":1,"stats":{"Line":0}},{"line":127,"address":[12853261],"length":1,"stats":{"Line":0}},{"line":131,"address":[12855952,12857130,12858604],"length":1,"stats":{"Line":0}},{"line":132,"address":[12855988],"length":1,"stats":{"Line":0}},{"line":133,"address":[12856021,12856108],"length":1,"stats":{"Line":0}},{"line":135,"address":[12856152],"length":1,"stats":{"Line":0}},{"line":136,"address":[12856249],"length":1,"stats":{"Line":0}},{"line":140,"address":[12856242],"length":1,"stats":{"Line":0}},{"line":141,"address":[12858558,12856358,12856295,12856451],"length":1,"stats":{"Line":0}},{"line":142,"address":[12858197,12856555],"length":1,"stats":{"Line":0}},{"line":143,"address":[12858340],"length":1,"stats":{"Line":0}},{"line":149,"address":[12856588],"length":1,"stats":{"Line":0}},{"line":150,"address":[12856610],"length":1,"stats":{"Line":0}},{"line":151,"address":[12857140,12856735],"length":1,"stats":{"Line":0}},{"line":152,"address":[12857343,12858133],"length":1,"stats":{"Line":0}},{"line":153,"address":[12857626],"length":1,"stats":{"Line":0}},{"line":154,"address":[12857794],"length":1,"stats":{"Line":0}},{"line":155,"address":[12857994],"length":1,"stats":{"Line":0}},{"line":161,"address":[12856764],"length":1,"stats":{"Line":0}},{"line":162,"address":[12856883,12856919],"length":1,"stats":{"Line":0}},{"line":163,"address":[12857007],"length":1,"stats":{"Line":0}},{"line":164,"address":[12857104],"length":1,"stats":{"Line":0}},{"line":168,"address":[12856841],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","bid.rs"],"content":"use core::cmp::Ordering;\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env, Vec};\n\nuse crate::events::emit_bid_expired;\n\nconst DEFAULT_BID_TTL: u64 = 7 * 24 * 60 * 60;\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum BidStatus {\n    Placed,\n    Withdrawn,\n    Accepted,\n    Expired,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Bid {\n    pub bid_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub investor: Address,\n    pub bid_amount: i128,\n    pub expected_return: i128,\n    pub timestamp: u64,\n    pub status: BidStatus,\n    pub expiration_timestamp: u64,\n}\n\nimpl Bid {\n    pub fn is_expired(\u0026self, current_timestamp: u64) -\u003e bool {\n        current_timestamp \u003e self.expiration_timestamp\n    }\n\n    pub fn default_expiration(now: u64) -\u003e u64 {\n        now.saturating_add(DEFAULT_BID_TTL)\n    }\n}\n\npub struct BidStorage;\n\nimpl BidStorage {\n    fn invoice_key(invoice_id: \u0026BytesN\u003c32\u003e) -\u003e (soroban_sdk::Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"bids\"), invoice_id.clone())\n    }\n\n    pub fn store_bid(env: \u0026Env, bid: \u0026Bid) {\n        env.storage().instance().set(\u0026bid.bid_id, bid);\n    }\n    pub fn get_bid(env: \u0026Env, bid_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        env.storage().instance().get(bid_id)\n    }\n    pub fn update_bid(env: \u0026Env, bid: \u0026Bid) {\n        env.storage().instance().set(\u0026bid.bid_id, bid);\n    }\n    pub fn get_bids_for_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::invoice_key(invoice_id))\n            .unwrap_or_else(|| Vec::new(env))\n    }\n    pub fn add_bid_to_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, bid_id: \u0026BytesN\u003c32\u003e) {\n        let mut bids = Self::get_bids_for_invoice(env, invoice_id);\n        let mut exists = false;\n        let mut idx: u32 = 0;\n        while idx \u003c bids.len() {\n            if bids.get(idx).unwrap() == *bid_id {\n                exists = true;\n                break;\n            }\n            idx += 1;\n        }\n        if !exists {\n            bids.push_back(bid_id.clone());\n            env.storage()\n                .instance()\n                .set(\u0026Self::invoice_key(invoice_id), \u0026bids);\n        }\n    }\n    fn refresh_expired_bids(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e u32 {\n        let current_timestamp = env.ledger().timestamp();\n        let bid_ids = Self::get_bids_for_invoice(env, invoice_id);\n        let mut active = Vec::new(env);\n        let mut expired = 0u32;\n        let mut idx: u32 = 0;\n        while idx \u003c bid_ids.len() {\n            let bid_id = bid_ids.get(idx).unwrap();\n            if let Some(mut bid) = Self::get_bid(env, \u0026bid_id) {\n                if bid.status == BidStatus::Placed \u0026\u0026 bid.is_expired(current_timestamp) {\n                    bid.status = BidStatus::Expired;\n                    Self::update_bid(env, \u0026bid);\n                    emit_bid_expired(env, \u0026bid);\n                    expired += 1;\n                } else {\n                    active.push_back(bid_id);\n                }\n            }\n            idx += 1;\n        }\n\n        env.storage()\n            .instance()\n            .set(\u0026Self::invoice_key(invoice_id), \u0026active);\n\n        expired\n    }\n\n    pub fn cleanup_expired_bids(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e u32 {\n        Self::refresh_expired_bids(env, invoice_id)\n    }\n\n    pub fn get_bid_records_for_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        let _ = Self::refresh_expired_bids(env, invoice_id);\n        let mut bids = Vec::new(env);\n        for bid_id in Self::get_bids_for_invoice(env, invoice_id).iter() {\n            if let Some(bid) = Self::get_bid(env, \u0026bid_id) {\n                bids.push_back(bid);\n            }\n        }\n        bids\n    }\n    pub fn get_bids_by_status(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, status: BidStatus) -\u003e Vec\u003cBid\u003e {\n        let mut filtered = Vec::new(env);\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let bid = records.get(idx).unwrap();\n            if bid.status == status {\n                filtered.push_back(bid);\n            }\n            idx += 1;\n        }\n        filtered\n    }\n    pub fn get_bids_by_investor(\n        env: \u0026Env,\n        invoice_id: \u0026BytesN\u003c32\u003e,\n        investor: \u0026Address,\n    ) -\u003e Vec\u003cBid\u003e {\n        let mut filtered = Vec::new(env);\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let bid = records.get(idx).unwrap();\n            if \u0026bid.investor == investor {\n                filtered.push_back(bid);\n            }\n            idx += 1;\n        }\n        filtered\n    }\n    pub fn compare_bids(bid1: \u0026Bid, bid2: \u0026Bid) -\u003e Ordering {\n        let profit1 = bid1.expected_return - bid1.bid_amount;\n        let profit2 = bid2.expected_return - bid2.bid_amount;\n        if profit1 != profit2 {\n            return profit1.cmp(\u0026profit2);\n        }\n        if bid1.expected_return != bid2.expected_return {\n            return bid1.expected_return.cmp(\u0026bid2.expected_return);\n        }\n        if bid1.bid_amount != bid2.bid_amount {\n            return bid1.bid_amount.cmp(\u0026bid2.bid_amount);\n        }\n        if bid1.timestamp != bid2.timestamp {\n            return bid2.timestamp.cmp(\u0026bid1.timestamp);\n        }\n        Ordering::Equal\n    }\n    pub fn get_best_bid(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut best: Option\u003cBid\u003e = None;\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let candidate = records.get(idx).unwrap();\n            if candidate.status != BidStatus::Placed {\n                idx += 1;\n                continue;\n            }\n            best = match best {\n                None =\u003e Some(candidate),\n                Some(current) =\u003e {\n                    if Self::compare_bids(\u0026candidate, \u0026current) == Ordering::Greater {\n                        Some(candidate)\n                    } else {\n                        Some(current)\n                    }\n                }\n            };\n            idx += 1;\n        }\n        best\n    }\n    pub fn rank_bids(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut remaining = Vec::new(env);\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let bid = records.get(idx).unwrap();\n            if bid.status == BidStatus::Placed {\n                remaining.push_back(bid);\n            }\n            idx += 1;\n        }\n\n        let mut ranked = Vec::new(env);\n\n        while remaining.len() \u003e 0 {\n            let mut best_idx: u32 = 0;\n            let mut best_bid = remaining.get(0).unwrap();\n            let mut search_idx: u32 = 1;\n            while search_idx \u003c remaining.len() {\n                let candidate = remaining.get(search_idx).unwrap();\n                if Self::compare_bids(\u0026candidate, \u0026best_bid) == Ordering::Greater {\n                    best_idx = search_idx;\n                    best_bid = candidate;\n                }\n                search_idx += 1;\n            }\n            ranked.push_back(best_bid);\n\n            let mut new_remaining = Vec::new(env);\n            let mut copy_idx: u32 = 0;\n            while copy_idx \u003c remaining.len() {\n                if copy_idx != best_idx {\n                    new_remaining.push_back(remaining.get(copy_idx).unwrap());\n                }\n                copy_idx += 1;\n            }\n            remaining = new_remaining;\n        }\n\n        ranked\n    }\n    /// Generates a unique 32-byte bid ID using timestamp and a simple counter.\n    /// This approach avoids potential serialization issues with large counters.\n    pub fn generate_unique_bid_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"bid_cnt\");\n        let mut counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        counter += 1;\n        env.storage().instance().set(\u0026counter_key, \u0026counter);\n\n        let mut bytes = [0u8; 32];\n        // Add bid prefix to distinguish from other entity types\n        bytes[0] = 0xB1; // 'B' for Bid\n        bytes[1] = 0xD0; // 'D' for biD\n                         // Embed timestamp in next 8 bytes\n        bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter in next 8 bytes\n        bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes with a pattern to ensure uniqueness\n        for i in 18..32 {\n            bytes[i] = ((timestamp + counter as u64 + 0xB1D0) % 256) as u8;\n        }\n        BytesN::from_array(env, \u0026bytes)\n    }\n}\n","traces":[{"line":31,"address":[12641984],"length":1,"stats":{"Line":3}},{"line":32,"address":[12641994],"length":1,"stats":{"Line":3}},{"line":35,"address":[12642016],"length":1,"stats":{"Line":2}},{"line":36,"address":[12642021],"length":1,"stats":{"Line":1}},{"line":43,"address":[12629984,12630153,12630147],"length":1,"stats":{"Line":2}},{"line":44,"address":[12630005],"length":1,"stats":{"Line":1}},{"line":47,"address":[12640113,12639920,12640119],"length":1,"stats":{"Line":1}},{"line":48,"address":[12639958],"length":1,"stats":{"Line":2}},{"line":50,"address":[12637956,12637744,12637962],"length":1,"stats":{"Line":3}},{"line":51,"address":[12637871,12637789],"length":1,"stats":{"Line":6}},{"line":53,"address":[12629959,12629760,12629953],"length":1,"stats":{"Line":3}},{"line":54,"address":[12629798],"length":1,"stats":{"Line":3}},{"line":56,"address":[12634139,12634145,12633808],"length":1,"stats":{"Line":1}},{"line":57,"address":[12633863],"length":1,"stats":{"Line":2}},{"line":59,"address":[12633945,12634008],"length":1,"stats":{"Line":3}},{"line":60,"address":[12634062],"length":1,"stats":{"Line":4}},{"line":62,"address":[12632426,12631696,12632420],"length":1,"stats":{"Line":2}},{"line":63,"address":[12631751],"length":1,"stats":{"Line":1}},{"line":64,"address":[12631761],"length":1,"stats":{"Line":1}},{"line":65,"address":[12631766],"length":1,"stats":{"Line":2}},{"line":66,"address":[12631774,12631847,12632045],"length":1,"stats":{"Line":3}},{"line":67,"address":[12631867],"length":1,"stats":{"Line":0}},{"line":68,"address":[12632070],"length":1,"stats":{"Line":0}},{"line":71,"address":[12632050,12632022],"length":1,"stats":{"Line":0}},{"line":73,"address":[12631851],"length":1,"stats":{"Line":1}},{"line":74,"address":[12632085,12632123],"length":1,"stats":{"Line":3}},{"line":75,"address":[12632160],"length":1,"stats":{"Line":1}},{"line":77,"address":[12632194],"length":1,"stats":{"Line":0}},{"line":80,"address":[12634160,12634854,12635462],"length":1,"stats":{"Line":1}},{"line":81,"address":[12634199],"length":1,"stats":{"Line":1}},{"line":82,"address":[12634326],"length":1,"stats":{"Line":1}},{"line":83,"address":[12634336],"length":1,"stats":{"Line":2}},{"line":84,"address":[12634396],"length":1,"stats":{"Line":1}},{"line":85,"address":[12634407],"length":1,"stats":{"Line":2}},{"line":86,"address":[12634494,12635416,12634418],"length":1,"stats":{"Line":5}},{"line":87,"address":[12634860,12634518],"length":1,"stats":{"Line":6}},{"line":88,"address":[12634919,12634967],"length":1,"stats":{"Line":6}},{"line":89,"address":[12635345,12635123,12635225,12635024],"length":1,"stats":{"Line":9}},{"line":90,"address":[12635251],"length":1,"stats":{"Line":0}},{"line":91,"address":[12635267],"length":1,"stats":{"Line":0}},{"line":92,"address":[12635307],"length":1,"stats":{"Line":0}},{"line":93,"address":[12635347,12635314],"length":1,"stats":{"Line":0}},{"line":95,"address":[12635274,12635129],"length":1,"stats":{"Line":6}},{"line":98,"address":[12635390,12635050,12635371],"length":1,"stats":{"Line":6}},{"line":101,"address":[12634511],"length":1,"stats":{"Line":2}},{"line":103,"address":[12634575],"length":1,"stats":{"Line":0}},{"line":105,"address":[12634801],"length":1,"stats":{"Line":1}},{"line":108,"address":[12633104],"length":1,"stats":{"Line":1}},{"line":109,"address":[12633118],"length":1,"stats":{"Line":1}},{"line":112,"address":[12637721,12637056,12637727],"length":1,"stats":{"Line":0}},{"line":113,"address":[12637115],"length":1,"stats":{"Line":0}},{"line":114,"address":[12637130],"length":1,"stats":{"Line":0}},{"line":115,"address":[12637364,12637274,12637213,12637153],"length":1,"stats":{"Line":0}},{"line":116,"address":[12637578,12637460],"length":1,"stats":{"Line":0}},{"line":117,"address":[12637719,12637678],"length":1,"stats":{"Line":0}},{"line":120,"address":[12637506],"length":1,"stats":{"Line":0}},{"line":122,"address":[12633063,12633069,12632448],"length":1,"stats":{"Line":0}},{"line":123,"address":[12632497],"length":1,"stats":{"Line":0}},{"line":124,"address":[12632546],"length":1,"stats":{"Line":0}},{"line":125,"address":[12632594],"length":1,"stats":{"Line":0}},{"line":126,"address":[12632674,12632605,12633025],"length":1,"stats":{"Line":0}},{"line":127,"address":[12632777,12632729],"length":1,"stats":{"Line":0}},{"line":128,"address":[12632884,12632815],"length":1,"stats":{"Line":0}},{"line":129,"address":[12632912],"length":1,"stats":{"Line":0}},{"line":131,"address":[12632997,12632890,12632978],"length":1,"stats":{"Line":0}},{"line":133,"address":[12632683],"length":1,"stats":{"Line":0}},{"line":135,"address":[12633136,12633770,12633776],"length":1,"stats":{"Line":0}},{"line":140,"address":[12633184],"length":1,"stats":{"Line":0}},{"line":141,"address":[12633233],"length":1,"stats":{"Line":0}},{"line":142,"address":[12633281],"length":1,"stats":{"Line":0}},{"line":143,"address":[12633361,12633292,12633732],"length":1,"stats":{"Line":0}},{"line":144,"address":[12633416,12633464],"length":1,"stats":{"Line":0}},{"line":145,"address":[12633591,12633502],"length":1,"stats":{"Line":0}},{"line":146,"address":[12633619],"length":1,"stats":{"Line":0}},{"line":148,"address":[12633685,12633597,12633704],"length":1,"stats":{"Line":0}},{"line":150,"address":[12633370],"length":1,"stats":{"Line":0}},{"line":152,"address":[12630176],"length":1,"stats":{"Line":0}},{"line":153,"address":[12630200,12630303],"length":1,"stats":{"Line":0}},{"line":154,"address":[12630363,12630326,12630263],"length":1,"stats":{"Line":0}},{"line":155,"address":[12630336],"length":1,"stats":{"Line":0}},{"line":156,"address":[12630411],"length":1,"stats":{"Line":0}},{"line":158,"address":[12630386],"length":1,"stats":{"Line":0}},{"line":159,"address":[12630478],"length":1,"stats":{"Line":0}},{"line":161,"address":[12630445],"length":1,"stats":{"Line":0}},{"line":162,"address":[12630529],"length":1,"stats":{"Line":0}},{"line":164,"address":[12630507],"length":1,"stats":{"Line":0}},{"line":165,"address":[12630557],"length":1,"stats":{"Line":0}},{"line":167,"address":[12630540],"length":1,"stats":{"Line":0}},{"line":169,"address":[12631553,12631668,12630592],"length":1,"stats":{"Line":0}},{"line":170,"address":[12630625],"length":1,"stats":{"Line":0}},{"line":171,"address":[12630659],"length":1,"stats":{"Line":0}},{"line":172,"address":[12630675],"length":1,"stats":{"Line":0}},{"line":173,"address":[12630686,12630777,12631533],"length":1,"stats":{"Line":0}},{"line":174,"address":[12630840],"length":1,"stats":{"Line":0}},{"line":175,"address":[12630905,12630976],"length":1,"stats":{"Line":0}},{"line":176,"address":[12631585,12631011,12631563],"length":1,"stats":{"Line":0}},{"line":179,"address":[12630982,12631175],"length":1,"stats":{"Line":0}},{"line":180,"address":[12631115],"length":1,"stats":{"Line":0}},{"line":181,"address":[12631040],"length":1,"stats":{"Line":0}},{"line":182,"address":[12631382,12631101,12631279],"length":1,"stats":{"Line":0}},{"line":183,"address":[12631384],"length":1,"stats":{"Line":0}},{"line":185,"address":[12631322],"length":1,"stats":{"Line":0}},{"line":189,"address":[12631206,12631486,12631505],"length":1,"stats":{"Line":0}},{"line":191,"address":[12630786],"length":1,"stats":{"Line":0}},{"line":193,"address":[12639142,12639897,12637984],"length":1,"stats":{"Line":0}},{"line":194,"address":[12638022],"length":1,"stats":{"Line":0}},{"line":195,"address":[12638077],"length":1,"stats":{"Line":0}},{"line":196,"address":[12638121],"length":1,"stats":{"Line":0}},{"line":197,"address":[12638132,12638204,12639859],"length":1,"stats":{"Line":0}},{"line":198,"address":[12638228,12639605],"length":1,"stats":{"Line":0}},{"line":199,"address":[12639714,12639643],"length":1,"stats":{"Line":0}},{"line":200,"address":[12639742],"length":1,"stats":{"Line":0}},{"line":202,"address":[12639720,12639811,12639830],"length":1,"stats":{"Line":0}},{"line":205,"address":[12638258,12638221],"length":1,"stats":{"Line":0}},{"line":207,"address":[12638268,12638323,12638976],"length":1,"stats":{"Line":0}},{"line":208,"address":[12638383],"length":1,"stats":{"Line":0}},{"line":209,"address":[12638412,12638442],"length":1,"stats":{"Line":0}},{"line":210,"address":[12638480],"length":1,"stats":{"Line":0}},{"line":211,"address":[12639549,12638491,12638570],"length":1,"stats":{"Line":0}},{"line":212,"address":[12638637,12639148],"length":1,"stats":{"Line":0}},{"line":213,"address":[12639492,12639202,12639258],"length":1,"stats":{"Line":0}},{"line":214,"address":[12639330],"length":1,"stats":{"Line":0}},{"line":215,"address":[12639344,12639397],"length":1,"stats":{"Line":0}},{"line":217,"address":[12639501,12639520,12639301],"length":1,"stats":{"Line":0}},{"line":219,"address":[12638574],"length":1,"stats":{"Line":0}},{"line":221,"address":[12638683],"length":1,"stats":{"Line":0}},{"line":222,"address":[12638698],"length":1,"stats":{"Line":0}},{"line":223,"address":[12638709,12638788,12639099],"length":1,"stats":{"Line":0}},{"line":224,"address":[12638863],"length":1,"stats":{"Line":0}},{"line":225,"address":[12639003],"length":1,"stats":{"Line":0}},{"line":227,"address":[12639104,12638981,12639092],"length":1,"stats":{"Line":0}},{"line":229,"address":[12638792,12638881],"length":1,"stats":{"Line":0}},{"line":232,"address":[12638333],"length":1,"stats":{"Line":0}},{"line":236,"address":[12637025,12635488,12637031],"length":1,"stats":{"Line":2}},{"line":237,"address":[12635543],"length":1,"stats":{"Line":1}},{"line":238,"address":[12635660],"length":1,"stats":{"Line":2}},{"line":239,"address":[12635713,12635764],"length":1,"stats":{"Line":3}},{"line":240,"address":[12636072,12636005],"length":1,"stats":{"Line":1}},{"line":241,"address":[12636065,12636092],"length":1,"stats":{"Line":3}},{"line":243,"address":[12636273],"length":1,"stats":{"Line":2}},{"line":245,"address":[12636293],"length":1,"stats":{"Line":1}},{"line":246,"address":[12636301],"length":1,"stats":{"Line":1}},{"line":248,"address":[12636309],"length":1,"stats":{"Line":2}},{"line":250,"address":[12636477],"length":1,"stats":{"Line":1}},{"line":252,"address":[12636633,12636989],"length":1,"stats":{"Line":3}},{"line":253,"address":[12636999,12636881,12636788],"length":1,"stats":{"Line":3}},{"line":255,"address":[12636827],"length":1,"stats":{"Line":2}}],"covered":54,"coverable":147},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","defaults.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::events::{\n    emit_dispute_created, emit_dispute_resolved, emit_dispute_under_review, emit_insurance_claimed,\n    emit_invoice_defaulted, emit_invoice_expired,\n};\nuse crate::investment::{InvestmentStatus, InvestmentStorage};\nuse crate::invoice::{Dispute, DisputeStatus, InvoiceStatus, InvoiceStorage};\nuse crate::notifications::NotificationSystem;\nuse soroban_sdk::{Address, BytesN, Env, String, Vec};\n\npub fn handle_default(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n    if !invoice.is_overdue(env.ledger().timestamp()) {\n        return Err(QuickLendXError::OperationNotAllowed);\n    }\n    InvoiceStorage::remove_from_status_invoices(env, \u0026InvoiceStatus::Funded, invoice_id);\n    invoice.mark_as_defaulted();\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n    InvoiceStorage::add_to_status_invoices(env, \u0026InvoiceStatus::Defaulted, invoice_id);\n    emit_invoice_expired(env, \u0026invoice);\n    if let Some(mut investment) = InvestmentStorage::get_investment_by_invoice(env, invoice_id) {\n        investment.status = InvestmentStatus::Defaulted;\n\n        let claim_details = investment\n            .process_insurance_claim()\n            .and_then(|(provider, amount)| {\n                if amount \u003e 0 {\n                    Some((provider, amount))\n                } else {\n                    None\n                }\n            });\n\n        InvestmentStorage::update_investment(env, \u0026investment);\n\n        if let Some((provider, coverage_amount)) = claim_details {\n            emit_insurance_claimed(\n                env,\n                \u0026investment.investment_id,\n                \u0026investment.invoice_id,\n                \u0026provider,\n                coverage_amount,\n            );\n        }\n    }\n    emit_invoice_defaulted(env, \u0026invoice);\n    let _ = NotificationSystem::notify_invoice_defaulted(env, \u0026invoice);\n    Ok(())\n}\n\n/// Create a dispute for an invoice\npub fn create_dispute(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    creator: \u0026Address,\n    reason: String,\n    evidence: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    creator.require_auth();\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    // Check if dispute already exists\n    if invoice.dispute_status != DisputeStatus::None {\n        return Err(QuickLendXError::DisputeAlreadyExists);\n    }\n\n    // Validate creator has stake in invoice (business or investor)\n    if creator != \u0026invoice.business {\n        if let Some(investor) = \u0026invoice.investor {\n            if creator != investor {\n                return Err(QuickLendXError::DisputeNotAuthorized);\n            }\n        } else {\n            return Err(QuickLendXError::DisputeNotAuthorized);\n        }\n    }\n\n    // Validate reason and evidence\n    if reason.len() == 0 || reason.len() \u003e 500 {\n        return Err(QuickLendXError::InvalidDisputeReason);\n    }\n\n    if evidence.len() == 0 || evidence.len() \u003e 1000 {\n        return Err(QuickLendXError::InvalidDisputeEvidence);\n    }\n\n    // Create dispute\n    let dispute = Dispute {\n        created_by: creator.clone(),\n        created_at: env.ledger().timestamp(),\n        reason: reason.clone(),\n        evidence,\n        resolution: String::from_str(env, \"\"),\n        resolved_by: Address::from_str(\n            env,\n            \"GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF\",\n        ),\n        resolved_at: 0,\n    };\n\n    // Update invoice with dispute\n    invoice.dispute_status = DisputeStatus::Disputed;\n    invoice.dispute = dispute;\n\n    // Update invoice in storage\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    // Emit dispute created event\n    emit_dispute_created(env, invoice_id, creator, \u0026reason);\n\n    Ok(())\n}\n\n/// Put a dispute under review (admin function)\npub fn put_dispute_under_review(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    reviewer: \u0026Address,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    reviewer.require_auth();\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    // Check if dispute exists and is in disputed status\n    if invoice.dispute_status != DisputeStatus::Disputed {\n        return Err(QuickLendXError::DisputeNotFound);\n    }\n\n    // Update dispute status\n    invoice.dispute_status = DisputeStatus::UnderReview;\n\n    // Update invoice in storage\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    // Emit dispute under review event\n    emit_dispute_under_review(env, invoice_id, reviewer);\n\n    Ok(())\n}\n\n/// Resolve a dispute (admin function)\npub fn resolve_dispute(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    resolver: \u0026Address,\n    resolution: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    resolver.require_auth();\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    // Check if dispute exists and is under review\n    if invoice.dispute_status != DisputeStatus::UnderReview {\n        return Err(QuickLendXError::DisputeNotUnderReview);\n    }\n\n    // Validate resolution\n    if resolution.len() == 0 || resolution.len() \u003e 500 {\n        return Err(QuickLendXError::InvalidDisputeReason);\n    }\n\n    // Update dispute with resolution\n    if invoice.dispute_status != DisputeStatus::None {\n        invoice.dispute.resolution = resolution.clone();\n        invoice.dispute.resolved_by = resolver.clone();\n        invoice.dispute.resolved_at = env.ledger().timestamp();\n    }\n\n    // Update dispute status\n    invoice.dispute_status = DisputeStatus::Resolved;\n\n    // Update invoice in storage\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    // Emit dispute resolved event\n    emit_dispute_resolved(env, invoice_id, resolver, \u0026resolution);\n\n    Ok(())\n}\n\n/// Get dispute details for an invoice\npub fn get_dispute_details(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n) -\u003e Result\u003cOption\u003cDispute\u003e, QuickLendXError\u003e {\n    let invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.dispute_status != DisputeStatus::None {\n        Ok(Some(invoice.dispute))\n    } else {\n        Ok(None)\n    }\n}\n\n/// Get all invoices with disputes\npub fn get_invoices_with_disputes(env: \u0026Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n    let mut disputed_invoices = Vec::new(env);\n\n    // Check all invoice statuses for disputes\n    let all_statuses = [\n        InvoiceStatus::Pending,\n        InvoiceStatus::Verified,\n        InvoiceStatus::Funded,\n        InvoiceStatus::Paid,\n        InvoiceStatus::Defaulted,\n    ];\n\n    for status in all_statuses.iter() {\n        let invoices = InvoiceStorage::get_invoices_by_status(env, status);\n        for invoice_id in invoices.iter() {\n            if let Some(invoice) = InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.dispute_status != DisputeStatus::None {\n                    disputed_invoices.push_back(invoice_id);\n                }\n            }\n        }\n    }\n\n    disputed_invoices\n}\n\n/// Get invoices by dispute status\npub fn get_invoices_by_dispute_status(env: \u0026Env, dispute_status: DisputeStatus) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n    let mut filtered_invoices = Vec::new(env);\n\n    // Check all invoice statuses for specific dispute status\n    let all_statuses = [\n        InvoiceStatus::Pending,\n        InvoiceStatus::Verified,\n        InvoiceStatus::Funded,\n        InvoiceStatus::Paid,\n        InvoiceStatus::Defaulted,\n    ];\n\n    for status in all_statuses.iter() {\n        let invoices = InvoiceStorage::get_invoices_by_status(env, status);\n        for invoice_id in invoices.iter() {\n            if let Some(invoice) = InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.dispute_status == dispute_status {\n                    filtered_invoices.push_back(invoice_id);\n                }\n            }\n        }\n    }\n\n    filtered_invoices\n}\n","traces":[{"line":11,"address":[12201532,12201417,12200288],"length":1,"stats":{"Line":0}},{"line":12,"address":[12200342],"length":1,"stats":{"Line":0}},{"line":14,"address":[12200540,12200607],"length":1,"stats":{"Line":0}},{"line":15,"address":[12200633],"length":1,"stats":{"Line":0}},{"line":17,"address":[12200646,12200626],"length":1,"stats":{"Line":0}},{"line":18,"address":[12200780],"length":1,"stats":{"Line":0}},{"line":20,"address":[12200813],"length":1,"stats":{"Line":0}},{"line":21,"address":[12200832],"length":1,"stats":{"Line":0}},{"line":22,"address":[12200849],"length":1,"stats":{"Line":0}},{"line":23,"address":[12200866],"length":1,"stats":{"Line":0}},{"line":24,"address":[12200890],"length":1,"stats":{"Line":0}},{"line":25,"address":[12200915],"length":1,"stats":{"Line":0}},{"line":26,"address":[12200987],"length":1,"stats":{"Line":0}},{"line":30,"address":[13887312,13887296],"length":1,"stats":{"Line":0}},{"line":31,"address":[13887390,13887408],"length":1,"stats":{"Line":0}},{"line":32,"address":[13887427],"length":1,"stats":{"Line":0}},{"line":34,"address":[13887404],"length":1,"stats":{"Line":0}},{"line":38,"address":[12201114],"length":1,"stats":{"Line":0}},{"line":40,"address":[12201174],"length":1,"stats":{"Line":0}},{"line":43,"address":[12201294],"length":1,"stats":{"Line":0}},{"line":44,"address":[12201302],"length":1,"stats":{"Line":0}},{"line":50,"address":[12201020],"length":1,"stats":{"Line":0}},{"line":51,"address":[12201495],"length":1,"stats":{"Line":0}},{"line":52,"address":[12201502],"length":1,"stats":{"Line":0}},{"line":56,"address":[12200114,12198400,12200275],"length":1,"stats":{"Line":0}},{"line":63,"address":[12198463],"length":1,"stats":{"Line":0}},{"line":65,"address":[12200199,12198562],"length":1,"stats":{"Line":0}},{"line":69,"address":[12198753,12198823],"length":1,"stats":{"Line":0}},{"line":70,"address":[12198869],"length":1,"stats":{"Line":0}},{"line":74,"address":[12198829,12198886],"length":1,"stats":{"Line":0}},{"line":75,"address":[12198908],"length":1,"stats":{"Line":0}},{"line":76,"address":[12199008,12198980],"length":1,"stats":{"Line":0}},{"line":77,"address":[12199014],"length":1,"stats":{"Line":0}},{"line":80,"address":[12198991],"length":1,"stats":{"Line":0}},{"line":85,"address":[12199069,12199031,12198897],"length":1,"stats":{"Line":0}},{"line":86,"address":[12199052],"length":1,"stats":{"Line":0}},{"line":89,"address":[12199134,12199081],"length":1,"stats":{"Line":0}},{"line":90,"address":[12199117],"length":1,"stats":{"Line":0}},{"line":95,"address":[12199141],"length":1,"stats":{"Line":0}},{"line":96,"address":[12199174,12199225],"length":1,"stats":{"Line":0}},{"line":97,"address":[12199306],"length":1,"stats":{"Line":0}},{"line":99,"address":[12199383],"length":1,"stats":{"Line":0}},{"line":100,"address":[12199439],"length":1,"stats":{"Line":0}},{"line":108,"address":[12199844],"length":1,"stats":{"Line":0}},{"line":109,"address":[12199852],"length":1,"stats":{"Line":0}},{"line":112,"address":[12200008],"length":1,"stats":{"Line":0}},{"line":115,"address":[12200030],"length":1,"stats":{"Line":0}},{"line":117,"address":[12200042],"length":1,"stats":{"Line":0}},{"line":121,"address":[12203952,12204402,12204408],"length":1,"stats":{"Line":0}},{"line":126,"address":[12204026],"length":1,"stats":{"Line":0}},{"line":128,"address":[12204042],"length":1,"stats":{"Line":0}},{"line":132,"address":[12204299,12204232],"length":1,"stats":{"Line":0}},{"line":133,"address":[12204330],"length":1,"stats":{"Line":0}},{"line":137,"address":[12204310],"length":1,"stats":{"Line":0}},{"line":140,"address":[12204323],"length":1,"stats":{"Line":0}},{"line":143,"address":[12204365],"length":1,"stats":{"Line":0}},{"line":145,"address":[12204372],"length":1,"stats":{"Line":0}},{"line":149,"address":[12202599,12201552,12202640],"length":1,"stats":{"Line":0}},{"line":155,"address":[12201631],"length":1,"stats":{"Line":0}},{"line":157,"address":[12202634,12201701],"length":1,"stats":{"Line":0}},{"line":161,"address":[12201956,12201889],"length":1,"stats":{"Line":0}},{"line":162,"address":[12201978],"length":1,"stats":{"Line":0}},{"line":166,"address":[12201967,12201995,12202033],"length":1,"stats":{"Line":0}},{"line":167,"address":[12202016],"length":1,"stats":{"Line":0}},{"line":171,"address":[12202040],"length":1,"stats":{"Line":0}},{"line":172,"address":[12202117],"length":1,"stats":{"Line":0}},{"line":173,"address":[12202268],"length":1,"stats":{"Line":0}},{"line":174,"address":[12202419],"length":1,"stats":{"Line":0}},{"line":178,"address":[12202081],"length":1,"stats":{"Line":0}},{"line":181,"address":[12202094],"length":1,"stats":{"Line":0}},{"line":184,"address":[12202549],"length":1,"stats":{"Line":0}},{"line":186,"address":[12202556],"length":1,"stats":{"Line":0}},{"line":190,"address":[12203931,12202656,12203910],"length":1,"stats":{"Line":0}},{"line":194,"address":[12202704],"length":1,"stats":{"Line":0}},{"line":197,"address":[12202917,12203021,12202984],"length":1,"stats":{"Line":0}},{"line":198,"address":[12203023],"length":1,"stats":{"Line":0}},{"line":200,"address":[12202995],"length":1,"stats":{"Line":0}},{"line":205,"address":[12204432,12205381,12205441],"length":1,"stats":{"Line":0}},{"line":206,"address":[12204462],"length":1,"stats":{"Line":0}},{"line":209,"address":[12204484],"length":1,"stats":{"Line":0}},{"line":217,"address":[12204587,12204519],"length":1,"stats":{"Line":0}},{"line":218,"address":[12204723],"length":1,"stats":{"Line":0}},{"line":219,"address":[12204846,12204942,12204779,12205395],"length":1,"stats":{"Line":0}},{"line":220,"address":[12205131,12205046],"length":1,"stats":{"Line":0}},{"line":221,"address":[12205278,12205189],"length":1,"stats":{"Line":0}},{"line":222,"address":[12205299],"length":1,"stats":{"Line":0}},{"line":228,"address":[12204735],"length":1,"stats":{"Line":0}},{"line":232,"address":[12205456,12206427,12206487],"length":1,"stats":{"Line":0}},{"line":233,"address":[12205492],"length":1,"stats":{"Line":0}},{"line":236,"address":[12205514],"length":1,"stats":{"Line":0}},{"line":244,"address":[12205635,12205567],"length":1,"stats":{"Line":0}},{"line":245,"address":[12205771],"length":1,"stats":{"Line":0}},{"line":246,"address":[12205894,12205827,12206441,12205990],"length":1,"stats":{"Line":0}},{"line":247,"address":[12206094,12206179],"length":1,"stats":{"Line":0}},{"line":248,"address":[12206237,12206324],"length":1,"stats":{"Line":0}},{"line":249,"address":[12206345],"length":1,"stats":{"Line":0}},{"line":255,"address":[12205783],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":97},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","errors.rs"],"content":"use soroban_sdk::{contracterror, symbol_short, Symbol};\n\n/// Custom error types for the QuickLendX contract\n#[contracterror]\n#[derive(Copy, Clone, Debug, Eq, PartialEq, PartialOrd, Ord)]\n#[repr(u32)]\npub enum QuickLendXError {\n    // Invoice errors (1000-1099)\n    InvoiceNotFound = 1000,\n    InvoiceAlreadyExists = 1001,\n    InvoiceNotAvailableForFunding = 1002,\n    InvoiceAlreadyFunded = 1003,\n    InvoiceAmountInvalid = 1004,\n    InvoiceDueDateInvalid = 1005,\n    InvoiceNotVerified = 1006,\n    InvoiceNotFunded = 1007,\n    InvoiceAlreadyPaid = 1008,\n    InvoiceAlreadyDefaulted = 1009,\n\n    // Authorization errors (1100-1199)\n    Unauthorized = 1100,\n    NotBusinessOwner = 1101,\n    NotInvestor = 1102,\n    NotAdmin = 1103,\n\n    // Validation errors (1200-1299)\n    InvalidAmount = 1200,\n    InvalidAddress = 1201,\n    InvalidCurrency = 1202,\n    InvalidTimestamp = 1203,\n    InvalidDescription = 1204,\n\n    // Storage errors (1300-1399)\n    StorageError = 1300,\n    StorageKeyNotFound = 1301,\n\n    // Business logic errors (1400-1499)\n    InsufficientFunds = 1400,\n    InvalidStatus = 1401,\n    OperationNotAllowed = 1402,\n    PaymentTooLow = 1403,\n    PlatformAccountNotConfigured = 1404,\n    InvalidCoveragePercentage = 1405,\n\n    // Rating errors (1500-1599)\n    InvalidRating = 1500,\n    NotFunded = 1501,\n    AlreadyRated = 1502,\n    NotRater = 1503,\n\n    // KYC/Verification errors (1600-1699)\n    BusinessNotVerified = 1600,\n    KYCAlreadyPending = 1601,\n    KYCAlreadyVerified = 1602,\n    KYCNotFound = 1603,\n    InvalidKYCStatus = 1604,\n\n    // Audit errors (1700-1799)\n    AuditLogNotFound = 1700,\n    AuditIntegrityError = 1701,\n    AuditQueryError = 1702,\n\n    // Category and Tag errors (1800-1899)\n    InvalidTag = 1802,\n    TagLimitExceeded = 1803,\n\n    // Dispute errors (1900-1999)\n    DisputeNotFound = 1900,\n    DisputeAlreadyExists = 1901,\n    DisputeNotAuthorized = 1902,\n    DisputeAlreadyResolved = 1903,\n    DisputeNotUnderReview = 1904,\n    InvalidDisputeReason = 1905,\n    InvalidDisputeEvidence = 1906,\n\n    // Notification errors\n    NotificationNotFound = 2000,\n    NotificationBlocked = 2001,\n}\n\nimpl From\u003cQuickLendXError\u003e for Symbol {\n    fn from(error: QuickLendXError) -\u003e Self {\n        match error {\n            QuickLendXError::InvoiceNotFound =\u003e symbol_short!(\"INV_NF\"),\n            QuickLendXError::InvoiceAlreadyExists =\u003e symbol_short!(\"INV_EX\"),\n            QuickLendXError::InvoiceNotAvailableForFunding =\u003e symbol_short!(\"INV_NA\"),\n            QuickLendXError::InvoiceAlreadyFunded =\u003e symbol_short!(\"INV_FD\"),\n            QuickLendXError::InvoiceAmountInvalid =\u003e symbol_short!(\"INV_AI\"),\n            QuickLendXError::InvoiceDueDateInvalid =\u003e symbol_short!(\"INV_DI\"),\n            QuickLendXError::InvoiceNotVerified =\u003e symbol_short!(\"INV_NV\"),\n            QuickLendXError::InvoiceNotFunded =\u003e symbol_short!(\"INV_NF\"),\n            QuickLendXError::InvoiceAlreadyPaid =\u003e symbol_short!(\"INV_PD\"),\n            QuickLendXError::InvoiceAlreadyDefaulted =\u003e symbol_short!(\"INV_DF\"),\n            QuickLendXError::Unauthorized =\u003e symbol_short!(\"UNAUTH\"),\n            QuickLendXError::NotBusinessOwner =\u003e symbol_short!(\"NOT_OWN\"),\n            QuickLendXError::NotInvestor =\u003e symbol_short!(\"NOT_INV\"),\n            QuickLendXError::NotAdmin =\u003e symbol_short!(\"NOT_ADM\"),\n            QuickLendXError::InvalidAmount =\u003e symbol_short!(\"INV_AMT\"),\n            QuickLendXError::InvalidAddress =\u003e symbol_short!(\"INV_ADR\"),\n            QuickLendXError::InvalidCurrency =\u003e symbol_short!(\"INV_CR\"),\n            QuickLendXError::InvalidTimestamp =\u003e symbol_short!(\"INV_TM\"),\n            QuickLendXError::InvalidDescription =\u003e symbol_short!(\"INV_DS\"),\n            QuickLendXError::StorageError =\u003e symbol_short!(\"STORE\"),\n            QuickLendXError::StorageKeyNotFound =\u003e symbol_short!(\"KEY_NF\"),\n            QuickLendXError::InsufficientFunds =\u003e symbol_short!(\"INSUF\"),\n            QuickLendXError::InvalidStatus =\u003e symbol_short!(\"INV_ST\"),\n            QuickLendXError::OperationNotAllowed =\u003e symbol_short!(\"OP_NA\"),\n            QuickLendXError::PaymentTooLow =\u003e symbol_short!(\"PAY_LOW\"),\n            QuickLendXError::PlatformAccountNotConfigured =\u003e symbol_short!(\"PLT_NC\"),\n            QuickLendXError::InvalidCoveragePercentage =\u003e symbol_short!(\"INS_CV\"),\n            QuickLendXError::InvalidRating =\u003e symbol_short!(\"INV_RT\"),\n            QuickLendXError::NotFunded =\u003e symbol_short!(\"NOT_FD\"),\n            QuickLendXError::AlreadyRated =\u003e symbol_short!(\"ALR_RT\"),\n            QuickLendXError::NotRater =\u003e symbol_short!(\"NOT_RT\"),\n            QuickLendXError::BusinessNotVerified =\u003e symbol_short!(\"BUS_NV\"),\n            QuickLendXError::KYCAlreadyPending =\u003e symbol_short!(\"KYC_PD\"),\n            QuickLendXError::KYCAlreadyVerified =\u003e symbol_short!(\"KYC_VF\"),\n            QuickLendXError::KYCNotFound =\u003e symbol_short!(\"KYC_NF\"),\n            QuickLendXError::InvalidKYCStatus =\u003e symbol_short!(\"KYC_IS\"),\n            QuickLendXError::AuditLogNotFound =\u003e symbol_short!(\"AUD_NF\"),\n            QuickLendXError::AuditIntegrityError =\u003e symbol_short!(\"AUD_IE\"),\n            QuickLendXError::AuditQueryError =\u003e symbol_short!(\"AUD_QE\"),\n            QuickLendXError::InvalidTag =\u003e symbol_short!(\"INV_TAG\"),\n            QuickLendXError::TagLimitExceeded =\u003e symbol_short!(\"TAG_LIM\"),\n            // Dispute errors\n            QuickLendXError::DisputeNotFound =\u003e symbol_short!(\"DSP_NF\"),\n            QuickLendXError::DisputeAlreadyExists =\u003e symbol_short!(\"DSP_EX\"),\n            QuickLendXError::DisputeNotAuthorized =\u003e symbol_short!(\"DSP_NA\"),\n            QuickLendXError::DisputeAlreadyResolved =\u003e symbol_short!(\"DSP_RS\"),\n            QuickLendXError::DisputeNotUnderReview =\u003e symbol_short!(\"DSP_UR\"),\n            QuickLendXError::InvalidDisputeReason =\u003e symbol_short!(\"DSP_RN\"),\n            QuickLendXError::InvalidDisputeEvidence =\u003e symbol_short!(\"DSP_EV\"),\n            // Notification errors\n            QuickLendXError::NotificationNotFound =\u003e symbol_short!(\"NOT_NF\"),\n            QuickLendXError::NotificationBlocked =\u003e symbol_short!(\"NOT_BL\"),\n        }\n    }\n}\n","traces":[{"line":82,"address":[15678288],"length":1,"stats":{"Line":0}},{"line":83,"address":[15678310],"length":1,"stats":{"Line":0}},{"line":84,"address":[15679152],"length":1,"stats":{"Line":0}},{"line":85,"address":[15679179],"length":1,"stats":{"Line":0}},{"line":86,"address":[15679206],"length":1,"stats":{"Line":0}},{"line":87,"address":[15679233],"length":1,"stats":{"Line":0}},{"line":88,"address":[15679260],"length":1,"stats":{"Line":0}},{"line":89,"address":[15679287],"length":1,"stats":{"Line":0}},{"line":90,"address":[15679314],"length":1,"stats":{"Line":0}},{"line":91,"address":[15679341],"length":1,"stats":{"Line":0}},{"line":92,"address":[15679368],"length":1,"stats":{"Line":0}},{"line":93,"address":[15679395],"length":1,"stats":{"Line":0}},{"line":94,"address":[15679422],"length":1,"stats":{"Line":0}},{"line":95,"address":[15679449],"length":1,"stats":{"Line":0}},{"line":96,"address":[15679476],"length":1,"stats":{"Line":0}},{"line":97,"address":[15679503],"length":1,"stats":{"Line":0}},{"line":98,"address":[15679530],"length":1,"stats":{"Line":0}},{"line":99,"address":[15679557],"length":1,"stats":{"Line":0}},{"line":100,"address":[15679584],"length":1,"stats":{"Line":0}},{"line":101,"address":[15679611],"length":1,"stats":{"Line":0}},{"line":102,"address":[15679638],"length":1,"stats":{"Line":0}},{"line":103,"address":[15679665],"length":1,"stats":{"Line":0}},{"line":104,"address":[15679692],"length":1,"stats":{"Line":0}},{"line":105,"address":[15679719],"length":1,"stats":{"Line":0}},{"line":106,"address":[15679746],"length":1,"stats":{"Line":0}},{"line":107,"address":[15679773],"length":1,"stats":{"Line":0}},{"line":108,"address":[15679800],"length":1,"stats":{"Line":0}},{"line":109,"address":[15679827],"length":1,"stats":{"Line":0}},{"line":110,"address":[15679854],"length":1,"stats":{"Line":0}},{"line":111,"address":[15679881],"length":1,"stats":{"Line":0}},{"line":112,"address":[15679908],"length":1,"stats":{"Line":0}},{"line":113,"address":[15679935],"length":1,"stats":{"Line":0}},{"line":114,"address":[15679962],"length":1,"stats":{"Line":0}},{"line":115,"address":[15679989],"length":1,"stats":{"Line":0}},{"line":116,"address":[15680016],"length":1,"stats":{"Line":2}},{"line":117,"address":[15680043],"length":1,"stats":{"Line":1}},{"line":118,"address":[15680070],"length":1,"stats":{"Line":2}},{"line":119,"address":[15680097],"length":1,"stats":{"Line":0}},{"line":120,"address":[15680124],"length":1,"stats":{"Line":0}},{"line":121,"address":[15680151],"length":1,"stats":{"Line":0}},{"line":122,"address":[15680178],"length":1,"stats":{"Line":0}},{"line":123,"address":[15680205],"length":1,"stats":{"Line":0}},{"line":124,"address":[15680232],"length":1,"stats":{"Line":0}},{"line":126,"address":[15680259],"length":1,"stats":{"Line":0}},{"line":127,"address":[15680286],"length":1,"stats":{"Line":0}},{"line":128,"address":[15680313],"length":1,"stats":{"Line":0}},{"line":129,"address":[15680340],"length":1,"stats":{"Line":0}},{"line":130,"address":[15680364],"length":1,"stats":{"Line":0}},{"line":131,"address":[15680388],"length":1,"stats":{"Line":0}},{"line":132,"address":[15680412],"length":1,"stats":{"Line":0}},{"line":134,"address":[15680436],"length":1,"stats":{"Line":0}},{"line":135,"address":[15680460],"length":1,"stats":{"Line":0}}],"covered":3,"coverable":52},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","events.rs"],"content":"use crate::bid::Bid;\nuse crate::invoice::{Invoice, InvoiceMetadata};\nuse crate::payments::Escrow;\nuse crate::profits::PlatformFeeConfig;\nuse crate::verification::InvestorVerification;\nuse soroban_sdk::{symbol_short, Address, BytesN, Env, String};\n\npub fn emit_invoice_uploaded(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_up\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            invoice.amount,\n            invoice.currency.clone(),\n            invoice.due_date,\n        ),\n    );\n}\n\npub fn emit_invoice_verified(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_ver\"),),\n        (invoice.id.clone(), invoice.business.clone()),\n    );\n}\n\npub fn emit_invoice_cancelled(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_canc\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\npub fn emit_invoice_metadata_updated(env: \u0026Env, invoice: \u0026Invoice, metadata: \u0026InvoiceMetadata) {\n    let mut total = 0i128;\n    for record in metadata.line_items.iter() {\n        total = total.saturating_add(record.3);\n    }\n\n    env.events().publish(\n        (symbol_short!(\"inv_meta\"),),\n        (\n            invoice.id.clone(),\n            metadata.customer_name.clone(),\n            metadata.tax_id.clone(),\n            metadata.line_items.len() as u32,\n            total,\n        ),\n    );\n}\n\npub fn emit_invoice_metadata_cleared(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_mclr\"),),\n        (invoice.id.clone(), invoice.business.clone()),\n    );\n}\n\npub fn emit_investor_verified(env: \u0026Env, verification: \u0026InvestorVerification) {\n    env.events().publish(\n        (symbol_short!(\"inv_veri\"),),\n        (\n            verification.investor.clone(),\n            verification.investment_limit,\n            verification.verified_at,\n        ),\n    );\n}\n\npub fn emit_invoice_settled(\n    env: \u0026Env,\n    invoice: \u0026crate::invoice::Invoice,\n    investor_return: i128,\n    platform_fee: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_set\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            investor_return,\n            platform_fee,\n        ),\n    );\n}\n\npub fn emit_partial_payment(\n    env: \u0026Env,\n    invoice: \u0026Invoice,\n    payment_amount: i128,\n    total_paid: i128,\n    progress: u32,\n    transaction_id: String,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_pp\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            payment_amount,\n            total_paid,\n            progress,\n            transaction_id,\n        ),\n    );\n}\n\npub fn emit_invoice_expired(env: \u0026Env, invoice: \u0026crate::invoice::Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_exp\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            invoice.due_date,\n        ),\n    );\n}\n\npub fn emit_invoice_defaulted(env: \u0026Env, invoice: \u0026crate::invoice::Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_def\"),),\n        (invoice.id.clone(), invoice.business.clone()),\n    );\n}\n\npub fn emit_insurance_added(\n    env: \u0026Env,\n    investment_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    provider: \u0026Address,\n    coverage_percentage: u32,\n    coverage_amount: i128,\n    premium_amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"ins_add\"),),\n        (\n            investment_id.clone(),\n            invoice_id.clone(),\n            investor.clone(),\n            provider.clone(),\n            coverage_percentage,\n            coverage_amount,\n            premium_amount,\n        ),\n    );\n}\n\npub fn emit_insurance_premium_collected(\n    env: \u0026Env,\n    investment_id: \u0026BytesN\u003c32\u003e,\n    provider: \u0026Address,\n    premium_amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"ins_prm\"),),\n        (investment_id.clone(), provider.clone(), premium_amount),\n    );\n}\n\npub fn emit_insurance_claimed(\n    env: \u0026Env,\n    investment_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    provider: \u0026Address,\n    coverage_amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"ins_clm\"),),\n        (\n            investment_id.clone(),\n            invoice_id.clone(),\n            provider.clone(),\n            coverage_amount,\n        ),\n    );\n}\n\npub fn emit_platform_fee_updated(env: \u0026Env, config: \u0026PlatformFeeConfig) {\n    env.events().publish(\n        (symbol_short!(\"fee_upd\"),),\n        (config.fee_bps, config.updated_at, config.updated_by.clone()),\n    );\n}\n\n/// Emit event when escrow is created\npub fn emit_escrow_created(env: \u0026Env, escrow: \u0026Escrow) {\n    env.events().publish(\n        (symbol_short!(\"esc_cr\"),),\n        (\n            escrow.escrow_id.clone(),\n            escrow.invoice_id.clone(),\n            escrow.investor.clone(),\n            escrow.business.clone(),\n            escrow.amount,\n        ),\n    );\n}\n\n/// Emit event when escrow funds are released to business\npub fn emit_escrow_released(\n    env: \u0026Env,\n    escrow_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"esc_rel\"),),\n        (\n            escrow_id.clone(),\n            invoice_id.clone(),\n            business.clone(),\n            amount,\n        ),\n    );\n}\n\n/// Emit event when escrow funds are refunded to investor\npub fn emit_escrow_refunded(\n    env: \u0026Env,\n    escrow_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"esc_ref\"),),\n        (\n            escrow_id.clone(),\n            invoice_id.clone(),\n            investor.clone(),\n            amount,\n        ),\n    );\n}\n\npub fn emit_bid_expired(env: \u0026Env, bid: \u0026Bid) {\n    env.events().publish(\n        (symbol_short!(\"bid_exp\"),),\n        (\n            bid.bid_id.clone(),\n            bid.invoice_id.clone(),\n            bid.investor.clone(),\n            bid.bid_amount,\n            bid.expiration_timestamp,\n        ),\n    );\n}\n\n/// Emit event when a bid is placed\npub fn emit_bid_placed(env: \u0026Env, bid: \u0026Bid) {\n    env.events().publish(\n        (symbol_short!(\"bid_plc\"),),\n        (\n            bid.bid_id.clone(),\n            bid.invoice_id.clone(),\n            bid.investor.clone(),\n            bid.bid_amount,\n            bid.expected_return,\n            bid.timestamp,\n            bid.expiration_timestamp,\n        ),\n    );\n}\n\n/// Emit event when a bid is withdrawn\npub fn emit_bid_withdrawn(env: \u0026Env, bid: \u0026Bid) {\n    env.events().publish(\n        (symbol_short!(\"bid_wdr\"),),\n        (\n            bid.bid_id.clone(),\n            bid.invoice_id.clone(),\n            bid.investor.clone(),\n            bid.bid_amount,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when backup is created\npub fn emit_backup_created(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, invoice_count: u32) {\n    env.events().publish(\n        (symbol_short!(\"bkup_crt\"),),\n        (backup_id.clone(), invoice_count, env.ledger().timestamp()),\n    );\n}\n\n/// Emit event when backup is restored\npub fn emit_backup_restored(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, invoice_count: u32) {\n    env.events().publish(\n        (symbol_short!(\"bkup_rstr\"),),\n        (backup_id.clone(), invoice_count, env.ledger().timestamp()),\n    );\n}\n\n/// Emit event when backup is validated\npub fn emit_backup_validated(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, success: bool) {\n    env.events().publish(\n        (symbol_short!(\"bkup_vd\"),),\n        (backup_id.clone(), success, env.ledger().timestamp()),\n    );\n}\n\n/// Emit event when backup is archived\npub fn emit_backup_archived(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) {\n    env.events().publish(\n        (symbol_short!(\"bkup_ar\"),),\n        (backup_id.clone(), env.ledger().timestamp()),\n    );\n}\n\n/// Emit audit validation event\npub fn emit_audit_validation(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, is_valid: bool) {\n    env.events().publish(\n        (symbol_short!(\"aud_val\"),),\n        (invoice_id.clone(), is_valid, env.ledger().timestamp()),\n    );\n}\n\n/// Emit audit query event\npub fn emit_audit_query(env: \u0026Env, query_type: String, result_count: u32) {\n    env.events()\n        .publish((symbol_short!(\"aud_qry\"),), (query_type, result_count));\n}\n\n/// Emit event when invoice category is updated\npub fn emit_invoice_category_updated(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    old_category: \u0026crate::invoice::InvoiceCategory,\n    new_category: \u0026crate::invoice::InvoiceCategory,\n) {\n    env.events().publish(\n        (symbol_short!(\"cat_upd\"),),\n        (\n            invoice_id.clone(),\n            business.clone(),\n            old_category.clone(),\n            new_category.clone(),\n        ),\n    );\n}\n\n/// Emit event when a tag is added to an invoice\npub fn emit_invoice_tag_added(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    tag: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"tag_add\"),),\n        (invoice_id.clone(), business.clone(), tag.clone()),\n    );\n}\n\n/// Emit event when a tag is removed from an invoice\npub fn emit_invoice_tag_removed(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    tag: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"tag_rm\"),),\n        (invoice_id.clone(), business.clone(), tag.clone()),\n    );\n}\n\n/// Emit event when a dispute is created\npub fn emit_dispute_created(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    created_by: \u0026Address,\n    reason: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"dsp_cr\"),),\n        (\n            invoice_id.clone(),\n            created_by.clone(),\n            reason.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when a dispute is put under review\npub fn emit_dispute_under_review(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, reviewed_by: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"dsp_ur\"),),\n        (\n            invoice_id.clone(),\n            reviewed_by.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when a dispute is resolved\npub fn emit_dispute_resolved(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    resolved_by: \u0026Address,\n    resolution: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"dsp_rs\"),),\n        (\n            invoice_id.clone(),\n            resolved_by.clone(),\n            resolution.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n// Analytics Events\n\n/// Emit event when platform metrics are updated\npub fn emit_platform_metrics_updated(\n    env: \u0026Env,\n    total_invoices: u32,\n    total_volume: i128,\n    total_fees: i128,\n    success_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"plt_met\"),),\n        (\n            total_invoices,\n            total_volume,\n            total_fees,\n            success_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when performance metrics are updated\npub fn emit_performance_metrics_updated(\n    env: \u0026Env,\n    average_settlement_time: u64,\n    transaction_success_rate: i128,\n    user_satisfaction_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"perf_met\"),),\n        (\n            average_settlement_time,\n            transaction_success_rate,\n            user_satisfaction_score,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when user behavior metrics are calculated\npub fn emit_user_behavior_analyzed(\n    env: \u0026Env,\n    user: \u0026Address,\n    total_investments: u32,\n    success_rate: i128,\n    risk_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"usr_beh\"),),\n        (\n            user.clone(),\n            total_investments,\n            success_rate,\n            risk_score,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when financial metrics are calculated\npub fn emit_financial_metrics_calculated(\n    env: \u0026Env,\n    period: \u0026crate::analytics::TimePeriod,\n    total_volume: i128,\n    total_fees: i128,\n    average_return_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"fin_met\"),),\n        (\n            period.clone(),\n            total_volume,\n            total_fees,\n            average_return_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when business report is generated\npub fn emit_business_report_generated(\n    env: \u0026Env,\n    report_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    period: \u0026crate::analytics::TimePeriod,\n    invoices_uploaded: u32,\n    success_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"biz_rpt\"),),\n        (\n            report_id.clone(),\n            business.clone(),\n            period.clone(),\n            invoices_uploaded,\n            success_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when investor report is generated\npub fn emit_investor_report_generated(\n    env: \u0026Env,\n    report_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    period: \u0026crate::analytics::TimePeriod,\n    investments_made: u32,\n    average_return_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_rpt\"),),\n        (\n            report_id.clone(),\n            investor.clone(),\n            period.clone(),\n            investments_made,\n            average_return_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when analytics query is performed\npub fn emit_analytics_query(\n    env: \u0026Env,\n    query_type: \u0026String,\n    filters_applied: u32,\n    result_count: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"anal_qry\"),),\n        (\n            query_type.clone(),\n            filters_applied,\n            result_count,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when analytics export is requested\npub fn emit_analytics_export(\n    env: \u0026Env,\n    export_type: \u0026String,\n    requested_by: \u0026Address,\n    record_count: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"anal_exp\"),),\n        (\n            export_type.clone(),\n            requested_by.clone(),\n            record_count,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\npub fn emit_investor_analytics_updated(\n    env: \u0026Env,\n    investor: \u0026Address,\n    success_rate: i128,\n    risk_score: u32,\n    compliance_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_anal\"),),\n        (investor.clone(), success_rate, risk_score, compliance_score),\n    );\n}\n\npub fn emit_investor_performance_updated(\n    env: \u0026Env,\n    total_investors: u32,\n    verified_investors: u32,\n    platform_success_rate: i128,\n    average_risk_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_perf\"),),\n        (\n            total_investors,\n            verified_investors,\n            platform_success_rate,\n            average_risk_score,\n        ),\n    );\n}\n","traces":[{"line":8,"address":[12400769,12400803,12400208],"length":1,"stats":{"Line":0}},{"line":9,"address":[12400712,12400242],"length":1,"stats":{"Line":0}},{"line":10,"address":[12400265],"length":1,"stats":{"Line":0}},{"line":12,"address":[12400309],"length":1,"stats":{"Line":0}},{"line":13,"address":[12400378],"length":1,"stats":{"Line":0}},{"line":14,"address":[12400443],"length":1,"stats":{"Line":0}},{"line":15,"address":[12400466],"length":1,"stats":{"Line":0}},{"line":16,"address":[12400540],"length":1,"stats":{"Line":0}},{"line":21,"address":[12401190,12401224,12400816],"length":1,"stats":{"Line":1}},{"line":22,"address":[12400849,12401133],"length":1,"stats":{"Line":4}},{"line":23,"address":[12400871],"length":1,"stats":{"Line":1}},{"line":24,"address":[12400983,12400915],"length":1,"stats":{"Line":3}},{"line":28,"address":[12402240,12402918,12402859],"length":1,"stats":{"Line":0}},{"line":29,"address":[12402279,12402704],"length":1,"stats":{"Line":0}},{"line":30,"address":[12402302],"length":1,"stats":{"Line":0}},{"line":32,"address":[12402346],"length":1,"stats":{"Line":0}},{"line":33,"address":[12402411],"length":1,"stats":{"Line":0}},{"line":34,"address":[12402532,12402484],"length":1,"stats":{"Line":0}},{"line":39,"address":[12407232,12408207,12408247],"length":1,"stats":{"Line":0}},{"line":40,"address":[12407291],"length":1,"stats":{"Line":0}},{"line":41,"address":[12407317,12407441],"length":1,"stats":{"Line":0}},{"line":42,"address":[12407568,12408310],"length":1,"stats":{"Line":0}},{"line":45,"address":[12407640,12408138],"length":1,"stats":{"Line":0}},{"line":46,"address":[12407650],"length":1,"stats":{"Line":0}},{"line":48,"address":[12407703],"length":1,"stats":{"Line":0}},{"line":49,"address":[12407780],"length":1,"stats":{"Line":0}},{"line":50,"address":[12407833],"length":1,"stats":{"Line":0}},{"line":51,"address":[12407898],"length":1,"stats":{"Line":0}},{"line":52,"address":[12407961],"length":1,"stats":{"Line":0}},{"line":57,"address":[12406800,12407174,12407208],"length":1,"stats":{"Line":0}},{"line":58,"address":[12406833,12407117],"length":1,"stats":{"Line":0}},{"line":59,"address":[12406855],"length":1,"stats":{"Line":0}},{"line":60,"address":[12406899,12406967],"length":1,"stats":{"Line":0}},{"line":64,"address":[12402215,12402221,12401872],"length":1,"stats":{"Line":2}},{"line":65,"address":[12402130,12401905],"length":1,"stats":{"Line":4}},{"line":66,"address":[12401927],"length":1,"stats":{"Line":2}},{"line":68,"address":[12401971],"length":1,"stats":{"Line":2}},{"line":69,"address":[12402035],"length":1,"stats":{"Line":2}},{"line":70,"address":[12402049],"length":1,"stats":{"Line":2}},{"line":75,"address":[12396144,12396632,12396666],"length":1,"stats":{"Line":1}},{"line":81,"address":[12396229,12396572],"length":1,"stats":{"Line":2}},{"line":82,"address":[12396252],"length":1,"stats":{"Line":1}},{"line":84,"address":[12396296],"length":1,"stats":{"Line":1}},{"line":85,"address":[12396365],"length":1,"stats":{"Line":1}},{"line":92,"address":[12397376,12397413,12396688],"length":1,"stats":{"Line":2}},{"line":100,"address":[12396797,12397311],"length":1,"stats":{"Line":4}},{"line":101,"address":[12396878],"length":1,"stats":{"Line":2}},{"line":103,"address":[12396925],"length":1,"stats":{"Line":2}},{"line":104,"address":[12396993],"length":1,"stats":{"Line":2}},{"line":105,"address":[19334948,19334954,19334432],"length":1,"stats":{"Line":0}},{"line":106,"address":[19334470],"length":1,"stats":{"Line":0}},{"line":108,"address":[12397082],"length":1,"stats":{"Line":2}},{"line":113,"address":[12396123,12395696,12396089],"length":1,"stats":{"Line":0}},{"line":114,"address":[19334894,19335997,19334992],"length":1,"stats":{"Line":0}},{"line":115,"address":[12395751],"length":1,"stats":{"Line":0}},{"line":117,"address":[12395795],"length":1,"stats":{"Line":0}},{"line":118,"address":[12395863],"length":1,"stats":{"Line":0}},{"line":119,"address":[12395927],"length":1,"stats":{"Line":0}},{"line":124,"address":[12403318,12403352,12402944],"length":1,"stats":{"Line":0}},{"line":125,"address":[12403261,12402977],"length":1,"stats":{"Line":0}},{"line":126,"address":[12402999],"length":1,"stats":{"Line":0}},{"line":127,"address":[12403111,12403043],"length":1,"stats":{"Line":0}},{"line":131,"address":[12394864,12395637,12395671],"length":1,"stats":{"Line":0}},{"line":141,"address":[12395002,12395577],"length":1,"stats":{"Line":0}},{"line":142,"address":[12395025],"length":1,"stats":{"Line":0}},{"line":144,"address":[12395075],"length":1,"stats":{"Line":0}},{"line":145,"address":[12395140],"length":1,"stats":{"Line":0}},{"line":146,"address":[12395213],"length":1,"stats":{"Line":0}},{"line":147,"address":[12395274],"length":1,"stats":{"Line":0}},{"line":155,"address":[12411451,12411008,12411485],"length":1,"stats":{"Line":0}},{"line":161,"address":[12411391,12411081],"length":1,"stats":{"Line":0}},{"line":162,"address":[12411104],"length":1,"stats":{"Line":0}},{"line":163,"address":[12411221,12411148],"length":1,"stats":{"Line":0}},{"line":167,"address":[12401248,12401815,12401849],"length":1,"stats":{"Line":0}},{"line":174,"address":[12401333,12401755],"length":1,"stats":{"Line":0}},{"line":175,"address":[12401356],"length":1,"stats":{"Line":0}},{"line":177,"address":[12401400],"length":1,"stats":{"Line":0}},{"line":178,"address":[12401465],"length":1,"stats":{"Line":0}},{"line":179,"address":[12401537],"length":1,"stats":{"Line":0}},{"line":185,"address":[12405568,12405562,12405200],"length":1,"stats":{"Line":0}},{"line":186,"address":[12405474,12405234],"length":1,"stats":{"Line":0}},{"line":187,"address":[12405257],"length":1,"stats":{"Line":0}},{"line":188,"address":[12405402,12405301],"length":1,"stats":{"Line":0}},{"line":193,"address":[12390336,12390968,12391002],"length":1,"stats":{"Line":3}},{"line":194,"address":[12390911,12390369],"length":1,"stats":{"Line":6}},{"line":195,"address":[12390391],"length":1,"stats":{"Line":3}},{"line":197,"address":[12390435],"length":1,"stats":{"Line":3}},{"line":198,"address":[12390503],"length":1,"stats":{"Line":3}},{"line":199,"address":[12390571],"length":1,"stats":{"Line":3}},{"line":200,"address":[12390635],"length":1,"stats":{"Line":3}},{"line":201,"address":[12390702],"length":1,"stats":{"Line":3}},{"line":207,"address":[12394807,12394841,12394240],"length":1,"stats":{"Line":0}},{"line":214,"address":[12394325,12394747],"length":1,"stats":{"Line":0}},{"line":215,"address":[12394348],"length":1,"stats":{"Line":0}},{"line":217,"address":[12394392],"length":1,"stats":{"Line":0}},{"line":218,"address":[12394457],"length":1,"stats":{"Line":0}},{"line":219,"address":[12394529],"length":1,"stats":{"Line":0}},{"line":226,"address":[12393616,12394183,12394217],"length":1,"stats":{"Line":0}},{"line":233,"address":[12394123,12393701],"length":1,"stats":{"Line":0}},{"line":234,"address":[12393724],"length":1,"stats":{"Line":0}},{"line":236,"address":[12393768],"length":1,"stats":{"Line":0}},{"line":237,"address":[12393833],"length":1,"stats":{"Line":0}},{"line":238,"address":[12393905],"length":1,"stats":{"Line":0}},{"line":244,"address":[12388272,12388838,12388804],"length":1,"stats":{"Line":0}},{"line":245,"address":[12388747,12388305],"length":1,"stats":{"Line":0}},{"line":246,"address":[12388327],"length":1,"stats":{"Line":0}},{"line":248,"address":[12388371],"length":1,"stats":{"Line":0}},{"line":249,"address":[12388439],"length":1,"stats":{"Line":0}},{"line":250,"address":[12388507],"length":1,"stats":{"Line":0}},{"line":251,"address":[12388574],"length":1,"stats":{"Line":0}},{"line":252,"address":[12388581],"length":1,"stats":{"Line":0}},{"line":258,"address":[12387280,12387848,12387882],"length":1,"stats":{"Line":1}},{"line":259,"address":[12387313,12387791],"length":1,"stats":{"Line":3}},{"line":260,"address":[12387335],"length":1,"stats":{"Line":2}},{"line":262,"address":[12387379],"length":1,"stats":{"Line":1}},{"line":263,"address":[12387447],"length":1,"stats":{"Line":2}},{"line":264,"address":[12387515],"length":1,"stats":{"Line":1}},{"line":265,"address":[12387582],"length":1,"stats":{"Line":2}},{"line":266,"address":[12387589],"length":1,"stats":{"Line":1}},{"line":267,"address":[12387597],"length":1,"stats":{"Line":2}},{"line":268,"address":[12387601],"length":1,"stats":{"Line":1}},{"line":274,"address":[12388864,12389657,12389735],"length":1,"stats":{"Line":0}},{"line":275,"address":[12389499,12388903],"length":1,"stats":{"Line":0}},{"line":276,"address":[12388926],"length":1,"stats":{"Line":0}},{"line":278,"address":[12388970],"length":1,"stats":{"Line":0}},{"line":279,"address":[12389035],"length":1,"stats":{"Line":0}},{"line":280,"address":[12389104],"length":1,"stats":{"Line":0}},{"line":281,"address":[12389177],"length":1,"stats":{"Line":0}},{"line":282,"address":[12389202,12389250],"length":1,"stats":{"Line":0}},{"line":288,"address":[12389760,12390323,12390286],"length":1,"stats":{"Line":0}},{"line":289,"address":[12389810,12390131],"length":1,"stats":{"Line":0}},{"line":290,"address":[12389833],"length":1,"stats":{"Line":0}},{"line":291,"address":[12389877,12389946],"length":1,"stats":{"Line":0}},{"line":296,"address":[12392192,12392755,12392718],"length":1,"stats":{"Line":0}},{"line":297,"address":[12392242,12392563],"length":1,"stats":{"Line":0}},{"line":298,"address":[12392265],"length":1,"stats":{"Line":0}},{"line":299,"address":[12392309,12392378],"length":1,"stats":{"Line":0}},{"line":304,"address":[12399304,12399341,12398768],"length":1,"stats":{"Line":0}},{"line":305,"address":[12398822,12399149],"length":1,"stats":{"Line":0}},{"line":306,"address":[12398845],"length":1,"stats":{"Line":0}},{"line":307,"address":[12398889,12398958],"length":1,"stats":{"Line":0}},{"line":312,"address":[12392165,12391632,12392128],"length":1,"stats":{"Line":0}},{"line":313,"address":[12391671,12391976],"length":1,"stats":{"Line":0}},{"line":314,"address":[12391694],"length":1,"stats":{"Line":0}},{"line":315,"address":[12391738,12391807],"length":1,"stats":{"Line":0}},{"line":320,"address":[12398749,12398712,12398176],"length":1,"stats":{"Line":0}},{"line":321,"address":[12398230,12398557],"length":1,"stats":{"Line":0}},{"line":322,"address":[12398253],"length":1,"stats":{"Line":0}},{"line":323,"address":[12398297,12398366],"length":1,"stats":{"Line":0}},{"line":328,"address":[12387904,12388237],"length":1,"stats":{"Line":0}},{"line":329,"address":[12387941],"length":1,"stats":{"Line":0}},{"line":330,"address":[12388019],"length":1,"stats":{"Line":0}},{"line":334,"address":[12406786,12406752,12406240],"length":1,"stats":{"Line":0}},{"line":341,"address":[12406313,12406692],"length":1,"stats":{"Line":0}},{"line":342,"address":[12406336],"length":1,"stats":{"Line":0}},{"line":344,"address":[12406380],"length":1,"stats":{"Line":0}},{"line":345,"address":[12406453],"length":1,"stats":{"Line":0}},{"line":346,"address":[12406506],"length":1,"stats":{"Line":0}},{"line":347,"address":[12406563],"length":1,"stats":{"Line":0}},{"line":353,"address":[12403881,12403376,12403915],"length":1,"stats":{"Line":0}},{"line":359,"address":[12403824,12403435],"length":1,"stats":{"Line":0}},{"line":360,"address":[12403458],"length":1,"stats":{"Line":0}},{"line":361,"address":[12403502,12403574],"length":1,"stats":{"Line":0}},{"line":366,"address":[12403936,12404441,12404475],"length":1,"stats":{"Line":0}},{"line":372,"address":[12404384,12403995],"length":1,"stats":{"Line":0}},{"line":373,"address":[12404018],"length":1,"stats":{"Line":0}},{"line":374,"address":[12404134,12404062],"length":1,"stats":{"Line":0}},{"line":379,"address":[12393520,12392768,12393598],"length":1,"stats":{"Line":0}},{"line":385,"address":[12392833,12393362],"length":1,"stats":{"Line":0}},{"line":386,"address":[12392856],"length":1,"stats":{"Line":0}},{"line":388,"address":[12392900],"length":1,"stats":{"Line":0}},{"line":389,"address":[12392969],"length":1,"stats":{"Line":0}},{"line":390,"address":[12393030],"length":1,"stats":{"Line":0}},{"line":391,"address":[12393091,12393139],"length":1,"stats":{"Line":0}},{"line":397,"address":[12404496,12405128,12405187],"length":1,"stats":{"Line":0}},{"line":398,"address":[12404970,12404548],"length":1,"stats":{"Line":0}},{"line":399,"address":[12404571],"length":1,"stats":{"Line":0}},{"line":401,"address":[12404615],"length":1,"stats":{"Line":0}},{"line":402,"address":[12404684],"length":1,"stats":{"Line":0}},{"line":403,"address":[12404745,12404793],"length":1,"stats":{"Line":0}},{"line":409,"address":[12400190,12399360,12400112],"length":1,"stats":{"Line":0}},{"line":415,"address":[12399425,12399954],"length":1,"stats":{"Line":0}},{"line":416,"address":[12399448],"length":1,"stats":{"Line":0}},{"line":418,"address":[12399492],"length":1,"stats":{"Line":0}},{"line":419,"address":[12399561],"length":1,"stats":{"Line":0}},{"line":420,"address":[12399622],"length":1,"stats":{"Line":0}},{"line":421,"address":[12399731,12399683],"length":1,"stats":{"Line":0}},{"line":429,"address":[12408912,12408352,12408906],"length":1,"stats":{"Line":0}},{"line":436,"address":[12408466,12408758],"length":1,"stats":{"Line":0}},{"line":437,"address":[12408489],"length":1,"stats":{"Line":0}},{"line":443,"address":[12408547,12408591],"length":1,"stats":{"Line":0}},{"line":449,"address":[12411980,12411986,12411504],"length":1,"stats":{"Line":0}},{"line":455,"address":[12411832,12411582],"length":1,"stats":{"Line":0}},{"line":456,"address":[12411605],"length":1,"stats":{"Line":0}},{"line":461,"address":[12411704,12411660],"length":1,"stats":{"Line":0}},{"line":467,"address":[12406188,12406225,12405584],"length":1,"stats":{"Line":0}},{"line":474,"address":[12405673,12406033],"length":1,"stats":{"Line":0}},{"line":475,"address":[12405696],"length":1,"stats":{"Line":0}},{"line":477,"address":[12405751],"length":1,"stats":{"Line":0}},{"line":481,"address":[12405808,12405856],"length":1,"stats":{"Line":0}},{"line":487,"address":[12412593,12412000,12412587],"length":1,"stats":{"Line":0}},{"line":494,"address":[12412433,12412117],"length":1,"stats":{"Line":0}},{"line":495,"address":[12412140],"length":1,"stats":{"Line":0}},{"line":497,"address":[12412193],"length":1,"stats":{"Line":0}},{"line":501,"address":[12412257],"length":1,"stats":{"Line":0}},{"line":507,"address":[12409684,12408928,12409743],"length":1,"stats":{"Line":0}},{"line":515,"address":[12409032,12409526],"length":1,"stats":{"Line":0}},{"line":516,"address":[12409055],"length":1,"stats":{"Line":0}},{"line":518,"address":[12409105],"length":1,"stats":{"Line":0}},{"line":519,"address":[12409174],"length":1,"stats":{"Line":0}},{"line":520,"address":[12409227],"length":1,"stats":{"Line":0}},{"line":523,"address":[12409292],"length":1,"stats":{"Line":0}},{"line":529,"address":[12410575,12409760,12410516],"length":1,"stats":{"Line":0}},{"line":537,"address":[12410358,12409864],"length":1,"stats":{"Line":0}},{"line":538,"address":[12409887],"length":1,"stats":{"Line":0}},{"line":540,"address":[12409937],"length":1,"stats":{"Line":0}},{"line":541,"address":[12410006],"length":1,"stats":{"Line":0}},{"line":542,"address":[12410059],"length":1,"stats":{"Line":0}},{"line":545,"address":[12410124],"length":1,"stats":{"Line":0}},{"line":551,"address":[12391608,12391024,12391571],"length":1,"stats":{"Line":0}},{"line":557,"address":[12391085,12391416],"length":1,"stats":{"Line":0}},{"line":558,"address":[12391108],"length":1,"stats":{"Line":0}},{"line":560,"address":[12391160],"length":1,"stats":{"Line":0}},{"line":563,"address":[12391265,12391217],"length":1,"stats":{"Line":0}},{"line":569,"address":[12398104,12398163,12397456],"length":1,"stats":{"Line":0}},{"line":575,"address":[12397519,12397946],"length":1,"stats":{"Line":0}},{"line":576,"address":[12397542],"length":1,"stats":{"Line":0}},{"line":578,"address":[12397594],"length":1,"stats":{"Line":0}},{"line":579,"address":[12397651],"length":1,"stats":{"Line":0}},{"line":581,"address":[12397712,12397760],"length":1,"stats":{"Line":0}},{"line":586,"address":[12410592,12410991,12410985],"length":1,"stats":{"Line":0}},{"line":593,"address":[12410897,12410678],"length":1,"stats":{"Line":0}},{"line":594,"address":[12410701],"length":1,"stats":{"Line":0}},{"line":595,"address":[12410819,12410753],"length":1,"stats":{"Line":0}},{"line":599,"address":[12412887,12412881,12412608],"length":1,"stats":{"Line":0}},{"line":606,"address":[12412698,12412817],"length":1,"stats":{"Line":0}},{"line":607,"address":[12412730],"length":1,"stats":{"Line":0}}],"covered":39,"coverable":237},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","fees.rs"],"content":"use crate::errors::QuickLendXError;\nuse soroban_sdk::{contracttype, symbol_short, vec, Address, Env, Map, Symbol, Vec};\n\n// Constants\nconst MAX_FEE_BPS: u32 = 1000;\nconst MIN_FEE_BPS: u32 = 0;\nconst BPS_DENOMINATOR: i128 = 10_000;\n\n// Storage keys\nconst FEE_CONFIG_KEY: Symbol = symbol_short!(\"fee_cfg\");\nconst REVENUE_KEY: Symbol = symbol_short!(\"revenue\");\nconst VOLUME_KEY: Symbol = symbol_short!(\"volume\");\n\n/// Fee types supported by the platform\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum FeeType {\n    Platform,\n    Processing,\n    Verification,\n    EarlyPayment,\n    LatePayment,\n}\n\n/// Volume tier for discounted fees\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum VolumeTier {\n    Standard,\n    Silver,\n    Gold,\n    Platinum,\n}\n\n/// Fee structure configuration\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct FeeStructure {\n    pub fee_type: FeeType,\n    pub base_fee_bps: u32,\n    pub min_fee: i128,\n    pub max_fee: i128,\n    pub is_active: bool,\n    pub updated_at: u64,\n    pub updated_by: Address,\n}\n\n/// User volume data\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct UserVolumeData {\n    pub user: Address,\n    pub total_volume: i128,\n    pub transaction_count: u32,\n    pub current_tier: VolumeTier,\n    pub last_updated: u64,\n}\n\n/// Revenue configuration\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct RevenueConfig {\n    pub treasury_address: Address,\n    pub treasury_share_bps: u32,\n    pub developer_share_bps: u32,\n    pub platform_share_bps: u32,\n    pub auto_distribution: bool,\n    pub min_distribution_amount: i128,\n}\n\n/// Revenue tracking\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct RevenueData {\n    pub period: u64,\n    pub total_collected: i128,\n    pub fees_by_type: Map\u003cFeeType, i128\u003e,\n    pub total_distributed: i128,\n    pub pending_distribution: i128,\n    pub transaction_count: u32,\n}\n\n/// Fee analytics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct FeeAnalytics {\n    pub period: u64,\n    pub total_fees: i128,\n    pub average_fee_rate: i128,\n    pub total_transactions: u32,\n    pub fee_efficiency_score: u32,\n}\n\npub struct FeeManager;\n\nimpl FeeManager {\n    pub fn initialize(env: \u0026Env, admin: \u0026Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        admin.require_auth();\n        let default_fees = vec![\n            env,\n            FeeStructure {\n                fee_type: FeeType::Platform,\n                base_fee_bps: 200,\n                min_fee: 100,\n                max_fee: 1_000_000,\n                is_active: true,\n                updated_at: env.ledger().timestamp(),\n                updated_by: admin.clone(),\n            },\n            FeeStructure {\n                fee_type: FeeType::Processing,\n                base_fee_bps: 50,\n                min_fee: 50,\n                max_fee: 500_000,\n                is_active: true,\n                updated_at: env.ledger().timestamp(),\n                updated_by: admin.clone(),\n            },\n            FeeStructure {\n                fee_type: FeeType::Verification,\n                base_fee_bps: 100,\n                min_fee: 100,\n                max_fee: 100_000,\n                is_active: true,\n                updated_at: env.ledger().timestamp(),\n                updated_by: admin.clone(),\n            },\n        ];\n        env.storage().instance().set(\u0026FEE_CONFIG_KEY, \u0026default_fees);\n        Ok(())\n    }\n\n    pub fn get_fee_structure(\n        env: \u0026Env,\n        fee_type: \u0026FeeType,\n    ) -\u003e Result\u003cFeeStructure, QuickLendXError\u003e {\n        let fee_structures: Vec\u003cFeeStructure\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026FEE_CONFIG_KEY)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        for i in 0..fee_structures.len() {\n            let structure = fee_structures.get(i).unwrap();\n            if structure.fee_type == *fee_type {\n                return Ok(structure);\n            }\n        }\n        Err(QuickLendXError::StorageKeyNotFound)\n    }\n\n    pub fn update_fee_structure(\n        env: \u0026Env,\n        admin: \u0026Address,\n        fee_type: FeeType,\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n        is_active: bool,\n    ) -\u003e Result\u003cFeeStructure, QuickLendXError\u003e {\n        admin.require_auth();\n        if base_fee_bps \u003e MAX_FEE_BPS {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        if min_fee \u003c 0 || max_fee \u003c min_fee {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let mut fee_structures: Vec\u003cFeeStructure\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026FEE_CONFIG_KEY)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let mut found = false;\n        let updated_structure = FeeStructure {\n            fee_type: fee_type.clone(),\n            base_fee_bps,\n            min_fee,\n            max_fee,\n            is_active,\n            updated_at: env.ledger().timestamp(),\n            updated_by: admin.clone(),\n        };\n        for i in 0..fee_structures.len() {\n            let structure = fee_structures.get(i).unwrap();\n            if structure.fee_type == fee_type {\n                fee_structures.set(i, updated_structure.clone());\n                found = true;\n                break;\n            }\n        }\n        if !found {\n            fee_structures.push_back(updated_structure.clone());\n        }\n        env.storage()\n            .instance()\n            .set(\u0026FEE_CONFIG_KEY, \u0026fee_structures);\n        Ok(updated_structure)\n    }\n\n    pub fn calculate_total_fees(\n        env: \u0026Env,\n        user: \u0026Address,\n        transaction_amount: i128,\n        is_early_payment: bool,\n        is_late_payment: bool,\n    ) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        if transaction_amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let fee_structures: Vec\u003cFeeStructure\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026FEE_CONFIG_KEY)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let user_volume_data = Self::get_user_volume(env, user);\n        let tier_discount = Self::get_tier_discount(\u0026user_volume_data.current_tier);\n        let mut total_fees: i128 = 0;\n        for i in 0..fee_structures.len() {\n            let structure = fee_structures.get(i).unwrap();\n            if !structure.is_active {\n                continue;\n            }\n            if structure.fee_type == FeeType::EarlyPayment \u0026\u0026 !is_early_payment {\n                continue;\n            }\n            if structure.fee_type == FeeType::LatePayment \u0026\u0026 !is_late_payment {\n                continue;\n            }\n            let mut fee = Self::calculate_base_fee(\u0026structure, transaction_amount)?;\n            if structure.fee_type != FeeType::LatePayment {\n                fee = fee - (fee * tier_discount as i128 / BPS_DENOMINATOR);\n            }\n            if is_early_payment \u0026\u0026 structure.fee_type == FeeType::Platform {\n                fee = fee - (fee * 1000 / BPS_DENOMINATOR);\n            }\n            if is_late_payment \u0026\u0026 structure.fee_type == FeeType::LatePayment {\n                fee = fee + (fee * 2000 / BPS_DENOMINATOR);\n            }\n            total_fees += fee;\n        }\n        Ok(total_fees)\n    }\n\n    fn calculate_base_fee(structure: \u0026FeeStructure, amount: i128) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        let fee = amount * structure.base_fee_bps as i128 / BPS_DENOMINATOR;\n        let fee = if fee \u003c structure.min_fee {\n            structure.min_fee\n        } else if fee \u003e structure.max_fee {\n            structure.max_fee\n        } else {\n            fee\n        };\n        Ok(fee)\n    }\n\n    fn get_tier_discount(tier: \u0026VolumeTier) -\u003e u32 {\n        match tier {\n            VolumeTier::Standard =\u003e 0,\n            VolumeTier::Silver =\u003e 500,\n            VolumeTier::Gold =\u003e 1000,\n            VolumeTier::Platinum =\u003e 1500,\n        }\n    }\n\n    pub fn get_user_volume(env: \u0026Env, user: \u0026Address) -\u003e UserVolumeData {\n        let key = (VOLUME_KEY, user.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or(UserVolumeData {\n                user: user.clone(),\n                total_volume: 0,\n                transaction_count: 0,\n                current_tier: VolumeTier::Standard,\n                last_updated: env.ledger().timestamp(),\n            })\n    }\n\n    pub fn update_user_volume(\n        env: \u0026Env,\n        user: \u0026Address,\n        transaction_amount: i128,\n    ) -\u003e Result\u003cUserVolumeData, QuickLendXError\u003e {\n        let mut volume_data = Self::get_user_volume(env, user);\n        volume_data.total_volume = volume_data.total_volume.saturating_add(transaction_amount);\n        volume_data.transaction_count = volume_data.transaction_count.saturating_add(1);\n        volume_data.last_updated = env.ledger().timestamp();\n        volume_data.current_tier = if volume_data.total_volume \u003e= 1_000_000_000_000 {\n            VolumeTier::Platinum\n        } else if volume_data.total_volume \u003e= 500_000_000_000 {\n            VolumeTier::Gold\n        } else if volume_data.total_volume \u003e= 100_000_000_000 {\n            VolumeTier::Silver\n        } else {\n            VolumeTier::Standard\n        };\n        let key = (VOLUME_KEY, user.clone());\n        env.storage().instance().set(\u0026key, \u0026volume_data);\n        Ok(volume_data)\n    }\n\n    pub fn collect_fees(\n        env: \u0026Env,\n        user: \u0026Address,\n        fees_collected: Map\u003cFeeType, i128\u003e,\n        total_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let period = Self::get_current_period(env);\n        let key = (REVENUE_KEY, period);\n        let mut revenue_data: RevenueData =\n            env.storage().instance().get(\u0026key).unwrap_or(RevenueData {\n                period,\n                total_collected: 0,\n                fees_by_type: Map::new(env),\n                total_distributed: 0,\n                pending_distribution: 0,\n                transaction_count: 0,\n            });\n        revenue_data.total_collected = revenue_data.total_collected.saturating_add(total_amount);\n        revenue_data.pending_distribution = revenue_data\n            .pending_distribution\n            .saturating_add(total_amount);\n        revenue_data.transaction_count = revenue_data.transaction_count.saturating_add(1);\n        // Copy fees by type into revenue data\n        revenue_data.fees_by_type = fees_collected;\n        env.storage().instance().set(\u0026key, \u0026revenue_data);\n        Self::update_user_volume(env, user, total_amount)?;\n        Ok(())\n    }\n\n    fn get_current_period(env: \u0026Env) -\u003e u64 {\n        env.ledger().timestamp() / 2_592_000\n    }\n\n    pub fn configure_revenue_distribution(\n        env: \u0026Env,\n        admin: \u0026Address,\n        config: RevenueConfig,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        admin.require_auth();\n        let total_shares =\n            config.treasury_share_bps + config.developer_share_bps + config.platform_share_bps;\n        if total_shares != 10_000 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let key = symbol_short!(\"rev_cfg\");\n        env.storage().instance().set(\u0026key, \u0026config);\n        Ok(())\n    }\n\n    pub fn distribute_revenue(\n        env: \u0026Env,\n        admin: \u0026Address,\n        period: u64,\n    ) -\u003e Result\u003c(i128, i128, i128), QuickLendXError\u003e {\n        admin.require_auth();\n        let config: RevenueConfig = env\n            .storage()\n            .instance()\n            .get(\u0026symbol_short!(\"rev_cfg\"))\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let revenue_key = (REVENUE_KEY, period);\n        let mut revenue_data: RevenueData = env\n            .storage()\n            .instance()\n            .get(\u0026revenue_key)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        if revenue_data.pending_distribution \u003c config.min_distribution_amount {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let amount = revenue_data.pending_distribution;\n        let treasury_amount = amount * config.treasury_share_bps as i128 / BPS_DENOMINATOR;\n        let developer_amount = amount * config.developer_share_bps as i128 / BPS_DENOMINATOR;\n        let platform_amount = amount - treasury_amount - developer_amount;\n        revenue_data.total_distributed = revenue_data.total_distributed.saturating_add(amount);\n        revenue_data.pending_distribution = 0;\n        env.storage().instance().set(\u0026revenue_key, \u0026revenue_data);\n        Ok((treasury_amount, developer_amount, platform_amount))\n    }\n\n    pub fn get_analytics(env: \u0026Env, period: u64) -\u003e Result\u003cFeeAnalytics, QuickLendXError\u003e {\n        let revenue_key = (REVENUE_KEY, period);\n        let revenue_data: RevenueData = env\n            .storage()\n            .instance()\n            .get(\u0026revenue_key)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let average_fee_rate = if revenue_data.transaction_count \u003e 0 {\n            revenue_data.total_collected / revenue_data.transaction_count as i128\n        } else {\n            0\n        };\n        let efficiency_score = if revenue_data.total_collected \u003e 0 {\n            let distributed_pct =\n                revenue_data.total_distributed * 100 / revenue_data.total_collected;\n            distributed_pct.min(100) as u32\n        } else {\n            0\n        };\n        Ok(FeeAnalytics {\n            period,\n            total_fees: revenue_data.total_collected,\n            average_fee_rate,\n            total_transactions: revenue_data.transaction_count,\n            fee_efficiency_score: efficiency_score,\n        })\n    }\n\n    pub fn validate_fee_params(\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        if base_fee_bps \u003c MIN_FEE_BPS || base_fee_bps \u003e MAX_FEE_BPS {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        if min_fee \u003c 0 || max_fee \u003c 0 || max_fee \u003c min_fee {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":97,"address":[13748400,13748406,13746688],"length":1,"stats":{"Line":0}},{"line":98,"address":[13746734],"length":1,"stats":{"Line":0}},{"line":99,"address":[13747295,13747359,13747079,13748427,13747015,13747552],"length":1,"stats":{"Line":0}},{"line":101,"address":[13746861],"length":1,"stats":{"Line":0}},{"line":107,"address":[13746761],"length":1,"stats":{"Line":0}},{"line":108,"address":[13746844],"length":1,"stats":{"Line":0}},{"line":110,"address":[13747141],"length":1,"stats":{"Line":0}},{"line":111,"address":[24170064,24165029,24170139,24166950,24165024,24166848,24166016,24166087],"length":1,"stats":{"Line":0}},{"line":116,"address":[13747000,13747047],"length":1,"stats":{"Line":0}},{"line":117,"address":[13747124],"length":1,"stats":{"Line":0}},{"line":119,"address":[24170087,24166893,24166061],"length":1,"stats":{"Line":0}},{"line":125,"address":[13747327,13747280],"length":1,"stats":{"Line":0}},{"line":126,"address":[13747404],"length":1,"stats":{"Line":0}},{"line":129,"address":[13748087],"length":1,"stats":{"Line":0}},{"line":130,"address":[24166075,24166933,24170107,24166876],"length":1,"stats":{"Line":0}},{"line":133,"address":[13753963,13753957,13752960],"length":1,"stats":{"Line":0}},{"line":137,"address":[13753245,13753295],"length":1,"stats":{"Line":0}},{"line":140,"address":[13753084],"length":1,"stats":{"Line":0}},{"line":141,"address":[13753160,13753396,13753040,13753976,13753284],"length":1,"stats":{"Line":0}},{"line":142,"address":[13753577],"length":1,"stats":{"Line":0}},{"line":143,"address":[13753771,13753726],"length":1,"stats":{"Line":0}},{"line":144,"address":[13753869,13753806],"length":1,"stats":{"Line":0}},{"line":145,"address":[24070405],"length":1,"stats":{"Line":0}},{"line":148,"address":[13753738],"length":1,"stats":{"Line":0}},{"line":151,"address":[13762240,13764272,13764278],"length":1,"stats":{"Line":0}},{"line":160,"address":[13762385],"length":1,"stats":{"Line":0}},{"line":161,"address":[13762399],"length":1,"stats":{"Line":0}},{"line":162,"address":[13762428],"length":1,"stats":{"Line":0}},{"line":164,"address":[13762466,13762416],"length":1,"stats":{"Line":0}},{"line":165,"address":[13762481],"length":1,"stats":{"Line":0}},{"line":167,"address":[13762751,13762804],"length":1,"stats":{"Line":0}},{"line":170,"address":[24070687],"length":1,"stats":{"Line":0}},{"line":171,"address":[24070658],"length":1,"stats":{"Line":0}},{"line":172,"address":[13763096],"length":1,"stats":{"Line":0}},{"line":174,"address":[13763112],"length":1,"stats":{"Line":0}},{"line":179,"address":[13763136],"length":1,"stats":{"Line":0}},{"line":180,"address":[13763224],"length":1,"stats":{"Line":0}},{"line":182,"address":[13763457],"length":1,"stats":{"Line":0}},{"line":183,"address":[13763613,13763639],"length":1,"stats":{"Line":0}},{"line":184,"address":[13763669,13763740],"length":1,"stats":{"Line":0}},{"line":185,"address":[13763780],"length":1,"stats":{"Line":0}},{"line":186,"address":[13763814],"length":1,"stats":{"Line":0}},{"line":190,"address":[13763620],"length":1,"stats":{"Line":0}},{"line":191,"address":[13763856,13763899],"length":1,"stats":{"Line":0}},{"line":193,"address":[24070808],"length":1,"stats":{"Line":0}},{"line":195,"address":[13763979,13763935],"length":1,"stats":{"Line":0}},{"line":196,"address":[13764197],"length":1,"stats":{"Line":0}},{"line":199,"address":[13759088,13762111,13762105],"length":1,"stats":{"Line":0}},{"line":206,"address":[13759240],"length":1,"stats":{"Line":0}},{"line":207,"address":[13759316],"length":1,"stats":{"Line":0}},{"line":209,"address":[13759542,13759598],"length":1,"stats":{"Line":0}},{"line":212,"address":[13759378],"length":1,"stats":{"Line":0}},{"line":213,"address":[13759334,13759711,13762124,13759584,13759454],"length":1,"stats":{"Line":0}},{"line":214,"address":[13759914],"length":1,"stats":{"Line":0}},{"line":215,"address":[13759987,13759921],"length":1,"stats":{"Line":0}},{"line":216,"address":[13759994],"length":1,"stats":{"Line":0}},{"line":217,"address":[24107308],"length":1,"stats":{"Line":0}},{"line":218,"address":[13760208,13760297],"length":1,"stats":{"Line":0}},{"line":219,"address":[24107301],"length":1,"stats":{"Line":0}},{"line":222,"address":[13760473,13760431,13760355],"length":1,"stats":{"Line":0}},{"line":225,"address":[13760541,13760437,13760489],"length":1,"stats":{"Line":0}},{"line":226,"address":[24107432],"length":1,"stats":{"Line":0}},{"line":228,"address":[13760527,13760566],"length":1,"stats":{"Line":0}},{"line":229,"address":[24107449],"length":1,"stats":{"Line":0}},{"line":230,"address":[13761113,13760744],"length":1,"stats":{"Line":0}},{"line":232,"address":[13761154,13761537,13760724],"length":1,"stats":{"Line":0}},{"line":233,"address":[13761196,13761542],"length":1,"stats":{"Line":0}},{"line":235,"address":[13761966,13761141,13761627],"length":1,"stats":{"Line":0}},{"line":236,"address":[13761663,13761971],"length":1,"stats":{"Line":0}},{"line":238,"address":[13762036,13762002,13761563],"length":1,"stats":{"Line":0}},{"line":240,"address":[13760223],"length":1,"stats":{"Line":0}},{"line":243,"address":[13754160],"length":1,"stats":{"Line":0}},{"line":244,"address":[13754449,13754211],"length":1,"stats":{"Line":0}},{"line":245,"address":[24069448],"length":1,"stats":{"Line":0}},{"line":246,"address":[13754500],"length":1,"stats":{"Line":0}},{"line":247,"address":[24069452],"length":1,"stats":{"Line":0}},{"line":248,"address":[13754546],"length":1,"stats":{"Line":0}},{"line":250,"address":[24069490,24069697],"length":1,"stats":{"Line":0}},{"line":252,"address":[13754574],"length":1,"stats":{"Line":0}},{"line":255,"address":[13754080],"length":1,"stats":{"Line":0}},{"line":256,"address":[13754085],"length":1,"stats":{"Line":0}},{"line":257,"address":[13754116],"length":1,"stats":{"Line":0}},{"line":258,"address":[13754126],"length":1,"stats":{"Line":0}},{"line":259,"address":[13754136],"length":1,"stats":{"Line":0}},{"line":260,"address":[24069833],"length":1,"stats":{"Line":0}},{"line":264,"address":[13751888,13752901,13752937],"length":1,"stats":{"Line":0}},{"line":265,"address":[13751939],"length":1,"stats":{"Line":0}},{"line":266,"address":[13752145,13752621],"length":1,"stats":{"Line":0}},{"line":268,"address":[13752274,13752323],"length":1,"stats":{"Line":0}},{"line":269,"address":[13752522,13752645],"length":1,"stats":{"Line":0}},{"line":270,"address":[13752339],"length":1,"stats":{"Line":0}},{"line":271,"address":[24069665],"length":1,"stats":{"Line":0}},{"line":272,"address":[24069682],"length":1,"stats":{"Line":0}},{"line":274,"address":[13752444,13752396],"length":1,"stats":{"Line":0}},{"line":278,"address":[13757776,13758885,13758891],"length":1,"stats":{"Line":0}},{"line":283,"address":[13757845],"length":1,"stats":{"Line":0}},{"line":284,"address":[13757881,13757959],"length":1,"stats":{"Line":0}},{"line":285,"address":[13757969],"length":1,"stats":{"Line":0}},{"line":286,"address":[13758016],"length":1,"stats":{"Line":0}},{"line":287,"address":[13758257,13758118,13758190],"length":1,"stats":{"Line":0}},{"line":288,"address":[13758182],"length":1,"stats":{"Line":0}},{"line":289,"address":[13758150,13758232],"length":1,"stats":{"Line":0}},{"line":290,"address":[13758224],"length":1,"stats":{"Line":0}},{"line":291,"address":[24068643],"length":1,"stats":{"Line":0}},{"line":292,"address":[24068652],"length":1,"stats":{"Line":0}},{"line":294,"address":[13758234],"length":1,"stats":{"Line":0}},{"line":296,"address":[13758271],"length":1,"stats":{"Line":0}},{"line":297,"address":[13758484,13758531],"length":1,"stats":{"Line":0}},{"line":298,"address":[13758711],"length":1,"stats":{"Line":0}},{"line":301,"address":[13750148,13750172,13748464],"length":1,"stats":{"Line":0}},{"line":307,"address":[13748615,13748528],"length":1,"stats":{"Line":0}},{"line":308,"address":[24068822],"length":1,"stats":{"Line":0}},{"line":309,"address":[13748722,13748864,13748930,13748811,13748678],"length":1,"stats":{"Line":0}},{"line":311,"address":[24068867],"length":1,"stats":{"Line":0}},{"line":312,"address":[24068871],"length":1,"stats":{"Line":0}},{"line":313,"address":[13748880],"length":1,"stats":{"Line":0}},{"line":316,"address":[24068902],"length":1,"stats":{"Line":0}},{"line":318,"address":[13749245],"length":1,"stats":{"Line":0}},{"line":319,"address":[13749357,13749314],"length":1,"stats":{"Line":0}},{"line":320,"address":[24069216],"length":1,"stats":{"Line":0}},{"line":321,"address":[24069238],"length":1,"stats":{"Line":0}},{"line":322,"address":[24069243],"length":1,"stats":{"Line":0}},{"line":324,"address":[13749412],"length":1,"stats":{"Line":0}},{"line":325,"address":[13749588],"length":1,"stats":{"Line":0}},{"line":326,"address":[24069280,24069285,24069256],"length":1,"stats":{"Line":0}},{"line":327,"address":[24069274],"length":1,"stats":{"Line":0}},{"line":330,"address":[13757632,13757753,13757759],"length":1,"stats":{"Line":0}},{"line":331,"address":[24068970],"length":1,"stats":{"Line":0}},{"line":334,"address":[24069120],"length":1,"stats":{"Line":0}},{"line":339,"address":[13764446],"length":1,"stats":{"Line":0}},{"line":340,"address":[13764499,13764579],"length":1,"stats":{"Line":0}},{"line":342,"address":[13764570],"length":1,"stats":{"Line":0}},{"line":343,"address":[13764658],"length":1,"stats":{"Line":0}},{"line":345,"address":[24069096],"length":1,"stats":{"Line":0}},{"line":346,"address":[13764646,13764717],"length":1,"stats":{"Line":0}},{"line":347,"address":[13764877],"length":1,"stats":{"Line":0}},{"line":350,"address":[13757430,13757504,13754608],"length":1,"stats":{"Line":0}},{"line":355,"address":[13754690],"length":1,"stats":{"Line":0}},{"line":356,"address":[24069888],"length":1,"stats":{"Line":0}},{"line":359,"address":[13754799],"length":1,"stats":{"Line":0}},{"line":360,"address":[13755005,13755196,13757517,13754755,13754875],"length":1,"stats":{"Line":0}},{"line":361,"address":[13755391],"length":1,"stats":{"Line":0}},{"line":362,"address":[13755739,13755683],"length":1,"stats":{"Line":0}},{"line":365,"address":[24069999,24069983],"length":1,"stats":{"Line":0}},{"line":366,"address":[13757451,13755526,13755725,13755980,13755598],"length":1,"stats":{"Line":0}},{"line":367,"address":[13756099],"length":1,"stats":{"Line":0}},{"line":368,"address":[13756334],"length":1,"stats":{"Line":0}},{"line":370,"address":[13756145],"length":1,"stats":{"Line":0}},{"line":371,"address":[13756190,13756618,13756365],"length":1,"stats":{"Line":0}},{"line":372,"address":[13756639,13756506,13756811],"length":1,"stats":{"Line":0}},{"line":373,"address":[13756786,13756969,13756852],"length":1,"stats":{"Line":0}},{"line":374,"address":[13757007,13756937],"length":1,"stats":{"Line":0}},{"line":375,"address":[13757023],"length":1,"stats":{"Line":0}},{"line":376,"address":[13757055],"length":1,"stats":{"Line":0}},{"line":377,"address":[13757281],"length":1,"stats":{"Line":0}},{"line":380,"address":[13751808,13751867,13750208],"length":1,"stats":{"Line":0}},{"line":381,"address":[13750246],"length":1,"stats":{"Line":0}},{"line":382,"address":[13750538,13750591],"length":1,"stats":{"Line":0}},{"line":385,"address":[13750446],"length":1,"stats":{"Line":0}},{"line":386,"address":[13750381,13751814,13750832,13750453,13750577],"length":1,"stats":{"Line":0}},{"line":387,"address":[13750951,13750985,13751198],"length":1,"stats":{"Line":0}},{"line":388,"address":[13751203,13750987,13751096],"length":1,"stats":{"Line":0}},{"line":390,"address":[13750961],"length":1,"stats":{"Line":0}},{"line":392,"address":[13751232,13751041,13751777],"length":1,"stats":{"Line":0}},{"line":393,"address":[13751745,13751237,13751542],"length":1,"stats":{"Line":0}},{"line":395,"address":[13751734,13751770],"length":1,"stats":{"Line":0}},{"line":397,"address":[13751221],"length":1,"stats":{"Line":0}},{"line":399,"address":[13751428],"length":1,"stats":{"Line":0}},{"line":400,"address":[24070234],"length":1,"stats":{"Line":0}},{"line":401,"address":[13751382],"length":1,"stats":{"Line":0}},{"line":402,"address":[13751398],"length":1,"stats":{"Line":0}},{"line":403,"address":[13751414],"length":1,"stats":{"Line":0}},{"line":404,"address":[13751421],"length":1,"stats":{"Line":0}},{"line":408,"address":[13758928],"length":1,"stats":{"Line":0}},{"line":413,"address":[13758976],"length":1,"stats":{"Line":0}},{"line":414,"address":[13758992],"length":1,"stats":{"Line":0}},{"line":416,"address":[13759007,13759056],"length":1,"stats":{"Line":0}},{"line":417,"address":[13759026],"length":1,"stats":{"Line":0}},{"line":419,"address":[13759066],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":179},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","investment.rs"],"content":"use crate::errors::QuickLendXError;\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env, Symbol, Vec};\n\n/// Premium rate applied to the covered amount expressed in basis points (1/10,000).\npub const DEFAULT_INSURANCE_PREMIUM_BPS: i128 = 200; // 2% of the covered amount.\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct InsuranceCoverage {\n    pub provider: Address,\n    pub coverage_amount: i128,\n    pub premium_amount: i128,\n    pub coverage_percentage: u32,\n    pub active: bool,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum InvestmentStatus {\n    Active,\n    Withdrawn,\n    Completed,\n    Defaulted,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Investment {\n    pub investment_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub investor: Address,\n    pub amount: i128,\n    pub funded_at: u64,\n    pub status: InvestmentStatus,\n    pub insurance: Vec\u003cInsuranceCoverage\u003e,\n}\n\nimpl Investment {\n    pub fn calculate_premium(amount: i128, coverage_percentage: u32) -\u003e i128 {\n        if amount \u003c= 0 || coverage_percentage == 0 {\n            return 0;\n        }\n\n        let coverage_amount = amount\n            .saturating_mul(coverage_percentage as i128)\n            .checked_div(100)\n            .unwrap_or(0);\n\n        let premium = coverage_amount\n            .saturating_mul(DEFAULT_INSURANCE_PREMIUM_BPS)\n            .checked_div(10_000)\n            .unwrap_or(0);\n\n        if premium == 0 \u0026\u0026 coverage_amount \u003e 0 {\n            1\n        } else {\n            premium\n        }\n    }\n\n    pub fn add_insurance(\n        \u0026mut self,\n        provider: Address,\n        coverage_percentage: u32,\n        premium: i128,\n    ) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        if coverage_percentage == 0 || coverage_percentage \u003e 100 {\n            return Err(QuickLendXError::InvalidCoveragePercentage);\n        }\n\n        if premium \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        for coverage in self.insurance.iter() {\n            if coverage.active {\n                return Err(QuickLendXError::OperationNotAllowed);\n            }\n        }\n\n        let coverage_amount = self\n            .amount\n            .saturating_mul(coverage_percentage as i128)\n            .checked_div(100)\n            .unwrap_or(0);\n\n        self.insurance.push_back(InsuranceCoverage {\n            provider,\n            coverage_amount,\n            premium_amount: premium,\n            coverage_percentage,\n            active: true,\n        });\n\n        Ok(coverage_amount)\n    }\n\n    pub fn has_active_insurance(\u0026self) -\u003e bool {\n        for coverage in self.insurance.iter() {\n            if coverage.active {\n                return true;\n            }\n        }\n        false\n    }\n\n    pub fn process_insurance_claim(\u0026mut self) -\u003e Option\u003c(Address, i128)\u003e {\n        let len = self.insurance.len();\n        for idx in 0..len {\n            if let Some(mut coverage) = self.insurance.get(idx) {\n                if coverage.active {\n                    coverage.active = false;\n                    let provider = coverage.provider.clone();\n                    let amount = coverage.coverage_amount;\n                    self.insurance.set(idx, coverage);\n                    return Some((provider, amount));\n                }\n            }\n        }\n        None\n    }\n}\n\npub struct InvestmentStorage;\n\nimpl InvestmentStorage {\n    fn invoice_index_key(invoice_id: \u0026BytesN\u003c32\u003e) -\u003e (Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"inv_map\"), invoice_id.clone())\n    }\n\n    /// Generate a unique investment ID using timestamp and counter\n    pub fn generate_unique_investment_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"invst_cnt\");\n        let counter = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add investment prefix to distinguish from other entity types\n        id_bytes[0] = 0x1A; // 'I' for Investment\n        id_bytes[1] = 0x4E; // 'N' for iNvestment\n                            // Embed timestamp in next 8 bytes\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter in next 8 bytes\n        id_bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes with a pattern to ensure uniqueness\n        for i in 18..32 {\n            id_bytes[i] = ((timestamp + counter as u64 + 0x1A4E) % 256) as u8;\n        }\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    pub fn store_investment(env: \u0026Env, investment: \u0026Investment) {\n        env.storage()\n            .instance()\n            .set(\u0026investment.investment_id, investment);\n\n        env.storage().instance().set(\n            \u0026Self::invoice_index_key(\u0026investment.invoice_id),\n            \u0026investment.investment_id,\n        );\n    }\n    pub fn get_investment(env: \u0026Env, investment_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvestment\u003e {\n        env.storage().instance().get(investment_id)\n    }\n    pub fn get_investment_by_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvestment\u003e {\n        let index_key = Self::invoice_index_key(invoice_id);\n        let investment_id: Option\u003cBytesN\u003c32\u003e\u003e = env.storage().instance().get(\u0026index_key);\n        investment_id.and_then(|id| Self::get_investment(env, \u0026id))\n    }\n    pub fn update_investment(env: \u0026Env, investment: \u0026Investment) {\n        env.storage()\n            .instance()\n            .set(\u0026investment.investment_id, investment);\n\n        env.storage().instance().set(\n            \u0026Self::invoice_index_key(\u0026investment.invoice_id),\n            \u0026investment.investment_id,\n        );\n    }\n}\n","traces":[{"line":39,"address":[12580800],"length":1,"stats":{"Line":0}},{"line":40,"address":[12580835],"length":1,"stats":{"Line":0}},{"line":41,"address":[12580856],"length":1,"stats":{"Line":0}},{"line":45,"address":[12580893],"length":1,"stats":{"Line":0}},{"line":50,"address":[12581020],"length":1,"stats":{"Line":0}},{"line":54,"address":[12581128,12581155],"length":1,"stats":{"Line":0}},{"line":55,"address":[12581178],"length":1,"stats":{"Line":0}},{"line":57,"address":[12581145],"length":1,"stats":{"Line":0}},{"line":61,"address":[12579872,12580764],"length":1,"stats":{"Line":0}},{"line":67,"address":[12579944],"length":1,"stats":{"Line":0}},{"line":68,"address":[12579979],"length":1,"stats":{"Line":0}},{"line":71,"address":[12580007],"length":1,"stats":{"Line":0}},{"line":72,"address":[12580051],"length":1,"stats":{"Line":0}},{"line":75,"address":[12580123,12580213,12580024],"length":1,"stats":{"Line":0}},{"line":76,"address":[12580266],"length":1,"stats":{"Line":0}},{"line":77,"address":[12580708],"length":1,"stats":{"Line":0}},{"line":81,"address":[12580309,12580465,12580376],"length":1,"stats":{"Line":0}},{"line":83,"address":[12580316],"length":1,"stats":{"Line":0}},{"line":87,"address":[12580481,12580534],"length":1,"stats":{"Line":0}},{"line":88,"address":[12580488],"length":1,"stats":{"Line":0}},{"line":95,"address":[12580658],"length":1,"stats":{"Line":0}},{"line":98,"address":[12581216,12581487,12581493],"length":1,"stats":{"Line":0}},{"line":99,"address":[12581343,12581234],"length":1,"stats":{"Line":0}},{"line":100,"address":[12581396],"length":1,"stats":{"Line":0}},{"line":101,"address":[12581455],"length":1,"stats":{"Line":0}},{"line":104,"address":[12581418],"length":1,"stats":{"Line":0}},{"line":107,"address":[12582238,12582244,12581520],"length":1,"stats":{"Line":0}},{"line":108,"address":[12581558],"length":1,"stats":{"Line":0}},{"line":109,"address":[12581587,12581603],"length":1,"stats":{"Line":0}},{"line":110,"address":[12581784,12581654,12581722],"length":1,"stats":{"Line":0}},{"line":111,"address":[12581753],"length":1,"stats":{"Line":0}},{"line":112,"address":[12581789],"length":1,"stats":{"Line":0}},{"line":113,"address":[12581797],"length":1,"stats":{"Line":0}},{"line":114,"address":[12581870],"length":1,"stats":{"Line":0}},{"line":115,"address":[12581911],"length":1,"stats":{"Line":0}},{"line":116,"address":[12582095],"length":1,"stats":{"Line":0}},{"line":120,"address":[12581705],"length":1,"stats":{"Line":0}},{"line":127,"address":[12583104,12583267,12583273],"length":1,"stats":{"Line":3}},{"line":128,"address":[12583125],"length":1,"stats":{"Line":3}},{"line":132,"address":[12585879,12585885,12584336],"length":1,"stats":{"Line":3}},{"line":133,"address":[12584391],"length":1,"stats":{"Line":3}},{"line":134,"address":[12584508],"length":1,"stats":{"Line":3}},{"line":135,"address":[12584561,12584612],"length":1,"stats":{"Line":6}},{"line":136,"address":[12584869],"length":1,"stats":{"Line":3}},{"line":138,"address":[12585124],"length":1,"stats":{"Line":2}},{"line":140,"address":[12585144],"length":1,"stats":{"Line":1}},{"line":141,"address":[12585152],"length":1,"stats":{"Line":1}},{"line":143,"address":[12585160],"length":1,"stats":{"Line":2}},{"line":145,"address":[12585328],"length":1,"stats":{"Line":1}},{"line":147,"address":[12585484,12585843],"length":1,"stats":{"Line":3}},{"line":148,"address":[12585735,12585853,12585647],"length":1,"stats":{"Line":3}},{"line":151,"address":[12585681],"length":1,"stats":{"Line":2}},{"line":154,"address":[12583091,12582608,12583085],"length":1,"stats":{"Line":1}},{"line":155,"address":[12582657],"length":1,"stats":{"Line":2}},{"line":157,"address":[12582683,12582729],"length":1,"stats":{"Line":1}},{"line":159,"address":[12582988,12582834],"length":1,"stats":{"Line":5}},{"line":160,"address":[12582909],"length":1,"stats":{"Line":1}},{"line":161,"address":[12582971],"length":1,"stats":{"Line":3}},{"line":164,"address":[12582368,12582580,12582586],"length":1,"stats":{"Line":1}},{"line":165,"address":[12582495,12582413],"length":1,"stats":{"Line":2}},{"line":167,"address":[12584321,12584293,12583792],"length":1,"stats":{"Line":1}},{"line":168,"address":[12583841],"length":1,"stats":{"Line":1}},{"line":169,"address":[12583872,12583916],"length":1,"stats":{"Line":2}},{"line":170,"address":[12584191],"length":1,"stats":{"Line":3}},{"line":172,"address":[12583773,12583296,12583779],"length":1,"stats":{"Line":1}},{"line":173,"address":[12583345],"length":1,"stats":{"Line":1}},{"line":175,"address":[12583417,12583371],"length":1,"stats":{"Line":1}},{"line":177,"address":[12583676,12583522],"length":1,"stats":{"Line":2}},{"line":178,"address":[12583597],"length":1,"stats":{"Line":1}},{"line":179,"address":[12583659],"length":1,"stats":{"Line":1}}],"covered":33,"coverable":70},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","invoice.rs"],"content":"use core::cmp::{max, min};\nuse soroban_sdk::{contracttype, symbol_short, vec, Address, BytesN, Env, String, Vec};\n\nuse crate::errors::QuickLendXError;\n\nconst DEFAULT_INVOICE_GRACE_PERIOD: u64 = 14 * 24 * 60 * 60;\n\n/// Invoice status enumeration\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum InvoiceStatus {\n    Pending,   // Invoice uploaded, awaiting verification\n    Verified,  // Invoice verified and available for bidding\n    Funded,    // Invoice has been funded by an investor\n    Paid,      // Invoice has been paid and settled\n    Defaulted, // Invoice payment is overdue/defaulted\n    Cancelled, // Invoice has been cancelled by the business owner\n}\n\n/// Dispute status enumeration\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum DisputeStatus {\n    None,        // No dispute exists\n    Disputed,    // Dispute has been created\n    UnderReview, // Dispute is under review\n    Resolved,    // Dispute has been resolved\n}\n\n/// Dispute structure\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Dispute {\n    pub created_by: Address,  // Address of the party who created the dispute\n    pub created_at: u64,      // Timestamp when dispute was created\n    pub reason: String,       // Reason for the dispute\n    pub evidence: String,     // Evidence provided by the disputing party\n    pub resolution: String,   // Resolution description (empty if not resolved)\n    pub resolved_by: Address, // Address of the party who resolved the dispute (zero address if not resolved)\n    pub resolved_at: u64,     // Timestamp when dispute was resolved (0 if not resolved)\n}\n\n/// Invoice category enumeration\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum InvoiceCategory {\n    Services,      // Professional services\n    Products,      // Physical products\n    Consulting,    // Consulting services\n    Manufacturing, // Manufacturing services\n    Technology,    // Technology services/products\n    Healthcare,    // Healthcare services\n    Other,         // Other categories\n}\n\n/// Invoice rating structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvoiceRating {\n    pub rating: u32,       // 1-5 stars\n    pub feedback: String,  // Feedback text\n    pub rated_by: Address, // Investor who provided the rating\n    pub rated_at: u64,     // Timestamp of rating\n}\n\n/// Compact representation of a line item stored on-chain\n#[contracttype]\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct LineItemRecord(pub String, pub i128, pub i128, pub i128);\n\n/// Metadata associated with an invoice\n#[contracttype]\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct InvoiceMetadata {\n    pub customer_name: String,\n    pub customer_address: String,\n    pub tax_id: String,\n    pub line_items: Vec\u003cLineItemRecord\u003e,\n    pub notes: String,\n}\n\n/// Individual payment record for an invoice\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct PaymentRecord {\n    pub amount: i128,           // Amount paid in this transaction\n    pub timestamp: u64,         // When the payment was recorded\n    pub transaction_id: String, // External transaction reference\n}\n\n/// Core invoice data structure\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Invoice {\n    pub id: BytesN\u003c32\u003e,        // Unique invoice identifier\n    pub business: Address,     // Business that uploaded the invoice\n    pub amount: i128,          // Total invoice amount\n    pub currency: Address,     // Currency token address (XLM = Address::random())\n    pub due_date: u64,         // Due date timestamp\n    pub status: InvoiceStatus, // Current status of the invoice\n    pub created_at: u64,       // Creation timestamp\n    pub description: String,   // Invoice description/metadata\n    pub metadata_customer_name: Option\u003cString\u003e,\n    pub metadata_customer_address: Option\u003cString\u003e,\n    pub metadata_tax_id: Option\u003cString\u003e,\n    pub metadata_notes: Option\u003cString\u003e,\n    pub metadata_line_items: Vec\u003cLineItemRecord\u003e,\n    pub category: InvoiceCategory,           // Invoice category\n    pub tags: Vec\u003cString\u003e,                   // Invoice tags for better discoverability\n    pub funded_amount: i128,                 // Amount funded by investors\n    pub funded_at: Option\u003cu64\u003e,              // When the invoice was funded\n    pub investor: Option\u003cAddress\u003e,           // Address of the investor who funded\n    pub settled_at: Option\u003cu64\u003e,             // When the invoice was settled\n    pub average_rating: Option\u003cu32\u003e,         // Average rating (1-5)\n    pub total_ratings: u32,                  // Total number of ratings\n    pub ratings: Vec\u003cInvoiceRating\u003e,         // List of all ratings\n    pub dispute_status: DisputeStatus,       // Current dispute status\n    pub dispute: Dispute,                    // Dispute details if any\n    pub total_paid: i128,                    // Aggregate amount paid towards the invoice\n    pub payment_history: Vec\u003cPaymentRecord\u003e, // History of partial payments\n}\n\n// Use the main error enum from errors.rs\nuse crate::audit::{log_invoice_created, log_invoice_funded, log_invoice_status_change};\n\nimpl Invoice {\n    /// Create a new invoice with audit logging\n    pub fn new(\n        env: \u0026Env,\n        business: Address,\n        amount: i128,\n        currency: Address,\n        due_date: u64,\n        description: String,\n        category: InvoiceCategory,\n        tags: Vec\u003cString\u003e,\n    ) -\u003e Self {\n        let id = Self::generate_unique_invoice_id(env);\n        let created_at = env.ledger().timestamp();\n\n        let invoice = Self {\n            id,\n            business,\n            amount,\n            currency,\n            due_date,\n            status: InvoiceStatus::Pending,\n            created_at,\n            description,\n            metadata_customer_name: None,\n            metadata_customer_address: None,\n            metadata_tax_id: None,\n            metadata_notes: None,\n            metadata_line_items: Vec::new(env),\n            category,\n            tags,\n            funded_amount: 0,\n            funded_at: None,\n            investor: None,\n            settled_at: None,\n            average_rating: None,\n            total_ratings: 0,\n            ratings: vec![env],\n            dispute_status: DisputeStatus::None,\n            dispute: Dispute {\n                created_by: Address::from_str(\n                    env,\n                    \"GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF\",\n                ),\n                created_at: 0,\n                reason: String::from_str(env, \"\"),\n                evidence: String::from_str(env, \"\"),\n                resolution: String::from_str(env, \"\"),\n                resolved_by: Address::from_str(\n                    env,\n                    \"GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF\",\n                ),\n                resolved_at: 0,\n            },\n            total_paid: 0,\n            payment_history: vec![env],\n        };\n\n        // Log invoice creation\n        log_invoice_created(env, \u0026invoice);\n\n        invoice\n    }\n\n    /// Generate a unique invoice ID\n    fn generate_unique_invoice_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let sequence = env.ledger().sequence();\n        let counter_key = symbol_short!(\"inv_cnt\");\n        let counter: u32 = env.storage().instance().get(\u0026counter_key).unwrap_or(0);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        // Create a unique ID from timestamp, sequence, and counter\n        let mut id_bytes = [0u8; 32];\n        id_bytes[0..8].copy_from_slice(\u0026timestamp.to_be_bytes());\n        id_bytes[8..12].copy_from_slice(\u0026sequence.to_be_bytes());\n        id_bytes[12..16].copy_from_slice(\u0026counter.to_be_bytes());\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    /// Check if invoice is available for funding\n    pub fn is_available_for_funding(\u0026self) -\u003e bool {\n        self.status == InvoiceStatus::Verified \u0026\u0026 self.funded_amount == 0\n    }\n\n    pub const DEFAULT_GRACE_PERIOD: u64 = DEFAULT_INVOICE_GRACE_PERIOD;\n\n    /// Check if invoice is overdue\n    pub fn is_overdue(\u0026self, current_timestamp: u64) -\u003e bool {\n        current_timestamp \u003e self.due_date\n    }\n\n    /// Calculate the timestamp when the grace period ends\n    pub fn grace_deadline(\u0026self, grace_period: u64) -\u003e u64 {\n        self.due_date.saturating_add(grace_period)\n    }\n\n    /// Check if the invoice should be defaulted and handle it if necessary\n    pub fn check_and_handle_expiration(\n        \u0026self,\n        env: \u0026Env,\n        grace_period: u64,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        if self.status != InvoiceStatus::Funded {\n            return Ok(false);\n        }\n\n        let now = env.ledger().timestamp();\n        if now \u003c= self.grace_deadline(grace_period) {\n            return Ok(false);\n        }\n\n        crate::defaults::handle_default(env, \u0026self.id)?;\n        Ok(true)\n    }\n\n    /// Mark invoice as funded with audit logging\n    pub fn mark_as_funded(\n        \u0026mut self,\n        env: \u0026Env,\n        investor: Address,\n        funded_amount: i128,\n        timestamp: u64,\n    ) {\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Funded;\n        self.funded_amount = funded_amount;\n        self.funded_at = Some(timestamp);\n        self.investor = Some(investor.clone());\n\n        // Log status change and funding\n        log_invoice_status_change(\n            env,\n            self.id.clone(),\n            investor.clone(),\n            old_status,\n            self.status.clone(),\n        );\n        log_invoice_funded(env, self.id.clone(), investor, funded_amount);\n    }\n\n    /// Mark invoice as paid with audit logging\n    pub fn mark_as_paid(\u0026mut self, env: \u0026Env, actor: Address, timestamp: u64) {\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Paid;\n        self.settled_at = Some(timestamp);\n\n        // Log status change\n        log_invoice_status_change(env, self.id.clone(), actor, old_status, self.status.clone());\n    }\n\n    /// Add a payment record and update totals\n    pub fn record_payment(\n        \u0026mut self,\n        env: \u0026Env,\n        amount: i128,\n        transaction_id: String,\n    ) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        if amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let record = PaymentRecord {\n            amount,\n            timestamp: env.ledger().timestamp(),\n            transaction_id,\n        };\n        self.payment_history.push_back(record);\n        self.total_paid = self.total_paid.saturating_add(amount);\n\n        Ok(self.payment_progress())\n    }\n\n    /// Calculate the payment progress percentage (0-100)\n    pub fn payment_progress(\u0026self) -\u003e u32 {\n        if self.amount \u003c= 0 {\n            return 0;\n        }\n\n        let capped_total = max(self.total_paid, 0i128);\n        let mut percentage = (capped_total.saturating_mul(100i128)) / max(self.amount, 1i128);\n        percentage = min(percentage, 100i128);\n        percentage as u32\n    }\n\n    /// Check if the invoice has been fully paid\n    pub fn is_fully_paid(\u0026self) -\u003e bool {\n        self.total_paid \u003e= self.amount\n    }\n\n    /// Retrieve metadata if present\n    pub fn metadata(\u0026self) -\u003e Option\u003cInvoiceMetadata\u003e {\n        let name = self.metadata_customer_name.clone()?;\n        let address = self.metadata_customer_address.clone()?;\n        let tax = self.metadata_tax_id.clone()?;\n        let notes = self.metadata_notes.clone()?;\n\n        Some(InvoiceMetadata {\n            customer_name: name,\n            customer_address: address,\n            tax_id: tax,\n            line_items: self.metadata_line_items.clone(),\n            notes,\n        })\n    }\n\n    /// Update structured metadata attached to the invoice\n    pub fn set_metadata(\u0026mut self, env: \u0026Env, metadata: Option\u003cInvoiceMetadata\u003e) {\n        match metadata {\n            Some(data) =\u003e {\n                self.metadata_customer_name = Some(data.customer_name);\n                self.metadata_customer_address = Some(data.customer_address);\n                self.metadata_tax_id = Some(data.tax_id);\n                self.metadata_notes = Some(data.notes);\n                self.metadata_line_items = data.line_items;\n            }\n            None =\u003e {\n                self.metadata_customer_name = None;\n                self.metadata_customer_address = None;\n                self.metadata_tax_id = None;\n                self.metadata_notes = None;\n                self.metadata_line_items = Vec::new(env);\n            }\n        }\n    }\n\n    /// Verify the invoice with audit logging\n    pub fn verify(\u0026mut self, env: \u0026Env, actor: Address) {\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Verified;\n\n        // Log status change\n        log_invoice_status_change(env, self.id.clone(), actor, old_status, self.status.clone());\n    }\n\n    /// Mark invoice as defaulted\n    pub fn mark_as_defaulted(\u0026mut self) {\n        self.status = InvoiceStatus::Defaulted;\n    }\n\n    /// Cancel the invoice (only if Pending or Verified, not Funded)\n    pub fn cancel(\u0026mut self, env: \u0026Env, actor: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Can only cancel if Pending or Verified (not yet funded)\n        if self.status != InvoiceStatus::Pending \u0026\u0026 self.status != InvoiceStatus::Verified {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Cancelled;\n\n        // Log status change\n        log_invoice_status_change(env, self.id.clone(), actor, old_status, self.status.clone());\n\n        Ok(())\n    }\n\n    /// Add a rating to the invoice\n    pub fn add_rating(\n        \u0026mut self,\n        rating: u32,\n        feedback: String,\n        rater: Address,\n        timestamp: u64,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Validate invoice is funded\n        if self.status != InvoiceStatus::Funded \u0026\u0026 self.status != InvoiceStatus::Paid {\n            return Err(QuickLendXError::NotFunded);\n        }\n\n        // Verify rater is the investor\n        if self.investor.as_ref() != Some(\u0026rater) {\n            return Err(QuickLendXError::NotRater);\n        }\n\n        // Validate rating value\n        if rating \u003c 1 || rating \u003e 5 {\n            return Err(QuickLendXError::InvalidRating);\n        }\n\n        // Check if rater has already rated\n        for existing_rating in self.ratings.iter() {\n            if existing_rating.rated_by == rater {\n                return Err(QuickLendXError::AlreadyRated);\n            }\n        }\n\n        // Create new rating\n        let invoice_rating = InvoiceRating {\n            rating,\n            feedback,\n            rated_by: rater,\n            rated_at: timestamp,\n        };\n\n        // Add rating\n        self.ratings.push_back(invoice_rating);\n        self.total_ratings += 1;\n\n        // Calculate new average rating\n        let sum: u64 = self.ratings.iter().map(|r| r.rating as u64).sum();\n        self.average_rating = Some((sum / self.total_ratings as u64) as u32);\n\n        Ok(())\n    }\n\n    /// Get ratings above a threshold\n    pub fn get_ratings_above(\u0026self, env: \u0026Env, threshold: u32) -\u003e Vec\u003cInvoiceRating\u003e {\n        let mut filtered = vec![env];\n        for rating in self.ratings.iter() {\n            if rating.rating \u003e= threshold {\n                filtered.push_back(rating);\n            }\n        }\n        filtered\n    }\n\n    /// Get all ratings for the invoice\n    pub fn get_all_ratings(\u0026self) -\u003e \u0026Vec\u003cInvoiceRating\u003e {\n        \u0026self.ratings\n    }\n\n    /// Check if invoice has ratings\n    pub fn has_ratings(\u0026self) -\u003e bool {\n        self.total_ratings \u003e 0\n    }\n\n    /// Get the highest rating received\n    pub fn get_highest_rating(\u0026self) -\u003e Option\u003cu32\u003e {\n        if self.ratings.is_empty() {\n            None\n        } else {\n            Some(self.ratings.iter().map(|r| r.rating).max().unwrap())\n        }\n    }\n\n    /// Get the lowest rating received\n    pub fn get_lowest_rating(\u0026self) -\u003e Option\u003cu32\u003e {\n        if self.ratings.is_empty() {\n            None\n        } else {\n            Some(self.ratings.iter().map(|r| r.rating).min().unwrap())\n        }\n    }\n\n    /// Add a tag to the invoice\n    pub fn add_tag(\n        \u0026mut self,\n        _env: \u0026Env,\n        tag: String,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        // Validate tag length (1-50 characters)\n        if tag.len() \u003c 1 || tag.len() \u003e 50 {\n            return Err(crate::errors::QuickLendXError::InvalidTag);\n        }\n\n        // Check tag limit (max 10 tags per invoice)\n        if self.tags.len() \u003e= 10 {\n            return Err(crate::errors::QuickLendXError::TagLimitExceeded);\n        }\n\n        // Check if tag already exists\n        for existing_tag in self.tags.iter() {\n            if existing_tag == tag {\n                return Ok(()); // Tag already exists, no need to add\n            }\n        }\n\n        self.tags.push_back(tag);\n        Ok(())\n    }\n\n    /// Remove a tag from the invoice\n    pub fn remove_tag(\u0026mut self, tag: String) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let mut new_tags = Vec::new(\u0026self.tags.env());\n        let mut found = false;\n\n        for existing_tag in self.tags.iter() {\n            if existing_tag != tag {\n                new_tags.push_back(existing_tag.clone());\n            } else {\n                found = true;\n            }\n        }\n\n        if !found {\n            return Err(crate::errors::QuickLendXError::InvalidTag);\n        }\n\n        self.tags = new_tags;\n        Ok(())\n    }\n\n    /// Check if invoice has a specific tag\n    pub fn has_tag(\u0026self, tag: String) -\u003e bool {\n        for existing_tag in self.tags.iter() {\n            if existing_tag == tag {\n                return true;\n            }\n        }\n        false\n    }\n\n    /// Update the invoice category\n    pub fn update_category(\u0026mut self, category: InvoiceCategory) {\n        self.category = category;\n    }\n\n    /// Get all tags as a vector\n    pub fn get_tags(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.tags.clone()\n    }\n}\n\n/// Storage keys for invoice data\npub struct InvoiceStorage;\n\nimpl InvoiceStorage {\n    /// Store an invoice\n    pub fn store_invoice(env: \u0026Env, invoice: \u0026Invoice) {\n        env.storage().instance().set(\u0026invoice.id, invoice);\n\n        // Add to business invoices list\n        Self::add_to_business_invoices(env, \u0026invoice.business, \u0026invoice.id);\n\n        // Add to status invoices list\n        Self::add_to_status_invoices(env, \u0026invoice.status, \u0026invoice.id);\n    }\n\n    /// Get an invoice by ID\n    pub fn get_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvoice\u003e {\n        env.storage().instance().get(invoice_id)\n    }\n\n    /// Update an invoice\n    pub fn update_invoice(env: \u0026Env, invoice: \u0026Invoice) {\n        env.storage().instance().set(\u0026invoice.id, invoice);\n    }\n\n    /// Get all invoices for a business\n    pub fn get_business_invoices(env: \u0026Env, business: \u0026Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"business\"), business.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get all invoices by status\n    pub fn get_invoices_by_status(env: \u0026Env, status: \u0026InvoiceStatus) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = match status {\n            InvoiceStatus::Pending =\u003e symbol_short!(\"pending\"),\n            InvoiceStatus::Verified =\u003e symbol_short!(\"verified\"),\n            InvoiceStatus::Funded =\u003e symbol_short!(\"funded\"),\n            InvoiceStatus::Paid =\u003e symbol_short!(\"paid\"),\n            InvoiceStatus::Defaulted =\u003e symbol_short!(\"default\"),\n            InvoiceStatus::Cancelled =\u003e symbol_short!(\"canceld\"),\n        };\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Add invoice to business invoices list\n    fn add_to_business_invoices(env: \u0026Env, business: \u0026Address, invoice_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"business\"), business.clone());\n        let mut invoices = Self::get_business_invoices(env, business);\n        invoices.push_back(invoice_id.clone());\n        env.storage().instance().set(\u0026key, \u0026invoices);\n    }\n\n    /// Add invoice to status invoices list\n    pub fn add_to_status_invoices(env: \u0026Env, status: \u0026InvoiceStatus, invoice_id: \u0026BytesN\u003c32\u003e) {\n        let key = match status {\n            InvoiceStatus::Pending =\u003e symbol_short!(\"pending\"),\n            InvoiceStatus::Verified =\u003e symbol_short!(\"verified\"),\n            InvoiceStatus::Funded =\u003e symbol_short!(\"funded\"),\n            InvoiceStatus::Paid =\u003e symbol_short!(\"paid\"),\n            InvoiceStatus::Defaulted =\u003e symbol_short!(\"default\"),\n            InvoiceStatus::Cancelled =\u003e symbol_short!(\"canceld\"),\n        };\n        let mut invoices = env\n            .storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env));\n        invoices.push_back(invoice_id.clone());\n        env.storage().instance().set(\u0026key, \u0026invoices);\n    }\n\n    /// Remove invoice from status invoices list\n    pub fn remove_from_status_invoices(env: \u0026Env, status: \u0026InvoiceStatus, invoice_id: \u0026BytesN\u003c32\u003e) {\n        let key = match status {\n            InvoiceStatus::Pending =\u003e symbol_short!(\"pending\"),\n            InvoiceStatus::Verified =\u003e symbol_short!(\"verified\"),\n            InvoiceStatus::Funded =\u003e symbol_short!(\"funded\"),\n            InvoiceStatus::Paid =\u003e symbol_short!(\"paid\"),\n            InvoiceStatus::Defaulted =\u003e symbol_short!(\"default\"),\n            InvoiceStatus::Cancelled =\u003e symbol_short!(\"canceld\"),\n        };\n        let invoices = Self::get_invoices_by_status(env, status);\n\n        // Find and remove the invoice ID\n        let mut new_invoices = Vec::new(env);\n        for id in invoices.iter() {\n            if id != *invoice_id {\n                new_invoices.push_back(id);\n            }\n        }\n\n        env.storage().instance().set(\u0026key, \u0026new_invoices);\n    }\n\n    /// Get invoices with ratings above a threshold\n    pub fn get_invoices_with_rating_above(env: \u0026Env, threshold: u32) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut high_rated_invoices = vec![env];\n        // Get all invoices and filter by rating\n        let all_statuses = [InvoiceStatus::Funded, InvoiceStatus::Paid];\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if let Some(avg_rating) = invoice.average_rating {\n                        if avg_rating \u003e= threshold {\n                            high_rated_invoices.push_back(invoice_id);\n                        }\n                    }\n                }\n            }\n        }\n        high_rated_invoices\n    }\n\n    /// Get invoices for a business with ratings above a threshold\n    pub fn get_business_invoices_with_rating_above(\n        env: \u0026Env,\n        business: \u0026Address,\n        threshold: u32,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut high_rated_invoices = vec![env];\n        let business_invoices = Self::get_business_invoices(env, business);\n        for invoice_id in business_invoices.iter() {\n            if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                if let Some(avg_rating) = invoice.average_rating {\n                    if avg_rating \u003e= threshold {\n                        high_rated_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        high_rated_invoices\n    }\n\n    /// Get count of invoices with ratings\n    pub fn get_invoices_with_ratings_count(env: \u0026Env) -\u003e u32 {\n        let mut count = 0;\n        let all_statuses = [InvoiceStatus::Funded, InvoiceStatus::Paid];\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if invoice.has_ratings() {\n                        count += 1;\n                    }\n                }\n            }\n        }\n        count\n    }\n\n    /// Get invoices by category\n    pub fn get_invoices_by_category(env: \u0026Env, category: \u0026InvoiceCategory) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut category_invoices = vec![env];\n        let all_statuses = [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ];\n\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if invoice.category == *category {\n                        category_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        category_invoices\n    }\n\n    /// Get invoices by category and status\n    pub fn get_invoices_by_category_and_status(\n        env: \u0026Env,\n        category: \u0026InvoiceCategory,\n        status: \u0026InvoiceStatus,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut filtered_invoices = vec![env];\n        let invoices = Self::get_invoices_by_status(env, status);\n\n        for invoice_id in invoices.iter() {\n            if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                if invoice.category == *category {\n                    filtered_invoices.push_back(invoice_id);\n                }\n            }\n        }\n        filtered_invoices\n    }\n\n    /// Get invoices by tag\n    pub fn get_invoices_by_tag(env: \u0026Env, tag: \u0026String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut tagged_invoices = vec![env];\n        let all_statuses = [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ];\n\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if invoice.has_tag(tag.clone()) {\n                        tagged_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        tagged_invoices\n    }\n\n    /// Get invoices by multiple tags (AND logic - must have all tags)\n    pub fn get_invoices_by_tags(env: \u0026Env, tags: \u0026Vec\u003cString\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut tagged_invoices = vec![env];\n        let all_statuses = [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ];\n\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    let mut has_all_tags = true;\n                    for tag in tags.iter() {\n                        if !invoice.has_tag(tag.clone()) {\n                            has_all_tags = false;\n                            break;\n                        }\n                    }\n                    if has_all_tags {\n                        tagged_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        tagged_invoices\n    }\n\n    /// Get invoice count by category\n    pub fn get_invoice_count_by_category(env: \u0026Env, category: \u0026InvoiceCategory) -\u003e u32 {\n        Self::get_invoices_by_category(env, category).len() as u32\n    }\n\n    /// Get invoice count by tag\n    pub fn get_invoice_count_by_tag(env: \u0026Env, tag: \u0026String) -\u003e u32 {\n        Self::get_invoices_by_tag(env, tag).len() as u32\n    }\n\n    /// Get all available categories\n    pub fn get_all_categories(env: \u0026Env) -\u003e Vec\u003cInvoiceCategory\u003e {\n        vec![\n            env,\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ]\n    }\n\n    fn metadata_customer_key(customer: \u0026String) -\u003e (soroban_sdk::Symbol, String) {\n        (symbol_short!(\"meta_c\"), customer.clone())\n    }\n\n    fn metadata_tax_key(tax_id: \u0026String) -\u003e (soroban_sdk::Symbol, String) {\n        (symbol_short!(\"meta_t\"), tax_id.clone())\n    }\n\n    fn add_to_metadata_index(\n        env: \u0026Env,\n        key: \u0026(soroban_sdk::Symbol, String),\n        invoice_id: \u0026BytesN\u003c32\u003e,\n    ) {\n        let mut invoices = env\n            .storage()\n            .instance()\n            .get(key)\n            .unwrap_or_else(|| Vec::new(env));\n        for existing in invoices.iter() {\n            if existing == *invoice_id {\n                return;\n            }\n        }\n        invoices.push_back(invoice_id.clone());\n        env.storage().instance().set(key, \u0026invoices);\n    }\n\n    fn remove_from_metadata_index(\n        env: \u0026Env,\n        key: \u0026(soroban_sdk::Symbol, String),\n        invoice_id: \u0026BytesN\u003c32\u003e,\n    ) {\n        let existing: Option\u003cVec\u003cBytesN\u003c32\u003e\u003e\u003e = env.storage().instance().get(key);\n        if let Some(invoices) = existing {\n            let mut filtered = Vec::new(env);\n            for id in invoices.iter() {\n                if id != *invoice_id {\n                    filtered.push_back(id);\n                }\n            }\n            env.storage().instance().set(key, \u0026filtered);\n        }\n    }\n\n    pub fn add_metadata_indexes(env: \u0026Env, invoice: \u0026Invoice) {\n        if let Some(name) = \u0026invoice.metadata_customer_name {\n            if name.len() \u003e 0 {\n                let key = Self::metadata_customer_key(name);\n                Self::add_to_metadata_index(env, \u0026key, \u0026invoice.id);\n            }\n        }\n\n        if let Some(tax) = \u0026invoice.metadata_tax_id {\n            if tax.len() \u003e 0 {\n                let key = Self::metadata_tax_key(tax);\n                Self::add_to_metadata_index(env, \u0026key, \u0026invoice.id);\n            }\n        }\n    }\n\n    pub fn remove_metadata_indexes(env: \u0026Env, metadata: \u0026InvoiceMetadata, invoice_id: \u0026BytesN\u003c32\u003e) {\n        if metadata.customer_name.len() \u003e 0 {\n            let key = Self::metadata_customer_key(\u0026metadata.customer_name);\n            Self::remove_from_metadata_index(env, \u0026key, invoice_id);\n        }\n\n        if metadata.tax_id.len() \u003e 0 {\n            let key = Self::metadata_tax_key(\u0026metadata.tax_id);\n            Self::remove_from_metadata_index(env, \u0026key, invoice_id);\n        }\n    }\n\n    pub fn get_invoices_by_customer(env: \u0026Env, customer_name: \u0026String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::metadata_customer_key(customer_name))\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    pub fn get_invoices_by_tax_id(env: \u0026Env, tax_id: \u0026String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::metadata_tax_key(tax_id))\n            .unwrap_or_else(|| Vec::new(env))\n    }\n}\n","traces":[{"line":128,"address":[16242144,16244855,16244573],"length":1,"stats":{"Line":1}},{"line":138,"address":[16242260,16242390],"length":1,"stats":{"Line":2}},{"line":139,"address":[16242406,16242451],"length":1,"stats":{"Line":2}},{"line":154,"address":[16242787],"length":1,"stats":{"Line":1}},{"line":163,"address":[16242907],"length":1,"stats":{"Line":1}},{"line":165,"address":[16243323],"length":1,"stats":{"Line":1}},{"line":181,"address":[16243595],"length":1,"stats":{"Line":1}},{"line":185,"address":[16244482],"length":1,"stats":{"Line":1}},{"line":187,"address":[16244534],"length":1,"stats":{"Line":1}},{"line":191,"address":[16241757,16241763,16240336],"length":1,"stats":{"Line":1}},{"line":192,"address":[16240391],"length":1,"stats":{"Line":1}},{"line":193,"address":[16240524],"length":1,"stats":{"Line":1}},{"line":194,"address":[16240638],"length":1,"stats":{"Line":1}},{"line":195,"address":[16240691,16240742],"length":1,"stats":{"Line":2}},{"line":196,"address":[16240984],"length":1,"stats":{"Line":1}},{"line":199,"address":[16241223],"length":1,"stats":{"Line":1}},{"line":200,"address":[16241242],"length":1,"stats":{"Line":1}},{"line":201,"address":[16241397],"length":1,"stats":{"Line":1}},{"line":202,"address":[16241547],"length":1,"stats":{"Line":1}},{"line":204,"address":[16241708],"length":1,"stats":{"Line":1}},{"line":208,"address":[16240240],"length":1,"stats":{"Line":0}},{"line":209,"address":[16240253],"length":1,"stats":{"Line":0}},{"line":215,"address":[16233792],"length":1,"stats":{"Line":0}},{"line":216,"address":[16233802],"length":1,"stats":{"Line":0}},{"line":220,"address":[16237296],"length":1,"stats":{"Line":0}},{"line":221,"address":[16237310],"length":1,"stats":{"Line":0}},{"line":225,"address":[16242123,16241776,16242129],"length":1,"stats":{"Line":0}},{"line":230,"address":[16241813],"length":1,"stats":{"Line":0}},{"line":231,"address":[16241875],"length":1,"stats":{"Line":0}},{"line":234,"address":[16241850,16241890],"length":1,"stats":{"Line":0}},{"line":235,"address":[16241965],"length":1,"stats":{"Line":0}},{"line":236,"address":[16242042],"length":1,"stats":{"Line":0}},{"line":239,"address":[16242054,16241993],"length":1,"stats":{"Line":0}},{"line":240,"address":[16242100],"length":1,"stats":{"Line":0}},{"line":244,"address":[16237328,16238112,16238140],"length":1,"stats":{"Line":3}},{"line":251,"address":[16237405,16237526],"length":1,"stats":{"Line":6}},{"line":252,"address":[16237534],"length":1,"stats":{"Line":3}},{"line":253,"address":[16237541],"length":1,"stats":{"Line":3}},{"line":254,"address":[16237555],"length":1,"stats":{"Line":3}},{"line":255,"address":[16237571],"length":1,"stats":{"Line":3}},{"line":260,"address":[16237732],"length":1,"stats":{"Line":3}},{"line":261,"address":[16237829,16237776],"length":1,"stats":{"Line":6}},{"line":263,"address":[16237837],"length":1,"stats":{"Line":3}},{"line":265,"address":[16237973],"length":1,"stats":{"Line":3}},{"line":269,"address":[16234704,16235129,16235154],"length":1,"stats":{"Line":1}},{"line":270,"address":[16234860,16234755],"length":1,"stats":{"Line":2}},{"line":271,"address":[16234867],"length":1,"stats":{"Line":1}},{"line":272,"address":[16234874],"length":1,"stats":{"Line":1}},{"line":275,"address":[16234886,16235135,16235098],"length":1,"stats":{"Line":1}},{"line":279,"address":[16238869,16238176],"length":1,"stats":{"Line":2}},{"line":285,"address":[16238240],"length":1,"stats":{"Line":2}},{"line":286,"address":[16238301],"length":1,"stats":{"Line":0}},{"line":291,"address":[16238289,16238369],"length":1,"stats":{"Line":4}},{"line":294,"address":[16238627],"length":1,"stats":{"Line":2}},{"line":295,"address":[16238743],"length":1,"stats":{"Line":2}},{"line":297,"address":[16238803],"length":1,"stats":{"Line":2}},{"line":301,"address":[16238960],"length":1,"stats":{"Line":2}},{"line":302,"address":[16238974],"length":1,"stats":{"Line":2}},{"line":303,"address":[16239151],"length":1,"stats":{"Line":0}},{"line":306,"address":[16239009],"length":1,"stats":{"Line":2}},{"line":307,"address":[16239064,16239184,16239317],"length":1,"stats":{"Line":3}},{"line":308,"address":[16239273],"length":1,"stats":{"Line":1}},{"line":309,"address":[16239307],"length":1,"stats":{"Line":1}},{"line":313,"address":[16237248],"length":1,"stats":{"Line":2}},{"line":314,"address":[16237253],"length":1,"stats":{"Line":2}},{"line":318,"address":[16247216,16248798,16248604],"length":1,"stats":{"Line":0}},{"line":319,"address":[16247246],"length":1,"stats":{"Line":0}},{"line":320,"address":[16247517,16248783,16247438],"length":1,"stats":{"Line":0}},{"line":321,"address":[16247754,16247675,16248738],"length":1,"stats":{"Line":0}},{"line":322,"address":[16247991,16247912],"length":1,"stats":{"Line":0}},{"line":324,"address":[16248392],"length":1,"stats":{"Line":0}},{"line":325,"address":[16248141],"length":1,"stats":{"Line":0}},{"line":326,"address":[16248188],"length":1,"stats":{"Line":0}},{"line":327,"address":[16248244],"length":1,"stats":{"Line":0}},{"line":328,"address":[16248300],"length":1,"stats":{"Line":0}},{"line":329,"address":[16248366],"length":1,"stats":{"Line":0}},{"line":334,"address":[16235184,16237146,16236119],"length":1,"stats":{"Line":0}},{"line":335,"address":[16235222],"length":1,"stats":{"Line":0}},{"line":336,"address":[16235289],"length":1,"stats":{"Line":0}},{"line":337,"address":[16235345,16236137],"length":1,"stats":{"Line":0}},{"line":338,"address":[16236239],"length":1,"stats":{"Line":0}},{"line":339,"address":[16236459],"length":1,"stats":{"Line":0}},{"line":340,"address":[16236688],"length":1,"stats":{"Line":0}},{"line":341,"address":[16236917],"length":1,"stats":{"Line":0}},{"line":344,"address":[16235458],"length":1,"stats":{"Line":0}},{"line":345,"address":[16235591],"length":1,"stats":{"Line":0}},{"line":346,"address":[16235724],"length":1,"stats":{"Line":0}},{"line":347,"address":[16235857],"length":1,"stats":{"Line":0}},{"line":348,"address":[16236003],"length":1,"stats":{"Line":0}},{"line":354,"address":[16245892,16245472,16245867],"length":1,"stats":{"Line":1}},{"line":355,"address":[16245610,16245510],"length":1,"stats":{"Line":3}},{"line":356,"address":[16245617],"length":1,"stats":{"Line":2}},{"line":359,"address":[16245836,16245624,16245873],"length":1,"stats":{"Line":1}},{"line":363,"address":[16240080],"length":1,"stats":{"Line":0}},{"line":364,"address":[16240085],"length":1,"stats":{"Line":0}},{"line":368,"address":[16245436,16244896,16245411],"length":1,"stats":{"Line":0}},{"line":370,"address":[16244934,16245070,16245036],"length":1,"stats":{"Line":0}},{"line":371,"address":[16245110],"length":1,"stats":{"Line":0}},{"line":374,"address":[16245047,16245138],"length":1,"stats":{"Line":0}},{"line":375,"address":[16245145],"length":1,"stats":{"Line":0}},{"line":378,"address":[16245417,16245152,16245380],"length":1,"stats":{"Line":0}},{"line":380,"address":[16245360],"length":1,"stats":{"Line":0}},{"line":384,"address":[16233752,16232304,16233680],"length":1,"stats":{"Line":0}},{"line":392,"address":[16232495,16232460,16232358],"length":1,"stats":{"Line":0}},{"line":393,"address":[16232530],"length":1,"stats":{"Line":0}},{"line":397,"address":[16232553,16232471],"length":1,"stats":{"Line":0}},{"line":398,"address":[16232605],"length":1,"stats":{"Line":0}},{"line":402,"address":[16232598,16232622],"length":1,"stats":{"Line":0}},{"line":403,"address":[16232627],"length":1,"stats":{"Line":0}},{"line":407,"address":[16232773,16232645],"length":1,"stats":{"Line":0}},{"line":408,"address":[16232921,16233602],"length":1,"stats":{"Line":0}},{"line":409,"address":[16233626],"length":1,"stats":{"Line":0}},{"line":422,"address":[16233183],"length":1,"stats":{"Line":0}},{"line":423,"address":[16233322,16233378],"length":1,"stats":{"Line":0}},{"line":426,"address":[16233356,16233414],"length":1,"stats":{"Line":0}},{"line":427,"address":[16233459,16233525],"length":1,"stats":{"Line":0}},{"line":429,"address":[16233515],"length":1,"stats":{"Line":0}},{"line":433,"address":[16240051,16239488,16240057],"length":1,"stats":{"Line":0}},{"line":434,"address":[16239550],"length":1,"stats":{"Line":0}},{"line":435,"address":[16239573,16239645,16239735,16240031],"length":1,"stats":{"Line":0}},{"line":436,"address":[16239800],"length":1,"stats":{"Line":0}},{"line":437,"address":[16239878],"length":1,"stats":{"Line":0}},{"line":440,"address":[16239831],"length":1,"stats":{"Line":0}},{"line":444,"address":[16238912],"length":1,"stats":{"Line":0}},{"line":445,"address":[16238920],"length":1,"stats":{"Line":0}},{"line":449,"address":[16234672],"length":1,"stats":{"Line":0}},{"line":450,"address":[16234677],"length":1,"stats":{"Line":0}},{"line":454,"address":[16240096],"length":1,"stats":{"Line":0}},{"line":455,"address":[16240115,16240206],"length":1,"stats":{"Line":0}},{"line":456,"address":[16240208],"length":1,"stats":{"Line":0}},{"line":458,"address":[13094644,13094624],"length":1,"stats":{"Line":0}},{"line":463,"address":[16239344],"length":1,"stats":{"Line":0}},{"line":464,"address":[16239363,16239454],"length":1,"stats":{"Line":0}},{"line":465,"address":[16239456],"length":1,"stats":{"Line":0}},{"line":467,"address":[13094596,13094576],"length":1,"stats":{"Line":0}},{"line":472,"address":[16245936,16246623],"length":1,"stats":{"Line":0}},{"line":478,"address":[16245982,16246054,16246092],"length":1,"stats":{"Line":0}},{"line":479,"address":[16246075],"length":1,"stats":{"Line":0}},{"line":483,"address":[16246102],"length":1,"stats":{"Line":0}},{"line":484,"address":[16246153],"length":1,"stats":{"Line":0}},{"line":488,"address":[16246134,16246176,16246269],"length":1,"stats":{"Line":0}},{"line":489,"address":[16246537,16246349],"length":1,"stats":{"Line":0}},{"line":490,"address":[16246565],"length":1,"stats":{"Line":0}},{"line":494,"address":[16246400],"length":1,"stats":{"Line":0}},{"line":495,"address":[16246469],"length":1,"stats":{"Line":0}},{"line":499,"address":[16234659,16233824,16234634],"length":1,"stats":{"Line":0}},{"line":500,"address":[16233849,16233926],"length":1,"stats":{"Line":0}},{"line":501,"address":[16233965],"length":1,"stats":{"Line":0}},{"line":503,"address":[16234043,16234133,16233970],"length":1,"stats":{"Line":0}},{"line":504,"address":[16234550,16234561,16234213],"length":1,"stats":{"Line":0}},{"line":505,"address":[16234608,16234579],"length":1,"stats":{"Line":0}},{"line":507,"address":[16234556],"length":1,"stats":{"Line":0}},{"line":511,"address":[16234254],"length":1,"stats":{"Line":0}},{"line":512,"address":[16234261],"length":1,"stats":{"Line":0}},{"line":515,"address":[16234391,16234290],"length":1,"stats":{"Line":0}},{"line":516,"address":[16234478],"length":1,"stats":{"Line":0}},{"line":520,"address":[16247137,16246672],"length":1,"stats":{"Line":0}},{"line":521,"address":[16246858,16246768,16246698],"length":1,"stats":{"Line":0}},{"line":522,"address":[16247054,16246938],"length":1,"stats":{"Line":0}},{"line":523,"address":[16247082],"length":1,"stats":{"Line":0}},{"line":526,"address":[16246981],"length":1,"stats":{"Line":0}},{"line":530,"address":[16238928],"length":1,"stats":{"Line":0}},{"line":531,"address":[16238940],"length":1,"stats":{"Line":0}},{"line":535,"address":[16247168],"length":1,"stats":{"Line":0}},{"line":536,"address":[16247185],"length":1,"stats":{"Line":0}},{"line":545,"address":[16205712,16205971,16205965],"length":1,"stats":{"Line":1}},{"line":546,"address":[16205754],"length":1,"stats":{"Line":2}},{"line":549,"address":[16205913],"length":1,"stats":{"Line":1}},{"line":552,"address":[16205938],"length":1,"stats":{"Line":2}},{"line":556,"address":[16205684,16205690,16205472],"length":1,"stats":{"Line":2}},{"line":557,"address":[16205517,16205599],"length":1,"stats":{"Line":3}},{"line":561,"address":[16206177,16205984,16206183],"length":1,"stats":{"Line":2}},{"line":562,"address":[16206022],"length":1,"stats":{"Line":1}},{"line":566,"address":[16211040,16211034,16210448],"length":1,"stats":{"Line":3}},{"line":567,"address":[16210497],"length":1,"stats":{"Line":3}},{"line":568,"address":[16210692],"length":1,"stats":{"Line":3}},{"line":570,"address":[16210821],"length":1,"stats":{"Line":3}},{"line":571,"address":[13050912,13050929],"length":1,"stats":{"Line":9}},{"line":575,"address":[16212096,16212672,16212678],"length":1,"stats":{"Line":2}},{"line":576,"address":[16212134],"length":1,"stats":{"Line":1}},{"line":577,"address":[16212165],"length":1,"stats":{"Line":2}},{"line":578,"address":[16212189],"length":1,"stats":{"Line":0}},{"line":579,"address":[16212213],"length":1,"stats":{"Line":1}},{"line":580,"address":[16212237],"length":1,"stats":{"Line":0}},{"line":581,"address":[16212261],"length":1,"stats":{"Line":0}},{"line":582,"address":[16212285],"length":1,"stats":{"Line":0}},{"line":584,"address":[16212320],"length":1,"stats":{"Line":1}},{"line":586,"address":[16212454],"length":1,"stats":{"Line":2}},{"line":587,"address":[16212509],"length":1,"stats":{"Line":3}},{"line":591,"address":[16213999,16213376,16213993],"length":1,"stats":{"Line":2}},{"line":592,"address":[16213422],"length":1,"stats":{"Line":1}},{"line":593,"address":[16213622],"length":1,"stats":{"Line":2}},{"line":594,"address":[16213731,16213671],"length":1,"stats":{"Line":4}},{"line":595,"address":[16213771],"length":1,"stats":{"Line":1}},{"line":599,"address":[16212080,16212074,16211232],"length":1,"stats":{"Line":3}},{"line":600,"address":[16211273],"length":1,"stats":{"Line":3}},{"line":601,"address":[16211304],"length":1,"stats":{"Line":3}},{"line":602,"address":[16211328],"length":1,"stats":{"Line":1}},{"line":603,"address":[16211352],"length":1,"stats":{"Line":0}},{"line":604,"address":[16211376],"length":1,"stats":{"Line":1}},{"line":605,"address":[16211400],"length":1,"stats":{"Line":0}},{"line":606,"address":[16211424],"length":1,"stats":{"Line":0}},{"line":611,"address":[16211596],"length":1,"stats":{"Line":3}},{"line":612,"address":[16211534,16211603],"length":1,"stats":{"Line":6}},{"line":613,"address":[16211801],"length":1,"stats":{"Line":3}},{"line":614,"address":[16211857],"length":1,"stats":{"Line":3}},{"line":618,"address":[16217763,16216864,16217971],"length":1,"stats":{"Line":2}},{"line":619,"address":[16216910],"length":1,"stats":{"Line":1}},{"line":620,"address":[16216949],"length":1,"stats":{"Line":2}},{"line":621,"address":[16216973],"length":1,"stats":{"Line":0}},{"line":622,"address":[16216997],"length":1,"stats":{"Line":2}},{"line":623,"address":[16217021],"length":1,"stats":{"Line":0}},{"line":624,"address":[16217045],"length":1,"stats":{"Line":0}},{"line":625,"address":[16217069],"length":1,"stats":{"Line":0}},{"line":627,"address":[16217106],"length":1,"stats":{"Line":1}},{"line":630,"address":[16217159],"length":1,"stats":{"Line":2}},{"line":631,"address":[16217386,16217229,16217293,16217925],"length":1,"stats":{"Line":6}},{"line":632,"address":[16217482,16217814],"length":1,"stats":{"Line":3}},{"line":633,"address":[16217832],"length":1,"stats":{"Line":0}},{"line":637,"address":[16217524],"length":1,"stats":{"Line":1}},{"line":641,"address":[16219117,16219057,16218112],"length":1,"stats":{"Line":0}},{"line":642,"address":[16218153],"length":1,"stats":{"Line":0}},{"line":644,"address":[16218175],"length":1,"stats":{"Line":0}},{"line":645,"address":[16218263,16218195],"length":1,"stats":{"Line":0}},{"line":646,"address":[16218397],"length":1,"stats":{"Line":0}},{"line":647,"address":[16218520,16219071,16218453,16218616],"length":1,"stats":{"Line":0}},{"line":648,"address":[16218805,16218720],"length":1,"stats":{"Line":0}},{"line":649,"address":[16218899,16218859],"length":1,"stats":{"Line":0}},{"line":650,"address":[16218913],"length":1,"stats":{"Line":0}},{"line":651,"address":[16218932,16219052],"length":1,"stats":{"Line":0}},{"line":657,"address":[16218409],"length":1,"stats":{"Line":0}},{"line":661,"address":[16221604,16221664,16220784],"length":1,"stats":{"Line":0}},{"line":666,"address":[16220838],"length":1,"stats":{"Line":0}},{"line":667,"address":[16220891],"length":1,"stats":{"Line":0}},{"line":668,"address":[16221618,16220952,16221106,16221013],"length":1,"stats":{"Line":0}},{"line":669,"address":[16221352,16221210],"length":1,"stats":{"Line":0}},{"line":670,"address":[16221406,16221446],"length":1,"stats":{"Line":0}},{"line":671,"address":[16221460],"length":1,"stats":{"Line":0}},{"line":672,"address":[16221479,16221599],"length":1,"stats":{"Line":0}},{"line":677,"address":[16221240],"length":1,"stats":{"Line":0}},{"line":681,"address":[16219136,16219859,16219853],"length":1,"stats":{"Line":0}},{"line":682,"address":[16219156],"length":1,"stats":{"Line":0}},{"line":683,"address":[16219164],"length":1,"stats":{"Line":0}},{"line":684,"address":[16219174,16219210],"length":1,"stats":{"Line":0}},{"line":685,"address":[16219281],"length":1,"stats":{"Line":0}},{"line":686,"address":[16219372,16219299,16219462],"length":1,"stats":{"Line":0}},{"line":687,"address":[16219640,16219558],"length":1,"stats":{"Line":0}},{"line":688,"address":[16219708,16219785,16219831],"length":1,"stats":{"Line":0}},{"line":689,"address":[16219806,16219833],"length":1,"stats":{"Line":0}},{"line":694,"address":[16219306],"length":1,"stats":{"Line":0}},{"line":698,"address":[16214144,16215130,16215190],"length":1,"stats":{"Line":0}},{"line":699,"address":[16214187],"length":1,"stats":{"Line":0}},{"line":700,"address":[16214209],"length":1,"stats":{"Line":0}},{"line":709,"address":[16214270,16214338],"length":1,"stats":{"Line":0}},{"line":710,"address":[16214474],"length":1,"stats":{"Line":0}},{"line":711,"address":[16214597,16214693,16215144,16214530],"length":1,"stats":{"Line":0}},{"line":712,"address":[16214797,16214882],"length":1,"stats":{"Line":0}},{"line":713,"address":[16214945,16215027],"length":1,"stats":{"Line":0}},{"line":714,"address":[16215048],"length":1,"stats":{"Line":0}},{"line":719,"address":[16214486],"length":1,"stats":{"Line":0}},{"line":723,"address":[16219872,16220750,16220690],"length":1,"stats":{"Line":0}},{"line":728,"address":[16219928],"length":1,"stats":{"Line":0}},{"line":729,"address":[16219981],"length":1,"stats":{"Line":0}},{"line":731,"address":[16220704,16220042,16220196,16220103],"length":1,"stats":{"Line":0}},{"line":732,"address":[16220442,16220300],"length":1,"stats":{"Line":0}},{"line":733,"address":[16220587,16220505],"length":1,"stats":{"Line":0}},{"line":734,"address":[16220608],"length":1,"stats":{"Line":0}},{"line":738,"address":[16220330],"length":1,"stats":{"Line":0}},{"line":742,"address":[16207521,16207581,16206512],"length":1,"stats":{"Line":0}},{"line":743,"address":[16206555],"length":1,"stats":{"Line":0}},{"line":744,"address":[16206577],"length":1,"stats":{"Line":0}},{"line":753,"address":[16206706,16206638],"length":1,"stats":{"Line":0}},{"line":754,"address":[16206842],"length":1,"stats":{"Line":0}},{"line":755,"address":[16206898,16207061,16207535,16206965],"length":1,"stats":{"Line":0}},{"line":756,"address":[16207250,16207165],"length":1,"stats":{"Line":0}},{"line":757,"address":[16207321,16207403],"length":1,"stats":{"Line":0}},{"line":758,"address":[16207439],"length":1,"stats":{"Line":0}},{"line":763,"address":[16206854],"length":1,"stats":{"Line":0}},{"line":767,"address":[16209408,16208000,16209348],"length":1,"stats":{"Line":0}},{"line":768,"address":[16208043],"length":1,"stats":{"Line":0}},{"line":769,"address":[16208065],"length":1,"stats":{"Line":0}},{"line":778,"address":[16208126,16208194],"length":1,"stats":{"Line":0}},{"line":779,"address":[16208330],"length":1,"stats":{"Line":0}},{"line":780,"address":[16208549,16209362,16208453,16208386],"length":1,"stats":{"Line":0}},{"line":781,"address":[16208738,16208653],"length":1,"stats":{"Line":0}},{"line":782,"address":[16208801],"length":1,"stats":{"Line":0}},{"line":783,"address":[16208899,16208817,16208992],"length":1,"stats":{"Line":0}},{"line":784,"address":[16209083,16209168],"length":1,"stats":{"Line":0}},{"line":785,"address":[16209189],"length":1,"stats":{"Line":0}},{"line":789,"address":[16209238],"length":1,"stats":{"Line":0}},{"line":790,"address":[16209266],"length":1,"stats":{"Line":0}},{"line":795,"address":[16208342],"length":1,"stats":{"Line":0}},{"line":799,"address":[16217984,16218093,16218087],"length":1,"stats":{"Line":0}},{"line":800,"address":[16218014],"length":1,"stats":{"Line":0}},{"line":804,"address":[16214125,16214016,16214119],"length":1,"stats":{"Line":0}},{"line":805,"address":[16214046],"length":1,"stats":{"Line":0}},{"line":809,"address":[16206384],"length":1,"stats":{"Line":0}},{"line":810,"address":[16206401],"length":1,"stats":{"Line":0}},{"line":822,"address":[16211215,16211056,16211221],"length":1,"stats":{"Line":0}},{"line":823,"address":[16211077],"length":1,"stats":{"Line":0}},{"line":826,"address":[16206367,16206208,16206373],"length":1,"stats":{"Line":0}},{"line":827,"address":[16206229],"length":1,"stats":{"Line":0}},{"line":830,"address":[16210420,16210288,16209424],"length":1,"stats":{"Line":0}},{"line":838,"address":[16209580],"length":1,"stats":{"Line":0}},{"line":839,"address":[13050864,13050881],"length":1,"stats":{"Line":0}},{"line":840,"address":[16209790,16209909],"length":1,"stats":{"Line":0}},{"line":841,"address":[16209997,16210342],"length":1,"stats":{"Line":0}},{"line":845,"address":[16210031],"length":1,"stats":{"Line":0}},{"line":846,"address":[16210087],"length":1,"stats":{"Line":0}},{"line":849,"address":[16216826,16216608,16215568],"length":1,"stats":{"Line":0}},{"line":854,"address":[16215620],"length":1,"stats":{"Line":0}},{"line":855,"address":[16215916],"length":1,"stats":{"Line":0}},{"line":856,"address":[16215992],"length":1,"stats":{"Line":0}},{"line":857,"address":[16216151,16216770,16216087,16216244],"length":1,"stats":{"Line":0}},{"line":858,"address":[16216659,16216340],"length":1,"stats":{"Line":0}},{"line":859,"address":[16216677],"length":1,"stats":{"Line":0}},{"line":862,"address":[16216382],"length":1,"stats":{"Line":0}},{"line":866,"address":[16207847,16207600,16207841],"length":1,"stats":{"Line":0}},{"line":867,"address":[16207633],"length":1,"stats":{"Line":0}},{"line":868,"address":[16207686],"length":1,"stats":{"Line":0}},{"line":869,"address":[16207761],"length":1,"stats":{"Line":0}},{"line":870,"address":[16207781],"length":1,"stats":{"Line":0}},{"line":874,"address":[16207865,16207701],"length":1,"stats":{"Line":0}},{"line":875,"address":[16207873],"length":1,"stats":{"Line":0}},{"line":876,"address":[16207909],"length":1,"stats":{"Line":0}},{"line":877,"address":[16207929],"length":1,"stats":{"Line":0}},{"line":882,"address":[16213056,16213350,16213344],"length":1,"stats":{"Line":0}},{"line":883,"address":[16213115],"length":1,"stats":{"Line":0}},{"line":884,"address":[16213161],"length":1,"stats":{"Line":0}},{"line":885,"address":[16213181],"length":1,"stats":{"Line":0}},{"line":888,"address":[16213130],"length":1,"stats":{"Line":0}},{"line":889,"address":[16213250],"length":1,"stats":{"Line":0}},{"line":890,"address":[16213285],"length":1,"stats":{"Line":0}},{"line":894,"address":[16215216,16215547,16215553],"length":1,"stats":{"Line":0}},{"line":895,"address":[16215271],"length":1,"stats":{"Line":0}},{"line":897,"address":[16215353,16215416],"length":1,"stats":{"Line":0}},{"line":898,"address":[13051121,13051104],"length":1,"stats":{"Line":0}},{"line":901,"address":[16213035,16213041,16212704],"length":1,"stats":{"Line":0}},{"line":902,"address":[16212759],"length":1,"stats":{"Line":0}},{"line":904,"address":[16212841,16212904],"length":1,"stats":{"Line":0}},{"line":905,"address":[13051056,13051073],"length":1,"stats":{"Line":0}}],"covered":96,"coverable":341},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","lib.rs"],"content":"#![no_std]\nuse soroban_sdk::{contract, contractimpl, symbol_short, Address, BytesN, Env, Map, String, Vec};\n\nmod analytics;\nmod audit;\nmod backup;\nmod bid;\nmod defaults;\nmod errors;\nmod events;\nmod fees;\nmod investment;\nmod invoice;\nmod notifications;\nmod payments;\nmod profits;\nmod settlement;\n#[cfg(test)]\nmod test_fees;\nmod verification;\n\nuse bid::{Bid, BidStatus, BidStorage};\nuse defaults::{\n    create_dispute as do_create_dispute, get_dispute_details as do_get_dispute_details,\n    get_invoices_by_dispute_status as do_get_invoices_by_dispute_status,\n    get_invoices_with_disputes as do_get_invoices_with_disputes,\n    handle_default as do_handle_default, put_dispute_under_review as do_put_dispute_under_review,\n    resolve_dispute as do_resolve_dispute,\n};\nuse errors::QuickLendXError;\nuse events::{\n    emit_audit_query, emit_audit_validation, emit_bid_placed, emit_bid_withdrawn,\n    emit_escrow_created, emit_escrow_refunded, emit_escrow_released, emit_insurance_added,\n    emit_insurance_premium_collected, emit_investor_verified, emit_invoice_cancelled,\n    emit_invoice_metadata_cleared, emit_invoice_metadata_updated, emit_invoice_uploaded,\n    emit_invoice_verified,\n};\nuse investment::{Investment, InvestmentStatus, InvestmentStorage};\nuse invoice::{DisputeStatus, Invoice, InvoiceMetadata, InvoiceStatus, InvoiceStorage};\nuse payments::{create_escrow, refund_escrow, release_escrow, EscrowStorage};\nuse profits::{calculate_profit as do_calculate_profit, PlatformFee, PlatformFeeConfig};\nuse settlement::{\n    process_partial_payment as do_process_partial_payment, settle_invoice as do_settle_invoice,\n};\nuse verification::{\n    calculate_investment_limit, calculate_investor_risk_score, determine_investor_tier,\n    get_business_verification_status, get_investor_analytics,\n    get_investor_verification as do_get_investor_verification, reject_business,\n    reject_investor as do_reject_investor, submit_investor_kyc as do_submit_investor_kyc,\n    submit_kyc_application, update_investor_analytics, validate_bid, validate_investor_investment,\n    validate_invoice_metadata, verify_business, verify_investor as do_verify_investor,\n    verify_invoice_data, BusinessVerificationStatus, BusinessVerificationStorage,\n    InvestorRiskLevel, InvestorTier, InvestorVerification, InvestorVerificationStorage,\n};\n\nuse crate::backup::{Backup, BackupStatus, BackupStorage};\nuse crate::notifications::{\n    Notification, NotificationDeliveryStatus, NotificationPreferences, NotificationStats,\n    NotificationSystem,\n};\nuse analytics::{\n    AnalyticsCalculator, AnalyticsStorage, BusinessReport, FinancialMetrics, InvestorAnalytics,\n    InvestorPerformanceMetrics, InvestorReport, PerformanceMetrics, PlatformMetrics, TimePeriod,\n    UserBehaviorMetrics,\n};\nuse audit::{AuditLogEntry, AuditOperation, AuditQueryFilter, AuditStats, AuditStorage};\n\n#[contract]\npub struct QuickLendXContract;\n\n#[contractimpl]\nimpl QuickLendXContract {\n    /// Store an invoice in the contract\n    pub fn store_invoice(\n        env: Env,\n        business: Address,\n        amount: i128,\n        currency: Address,\n        due_date: u64,\n        description: String,\n        category: invoice::InvoiceCategory,\n        tags: Vec\u003cString\u003e,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Validate input parameters\n        if amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let current_timestamp = env.ledger().timestamp();\n        if due_date \u003c= current_timestamp {\n            return Err(QuickLendXError::InvoiceDueDateInvalid);\n        }\n\n        if description.len() == 0 {\n            return Err(QuickLendXError::InvalidDescription);\n        }\n\n        // Check if business is verified (temporarily disabled for debugging)\n        // if !verification::BusinessVerificationStorage::is_business_verified(\u0026env, \u0026business) {\n        //     return Err(QuickLendXError::BusinessNotVerified);\n        // }\n\n        // Validate category and tags\n        verification::validate_invoice_category(\u0026category)?;\n        verification::validate_invoice_tags(\u0026tags)?;\n\n        // Create new invoice\n        let invoice = Invoice::new(\n            \u0026env,\n            business.clone(),\n            amount,\n            currency.clone(),\n            due_date,\n            description,\n            category,\n            tags,\n        );\n\n        // Store the invoice\n        InvoiceStorage::store_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        env.events().publish(\n            (symbol_short!(\"created\"),),\n            (invoice.id.clone(), business, amount, currency, due_date),\n        );\n\n        Ok(invoice.id)\n    }\n\n    /// Upload an invoice (business only)\n    pub fn upload_invoice(\n        env: Env,\n        business: Address,\n        amount: i128,\n        currency: Address,\n        due_date: u64,\n        description: String,\n        category: invoice::InvoiceCategory,\n        tags: Vec\u003cString\u003e,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Only the business can upload their own invoice\n        business.require_auth();\n\n        // Check if business is verified\n        let verification = get_business_verification_status(\u0026env, \u0026business);\n        if verification.is_none()\n            || !matches!(\n                verification.unwrap().status,\n                verification::BusinessVerificationStatus::Verified\n            )\n        {\n            return Err(QuickLendXError::BusinessNotVerified);\n        }\n\n        // Basic validation\n        verify_invoice_data(\u0026env, \u0026business, amount, \u0026currency, due_date, \u0026description)?;\n\n        // Validate category and tags\n        verification::validate_invoice_category(\u0026category)?;\n        verification::validate_invoice_tags(\u0026tags)?;\n\n        // Create and store invoice\n        let invoice = Invoice::new(\n            \u0026env,\n            business.clone(),\n            amount,\n            currency.clone(),\n            due_date,\n            description.clone(),\n            category,\n            tags,\n        );\n        InvoiceStorage::store_invoice(\u0026env, \u0026invoice);\n        emit_invoice_uploaded(\u0026env, \u0026invoice);\n\n        // Send notification\n        let _ = NotificationSystem::notify_invoice_created(\u0026env, \u0026invoice);\n\n        Ok(invoice.id)\n    }\n\n    /// Verify an invoice (admin or automated process)\n    pub fn verify_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        // Only allow verification if pending\n        if invoice.status != InvoiceStatus::Pending {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        // Remove from pending status list\n        // Remove from old status list (Pending)\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026InvoiceStatus::Pending, \u0026invoice_id);\n\n        invoice.verify(\u0026env, admin.clone());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Add to verified status list\n        // Add to new status list (Verified)\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026InvoiceStatus::Verified, \u0026invoice_id);\n\n        emit_invoice_verified(\u0026env, \u0026invoice);\n\n        // Send notification\n        let _ = NotificationSystem::notify_invoice_verified(\u0026env, \u0026invoice);\n\n        // If invoice is funded (has escrow), release escrow funds to business\n        if invoice.status == InvoiceStatus::Funded {\n            Self::release_escrow_funds(env.clone(), invoice_id)?;\n        }\n\n        Ok(())\n    }\n\n    /// Cancel an invoice (business only, before funding)\n    pub fn cancel_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can cancel their own invoice\n        invoice.business.require_auth();\n\n        // Remove from old status list\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026invoice.status, \u0026invoice_id);\n\n        // Cancel the invoice (only works if Pending or Verified)\n        invoice.cancel(\u0026env, invoice.business.clone())?;\n\n        // Update storage\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Add to cancelled status list\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026InvoiceStatus::Cancelled, \u0026invoice_id);\n\n        // Emit event\n        emit_invoice_cancelled(\u0026env, \u0026invoice);\n\n        // Send notification (optional - could notify interested investors)\n        let _ = NotificationSystem::notify_invoice_status_changed(\n            \u0026env,\n            \u0026invoice,\n            \u0026InvoiceStatus::Pending, // Could be Pending or Verified\n            \u0026InvoiceStatus::Cancelled,\n        );\n\n        Ok(())\n    }\n\n    /// Get an invoice by ID\n    pub fn get_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003cInvoice, QuickLendXError\u003e {\n        InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).ok_or(QuickLendXError::InvoiceNotFound)\n    }\n\n    /// Get all invoices for a business\n    pub fn get_invoice_by_business(env: Env, business: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_business_invoices(\u0026env, \u0026business)\n    }\n\n    /// Get all invoices for a specific business\n    pub fn get_business_invoices(env: Env, business: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_business_invoices(\u0026env, \u0026business)\n    }\n\n    /// Update structured metadata for an invoice\n    pub fn update_invoice_metadata(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        metadata: InvoiceMetadata,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        invoice.business.require_auth();\n        validate_invoice_metadata(\u0026metadata, invoice.amount)?;\n\n        if let Some(existing) = invoice.metadata() {\n            InvoiceStorage::remove_metadata_indexes(\u0026env, \u0026existing, \u0026invoice.id);\n        }\n\n        invoice.set_metadata(\u0026env, Some(metadata.clone()));\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n        InvoiceStorage::add_metadata_indexes(\u0026env, \u0026invoice);\n\n        emit_invoice_metadata_updated(\u0026env, \u0026invoice, \u0026metadata);\n        Ok(())\n    }\n\n    /// Clear metadata attached to an invoice\n    pub fn clear_invoice_metadata(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        invoice.business.require_auth();\n\n        if let Some(existing) = invoice.metadata() {\n            InvoiceStorage::remove_metadata_indexes(\u0026env, \u0026existing, \u0026invoice.id);\n            invoice.set_metadata(\u0026env, None);\n            InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n            emit_invoice_metadata_cleared(\u0026env, \u0026invoice);\n        }\n\n        Ok(())\n    }\n\n    /// Get invoices indexed by customer name\n    pub fn get_invoices_by_customer(env: Env, customer_name: String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_customer(\u0026env, \u0026customer_name)\n    }\n\n    /// Get invoices indexed by tax id\n    pub fn get_invoices_by_tax_id(env: Env, tax_id: String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_tax_id(\u0026env, \u0026tax_id)\n    }\n\n    /// Get all invoices by status\n    pub fn get_invoices_by_status(env: Env, status: InvoiceStatus) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_status(\u0026env, \u0026status)\n    }\n\n    /// Get all available invoices (verified and not funded)\n    pub fn get_available_invoices(env: Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Verified)\n    }\n\n    /// Update invoice status (admin function)\n    pub fn update_invoice_status(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        new_status: InvoiceStatus,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Remove from old status list\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026invoice.status, \u0026invoice_id);\n\n        // Update status\n        match new_status {\n            InvoiceStatus::Verified =\u003e invoice.verify(\u0026env, invoice.business.clone()),\n            InvoiceStatus::Paid =\u003e {\n                invoice.mark_as_paid(\u0026env, invoice.business.clone(), env.ledger().timestamp())\n            }\n            InvoiceStatus::Defaulted =\u003e invoice.mark_as_defaulted(),\n            InvoiceStatus::Funded =\u003e {\n                // For testing purposes - normally funding happens via accept_bid\n                invoice.mark_as_funded(\n                    \u0026env,\n                    invoice.business.clone(),\n                    invoice.amount,\n                    env.ledger().timestamp(),\n                );\n            }\n            _ =\u003e return Err(QuickLendXError::InvalidStatus),\n        }\n\n        // Store updated invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Add to new status list\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026invoice.status, \u0026invoice_id);\n\n        // Emit event\n        env.events().publish(\n            (symbol_short!(\"updated\"),),\n            (invoice_id, new_status.clone()),\n        );\n\n        // Send notifications based on status change\n        match new_status {\n            InvoiceStatus::Verified =\u003e {\n                let _ = NotificationSystem::notify_invoice_verified(\u0026env, \u0026invoice);\n            }\n            InvoiceStatus::Paid =\u003e {\n                let _ = NotificationSystem::notify_payment_received(\u0026env, \u0026invoice, invoice.amount);\n            }\n            InvoiceStatus::Defaulted =\u003e {\n                let _ = NotificationSystem::notify_invoice_defaulted(\u0026env, \u0026invoice);\n            }\n            _ =\u003e {}\n        }\n\n        Ok(())\n    }\n\n    /// Get invoice count by status\n    pub fn get_invoice_count_by_status(env: Env, status: InvoiceStatus) -\u003e u32 {\n        let invoices = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026status);\n        invoices.len() as u32\n    }\n\n    /// Get total invoice count\n    pub fn get_total_invoice_count(env: Env) -\u003e u32 {\n        let pending = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Pending);\n        let verified = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Verified);\n        let funded = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Funded);\n        let paid = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Paid);\n        let defaulted = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Defaulted);\n        let cancelled = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Cancelled);\n\n        pending + verified + funded + paid + defaulted + cancelled\n    }\n\n    /// Get a bid by ID\n    pub fn get_bid(env: Env, bid_id: BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        BidStorage::get_bid(\u0026env, \u0026bid_id)\n    }\n\n    /// Get the highest ranked bid for an invoice\n    pub fn get_best_bid(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        BidStorage::get_best_bid(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get all bids for an invoice sorted using the platform ranking rules\n    pub fn get_ranked_bids(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        BidStorage::rank_bids(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get bids filtered by status\n    pub fn get_bids_by_status(env: Env, invoice_id: BytesN\u003c32\u003e, status: BidStatus) -\u003e Vec\u003cBid\u003e {\n        BidStorage::get_bids_by_status(\u0026env, \u0026invoice_id, status)\n    }\n\n    /// Get bids filtered by investor\n    pub fn get_bids_by_investor(env: Env, invoice_id: BytesN\u003c32\u003e, investor: Address) -\u003e Vec\u003cBid\u003e {\n        BidStorage::get_bids_by_investor(\u0026env, \u0026invoice_id, \u0026investor)\n    }\n\n    /// Get all bids for an invoice\n    /// Returns a list of all bid records (including expired, withdrawn, etc.)\n    /// Use get_bids_by_status to filter by status if needed\n    pub fn get_bids_for_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        BidStorage::get_bid_records_for_invoice(\u0026env, \u0026invoice_id)\n    }\n\n    /// Remove bids that have passed their expiration window\n    pub fn cleanup_expired_bids(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e u32 {\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id)\n    }\n\n    /// Place a bid on an invoice\n    ///\n    /// Validates:\n    /// - Invoice exists and is verified\n    /// - Bid amount is positive\n    /// - Investor is authorized and verified\n    /// - Creates and stores the bid\n    pub fn place_bid(\n        env: Env,\n        investor: Address,\n        invoice_id: BytesN\u003c32\u003e,\n        bid_amount: i128,\n        expected_return: i128,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Authorization check: Only the investor can place their own bid\n        investor.require_auth();\n\n        // Validate bid amount is positive\n        if bid_amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        // Validate invoice exists and is verified\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        if invoice.status != InvoiceStatus::Verified {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        let verification = do_get_investor_verification(\u0026env, \u0026investor)\n            .ok_or(QuickLendXError::BusinessNotVerified)?;\n        match verification.status {\n            BusinessVerificationStatus::Verified =\u003e {\n                if bid_amount \u003e verification.investment_limit {\n                    return Err(QuickLendXError::InvalidAmount);\n                }\n            }\n            BusinessVerificationStatus::Pending =\u003e return Err(QuickLendXError::KYCAlreadyPending),\n            BusinessVerificationStatus::Rejected =\u003e {\n                return Err(QuickLendXError::BusinessNotVerified)\n            }\n        }\n\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id);\n        validate_bid(\u0026env, \u0026invoice, bid_amount, expected_return, \u0026investor)?;\n        // Create bid\n        let bid_id = BidStorage::generate_unique_bid_id(\u0026env);\n        let current_timestamp = env.ledger().timestamp();\n        let bid = Bid {\n            bid_id: bid_id.clone(),\n            invoice_id: invoice_id.clone(),\n            investor: investor.clone(),\n            bid_amount,\n            expected_return,\n            timestamp: current_timestamp,\n            status: BidStatus::Placed,\n            expiration_timestamp: Bid::default_expiration(current_timestamp),\n        };\n        BidStorage::store_bid(\u0026env, \u0026bid);\n        // Track bid for this invoice\n        BidStorage::add_bid_to_invoice(\u0026env, \u0026invoice_id, \u0026bid_id);\n\n        // Emit bid placed event\n        emit_bid_placed(\u0026env, \u0026bid);\n\n        // Send notification for business about new bid\n        let _ = NotificationSystem::notify_bid_received(\u0026env, \u0026invoice, \u0026bid);\n\n        Ok(bid_id)\n    }\n\n    /// Accept a bid (business only)\n    pub fn accept_bid(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        bid_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id);\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        let bid = BidStorage::get_bid(\u0026env, \u0026bid_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let invoice_id = bid.invoice_id.clone();\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id);\n        let mut bid =\n            BidStorage::get_bid(\u0026env, \u0026bid_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n        // Only the business owner can accept a bid\n        invoice.business.require_auth();\n        // Only allow accepting if invoice is verified and bid is placed\n        if invoice.status != InvoiceStatus::Verified || bid.status != BidStatus::Placed {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        // Create escrow\n        let escrow_id = create_escrow(\n            \u0026env,\n            \u0026invoice_id,\n            \u0026bid.investor,\n            \u0026invoice.business,\n            bid.bid_amount,\n            \u0026invoice.currency,\n        )?;\n        // Mark bid as accepted\n        bid.status = BidStatus::Accepted;\n        BidStorage::update_bid(\u0026env, \u0026bid);\n        // Mark invoice as funded\n        invoice.mark_as_funded(\n            \u0026env,\n            bid.investor.clone(),\n            bid.bid_amount,\n            env.ledger().timestamp(),\n        );\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n        // Track investment\n        let investment_id = InvestmentStorage::generate_unique_investment_id(\u0026env);\n        let investment = Investment {\n            investment_id: investment_id.clone(),\n            invoice_id: invoice_id.clone(),\n            investor: bid.investor.clone(),\n            amount: bid.bid_amount,\n            funded_at: env.ledger().timestamp(),\n            status: InvestmentStatus::Active,\n            insurance: Vec::new(\u0026env),\n        };\n        InvestmentStorage::store_investment(\u0026env, \u0026investment);\n\n        let escrow = EscrowStorage::get_escrow(\u0026env, \u0026escrow_id)\n            .expect(\"Escrow should exist after creation\");\n        emit_escrow_created(\u0026env, \u0026escrow);\n\n        // Send notification to investor for bid acceptance\n        let _ = NotificationSystem::notify_bid_accepted(\u0026env, \u0026invoice, \u0026bid);\n\n        // Send notification about invoice status change\n        let _ = NotificationSystem::notify_invoice_status_changed(\n            \u0026env,\n            \u0026invoice,\n            \u0026InvoiceStatus::Verified,\n            \u0026InvoiceStatus::Funded,\n        );\n\n        Ok(())\n    }\n\n    pub fn add_investment_insurance(\n        env: Env,\n        investment_id: BytesN\u003c32\u003e,\n        provider: Address,\n        coverage_percentage: u32,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut investment = InvestmentStorage::get_investment(\u0026env, \u0026investment_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        investment.investor.require_auth();\n\n        if investment.status != InvestmentStatus::Active {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        let premium = Investment::calculate_premium(investment.amount, coverage_percentage);\n        if premium \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let coverage_amount =\n            investment.add_insurance(provider.clone(), coverage_percentage, premium)?;\n\n        InvestmentStorage::update_investment(\u0026env, \u0026investment);\n\n        emit_insurance_added(\n            \u0026env,\n            \u0026investment_id,\n            \u0026investment.invoice_id,\n            \u0026investment.investor,\n            \u0026provider,\n            coverage_percentage,\n            coverage_amount,\n            premium,\n        );\n        emit_insurance_premium_collected(\u0026env, \u0026investment_id, \u0026provider, premium);\n\n        Ok(())\n    }\n\n    /// Withdraw a bid (investor only, before acceptance)\n    ///\n    /// Validates:\n    /// - Bid exists\n    /// - Caller is the bid owner (authorization check)\n    /// - Bid is in Placed status (prevents withdrawal of accepted/expired/withdrawn bids)\n    /// - Updates bid status to Withdrawn\n    pub fn withdraw_bid(env: Env, bid_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Get bid and validate it exists\n        let mut bid =\n            BidStorage::get_bid(\u0026env, \u0026bid_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Authorization check: Only the investor who owns the bid can withdraw it\n        bid.investor.require_auth();\n\n        // Status validation: Only allow withdrawal if bid is placed\n        // Prevents withdrawal of accepted, withdrawn, or expired bids\n        if bid.status != BidStatus::Placed {\n            return Err(QuickLendXError::OperationNotAllowed);\n        }\n        bid.status = BidStatus::Withdrawn;\n        BidStorage::update_bid(\u0026env, \u0026bid);\n\n        // Emit bid withdrawn event\n        emit_bid_withdrawn(\u0026env, \u0026bid);\n\n        Ok(())\n    }\n\n    /// Settle an invoice (business or automated process)\n    pub fn settle_invoice(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        payment_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Get the investment to track investor analytics\n        let investment = InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id);\n\n        let result = do_settle_invoice(\u0026env, \u0026invoice_id, payment_amount);\n\n        // Update investor analytics if settlement was successful\n        if result.is_ok() {\n            if let Some(inv) = investment {\n                let is_successful = payment_amount \u003e= inv.amount;\n                let _ = update_investor_analytics(\u0026env, \u0026inv.investor, inv.amount, is_successful);\n            }\n        }\n\n        result\n    }\n\n    pub fn get_invoice_investment(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cInvestment, QuickLendXError\u003e {\n        InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)\n    }\n\n    pub fn get_investment(\n        env: Env,\n        investment_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cInvestment, QuickLendXError\u003e {\n        InvestmentStorage::get_investment(\u0026env, \u0026investment_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)\n    }\n\n    /// Process a partial payment towards an invoice\n    pub fn process_partial_payment(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        payment_amount: i128,\n        transaction_id: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_process_partial_payment(\u0026env, \u0026invoice_id, payment_amount, transaction_id)\n    }\n\n    /// Handle invoice default (admin or automated process)\n    pub fn handle_default(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Get the investment to track investor analytics\n        let investment = InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id);\n\n        let result = do_handle_default(\u0026env, \u0026invoice_id);\n\n        // Update investor analytics for failed investment\n        if result.is_ok() {\n            if let Some(inv) = investment {\n                let _ = update_investor_analytics(\u0026env, \u0026inv.investor, inv.amount, false);\n            }\n        }\n\n        result\n    }\n\n    /// Calculate profit and platform fee\n    pub fn calculate_profit(\n        env: Env,\n        investment_amount: i128,\n        payment_amount: i128,\n    ) -\u003e (i128, i128) {\n        do_calculate_profit(\u0026env, investment_amount, payment_amount)\n    }\n\n    /// Retrieve the current platform fee configuration\n    pub fn get_platform_fee(env: Env) -\u003e PlatformFeeConfig {\n        PlatformFee::get_config(\u0026env)\n    }\n\n    /// Update the platform fee basis points (admin only)\n    pub fn set_platform_fee(env: Env, new_fee_bps: i128) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        PlatformFee::set_config(\u0026env, \u0026admin, new_fee_bps)?;\n        Ok(())\n    }\n\n    // Rating Functions (from feat-invoice_rating_system)\n\n    /// Add a rating to an invoice (investor only)\n    pub fn add_invoice_rating(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        rating: u32,\n        feedback: String,\n        rater: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the investor who funded the invoice can rate it\n        rater.require_auth();\n\n        invoice.add_rating(rating, feedback, rater.clone(), env.ledger().timestamp())?;\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit rating event\n        env.events()\n            .publish((symbol_short!(\"rated\"),), (invoice_id, rating, rater));\n\n        Ok(())\n    }\n\n    /// Get invoices with ratings above a threshold\n    pub fn get_invoices_with_rating_above(env: Env, threshold: u32) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_with_rating_above(\u0026env, threshold)\n    }\n\n    /// Get business invoices with ratings above a threshold\n    pub fn get_business_rated_invoices(\n        env: Env,\n        business: Address,\n        threshold: u32,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_business_invoices_with_rating_above(\u0026env, \u0026business, threshold)\n    }\n\n    /// Get count of invoices with ratings\n    pub fn get_invoices_with_ratings_count(env: Env) -\u003e u32 {\n        InvoiceStorage::get_invoices_with_ratings_count(\u0026env)\n    }\n\n    /// Get invoice rating statistics\n    pub fn get_invoice_rating_stats(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003c(Option\u003cu32\u003e, u32, Option\u003cu32\u003e, Option\u003cu32\u003e), QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        Ok((\n            invoice.average_rating,\n            invoice.total_ratings,\n            invoice.get_highest_rating(),\n            invoice.get_lowest_rating(),\n        ))\n    }\n\n    // Business KYC/Verification Functions (from main)\n\n    /// Submit KYC application (business only)\n    pub fn submit_kyc_application(\n        env: Env,\n        business: Address,\n        kyc_data: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        submit_kyc_application(\u0026env, \u0026business, kyc_data)\n    }\n\n    /// Submit investor verification request\n    pub fn submit_investor_kyc(\n        env: Env,\n        investor: Address,\n        kyc_data: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_submit_investor_kyc(\u0026env, \u0026investor, kyc_data)\n    }\n\n    /// Verify an investor and set an investment limit\n    pub fn verify_investor(\n        env: Env,\n        investor: Address,\n        investment_limit: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        let verification = do_verify_investor(\u0026env, \u0026admin, \u0026investor, investment_limit)?;\n        emit_investor_verified(\u0026env, \u0026verification);\n        Ok(())\n    }\n\n    /// Reject an investor verification request\n    pub fn reject_investor(\n        env: Env,\n        investor: Address,\n        reason: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        do_reject_investor(\u0026env, \u0026admin, \u0026investor, reason)\n    }\n\n    /// Get investor verification record if available\n    pub fn get_investor_verification(env: Env, investor: Address) -\u003e Option\u003cInvestorVerification\u003e {\n        do_get_investor_verification(\u0026env, \u0026investor)\n    }\n\n    /// Verify business (admin only)\n    pub fn verify_business(\n        env: Env,\n        admin: Address,\n        business: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        verify_business(\u0026env, \u0026admin, \u0026business)\n    }\n\n    /// Reject business (admin only)\n    pub fn reject_business(\n        env: Env,\n        admin: Address,\n        business: Address,\n        reason: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        reject_business(\u0026env, \u0026admin, \u0026business, reason)\n    }\n\n    /// Get business verification status\n    pub fn get_business_verification_status(\n        env: Env,\n        business: Address,\n    ) -\u003e Option\u003cverification::BusinessVerification\u003e {\n        get_business_verification_status(\u0026env, \u0026business)\n    }\n\n    /// Set admin address (initialization function)\n    pub fn set_admin(env: Env, admin: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        if let Some(current_admin) = BusinessVerificationStorage::get_admin(\u0026env) {\n            current_admin.require_auth();\n        } else {\n            admin.require_auth();\n        }\n        BusinessVerificationStorage::set_admin(\u0026env, \u0026admin);\n        Ok(())\n    }\n\n    /// Get admin address\n    pub fn get_admin(env: Env) -\u003e Option\u003cAddress\u003e {\n        BusinessVerificationStorage::get_admin(\u0026env)\n    }\n\n    /// Get all verified businesses\n    pub fn get_verified_businesses(env: Env) -\u003e Vec\u003cAddress\u003e {\n        BusinessVerificationStorage::get_verified_businesses(\u0026env)\n    }\n\n    /// Get all pending businesses\n    pub fn get_pending_businesses(env: Env) -\u003e Vec\u003cAddress\u003e {\n        BusinessVerificationStorage::get_pending_businesses(\u0026env)\n    }\n\n    /// Get all rejected businesses\n    pub fn get_rejected_businesses(env: Env) -\u003e Vec\u003cAddress\u003e {\n        BusinessVerificationStorage::get_rejected_businesses(\u0026env)\n    }\n\n    // ========================================\n    // Enhanced Investor Verification Functions\n    // ========================================\n\n    /// Get all verified investors\n    pub fn get_verified_investors(env: Env) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_verified_investors(\u0026env)\n    }\n\n    /// Get all pending investors\n    pub fn get_pending_investors(env: Env) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_pending_investors(\u0026env)\n    }\n\n    /// Get all rejected investors\n    pub fn get_rejected_investors(env: Env) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_rejected_investors(\u0026env)\n    }\n\n    /// Get investors by tier\n    pub fn get_investors_by_tier(env: Env, tier: InvestorTier) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_investors_by_tier(\u0026env, tier)\n    }\n\n    /// Get investors by risk level\n    pub fn get_investors_by_risk_level(env: Env, risk_level: InvestorRiskLevel) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_investors_by_risk_level(\u0026env, risk_level)\n    }\n\n    /// Calculate investor risk score\n    pub fn calculate_investor_risk_score(\n        env: Env,\n        investor: Address,\n        kyc_data: String,\n    ) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        calculate_investor_risk_score(\u0026env, \u0026investor, \u0026kyc_data)\n    }\n\n    /// Determine investor tier\n    pub fn determine_investor_tier(\n        env: Env,\n        investor: Address,\n        risk_score: u32,\n    ) -\u003e Result\u003cInvestorTier, QuickLendXError\u003e {\n        determine_investor_tier(\u0026env, \u0026investor, risk_score)\n    }\n\n    /// Calculate investment limit for investor\n    pub fn calculate_investment_limit(\n        _env: Env,\n        tier: InvestorTier,\n        risk_level: InvestorRiskLevel,\n        base_limit: i128,\n    ) -\u003e i128 {\n        calculate_investment_limit(\u0026tier, \u0026risk_level, base_limit)\n    }\n\n    /// Update investor analytics after investment\n    pub fn update_investor_analytics(\n        env: Env,\n        investor: Address,\n        investment_amount: i128,\n        is_successful: bool,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        update_investor_analytics(\u0026env, \u0026investor, investment_amount, is_successful)\n    }\n\n    /// Get investor analytics\n    pub fn get_investor_analytics(\n        env: Env,\n        investor: Address,\n    ) -\u003e Result\u003cInvestorVerification, QuickLendXError\u003e {\n        get_investor_analytics(\u0026env, \u0026investor)\n    }\n\n    /// Validate investor investment\n    pub fn validate_investor_investment(\n        env: Env,\n        investor: Address,\n        investment_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        validate_investor_investment(\u0026env, \u0026investor, investment_amount)\n    }\n\n    /// Check if investor is verified\n    pub fn is_investor_verified(env: Env, investor: Address) -\u003e bool {\n        InvestorVerificationStorage::is_investor_verified(\u0026env, \u0026investor)\n    }\n\n    /// Release escrow funds to business upon invoice verification\n    pub fn release_escrow_funds(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let escrow = EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Release escrow funds\n        release_escrow(\u0026env, \u0026invoice_id)?;\n\n        // Emit event\n        emit_escrow_released(\n            \u0026env,\n            \u0026escrow.escrow_id,\n            \u0026invoice_id,\n            \u0026escrow.business,\n            escrow.amount,\n        );\n\n        Ok(())\n    }\n\n    /// Refund escrow funds to investor if verification fails\n    pub fn refund_escrow_funds(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let escrow = EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Refund escrow funds\n        refund_escrow(\u0026env, \u0026invoice_id)?;\n\n        // Emit event\n        emit_escrow_refunded(\n            \u0026env,\n            \u0026escrow.escrow_id,\n            \u0026invoice_id,\n            \u0026escrow.investor,\n            escrow.amount,\n        );\n\n        Ok(())\n    }\n\n    /// Get escrow status for an invoice\n    pub fn get_escrow_status(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cpayments::EscrowStatus, QuickLendXError\u003e {\n        let escrow = EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        Ok(escrow.status)\n    }\n\n    /// Get escrow details for an invoice\n    pub fn get_escrow_details(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cpayments::Escrow, QuickLendXError\u003e {\n        EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)\n    }\n\n    ///== Notification Management Functions ==///\n\n    /// Get a notification by ID\n    pub fn get_notification(env: Env, notification_id: BytesN\u003c32\u003e) -\u003e Option\u003cNotification\u003e {\n        NotificationSystem::get_notification(\u0026env, \u0026notification_id)\n    }\n\n    /// Update notification delivery status\n    pub fn update_notification_status(\n        env: Env,\n        notification_id: BytesN\u003c32\u003e,\n        status: NotificationDeliveryStatus,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        NotificationSystem::update_notification_status(\u0026env, \u0026notification_id, status)\n    }\n\n    /// Get all notifications for a user\n    pub fn get_user_notifications(env: Env, user: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        NotificationSystem::get_user_notifications(\u0026env, \u0026user)\n    }\n\n    /// Get user notification preferences\n    pub fn get_notification_preferences(env: Env, user: Address) -\u003e NotificationPreferences {\n        NotificationSystem::get_user_preferences(\u0026env, \u0026user)\n    }\n\n    /// Update user notification preferences\n    pub fn update_notification_preferences(\n        env: Env,\n        user: Address,\n        preferences: NotificationPreferences,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        user.require_auth();\n        NotificationSystem::update_user_preferences(\u0026env, \u0026user, preferences);\n        Ok(())\n    }\n\n    /// Get notification statistics for a user\n    pub fn get_user_notification_stats(env: Env, user: Address) -\u003e NotificationStats {\n        NotificationSystem::get_user_notification_stats(\u0026env, \u0026user)\n    }\n\n    /// Check for overdue invoices and send notifications (admin or automated process)\n    pub fn check_overdue_invoices(env: Env) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        Self::check_overdue_invoices_grace(env, Invoice::DEFAULT_GRACE_PERIOD)\n    }\n\n    /// Check for overdue invoices with a custom grace period (in seconds)\n    pub fn check_overdue_invoices_grace(\n        env: Env,\n        grace_period: u64,\n    ) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let funded_invoices = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Funded);\n        let mut overdue_count = 0u32;\n\n        for invoice_id in funded_invoices.iter() {\n            if let Some(invoice) = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id) {\n                if invoice.is_overdue(current_timestamp) {\n                    let _ = NotificationSystem::notify_payment_overdue(\u0026env, \u0026invoice);\n                    overdue_count += 1;\n                }\n                let _ = invoice.check_and_handle_expiration(\u0026env, grace_period)?;\n            }\n        }\n\n        Ok(overdue_count)\n    }\n\n    /// Check whether a specific invoice has expired and trigger default handling when necessary\n    pub fn check_invoice_expiration(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        grace_period: Option\u003cu64\u003e,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        let grace = grace_period.unwrap_or(Invoice::DEFAULT_GRACE_PERIOD);\n        invoice.check_and_handle_expiration(\u0026env, grace)\n    }\n\n    /// Create a backup of all invoice data\n    pub fn create_backup(env: Env, description: String) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Only admin can create backups\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        // Get all invoices\n        let pending = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Pending);\n        let verified = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Verified);\n        let funded = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Funded);\n        let paid = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Paid);\n        let defaulted = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Defaulted);\n\n        // Combine all invoices\n        let mut all_invoices = Vec::new(\u0026env);\n        for status_vec in [pending, verified, funded, paid, defaulted].iter() {\n            for invoice_id in status_vec.iter() {\n                if let Some(invoice) = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id) {\n                    all_invoices.push_back(invoice);\n                }\n            }\n        }\n\n        // Create backup\n        let backup_id = BackupStorage::generate_backup_id(\u0026env);\n        let backup = Backup {\n            backup_id: backup_id.clone(),\n            timestamp: env.ledger().timestamp(),\n            description,\n            invoice_count: all_invoices.len() as u32,\n            status: BackupStatus::Active,\n        };\n\n        // Store backup and data\n        BackupStorage::store_backup(\u0026env, \u0026backup);\n        BackupStorage::store_backup_data(\u0026env, \u0026backup_id, \u0026all_invoices);\n        BackupStorage::add_to_backup_list(\u0026env, \u0026backup_id);\n\n        // Clean up old backups (keep last 5)\n        BackupStorage::cleanup_old_backups(\u0026env, 5)?;\n\n        // Emit event\n        events::emit_backup_created(\u0026env, \u0026backup_id, backup.invoice_count);\n\n        Ok(backup_id)\n    }\n\n    /// Restore invoice data from a backup\n    pub fn restore_backup(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Only admin can restore backups\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        // Validate backup first\n        BackupStorage::validate_backup(\u0026env, \u0026backup_id)?;\n\n        // Get backup data\n        let invoices = BackupStorage::get_backup_data(\u0026env, \u0026backup_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Clear current invoice data\n        Self::clear_all_invoices(\u0026env)?;\n\n        // Restore invoices\n        for invoice in invoices.iter() {\n            InvoiceStorage::store_invoice(\u0026env, \u0026invoice);\n        }\n\n        // Emit event\n        events::emit_backup_restored(\u0026env, \u0026backup_id, invoices.len() as u32);\n\n        Ok(())\n    }\n\n    /// Validate a backup's integrity\n    pub fn validate_backup(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let result = BackupStorage::validate_backup(\u0026env, \u0026backup_id).is_ok();\n        events::emit_backup_validated(\u0026env, \u0026backup_id, result);\n        Ok(result)\n    }\n\n    /// Archive a backup (mark as no longer active)\n    pub fn archive_backup(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Only admin can archive backups\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let mut backup = BackupStorage::get_backup(\u0026env, \u0026backup_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        backup.status = BackupStatus::Archived;\n        BackupStorage::update_backup(\u0026env, \u0026backup);\n        BackupStorage::remove_from_backup_list(\u0026env, \u0026backup_id);\n\n        events::emit_backup_archived(\u0026env, \u0026backup_id);\n\n        Ok(())\n    }\n\n    /// Get all available backups\n    pub fn get_backups(env: Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        BackupStorage::get_all_backups(\u0026env)\n    }\n\n    /// Get backup details\n    pub fn get_backup_details(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Option\u003cBackup\u003e {\n        BackupStorage::get_backup(\u0026env, \u0026backup_id)\n    }\n\n    /// Internal function to clear all invoice data\n    fn clear_all_invoices(env: \u0026Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Clear all status lists\n        for status in [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ]\n        .iter()\n        {\n            let invoices = InvoiceStorage::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                // Remove from status list\n                InvoiceStorage::remove_from_status_invoices(env, status, \u0026invoice_id);\n                // Remove the invoice itself\n                env.storage().instance().remove(\u0026invoice_id);\n            }\n        }\n\n        // Clear all business invoices\n        let verified_businesses = BusinessVerificationStorage::get_verified_businesses(env);\n        for business in verified_businesses.iter() {\n            let _ = InvoiceStorage::get_business_invoices(env, \u0026business);\n            let key = (symbol_short!(\"business\"), business.clone());\n            env.storage().instance().remove(\u0026key);\n        }\n\n        Ok(())\n    }\n    /// Get audit trail for an invoice\n    pub fn get_invoice_audit_trail(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        AuditStorage::get_invoice_audit_trail(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get audit entry by ID\n    pub fn get_audit_entry(\n        env: Env,\n        audit_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cAuditLogEntry, QuickLendXError\u003e {\n        AuditStorage::get_audit_entry(\u0026env, \u0026audit_id).ok_or(QuickLendXError::AuditLogNotFound)\n    }\n\n    /// Query audit logs with filters\n    pub fn query_audit_logs(env: Env, filter: AuditQueryFilter, limit: u32) -\u003e Vec\u003cAuditLogEntry\u003e {\n        let results = AuditStorage::query_audit_logs(\u0026env, \u0026filter, limit);\n        emit_audit_query(\n            \u0026env,\n            String::from_str(\u0026env, \"query_audit_logs\"),\n            results.len() as u32,\n        );\n        results\n    }\n\n    /// Get audit statistics\n    pub fn get_audit_stats(env: Env) -\u003e AuditStats {\n        AuditStorage::get_audit_stats(\u0026env)\n    }\n\n    /// Validate audit log integrity for an invoice\n    pub fn validate_invoice_audit_integrity(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let is_valid = AuditStorage::validate_invoice_audit_integrity(\u0026env, \u0026invoice_id)?;\n        emit_audit_validation(\u0026env, \u0026invoice_id, is_valid);\n        Ok(is_valid)\n    }\n\n    /// Get audit entries by operation type\n    pub fn get_audit_entries_by_operation(env: Env, operation: AuditOperation) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        AuditStorage::get_audit_entries_by_operation(\u0026env, \u0026operation)\n    }\n\n    /// Get audit entries by actor\n    pub fn get_audit_entries_by_actor(env: Env, actor: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        AuditStorage::get_audit_entries_by_actor(\u0026env, \u0026actor)\n    }\n\n    // Category and Tag Management Functions\n\n    /// Get invoices by category\n    pub fn get_invoices_by_category(\n        env: Env,\n        category: invoice::InvoiceCategory,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_category(\u0026env, \u0026category)\n    }\n\n    /// Get invoices by category and status\n    pub fn get_invoices_by_cat_status(\n        env: Env,\n        category: invoice::InvoiceCategory,\n        status: InvoiceStatus,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_category_and_status(\u0026env, \u0026category, \u0026status)\n    }\n\n    /// Get invoices by tag\n    pub fn get_invoices_by_tag(env: Env, tag: String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_tag(\u0026env, \u0026tag)\n    }\n\n    /// Get invoices by multiple tags (AND logic)\n    pub fn get_invoices_by_tags(env: Env, tags: Vec\u003cString\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_tags(\u0026env, \u0026tags)\n    }\n\n    /// Get invoice count by category\n    pub fn get_invoice_count_by_category(env: Env, category: invoice::InvoiceCategory) -\u003e u32 {\n        InvoiceStorage::get_invoice_count_by_category(\u0026env, \u0026category)\n    }\n\n    /// Get invoice count by tag\n    pub fn get_invoice_count_by_tag(env: Env, tag: String) -\u003e u32 {\n        InvoiceStorage::get_invoice_count_by_tag(\u0026env, \u0026tag)\n    }\n\n    /// Get all available categories\n    pub fn get_all_categories(env: Env) -\u003e Vec\u003cinvoice::InvoiceCategory\u003e {\n        InvoiceStorage::get_all_categories(\u0026env)\n    }\n\n    /// Update invoice category (business owner only)\n    pub fn update_invoice_category(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        new_category: invoice::InvoiceCategory,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can update the category\n        invoice.business.require_auth();\n\n        let old_category = invoice.category.clone();\n        invoice.update_category(new_category.clone());\n\n        // Validate the new category\n        verification::validate_invoice_category(\u0026new_category)?;\n\n        // Update the invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        events::emit_invoice_category_updated(\n            \u0026env,\n            \u0026invoice_id,\n            \u0026invoice.business,\n            \u0026old_category,\n            \u0026new_category,\n        );\n\n        Ok(())\n    }\n\n    /// Add tag to invoice (business owner only)\n    pub fn add_invoice_tag(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        tag: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can add tags\n        invoice.business.require_auth();\n\n        // Add the tag\n        invoice.add_tag(\u0026env, tag.clone())?;\n\n        // Update the invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        events::emit_invoice_tag_added(\u0026env, \u0026invoice_id, \u0026invoice.business, \u0026tag);\n\n        Ok(())\n    }\n\n    /// Remove tag from invoice (business owner only)\n    pub fn remove_invoice_tag(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        tag: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can remove tags\n        invoice.business.require_auth();\n\n        // Remove the tag\n        invoice.remove_tag(tag.clone())?;\n\n        // Update the invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        events::emit_invoice_tag_removed(\u0026env, \u0026invoice_id, \u0026invoice.business, \u0026tag);\n\n        Ok(())\n    }\n\n    /// Get all tags for an invoice\n    pub fn get_invoice_tags(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        Ok(invoice.get_tags())\n    }\n\n    /// Check if invoice has a specific tag\n    pub fn invoice_has_tag(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        tag: String,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        Ok(invoice.has_tag(tag))\n    }\n\n    // Dispute Resolution Functions\n\n    /// Create a dispute for an invoice\n    pub fn create_dispute(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        creator: Address,\n        reason: String,\n        evidence: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_create_dispute(\u0026env, \u0026invoice_id, \u0026creator, reason, evidence)\n    }\n\n    /// Put a dispute under review (admin function)\n    pub fn put_dispute_under_review(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        reviewer: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_put_dispute_under_review(\u0026env, \u0026invoice_id, \u0026reviewer)\n    }\n\n    /// Resolve a dispute (admin function)\n    pub fn resolve_dispute(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        resolver: Address,\n        resolution: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_resolve_dispute(\u0026env, \u0026invoice_id, \u0026resolver, resolution)\n    }\n\n    /// Get dispute details for an invoice\n    pub fn get_dispute_details(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cOption\u003cinvoice::Dispute\u003e, QuickLendXError\u003e {\n        do_get_dispute_details(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get all invoices with disputes\n    pub fn get_invoices_with_disputes(env: Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        do_get_invoices_with_disputes(\u0026env)\n    }\n\n    /// Get invoices by dispute status\n    pub fn get_invoices_by_dispute_status(\n        env: Env,\n        dispute_status: DisputeStatus,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        do_get_invoices_by_dispute_status(\u0026env, dispute_status)\n    }\n\n    /// Get dispute status for an invoice\n    pub fn get_invoice_dispute_status(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cDisputeStatus, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        Ok(invoice.dispute_status)\n    }\n\n    // Analytics and Reporting Functions\n\n    /// Get current platform metrics\n    pub fn get_platform_metrics(env: Env) -\u003e Result\u003cPlatformMetrics, QuickLendXError\u003e {\n        AnalyticsCalculator::calculate_platform_metrics(\u0026env)\n    }\n\n    /// Update platform metrics (admin only)\n    pub fn update_platform_metrics(env: Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let metrics = AnalyticsCalculator::calculate_platform_metrics(\u0026env)?;\n        AnalyticsStorage::store_platform_metrics(\u0026env, \u0026metrics);\n\n        // Emit event\n        events::emit_platform_metrics_updated(\n            \u0026env,\n            metrics.total_invoices,\n            metrics.total_volume,\n            metrics.total_fees_collected,\n            metrics.success_rate,\n        );\n\n        Ok(())\n    }\n\n    /// Get performance metrics\n    pub fn get_performance_metrics(env: Env) -\u003e Result\u003cPerformanceMetrics, QuickLendXError\u003e {\n        AnalyticsCalculator::calculate_performance_metrics(\u0026env)\n    }\n\n    /// Update performance metrics (admin only)\n    pub fn update_performance_metrics(env: Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let metrics = AnalyticsCalculator::calculate_performance_metrics(\u0026env)?;\n        AnalyticsStorage::store_performance_metrics(\u0026env, \u0026metrics);\n\n        // Emit event\n        events::emit_performance_metrics_updated(\n            \u0026env,\n            metrics.average_settlement_time,\n            metrics.transaction_success_rate,\n            metrics.user_satisfaction_score,\n        );\n\n        Ok(())\n    }\n\n    /// Get user behavior metrics\n    pub fn get_user_behavior_metrics(\n        env: Env,\n        user: Address,\n    ) -\u003e Result\u003cUserBehaviorMetrics, QuickLendXError\u003e {\n        AnalyticsCalculator::calculate_user_behavior_metrics(\u0026env, \u0026user)\n    }\n\n    /// Update user behavior metrics\n    pub fn update_user_behavior_metrics(env: Env, user: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        user.require_auth();\n\n        let behavior = AnalyticsCalculator::calculate_user_behavior_metrics(\u0026env, \u0026user)?;\n        AnalyticsStorage::store_user_behavior(\u0026env, \u0026user, \u0026behavior);\n\n        // Emit event\n        events::emit_user_behavior_analyzed(\n            \u0026env,\n            \u0026user,\n            behavior.total_investments_made,\n            behavior.success_rate,\n            behavior.risk_score,\n        );\n\n        Ok(())\n    }\n\n    /// Get financial metrics for a specific period\n    pub fn get_financial_metrics(\n        env: Env,\n        period: TimePeriod,\n    ) -\u003e Result\u003cFinancialMetrics, QuickLendXError\u003e {\n        let metrics = AnalyticsCalculator::calculate_financial_metrics(\u0026env, period.clone())?;\n\n        // Emit event\n        events::emit_financial_metrics_calculated(\n            \u0026env,\n            \u0026period,\n            metrics.total_volume,\n            metrics.total_fees,\n            metrics.average_return_rate,\n        );\n\n        Ok(metrics)\n    }\n\n    /// Generate business report\n    pub fn generate_business_report(\n        env: Env,\n        business: Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cBusinessReport, QuickLendXError\u003e {\n        business.require_auth();\n\n        let report =\n            AnalyticsCalculator::generate_business_report(\u0026env, \u0026business, period.clone())?;\n        AnalyticsStorage::store_business_report(\u0026env, \u0026report);\n\n        // Emit event\n        events::emit_business_report_generated(\n            \u0026env,\n            \u0026report.report_id,\n            \u0026business,\n            \u0026period,\n            report.invoices_uploaded,\n            report.success_rate,\n        );\n\n        Ok(report)\n    }\n\n    /// Generate investor report\n    pub fn generate_investor_report(\n        env: Env,\n        investor: Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cInvestorReport, QuickLendXError\u003e {\n        investor.require_auth();\n\n        let report =\n            AnalyticsCalculator::generate_investor_report(\u0026env, \u0026investor, period.clone())?;\n        AnalyticsStorage::store_investor_report(\u0026env, \u0026report);\n\n        // Emit event\n        events::emit_investor_report_generated(\n            \u0026env,\n            \u0026report.report_id,\n            \u0026investor,\n            \u0026period,\n            report.investments_made,\n            report.average_return_rate,\n        );\n\n        Ok(report)\n    }\n\n    /// Get business report by ID\n    pub fn get_business_report(env: Env, report_id: BytesN\u003c32\u003e) -\u003e Option\u003cBusinessReport\u003e {\n        AnalyticsStorage::get_business_report(\u0026env, \u0026report_id)\n    }\n\n    /// Get investor report by ID\n    pub fn get_investor_report(env: Env, report_id: BytesN\u003c32\u003e) -\u003e Option\u003cInvestorReport\u003e {\n        AnalyticsStorage::get_investor_report(\u0026env, \u0026report_id)\n    }\n\n    /// Get analytics data summary\n    pub fn get_analytics_summary(\n        env: Env,\n    ) -\u003e Result\u003c(PlatformMetrics, PerformanceMetrics), QuickLendXError\u003e {\n        let platform_metrics = AnalyticsStorage::get_platform_metrics(\u0026env)\n            .unwrap_or_else(|| AnalyticsCalculator::calculate_platform_metrics(\u0026env).unwrap());\n\n        let performance_metrics = AnalyticsStorage::get_performance_metrics(\u0026env)\n            .unwrap_or_else(|| AnalyticsCalculator::calculate_performance_metrics(\u0026env).unwrap());\n\n        Ok((platform_metrics, performance_metrics))\n    }\n\n    /// Export analytics data (admin only)\n    pub fn export_analytics_data(\n        env: Env,\n        export_type: String,\n        filters: Vec\u003cString\u003e,\n    ) -\u003e Result\u003cString, QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        // Emit event\n        events::emit_analytics_export(\u0026env, \u0026export_type, \u0026admin, filters.len() as u32);\n\n        // Return a summary string\n        Ok(String::from_str(\u0026env, \"Analytics data exported\"))\n    }\n\n    /// Query analytics data with filters\n    pub fn query_analytics_data(\n        env: Env,\n        query_type: String,\n        filters: Vec\u003cString\u003e,\n        limit: u32,\n    ) -\u003e Result\u003cVec\u003cString\u003e, QuickLendXError\u003e {\n        // Emit event\n        events::emit_analytics_query(\u0026env, \u0026query_type, filters.len() as u32, limit);\n\n        // Return basic analytics data\n        let mut results = Vec::new(\u0026env);\n        results.push_back(String::from_str(\u0026env, \"Analytics query completed\"));\n\n        Ok(results)\n    }\n\n    /// Get analytics trends over time\n    pub fn get_analytics_trends(\n        env: Env,\n        period: TimePeriod,\n        _metric_type: String,\n    ) -\u003e Result\u003cVec\u003c(u64, i128)\u003e, QuickLendXError\u003e {\n        let mut trends = Vec::new(\u0026env);\n        let current_timestamp = env.ledger().timestamp();\n\n        // Generate sample trend data based on period\n        let (start_date, _) =\n            AnalyticsCalculator::get_period_dates(current_timestamp, period.clone());\n        let interval = match period {\n            TimePeriod::Daily =\u003e 24 * 60 * 60,          // 1 day\n            TimePeriod::Weekly =\u003e 7 * 24 * 60 * 60,     // 1 week\n            TimePeriod::Monthly =\u003e 30 * 24 * 60 * 60,   // 1 month\n            TimePeriod::Quarterly =\u003e 90 * 24 * 60 * 60, // 1 quarter\n            TimePeriod::Yearly =\u003e 365 * 24 * 60 * 60,   // 1 year\n            TimePeriod::AllTime =\u003e current_timestamp - start_date,\n        };\n\n        let mut timestamp = start_date;\n        while timestamp \u003c current_timestamp {\n            // Calculate metrics for this time period\n            let period_metrics =\n                AnalyticsCalculator::calculate_financial_metrics(\u0026env, period.clone())?;\n\n            let value = period_metrics.total_volume;\n\n            trends.push_back((timestamp, value));\n            timestamp = timestamp.saturating_add(interval);\n        }\n\n        Ok(trends)\n    }\n\n    // ========================================\n    // Enhanced Investor Analytics Functions\n    // ========================================\n\n    /// Calculate comprehensive investor analytics\n    pub fn calculate_investor_analytics(\n        env: Env,\n        investor: Address,\n    ) -\u003e Result\u003cInvestorAnalytics, QuickLendXError\u003e {\n        let analytics = AnalyticsCalculator::calculate_investor_analytics(\u0026env, \u0026investor)?;\n        AnalyticsStorage::store_investor_analytics(\u0026env, \u0026investor, \u0026analytics);\n        Ok(analytics)\n    }\n\n    /// Get stored investor analytics\n    pub fn get_investor_analytics_data(env: Env, investor: Address) -\u003e Option\u003cInvestorAnalytics\u003e {\n        AnalyticsStorage::get_investor_analytics(\u0026env, \u0026investor)\n    }\n\n    /// Calculate investor performance metrics for the platform\n    pub fn calc_investor_perf_metrics(\n        env: Env,\n    ) -\u003e Result\u003cInvestorPerformanceMetrics, QuickLendXError\u003e {\n        let metrics = AnalyticsCalculator::calc_investor_perf_metrics(\u0026env)?;\n        AnalyticsStorage::store_investor_performance(\u0026env, \u0026metrics);\n        Ok(metrics)\n    }\n\n    /// Get stored investor performance metrics\n    pub fn get_investor_performance_metrics(env: Env) -\u003e Option\u003cInvestorPerformanceMetrics\u003e {\n        AnalyticsStorage::get_investor_performance(\u0026env)\n    }\n\n    /// Update investor analytics (admin only)\n    pub fn update_investor_analytics_data(\n        env: Env,\n        investor: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let analytics = AnalyticsCalculator::calculate_investor_analytics(\u0026env, \u0026investor)?;\n        AnalyticsStorage::store_investor_analytics(\u0026env, \u0026investor, \u0026analytics);\n\n        // Emit event\n        events::emit_investor_analytics_updated(\n            \u0026env,\n            \u0026investor,\n            analytics.success_rate,\n            analytics.risk_score,\n            analytics.compliance_score,\n        );\n\n        Ok(())\n    }\n\n    /// Update platform investor performance metrics (admin only)\n    pub fn update_investor_performance_data(env: Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let metrics = AnalyticsCalculator::calc_investor_perf_metrics(\u0026env)?;\n        AnalyticsStorage::store_investor_performance(\u0026env, \u0026metrics);\n\n        // Emit event\n        events::emit_investor_performance_updated(\n            \u0026env,\n            metrics.total_investors,\n            metrics.verified_investors,\n            metrics.platform_success_rate,\n            metrics.average_risk_score,\n        );\n\n        Ok(())\n    }\n    // ========================================\n    // Fee and Revenue Management Functions\n    // ========================================\n\n    /// Initialize fee management system\n    pub fn initialize_fee_system(env: Env, admin: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        fees::FeeManager::initialize(\u0026env, \u0026admin)\n    }\n\n    /// Update fee structure for a specific fee type\n    pub fn update_fee_structure(\n        env: Env,\n        admin: Address,\n        fee_type: fees::FeeType,\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n        is_active: bool,\n    ) -\u003e Result\u003cfees::FeeStructure, QuickLendXError\u003e {\n        fees::FeeManager::update_fee_structure(\n            \u0026env,\n            \u0026admin,\n            fee_type,\n            base_fee_bps,\n            min_fee,\n            max_fee,\n            is_active,\n        )\n    }\n\n    /// Get fee structure for a fee type\n    pub fn get_fee_structure(\n        env: Env,\n        fee_type: fees::FeeType,\n    ) -\u003e Result\u003cfees::FeeStructure, QuickLendXError\u003e {\n        fees::FeeManager::get_fee_structure(\u0026env, \u0026fee_type)\n    }\n\n    /// Calculate total fees for a transaction\n    pub fn calculate_transaction_fees(\n        env: Env,\n        user: Address,\n        transaction_amount: i128,\n        is_early_payment: bool,\n        is_late_payment: bool,\n    ) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        fees::FeeManager::calculate_total_fees(\n            \u0026env,\n            \u0026user,\n            transaction_amount,\n            is_early_payment,\n            is_late_payment,\n        )\n    }\n\n    /// Get user volume data and tier\n    pub fn get_user_volume_data(env: Env, user: Address) -\u003e fees::UserVolumeData {\n        fees::FeeManager::get_user_volume(\u0026env, \u0026user)\n    }\n\n    /// Update user volume (called internally after transactions)\n    pub fn update_user_transaction_volume(\n        env: Env,\n        user: Address,\n        transaction_amount: i128,\n    ) -\u003e Result\u003cfees::UserVolumeData, QuickLendXError\u003e {\n        fees::FeeManager::update_user_volume(\u0026env, \u0026user, transaction_amount)\n    }\n\n    /// Configure revenue distribution\n    pub fn configure_revenue_distribution(\n        env: Env,\n        admin: Address,\n        treasury_address: Address,\n        treasury_share_bps: u32,\n        developer_share_bps: u32,\n        platform_share_bps: u32,\n        auto_distribution: bool,\n        min_distribution_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let config = fees::RevenueConfig {\n            treasury_address,\n            treasury_share_bps,\n            developer_share_bps,\n            platform_share_bps,\n            auto_distribution,\n            min_distribution_amount,\n        };\n        fees::FeeManager::configure_revenue_distribution(\u0026env, \u0026admin, config)\n    }\n\n    /// Distribute revenue for a period\n    pub fn distribute_revenue(\n        env: Env,\n        admin: Address,\n        period: u64,\n    ) -\u003e Result\u003c(i128, i128, i128), QuickLendXError\u003e {\n        fees::FeeManager::distribute_revenue(\u0026env, \u0026admin, period)\n    }\n\n    /// Get fee analytics for a period\n    pub fn get_fee_analytics(env: Env, period: u64) -\u003e Result\u003cfees::FeeAnalytics, QuickLendXError\u003e {\n        fees::FeeManager::get_analytics(\u0026env, period)\n    }\n\n    /// Collect fees (internal function called after fee calculation)\n    pub fn collect_transaction_fees(\n        env: Env,\n        user: Address,\n        fees_by_type: Map\u003cfees::FeeType, i128\u003e,\n        total_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        fees::FeeManager::collect_fees(\u0026env, \u0026user, fees_by_type, total_amount)\n    }\n\n    /// Validate fee parameters\n    pub fn validate_fee_parameters(\n        _env: Env,\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        fees::FeeManager::validate_fee_params(base_fee_bps, min_fee, max_fee)\n    }\n}\n\n#[cfg(test)]\nmod test;\n\n#[cfg(test)]\nmod test_bid;\n\n#[cfg(test)]\nmod test_escrow;\n\n#[cfg(test)]\nmod test_partial_payments;\n","traces":[{"line":72,"address":[19930152],"length":1,"stats":{"Line":0}},{"line":74,"address":[16290915,16291292,16288560],"length":1,"stats":{"Line":1}},{"line":85,"address":[19931824],"length":1,"stats":{"Line":2}},{"line":86,"address":[31458221,31455603,31458402,31458205],"length":1,"stats":{"Line":1}},{"line":89,"address":[16288843,16288775],"length":1,"stats":{"Line":3}},{"line":90,"address":[16288953],"length":1,"stats":{"Line":2}},{"line":91,"address":[20587859],"length":1,"stats":{"Line":1}},{"line":94,"address":[42428212],"length":1,"stats":{"Line":4}},{"line":95,"address":[16289030],"length":1,"stats":{"Line":1}},{"line":104,"address":[16289014,16289049,16290998],"length":1,"stats":{"Line":2}},{"line":105,"address":[42436336],"length":1,"stats":{"Line":2}},{"line":109,"address":[41612724,41612484,41613047,41613825,41614038,41612567],"length":1,"stats":{"Line":1}},{"line":110,"address":[41614109,41612535,41612731,41613854,41612615,41613055],"length":1,"stats":{"Line":3}},{"line":111,"address":[41612583,41613063,41614177,41612655,41612738,41613883],"length":1,"stats":{"Line":0}},{"line":112,"address":[16289286],"length":1,"stats":{"Line":2}},{"line":113,"address":[31460743],"length":1,"stats":{"Line":0}},{"line":114,"address":[31460816],"length":1,"stats":{"Line":2}},{"line":115,"address":[31460771],"length":1,"stats":{"Line":0}},{"line":116,"address":[16289413],"length":1,"stats":{"Line":2}},{"line":120,"address":[31430635],"length":1,"stats":{"Line":2}},{"line":123,"address":[16289617,16290027],"length":1,"stats":{"Line":7}},{"line":124,"address":[42436994,42437043],"length":1,"stats":{"Line":4}},{"line":125,"address":[16289677,16289773],"length":1,"stats":{"Line":7}},{"line":128,"address":[42437056],"length":1,"stats":{"Line":4}},{"line":132,"address":[31462362,31461965,31461796],"length":1,"stats":{"Line":0}},{"line":143,"address":[16296300],"length":1,"stats":{"Line":0}},{"line":146,"address":[31460306],"length":1,"stats":{"Line":0}},{"line":147,"address":[16296433,16296486],"length":1,"stats":{"Line":0}},{"line":148,"address":[42366488],"length":1,"stats":{"Line":0}},{"line":149,"address":[32325996,32298470],"length":1,"stats":{"Line":0}},{"line":150,"address":[32298553,32326064],"length":1,"stats":{"Line":0}},{"line":153,"address":[25530288],"length":1,"stats":{"Line":0}},{"line":157,"address":[16296670,16298504],"length":1,"stats":{"Line":0}},{"line":160,"address":[32326593,32299383],"length":1,"stats":{"Line":5}},{"line":161,"address":[45247644,45220922],"length":1,"stats":{"Line":0}},{"line":165,"address":[45247916,45221254],"length":1,"stats":{"Line":1}},{"line":166,"address":[27182158,27182222,27182094,27182126],"length":1,"stats":{"Line":2}},{"line":167,"address":[20570802,20574324,20572562,20583138,20576074,20577842,20581370,20579608],"length":1,"stats":{"Line":1}},{"line":168,"address":[16297098,16297042],"length":1,"stats":{"Line":0}},{"line":169,"address":[27004960,27005300,27006928,27006592,27008950,27007648,26990279,27004263,27000592,26988880,27006567,27008565,26993456,27005664,27009328,27009669,27007312,26996739,26991760,27008224,27009316,27008199,27008976,27007632,27002499,27006004,26995152,26987331,26998579,27007286,27005312,27006016,27006912,27008592,26985792,27005652],"length":1,"stats":{"Line":1}},{"line":170,"address":[27005341,27006619,27006083,27007339,27008256,27008627,27009005,27006963,27009360,27007715,27004989,27005693],"length":1,"stats":{"Line":1}},{"line":171,"address":[27182053,27182021,27181989,27182181],"length":1,"stats":{"Line":0}},{"line":172,"address":[27182000,27182032,27182192,27182064],"length":1,"stats":{"Line":0}},{"line":174,"address":[31460909],"length":1,"stats":{"Line":1}},{"line":175,"address":[32300628,32327613],"length":1,"stats":{"Line":0}},{"line":178,"address":[42428497,42428285,42428343],"length":1,"stats":{"Line":0}},{"line":180,"address":[16297445],"length":1,"stats":{"Line":0}},{"line":184,"address":[32301481,32328105],"length":1,"stats":{"Line":8}},{"line":185,"address":[45249149,45223054],"length":1,"stats":{"Line":5}},{"line":187,"address":[33508672,33509560,33508704,33508021,33509520,33509812,33508016,33509792],"length":1,"stats":{"Line":2}},{"line":189,"address":[20578575,20582126,20583871,20575006,20573321,20573244,20575083,20576753,20580338,20580367,20583822,20578526,20571484,20576801,20576830,20575054,20580290,20578604,20573292,20583900,20571561,20582049,20571532,20582097],"length":1,"stats":{"Line":3}},{"line":190,"address":[42773157,42773054,42772718,42773317,42773358,42772669,42773413,42772862,42772957,42773502,42772798,42772581,42773013,42773246,42772629,42773109,42773454,42773573,42772533,42773205,42772926],"length":1,"stats":{"Line":1}},{"line":192,"address":[31437104],"length":1,"stats":{"Line":3}},{"line":193,"address":[17147437],"length":1,"stats":{"Line":0}},{"line":198,"address":[16299382],"length":1,"stats":{"Line":1}},{"line":200,"address":[45571808],"length":1,"stats":{"Line":2}},{"line":201,"address":[31461673],"length":1,"stats":{"Line":1}},{"line":205,"address":[31459760],"length":1,"stats":{"Line":2}},{"line":207,"address":[20571751,20573484,20578794,20584090,20576993,20582316,20582289,20575246,20584063,20580530,20575273,20577020,20573511,20571724,20578767,20580557],"length":1,"stats":{"Line":2}},{"line":210,"address":[33526224,33526624,33526647,33525568,33526299,33526248,33526387,33526762,33525573,33526848,33526872,33526705,33526935],"length":1,"stats":{"Line":1}},{"line":213,"address":[16299541],"length":1,"stats":{"Line":1}},{"line":214,"address":[26493705],"length":1,"stats":{"Line":0}},{"line":217,"address":[16299577],"length":1,"stats":{"Line":2}},{"line":221,"address":[16293025,16293054,16292304],"length":1,"stats":{"Line":0}},{"line":222,"address":[26493243,26493212],"length":1,"stats":{"Line":1}},{"line":223,"address":[26493238],"length":1,"stats":{"Line":0}},{"line":226,"address":[33527840],"length":1,"stats":{"Line":0}},{"line":229,"address":[16292645],"length":1,"stats":{"Line":0}},{"line":232,"address":[16292660,16292993],"length":1,"stats":{"Line":1}},{"line":235,"address":[45550038,45546374],"length":1,"stats":{"Line":0}},{"line":238,"address":[20587779,20587811],"length":1,"stats":{"Line":2}},{"line":241,"address":[45543166,45546871],"length":1,"stats":{"Line":0}},{"line":245,"address":[33525897],"length":1,"stats":{"Line":1}},{"line":246,"address":[31458035],"length":1,"stats":{"Line":0}},{"line":247,"address":[27208339,27261342,27208302,27182483,27182446,27234990,27261379,27235027],"length":1,"stats":{"Line":4}},{"line":248,"address":[41983918],"length":1,"stats":{"Line":3}},{"line":251,"address":[33501619,33507936,33502037,33502032,33501584,33501600,33501589,33507946],"length":1,"stats":{"Line":2}},{"line":255,"address":[45542754,45546498],"length":1,"stats":{"Line":1}},{"line":256,"address":[42267488],"length":1,"stats":{"Line":3}},{"line":260,"address":[42241920],"length":1,"stats":{"Line":49}},{"line":261,"address":[27187809,27189811,27192566,27214816,27267725,27244025,27244793,27266002,27267972,27270189,27271668,27241215,27193343,27192315,27245046,27245814,27266061,27187059,27187558,27216640,27241727,27188311,27189563,27188810,27245558,27242492,27216118,27269204,27218722,27217942,27218983,27189312,27241471,27243260,27267234,27212995,27242239,27190564,27214555,27240962,27243769,27190313,27192067,27219526,27242748,27266246,27218203,27266740,27270436,27268219,27215338,27268710,27216901,27189061,27243516,27190815,27271421,27272187,27266987,27191565,27270930,27217159,27213054,27239744,27240706,27246091,27191063,27271915,27270683,27239938,27188060,27218461,27217420,27213514,27215857,27213253,27191314,27240194,27214036,27266493,27192817,27243004,27193068,27241983,27268957,27187307,27245302,27244281,27187118,27269698,27271174,27190062,27217681,27219244,27269942,27188559,27215077,27244537,27268466,27213775,27269451,27191816,27214297,27239685,27215599,27240450,27267478,27216379],"length":1,"stats":{"Line":37}},{"line":265,"address":[20584754,20586350],"length":1,"stats":{"Line":2}},{"line":266,"address":[27193273,27246019,27219454,27272117],"length":1,"stats":{"Line":5}},{"line":270,"address":[16327215,16326240,16326880],"length":1,"stats":{"Line":36}},{"line":275,"address":[45549674,45543878,45546008,45547577],"length":1,"stats":{"Line":15}},{"line":276,"address":[16326417,16326359],"length":1,"stats":{"Line":0}},{"line":278,"address":[27284331,27230056,27259697,27205735,27281233,27206715,27255467,27254840,27203470,27226728,27282782,27230013,27233927,27253178,27256459,27280583,27257086,27230692,27283681,27283724,27285267,27279034,27206678,27228349,27226685,27229028,27279684,27205074,27231720,27260300,27203513,27259654,27279077,27207267,27282175,27200262,27285230,27285808,27201866,27232356,27233372,27258705,27227364,27200305,27254797,27228392,27256416,27258035,27233335,27253848,27282132,27258078,27200923,27204131,27202527,27231677,27201909,27253221,27280626,27205117],"length":1,"stats":{"Line":15}},{"line":279,"address":[16326580,16327148],"length":1,"stats":{"Line":0}},{"line":281,"address":[27010364,27010051,27009786,27010156,27010262,27009878],"length":1,"stats":{"Line":0}},{"line":282,"address":[27253926,27279760,27259386,27228072,27233813,27256148,27258984,27255746,27227442,27259185,27283047,27284974,27285710,27200799,27205811,27202803,27253725,27260192,27281309,27281687,27201399,27234545,27257566,27282669,27228896,27204807,27284596,27229526,27203203,27234362,27258783,27230980,27260900,27232434,27233064,27233996,27254529,27256963,27279571,27286034,27281120,27286196,27206211,27229736,27260723,27227652,27230560,27286358,27255344,27281876,27205611,27230770,27200999,27229106,27234179,27257164,27257365,27280138,27231190,27280327,27285872,27202603,27283425,27284218,27207686,27207510,27204607,27206011,27231400,27232854,27255947,27257767,27229316,27227232,27281498,27283236,27284407,27204007,27260546,27204207,27206411,27201199,27255545,27260369,27279949,27204407,27203003,27207334,27284785,27258582,27232224,27232644,27254127,27207158,27282858,27207862,27201599,27227862,27202403,27254328],"length":1,"stats":{"Line":40}},{"line":285,"address":[45545911,45549576],"length":1,"stats":{"Line":0}},{"line":286,"address":[16326951],"length":1,"stats":{"Line":0}},{"line":287,"address":[16326968],"length":1,"stats":{"Line":0}},{"line":289,"address":[27208043,27234733,27286528,27261080],"length":1,"stats":{"Line":3}},{"line":290,"address":[45545971,45549636],"length":1,"stats":{"Line":0}},{"line":294,"address":[42284146],"length":1,"stats":{"Line":0}},{"line":295,"address":[42755920],"length":1,"stats":{"Line":0}},{"line":296,"address":[42284200],"length":1,"stats":{"Line":0}},{"line":298,"address":[16321795],"length":1,"stats":{"Line":0}},{"line":300,"address":[16321864],"length":1,"stats":{"Line":0}},{"line":301,"address":[42284343],"length":1,"stats":{"Line":0}},{"line":302,"address":[20587349,20585753],"length":1,"stats":{"Line":0}},{"line":303,"address":[27012160,27012485,27011856,27011536,27012176,27010384,27010848,27011173,27011517,27011832,27010864,27011200],"length":1,"stats":{"Line":0}},{"line":304,"address":[45544148,45547841],"length":1,"stats":{"Line":0}},{"line":307,"address":[45544266,45547958],"length":1,"stats":{"Line":0}},{"line":311,"address":[44023635],"length":1,"stats":{"Line":0}},{"line":312,"address":[16332213],"length":1,"stats":{"Line":0}},{"line":316,"address":[20585995,20587591],"length":1,"stats":{"Line":0}},{"line":317,"address":[42758283,42753433,42753892,42755252,42757301,42755707,42752621,42754793,42752205,42756741,42754347,42757819],"length":1,"stats":{"Line":0}},{"line":321,"address":[31363329],"length":1,"stats":{"Line":0}},{"line":322,"address":[31363528],"length":1,"stats":{"Line":0}},{"line":326,"address":[31363651],"length":1,"stats":{"Line":1}},{"line":327,"address":[45544543,45548229],"length":1,"stats":{"Line":0}},{"line":331,"address":[42285831],"length":1,"stats":{"Line":0}},{"line":336,"address":[42427984],"length":1,"stats":{"Line":0}},{"line":337,"address":[45228416,45251532],"length":1,"stats":{"Line":0}},{"line":340,"address":[16320027],"length":1,"stats":{"Line":0}},{"line":343,"address":[45251633,45228633],"length":1,"stats":{"Line":1}},{"line":344,"address":[45228716,45251673],"length":1,"stats":{"Line":0}},{"line":345,"address":[45251713,45228799],"length":1,"stats":{"Line":0}},{"line":346,"address":[45251753,45228882],"length":1,"stats":{"Line":3}},{"line":348,"address":[31391534],"length":1,"stats":{"Line":6}},{"line":349,"address":[32330658,32307196],"length":1,"stats":{"Line":0}},{"line":351,"address":[31391581],"length":1,"stats":{"Line":0}},{"line":352,"address":[31363854],"length":1,"stats":{"Line":3}},{"line":353,"address":[27015184,27013504,27014704,27015008,27015158,27013958,27014128,27013664,27014256,27014400,27014681,27015311,27014112,27014416,27014848,27014537,27013680,27014272,27014560,27013984,27015024,27013808,27013824,27014831],"length":1,"stats":{"Line":0}},{"line":354,"address":[31428347,31428105,31427766,31427852,31428198,31428262,31428716,31429051,31429089,31428502,31429157,31428854,31429017,31428409],"length":1,"stats":{"Line":0}},{"line":355,"address":[42753185,42753009],"length":1,"stats":{"Line":2}},{"line":358,"address":[27013803,27015306,27014826,27014395,27015003,27014532,27013659,27014676,27015153,27014251,27013953,27014107],"length":1,"stats":{"Line":0}},{"line":362,"address":[31428576,31427680,31427952,31428912,31427888,31428000],"length":1,"stats":{"Line":1}},{"line":365,"address":[31427721,31428045,31428636,31428957,31427990,31427933],"length":1,"stats":{"Line":2}},{"line":368,"address":[32331180,32308060],"length":1,"stats":{"Line":0}},{"line":369,"address":[41845840,41845920,41846000,41846080,41846160,41846240],"length":1,"stats":{"Line":3}},{"line":370,"address":[31360577],"length":1,"stats":{"Line":3}},{"line":374,"address":[32331588,32308558],"length":1,"stats":{"Line":0}},{"line":375,"address":[31360720],"length":1,"stats":{"Line":1}},{"line":376,"address":[31429071,31429025],"length":1,"stats":{"Line":2}},{"line":378,"address":[32308890,32331860],"length":1,"stats":{"Line":3}},{"line":379,"address":[45549259,45545593],"length":1,"stats":{"Line":3}},{"line":381,"address":[45253475,45231074],"length":1,"stats":{"Line":6}},{"line":382,"address":[45231157,45253543],"length":1,"stats":{"Line":6}},{"line":384,"address":[17149453],"length":1,"stats":{"Line":7}},{"line":387,"address":[32309637,32332472],"length":1,"stats":{"Line":0}},{"line":391,"address":[45231904,45254155],"length":1,"stats":{"Line":0}},{"line":392,"address":[16336636],"length":1,"stats":{"Line":0}},{"line":393,"address":[16336680],"length":1,"stats":{"Line":1}},{"line":397,"address":[16324880,16324288],"length":1,"stats":{"Line":1}},{"line":398,"address":[32310550,32333220],"length":1,"stats":{"Line":2}},{"line":399,"address":[32310633,32333288],"length":1,"stats":{"Line":0}},{"line":400,"address":[31404000],"length":1,"stats":{"Line":0}},{"line":401,"address":[45232734,45254835],"length":1,"stats":{"Line":0}},{"line":402,"address":[41849283,41854192,41854352,41854512,41854672,41847971,41854992,41849939,41853875,41855152,41855952,41852563,41851251,41855312,41855632,41855792,41848627,41850595,41855472,41854832,41847315,41846659,41853219,41851907],"length":1,"stats":{"Line":2}},{"line":403,"address":[42744192],"length":1,"stats":{"Line":2}},{"line":405,"address":[32311131,32333696],"length":1,"stats":{"Line":1}},{"line":409,"address":[42744273],"length":1,"stats":{"Line":0}},{"line":410,"address":[32334036,32311546],"length":1,"stats":{"Line":0}},{"line":414,"address":[16284575,16284448],"length":1,"stats":{"Line":0}},{"line":415,"address":[45255787,45233896],"length":1,"stats":{"Line":1}},{"line":419,"address":[32312293,32334648],"length":1,"stats":{"Line":1}},{"line":420,"address":[32334716,32312376],"length":1,"stats":{"Line":2}},{"line":424,"address":[32312708,32334988],"length":1,"stats":{"Line":0}},{"line":425,"address":[32335056,32312791],"length":1,"stats":{"Line":2}},{"line":429,"address":[41885627,41880806,41884491,41890171,41879670,41878811,41882219,41883078,41883355,41878534,41886486,41888758,41891307,41881083,41884214,41886763,41881942,41885350,41887899,41879947,41889035,41887622,41889894,41891030],"length":1,"stats":{"Line":1}},{"line":430,"address":[45234726,45256467],"length":1,"stats":{"Line":0}},{"line":436,"address":[32313289,32335464],"length":1,"stats":{"Line":0}},{"line":437,"address":[32313372,32335532],"length":1,"stats":{"Line":1}},{"line":441,"address":[45235639,45257215],"length":1,"stats":{"Line":2}},{"line":442,"address":[16313341],"length":1,"stats":{"Line":1}},{"line":452,"address":[45236976,45258182],"length":1,"stats":{"Line":1}},{"line":460,"address":[45258502,45237640],"length":1,"stats":{"Line":1}},{"line":463,"address":[45258622,45237889],"length":1,"stats":{"Line":1}},{"line":464,"address":[16346918],"length":1,"stats":{"Line":0}},{"line":468,"address":[16348938,16346903,16346977,16347034],"length":1,"stats":{"Line":2}},{"line":469,"address":[31477231],"length":1,"stats":{"Line":1}},{"line":470,"address":[27017555,27021923,27035781,27027587,27044563,27024915],"length":1,"stats":{"Line":2}},{"line":471,"address":[31477415],"length":1,"stats":{"Line":0}},{"line":474,"address":[16347215,16348920,16347289,16347346],"length":1,"stats":{"Line":3}},{"line":475,"address":[42269058,42268642,42267810,42269474,42269890,42268226],"length":1,"stats":{"Line":1}},{"line":476,"address":[16347433],"length":1,"stats":{"Line":1}},{"line":477,"address":[33518590],"length":1,"stats":{"Line":0}},{"line":478,"address":[16347506],"length":1,"stats":{"Line":1}},{"line":479,"address":[27027056,27029984,27024320,27019744,27040272,27046960],"length":1,"stats":{"Line":0}},{"line":482,"address":[16347478],"length":1,"stats":{"Line":3}},{"line":483,"address":[42105678,42105774,42105806,42105838,42105742,42105710],"length":1,"stats":{"Line":2}},{"line":484,"address":[16347540],"length":1,"stats":{"Line":0}},{"line":488,"address":[41876340,41876532,41876916,41875764,41876148,41877492,41875572,41876724,41875380,41877300,41877108,41875956],"length":1,"stats":{"Line":2}},{"line":489,"address":[41875681,41876257,41875489,41876833,41876449,41876065,41876641,41877025,41877409,41877217,41875873,41877601],"length":1,"stats":{"Line":4}},{"line":491,"address":[16347820],"length":1,"stats":{"Line":1}},{"line":492,"address":[16347848,16347896],"length":1,"stats":{"Line":4}},{"line":494,"address":[41982923,41981941,41982107,41982277,41983253,41983429,41983083,41983605,41982443,41981765,41982603,41982763],"length":1,"stats":{"Line":4}},{"line":495,"address":[27045630,27018554,27025882,27028654,27023006,27037573],"length":1,"stats":{"Line":2}},{"line":496,"address":[16348101],"length":1,"stats":{"Line":1}},{"line":501,"address":[16348154],"length":1,"stats":{"Line":1}},{"line":503,"address":[16348462],"length":1,"stats":{"Line":4}},{"line":505,"address":[31468078],"length":1,"stats":{"Line":1}},{"line":508,"address":[16348547],"length":1,"stats":{"Line":2}},{"line":511,"address":[16348575],"length":1,"stats":{"Line":1}},{"line":513,"address":[16348590],"length":1,"stats":{"Line":1}},{"line":517,"address":[42741963],"length":1,"stats":{"Line":2}},{"line":522,"address":[42742160],"length":1,"stats":{"Line":4}},{"line":523,"address":[27019075,27045943,27038773,27038340,27038945,27026158,27046120,27046202,27023580,27026311,27029144,27018840,27023321,27018998,27023498,27028967,27029226,27026387],"length":1,"stats":{"Line":7}},{"line":524,"address":[33510286],"length":1,"stats":{"Line":5}},{"line":525,"address":[27029231,27046184,27038817,27023526,27046207,27019024,27029208,27038950,27038868,27023564,27026337,27026392,27023585,27019062,27019080,27029172,27026374,27046148],"length":1,"stats":{"Line":6}},{"line":526,"address":[31436212,31434038,31434862,31434453,31433248,31435669,31436836,31432832,31433646,31435254],"length":1,"stats":{"Line":3}},{"line":527,"address":[27018968,27023380,27029083,27046059,27029028,27038679,27026211,27026257,27026281,27046004,27018943,27038629,27038498,27023465,27029109,27023439,27046085,27018893],"length":1,"stats":{"Line":4}},{"line":528,"address":[27023444,27023503,27046102,27026316,27029088,27029126,27026298,27038645,27029149,27046125,27018985,27023482,27026261,27038696,27046064,27018947,27019003,27038778],"length":1,"stats":{"Line":5}},{"line":531,"address":[33509936],"length":1,"stats":{"Line":3}},{"line":533,"address":[31433900,31436581,31434719,31435116,31435957,31432696,31433503,31434296,31433112,31435512],"length":1,"stats":{"Line":4}},{"line":534,"address":[31433910,31433517,31435126,31436617,31433125,31435526,31434733,31435993,31434310,31432709],"length":1,"stats":{"Line":0}},{"line":539,"address":[33510095],"length":1,"stats":{"Line":1}},{"line":540,"address":[42116392,42173618,42185490,42183442,42155808,42130168,42143987,42203059,42157760,42201112,42205059,42177624,42147939,42136082,42159712,42193426,42189395,42187448,42197296,42169552,42124400,42151856,42149904,42126352,42163688,42191395,42195384,42140040,42120370,42128280,42167587,42161730,42141987,42165600,42171570,42199224,42145952,42112403,42175666,42114434,42122418,42118339,42179536,42181464,42132146,42153843,42138099,42134104],"length":1,"stats":{"Line":0}},{"line":541,"address":[16281983],"length":1,"stats":{"Line":3}},{"line":542,"address":[42130312,42185816,42157904,42122744,42142131,42153987,42167900,42173762,42175992,42183768,42132290,42165883,42185634,42193570,42201382,42203372,42205203,42199368,42134374,42112716,42146096,42128550,42152000,42152139,42189539,42159856,42199494,42183586,42203203,42120696,42161874,42179680,42118652,42140310,42159995,42150187,42171896,42154156,42116536,42116662,42148083,42197579,42171714,42201256,42187718,42146235,42177894,42179819,42195654,42114578,42118483,42197440,42177768,42114760,42181734,42193752,42156091,42136226,42126635,42144300,42130438,42165744,42138243,42158043,42169835,42187592,42191539,42136408,42189708,42175810,42138412,42150048,42124683,42142300,42132472,42162056,42167731,42205372,42173944,42195528,42112547,42124544,42126496,42122562,42148252,42140184,42144131,42128424,42163832,42134248,42169696,42181608,42191708,42120514,42163958,42155952],"length":1,"stats":{"Line":3}},{"line":543,"address":[33510131],"length":1,"stats":{"Line":3}},{"line":544,"address":[16282015],"length":1,"stats":{"Line":3}},{"line":547,"address":[16282245],"length":1,"stats":{"Line":3}},{"line":548,"address":[42152669,42190275,42176602,42150754,42180386,42186377,42142916,42142830,42134935,42129074,42164482,42174468,42184378,42174554,42172506,42119182,42194313,42148819,42123305,42152755,42176553,42134898,42170402,42152706,42138979,42130962,42136932,42123354,42130999,42113332,42132996,42148868,42186426,42121257,42192238,42198109,42201906,42156658,42154772,42148782,42178455,42203902,42131048,42136969,42134984,42123268,42166450,42158659,42168516,42192324,42205902,42180349,42137018,42162617,42156621,42138942,42115321,42146765,42188328,42133082,42188242,42162666,42115370,42190238,42119219,42198195,42158610,42160611,42164519,42119268,42154723,42203939,42178418,42182295,42188279,42178504,42164568,42170365,42125299,42172457,42140834,42127251,42156707,42133033,42146802,42182344,42203988,42117272,42196264,42194362,42113246,42125213,42196178,42127165,42190324,42117186,42196215,42139028,42121306,42144830,42205988,42176516,42144916,42113283,42142867,42166413,42198146,42150717,42200018,42201992,42184329,42200055,42125250,42158573,42144867,42180435,42201943,42140871,42129160,42162580,42115284,42174505,42166499,42121220,42117223,42140920,42182258,42127202,42168430,42150803,42186340,42205939,42146851,42168467,42154686,42160525,42192275,42194276,42200104,42172420,42170451,42184292,42160562,42129111],"length":1,"stats":{"Line":3}},{"line":550,"address":[42131154,42127357,42113438,42194468,42121412,42141026,42133188,42180541,42176708,42137124,42162772,42186532,42196370,42115476,42200210,42135090,42170557,42190430,42202098,42143022,42166605,42154878,42160717,42148974,42150909,42156813,42158765,42192430,42206094,42174660,42146957,42152861,42117378,42119374,42129266,42123460,42168622,42188434,42125405,42139134,42198301,42145022,42182450,42184484,42204094,42164674,42172612,42178610],"length":1,"stats":{"Line":3}},{"line":551,"address":[27046310,27039127,27026485,27023686,27029334,27019173],"length":1,"stats":{"Line":0}},{"line":552,"address":[42166716,42202206,42113549,42123568,42176816,42184592,42127468,42174768,42137232,42182558,42200318,42206205,42164782,42139245,42156924,42178718,42147068,42188542,42180652,42135198,42170668,42151020,42186640,42154989,42133296,42172720,42143133,42125516,42192541,42141134,42158876,42204205,42162880,42115584,42152972,42168733,42198412,42119485,42117486,42145133,42121520,42131262,42129374,42149085,42194576,42190541,42160828,42196478],"length":1,"stats":{"Line":3}},{"line":553,"address":[16282351],"length":1,"stats":{"Line":3}},{"line":554,"address":[16282436,16282385],"length":1,"stats":{"Line":6}},{"line":556,"address":[33510197],"length":1,"stats":{"Line":3}},{"line":558,"address":[42151610,42118051,42169303,42183123,42200883,42149655,42191111,42167306,42133881,42124153,42128058,42153562,42165347,42175353,42129939,42157514,42161418,42187225,42189107,42163465,42177401,42199002,42179283,42135763,42131827,42195161,42155559,42137817,42193111,42114119,42204775,42120055,42141699,42171258,42173305,42139815,42143703,42122105,42145703,42147658,42181242,42202771,42197043,42116169,42126106,42159466,42185177,42206775],"length":1,"stats":{"Line":3}},{"line":560,"address":[31473079],"length":1,"stats":{"Line":4}},{"line":561,"address":[16282699],"length":1,"stats":{"Line":2}},{"line":562,"address":[16282767],"length":1,"stats":{"Line":1}},{"line":563,"address":[16282839],"length":1,"stats":{"Line":3}},{"line":564,"address":[31439686],"length":1,"stats":{"Line":3}},{"line":566,"address":[42003009,42003441,42001713,42001281,41999985,41999121,42002577,42000417,42002145,42003873,41999553,42000849],"length":1,"stats":{"Line":2}},{"line":568,"address":[42002034,41999947,42002466,42002971,42003835,42001337,42001769,42002539,42000379,42000811,41999609,42002633,42001170,42000306,42004194,42003403,42001243,42003929,42004267,41999442,41999177,42002107,41999874,42000473,42003330,41999515,42003065,42003762,42003497,42000905,42001675,42000041,42002898,42000738,42001602,42002201],"length":1,"stats":{"Line":2}},{"line":570,"address":[16283357],"length":1,"stats":{"Line":5}},{"line":572,"address":[16283422],"length":1,"stats":{"Line":3}},{"line":575,"address":[33510366],"length":1,"stats":{"Line":3}},{"line":579,"address":[33510378],"length":1,"stats":{"Line":0}},{"line":580,"address":[41909743,41910303,41909407,41909631,41909519,41910191,41910415,41910527,41909855,41909967,41909295,41910079],"length":1,"stats":{"Line":1}},{"line":581,"address":[41909549,41910109,41909325,41909437,41910221,41910445,41909661,41909773,41910557,41909997,41909885,41910333],"length":1,"stats":{"Line":1}},{"line":582,"address":[41909693,41910253,41910365,41910477,41909469,41910141,41909581,41910589,41909805,41910029,41909917,41909357],"length":1,"stats":{"Line":1}},{"line":585,"address":[16283537],"length":1,"stats":{"Line":1}},{"line":588,"address":[16328112,16329152,16329200],"length":1,"stats":{"Line":1}},{"line":594,"address":[16328171,16329162,16328266,16328314],"length":1,"stats":{"Line":1}},{"line":595,"address":[16328300,16328243],"length":1,"stats":{"Line":0}},{"line":597,"address":[41990501,41989717,41984229,41985013,41986581,41992069,41987365,41988149,41991285,41992853,41988933,41985797],"length":1,"stats":{"Line":1}},{"line":599,"address":[41998849,41998545,41995441,41998727,41997319,41996967,41998193,41994455,41994103,41994967,41998071,41998423,41995089,41994225,41995783,41995319,41994577,41996135,41996257,41996551,41996673,41997089,41997441,41995905],"length":1,"stats":{"Line":0}},{"line":600,"address":[41997112,41995464,41996280,41995570,41994706,41998322,41997414,41998166,41994600,41996802,41996386,41998568,41995062,41994354,41995878,41995218,41998822,41998872,41994248,41995112,41995414,41994198,41996696,41998978,41996230,41995928,41998674,41997062,41996646,41996034,41998518,41997464,41997218,41994550,41998216,41997570],"length":1,"stats":{"Line":0}},{"line":603,"address":[41991417,41984361,41986713,41994880,41995232,41988281,41993904,41989065,41994720,41990633,41997253,41995253,41985145,41996048,41998357,41993925,41992985,41996069,41997232,41985929,41993648,41993808,41994389,41993877,41987497,41994368,41994741,41993856,41992201,41995584,41993669,41989849,41993829,41994901,41998336,41995605],"length":1,"stats":{"Line":1}},{"line":604,"address":[41984667,41989493,41992453,41993413,41991061,41988587,41986181,41986965,41991723,41989371,41988533,41989317,41992507,41991845,41986235,41987019,41987141,41984789,41985451,41990101,41990155,41990277,41990939,41990885,41985397,41987925,41991669,41987749,41988709,41992629,41993237,41984613,41985573,41987803,41986357,41993291],"length":1,"stats":{"Line":2}},{"line":605,"address":[41997584,41996816,41997696,41993696,41993349,41993536,41997948,41993258,41999020,41996400,41988645,41990213,41984634,41986293,41990122,41991690,41995632,41993724,41993980,41985418,41997612,41987077,41989338,41985509,41992565,41997724,41997808,41984725,41993564,41994796,41997836,41992474,41997920,41987770,41998992,41996844,41991781,41986986,41990906,41993952,41987861,41986202,41990997,41988554,41994768,41995660,41996428,41989429],"length":1,"stats":{"Line":1}},{"line":608,"address":[27037320,27018424,27025752,27045496,27022872,27028520],"length":1,"stats":{"Line":0}},{"line":611,"address":[16328809],"length":1,"stats":{"Line":0}},{"line":614,"address":[27045559,27018482,27037474,27045586,27022951,27037459,27018507,27022939,27028595,27028610,27018492,27022966,27025818,27028583,27025808,27037437,27045571,27025833],"length":1,"stats":{"Line":1}},{"line":616,"address":[17147925,17147948],"length":1,"stats":{"Line":0}},{"line":617,"address":[41955667,41963155,41948179,41965651,41913235,41933203,41910739,41938195,41950675,41958163,41968147,41923219,41940691,41928211,41953171,41943187,41960659,41935699,41915731,41930707,41920723,41918227,41945683,41925715],"length":1,"stats":{"Line":1}},{"line":618,"address":[41923284,41945748,41955732,41958228,41960724,41968212,41963220,41925780,41930772,41940756,41918292,41915796,41950740,41965716,41910804,41935764,41928276,41913300,41953236,41948244,41933268,41938260,41920788,41943252],"length":1,"stats":{"Line":1}},{"line":620,"address":[17140944],"length":1,"stats":{"Line":0}},{"line":621,"address":[41955915,41960907,41965899,41950923,41918475,41920971,41928459,41963403,41968395,41938443,41940939,41945931,41910987,41925963,41923467,41915979,41930955,41933451,41948427,41953419,41958411,41913483,41935947,41943435],"length":1,"stats":{"Line":0}},{"line":623,"address":[16328931],"length":1,"stats":{"Line":0}},{"line":625,"address":[17141408],"length":1,"stats":{"Line":0}},{"line":635,"address":[41933950,41921470,41926462,41948926,41951422,41953918,41923966,41938942,41946430,41936446,41968894,41911486,41966398,41918974,41956414,41941438,41958910,41928958,41961406,41916478,41913982,41963902,41931454,41943934],"length":1,"stats":{"Line":0}},{"line":637,"address":[17141670],"length":1,"stats":{"Line":0}},{"line":641,"address":[16284851],"length":1,"stats":{"Line":0}},{"line":645,"address":[16284907],"length":1,"stats":{"Line":0}},{"line":646,"address":[16284968],"length":1,"stats":{"Line":0}},{"line":648,"address":[16284948],"length":1,"stats":{"Line":0}},{"line":649,"address":[41977544,41975832,41977400,41978152,41970552,41972088,41979976,41977688,41975976,41979832,41979368,41971160,41978440,41978904,41971944,41980120,41972696,41972552,41975048,41974904,41980904,41974760,41971016,41978296],"length":1,"stats":{"Line":0}},{"line":652,"address":[16284998],"length":1,"stats":{"Line":0}},{"line":654,"address":[41935137,41930006,41967585,41932502,41937431,41942486,41932641,41947478,41954966,41969942,41914967,41915169,41920022,41950113,41942625,41959958,41922657,41944919,41959895,41949911,41939990,41924951,41970081,41940129,41925153,41947415,41934935,41912534,41937494,41952407,41912471,41922455,41955105,41952470,41947617,41949974,41929943,41925014,41965089,41945121,41942423,41969879,41932439,41964950,41962454,41952609,41967446,41920161,41944982,41927447,41962391,41922518,41962593,41917526,41957462,41919959,41937633,41964887,41917463,41957601,41930145,41912673,41927510,41960097,41967383,41934998,41915030,41954903,41939927,41957399,41917665,41927649],"length":1,"stats":{"Line":0}},{"line":658,"address":[16295536,16296014,16296156],"length":1,"stats":{"Line":1}},{"line":664,"address":[16295669,16295588],"length":1,"stats":{"Line":2}},{"line":666,"address":[42764322],"length":1,"stats":{"Line":2}},{"line":669,"address":[16295754],"length":1,"stats":{"Line":1}},{"line":670,"address":[16295811],"length":1,"stats":{"Line":1}},{"line":671,"address":[16295888],"length":1,"stats":{"Line":1}},{"line":672,"address":[16295921],"length":1,"stats":{"Line":1}},{"line":676,"address":[41923000,41952861,41940438,41945464,41927992,41925462,41955448,41967894,41932950,41965432,41917974,41942934,41970333,41942968,41947869,41950456,41967928,41932984,41955357,41915512,41957910,41960406,41962936,41940381,41967837,41960440,41962902,41935389,41915478,41965398,41913016,41945373,41970390,41925496,41935480,41942877,41920413,41935446,41957944,41920470,41970424,41952952,41922909,41945430,41957853,41930488,41920504,41917917,41918008,41962845,41960349,41937942,41927901,41927958,41940472,41930397,41950365,41930454,41922966,41947926,41912982,41925405,41952918,41912925,41937976,41947960,41937885,41950422,41915421,41955414,41965341,41932893],"length":1,"stats":{"Line":0}},{"line":679,"address":[41951052,41963981,41911116,41939021,41919053,41961036,41914061,41911565,41928588,41938572,41934029,41924045,41944013,41916557,41946060,41951501,41921100,41956044,41956493,41958989,41941068,41948556,41963532,41943564,41936076,41966477,41968524,41961485,41946509,41929037,41926541,41926092,41933580,41949005,41953548,41936525,41941517,41913612,41953997,41958540,41966028,41916108,41921549,41923596,41931533,41968973,41931084,41918604],"length":1,"stats":{"Line":0}},{"line":683,"address":[16322527],"length":1,"stats":{"Line":0}},{"line":684,"address":[16322586],"length":1,"stats":{"Line":0}},{"line":687,"address":[16293360,16293534],"length":1,"stats":{"Line":0}},{"line":691,"address":[16293391],"length":1,"stats":{"Line":0}},{"line":692,"address":[17145111],"length":1,"stats":{"Line":0}},{"line":696,"address":[16325008,16325177],"length":1,"stats":{"Line":1}},{"line":702,"address":[16325032],"length":1,"stats":{"Line":4}},{"line":706,"address":[16293963,16294105,16293568],"length":1,"stats":{"Line":0}},{"line":708,"address":[17147153,17138577,17146497,17148977,17150513,17149745,17151169],"length":1,"stats":{"Line":3}},{"line":710,"address":[42221675,42220491,42208427,42213867,42210635,42214971,42216075,42217179,42224987,42228299,42223803,42207323,42217259,42227115,42218283,42209531,42229403,42212843,42213947,42226091,42212763,42224907,42216155,42219467,42221595,42222699,42227195,42219387,42211739,42215051,42229323,42230427,42218363,42220571,42222779,42230507,42232635,42231611,42209451,42228219,42210555,42226011,42207243,42208347,42211659,42223883,42231531,42232715],"length":1,"stats":{"Line":0}},{"line":713,"address":[42217462,42219625,42227411,42211942,42216371,42219683,42224099,42231827,42227353,42211955,42229606,42231814,42226249,42215267,42207526,42230665,42217475,42229619,42230710,42207481,42222995,42224086,42226307,42232918,42218566,42228515,42222937,42210793,42216358,42232931,42209689,42225203,42208643,42215209,42209747,42208585,42229561,42215254,42218579,42220774,42232873,42214105,42207539,42214150,42221833,42224041,42209734,42210838,42225145,42226294,42211897,42208630,42228457,42230723,42231769,42213046,42213001,42220729,42214163,42228502,42220787,42219670,42225190,42221878,42213059,42218521,42221891,42217417,42210851,42222982,42227398,42216313],"length":1,"stats":{"Line":0}},{"line":714,"address":[16293804],"length":1,"stats":{"Line":0}},{"line":715,"address":[16293871],"length":1,"stats":{"Line":0}},{"line":719,"address":[42221981,42207785,42221033,42230969,42216701,42210941,42209993,42214409,42228605,42218825,42223241,42229709,42207629,42216617,42226553,42216461,42219773,42226397,42228761,42224345,42215513,42232073,42230813,42213149,42213389,42217805,42225293,42227657,42217565,42222221,42208733,42228845,42229949,42219929,42215597,42212285,42231917,42207869,42212045,42220013,42214493,42220877,42225533,42226637,42227501,42208889,42224429,42227741,42221117,42233261,42233021,42225449,42208973,42212201,42218909,42224189,42217721,42209837,42223085,42223325,42215357,42222137,42211181,42232157,42211097,42231053,42213305,42214253,42218669,42229865,42233177,42210077],"length":1,"stats":{"Line":0}},{"line":723,"address":[42239756,42238648,42240472,42237836,42240764,42235820,42234476,42239276,42240808,42238940,42233752,42237640,42237068,42239800,42239516,42236872,42239320,42236200,42239560,42240136,42240428,42235624,42236492,42235048,42236156,42235864,42235004,42241048,42241288,42236828,42235340,42234088,42235580,42233708,42234520,42235384,42236536,42237112,42237596,42238216,42238172,42238604,42240092,42241004,42241244,42237880,42238984,42234044],"length":1,"stats":{"Line":0}},{"line":728,"address":[16304324],"length":1,"stats":{"Line":0}},{"line":732,"address":[16305149,16305072],"length":1,"stats":{"Line":0}},{"line":733,"address":[16305089],"length":1,"stats":{"Line":0}},{"line":737,"address":[16305568,16306276,16306292],"length":1,"stats":{"Line":0}},{"line":738,"address":[16305689,16306286,16305620],"length":1,"stats":{"Line":1}},{"line":740,"address":[42022052,42066948,42006436,42010340,42084516,42041572,42024004,42018148,42047428,42074756,42053284,42043524,42082564,42039620,42072804,42033764,42025956,42008388,42029860,42020100,42037668,42051332,42012292,42063044,42064996,42090372,42092324,42094276,42055236,42014244,42068900,42059140,42031812,42057188,42049380,42076708,42078660,42080612,42016196,42035716,42027908,42061092,42086468,42096228,42070852,42045476,42004484,42088420],"length":1,"stats":{"Line":1}},{"line":741,"address":[16306192],"length":1,"stats":{"Line":0}},{"line":747,"address":[42065641,42016841,42053929,42061737,42087113,42089065,42026601,42028553,42046121,42051977,42030505,42083209,42036361,42055881,42010985,42040265,42069545,42077353,42018793,42067593,42071497,42094921,42014889,42007081,42012937,42005129,42096873,42022697,42057833,42009033,42024649,42081257,42092969,42032457,42038313,42075401,42073449,42020745,42085161,42044169,42063689,42079305,42050025,42091017,42042217,42048073,42034409,42059785],"length":1,"stats":{"Line":0}},{"line":754,"address":[31474096],"length":1,"stats":{"Line":0}},{"line":755,"address":[16307268,16307210],"length":1,"stats":{"Line":0}},{"line":758,"address":[16307375],"length":1,"stats":{"Line":0}},{"line":760,"address":[16308336,16308387,16307433],"length":1,"stats":{"Line":0}},{"line":761,"address":[42083276,42061804,42096940,42063756,42028620,42071564,42046188,42018860,42069612,42048140,42057900,42036428,42050092,42079372,42087180,42011052,42042284,42022764,42007148,42026668,42020812,42016908,42053996,42059852,42014956,42005196,42009100,42013004,42030572,42034476,42075468,42040332,42055948,42024716,42065708,42067660,42073516,42077420,42085228,42032524,42081324,42089132,42091084,42044236,42093036,42094988,42052044,42038380],"length":1,"stats":{"Line":0}},{"line":764,"address":[16307934],"length":1,"stats":{"Line":0}},{"line":765,"address":[16307955],"length":1,"stats":{"Line":0}},{"line":767,"address":[16308283],"length":1,"stats":{"Line":0}},{"line":771,"address":[16341198,16341120],"length":1,"stats":{"Line":0}},{"line":772,"address":[17132317,17132398,17132407,17132465,17132436,17132427,17132240,17132456],"length":1,"stats":{"Line":2}},{"line":776,"address":[16336326,16336192],"length":1,"stats":{"Line":0}},{"line":781,"address":[17132298],"length":1,"stats":{"Line":1}},{"line":785,"address":[16342536,16342464],"length":1,"stats":{"Line":1}},{"line":786,"address":[16342473],"length":1,"stats":{"Line":0}},{"line":790,"address":[16332055,16332020,16331408],"length":1,"stats":{"Line":0}},{"line":794,"address":[16331604,16331458,16331550],"length":1,"stats":{"Line":0}},{"line":795,"address":[16331590,16331527],"length":1,"stats":{"Line":0}},{"line":797,"address":[16331855],"length":1,"stats":{"Line":0}},{"line":798,"address":[16331698],"length":1,"stats":{"Line":0}},{"line":799,"address":[16331720],"length":1,"stats":{"Line":0}},{"line":800,"address":[16331731],"length":1,"stats":{"Line":0}},{"line":801,"address":[16331804],"length":1,"stats":{"Line":0}},{"line":808,"address":[16323456,16323612],"length":1,"stats":{"Line":1}},{"line":813,"address":[16323470],"length":1,"stats":{"Line":2}},{"line":817,"address":[16313152,16313308],"length":1,"stats":{"Line":1}},{"line":822,"address":[16313166],"length":1,"stats":{"Line":1}},{"line":826,"address":[16303488,16304203,16304272],"length":1,"stats":{"Line":1}},{"line":831,"address":[29422516,29422900,29423380,29423332,29422756,29423236,29423092,29422948,29423284,29423140,29422568,29422708,29422996,29423188,29422468,29423044,29422852,29422804],"length":1,"stats":{"Line":2}},{"line":833,"address":[30794161,30793969,30793921,30794353,30794209,30794065,30794257,30794401,30794017,30794113,30794449,30794305],"length":1,"stats":{"Line":3}},{"line":834,"address":[16304040],"length":1,"stats":{"Line":2}},{"line":835,"address":[16304087],"length":1,"stats":{"Line":3}},{"line":839,"address":[16302176,16302691,16302804],"length":1,"stats":{"Line":0}},{"line":844,"address":[16302706,16302228,16302297],"length":1,"stats":{"Line":0}},{"line":846,"address":[42771944,42772130],"length":1,"stats":{"Line":0}},{"line":850,"address":[16332896,16333023],"length":1,"stats":{"Line":0}},{"line":851,"address":[42772493],"length":1,"stats":{"Line":0}},{"line":855,"address":[17151939],"length":1,"stats":{"Line":2}},{"line":860,"address":[27033886,27021838,27044446,27032286,27033920,27049278,27049323,27044521,27035723,27035678,27021877,27032331],"length":1,"stats":{"Line":6}},{"line":864,"address":[42758541],"length":1,"stats":{"Line":1}},{"line":870,"address":[17152346],"length":1,"stats":{"Line":1}},{"line":874,"address":[16343359,16343232],"length":1,"stats":{"Line":0}},{"line":878,"address":[16343253],"length":1,"stats":{"Line":0}},{"line":882,"address":[16349301,16349220,16348992],"length":1,"stats":{"Line":1}},{"line":883,"address":[27032833,27020826,27048140,27048120,27020811,27032870,27032885,27020773,27042389,27031145,27042312,27048082,27031107,27031163,27034540,27034520,27042261,27034482],"length":1,"stats":{"Line":2}},{"line":884,"address":[16349118],"length":1,"stats":{"Line":0}},{"line":886,"address":[17152218],"length":1,"stats":{"Line":3}},{"line":888,"address":[27031416,27034858,27048397,27031454,27034835,27021050,27021088,27033145,27048435,27042936,27043067,27048458,27031475,27033108,27034797,27033163,27021106,27042987],"length":1,"stats":{"Line":1}},{"line":889,"address":[42767264],"length":1,"stats":{"Line":1}},{"line":893,"address":[42767361,42767715,42767692],"length":1,"stats":{"Line":1}},{"line":894,"address":[17137497],"length":1,"stats":{"Line":1}},{"line":898,"address":[27030720,27034096,27020416,27041440,27032496,27047696],"length":1,"stats":{"Line":2}},{"line":899,"address":[31432119,31430251,31430815,31431225,31431621],"length":1,"stats":{"Line":0}},{"line":903,"address":[42780656],"length":1,"stats":{"Line":0}},{"line":904,"address":[17135056],"length":1,"stats":{"Line":0}},{"line":908,"address":[16324192,16324269],"length":1,"stats":{"Line":0}},{"line":909,"address":[16324209],"length":1,"stats":{"Line":0}},{"line":917,"address":[16323373,16323296],"length":1,"stats":{"Line":0}},{"line":918,"address":[16323313],"length":1,"stats":{"Line":0}},{"line":922,"address":[16319469,16319392],"length":1,"stats":{"Line":0}},{"line":923,"address":[16319409],"length":1,"stats":{"Line":0}},{"line":927,"address":[31438265],"length":1,"stats":{"Line":0}},{"line":928,"address":[16323073],"length":1,"stats":{"Line":0}},{"line":932,"address":[17136104],"length":1,"stats":{"Line":0}},{"line":933,"address":[27030688,27032451,27020312,27041406,27047592,27032469,27041304,27047664,27047644,27034044,27032408,27030616,27033992,27020379,27034064,27041390,27020356,27030668],"length":1,"stats":{"Line":0}},{"line":937,"address":[16336579,16336496],"length":1,"stats":{"Line":0}},{"line":938,"address":[16336518],"length":1,"stats":{"Line":0}},{"line":942,"address":[17135859],"length":1,"stats":{"Line":0}},{"line":947,"address":[16339875],"length":1,"stats":{"Line":0}},{"line":951,"address":[16323632,16323783],"length":1,"stats":{"Line":0}},{"line":956,"address":[42744000],"length":1,"stats":{"Line":0}},{"line":960,"address":[16333952,16334091],"length":1,"stats":{"Line":0}},{"line":966,"address":[16334013],"length":1,"stats":{"Line":0}},{"line":970,"address":[31439056,31439152,31438864,31438960,31438768],"length":1,"stats":{"Line":0}},{"line":976,"address":[16333415],"length":1,"stats":{"Line":0}},{"line":980,"address":[16322479,16322352],"length":1,"stats":{"Line":0}},{"line":984,"address":[31437920],"length":1,"stats":{"Line":0}},{"line":988,"address":[17138328],"length":1,"stats":{"Line":0}},{"line":993,"address":[16339720],"length":1,"stats":{"Line":0}},{"line":997,"address":[16316252,16316128],"length":1,"stats":{"Line":0}},{"line":998,"address":[16316141],"length":1,"stats":{"Line":0}},{"line":1002,"address":[16317331,16316752,16317360],"length":1,"stats":{"Line":0}},{"line":1003,"address":[16316923,16317341,16316783,16316875],"length":1,"stats":{"Line":0}},{"line":1004,"address":[16316909,16316852],"length":1,"stats":{"Line":0}},{"line":1007,"address":[42743921],"length":1,"stats":{"Line":0}},{"line":1012,"address":[16317169],"length":1,"stats":{"Line":0}},{"line":1014,"address":[16317174],"length":1,"stats":{"Line":0}},{"line":1015,"address":[16317182],"length":1,"stats":{"Line":0}},{"line":1018,"address":[16317199],"length":1,"stats":{"Line":0}},{"line":1022,"address":[16313104,16312496,16313075],"length":1,"stats":{"Line":0}},{"line":1023,"address":[16312527,16312667,16312619,16313085],"length":1,"stats":{"Line":0}},{"line":1024,"address":[16312596,16312653],"length":1,"stats":{"Line":0}},{"line":1027,"address":[16313043,16312817,16312765],"length":1,"stats":{"Line":0}},{"line":1032,"address":[16312913],"length":1,"stats":{"Line":0}},{"line":1034,"address":[16312918],"length":1,"stats":{"Line":0}},{"line":1035,"address":[16312926],"length":1,"stats":{"Line":0}},{"line":1038,"address":[42780560],"length":1,"stats":{"Line":0}},{"line":1042,"address":[17136784],"length":1,"stats":{"Line":1}},{"line":1046,"address":[16306475,16306523,16306383,16306731],"length":1,"stats":{"Line":0}},{"line":1047,"address":[16306452,16306509],"length":1,"stats":{"Line":0}},{"line":1048,"address":[16306620],"length":1,"stats":{"Line":0}},{"line":1052,"address":[16311022,16310848],"length":1,"stats":{"Line":0}},{"line":1056,"address":[16310879],"length":1,"stats":{"Line":0}},{"line":1057,"address":[16310938],"length":1,"stats":{"Line":0}},{"line":1063,"address":[17135534,17135580,17135566],"length":1,"stats":{"Line":0}},{"line":1064,"address":[16304949],"length":1,"stats":{"Line":0}},{"line":1068,"address":[16335379,16335248],"length":1,"stats":{"Line":0}},{"line":1073,"address":[16335267],"length":1,"stats":{"Line":0}},{"line":1077,"address":[16323279,16323152],"length":1,"stats":{"Line":0}},{"line":1078,"address":[16323173],"length":1,"stats":{"Line":0}},{"line":1082,"address":[16338959,16338832],"length":1,"stats":{"Line":0}},{"line":1083,"address":[16338853],"length":1,"stats":{"Line":0}},{"line":1087,"address":[16342944,16343212],"length":1,"stats":{"Line":0}},{"line":1092,"address":[16342977],"length":1,"stats":{"Line":0}},{"line":1093,"address":[17134979],"length":1,"stats":{"Line":0}},{"line":1094,"address":[17135022],"length":1,"stats":{"Line":0}},{"line":1098,"address":[16336784,16336911],"length":1,"stats":{"Line":0}},{"line":1099,"address":[16336805],"length":1,"stats":{"Line":0}},{"line":1103,"address":[16321472],"length":1,"stats":{"Line":0}},{"line":1104,"address":[16321476],"length":1,"stats":{"Line":0}},{"line":1108,"address":[16337648,16338805],"length":1,"stats":{"Line":0}},{"line":1112,"address":[16337684,16337732],"length":1,"stats":{"Line":0}},{"line":1113,"address":[16337825],"length":1,"stats":{"Line":0}},{"line":1114,"address":[16337847],"length":1,"stats":{"Line":0}},{"line":1116,"address":[16337941,16337874,16338037],"length":1,"stats":{"Line":0}},{"line":1117,"address":[16338133,16338264],"length":1,"stats":{"Line":0}},{"line":1118,"address":[16338337,16338501,16338414],"length":1,"stats":{"Line":0}},{"line":1119,"address":[16338463],"length":1,"stats":{"Line":0}},{"line":1120,"address":[16338503,16338470],"length":1,"stats":{"Line":0}},{"line":1122,"address":[16338528,16338713,16338438],"length":1,"stats":{"Line":0}},{"line":1126,"address":[16338155],"length":1,"stats":{"Line":0}},{"line":1130,"address":[42746504,42746776,42745550,42745793,42745334,42744621,42747022,42746254,42747246,42745089,42746038,42744845],"length":1,"stats":{"Line":0}},{"line":1135,"address":[16329432,16329291,16329383,16329756],"length":1,"stats":{"Line":0}},{"line":1136,"address":[16329360,16329418],"length":1,"stats":{"Line":0}},{"line":1137,"address":[16329531,16329599],"length":1,"stats":{"Line":0}},{"line":1138,"address":[42746603,42744923,42745403,42746331,42746875,42746107,42745867,42744699,42747099,42747323,42745163,42745627],"length":1,"stats":{"Line":0}},{"line":1142,"address":[16285168,16287864,16288537],"length":1,"stats":{"Line":0}},{"line":1144,"address":[16285210],"length":1,"stats":{"Line":0}},{"line":1146,"address":[16285540],"length":1,"stats":{"Line":0}},{"line":1149,"address":[16285608],"length":1,"stats":{"Line":0}},{"line":1150,"address":[16285708,16285643],"length":1,"stats":{"Line":0}},{"line":1151,"address":[16285716,16285781],"length":1,"stats":{"Line":0}},{"line":1152,"address":[16285854,16285789],"length":1,"stats":{"Line":0}},{"line":1153,"address":[16285927,16285862],"length":1,"stats":{"Line":0}},{"line":1156,"address":[16285943],"length":1,"stats":{"Line":0}},{"line":1157,"address":[16285988,16286588],"length":1,"stats":{"Line":0}},{"line":1158,"address":[16288026,16286719,16287930],"length":1,"stats":{"Line":0}},{"line":1159,"address":[42285358],"length":1,"stats":{"Line":0}},{"line":1160,"address":[16288290,16288334],"length":1,"stats":{"Line":0}},{"line":1166,"address":[16286797],"length":1,"stats":{"Line":0}},{"line":1168,"address":[42768848],"length":1,"stats":{"Line":0}},{"line":1169,"address":[42768869],"length":1,"stats":{"Line":0}},{"line":1171,"address":[16287062],"length":1,"stats":{"Line":0}},{"line":1176,"address":[42285451,42284903],"length":1,"stats":{"Line":0}},{"line":1177,"address":[16287345],"length":1,"stats":{"Line":0}},{"line":1178,"address":[16287365],"length":1,"stats":{"Line":0}},{"line":1181,"address":[16287382],"length":1,"stats":{"Line":0}},{"line":1184,"address":[16287490],"length":1,"stats":{"Line":0}},{"line":1186,"address":[16287517],"length":1,"stats":{"Line":0}},{"line":1190,"address":[42768477],"length":1,"stats":{"Line":0}},{"line":1192,"address":[42768547],"length":1,"stats":{"Line":0}},{"line":1194,"address":[16294407],"length":1,"stats":{"Line":1}},{"line":1197,"address":[17132032],"length":1,"stats":{"Line":0}},{"line":1200,"address":[16294693,16294645,16294594,16295456],"length":1,"stats":{"Line":0}},{"line":1201,"address":[17132125],"length":1,"stats":{"Line":0}},{"line":1204,"address":[16294815,16295417,16294870],"length":1,"stats":{"Line":0}},{"line":1207,"address":[42265680],"length":1,"stats":{"Line":2}},{"line":1208,"address":[42265685],"length":1,"stats":{"Line":1}},{"line":1212,"address":[42265765],"length":1,"stats":{"Line":1}},{"line":1214,"address":[16295230],"length":1,"stats":{"Line":0}},{"line":1218,"address":[16303056,16303257],"length":1,"stats":{"Line":0}},{"line":1219,"address":[42265583],"length":1,"stats":{"Line":1}},{"line":1220,"address":[16303160],"length":1,"stats":{"Line":0}},{"line":1221,"address":[42265622],"length":1,"stats":{"Line":1}},{"line":1225,"address":[42265363],"length":1,"stats":{"Line":1}},{"line":1227,"address":[42265417,42265471],"length":1,"stats":{"Line":1}},{"line":1229,"address":[42265459],"length":1,"stats":{"Line":2}},{"line":1231,"address":[42265232],"length":1,"stats":{"Line":1}},{"line":1232,"address":[16291733,16291676],"length":1,"stats":{"Line":1}},{"line":1234,"address":[16291996],"length":1,"stats":{"Line":0}},{"line":1235,"address":[17140041],"length":1,"stats":{"Line":0}},{"line":1236,"address":[16292069],"length":1,"stats":{"Line":0}},{"line":1238,"address":[42267173],"length":1,"stats":{"Line":0}},{"line":1240,"address":[16292093],"length":1,"stats":{"Line":0}},{"line":1244,"address":[16284144,16284221],"length":1,"stats":{"Line":1}},{"line":1245,"address":[16284161],"length":1,"stats":{"Line":1}},{"line":1249,"address":[42266044,42265933,42266074],"length":1,"stats":{"Line":2}},{"line":1250,"address":[16310565],"length":1,"stats":{"Line":0}},{"line":1254,"address":[16308688,16309730,16309736],"length":1,"stats":{"Line":0}},{"line":1256,"address":[16308746,16308731],"length":1,"stats":{"Line":0}},{"line":1258,"address":[17144068,17144092,17144118,17143911],"length":1,"stats":{"Line":0}},{"line":1259,"address":[17144172,17143809],"length":1,"stats":{"Line":0}},{"line":1260,"address":[17144299,17143990],"length":1,"stats":{"Line":0}},{"line":1261,"address":[42249168],"length":1,"stats":{"Line":1}},{"line":1262,"address":[17144017,17144325],"length":1,"stats":{"Line":0}},{"line":1264,"address":[16308708],"length":1,"stats":{"Line":1}},{"line":1266,"address":[42249775,42249839,42250050,42250305,42251569,42251035,42250501,42251907,42251449,42251983,42250839,42249967,42252441,42252517,42251652,42250584,42250381,42252637,42251118,42251373,42252103,42252186,42252720,42250915],"length":1,"stats":{"Line":2}},{"line":1267,"address":[16309800,16309890,16308840],"length":1,"stats":{"Line":0}},{"line":1269,"address":[16309983],"length":1,"stats":{"Line":0}},{"line":1271,"address":[16310078],"length":1,"stats":{"Line":0}},{"line":1276,"address":[16308867],"length":1,"stats":{"Line":0}},{"line":1277,"address":[17144488],"length":1,"stats":{"Line":0}},{"line":1278,"address":[16309236,16309143],"length":1,"stats":{"Line":0}},{"line":1279,"address":[16309255],"length":1,"stats":{"Line":0}},{"line":1280,"address":[17144523,17144397,17144514],"length":1,"stats":{"Line":0}},{"line":1283,"address":[17144579],"length":1,"stats":{"Line":0}},{"line":1286,"address":[16323935,16323808],"length":1,"stats":{"Line":0}},{"line":1287,"address":[16323829],"length":1,"stats":{"Line":0}},{"line":1291,"address":[16300832,16301006],"length":1,"stats":{"Line":2}},{"line":1295,"address":[42254481,42255851,42257221,42253138,42258642,42253189,42254532,42258591,42259961,42260012,42257272,42255902],"length":1,"stats":{"Line":1}},{"line":1299,"address":[16305545,16305168],"length":1,"stats":{"Line":3}},{"line":1300,"address":[16305202],"length":1,"stats":{"Line":0}},{"line":1303,"address":[16305264,16305322],"length":1,"stats":{"Line":0}},{"line":1304,"address":[16305335],"length":1,"stats":{"Line":0}},{"line":1306,"address":[16305431],"length":1,"stats":{"Line":0}},{"line":1310,"address":[16301040,16301117],"length":1,"stats":{"Line":0}},{"line":1311,"address":[16301057],"length":1,"stats":{"Line":0}},{"line":1315,"address":[16344941,16344592],"length":1,"stats":{"Line":0}},{"line":1319,"address":[16344661,16344896,16344609],"length":1,"stats":{"Line":0}},{"line":1320,"address":[16344789],"length":1,"stats":{"Line":0}},{"line":1321,"address":[16344808],"length":1,"stats":{"Line":0}},{"line":1325,"address":[16340896,16340981],"length":1,"stats":{"Line":0}},{"line":1326,"address":[42264528],"length":1,"stats":{"Line":0}},{"line":1330,"address":[16334336,16334463],"length":1,"stats":{"Line":0}},{"line":1331,"address":[16334357],"length":1,"stats":{"Line":0}},{"line":1337,"address":[16332080,16332165],"length":1,"stats":{"Line":0}},{"line":1341,"address":[16332107],"length":1,"stats":{"Line":0}},{"line":1345,"address":[16334944,16335040],"length":1,"stats":{"Line":0}},{"line":1350,"address":[16334982],"length":1,"stats":{"Line":0}},{"line":1354,"address":[16312352,16312479],"length":1,"stats":{"Line":0}},{"line":1355,"address":[16312373],"length":1,"stats":{"Line":0}},{"line":1359,"address":[16315744,16315871],"length":1,"stats":{"Line":0}},{"line":1360,"address":[16315765],"length":1,"stats":{"Line":0}},{"line":1364,"address":[16340164,16340080],"length":1,"stats":{"Line":0}},{"line":1365,"address":[16340101],"length":1,"stats":{"Line":0}},{"line":1369,"address":[16331386,16331264],"length":1,"stats":{"Line":0}},{"line":1370,"address":[42261467],"length":1,"stats":{"Line":0}},{"line":1374,"address":[16310448,16310525],"length":1,"stats":{"Line":0}},{"line":1375,"address":[16310465],"length":1,"stats":{"Line":0}},{"line":1379,"address":[16326185,16326214,16325488],"length":1,"stats":{"Line":0}},{"line":1384,"address":[16325632,16325540,16326195,16325681],"length":1,"stats":{"Line":0}},{"line":1385,"address":[42264629],"length":1,"stats":{"Line":0}},{"line":1388,"address":[42264982],"length":1,"stats":{"Line":0}},{"line":1390,"address":[42265077,42265107],"length":1,"stats":{"Line":0}},{"line":1391,"address":[16325860],"length":1,"stats":{"Line":0}},{"line":1394,"address":[16325895,16326153],"length":1,"stats":{"Line":0}},{"line":1397,"address":[16326007],"length":1,"stats":{"Line":0}},{"line":1403,"address":[16326024],"length":1,"stats":{"Line":0}},{"line":1408,"address":[16326052],"length":1,"stats":{"Line":0}},{"line":1412,"address":[16300761,16300806,16300048],"length":1,"stats":{"Line":0}},{"line":1417,"address":[16300194,16300102,16300243,16300771],"length":1,"stats":{"Line":0}},{"line":1418,"address":[16300229,16300171],"length":1,"stats":{"Line":0}},{"line":1421,"address":[16300331],"length":1,"stats":{"Line":0}},{"line":1424,"address":[16300729,16300400],"length":1,"stats":{"Line":1}},{"line":1427,"address":[16300537],"length":1,"stats":{"Line":0}},{"line":1430,"address":[16300559],"length":1,"stats":{"Line":0}},{"line":1432,"address":[16300574],"length":1,"stats":{"Line":0}},{"line":1436,"address":[16311764,16311056,16311809],"length":1,"stats":{"Line":0}},{"line":1441,"address":[16311774,16311202,16311110,16311251],"length":1,"stats":{"Line":0}},{"line":1442,"address":[16311237,16311179],"length":1,"stats":{"Line":0}},{"line":1445,"address":[16311339],"length":1,"stats":{"Line":1}},{"line":1448,"address":[16311408,16311732],"length":1,"stats":{"Line":1}},{"line":1451,"address":[16311540],"length":1,"stats":{"Line":0}},{"line":1454,"address":[42243877],"length":1,"stats":{"Line":1}},{"line":1456,"address":[16311577],"length":1,"stats":{"Line":0}},{"line":1460,"address":[16304905,16304400,16304870],"length":1,"stats":{"Line":0}},{"line":1464,"address":[16304596,16304542,16304450],"length":1,"stats":{"Line":0}},{"line":1465,"address":[16304519,16304582],"length":1,"stats":{"Line":0}},{"line":1466,"address":[16304696,16304745],"length":1,"stats":{"Line":0}},{"line":1470,"address":[16301800,16301280,16301937],"length":1,"stats":{"Line":0}},{"line":1475,"address":[16301442,16301326,16301816,16301491],"length":1,"stats":{"Line":0}},{"line":1476,"address":[16301419,16301477],"length":1,"stats":{"Line":0}},{"line":1477,"address":[16301696,16301593],"length":1,"stats":{"Line":0}},{"line":1483,"address":[16293336,16293072],"length":1,"stats":{"Line":0}},{"line":1490,"address":[16293093],"length":1,"stats":{"Line":0}},{"line":1494,"address":[16332336,16332514],"length":1,"stats":{"Line":0}},{"line":1499,"address":[16332355],"length":1,"stats":{"Line":1}},{"line":1503,"address":[16303038,16302832],"length":1,"stats":{"Line":0}},{"line":1509,"address":[16302850],"length":1,"stats":{"Line":0}},{"line":1513,"address":[16312064,16312191],"length":1,"stats":{"Line":0}},{"line":1517,"address":[16312085],"length":1,"stats":{"Line":0}},{"line":1521,"address":[16335133,16335056],"length":1,"stats":{"Line":0}},{"line":1522,"address":[16335073],"length":1,"stats":{"Line":0}},{"line":1526,"address":[16341091,16341008],"length":1,"stats":{"Line":0}},{"line":1530,"address":[16341030],"length":1,"stats":{"Line":0}},{"line":1534,"address":[16334480,16334920],"length":1,"stats":{"Line":0}},{"line":1538,"address":[42266144],"length":1,"stats":{"Line":1}},{"line":1539,"address":[42266672,42266369,42266282],"length":1,"stats":{"Line":2}},{"line":1540,"address":[16334764],"length":1,"stats":{"Line":1}},{"line":1546,"address":[42267120],"length":1,"stats":{"Line":0}},{"line":1547,"address":[42267125],"length":1,"stats":{"Line":0}},{"line":1551,"address":[16327232,16327906,16327922],"length":1,"stats":{"Line":0}},{"line":1552,"address":[16327916,16327255,16327324],"length":1,"stats":{"Line":0}},{"line":1554,"address":[16327503],"length":1,"stats":{"Line":0}},{"line":1556,"address":[16327573,16327873],"length":1,"stats":{"Line":0}},{"line":1557,"address":[16327738],"length":1,"stats":{"Line":0}},{"line":1561,"address":[42261642],"length":1,"stats":{"Line":0}},{"line":1562,"address":[16327750],"length":1,"stats":{"Line":0}},{"line":1563,"address":[42261654],"length":1,"stats":{"Line":0}},{"line":1564,"address":[42261674],"length":1,"stats":{"Line":0}},{"line":1565,"address":[42261694],"length":1,"stats":{"Line":0}},{"line":1568,"address":[16327822],"length":1,"stats":{"Line":0}},{"line":1572,"address":[16324096,16324173],"length":1,"stats":{"Line":0}},{"line":1573,"address":[42261967,42261997],"length":1,"stats":{"Line":0}},{"line":1577,"address":[42261810],"length":1,"stats":{"Line":0}},{"line":1578,"address":[42261815,42261736],"length":1,"stats":{"Line":0}},{"line":1580,"address":[16335661],"length":1,"stats":{"Line":0}},{"line":1582,"address":[16335731,16336118],"length":1,"stats":{"Line":0}},{"line":1583,"address":[16336016],"length":1,"stats":{"Line":0}},{"line":1587,"address":[30338259,30339923,30339091,30337843,30337011,30339507,30337427,30340755,30338675,30341171,30341587,30340339],"length":1,"stats":{"Line":0}},{"line":1588,"address":[16336028],"length":1,"stats":{"Line":0}},{"line":1589,"address":[42262811],"length":1,"stats":{"Line":0}},{"line":1590,"address":[42262758],"length":1,"stats":{"Line":0}},{"line":1593,"address":[30547571,30546323,30545907,30547155,30545491,30546739],"length":1,"stats":{"Line":0}},{"line":1597,"address":[16333040,16333167],"length":1,"stats":{"Line":0}},{"line":1601,"address":[16333061],"length":1,"stats":{"Line":0}},{"line":1605,"address":[16339630,16339168,16339673],"length":1,"stats":{"Line":0}},{"line":1606,"address":[42263648,42263706,42264177],"length":1,"stats":{"Line":0}},{"line":1608,"address":[16339268,16339645],"length":1,"stats":{"Line":0}},{"line":1609,"address":[16339447],"length":1,"stats":{"Line":0}},{"line":1613,"address":[42264039],"length":1,"stats":{"Line":0}},{"line":1615,"address":[16339501],"length":1,"stats":{"Line":0}},{"line":1616,"address":[42264217],"length":1,"stats":{"Line":0}},{"line":1617,"address":[42264235],"length":1,"stats":{"Line":0}},{"line":1620,"address":[16339533],"length":1,"stats":{"Line":0}},{"line":1624,"address":[42261536],"length":1,"stats":{"Line":0}},{"line":1628,"address":[16318833,16318894],"length":1,"stats":{"Line":0}},{"line":1634,"address":[42265216],"length":1,"stats":{"Line":0}},{"line":1635,"address":[16319080],"length":1,"stats":{"Line":0}},{"line":1636,"address":[42265230],"length":1,"stats":{"Line":0}},{"line":1639,"address":[16319165],"length":1,"stats":{"Line":0}},{"line":1643,"address":[16330584,16330619,16330016],"length":1,"stats":{"Line":0}},{"line":1648,"address":[16330057],"length":1,"stats":{"Line":0}},{"line":1650,"address":[16330114],"length":1,"stats":{"Line":0}},{"line":1652,"address":[16330328],"length":1,"stats":{"Line":0}},{"line":1657,"address":[16330385],"length":1,"stats":{"Line":0}},{"line":1659,"address":[42282829,42282752],"length":1,"stats":{"Line":0}},{"line":1660,"address":[16330393],"length":1,"stats":{"Line":0}},{"line":1661,"address":[16330401],"length":1,"stats":{"Line":0}},{"line":1664,"address":[42282805],"length":1,"stats":{"Line":0}},{"line":1668,"address":[16331243,16331208,16330640],"length":1,"stats":{"Line":0}},{"line":1673,"address":[30550528,30550128,30550208,30550448,30550288,30550368],"length":1,"stats":{"Line":0}},{"line":1675,"address":[16330738],"length":1,"stats":{"Line":0}},{"line":1677,"address":[42242176],"length":1,"stats":{"Line":0}},{"line":1682,"address":[42242304],"length":1,"stats":{"Line":0}},{"line":1684,"address":[42242331],"length":1,"stats":{"Line":0}},{"line":1685,"address":[42243005,42242353],"length":1,"stats":{"Line":0}},{"line":1686,"address":[42242596],"length":1,"stats":{"Line":0}},{"line":1689,"address":[42242666],"length":1,"stats":{"Line":0}},{"line":1693,"address":[16312047,16311920],"length":1,"stats":{"Line":0}},{"line":1694,"address":[42243062],"length":1,"stats":{"Line":0}},{"line":1698,"address":[16312335,16312208],"length":1,"stats":{"Line":0}},{"line":1699,"address":[16312229],"length":1,"stats":{"Line":0}},{"line":1703,"address":[16318352,16318635],"length":1,"stats":{"Line":0}},{"line":1706,"address":[42242576],"length":1,"stats":{"Line":0}},{"line":1707,"address":[16318435],"length":1,"stats":{"Line":0}},{"line":1709,"address":[16318475],"length":1,"stats":{"Line":0}},{"line":1710,"address":[16318487],"length":1,"stats":{"Line":0}},{"line":1712,"address":[16318517],"length":1,"stats":{"Line":0}},{"line":1716,"address":[16318276,16318327,16317680],"length":1,"stats":{"Line":0}},{"line":1721,"address":[16317720,16317789],"length":1,"stats":{"Line":0}},{"line":1723,"address":[16317957],"length":1,"stats":{"Line":0}},{"line":1726,"address":[16318019],"length":1,"stats":{"Line":0}},{"line":1729,"address":[16318061],"length":1,"stats":{"Line":0}},{"line":1733,"address":[16316272,16316725],"length":1,"stats":{"Line":0}},{"line":1740,"address":[16316325,16316395],"length":1,"stats":{"Line":0}},{"line":1743,"address":[16316407],"length":1,"stats":{"Line":0}},{"line":1744,"address":[16316493,16316428],"length":1,"stats":{"Line":0}},{"line":1746,"address":[16316524],"length":1,"stats":{"Line":0}},{"line":1750,"address":[16315376,16315317,16313472],"length":1,"stats":{"Line":0}},{"line":1755,"address":[16313528],"length":1,"stats":{"Line":0}},{"line":1756,"address":[42286657],"length":1,"stats":{"Line":0}},{"line":1759,"address":[30550992,30550896,30550704,30551088,30550608,30550800],"length":1,"stats":{"Line":0}},{"line":1761,"address":[16313824],"length":1,"stats":{"Line":0}},{"line":1762,"address":[42286995],"length":1,"stats":{"Line":0}},{"line":1763,"address":[16314192,16313901],"length":1,"stats":{"Line":0}},{"line":1764,"address":[30550940,30550652,30551132,30550748,30550844,30551036],"length":1,"stats":{"Line":0}},{"line":1765,"address":[30347860,30348052,30348148,30347764,30348244,30347476,30348340,30347956,30348436,30347668,30347380,30347572],"length":1,"stats":{"Line":0}},{"line":1766,"address":[16314006,16314588],"length":1,"stats":{"Line":0}},{"line":1767,"address":[42286160],"length":1,"stats":{"Line":0}},{"line":1770,"address":[16314171],"length":1,"stats":{"Line":0}},{"line":1771,"address":[42286248],"length":1,"stats":{"Line":0}},{"line":1773,"address":[16314889,16314986],"length":1,"stats":{"Line":0}},{"line":1776,"address":[16315163],"length":1,"stats":{"Line":0}},{"line":1778,"address":[42286384],"length":1,"stats":{"Line":0}},{"line":1779,"address":[16315258],"length":1,"stats":{"Line":0}},{"line":1782,"address":[16314787],"length":1,"stats":{"Line":0}},{"line":1790,"address":[16337594,16337629,16337152],"length":1,"stats":{"Line":0}},{"line":1794,"address":[16337251,16337187],"length":1,"stats":{"Line":0}},{"line":1795,"address":[16337408],"length":1,"stats":{"Line":0}},{"line":1796,"address":[16337492],"length":1,"stats":{"Line":0}},{"line":1800,"address":[16336352,16336479],"length":1,"stats":{"Line":0}},{"line":1801,"address":[16336373],"length":1,"stats":{"Line":0}},{"line":1805,"address":[41905078],"length":1,"stats":{"Line":0}},{"line":1808,"address":[41905108],"length":1,"stats":{"Line":0}},{"line":1809,"address":[16333798],"length":1,"stats":{"Line":0}},{"line":1810,"address":[41905128],"length":1,"stats":{"Line":0}},{"line":1814,"address":[16343453,16343376],"length":1,"stats":{"Line":0}},{"line":1815,"address":[16343393],"length":1,"stats":{"Line":0}},{"line":1819,"address":[16342278,16342209,16341472],"length":1,"stats":{"Line":0}},{"line":1823,"address":[41905268,41905175],"length":1,"stats":{"Line":0}},{"line":1825,"address":[41908897,41905365],"length":1,"stats":{"Line":0}},{"line":1827,"address":[41905506],"length":1,"stats":{"Line":0}},{"line":1828,"address":[16341997],"length":1,"stats":{"Line":0}},{"line":1832,"address":[41905704,41905800],"length":1,"stats":{"Line":0}},{"line":1833,"address":[41905868],"length":1,"stats":{"Line":0}},{"line":1834,"address":[16342054],"length":1,"stats":{"Line":0}},{"line":1835,"address":[16342070],"length":1,"stats":{"Line":0}},{"line":1836,"address":[41906139],"length":1,"stats":{"Line":0}},{"line":1839,"address":[16342093],"length":1,"stats":{"Line":0}},{"line":1843,"address":[16343856,16344524,16344577],"length":1,"stats":{"Line":0}},{"line":1844,"address":[41906404],"length":1,"stats":{"Line":0}},{"line":1846,"address":[16344118],"length":1,"stats":{"Line":0}},{"line":1848,"address":[41906548],"length":1,"stats":{"Line":0}},{"line":1849,"address":[16344365],"length":1,"stats":{"Line":0}},{"line":1853,"address":[30336339,30335091,30334675,30332595,30331763,30334259,30332179,30333427,30333011,30333843,30335507,30335923],"length":1,"stats":{"Line":0}},{"line":1854,"address":[16344417],"length":1,"stats":{"Line":0}},{"line":1855,"address":[41906938],"length":1,"stats":{"Line":0}},{"line":1856,"address":[16344431],"length":1,"stats":{"Line":0}},{"line":1857,"address":[41907017],"length":1,"stats":{"Line":0}},{"line":1860,"address":[41907215,41907241],"length":1,"stats":{"Line":0}},{"line":1867,"address":[29427094,29427926,29429174,29430006,29430838,29425846,29429590,29431283,29428342,29425014,29426678,29428758,29432134,29425430,29426262,29427510,29431718,29430422],"length":1,"stats":{"Line":0}},{"line":1868,"address":[16319501],"length":1,"stats":{"Line":0}},{"line":1872,"address":[41907628],"length":1,"stats":{"Line":0}},{"line":1883,"address":[41907908,41907815],"length":1,"stats":{"Line":0}},{"line":1884,"address":[41907901,41907960],"length":1,"stats":{"Line":0}},{"line":1885,"address":[41908027],"length":1,"stats":{"Line":0}},{"line":1886,"address":[41907979,41908244],"length":1,"stats":{"Line":0}},{"line":1887,"address":[41908253],"length":1,"stats":{"Line":0}},{"line":1893,"address":[16306981,16306896],"length":1,"stats":{"Line":0}},{"line":1897,"address":[16306923],"length":1,"stats":{"Line":0}},{"line":1901,"address":[16334112,16334306],"length":1,"stats":{"Line":0}},{"line":1918,"address":[16316111,16315984],"length":1,"stats":{"Line":0}},{"line":1919,"address":[16316005],"length":1,"stats":{"Line":0}},{"line":1923,"address":[16342304,16342444],"length":1,"stats":{"Line":0}},{"line":1928,"address":[16342336],"length":1,"stats":{"Line":0}},{"line":1932,"address":[16340544,16340869],"length":1,"stats":{"Line":0}},{"line":1950,"address":[16340670],"length":1,"stats":{"Line":0}},{"line":1954,"address":[16310288,16310423],"length":1,"stats":{"Line":0}},{"line":1959,"address":[16310315],"length":1,"stats":{"Line":0}},{"line":1963,"address":[16306800,16306879],"length":1,"stats":{"Line":0}},{"line":1964,"address":[16306821],"length":1,"stats":{"Line":0}},{"line":1968,"address":[16329990,16329824],"length":1,"stats":{"Line":0}},{"line":1974,"address":[16329848],"length":1,"stats":{"Line":0}},{"line":1978,"address":[16327936,16328094],"length":1,"stats":{"Line":0}},{"line":1984,"address":[16328031],"length":1,"stats":{"Line":0}}],"covered":226,"coverable":744},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","notifications.rs"],"content":"use crate::bid::Bid;\nuse crate::invoice::{Invoice, InvoiceStatus};\nuse soroban_sdk::{contracttype, symbol_short, Address, Bytes, BytesN, Env, Map, String, Vec};\n\n/// Notification types for different events\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum NotificationType {\n    InvoiceCreated,\n    InvoiceVerified,\n    InvoiceStatusChanged,\n    BidReceived,\n    BidAccepted,\n    PaymentReceived,\n    PaymentOverdue,\n    InvoiceDefaulted,\n    SystemAlert,\n    General,\n}\n\n/// Notification priority levels\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum NotificationPriority {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Notification delivery status\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum NotificationDeliveryStatus {\n    Pending,\n    Sent,\n    Delivered,\n    Failed,\n    Read,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum DataKey {\n    UserNotifications(Address),\n    UserPreferences(Address),\n    Notification(BytesN\u003c32\u003e),\n    NotificationType(NotificationType),\n}\n\n/// Notification statistics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct NotificationStats {\n    pub total_sent: u32,\n    pub total_delivered: u32,\n    pub total_read: u32,\n    pub total_failed: u32,\n}\n\n/// Notification data structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct Notification {\n    pub id: BytesN\u003c32\u003e,\n    pub recipient: Address,\n    pub notification_type: NotificationType,\n    pub priority: NotificationPriority,\n    pub title: String,\n    pub message: String,\n    pub related_invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    pub created_at: u64,\n    pub delivery_status: NotificationDeliveryStatus,\n    pub delivered_at: Option\u003cu64\u003e,\n    pub read_at: Option\u003cu64\u003e,\n    pub metadata: Map\u003cString, String\u003e,\n}\n\nimpl Notification {\n    /// Create a new notification\n    pub fn new(\n        env: \u0026Env,\n        recipient: Address,\n        notification_type: NotificationType,\n        priority: NotificationPriority,\n        title: String,\n        message: String,\n        related_invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    ) -\u003e Self {\n        let id = env.crypto().keccak256(\u0026Bytes::from_array(\n            \u0026env,\n            \u0026env.ledger().timestamp().to_be_bytes(),\n        ));\n        let created_at = env.ledger().timestamp();\n\n        Self {\n            id: id.into(),\n            recipient,\n            notification_type,\n            priority,\n            title,\n            message,\n            related_invoice_id,\n            created_at,\n            delivery_status: NotificationDeliveryStatus::Pending,\n            delivered_at: None,\n            read_at: None,\n            metadata: Map::new(env),\n        }\n    }\n\n    /// Mark notification as sent\n    pub fn mark_as_sent(\u0026mut self, timestamp: u64) {\n        self.delivery_status = NotificationDeliveryStatus::Sent;\n        self.delivered_at = Some(timestamp);\n    }\n\n    /// Mark notification as delivered\n    pub fn mark_as_delivered(\u0026mut self, timestamp: u64) {\n        self.delivery_status = NotificationDeliveryStatus::Delivered;\n        if self.delivered_at.is_none() {\n            self.delivered_at = Some(timestamp);\n        }\n    }\n\n    /// Mark notification as read\n    pub fn mark_as_read(\u0026mut self, timestamp: u64) {\n        self.delivery_status = NotificationDeliveryStatus::Read;\n        self.read_at = Some(timestamp);\n    }\n\n    /// Mark notification as failed\n    pub fn mark_as_failed(\u0026mut self) {\n        self.delivery_status = NotificationDeliveryStatus::Failed;\n    }\n}\n\n/// User notification preferences\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct NotificationPreferences {\n    pub user: Address,\n    pub invoice_created: bool,\n    pub invoice_verified: bool,\n    pub invoice_status_changed: bool,\n    pub bid_received: bool,\n    pub bid_accepted: bool,\n    pub payment_received: bool,\n    pub payment_overdue: bool,\n    pub invoice_defaulted: bool,\n    pub system_alerts: bool,\n    pub general: bool,\n    pub minimum_priority: NotificationPriority,\n    pub updated_at: u64,\n}\n\nimpl NotificationPreferences {\n    /// Create default notification preferences for a user\n    pub fn default_for_user(env: \u0026Env, user: Address) -\u003e Self {\n        Self {\n            user,\n            invoice_created: true,\n            invoice_verified: true,\n            invoice_status_changed: true,\n            bid_received: true,\n            bid_accepted: true,\n            payment_received: true,\n            payment_overdue: true,\n            invoice_defaulted: true,\n            system_alerts: true,\n            general: false,\n            minimum_priority: NotificationPriority::Medium,\n            updated_at: env.ledger().timestamp(),\n        }\n    }\n\n    /// Check if user wants notifications for a specific type\n    pub fn should_notify(\n        \u0026self,\n        notification_type: \u0026NotificationType,\n        priority: \u0026NotificationPriority,\n    ) -\u003e bool {\n        // Check minimum priority first\n        let priority_check = match (\u0026self.minimum_priority, priority) {\n            (NotificationPriority::Critical, NotificationPriority::Critical) =\u003e true,\n            (\n                NotificationPriority::High,\n                NotificationPriority::High | NotificationPriority::Critical,\n            ) =\u003e true,\n            (\n                NotificationPriority::Medium,\n                NotificationPriority::Medium\n                | NotificationPriority::High\n                | NotificationPriority::Critical,\n            ) =\u003e true,\n            (NotificationPriority::Low, _) =\u003e true,\n            _ =\u003e false,\n        };\n\n        if !priority_check {\n            return false;\n        }\n\n        // Check notification type preferences\n        match notification_type {\n            NotificationType::InvoiceCreated =\u003e self.invoice_created,\n            NotificationType::InvoiceVerified =\u003e self.invoice_verified,\n            NotificationType::InvoiceStatusChanged =\u003e self.invoice_status_changed,\n            NotificationType::BidReceived =\u003e self.bid_received,\n            NotificationType::BidAccepted =\u003e self.bid_accepted,\n            NotificationType::PaymentReceived =\u003e self.payment_received,\n            NotificationType::PaymentOverdue =\u003e self.payment_overdue,\n            NotificationType::InvoiceDefaulted =\u003e self.invoice_defaulted,\n            NotificationType::SystemAlert =\u003e self.system_alerts,\n            NotificationType::General =\u003e self.general,\n        }\n    }\n}\n\n/// Main notification system\npub struct NotificationSystem;\n\nimpl NotificationSystem {\n    /// Create and store a notification\n    pub fn create_notification(\n        env: \u0026Env,\n        recipient: Address,\n        notification_type: NotificationType,\n        priority: NotificationPriority,\n        title: String,\n        message: String,\n        related_invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, crate::errors::QuickLendXError\u003e {\n        // Check if user wants this type of notification\n        let preferences = Self::get_user_preferences(env, \u0026recipient);\n        if !preferences.should_notify(\u0026notification_type, \u0026priority) {\n            return Err(crate::errors::QuickLendXError::NotificationBlocked);\n        }\n\n        // Create notification\n        let notification = Notification::new(\n            env,\n            recipient.clone(),\n            notification_type.clone(),\n            priority.clone(),\n            title,\n            message,\n            related_invoice_id,\n        );\n\n        // Store notification\n        Self::store_notification(env, \u0026notification);\n\n        // Add to user's notification list\n        Self::add_to_user_notifications(env, \u0026recipient, \u0026notification.id);\n\n        // Emit notification event\n        env.events().publish(\n            (symbol_short!(\"notif\"),),\n            (\n                notification.id.clone(),\n                recipient,\n                notification_type,\n                priority,\n            ),\n        );\n\n        Ok(notification.id)\n    }\n\n    /// Store a notification\n    fn store_notification(env: \u0026Env, notification: \u0026Notification) {\n        let key = Self::get_notification_key(\u0026notification.id);\n        env.storage().instance().set(\u0026key, notification);\n    }\n\n    /// Get a notification by ID\n    pub fn get_notification(env: \u0026Env, notification_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cNotification\u003e {\n        let key = Self::get_notification_key(notification_id);\n        env.storage().instance().get(\u0026key)\n    }\n\n    /// Update notification status\n    pub fn update_notification_status(\n        env: \u0026Env,\n        notification_id: \u0026BytesN\u003c32\u003e,\n        status: NotificationDeliveryStatus,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let mut notification = Self::get_notification(env, notification_id)\n            .ok_or(crate::errors::QuickLendXError::NotificationNotFound)?;\n\n        let timestamp = env.ledger().timestamp();\n\n        match status {\n            NotificationDeliveryStatus::Sent =\u003e notification.mark_as_sent(timestamp),\n            NotificationDeliveryStatus::Delivered =\u003e notification.mark_as_delivered(timestamp),\n            NotificationDeliveryStatus::Read =\u003e notification.mark_as_read(timestamp),\n            NotificationDeliveryStatus::Failed =\u003e notification.mark_as_failed(),\n            _ =\u003e {}\n        }\n\n        Self::store_notification(env, \u0026notification);\n\n        // Emit status update event\n        env.events().publish(\n            (symbol_short!(\"n_status\"),),\n            (notification_id.clone(), status),\n        );\n\n        Ok(())\n    }\n\n    /// Get user notifications\n    pub fn get_user_notifications(env: \u0026Env, user: \u0026Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = Self::get_user_notifications_key(user);\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get user notification preferences\n    pub fn get_user_preferences(env: \u0026Env, user: \u0026Address) -\u003e NotificationPreferences {\n        let key = DataKey::UserPreferences(user.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| NotificationPreferences::default_for_user(env, user.clone()))\n    }\n\n    /// Update user notification preferences\n    pub fn update_user_preferences(\n        env: \u0026Env,\n        user: \u0026Address,\n        preferences: NotificationPreferences,\n    ) {\n        let key = DataKey::UserPreferences(user.clone());\n        env.storage().instance().set(\u0026key, \u0026preferences);\n\n        // Emit preferences update event\n        env.events()\n            .publish((symbol_short!(\"pref_up\"),), (user.clone(),));\n    }\n\n    /// Get notification statistics for a user\n    pub fn get_user_notification_stats(env: \u0026Env, user: \u0026Address) -\u003e NotificationStats {\n        let notifications = Self::get_user_notifications(env, user);\n        let mut stats = NotificationStats {\n            total_sent: 0,\n            total_delivered: 0,\n            total_read: 0,\n            total_failed: 0,\n        };\n\n        for notification_id in notifications.iter() {\n            if let Some(notification) = Self::get_notification(env, \u0026notification_id) {\n                match notification.delivery_status {\n                    NotificationDeliveryStatus::Sent =\u003e stats.total_sent += 1,\n                    NotificationDeliveryStatus::Delivered =\u003e {\n                        stats.total_sent += 1;\n                        stats.total_delivered += 1;\n                    }\n                    NotificationDeliveryStatus::Read =\u003e {\n                        stats.total_sent += 1;\n                        stats.total_delivered += 1;\n                        stats.total_read += 1;\n                    }\n                    NotificationDeliveryStatus::Failed =\u003e stats.total_failed += 1,\n                    _ =\u003e {}\n                }\n            }\n        }\n\n        stats\n    }\n\n    // Storage key helpers\n    fn get_notification_key(notification_id: \u0026BytesN\u003c32\u003e) -\u003e DataKey {\n        DataKey::Notification(notification_id.clone())\n    }\n\n    fn get_user_notifications_key(user: \u0026Address) -\u003e DataKey {\n        DataKey::UserNotifications(user.clone())\n    }\n\n    // Helper methods for adding to lists\n    fn add_to_user_notifications(env: \u0026Env, user: \u0026Address, notification_id: \u0026BytesN\u003c32\u003e) {\n        let key = Self::get_user_notifications_key(user);\n        let mut notifications = Self::get_user_notifications(env, user);\n        notifications.push_back(notification_id.clone());\n        env.storage().instance().set(\u0026key, \u0026notifications);\n    }\n}\n\n// Notification helper functions for common scenarios\nimpl NotificationSystem {\n    /// Create invoice created notification\n    pub fn notify_invoice_created(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Created\");\n        let message = String::from_str(\n            env,\n            \"Your invoice has been successfully created and is pending verification\",\n        );\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceCreated,\n            NotificationPriority::Medium,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create invoice verified notification\n    pub fn notify_invoice_verified(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Verified\");\n        let message = String::from_str(\n            env,\n            \"Your invoice has been verified and is now available for funding\",\n        );\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceVerified,\n            NotificationPriority::High,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create invoice status changed notification\n    pub fn notify_invoice_status_changed(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        old_status: \u0026InvoiceStatus,\n        new_status: \u0026InvoiceStatus,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Status Updated\");\n\n        let status_text = match (old_status, new_status) {\n            (InvoiceStatus::Pending, InvoiceStatus::Verified) =\u003e {\n                \"Your invoice has been verified and is now available for funding\"\n            }\n            (InvoiceStatus::Verified, InvoiceStatus::Funded) =\u003e {\n                \"Your invoice has been funded by an investor\"\n            }\n            (InvoiceStatus::Funded, InvoiceStatus::Paid) =\u003e {\n                \"Your invoice has been paid successfully\"\n            }\n            (_, InvoiceStatus::Defaulted) =\u003e \"Your invoice has been marked as defaulted\",\n            _ =\u003e \"Your invoice status has been updated\",\n        };\n\n        let message = String::from_str(env, status_text);\n\n        let priority = match new_status {\n            InvoiceStatus::Funded | InvoiceStatus::Paid =\u003e NotificationPriority::High,\n            InvoiceStatus::Defaulted =\u003e NotificationPriority::Critical,\n            _ =\u003e NotificationPriority::Medium,\n        };\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceStatusChanged,\n            priority.clone(),\n            title.clone(),\n            message.clone(),\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor if applicable\n        if let Some(investor) = \u0026invoice.investor {\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::InvoiceStatusChanged,\n                priority,\n                title,\n                message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n        Ok(())\n    }\n\n    /// Create payment overdue notification\n    pub fn notify_payment_overdue(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Payment Overdue\");\n        let message = String::from_str(env, \"Your invoice payment is overdue\");\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::PaymentOverdue,\n            NotificationPriority::Critical,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor\n        if let Some(investor) = \u0026invoice.investor {\n            let investor_title = String::from_str(env, \"Invoice Payment Overdue\");\n            let investor_message =\n                String::from_str(env, \"An invoice you funded has an overdue payment\");\n\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::PaymentOverdue,\n                NotificationPriority::Critical,\n                investor_title,\n                investor_message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n\n        Ok(())\n    }\n\n    /// Create bid received notification for business\n    pub fn notify_bid_received(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        _: \u0026Bid, //bid\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"New Bid Received\");\n        let message = String::from_str(env, \"A new bid has been placed on your invoice\");\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::BidReceived,\n            NotificationPriority::Medium,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create bid accepted notification for investor\n    pub fn notify_bid_accepted(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        bid: \u0026Bid,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Bid Accepted\");\n        let message = String::from_str(\n            env,\n            \"Your bid has been accepted and funds are being escrowed\",\n        );\n\n        Self::create_notification(\n            env,\n            bid.investor.clone(),\n            NotificationType::BidAccepted,\n            NotificationPriority::High,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create payment received notification\n    pub fn notify_payment_received(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        _: i128, //amount\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Payment Received\");\n        let message = String::from_str(env, \"Payment has been received for your invoice\");\n\n        // Notify business\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::PaymentReceived,\n            NotificationPriority::High,\n            title.clone(),\n            message.clone(),\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor if applicable\n        if let Some(investor) = \u0026invoice.investor {\n            let investor_title = String::from_str(env, \"Investment Payment Received\");\n            let investor_message =\n                String::from_str(env, \"Payment has been received for an invoice you funded\");\n\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::PaymentReceived,\n                NotificationPriority::High,\n                investor_title,\n                investor_message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n\n        Ok(())\n    }\n\n    /// Create invoice defaulted notification\n    pub fn notify_invoice_defaulted(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Defaulted\");\n        let message = String::from_str(env, \"Your invoice has been marked as defaulted\");\n\n        // Notify business\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceDefaulted,\n            NotificationPriority::Critical,\n            title.clone(),\n            message.clone(),\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor if applicable\n        if let Some(investor) = \u0026invoice.investor {\n            let investor_title = String::from_str(env, \"Investment Defaulted\");\n            let investor_message = String::from_str(env, \"An invoice you funded has defaulted\");\n\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::InvoiceDefaulted,\n                NotificationPriority::Critical,\n                investor_title,\n                investor_message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":81,"address":[15619748,15618352,15619932],"length":1,"stats":{"Line":2}},{"line":90,"address":[15618435,15618766],"length":1,"stats":{"Line":3}},{"line":91,"address":[15618568],"length":1,"stats":{"Line":2}},{"line":92,"address":[15618634,15618704,15618586],"length":1,"stats":{"Line":4}},{"line":94,"address":[15619037],"length":1,"stats":{"Line":2}},{"line":97,"address":[15619152],"length":1,"stats":{"Line":1}},{"line":108,"address":[15619424],"length":1,"stats":{"Line":2}},{"line":113,"address":[15618224],"length":1,"stats":{"Line":0}},{"line":114,"address":[15618234],"length":1,"stats":{"Line":0}},{"line":115,"address":[15618241],"length":1,"stats":{"Line":0}},{"line":119,"address":[15618272],"length":1,"stats":{"Line":0}},{"line":120,"address":[15618296],"length":1,"stats":{"Line":0}},{"line":121,"address":[15618339,15618303],"length":1,"stats":{"Line":0}},{"line":122,"address":[15618328],"length":1,"stats":{"Line":0}},{"line":127,"address":[15618192],"length":1,"stats":{"Line":0}},{"line":128,"address":[15618202],"length":1,"stats":{"Line":0}},{"line":129,"address":[15618209],"length":1,"stats":{"Line":0}},{"line":133,"address":[15618256],"length":1,"stats":{"Line":0}},{"line":134,"address":[15618261],"length":1,"stats":{"Line":0}},{"line":159,"address":[15645984,15646255,15646277],"length":1,"stats":{"Line":1}},{"line":173,"address":[15646040,15646088],"length":1,"stats":{"Line":3}},{"line":178,"address":[15645600],"length":1,"stats":{"Line":1}},{"line":184,"address":[15645630,15645674],"length":1,"stats":{"Line":3}},{"line":186,"address":[15645752],"length":1,"stats":{"Line":0}},{"line":190,"address":[15645745],"length":1,"stats":{"Line":2}},{"line":196,"address":[15645662],"length":1,"stats":{"Line":0}},{"line":197,"address":[15645738],"length":1,"stats":{"Line":0}},{"line":200,"address":[15645729],"length":1,"stats":{"Line":1}},{"line":201,"address":[15645759],"length":1,"stats":{"Line":0}},{"line":205,"address":[15645660,15645771],"length":1,"stats":{"Line":2}},{"line":206,"address":[15645812],"length":1,"stats":{"Line":0}},{"line":207,"address":[15645828],"length":1,"stats":{"Line":1}},{"line":208,"address":[15645844],"length":1,"stats":{"Line":3}},{"line":209,"address":[15645860],"length":1,"stats":{"Line":1}},{"line":210,"address":[15645876],"length":1,"stats":{"Line":3}},{"line":211,"address":[15645892],"length":1,"stats":{"Line":1}},{"line":212,"address":[15645908],"length":1,"stats":{"Line":0}},{"line":213,"address":[15645924],"length":1,"stats":{"Line":0}},{"line":214,"address":[15645943],"length":1,"stats":{"Line":0}},{"line":215,"address":[15645962],"length":1,"stats":{"Line":0}},{"line":225,"address":[15620752,15622537,15622415],"length":1,"stats":{"Line":2}},{"line":235,"address":[15620829],"length":1,"stats":{"Line":1}},{"line":236,"address":[15620977,15621026],"length":1,"stats":{"Line":4}},{"line":237,"address":[15621037],"length":1,"stats":{"Line":0}},{"line":243,"address":[15621271,15621072],"length":1,"stats":{"Line":3}},{"line":244,"address":[15621284],"length":1,"stats":{"Line":1}},{"line":245,"address":[15621341],"length":1,"stats":{"Line":2}},{"line":246,"address":[15621380],"length":1,"stats":{"Line":1}},{"line":247,"address":[15621426],"length":1,"stats":{"Line":2}},{"line":248,"address":[15621469],"length":1,"stats":{"Line":1}},{"line":252,"address":[15621605],"length":1,"stats":{"Line":1}},{"line":255,"address":[15621662],"length":1,"stats":{"Line":2}},{"line":258,"address":[15621690,15621984],"length":1,"stats":{"Line":4}},{"line":259,"address":[15621697],"length":1,"stats":{"Line":1}},{"line":261,"address":[15621750],"length":1,"stats":{"Line":2}},{"line":262,"address":[15621823],"length":1,"stats":{"Line":1}},{"line":268,"address":[15622055],"length":1,"stats":{"Line":1}},{"line":272,"address":[15620464,15620732,15620738],"length":1,"stats":{"Line":2}},{"line":273,"address":[15620496],"length":1,"stats":{"Line":1}},{"line":274,"address":[15620520,15620564],"length":1,"stats":{"Line":3}},{"line":278,"address":[15620431,15620064,15620437],"length":1,"stats":{"Line":0}},{"line":279,"address":[15620118],"length":1,"stats":{"Line":0}},{"line":280,"address":[15620136,15620180,15620256],"length":1,"stats":{"Line":0}},{"line":284,"address":[15634976,15635831,15635837],"length":1,"stats":{"Line":0}},{"line":289,"address":[15635075,15635138,15635028,15635411],"length":1,"stats":{"Line":0}},{"line":290,"address":[15635049,15635124],"length":1,"stats":{"Line":0}},{"line":292,"address":[15635283,15635239],"length":1,"stats":{"Line":0}},{"line":294,"address":[15635384],"length":1,"stats":{"Line":0}},{"line":295,"address":[15635423,15635493],"length":1,"stats":{"Line":0}},{"line":296,"address":[15635440,15635495],"length":1,"stats":{"Line":0}},{"line":297,"address":[15635469,15635499],"length":1,"stats":{"Line":0}},{"line":298,"address":[15635452,15635497],"length":1,"stats":{"Line":0}},{"line":302,"address":[15635486],"length":1,"stats":{"Line":0}},{"line":305,"address":[15635698,15635514],"length":1,"stats":{"Line":0}},{"line":306,"address":[15635526],"length":1,"stats":{"Line":0}},{"line":307,"address":[15635643,15635579],"length":1,"stats":{"Line":0}},{"line":310,"address":[15635764],"length":1,"stats":{"Line":0}},{"line":314,"address":[15625614,15625200,15625608],"length":1,"stats":{"Line":2}},{"line":315,"address":[15625254],"length":1,"stats":{"Line":1}},{"line":316,"address":[15625272],"length":1,"stats":{"Line":2}},{"line":318,"address":[15625398],"length":1,"stats":{"Line":1}},{"line":319,"address":[12717136,12717153],"length":1,"stats":{"Line":5}},{"line":323,"address":[15625179,15624720,15625185],"length":1,"stats":{"Line":2}},{"line":324,"address":[15624776],"length":1,"stats":{"Line":1}},{"line":325,"address":[15624832],"length":1,"stats":{"Line":2}},{"line":327,"address":[15624961],"length":1,"stats":{"Line":1}},{"line":328,"address":[12717040,12717082],"length":1,"stats":{"Line":5}},{"line":332,"address":[15632415,15631744],"length":1,"stats":{"Line":0}},{"line":337,"address":[15631782,15631844],"length":1,"stats":{"Line":0}},{"line":338,"address":[15631887,15631928],"length":1,"stats":{"Line":0}},{"line":341,"address":[15632282,15632113],"length":1,"stats":{"Line":0}},{"line":342,"address":[15632314,15632125,15632378],"length":1,"stats":{"Line":0}},{"line":346,"address":[15635856,15636884,15636878],"length":1,"stats":{"Line":0}},{"line":347,"address":[15635904],"length":1,"stats":{"Line":0}},{"line":355,"address":[15636024,15636117,15636442,15635960],"length":1,"stats":{"Line":0}},{"line":356,"address":[15636213,15636328],"length":1,"stats":{"Line":0}},{"line":357,"address":[15636386],"length":1,"stats":{"Line":0}},{"line":358,"address":[15636444,15636566],"length":1,"stats":{"Line":0}},{"line":359,"address":[15636685],"length":1,"stats":{"Line":0}},{"line":360,"address":[15636463,15636636,15636659],"length":1,"stats":{"Line":0}},{"line":361,"address":[15636690,15636640,15636681],"length":1,"stats":{"Line":0}},{"line":363,"address":[15636852],"length":1,"stats":{"Line":0}},{"line":364,"address":[15636518,15636769,15636746],"length":1,"stats":{"Line":0}},{"line":365,"address":[15636750,15636794,15636820],"length":1,"stats":{"Line":0}},{"line":366,"address":[15636798,15636857,15636845],"length":1,"stats":{"Line":0}},{"line":368,"address":[15636489,15636712],"length":1,"stats":{"Line":0}},{"line":374,"address":[15636240],"length":1,"stats":{"Line":0}},{"line":378,"address":[15624640],"length":1,"stats":{"Line":2}},{"line":379,"address":[15624658],"length":1,"stats":{"Line":1}},{"line":382,"address":[15634896],"length":1,"stats":{"Line":1}},{"line":383,"address":[15634914],"length":1,"stats":{"Line":2}},{"line":387,"address":[15634873,15634879,15634448],"length":1,"stats":{"Line":1}},{"line":388,"address":[15634498],"length":1,"stats":{"Line":2}},{"line":389,"address":[15634518],"length":1,"stats":{"Line":1}},{"line":390,"address":[15634566,15634623],"length":1,"stats":{"Line":3}},{"line":391,"address":[15634660],"length":1,"stats":{"Line":1}},{"line":398,"address":[15625632,15626611,15626530],"length":1,"stats":{"Line":0}},{"line":402,"address":[15625671],"length":1,"stats":{"Line":0}},{"line":410,"address":[15625886,15625824],"length":1,"stats":{"Line":0}},{"line":413,"address":[15625894],"length":1,"stats":{"Line":0}},{"line":414,"address":[15625949],"length":1,"stats":{"Line":0}},{"line":415,"address":[15626007,15626076],"length":1,"stats":{"Line":0}},{"line":418,"address":[15626437],"length":1,"stats":{"Line":0}},{"line":422,"address":[15629605,15629686,15628704],"length":1,"stats":{"Line":2}},{"line":426,"address":[15628743],"length":1,"stats":{"Line":1}},{"line":434,"address":[15628896,15628958],"length":1,"stats":{"Line":3}},{"line":437,"address":[15628966],"length":1,"stats":{"Line":2}},{"line":438,"address":[15629021],"length":1,"stats":{"Line":1}},{"line":439,"address":[15629079,15629148],"length":1,"stats":{"Line":3}},{"line":442,"address":[15629512],"length":1,"stats":{"Line":2}},{"line":446,"address":[15639190,15638891,15636912],"length":1,"stats":{"Line":3}},{"line":452,"address":[15636977],"length":1,"stats":{"Line":3}},{"line":454,"address":[15637076],"length":1,"stats":{"Line":3}},{"line":456,"address":[15637188],"length":1,"stats":{"Line":0}},{"line":459,"address":[15637254],"length":1,"stats":{"Line":3}},{"line":462,"address":[15637283],"length":1,"stats":{"Line":0}},{"line":464,"address":[15637312],"length":1,"stats":{"Line":0}},{"line":465,"address":[15637341],"length":1,"stats":{"Line":0}},{"line":468,"address":[15637220,15637419],"length":1,"stats":{"Line":6}},{"line":470,"address":[15637427],"length":1,"stats":{"Line":3}},{"line":471,"address":[15637470],"length":1,"stats":{"Line":3}},{"line":472,"address":[15637480],"length":1,"stats":{"Line":0}},{"line":473,"address":[15637460],"length":1,"stats":{"Line":0}},{"line":478,"address":[15637493,15637553],"length":1,"stats":{"Line":6}},{"line":480,"address":[15637569],"length":1,"stats":{"Line":3}},{"line":481,"address":[15637631],"length":1,"stats":{"Line":3}},{"line":482,"address":[15637712,15637662],"length":1,"stats":{"Line":6}},{"line":483,"address":[15637790,15637720],"length":1,"stats":{"Line":6}},{"line":487,"address":[15638157],"length":1,"stats":{"Line":3}},{"line":490,"address":[15638218,15638257],"length":1,"stats":{"Line":6}},{"line":492,"address":[15638265],"length":1,"stats":{"Line":3}},{"line":493,"address":[15638276],"length":1,"stats":{"Line":3}},{"line":494,"address":[15638334],"length":1,"stats":{"Line":3}},{"line":495,"address":[15638398,15638471],"length":1,"stats":{"Line":6}},{"line":498,"address":[15638225],"length":1,"stats":{"Line":2}},{"line":502,"address":[15626640,15628665,15628428],"length":1,"stats":{"Line":0}},{"line":506,"address":[15626679],"length":1,"stats":{"Line":0}},{"line":507,"address":[15626864,15626794],"length":1,"stats":{"Line":0}},{"line":511,"address":[15626872,15626934],"length":1,"stats":{"Line":0}},{"line":514,"address":[15626942],"length":1,"stats":{"Line":0}},{"line":515,"address":[15626997],"length":1,"stats":{"Line":0}},{"line":516,"address":[15627058,15627127],"length":1,"stats":{"Line":0}},{"line":520,"address":[15628347,15627496],"length":1,"stats":{"Line":0}},{"line":521,"address":[15627615,15627554],"length":1,"stats":{"Line":0}},{"line":522,"address":[15627623,15627696],"length":1,"stats":{"Line":0}},{"line":527,"address":[15627712,15627762],"length":1,"stats":{"Line":0}},{"line":530,"address":[15627770],"length":1,"stats":{"Line":0}},{"line":531,"address":[15627834],"length":1,"stats":{"Line":0}},{"line":532,"address":[15627967,15627898],"length":1,"stats":{"Line":0}},{"line":536,"address":[15627581],"length":1,"stats":{"Line":0}},{"line":540,"address":[15624525,15623616,15624606],"length":1,"stats":{"Line":2}},{"line":545,"address":[15623663],"length":1,"stats":{"Line":1}},{"line":546,"address":[15623738,15623808],"length":1,"stats":{"Line":3}},{"line":550,"address":[15623816,15623878],"length":1,"stats":{"Line":3}},{"line":553,"address":[15623886],"length":1,"stats":{"Line":2}},{"line":554,"address":[15623941],"length":1,"stats":{"Line":1}},{"line":555,"address":[15624068,15623999],"length":1,"stats":{"Line":3}},{"line":558,"address":[15624432],"length":1,"stats":{"Line":2}},{"line":562,"address":[15623577,15622576,15623496],"length":1,"stats":{"Line":3}},{"line":567,"address":[15622628],"length":1,"stats":{"Line":3}},{"line":575,"address":[15622846,15622781],"length":1,"stats":{"Line":6}},{"line":578,"address":[15622854],"length":1,"stats":{"Line":3}},{"line":579,"address":[15622909],"length":1,"stats":{"Line":3}},{"line":580,"address":[15622970,15623039],"length":1,"stats":{"Line":6}},{"line":583,"address":[15623403],"length":1,"stats":{"Line":3}},{"line":587,"address":[15631730,15629728,15631509],"length":1,"stats":{"Line":1}},{"line":592,"address":[15629783],"length":1,"stats":{"Line":1}},{"line":593,"address":[15629874],"length":1,"stats":{"Line":1}},{"line":598,"address":[15629944,15630001],"length":1,"stats":{"Line":2}},{"line":601,"address":[15630022,15630067],"length":1,"stats":{"Line":2}},{"line":602,"address":[15630088,15630138],"length":1,"stats":{"Line":2}},{"line":603,"address":[15630146,15630212],"length":1,"stats":{"Line":2}},{"line":607,"address":[15630581,15631430],"length":1,"stats":{"Line":2}},{"line":608,"address":[15630698,15630639],"length":1,"stats":{"Line":2}},{"line":609,"address":[15630706,15630779],"length":1,"stats":{"Line":2}},{"line":614,"address":[15630845,15630795],"length":1,"stats":{"Line":2}},{"line":617,"address":[15630853],"length":1,"stats":{"Line":1}},{"line":618,"address":[15630917],"length":1,"stats":{"Line":1}},{"line":619,"address":[15630981,15631050],"length":1,"stats":{"Line":2}},{"line":623,"address":[15630666],"length":1,"stats":{"Line":1}},{"line":627,"address":[15634434,15632448,15634213],"length":1,"stats":{"Line":0}},{"line":631,"address":[15632487],"length":1,"stats":{"Line":0}},{"line":632,"address":[15632578],"length":1,"stats":{"Line":0}},{"line":637,"address":[15632705,15632648],"length":1,"stats":{"Line":0}},{"line":640,"address":[15632726,15632771],"length":1,"stats":{"Line":0}},{"line":641,"address":[15632792,15632842],"length":1,"stats":{"Line":0}},{"line":642,"address":[15632850,15632916],"length":1,"stats":{"Line":0}},{"line":646,"address":[15634134,15633285],"length":1,"stats":{"Line":0}},{"line":647,"address":[15633343,15633402],"length":1,"stats":{"Line":0}},{"line":648,"address":[15633410,15633483],"length":1,"stats":{"Line":0}},{"line":652,"address":[15633499,15633549],"length":1,"stats":{"Line":0}},{"line":655,"address":[15633557],"length":1,"stats":{"Line":0}},{"line":656,"address":[15633621],"length":1,"stats":{"Line":0}},{"line":657,"address":[15633754,15633685],"length":1,"stats":{"Line":0}},{"line":661,"address":[15633370],"length":1,"stats":{"Line":0}}],"covered":113,"coverable":215},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","payments.rs"],"content":"use crate::errors::QuickLendXError;\nuse soroban_sdk::token;\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env};\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum EscrowStatus {\n    Held,     // Funds are held in escrow\n    Released, // Funds released to business\n    Refunded, // Funds refunded to investor\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Escrow {\n    pub escrow_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub investor: Address,\n    pub business: Address,\n    pub amount: i128,\n    pub currency: Address,\n    pub created_at: u64,\n    pub status: EscrowStatus,\n}\n\npub struct EscrowStorage;\n\nimpl EscrowStorage {\n    pub fn store_escrow(env: \u0026Env, escrow: \u0026Escrow) {\n        env.storage().instance().set(\u0026escrow.escrow_id, escrow);\n        // Also store by invoice_id for easy lookup\n        env.storage().instance().set(\n            \u0026(symbol_short!(\"escrow\"), \u0026escrow.invoice_id),\n            \u0026escrow.escrow_id,\n        );\n    }\n\n    pub fn get_escrow(env: \u0026Env, escrow_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cEscrow\u003e {\n        env.storage().instance().get(escrow_id)\n    }\n\n    pub fn get_escrow_by_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cEscrow\u003e {\n        let escrow_id: Option\u003cBytesN\u003c32\u003e\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026(symbol_short!(\"escrow\"), invoice_id));\n        if let Some(id) = escrow_id {\n            Self::get_escrow(env, \u0026id)\n        } else {\n            None\n        }\n    }\n\n    pub fn update_escrow(env: \u0026Env, escrow: \u0026Escrow) {\n        env.storage().instance().set(\u0026escrow.escrow_id, escrow);\n    }\n\n    pub fn generate_unique_escrow_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"esc_cnt\");\n        let counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add escrow prefix to distinguish from other entity types\n        id_bytes[0] = 0xE5; // 'E' for Escrow\n        id_bytes[1] = 0xC0; // 'C' for sCrow\n                            // Embed timestamp in next 8 bytes\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter in next 8 bytes\n        id_bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes with a pattern to ensure uniqueness\n        for i in 18..32 {\n            id_bytes[i] = ((timestamp + counter + 0xE5C0) % 256) as u8;\n        }\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n}\n\n/// Create escrow when bid is accepted\npub fn create_escrow(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    business: \u0026Address,\n    amount: i128,\n    currency: \u0026Address,\n) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n    if amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Move funds from investor into contract-controlled escrow\n    let contract_address = env.current_contract_address();\n    transfer_funds(env, currency, investor, \u0026contract_address, amount)?;\n\n    let escrow_id = EscrowStorage::generate_unique_escrow_id(env);\n    let escrow = Escrow {\n        escrow_id: escrow_id.clone(),\n        invoice_id: invoice_id.clone(),\n        investor: investor.clone(),\n        business: business.clone(),\n        amount,\n        currency: currency.clone(),\n        created_at: env.ledger().timestamp(),\n        status: EscrowStatus::Held,\n    };\n\n    EscrowStorage::store_escrow(env, \u0026escrow);\n    Ok(escrow_id)\n}\n\n/// Release escrow funds to business upon invoice verification\npub fn release_escrow(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    let mut escrow = EscrowStorage::get_escrow_by_invoice(env, invoice_id)\n        .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n    if escrow.status != EscrowStatus::Held {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Transfer funds from escrow (contract) to business\n    let contract_address = env.current_contract_address();\n    transfer_funds(\n        env,\n        \u0026escrow.currency,\n        \u0026contract_address,\n        \u0026escrow.business,\n        escrow.amount,\n    )?;\n\n    // Update escrow status\n    escrow.status = EscrowStatus::Released;\n    EscrowStorage::update_escrow(env, \u0026escrow);\n\n    Ok(())\n}\n\n/// Refund escrow funds to investor if verification fails\npub fn refund_escrow(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    let mut escrow = EscrowStorage::get_escrow_by_invoice(env, invoice_id)\n        .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n    if escrow.status != EscrowStatus::Held {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Refund funds from escrow (contract) back to investor\n    let contract_address = env.current_contract_address();\n    transfer_funds(\n        env,\n        \u0026escrow.currency,\n        \u0026contract_address,\n        \u0026escrow.investor,\n        escrow.amount,\n    )?;\n\n    // Update escrow status\n    escrow.status = EscrowStatus::Refunded;\n    EscrowStorage::update_escrow(env, \u0026escrow);\n\n    Ok(())\n}\n\n/// Transfer funds between addresses\npub fn transfer_funds(\n    env: \u0026Env,\n    currency: \u0026Address,\n    from: \u0026Address,\n    to: \u0026Address,\n    amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    if from == to {\n        return Ok(());\n    }\n\n    let token_client = token::Client::new(env, currency);\n    let contract_address = env.current_contract_address();\n\n    // Ensure sufficient balance exists before attempting transfer\n    let available_balance = token_client.balance(from);\n    if available_balance \u003c amount {\n        return Err(QuickLendXError::InsufficientFunds);\n    }\n\n    if from == \u0026contract_address {\n        token_client.transfer(from, to, \u0026amount);\n        return Ok(());\n    }\n\n    let allowance = token_client.allowance(from, \u0026contract_address);\n    if allowance \u003c amount {\n        return Err(QuickLendXError::OperationNotAllowed);\n    }\n\n    token_client.transfer_from(\u0026contract_address, from, to, \u0026amount);\n    Ok(())\n}\n","traces":[{"line":29,"address":[12312560,12313074,12313080],"length":1,"stats":{"Line":3}},{"line":30,"address":[12312609],"length":1,"stats":{"Line":3}},{"line":32,"address":[12312785,12312936],"length":1,"stats":{"Line":6}},{"line":33,"address":[12312859],"length":1,"stats":{"Line":3}},{"line":34,"address":[12312919],"length":1,"stats":{"Line":3}},{"line":38,"address":[12312320,12312532,12312538],"length":1,"stats":{"Line":3}},{"line":39,"address":[12312447,12312365],"length":1,"stats":{"Line":6}},{"line":42,"address":[12313328,12313969,12313985],"length":1,"stats":{"Line":0}},{"line":43,"address":[12313371],"length":1,"stats":{"Line":0}},{"line":46,"address":[12314014,12313467,12313418],"length":1,"stats":{"Line":0}},{"line":47,"address":[12313775,12313883],"length":1,"stats":{"Line":0}},{"line":48,"address":[12313864],"length":1,"stats":{"Line":0}},{"line":50,"address":[12313876],"length":1,"stats":{"Line":0}},{"line":54,"address":[12313297,12313104,12313303],"length":1,"stats":{"Line":0}},{"line":55,"address":[12313142],"length":1,"stats":{"Line":0}},{"line":58,"address":[12315597,12314048,12315591],"length":1,"stats":{"Line":3}},{"line":59,"address":[12314103],"length":1,"stats":{"Line":3}},{"line":60,"address":[12314220],"length":1,"stats":{"Line":3}},{"line":61,"address":[12314273,12314324],"length":1,"stats":{"Line":6}},{"line":62,"address":[12314581],"length":1,"stats":{"Line":3}},{"line":64,"address":[12314836],"length":1,"stats":{"Line":3}},{"line":66,"address":[12314856],"length":1,"stats":{"Line":3}},{"line":67,"address":[12314864],"length":1,"stats":{"Line":3}},{"line":69,"address":[12314872],"length":1,"stats":{"Line":3}},{"line":71,"address":[12315040],"length":1,"stats":{"Line":3}},{"line":73,"address":[12315555,12315196],"length":1,"stats":{"Line":6}},{"line":74,"address":[12315359,12315447,12315565],"length":1,"stats":{"Line":6}},{"line":77,"address":[12315393],"length":1,"stats":{"Line":3}},{"line":82,"address":[12317108,12315616,12316966],"length":1,"stats":{"Line":3}},{"line":90,"address":[12315748],"length":1,"stats":{"Line":3}},{"line":91,"address":[12315838],"length":1,"stats":{"Line":0}},{"line":95,"address":[12315773],"length":1,"stats":{"Line":3}},{"line":96,"address":[12315822,12315898],"length":1,"stats":{"Line":4}},{"line":98,"address":[12315999],"length":1,"stats":{"Line":3}},{"line":100,"address":[12316014],"length":1,"stats":{"Line":3}},{"line":101,"address":[12316087],"length":1,"stats":{"Line":3}},{"line":102,"address":[12316160],"length":1,"stats":{"Line":3}},{"line":103,"address":[12316221],"length":1,"stats":{"Line":3}},{"line":105,"address":[12316282],"length":1,"stats":{"Line":3}},{"line":106,"address":[12316343,12316391],"length":1,"stats":{"Line":6}},{"line":110,"address":[12316816],"length":1,"stats":{"Line":3}},{"line":111,"address":[12316828],"length":1,"stats":{"Line":3}},{"line":115,"address":[12318426,12318420,12317792],"length":1,"stats":{"Line":0}},{"line":116,"address":[12317865,12317927,12317826],"length":1,"stats":{"Line":0}},{"line":117,"address":[12317913,12317839],"length":1,"stats":{"Line":0}},{"line":119,"address":[12318015,12318082],"length":1,"stats":{"Line":0}},{"line":120,"address":[12318112],"length":1,"stats":{"Line":0}},{"line":124,"address":[12318093],"length":1,"stats":{"Line":0}},{"line":127,"address":[12318130],"length":1,"stats":{"Line":0}},{"line":129,"address":[12318138],"length":1,"stats":{"Line":0}},{"line":130,"address":[12318146],"length":1,"stats":{"Line":0}},{"line":134,"address":[12318312],"length":1,"stats":{"Line":0}},{"line":135,"address":[12318325],"length":1,"stats":{"Line":0}},{"line":137,"address":[12318332],"length":1,"stats":{"Line":0}},{"line":141,"address":[12317136,12317764,12317770],"length":1,"stats":{"Line":0}},{"line":142,"address":[12317170,12317271,12317209],"length":1,"stats":{"Line":0}},{"line":143,"address":[12317183,12317257],"length":1,"stats":{"Line":0}},{"line":145,"address":[12317359,12317426],"length":1,"stats":{"Line":0}},{"line":146,"address":[12317456],"length":1,"stats":{"Line":0}},{"line":150,"address":[12317437],"length":1,"stats":{"Line":0}},{"line":153,"address":[12317474],"length":1,"stats":{"Line":0}},{"line":155,"address":[12317482],"length":1,"stats":{"Line":0}},{"line":156,"address":[12317490],"length":1,"stats":{"Line":0}},{"line":160,"address":[12317656],"length":1,"stats":{"Line":0}},{"line":161,"address":[12317669],"length":1,"stats":{"Line":0}},{"line":163,"address":[12317676],"length":1,"stats":{"Line":0}},{"line":167,"address":[12319105,12318448,12319111],"length":1,"stats":{"Line":3}},{"line":174,"address":[12318501],"length":1,"stats":{"Line":3}},{"line":175,"address":[12318545],"length":1,"stats":{"Line":0}},{"line":178,"address":[12318523],"length":1,"stats":{"Line":3}},{"line":179,"address":[12318606],"length":1,"stats":{"Line":0}},{"line":182,"address":[12318568],"length":1,"stats":{"Line":3}},{"line":183,"address":[12318587],"length":1,"stats":{"Line":3}},{"line":186,"address":[12318660,12318742],"length":1,"stats":{"Line":6}},{"line":187,"address":[12318758],"length":1,"stats":{"Line":3}},{"line":188,"address":[12318822],"length":1,"stats":{"Line":0}},{"line":191,"address":[12318839,12318786],"length":1,"stats":{"Line":6}},{"line":192,"address":[12318884],"length":1,"stats":{"Line":0}},{"line":193,"address":[12319082],"length":1,"stats":{"Line":0}},{"line":196,"address":[12318845,12318928],"length":1,"stats":{"Line":6}},{"line":197,"address":[12318944],"length":1,"stats":{"Line":3}},{"line":198,"address":[12319003],"length":1,"stats":{"Line":0}},{"line":201,"address":[12318964],"length":1,"stats":{"Line":3}},{"line":202,"address":[12319013],"length":1,"stats":{"Line":2}}],"covered":45,"coverable":84},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","profits.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::events::emit_platform_fee_updated;\nuse soroban_sdk::{contracttype, symbol_short, Address, Env};\n\nconst DEFAULT_PLATFORM_FEE_BPS: i128 = 200; // 2%\nconst MAX_PLATFORM_FEE_BPS: i128 = 1_000; // 10%\n\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct PlatformFeeConfig {\n    pub fee_bps: i128,\n    pub updated_at: u64,\n    pub updated_by: Address,\n}\n\npub struct PlatformFee;\n\nimpl PlatformFee {\n    const STORAGE_KEY: soroban_sdk::Symbol = symbol_short!(\"fee_cfg\");\n\n    fn default_config(env: \u0026Env) -\u003e PlatformFeeConfig {\n        PlatformFeeConfig {\n            fee_bps: DEFAULT_PLATFORM_FEE_BPS,\n            updated_at: 0,\n            updated_by: env.current_contract_address(),\n        }\n    }\n\n    pub fn get_config(env: \u0026Env) -\u003e PlatformFeeConfig {\n        env.storage()\n            .instance()\n            .get(\u0026Self::STORAGE_KEY)\n            .unwrap_or_else(|| Self::default_config(env))\n    }\n\n    pub fn set_config(\n        env: \u0026Env,\n        admin: \u0026Address,\n        new_fee_bps: i128,\n    ) -\u003e Result\u003cPlatformFeeConfig, QuickLendXError\u003e {\n        admin.require_auth();\n\n        if new_fee_bps \u003c 0 || new_fee_bps \u003e MAX_PLATFORM_FEE_BPS {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let config = PlatformFeeConfig {\n            fee_bps: new_fee_bps,\n            updated_at: env.ledger().timestamp(),\n            updated_by: admin.clone(),\n        };\n\n        env.storage().instance().set(\u0026Self::STORAGE_KEY, \u0026config);\n        emit_platform_fee_updated(env, \u0026config);\n        Ok(config)\n    }\n\n    pub fn calculate(env: \u0026Env, investment_amount: i128, payment_amount: i128) -\u003e (i128, i128) {\n        let config = Self::get_config(env);\n        let profit = payment_amount.saturating_sub(investment_amount);\n        if profit \u003c= 0 {\n            return (payment_amount.max(0), 0);\n        }\n\n        let platform_fee = profit.saturating_mul(config.fee_bps) / 10_000;\n        let investor_return = payment_amount.saturating_sub(platform_fee);\n        (investor_return, platform_fee)\n    }\n}\n\npub fn calculate_profit(env: \u0026Env, investment_amount: i128, payment_amount: i128) -\u003e (i128, i128) {\n    PlatformFee::calculate(env, investment_amount, payment_amount)\n}\n","traces":[{"line":21,"address":[15989952],"length":1,"stats":{"Line":1}},{"line":25,"address":[15989970],"length":1,"stats":{"Line":1}},{"line":29,"address":[15989138,15989144,15988784],"length":1,"stats":{"Line":1}},{"line":30,"address":[15988826],"length":1,"stats":{"Line":1}},{"line":32,"address":[15988896],"length":1,"stats":{"Line":1}},{"line":33,"address":[13872608,13872625],"length":1,"stats":{"Line":3}},{"line":36,"address":[15989927,15989921,15989168],"length":1,"stats":{"Line":0}},{"line":41,"address":[15989245],"length":1,"stats":{"Line":0}},{"line":43,"address":[15989259],"length":1,"stats":{"Line":0}},{"line":44,"address":[15989296],"length":1,"stats":{"Line":0}},{"line":49,"address":[15989328],"length":1,"stats":{"Line":0}},{"line":50,"address":[15989410],"length":1,"stats":{"Line":0}},{"line":53,"address":[15989555],"length":1,"stats":{"Line":0}},{"line":54,"address":[15989855],"length":1,"stats":{"Line":0}},{"line":55,"address":[15989862],"length":1,"stats":{"Line":0}},{"line":58,"address":[15990645,15990651,15990048],"length":1,"stats":{"Line":1}},{"line":59,"address":[15990133],"length":1,"stats":{"Line":1}},{"line":60,"address":[15990237,15990158],"length":1,"stats":{"Line":2}},{"line":61,"address":[15990253],"length":1,"stats":{"Line":1}},{"line":62,"address":[15990324,15990607],"length":1,"stats":{"Line":2}},{"line":65,"address":[15990490,15990353,15990281],"length":1,"stats":{"Line":2}},{"line":66,"address":[15990473,15990535],"length":1,"stats":{"Line":2}},{"line":67,"address":[15990551],"length":1,"stats":{"Line":1}},{"line":71,"address":[15990672],"length":1,"stats":{"Line":1}},{"line":72,"address":[15990708],"length":1,"stats":{"Line":1}}],"covered":16,"coverable":25},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","settlement.rs"],"content":"use crate::audit::log_payment_processed;\nuse crate::errors::QuickLendXError;\nuse crate::events::{emit_invoice_settled, emit_partial_payment};\nuse crate::investment::{InvestmentStatus, InvestmentStorage};\nuse crate::invoice::{InvoiceStatus, InvoiceStorage};\nuse crate::notifications::NotificationSystem;\nuse crate::payments::transfer_funds;\nuse crate::profits::calculate_profit;\nuse soroban_sdk::{BytesN, Env, String};\n\npub fn process_partial_payment(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    payment_amount: i128,\n    transaction_id: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if payment_amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    let business = invoice.business.clone();\n    business.require_auth();\n\n    let tx_for_event = transaction_id.clone();\n    let progress = invoice.record_payment(env, payment_amount, transaction_id)?;\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    emit_partial_payment(\n        env,\n        \u0026invoice,\n        payment_amount,\n        invoice.total_paid,\n        progress,\n        tx_for_event,\n    );\n    log_payment_processed(\n        env,\n        invoice.id.clone(),\n        business.clone(),\n        payment_amount,\n        String::from_str(env, \"partial\"),\n    );\n\n    if invoice.is_fully_paid() {\n        // Use internal function to avoid duplicate require_auth call\n        settle_invoice_internal(env, invoice_id, invoice.total_paid)?;\n    }\n\n    Ok(())\n}\n\npub fn settle_invoice(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    payment_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if payment_amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Get and validate invoice\n    let invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Require business authorization for direct settlement calls\n    invoice.business.require_auth();\n\n    // Delegate to internal settlement logic\n    settle_invoice_internal(env, invoice_id, payment_amount)\n}\n\n/// Internal settlement logic - no auth required (caller must verify authorization)\nfn settle_invoice_internal(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    payment_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if payment_amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Get and validate invoice\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Get investor from invoice\n    let investor_address = invoice\n        .investor\n        .clone()\n        .ok_or(QuickLendXError::NotInvestor)?;\n\n    // Get investment details\n    let investment = InvestmentStorage::get_investment_by_invoice(env, invoice_id)\n        .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n    // Ensure the recorded total reflects the latest payment attempt\n    let mut total_payment = invoice.total_paid;\n    if total_payment == 0 {\n        invoice.record_payment(env, payment_amount, String::from_str(env, \"settlement\"))?;\n        total_payment = invoice.total_paid;\n    } else if payment_amount \u003e total_payment {\n        let additional = payment_amount.saturating_sub(total_payment);\n        if additional \u003e 0 {\n            invoice.record_payment(env, additional, String::from_str(env, \"settlement_adj\"))?;\n        }\n        total_payment = invoice.total_paid;\n    } else {\n        total_payment = total_payment.max(payment_amount);\n        invoice.total_paid = total_payment;\n    }\n\n    if total_payment \u003c investment.amount || total_payment \u003c invoice.amount {\n        return Err(QuickLendXError::PaymentTooLow);\n    }\n\n    // Calculate profit and platform fee\n    let (investor_return, platform_fee) = calculate_profit(env, investment.amount, total_payment);\n\n    // Transfer funds to investor and platform\n    let business_address = invoice.business.clone();\n    transfer_funds(\n        env,\n        \u0026invoice.currency,\n        \u0026business_address,\n        \u0026investor_address,\n        investor_return,\n    )?;\n\n    if platform_fee \u003e 0 {\n        let platform_account = env.current_contract_address();\n        transfer_funds(\n            env,\n            \u0026invoice.currency,\n            \u0026business_address,\n            \u0026platform_account,\n            platform_fee,\n        )?;\n    }\n\n    // Update invoice status\n    let previous_status = invoice.status.clone();\n    invoice.mark_as_paid(env, business_address.clone(), env.ledger().timestamp());\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n    if previous_status != invoice.status {\n        InvoiceStorage::remove_from_status_invoices(env, \u0026previous_status, invoice_id);\n        InvoiceStorage::add_to_status_invoices(env, \u0026invoice.status, invoice_id);\n    }\n\n    // Update investment status\n    let mut updated_investment = investment;\n    updated_investment.status = InvestmentStatus::Completed;\n    InvestmentStorage::update_investment(env, \u0026updated_investment);\n\n    log_payment_processed(\n        env,\n        invoice.id.clone(),\n        business_address.clone(),\n        total_payment,\n        String::from_str(env, \"final\"),\n    );\n\n    // Emit settlement event\n    emit_invoice_settled(env, \u0026invoice, investor_return, platform_fee);\n\n    // Send notification about payment received\n    let _ = NotificationSystem::notify_payment_received(env, \u0026invoice, total_payment);\n\n    Ok(())\n}\n","traces":[{"line":11,"address":[14580748,14580900,14579216],"length":1,"stats":{"Line":1}},{"line":17,"address":[14579298],"length":1,"stats":{"Line":2}},{"line":18,"address":[14579375],"length":1,"stats":{"Line":0}},{"line":21,"address":[14580891,14579368,14579453],"length":1,"stats":{"Line":4}},{"line":24,"address":[14579686,14579616],"length":1,"stats":{"Line":4}},{"line":25,"address":[14579715],"length":1,"stats":{"Line":0}},{"line":28,"address":[14579692],"length":1,"stats":{"Line":2}},{"line":29,"address":[14579731],"length":1,"stats":{"Line":2}},{"line":31,"address":[14579804],"length":1,"stats":{"Line":2}},{"line":32,"address":[14579965,14579842,14580780],"length":1,"stats":{"Line":3}},{"line":33,"address":[14580083],"length":1,"stats":{"Line":1}},{"line":39,"address":[14580112],"length":1,"stats":{"Line":1}},{"line":41,"address":[14580128],"length":1,"stats":{"Line":1}},{"line":45,"address":[14580216],"length":1,"stats":{"Line":2}},{"line":46,"address":[14580320,14580267],"length":1,"stats":{"Line":4}},{"line":48,"address":[14580328],"length":1,"stats":{"Line":2}},{"line":51,"address":[14580482],"length":1,"stats":{"Line":2}},{"line":53,"address":[14580554,14580707],"length":1,"stats":{"Line":1}},{"line":56,"address":[14580503],"length":1,"stats":{"Line":2}},{"line":59,"address":[14579194,14578720,14579200],"length":1,"stats":{"Line":1}},{"line":64,"address":[14578794],"length":1,"stats":{"Line":1}},{"line":65,"address":[14578906],"length":1,"stats":{"Line":0}},{"line":69,"address":[14578816,14578919],"length":1,"stats":{"Line":1}},{"line":72,"address":[14579088,14579021],"length":1,"stats":{"Line":2}},{"line":73,"address":[14579113],"length":1,"stats":{"Line":0}},{"line":77,"address":[14579094],"length":1,"stats":{"Line":1}},{"line":80,"address":[14579153],"length":1,"stats":{"Line":1}},{"line":84,"address":[14584569,14580960,14584814],"length":1,"stats":{"Line":1}},{"line":89,"address":[14581046],"length":1,"stats":{"Line":1}},{"line":90,"address":[14581196],"length":1,"stats":{"Line":0}},{"line":94,"address":[14581212,14581106],"length":1,"stats":{"Line":1}},{"line":97,"address":[14581338,14581414],"length":1,"stats":{"Line":2}},{"line":98,"address":[14581443],"length":1,"stats":{"Line":0}},{"line":102,"address":[14581420,14581503,14584805,14581551],"length":1,"stats":{"Line":2}},{"line":105,"address":[14581480,14581537],"length":1,"stats":{"Line":1}},{"line":108,"address":[14581790,14584771,14581838,14581695],"length":1,"stats":{"Line":2}},{"line":109,"address":[14581824,14581767],"length":1,"stats":{"Line":1}},{"line":112,"address":[14581958],"length":1,"stats":{"Line":1}},{"line":113,"address":[14581990,14582904],"length":1,"stats":{"Line":2}},{"line":114,"address":[14582063,14582742,14584707],"length":1,"stats":{"Line":2}},{"line":115,"address":[14582872],"length":1,"stats":{"Line":1}},{"line":116,"address":[14582029,14582440],"length":1,"stats":{"Line":1}},{"line":117,"address":[14582380,14582168],"length":1,"stats":{"Line":0}},{"line":118,"address":[14582398,14582665],"length":1,"stats":{"Line":0}},{"line":119,"address":[14582677,14582450],"length":1,"stats":{"Line":0}},{"line":121,"address":[14582408],"length":1,"stats":{"Line":0}},{"line":123,"address":[14582109,14582267],"length":1,"stats":{"Line":2}},{"line":124,"address":[14582283],"length":1,"stats":{"Line":1}},{"line":127,"address":[14582315,14582909],"length":1,"stats":{"Line":2}},{"line":128,"address":[14582951],"length":1,"stats":{"Line":0}},{"line":132,"address":[14582975],"length":1,"stats":{"Line":1}},{"line":135,"address":[14583106],"length":1,"stats":{"Line":1}},{"line":138,"address":[14583147],"length":1,"stats":{"Line":1}},{"line":144,"address":[14583329],"length":1,"stats":{"Line":1}},{"line":145,"address":[14583369],"length":1,"stats":{"Line":1}},{"line":148,"address":[14583406],"length":1,"stats":{"Line":1}},{"line":156,"address":[14583602,14583339],"length":1,"stats":{"Line":2}},{"line":157,"address":[14583625,14583731,14584597],"length":1,"stats":{"Line":1}},{"line":158,"address":[14583859],"length":1,"stats":{"Line":1}},{"line":159,"address":[14583866],"length":1,"stats":{"Line":1}},{"line":160,"address":[14583998],"length":1,"stats":{"Line":1}},{"line":161,"address":[14584021],"length":1,"stats":{"Line":1}},{"line":165,"address":[14583903],"length":1,"stats":{"Line":2}},{"line":166,"address":[14583959],"length":1,"stats":{"Line":2}},{"line":167,"address":[14583967],"length":1,"stats":{"Line":1}},{"line":171,"address":[14584081],"length":1,"stats":{"Line":1}},{"line":172,"address":[14584132,14584185],"length":1,"stats":{"Line":3}},{"line":173,"address":[14584193],"length":1,"stats":{"Line":2}},{"line":174,"address":[14584219],"length":1,"stats":{"Line":2}},{"line":178,"address":[14584401],"length":1,"stats":{"Line":2}},{"line":181,"address":[14584416],"length":1,"stats":{"Line":1}},{"line":183,"address":[14584447],"length":1,"stats":{"Line":1}}],"covered":61,"coverable":72},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test.rs"],"content":"use super::*;\nuse crate::audit::{AuditOperation, AuditOperationFilter, AuditQueryFilter};\nuse crate::bid::{BidStatus, BidStorage};\nuse crate::investment::{Investment, InvestmentStorage};\nuse crate::invoice::{DisputeStatus, InvoiceCategory, InvoiceMetadata, LineItemRecord};\nuse crate::verification::BusinessVerificationStatus;\nuse soroban_sdk::{\n    testutils::{Address as _, Ledger},\n    token, Address, BytesN, Env, String, Vec,\n};\n\nfn verify_investor_for_test(\n    env: \u0026Env,\n    client: \u0026QuickLendXContractClient,\n    investor: \u0026Address,\n    limit: i128,\n) {\n    client.submit_investor_kyc(investor, \u0026String::from_str(env, \"Investor KYC\"));\n    client.verify_investor(investor, \u0026limit);\n}\n\n#[test]\nfn test_store_invoice() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000;\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    let description = String::from_str(\u0026env, \"Test invoice for services\");\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify invoice was stored\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n    assert_eq!(invoice.currency, currency);\n    assert_eq!(invoice.due_date, due_date);\n    assert_eq!(invoice.description, description);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.funded_amount, 0);\n    assert!(invoice.investor.is_none());\n}\n\n#[test]\nfn test_store_invoice_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Valid invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify invoice was created\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.amount, 1000);\n    assert_eq!(invoice.business, business);\n}\n\n#[test]\nfn test_get_business_invoices() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices for business1\n    let invoice1_id = client.store_invoice(\n        \u0026business1,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice2_id = client.store_invoice(\n        \u0026business1,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Create invoice for business2\n    let invoice3_id = client.store_invoice(\n        \u0026business2,\n        \u00263000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 3\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get invoices for business1\n    let business1_invoices = client.get_business_invoices(\u0026business1);\n    assert_eq!(business1_invoices.len(), 2);\n    assert!(business1_invoices.contains(\u0026invoice1_id));\n    assert!(business1_invoices.contains(\u0026invoice2_id));\n\n    // Get invoices for business2\n    let business2_invoices = client.get_business_invoices(\u0026business2);\n    assert_eq!(business2_invoices.len(), 1);\n    assert!(business2_invoices.contains(\u0026invoice3_id));\n}\n\n#[test]\nfn test_get_invoices_by_status() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices\n    let invoice1_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice2_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get pending invoices\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_invoices.len(), 2);\n    assert!(pending_invoices.contains(\u0026invoice1_id));\n    assert!(pending_invoices.contains(\u0026invoice2_id));\n\n    // Get verified invoices (should be empty initially)\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_invoices.len(), 0);\n}\n\n#[test]\nfn test_update_invoice_status() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify invoice starts as pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    // Update to verified\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    // Check status lists\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_invoices.len(), 0);\n\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_invoices.len(), 1);\n    assert!(verified_invoices.contains(\u0026invoice_id));\n}\n\n#[test]\nfn test_update_invoice_metadata_and_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Metadata invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let mut line_items = Vec::new(\u0026env);\n    line_items.push_back(LineItemRecord(\n        String::from_str(\u0026env, \"Consulting\"),\n        5,\n        200,\n        1_000,\n    ));\n\n    let metadata = InvoiceMetadata {\n        customer_name: String::from_str(\u0026env, \"Acme Corp\"),\n        customer_address: String::from_str(\u0026env, \"123 Market St\"),\n        tax_id: String::from_str(\u0026env, \"TAX-123\"),\n        line_items,\n        notes: String::from_str(\u0026env, \"Net 30\"),\n    };\n\n    client.update_invoice_metadata(\u0026invoice_id, \u0026metadata);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    let stored_metadata = invoice.metadata().expect(\"metadata must be stored\");\n    assert_eq!(stored_metadata.customer_name, metadata.customer_name);\n    assert_eq!(stored_metadata.tax_id, metadata.tax_id);\n    assert_eq!(stored_metadata.line_items.len(), 1);\n    let stored_line_item = stored_metadata.line_items.get(0).expect(\"line item\");\n    assert_eq!(stored_line_item.3, 1_000);\n\n    let customer_invoices = client.get_invoices_by_customer(\u0026metadata.customer_name);\n    assert!(customer_invoices.contains(\u0026invoice_id));\n\n    let tax_invoices = client.get_invoices_by_tax_id(\u0026metadata.tax_id);\n    assert!(tax_invoices.contains(\u0026invoice_id));\n\n    client.clear_invoice_metadata(\u0026invoice_id);\n\n    let cleared_invoice = client.get_invoice(\u0026invoice_id);\n    assert!(cleared_invoice.metadata().is_none());\n\n    let customer_invoices_after_clear = client.get_invoices_by_customer(\u0026metadata.customer_name);\n    assert!(!customer_invoices_after_clear.contains(\u0026invoice_id));\n}\n\n#[test]\nfn test_invoice_metadata_validation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invalid metadata invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let mut invalid_items = Vec::new(\u0026env);\n    invalid_items.push_back(LineItemRecord(\n        String::from_str(\u0026env, \"Consulting\"),\n        2,\n        250,\n        500,\n    ));\n\n    let invalid_metadata = InvoiceMetadata {\n        customer_name: String::from_str(\u0026env, \"Beta LLC\"),\n        customer_address: String::from_str(\u0026env, \"456 Elm St\"),\n        tax_id: String::from_str(\u0026env, \"TAX-456\"),\n        line_items: invalid_items,\n        notes: String::from_str(\u0026env, \"Review\"),\n    };\n\n    let result = client.try_update_invoice_metadata(\u0026invoice_id, \u0026invalid_metadata);\n    let err = result.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::InvoiceAmountInvalid);\n\n    let mut invalid_line = Vec::new(\u0026env);\n    invalid_line.push_back(LineItemRecord(\n        String::from_str(\u0026env, \"Consulting\"),\n        0,\n        1,\n        0,\n    ));\n\n    let invalid_line_metadata = InvoiceMetadata {\n        customer_name: String::from_str(\u0026env, \"Gamma LLC\"),\n        customer_address: String::from_str(\u0026env, \"789 Oak St\"),\n        tax_id: String::from_str(\u0026env, \"TAX-789\"),\n        line_items: invalid_line,\n        notes: String::from_str(\u0026env, \"Invalid\"),\n    };\n\n    let result_line = client.try_update_invoice_metadata(\u0026invoice_id, \u0026invalid_line_metadata);\n    let err_line = result_line.err().expect(\"expected error\");\n    let contract_error_line = err_line.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error_line, QuickLendXError::InvalidAmount);\n}\n\n#[test]\nfn test_investor_verification_enforced() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Investor verification invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n\n    let bid_attempt = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n    let err = bid_attempt.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::BusinessNotVerified);\n\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC\"));\n\n    let pending_attempt = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n    let pending_err = pending_attempt.err().expect(\"expected pending error\");\n    let pending_contract_error = pending_err.expect(\"expected contract invoke error\");\n    assert_eq!(pending_contract_error, QuickLendXError::KYCAlreadyPending);\n\n    client.verify_investor(\u0026investor, \u00261_000);\n\n    let verification = client\n        .get_investor_verification(\u0026investor)\n        .expect(\"verification record\");\n    assert_eq!(verification.investment_limit, 750);\n    assert!(matches!(\n        verification.status,\n        BusinessVerificationStatus::Verified\n    ));\n\n    let _bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n\n    let over_limit = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00261_500, \u00261_700);\n    let limit_err = over_limit.err().expect(\"expected limit error\");\n    let limit_contract_error = limit_err.expect(\"expected invoke error\");\n    assert_eq!(limit_contract_error, QuickLendXError::InvalidAmount);\n}\n\n#[test]\nfn test_get_available_invoices() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices\n    let invoice1_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let _invoice2_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Initially no available invoices (all pending)\n    let available_invoices = client.get_available_invoices();\n    assert_eq!(available_invoices.len(), 0);\n\n    // Verify one invoice\n    client.update_invoice_status(\u0026invoice1_id, \u0026InvoiceStatus::Verified);\n\n    // Now one available invoice\n    let available_invoices = client.get_available_invoices();\n    assert_eq!(available_invoices.len(), 1);\n    assert!(available_invoices.contains(\u0026invoice1_id));\n}\n\n#[test]\nfn test_invoice_count_functions() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices\n    client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Test count by status\n    let pending_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_count, 2);\n\n    let verified_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_count, 0);\n\n    // Test total count\n    let total_count = client.get_total_invoice_count();\n    assert_eq!(total_count, 2);\n}\n\n#[test]\nfn test_invoice_not_found() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let fake_id = BytesN::from_array(\u0026env, \u0026[0u8; 32]);\n\n    let result = client.try_get_invoice(\u0026fake_id);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_invoice_lifecycle() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Test lifecycle: Pending -\u003e Verified -\u003e Paid\n    let mut invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Paid);\n    invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert!(invoice.settled_at.is_some());\n}\n\n#[test]\nfn test_simple_bid_storage() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place a single bid to test basic functionality\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026900, \u00261000);\n\n    // Verify that the bid can be retrieved\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some(), \"Bid should be retrievable\");\n    let bid = bid.unwrap();\n    assert_eq!(bid.bid_amount, 900);\n    assert_eq!(bid.expected_return, 1000);\n}\n\n#[test]\nfn test_unique_bid_id_generation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n\n    env.as_contract(\u0026contract_id, || {\n        let mut ids = Vec::new(\u0026env);\n\n        // Generate 100 unique bid IDs (reduced for faster testing)\n        for _ in 0..100 {\n            let id = crate::bid::BidStorage::generate_unique_bid_id(\u0026env);\n\n            // Check if this ID already exists in our vector\n            for i in 0..ids.len() {\n                let existing_id = ids.get(i).unwrap();\n                assert_ne!(id, existing_id, \"Duplicate bid ID generated\");\n            }\n\n            ids.push_back(id);\n        }\n    });\n    env.mock_all_auths();\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place first bid\n    let bid_id_1 = client.place_bid(\u0026investor, \u0026invoice_id, \u0026900, \u00261100);\n\n    // Verify first bid was stored correctly\n    let bid_1 = client.get_bid(\u0026bid_id_1);\n    assert!(bid_1.is_some(), \"First bid should be retrievable\");\n\n    // Attempt duplicate bid from same investor should fail\n    let duplicate = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026950, \u00261200);\n    assert!(\n        duplicate.is_err(),\n        \"Duplicate active bids should be rejected\"\n    );\n}\n\n#[test]\nfn test_bid_ranking_and_filters() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor_a = Address::generate(\u0026env);\n    let investor_b = Address::generate(\u0026env);\n    let investor_c = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86_400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00262_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Ranking invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_a, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_b, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_c, 10_000);\n\n    let bid_a = client.place_bid(\u0026investor_a, \u0026invoice_id, \u0026700, \u0026880);\n    let bid_b = client.place_bid(\u0026investor_b, \u0026invoice_id, \u0026800, \u00261_050);\n    let _bid_c = client.place_bid(\u0026investor_c, \u0026invoice_id, \u0026900, \u00261_200);\n\n    let ranked = client.get_ranked_bids(\u0026invoice_id);\n    assert_eq!(ranked.len(), 3);\n\n    let best = client.get_best_bid(\u0026invoice_id).unwrap();\n    assert_eq!(best.bid_id, ranked.get(0).unwrap().bid_id);\n    assert_eq!(best.investor, investor_c);\n\n    env.as_contract(\u0026contract_id, || {\n        let mut bid = BidStorage::get_bid(\u0026env, \u0026bid_a).unwrap();\n        bid.status = BidStatus::Accepted;\n        BidStorage::update_bid(\u0026env, \u0026bid);\n    });\n\n    let placed = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed.len(), 2);\n    let accepted = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Accepted);\n    assert_eq!(accepted.len(), 1);\n\n    let investor_filter = client.get_bids_by_investor(\u0026invoice_id, \u0026investor_b);\n    assert_eq!(investor_filter.len(), 1);\n    assert_eq!(investor_filter.get(0).unwrap().bid_id, bid_b);\n}\n\n#[test]\nfn test_bid_expiration_cleanup() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86_400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Expiration invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026650);\n\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Placed);\n\n    let ranked = client.get_ranked_bids(\u0026invoice_id);\n    assert_eq!(ranked.len(), 1);\n\n    env.ledger().set_timestamp(bid.expiration_timestamp + 1);\n\n    let expired_count = client.cleanup_expired_bids(\u0026invoice_id);\n    assert_eq!(expired_count, 1);\n\n    let bid_after = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid_after.status, BidStatus::Expired);\n\n    assert!(client.get_ranked_bids(\u0026invoice_id).is_empty());\n    assert!(client.get_best_bid(\u0026invoice_id).is_none());\n}\n\n#[test]\nfn test_bid_validation_rules() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let other_investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Validation invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026other_investor, 10_000);\n\n    // Amount below minimum\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u002650, \u002660)\n        .is_err());\n\n    // Expected return must exceed bid amount\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u0026150, \u0026150)\n        .is_err());\n\n    // Amount cannot exceed invoice amount\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u00261500, \u00261600)\n        .is_err());\n\n    // Valid bid succeeds\n    let _bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026150, \u0026200);\n\n    // Duplicate bid from same investor is rejected\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u0026180, \u0026240)\n        .is_err());\n\n    // Another investor can still bid\n    let second_bid = client.try_place_bid(\u0026other_investor, \u0026invoice_id, \u0026180, \u0026240);\n    assert!(second_bid.is_ok());\n}\n\n#[test]\nfn test_withdraw_bid() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Withdraw test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place a bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Placed);\n\n    // Withdraw the bid\n    client.withdraw_bid(\u0026bid_id);\n    let withdrawn_bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(withdrawn_bid.status, BidStatus::Withdrawn);\n\n    // Verify bid is no longer in placed status\n    let placed_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed_bids.len(), 0);\n\n    // Verify bid appears in withdrawn status\n    let withdrawn_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Withdrawn);\n    assert_eq!(withdrawn_bids.len(), 1);\n    assert_eq!(withdrawn_bids.get(0).unwrap().bid_id, bid_id);\n\n    // Try to withdraw again (should fail)\n    assert!(client.try_withdraw_bid(\u0026bid_id).is_err());\n}\n\n#[test]\nfn test_get_bids_for_invoice() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor_a = Address::generate(\u0026env);\n    let investor_b = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Get bids test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_a, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_b, 10_000);\n\n    // Place multiple bids\n    let bid_a = client.place_bid(\u0026investor_a, \u0026invoice_id, \u0026500, \u0026600);\n    let bid_b = client.place_bid(\u0026investor_b, \u0026invoice_id, \u0026600, \u0026750);\n\n    // Get all bids for invoice\n    let all_bids = client.get_bids_for_invoice(\u0026invoice_id);\n    assert_eq!(all_bids.len(), 2);\n\n    // Verify both bids are present\n    let mut found_a = false;\n    let mut found_b = false;\n    for bid in all_bids.iter() {\n        if bid.bid_id == bid_a {\n            found_a = true;\n            assert_eq!(bid.investor, investor_a);\n        }\n        if bid.bid_id == bid_b {\n            found_b = true;\n            assert_eq!(bid.investor, investor_b);\n        }\n    }\n    assert!(found_a \u0026\u0026 found_b, \"Both bids should be found\");\n\n    // Withdraw one bid\n    client.withdraw_bid(\u0026bid_a);\n\n    // Get all bids again (should still include withdrawn bid)\n    let all_bids_after = client.get_bids_for_invoice(\u0026invoice_id);\n    assert_eq!(all_bids_after.len(), 2);\n\n    // Verify withdrawn bid is still in the list\n    let withdrawn = all_bids_after.iter().find(|b| b.bid_id == bid_a).unwrap();\n    assert_eq!(withdrawn.status, BidStatus::Withdrawn);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn _test_escrow_creation_on_bid_acceptance() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n\n    // Accept bid (should create escrow)\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify escrow was created\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow_details.invoice_id, invoice_id);\n    assert_eq!(escrow_details.investor, investor);\n    assert_eq!(escrow_details.business, business);\n    assert_eq!(escrow_details.amount, bid_amount);\n    assert_eq!(escrow_details.currency, currency);\n    assert_eq!(escrow_details.status, crate::payments::EscrowStatus::Held);\n\n    // Verify escrow status\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Held);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn _test_escrow_release_on_verification() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place and accept bid (creates escrow)\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify escrow is held\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Held);\n\n    // Release escrow funds\n    client.release_escrow_funds(\u0026invoice_id);\n\n    // Verify escrow is released\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Released);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn test_escrow_refund() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n\n    // Create invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Place and accept bid (creates escrow)\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify escrow is held\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Held);\n\n    // Refund escrow funds\n    client.refund_escrow_funds(\u0026invoice_id);\n\n    // Verify escrow is refunded\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Refunded);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn test_escrow_status_tracking() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Place and accept bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Test escrow details\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow_details.status, crate::payments::EscrowStatus::Held);\n    // created_at is set to ledger timestamp (u64 is always \u003e= 0)\n    assert_eq!(escrow_details.amount, bid_amount);\n\n    // Test status progression: Held -\u003e Released\n    client.release_escrow_funds(\u0026invoice_id);\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(\n        escrow_details.status,\n        crate::payments::EscrowStatus::Released\n    );\n}\n\n#[test]\nfn test_escrow_error_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let fake_invoice_id = BytesN::from_array(\u0026env, \u0026[1u8; 32]);\n\n    // Test getting escrow for non-existent invoice\n    let result = client.try_get_escrow_status(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    let result = client.try_get_escrow_details(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    // Test releasing escrow for non-existent invoice\n    let result = client.try_release_escrow_funds(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    // Test refunding escrow for non-existent invoice\n    let result = client.try_refund_escrow_funds(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn test_escrow_double_operation_prevention() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Place and accept bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Release escrow funds\n    client.release_escrow_funds(\u0026invoice_id);\n\n    // Try to release again (should fail)\n    let result = client.try_release_escrow_funds(\u0026invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    // Try to refund after release (should fail)\n    let result = client.try_refund_escrow_funds(\u0026invoice_id);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_unique_investment_id_generation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n\n    env.as_contract(\u0026contract_id, || {\n        let mut ids = Vec::new(\u0026env);\n\n        // Generate 100 unique investment IDs (reduced for faster testing)\n        for _ in 0..100 {\n            let id = crate::investment::InvestmentStorage::generate_unique_investment_id(\u0026env);\n\n            // Check if this ID already exists in our vector\n            for i in 0..ids.len() {\n                let existing_id = ids.get(i).unwrap();\n                assert_ne!(id, existing_id, \"Duplicate investment ID generated\");\n            }\n\n            ids.push_back(id);\n        }\n    });\n}\n\n// Rating System Tests (from feat-invoice_rating_system branch)\n\n#[test]\nfn test_add_invoice_rating() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund an invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify the invoice\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Fund the invoice properly\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add rating with proper authentication\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"Great service!\"),\n                investor,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Verify rating was added\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.average_rating, Some(5));\n    assert_eq!(invoice.total_ratings, 1);\n    assert!(invoice.has_ratings());\n    assert_eq!(invoice.get_highest_rating(), Some(5));\n    assert_eq!(invoice.get_lowest_rating(), Some(5));\n}\n\n#[test]\nfn test_add_invoice_rating_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Fund the invoice\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    let investor = Address::generate(\u0026env);\n\n    // Test invalid rating (0)\n    let result = client.try_add_invoice_rating(\n        \u0026invoice_id,\n        \u00260,\n        \u0026String::from_str(\u0026env, \"Invalid\"),\n        \u0026investor,\n    );\n    assert!(matches!(result, Err(_)));\n\n    // Test invalid rating (6)\n    let result = client.try_add_invoice_rating(\n        \u0026invoice_id,\n        \u00266,\n        \u0026String::from_str(\u0026env, \"Invalid\"),\n        \u0026investor,\n    );\n    assert!(matches!(result, Err(_)));\n\n    // Test rating on pending invoice (should fail)\n    let pending_invoice_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Pending invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    let result = client.try_add_invoice_rating(\n        \u0026pending_invoice_id,\n        \u00265,\n        \u0026String::from_str(\u0026env, \"Should fail\"),\n        \u0026investor,\n    );\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_multiple_ratings() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add a single rating (since only one investor can rate per invoice)\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"Excellent!\"),\n                investor,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Verify rating was added correctly\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.average_rating, Some(5));\n    assert_eq!(invoice.total_ratings, 1);\n    assert_eq!(invoice.get_highest_rating(), Some(5));\n    assert_eq!(invoice.get_lowest_rating(), Some(5));\n}\n\n#[test]\nfn test_duplicate_rating_prevention() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add first rating\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"First rating\"),\n                investor.clone(),\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Try to add duplicate rating (should fail)\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        let result = invoice.add_rating(\n            4,\n            String::from_str(\u0026env, \"Duplicate\"),\n            investor,\n            env.ledger().timestamp(),\n        );\n        // Check if the rating was actually added (it shouldn't be)\n        if result.is_ok() {\n            // If it succeeded, verify the rating count didn't increase\n            let updated_invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n            assert_eq!(\n                updated_invoice.total_ratings, 1,\n                \"Duplicate rating should not be added\"\n            );\n        }\n    });\n\n    // Verify only one rating exists\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.total_ratings, 1);\n    assert_eq!(invoice.average_rating, Some(5));\n}\n\n#[test]\nfn test_rating_queries() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business1 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund a single invoice first\n    let invoice1_id = client.store_invoice(\n        \u0026business1,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Add rating with proper authentication\n    env.as_contract(\u0026contract_id, || {\n        let investor1 = Address::generate(\u0026env);\n\n        // Update invoice to have investor and add to funded status list\n        let mut invoice1 = InvoiceStorage::get_invoice(\u0026env, \u0026invoice1_id).unwrap();\n        invoice1.mark_as_funded(\u0026env, investor1.clone(), 1000, env.ledger().timestamp());\n        invoice1\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"Excellent\"),\n                investor1,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice1);\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026InvoiceStatus::Pending, \u0026invoice1_id);\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026InvoiceStatus::Funded, \u0026invoice1_id);\n    });\n\n    // Verify that invoice is properly moved to Funded status\n    env.as_contract(\u0026contract_id, || {\n        let pending_invoices =\n            InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Pending);\n        assert_eq!(\n            pending_invoices.len(),\n            0,\n            \"No invoices should be in Pending status\"\n        );\n\n        let funded_invoices = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Funded);\n        assert_eq!(\n            funded_invoices.len(),\n            1,\n            \"Invoice should be in Funded status\"\n        );\n    });\n\n    // Test rating query\n    let high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    assert_eq!(high_rated_invoices.len(), 1); // invoice1 (5)\n    assert!(high_rated_invoices.contains(\u0026invoice1_id));\n\n    let rated_count = client.get_invoices_with_ratings_count();\n    assert_eq!(rated_count, 1);\n}\n\n#[test]\nfn test_rating_statistics() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add a single rating (since only one investor can rate per invoice)\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                3,\n                String::from_str(\u0026env, \"Average\"),\n                investor,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Get rating statistics\n    let (avg_rating, total_ratings, highest, lowest) = client.get_invoice_rating_stats(\u0026invoice_id);\n\n    assert_eq!(avg_rating, Some(3)); // Single rating of 3\n    assert_eq!(total_ratings, 1);\n    assert_eq!(highest, Some(3));\n    assert_eq!(lowest, Some(3));\n}\n\n#[test]\nfn test_rating_on_unfunded_invoice() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoice but don't fund it\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Unfunded invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Try to rate unfunded invoice (should fail)\n    // Note: This test is simplified since the client wrapper doesn't expose Result types\n    // In a real scenario, this would be tested at the contract level\n\n    // Verify no rating was added\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.total_ratings, 0);\n    assert!(!invoice.has_ratings());\n    assert!(invoice.average_rating.is_none());\n}\n\n// Business KYC/Verification Tests (from main branch)\n\n#[test]\nfn test_submit_kyc_application() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Mock business authorization\n    env.mock_all_auths();\n\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Verify KYC was submitted\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert_eq!(verification.business, business);\n    assert_eq!(verification.kyc_data, kyc_data);\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Pending\n    ));\n}\n\n#[test]\nfn test_verify_business() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC application\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Verify business\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Check verification status\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Verified\n    ));\n    assert!(verification.verified_at.is_some());\n    assert_eq!(verification.verified_by, Some(admin));\n}\n\n#[test]\nfn test_verify_invoice_requires_admin() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Admin gating\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    assert!(client.try_verify_invoice(\u0026invoice_id).is_err());\n\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    client.verify_invoice(\u0026invoice_id);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n}\n\n#[test]\nfn test_reject_business() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    let rejection_reason = String::from_str(\u0026env, \"Incomplete documentation\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC application\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Reject business\n    env.mock_all_auths();\n    client.reject_business(\u0026admin, \u0026business, \u0026rejection_reason);\n\n    // Check verification status\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Rejected\n    ));\n    assert_eq!(verification.rejection_reason, Some(rejection_reason));\n}\n\n#[test]\nfn test_upload_invoice_requires_verification() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Mock business authorization\n    env.mock_all_auths();\n\n    // Try to upload invoice without verification - should fail\n    let result = client.try_upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    assert!(result.is_err());\n\n    // Submit KYC and verify business\n    let admin = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Now try to upload invoice - should succeed\n    env.mock_all_auths();\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n}\n\n#[test]\nfn test_kyc_already_pending() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Mock business authorization\n    env.mock_all_auths();\n\n    // Submit KYC application\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Try to submit again - should fail\n    let result = client.try_submit_kyc_application(\u0026business, \u0026kyc_data);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_kyc_already_verified() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Set admin and submit KYC\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Verify business\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Try to submit KYC again - should fail\n    let result = client.try_submit_kyc_application(\u0026business, \u0026kyc_data);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_kyc_resubmission_after_rejection() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    let rejection_reason = String::from_str(\u0026env, \"Incomplete documentation\");\n\n    // Set admin and submit KYC\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Reject business\n    env.mock_all_auths();\n    client.reject_business(\u0026admin, \u0026business, \u0026rejection_reason);\n\n    // Try to resubmit KYC - should succeed\n    let new_kyc_data = String::from_str(\u0026env, \"Updated business registration documents\");\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026new_kyc_data);\n\n    // Check status is back to pending\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Pending\n    ));\n    assert_eq!(verification.kyc_data, new_kyc_data);\n}\n\n#[test]\nfn test_verification_unauthorized_access() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let unauthorized_admin = Address::generate(\u0026env);\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC application\n    env.mock_all_auths();\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Try to verify with unauthorized admin - should fail\n    env.mock_all_auths();\n    let result = client.try_verify_business(\u0026unauthorized_admin, \u0026business);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_get_verification_lists() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let business3 = Address::generate(\u0026env);\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC applications\n    env.mock_all_auths();\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    client.submit_kyc_application(\u0026business1, \u0026kyc_data);\n    client.submit_kyc_application(\u0026business2, \u0026kyc_data);\n    client.submit_kyc_application(\u0026business3, \u0026kyc_data);\n\n    // Verify business1, reject business2, leave business3 pending\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business1);\n    client.reject_business(\u0026admin, \u0026business2, \u0026String::from_str(\u0026env, \"Rejected\"));\n\n    // Check lists\n    let verified = client.get_verified_businesses();\n    let pending = client.get_pending_businesses();\n    let rejected = client.get_rejected_businesses();\n\n    assert_eq!(verified.len(), 1);\n    assert_eq!(pending.len(), 1);\n    assert_eq!(rejected.len(), 1);\n\n    assert!(verified.contains(\u0026business1));\n    assert!(pending.contains(\u0026business3));\n    assert!(rejected.contains(\u0026business2));\n}\n\n#[test]\nfn test_create_and_restore_backup() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create test invoices\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice1_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice2_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Create backup\n    env.mock_all_auths();\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Initial backup\"));\n\n    // Verify backup was created\n    let backup = client.get_backup_details(\u0026backup_id);\n    assert!(backup.is_some());\n    let backup = backup.unwrap();\n    assert_eq!(backup.invoice_count, 2);\n    assert_eq!(backup.status, BackupStatus::Active);\n\n    // Clear invoices - use the contract's clear method\n    env.mock_all_auths();\n    env.as_contract(\u0026contract_id, || {\n        QuickLendXContract::clear_all_invoices(\u0026env).unwrap();\n    });\n\n    // Verify invoices are gone\n    assert!(client.try_get_invoice(\u0026invoice1_id).is_err());\n    assert!(client.try_get_invoice(\u0026invoice2_id).is_err());\n\n    // Restore backup\n    env.mock_all_auths();\n    client.restore_backup(\u0026backup_id);\n\n    // Verify invoices are back\n    let invoice1 = client.get_invoice(\u0026invoice1_id);\n    assert_eq!(invoice1.amount, 1000);\n    let invoice2 = client.get_invoice(\u0026invoice2_id);\n    assert_eq!(invoice2.amount, 2000);\n}\n\n#[test]\nfn test_backup_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create test invoice\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Create backup\n    env.mock_all_auths();\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Test backup\"));\n\n    // Validate backup\n    let is_valid = client.validate_backup(\u0026backup_id);\n    assert!(is_valid);\n\n    // Tamper with backup data (simulate corruption)\n    env.as_contract(\u0026contract_id, || {\n        let mut backup = BackupStorage::get_backup(\u0026env, \u0026backup_id).unwrap();\n        backup.invoice_count = 999; // Incorrect count\n        BackupStorage::update_backup(\u0026env, \u0026backup);\n    });\n\n    // Validate should fail now\n    let is_valid = client.validate_backup(\u0026backup_id);\n    assert!(!is_valid);\n}\n\n#[test]\nfn test_backup_cleanup() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create multiple backups with simple descriptions\n    env.mock_all_auths();\n    for i in 0..10 {\n        let description = if i == 0 {\n            String::from_str(\u0026env, \"Backup 0\")\n        } else if i == 1 {\n            String::from_str(\u0026env, \"Backup 1\")\n        } else {\n            // Continue this pattern or just use a generic description\n            String::from_str(\u0026env, \"Backup\")\n        };\n        client.create_backup(\u0026description);\n    }\n\n    // Verify only last 5 backups are kept\n    let backups = client.get_backups();\n    assert_eq!(backups.len(), 5);\n}\n\n#[test]\nfn test_archive_backup() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create backup\n    env.mock_all_auths();\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Test backup\"));\n\n    // Archive backup\n    client.archive_backup(\u0026backup_id);\n\n    // Verify backup is archived\n    let backup = client.get_backup_details(\u0026backup_id);\n    assert!(backup.is_some());\n    assert_eq!(backup.unwrap().status, BackupStatus::Archived);\n\n    // Verify backup is removed from active list\n    let backups = client.get_backups();\n    assert!(!backups.contains(\u0026backup_id));\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_trail_creation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Check audit trail was created\n    let audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    assert!(!audit_trail.is_empty());\n\n    // Verify audit entry details\n    let audit_entry = client.get_audit_entry(\u0026audit_trail.get(0).unwrap());\n    assert_eq!(audit_entry.invoice_id, invoice_id);\n    assert_eq!(audit_entry.operation, AuditOperation::InvoiceCreated);\n    assert_eq!(audit_entry.actor, business);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_integrity_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Validate audit integrity\n    let is_valid = client.validate_invoice_audit_integrity(\u0026invoice_id);\n    assert!(is_valid);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_query_functionality() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create multiple invoices\n    let invoice_id1 = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    let amount2 = amount * 2;\n    let _invoice_id2 = client.upload_invoice(\n        \u0026business,\n        \u0026amount2,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Query by operation type\n    let filter = AuditQueryFilter {\n        invoice_id: None,\n        operation: AuditOperationFilter::Specific(AuditOperation::InvoiceCreated),\n        actor: None,\n        start_timestamp: None,\n        end_timestamp: None,\n    };\n\n    let results = client.query_audit_logs(\u0026filter, \u002610);\n    assert_eq!(results.len(), 2);\n\n    // Query by specific invoice\n    let filter = AuditQueryFilter {\n        invoice_id: Some(invoice_id1.clone()),\n        operation: AuditOperationFilter::Any,\n        actor: None,\n        start_timestamp: None,\n        end_timestamp: None,\n    };\n\n    let results = client.query_audit_logs(\u0026filter, \u002610);\n    assert!(!results.is_empty());\n    assert_eq!(results.get(0).unwrap().invoice_id, invoice_id1);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_statistics() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create and process invoices\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Get audit statistics\n    let stats = client.get_audit_stats();\n    assert!(stats.total_entries \u003e 0);\n    assert!(stats.unique_actors \u003e 0);\n}\n\n// --- Start of merged content ---\n\n// Notification System Tests (from feat-notif)\n\n#[test]\nfn test_notification_preferences_default() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let user = Address::generate(\u0026env);\n\n    // Get default preferences\n    let preferences = client.get_notification_preferences(\u0026user);\n\n    // Verify default preferences are set correctly\n    assert_eq!(preferences.user, user);\n    assert!(preferences.invoice_created);\n    assert!(preferences.invoice_verified);\n    assert!(preferences.bid_received);\n    assert!(preferences.payment_received);\n}\n\n#[test]\nfn test_update_notification_preferences() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let user = Address::generate(\u0026env);\n    env.mock_all_auths();\n\n    // Get default preferences\n    let mut preferences = client.get_notification_preferences(\u0026user);\n\n    // Update preferences\n    preferences.invoice_created = false;\n    preferences.bid_received = false;\n\n    // Update preferences in contract\n    client.update_notification_preferences(\u0026user, \u0026preferences);\n\n    // Verify preferences were updated\n    let updated_preferences = client.get_notification_preferences(\u0026user);\n    assert_eq!(updated_preferences.invoice_created, false);\n    assert_eq!(updated_preferences.bid_received, false);\n    assert_eq!(updated_preferences.payment_received, true); // Should remain true\n}\n\n#[test]\nfn test_notification_creation_on_invoice_upload() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice (should trigger notification)\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Check that business has notifications\n    let notifications = client.get_user_notifications(\u0026business);\n    assert!(!notifications.is_empty());\n}\n\n#[test]\nfn test_notification_creation_on_bid_placement() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place bid (should trigger notification to business)\n    let _bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261000, \u00261100);\n\n    // Check that business received bid notification\n    let business_notifications = client.get_user_notifications(\u0026business);\n    assert!(!business_notifications.is_empty());\n\n    // Verify notification content\n    let notification_id = business_notifications\n        .get(business_notifications.len() - 1)\n        .unwrap();\n    let notification = client.get_notification(\u0026notification_id);\n    assert!(notification.is_some());\n}\n\n#[test]\nfn test_notification_creation_on_invoice_status_change() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get initial notification count\n    let initial_notifications = client.get_user_notifications(\u0026business);\n    let initial_count = initial_notifications.len();\n\n    // Update invoice status (should trigger notification)\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Check that business received verification notification\n    let updated_notifications = client.get_user_notifications(\u0026business);\n    assert!(updated_notifications.len() \u003e initial_count);\n}\n\n#[test]\nfn test_notification_delivery_status_update() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice to trigger notification\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get the notification\n    let notifications = client.get_user_notifications(\u0026business);\n    assert!(!notifications.is_empty());\n    let notification_id = notifications.get(0).unwrap();\n\n    // Update notification status\n    client.update_notification_status(\u0026notification_id, \u0026NotificationDeliveryStatus::Sent);\n\n    // Verify status was updated\n    let notification = client.get_notification(\u0026notification_id);\n    assert!(notification.is_some());\n    let notification = notification.unwrap();\n    assert_eq!(\n        notification.delivery_status,\n        NotificationDeliveryStatus::Sent\n    );\n}\n\n#[test]\nfn test_user_notification_stats() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice to trigger notification\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get notification stats\n    let stats = client.get_user_notification_stats(\u0026business);\n\n    // Verify stats - check that notifications were created\n    assert!(stats.total_sent \u003e= 0);\n    assert!(stats.total_delivered \u003e= 0);\n    assert!(stats.total_read \u003e= 0);\n    assert!(stats.total_failed \u003e= 0);\n}\n\n#[test]\nfn test_platform_fee_configuration() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    let default_config = client.get_platform_fee();\n    assert_eq!(default_config.fee_bps, 200);\n\n    client.set_platform_fee(\u0026300);\n    let updated_config = client.get_platform_fee();\n    assert_eq!(updated_config.fee_bps, 300);\n    assert_eq!(updated_config.updated_by, admin);\n\n    let (investor_return, platform_fee) = client.calculate_profit(\u00261_000, \u00261_200);\n    assert_eq!(investor_return, 1_194);\n    assert_eq!(platform_fee, 6);\n\n    let invalid = client.try_set_platform_fee(\u00261_200);\n    let err = invalid.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::InvalidAmount);\n}\n\n#[test]\nfn test_overdue_invoice_notifications() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n\n    // Register a Stellar Asset Contract to represent the currency used in tests\n    let token_admin = Address::generate(\u0026env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create invoice with future due date first\n    let future_due_date = env.ledger().timestamp() + 86400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026future_due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify and fund the invoice\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261000, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Check for overdue invoices (this will check current time vs due dates)\n    let overdue_count = client.check_overdue_invoices();\n\n    // Verify notifications were sent to both parties\n    let business_notifications = client.get_user_notifications(\u0026business);\n    let investor_notifications = client.get_user_notifications(\u0026investor);\n\n    // Both business and investor should have notifications from previous actions\n    assert!(!business_notifications.is_empty());\n    assert!(!investor_notifications.is_empty());\n\n    // The overdue check function should complete successfully\n    assert!(overdue_count \u003e= 0);\n}\n\n#[test]\nfn test_invoice_expiration_triggers_default() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 5_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let due_date = env.ledger().timestamp() + 60;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Expiring invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261_000, \u00261_100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n\n    env.ledger().set_timestamp(invoice.due_date + 1);\n\n    let defaulted = client.check_invoice_expiration(\u0026invoice_id, \u0026Some(0));\n    assert!(defaulted);\n\n    let updated_invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(updated_invoice.status, InvoiceStatus::Defaulted);\n}\n\n#[test]\nfn test_partial_payments_trigger_settlement() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 5_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let due_date = env.ledger().timestamp() + 86_400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Partial payment invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261_000, \u00261_100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    let tx1 = String::from_str(\u0026env, \"tx-1\");\n    client.process_partial_payment(\u0026invoice_id, \u0026400, \u0026tx1);\n\n    let mid_invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(mid_invoice.total_paid, 400);\n    assert_eq!(mid_invoice.payment_history.len(), 1);\n    assert_eq!(mid_invoice.status, InvoiceStatus::Funded);\n    assert_eq!(mid_invoice.payment_progress(), 40);\n\n    let tx2 = String::from_str(\u0026env, \"tx-2\");\n    client.process_partial_payment(\u0026invoice_id, \u0026600, \u0026tx2);\n\n    let settled_invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(settled_invoice.status, InvoiceStatus::Paid);\n    assert_eq!(settled_invoice.total_paid, 1_000);\n    assert_eq!(settled_invoice.payment_history.len(), 2);\n    assert_eq!(settled_invoice.payment_progress(), 100);\n\n    let investment = env\n        .as_contract(\u0026contract_id, || {\n            InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id)\n        })\n        .expect(\"investment\");\n    assert_eq!(investment.status, InvestmentStatus::Completed);\n}\n\n// Dispute Resolution System Tests (from main)\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_create_dispute() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Create dispute as business\n    let reason = String::from_str(\u0026env, \"Payment not received\");\n    let evidence = String::from_str(\u0026env, \"Bank statement showing no payment\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Verify dispute was created\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::Disputed);\n\n    let dispute_details = client.get_dispute_details(\u0026invoice_id);\n    assert!(dispute_details.is_some());\n\n    let dispute = dispute_details.unwrap();\n    assert_eq!(dispute.created_by, business);\n    assert_eq!(dispute.reason, reason);\n    assert_eq!(dispute.evidence, evidence);\n    assert_eq!(dispute.resolution, String::from_str(\u0026env, \"\"));\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_create_dispute_as_investor() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create, verify, and fund invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Place and accept bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026amount, \u0026(amount + 100));\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Create dispute as investor\n    let reason = String::from_str(\u0026env, \"Invoice details are incorrect\");\n    let evidence = String::from_str(\u0026env, \"Original contract shows different terms\");\n\n    client.create_dispute(\u0026invoice_id, \u0026investor, \u0026reason, \u0026evidence);\n\n    // Verify dispute was created\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::Disputed);\n\n    let dispute_details = client.get_dispute_details(\u0026invoice_id);\n    assert!(dispute_details.is_some());\n\n    let dispute = dispute_details.unwrap();\n    assert_eq!(dispute.created_by, investor);\n    assert_eq!(dispute.reason, reason);\n    assert_eq!(dispute.evidence, evidence);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_unauthorized_dispute_creation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let unauthorized = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Try to create dispute as unauthorized party\n    let reason = String::from_str(\u0026env, \"Invalid dispute\");\n    let evidence = String::from_str(\u0026env, \"Invalid evidence\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026unauthorized, \u0026reason, \u0026evidence);\n\n    assert!(result.is_err());\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_duplicate_dispute_prevention() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Create first dispute\n    let reason1 = String::from_str(\u0026env, \"First dispute\");\n    let evidence1 = String::from_str(\u0026env, \"First evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason1, \u0026evidence1);\n\n    // Try to create second dispute\n    let reason2 = String::from_str(\u0026env, \"Second dispute\");\n    let evidence2 = String::from_str(\u0026env, \"Second evidence\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026business, \u0026reason2, \u0026evidence2);\n\n    assert!(result.is_err());\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_dispute_under_review() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create, verify invoice and create dispute\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Put dispute under review\n    client.put_dispute_under_review(\u0026invoice_id, \u0026admin);\n\n    // Verify dispute status\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::UnderReview);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_resolve_dispute() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create, verify invoice and create dispute\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Put dispute under review\n    client.put_dispute_under_review(\u0026invoice_id, \u0026admin);\n\n    // Resolve dispute\n    let resolution = String::from_str(\n        \u0026env,\n        \"Payment confirmed, dispute resolved in favor of business\",\n    );\n    client.resolve_dispute(\u0026invoice_id, \u0026admin, \u0026resolution);\n\n    // Verify dispute is resolved\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::Resolved);\n\n    let dispute_details = client.get_dispute_details(\u0026invoice_id);\n    assert!(dispute_details.is_some());\n\n    let dispute = dispute_details.unwrap();\n    assert_eq!(dispute.resolution, resolution);\n    assert_eq!(dispute.resolved_by, admin);\n    assert!(dispute.resolved_at \u003e 0);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_get_invoices_with_disputes() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create invoices\n    let invoice_id1 = client.upload_invoice(\n        \u0026business1,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice_id2 = client.upload_invoice(\n        \u0026business2,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id1);\n    client.verify_invoice(\u0026invoice_id2);\n\n    // Create disputes\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id1, \u0026business1, \u0026reason, \u0026evidence);\n\n    client.create_dispute(\u0026invoice_id2, \u0026business2, \u0026reason, \u0026evidence);\n\n    // Get all invoices with disputes\n    let disputed_invoices = client.get_invoices_with_disputes();\n    assert_eq!(disputed_invoices.len(), 2);\n    assert!(disputed_invoices.contains(\u0026invoice_id1));\n    assert!(disputed_invoices.contains(\u0026invoice_id2));\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_get_invoices_by_dispute_status() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create, verify invoice and create dispute\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Get invoices with disputed status\n    let disputed_invoices = client.get_invoices_by_dispute_status(\u0026DisputeStatus::Disputed);\n    assert_eq!(disputed_invoices.len(), 1);\n    assert_eq!(disputed_invoices.get(0).unwrap(), invoice_id);\n\n    // Put under review\n    client.put_dispute_under_review(\u0026invoice_id, \u0026admin);\n\n    // Get invoices with under review status\n    let under_review_invoices = client.get_invoices_by_dispute_status(\u0026DisputeStatus::UnderReview);\n    assert_eq!(under_review_invoices.len(), 1);\n    assert_eq!(under_review_invoices.get(0).unwrap(), invoice_id);\n\n    // Resolve dispute\n    let resolution = String::from_str(\u0026env, \"Dispute resolved\");\n    client.resolve_dispute(\u0026invoice_id, \u0026admin, \u0026resolution);\n\n    // Get invoices with resolved status\n    let resolved_invoices = client.get_invoices_by_dispute_status(\u0026DisputeStatus::Resolved);\n    assert_eq!(resolved_invoices.len(), 1);\n    assert_eq!(resolved_invoices.get(0).unwrap(), invoice_id);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_dispute_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Test empty reason\n    let empty_reason = String::from_str(\u0026env, \"\");\n    let evidence = String::from_str(\u0026env, \"Valid evidence\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026business, \u0026empty_reason, \u0026evidence);\n    assert!(result.is_err());\n\n    // Test empty evidence\n    let reason = String::from_str(\u0026env, \"Valid reason\");\n    let empty_evidence = String::from_str(\u0026env, \"\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026empty_evidence);\n    assert!(result.is_err());\n}\n\n#[test]\nfn test_investment_insurance_lifecycle() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let provider = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n\n    let token_admin = Address::generate(\u0026env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    client.set_admin(\u0026admin);\n\n    let due_date = env.ledger().timestamp() + 86_400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000i128,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice with insurance\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261_000i128, \u00261_100i128);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    let investment = client.get_invoice_investment(\u0026invoice_id);\n    let investment_id = investment.investment_id.clone();\n\n    let invalid_attempt = client.try_add_investment_insurance(\u0026investment_id, \u0026provider, \u0026150u32);\n    let err = invalid_attempt.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::InvalidCoveragePercentage);\n\n    let coverage_percentage = 60u32;\n    client.add_investment_insurance(\u0026investment_id, \u0026provider, \u0026coverage_percentage);\n\n    let duplicate_provider = Address::generate(\u0026env);\n    let duplicate_attempt =\n        client.try_add_investment_insurance(\u0026investment_id, \u0026duplicate_provider, \u002630u32);\n    let err = duplicate_attempt.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::OperationNotAllowed);\n\n    let insured_investment = client.get_invoice_investment(\u0026invoice_id);\n    let investment_amount = insured_investment.amount;\n    assert_eq!(insured_investment.insurance.len(), 1);\n    let insurance = insured_investment\n        .insurance\n        .get(0)\n        .expect(\"expected insurance entry\");\n    assert!(insurance.active);\n    assert_eq!(insurance.provider, provider);\n    assert_eq!(insurance.coverage_percentage, coverage_percentage);\n    let expected_coverage = investment_amount * coverage_percentage as i128 / 100;\n    assert_eq!(insurance.coverage_amount, expected_coverage);\n    let expected_premium = Investment::calculate_premium(investment_amount, coverage_percentage);\n    assert_eq!(insurance.premium_amount, expected_premium);\n\n    let stored_invoice = client.get_invoice(\u0026invoice_id);\n    env.ledger().set_timestamp(stored_invoice.due_date + 1);\n    let result = client.try_handle_default(\u0026invoice_id);\n    assert!(result.is_ok());\n\n    let after_default = client.get_invoice_investment(\u0026invoice_id);\n    assert_eq!(after_default.status, InvestmentStatus::Defaulted);\n    assert_eq!(after_default.insurance.len(), 1);\n    let insurance_after = after_default\n        .insurance\n        .get(0)\n        .expect(\"expected insurance entry after claim\");\n    assert!(!insurance_after.active);\n    assert_eq!(insurance_after.coverage_amount, expected_coverage);\n}\n\n// Test basic functionality from README.md\n#[test]\nfn test_basic_readme_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    \n    // Register a Stellar Asset Contract to represent the currency used in tests\n    let token_admin = Address::generate(\u0026env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    \n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    \n    // Test 1: Set admin\n    client.set_admin(\u0026admin);\n    \n    // Test 2: Business KYC submission\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\"));\n    \n    // Test 3: Business verification\n    client.verify_business(\u0026admin, \u0026business);\n    \n    // Test 4: Create invoice\n    let invoice_id = client.try_store_invoice(\n        \u0026business,\n        \u002610000, // $100.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice for services\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env)\n    ).unwrap().unwrap();\n    \n    // Test 5: Verify invoice\n    client.verify_invoice(\u0026invoice_id);\n    \n    // Test 6: Investor KYC submission\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\"));\n    \n    // Test 7: Investor verification (set limit high enough for the bid)\n    client.verify_investor(\u0026investor, \u002620000);\n    \n    // Test 8: Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00269500, \u002610000);\n    \n    // Test 9: Accept bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Test 10: Release escrow funds\n    client.release_escrow_funds(\u0026invoice_id);\n    \n    // Test 11: Query functions\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.amount, 10000);\n    \n    let business_invoices = client.get_business_invoices(\u0026business);\n    assert_eq!(business_invoices.len(), 1);\n    \n    let _pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    let _verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    let _funded_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Funded);\n    \n    let _available_invoices = client.get_available_invoices();\n    \n    // Test 12: Verification queries\n    let _verified_businesses = client.get_verified_businesses();\n    let _pending_businesses = client.get_pending_businesses();\n    \n    let business_verification = client.get_business_verification_status(\u0026business);\n    assert!(business_verification.is_some());\n    \n    // Test 13: Investor verification queries\n    let _verified_investors = client.get_verified_investors();\n    let _pending_investors = client.get_pending_investors();\n    \n    let investor_verification = client.get_investor_verification(\u0026investor);\n    assert!(investor_verification.is_some());\n    \n    // Test 14: Analytics queries\n    let _platform_metrics = client.get_platform_metrics();\n    let _performance_metrics = client.get_performance_metrics();\n    \n    // Test 15: Audit queries\n    let _audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    let _audit_stats = client.get_audit_stats();\n    \n    // Test 16: Backup queries\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Test backup\"));\n    let _backup_details = client.get_backup_details(\u0026backup_id);\n    let _backups = client.get_backups();\n    \n    // Test 17: Category and tag queries\n    let _services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    let _test_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"test\"));\n    let _all_categories = client.get_all_categories();\n    \n    // Test 18: Rating queries\n    let _invoices_with_ratings = client.get_invoices_with_ratings_count();\n    let _high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    \n    // Test 19: Notification queries\n    let _user_notifications = client.get_user_notifications(\u0026business);\n    let _preferences = client.get_notification_preferences(\u0026business);\n    let _notification_stats = client.get_user_notification_stats(\u0026business);\n    \n    // Test 20: Advanced analytics queries\n    let _financial_metrics = client.get_financial_metrics(\u0026TimePeriod::Monthly);\n    let _user_behavior_metrics = client.get_user_behavior_metrics(\u0026business);\n    let _analytics_summary = client.get_analytics_summary();\n    \n    // Test 21: Investor analytics queries\n    let _basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    let _medium_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Medium);\n    let _investor_analytics = client.calculate_investor_analytics(\u0026investor);\n    let _investor_performance_metrics = client.calc_investor_perf_metrics();\n    \n    // All tests passed\n    assert!(true);\n}\n\n// ========================================\n// Invoice Lifecycle Tests\n// ========================================\n\n#[test]\nfn test_upload_invoice_success() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Payment for consulting services\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Consulting,\n        \u0026tags,\n    );\n\n    // Verify invoice was created with correct status\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n    assert_eq!(invoice.due_date, due_date);\n}\n\n#[test]\n#[should_panic(expected = \"BusinessNotVerified\")]\nfn test_upload_invoice_not_verified_business() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Try to upload invoice without being verified\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n}\n\n#[test]\n#[should_panic(expected = \"InvalidAmount\")]\nfn test_upload_invoice_invalid_amount() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Try to upload invoice with negative amount\n    let amount = -100i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n}\n\n#[test]\n#[should_panic(expected = \"InvoiceDueDateInvalid\")]\nfn test_upload_invoice_past_due_date() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Try to upload invoice with past due date\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() - 86400; // Past date\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n}\n\n#[test]\nfn test_verify_invoice_success() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify invoice status is Pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    // Verify the invoice\n    client.verify_invoice(\u0026invoice_id);\n\n    // Check status changed to Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n}\n\n#[test]\n#[should_panic(expected = \"NotAdmin\")]\nfn test_verify_invoice_not_admin() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let non_admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Try to verify as non-admin (should fail in real scenario)\n    // Note: mock_all_auths() bypasses auth, so we set admin first\n    client.set_admin(\u0026non_admin);\n    client.verify_invoice(\u0026invoice_id);\n}\n\n#[test]\n#[should_panic(expected = \"InvalidStatus\")]\nfn test_verify_invoice_already_verified() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify once\n    client.verify_invoice(\u0026invoice_id);\n\n    // Try to verify again (should fail)\n    client.verify_invoice(\u0026invoice_id);\n}\n\n#[test]\nfn test_cancel_invoice_pending() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify invoice is Pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    // Cancel the invoice\n    client.cancel_invoice(\u0026invoice_id);\n\n    // Verify status changed to Cancelled\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Cancelled);\n}\n\n#[test]\nfn test_cancel_invoice_verified() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify the invoice\n    client.verify_invoice(\u0026invoice_id);\n\n    // Verify invoice is Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    // Cancel the invoice\n    client.cancel_invoice(\u0026invoice_id);\n\n    // Verify status changed to Cancelled\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Cancelled);\n}\n\n#[test]\n#[should_panic(expected = \"InvalidStatus\")]\nfn test_cancel_invoice_funded() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business and investor\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10000000);\n\n    // Upload and verify invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n\n    // Investor places bid\n    let bid_amount = amount;\n    let expected_return = amount + 100000;\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u0026expected_return);\n\n    // Business accepts bid (invoice becomes Funded)\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify invoice is Funded\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n\n    // Try to cancel funded invoice (should fail)\n    client.cancel_invoice(\u0026invoice_id);\n}\n\n#[test]\nfn test_complete_invoice_lifecycle_with_cancellation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Setup: Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Step 1: Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Consulting services invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Consulting,\n        \u0026tags,\n    );\n\n    // Verify invoice is Pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n\n    // Step 2: Verify invoice\n    client.verify_invoice(\u0026invoice_id);\n\n    // Verify status changed to Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    // Step 3: Cancel invoice (business changes mind)\n    client.cancel_invoice(\u0026invoice_id);\n\n    // Verify status changed to Cancelled\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Cancelled);\n\n    // Verify cancelled invoices are tracked\n    let cancelled_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Cancelled);\n    assert_eq!(cancelled_invoices.len(), 1);\n    assert_eq!(cancelled_invoices.get(0).unwrap(), invoice_id);\n}\n\n#[test]\nfn test_invoice_lifecycle_counts() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create multiple invoices in different states\n    let due_date = env.ledger().timestamp() + 86400;\n    let tags = Vec::new(\u0026env);\n\n    // Invoice 1: Pending\n    let _invoice_id_1 = client.upload_invoice(\n        \u0026business,\n        \u00261000000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Invoice 2: Verified\n    let invoice_id_2 = client.upload_invoice(\n        \u0026business,\n        \u00262000000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Products,\n        \u0026tags,\n    );\n    client.verify_invoice(\u0026invoice_id_2);\n\n    // Invoice 3: Cancelled\n    let invoice_id_3 = client.upload_invoice(\n        \u0026business,\n        \u00263000000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 3\"),\n        \u0026InvoiceCategory::Consulting,\n        \u0026tags,\n    );\n    client.verify_invoice(\u0026invoice_id_3);\n    client.cancel_invoice(\u0026invoice_id_3);\n\n    // Verify counts\n    let pending_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Pending);\n    let verified_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Verified);\n    let cancelled_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Cancelled);\n    let total_count = client.get_total_invoice_count();\n\n    assert_eq!(pending_count, 1);\n    assert_eq!(verified_count, 1);\n    assert_eq!(cancelled_count, 1);\n    assert_eq!(total_count, 3);\n}\n\n#[test]\nfn test_get_invoices_by_status_cancelled() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let due_date = env.ledger().timestamp() + 86400;\n    let tags = Vec::new(\u0026env);\n\n    // Create and cancel multiple invoices\n    let mut cancelled_ids = Vec::new(\u0026env);\n    for i in 0..3 {\n        let desc = if i == 0 {\n            \"Invoice 1\"\n        } else if i == 1 {\n            \"Invoice 2\"\n        } else {\n            \"Invoice 3\"\n        };\n        let invoice_id = client.upload_invoice(\n            \u0026business,\n            \u0026((i + 1) * 1000000),\n            \u0026currency,\n            \u0026due_date,\n            \u0026String::from_str(\u0026env, desc),\n            \u0026InvoiceCategory::Services,\n            \u0026tags,\n        );\n        client.cancel_invoice(\u0026invoice_id);\n        cancelled_ids.push_back(invoice_id);\n    }\n\n    // Get all cancelled invoices\n    let cancelled_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Cancelled);\n    assert_eq!(cancelled_invoices.len(), 3);\n\n    // Verify all cancelled IDs are in the list\n    for id in cancelled_ids.iter() {\n        let found = cancelled_invoices.iter().any(|invoice_id| invoice_id == id);\n        assert!(found);\n    }\n}\n","traces":[{"line":12,"address":[14260289,14260112,14260283],"length":1,"stats":{"Line":1}},{"line":18,"address":[14260160],"length":1,"stats":{"Line":1}},{"line":19,"address":[14260265],"length":1,"stats":{"Line":1}},{"line":912,"address":[14367935,14367929,14365040],"length":1,"stats":{"Line":0}},{"line":913,"address":[14365047],"length":1,"stats":{"Line":0}},{"line":914,"address":[14365080],"length":1,"stats":{"Line":0}},{"line":915,"address":[14365151],"length":1,"stats":{"Line":0}},{"line":916,"address":[14365182],"length":1,"stats":{"Line":0}},{"line":918,"address":[14365230],"length":1,"stats":{"Line":0}},{"line":919,"address":[14365294],"length":1,"stats":{"Line":0}},{"line":920,"address":[14365362],"length":1,"stats":{"Line":0}},{"line":921,"address":[14365494,14365446],"length":1,"stats":{"Line":0}},{"line":922,"address":[14365635],"length":1,"stats":{"Line":0}},{"line":923,"address":[14365659],"length":1,"stats":{"Line":0}},{"line":924,"address":[14365702],"length":1,"stats":{"Line":0}},{"line":925,"address":[14365753],"length":1,"stats":{"Line":0}},{"line":926,"address":[14365796],"length":1,"stats":{"Line":0}},{"line":927,"address":[14365844],"length":1,"stats":{"Line":0}},{"line":928,"address":[14365887],"length":1,"stats":{"Line":0}},{"line":929,"address":[14365935],"length":1,"stats":{"Line":0}},{"line":930,"address":[14365978],"length":1,"stats":{"Line":0}},{"line":931,"address":[14366026],"length":1,"stats":{"Line":0}},{"line":932,"address":[14366069],"length":1,"stats":{"Line":0}},{"line":935,"address":[14366220],"length":1,"stats":{"Line":0}},{"line":940,"address":[14366117],"length":1,"stats":{"Line":0}},{"line":942,"address":[14366152],"length":1,"stats":{"Line":0}},{"line":944,"address":[14366479],"length":1,"stats":{"Line":0}},{"line":945,"address":[14366543],"length":1,"stats":{"Line":0}},{"line":946,"address":[14366584],"length":1,"stats":{"Line":0}},{"line":947,"address":[14366625],"length":1,"stats":{"Line":0}},{"line":948,"address":[14366666],"length":1,"stats":{"Line":0}},{"line":949,"address":[14366707],"length":1,"stats":{"Line":0}},{"line":952,"address":[14366714],"length":1,"stats":{"Line":0}},{"line":955,"address":[14366792],"length":1,"stats":{"Line":0}},{"line":958,"address":[14366867],"length":1,"stats":{"Line":0}},{"line":959,"address":[14366874,14366966],"length":1,"stats":{"Line":0}},{"line":960,"address":[14367014],"length":1,"stats":{"Line":0}},{"line":961,"address":[14367118],"length":1,"stats":{"Line":0}},{"line":962,"address":[14367230],"length":1,"stats":{"Line":0}},{"line":963,"address":[14367332],"length":1,"stats":{"Line":0}},{"line":964,"address":[14367436],"length":1,"stats":{"Line":0}},{"line":967,"address":[14367550],"length":1,"stats":{"Line":0}},{"line":968,"address":[14367580],"length":1,"stats":{"Line":0}},{"line":973,"address":[14357127,14357121,14355152],"length":1,"stats":{"Line":0}},{"line":974,"address":[14355159],"length":1,"stats":{"Line":0}},{"line":975,"address":[14355183],"length":1,"stats":{"Line":0}},{"line":976,"address":[14355245],"length":1,"stats":{"Line":0}},{"line":977,"address":[14355270],"length":1,"stats":{"Line":0}},{"line":979,"address":[14355315],"length":1,"stats":{"Line":0}},{"line":980,"address":[14355376],"length":1,"stats":{"Line":0}},{"line":981,"address":[14355441],"length":1,"stats":{"Line":0}},{"line":982,"address":[14355567,14355519],"length":1,"stats":{"Line":0}},{"line":983,"address":[14355708],"length":1,"stats":{"Line":0}},{"line":984,"address":[14355732],"length":1,"stats":{"Line":0}},{"line":985,"address":[14355772],"length":1,"stats":{"Line":0}},{"line":986,"address":[14355823],"length":1,"stats":{"Line":0}},{"line":987,"address":[14355863],"length":1,"stats":{"Line":0}},{"line":988,"address":[14355911],"length":1,"stats":{"Line":0}},{"line":989,"address":[14355951],"length":1,"stats":{"Line":0}},{"line":992,"address":[14356096],"length":1,"stats":{"Line":0}},{"line":997,"address":[14355999],"length":1,"stats":{"Line":0}},{"line":999,"address":[14356031],"length":1,"stats":{"Line":0}},{"line":1001,"address":[14356355],"length":1,"stats":{"Line":0}},{"line":1002,"address":[14356416],"length":1,"stats":{"Line":0}},{"line":1003,"address":[14356454],"length":1,"stats":{"Line":0}},{"line":1004,"address":[14356492],"length":1,"stats":{"Line":0}},{"line":1007,"address":[14356499],"length":1,"stats":{"Line":0}},{"line":1008,"address":[14356577],"length":1,"stats":{"Line":0}},{"line":1011,"address":[14356644],"length":1,"stats":{"Line":0}},{"line":1012,"address":[14356674],"length":1,"stats":{"Line":0}},{"line":1015,"address":[14356778],"length":1,"stats":{"Line":0}},{"line":1018,"address":[14356801],"length":1,"stats":{"Line":0}},{"line":1019,"address":[14356831],"length":1,"stats":{"Line":0}},{"line":1024,"address":[14231860,14230320,14231854],"length":1,"stats":{"Line":0}},{"line":1025,"address":[14230327],"length":1,"stats":{"Line":0}},{"line":1026,"address":[14230351],"length":1,"stats":{"Line":0}},{"line":1027,"address":[14230413],"length":1,"stats":{"Line":0}},{"line":1028,"address":[14230438],"length":1,"stats":{"Line":0}},{"line":1030,"address":[14230483],"length":1,"stats":{"Line":0}},{"line":1031,"address":[14230544],"length":1,"stats":{"Line":0}},{"line":1032,"address":[14230609],"length":1,"stats":{"Line":0}},{"line":1033,"address":[14230687,14230735],"length":1,"stats":{"Line":0}},{"line":1034,"address":[14230876],"length":1,"stats":{"Line":0}},{"line":1037,"address":[14231000],"length":1,"stats":{"Line":0}},{"line":1042,"address":[14230900],"length":1,"stats":{"Line":0}},{"line":1044,"address":[14230932],"length":1,"stats":{"Line":0}},{"line":1046,"address":[14231259],"length":1,"stats":{"Line":0}},{"line":1049,"address":[14231289],"length":1,"stats":{"Line":0}},{"line":1050,"address":[14231367],"length":1,"stats":{"Line":0}},{"line":1053,"address":[14231434],"length":1,"stats":{"Line":0}},{"line":1054,"address":[14231464],"length":1,"stats":{"Line":0}},{"line":1057,"address":[14231568],"length":1,"stats":{"Line":0}},{"line":1060,"address":[14231591],"length":1,"stats":{"Line":0}},{"line":1061,"address":[14231621],"length":1,"stats":{"Line":0}},{"line":1066,"address":[14285904,14287660,14287666],"length":1,"stats":{"Line":0}},{"line":1067,"address":[14285911],"length":1,"stats":{"Line":0}},{"line":1068,"address":[14285935],"length":1,"stats":{"Line":0}},{"line":1069,"address":[14286000],"length":1,"stats":{"Line":0}},{"line":1070,"address":[14286028],"length":1,"stats":{"Line":0}},{"line":1072,"address":[14286076],"length":1,"stats":{"Line":0}},{"line":1073,"address":[14286137],"length":1,"stats":{"Line":0}},{"line":1074,"address":[14286202],"length":1,"stats":{"Line":0}},{"line":1075,"address":[14286328,14286280],"length":1,"stats":{"Line":0}},{"line":1076,"address":[14286469],"length":1,"stats":{"Line":0}},{"line":1079,"address":[14286593],"length":1,"stats":{"Line":0}},{"line":1084,"address":[14286493],"length":1,"stats":{"Line":0}},{"line":1086,"address":[14286525],"length":1,"stats":{"Line":0}},{"line":1088,"address":[14286852],"length":1,"stats":{"Line":0}},{"line":1091,"address":[14286882],"length":1,"stats":{"Line":0}},{"line":1092,"address":[14286960],"length":1,"stats":{"Line":0}},{"line":1095,"address":[14287035],"length":1,"stats":{"Line":0}},{"line":1096,"address":[14287133,14287042],"length":1,"stats":{"Line":0}},{"line":1098,"address":[14287188],"length":1,"stats":{"Line":0}},{"line":1101,"address":[14287306],"length":1,"stats":{"Line":0}},{"line":1102,"address":[14287337],"length":1,"stats":{"Line":0}},{"line":1103,"address":[14287344,14287435],"length":1,"stats":{"Line":0}},{"line":1136,"address":[14369448,14367952,14369454],"length":1,"stats":{"Line":0}},{"line":1137,"address":[14367959],"length":1,"stats":{"Line":0}},{"line":1138,"address":[14367983],"length":1,"stats":{"Line":0}},{"line":1139,"address":[14368045],"length":1,"stats":{"Line":0}},{"line":1140,"address":[14368070],"length":1,"stats":{"Line":0}},{"line":1142,"address":[14368115],"length":1,"stats":{"Line":0}},{"line":1143,"address":[14368176],"length":1,"stats":{"Line":0}},{"line":1144,"address":[14368241],"length":1,"stats":{"Line":0}},{"line":1145,"address":[14368367,14368319],"length":1,"stats":{"Line":0}},{"line":1146,"address":[14368508],"length":1,"stats":{"Line":0}},{"line":1149,"address":[14368632],"length":1,"stats":{"Line":0}},{"line":1154,"address":[14368532],"length":1,"stats":{"Line":0}},{"line":1156,"address":[14368564],"length":1,"stats":{"Line":0}},{"line":1158,"address":[14368891],"length":1,"stats":{"Line":0}},{"line":1161,"address":[14368921],"length":1,"stats":{"Line":0}},{"line":1162,"address":[14368999],"length":1,"stats":{"Line":0}},{"line":1165,"address":[14369066],"length":1,"stats":{"Line":0}},{"line":1168,"address":[14369089],"length":1,"stats":{"Line":0}},{"line":1169,"address":[14369130],"length":1,"stats":{"Line":0}},{"line":1172,"address":[14369204],"length":1,"stats":{"Line":0}},{"line":1173,"address":[14369245],"length":1,"stats":{"Line":0}},{"line":2097,"address":[14260304,14262201,14262195],"length":1,"stats":{"Line":0}},{"line":2098,"address":[14260311],"length":1,"stats":{"Line":0}},{"line":2099,"address":[14260343],"length":1,"stats":{"Line":0}},{"line":2100,"address":[14260412],"length":1,"stats":{"Line":0}},{"line":2103,"address":[14260460],"length":1,"stats":{"Line":0}},{"line":2105,"address":[14260513],"length":1,"stats":{"Line":0}},{"line":2106,"address":[14260537],"length":1,"stats":{"Line":0}},{"line":2107,"address":[14260602],"length":1,"stats":{"Line":0}},{"line":2108,"address":[14260626],"length":1,"stats":{"Line":0}},{"line":2109,"address":[14260752,14260704],"length":1,"stats":{"Line":0}},{"line":2110,"address":[14260893],"length":1,"stats":{"Line":0}},{"line":2112,"address":[14260925],"length":1,"stats":{"Line":0}},{"line":2113,"address":[14261001],"length":1,"stats":{"Line":0}},{"line":2114,"address":[14261008],"length":1,"stats":{"Line":0}},{"line":2115,"address":[14261158],"length":1,"stats":{"Line":0}},{"line":2118,"address":[14261189],"length":1,"stats":{"Line":0}},{"line":2125,"address":[14261165],"length":1,"stats":{"Line":0}},{"line":2129,"address":[14261412],"length":1,"stats":{"Line":0}},{"line":2130,"address":[14261514,14261483,14261427],"length":1,"stats":{"Line":0}},{"line":2133,"address":[14261507,14261547],"length":1,"stats":{"Line":0}},{"line":2134,"address":[14261711],"length":1,"stats":{"Line":0}},{"line":2135,"address":[14261811],"length":1,"stats":{"Line":0}},{"line":2136,"address":[14261909],"length":1,"stats":{"Line":0}},{"line":2141,"address":[14319451,14319457,14318128],"length":1,"stats":{"Line":0}},{"line":2142,"address":[14318135],"length":1,"stats":{"Line":0}},{"line":2143,"address":[14318164],"length":1,"stats":{"Line":0}},{"line":2144,"address":[14318230],"length":1,"stats":{"Line":0}},{"line":2147,"address":[14318275],"length":1,"stats":{"Line":0}},{"line":2149,"address":[14318328],"length":1,"stats":{"Line":0}},{"line":2150,"address":[14318352],"length":1,"stats":{"Line":0}},{"line":2151,"address":[14318417],"length":1,"stats":{"Line":0}},{"line":2152,"address":[14318441],"length":1,"stats":{"Line":0}},{"line":2153,"address":[14318519,14318567],"length":1,"stats":{"Line":0}},{"line":2154,"address":[14318708],"length":1,"stats":{"Line":0}},{"line":2156,"address":[14318740],"length":1,"stats":{"Line":0}},{"line":2157,"address":[14318816],"length":1,"stats":{"Line":0}},{"line":2158,"address":[14318823],"length":1,"stats":{"Line":0}},{"line":2159,"address":[14318973],"length":1,"stats":{"Line":0}},{"line":2162,"address":[14319004],"length":1,"stats":{"Line":0}},{"line":2169,"address":[14318980],"length":1,"stats":{"Line":0}},{"line":2171,"address":[14319219],"length":1,"stats":{"Line":0}},{"line":2174,"address":[14319242],"length":1,"stats":{"Line":0}},{"line":2175,"address":[14319269],"length":1,"stats":{"Line":0}},{"line":2180,"address":[14315033,14315039,14312432],"length":1,"stats":{"Line":0}},{"line":2181,"address":[14312439],"length":1,"stats":{"Line":0}},{"line":2182,"address":[14312471],"length":1,"stats":{"Line":0}},{"line":2183,"address":[14312540],"length":1,"stats":{"Line":0}},{"line":2186,"address":[14312588],"length":1,"stats":{"Line":0}},{"line":2188,"address":[14312641],"length":1,"stats":{"Line":0}},{"line":2189,"address":[14312665],"length":1,"stats":{"Line":0}},{"line":2190,"address":[14312730],"length":1,"stats":{"Line":0}},{"line":2191,"address":[14312754],"length":1,"stats":{"Line":0}},{"line":2192,"address":[14312832,14312880],"length":1,"stats":{"Line":0}},{"line":2193,"address":[14313021],"length":1,"stats":{"Line":0}},{"line":2195,"address":[14313053],"length":1,"stats":{"Line":0}},{"line":2196,"address":[14313129],"length":1,"stats":{"Line":0}},{"line":2197,"address":[14313136],"length":1,"stats":{"Line":0}},{"line":2198,"address":[14313286],"length":1,"stats":{"Line":0}},{"line":2201,"address":[14313317],"length":1,"stats":{"Line":0}},{"line":2208,"address":[14313293],"length":1,"stats":{"Line":0}},{"line":2210,"address":[14313605,14313516],"length":1,"stats":{"Line":0}},{"line":2211,"address":[14313626],"length":1,"stats":{"Line":0}},{"line":2218,"address":[14313581],"length":1,"stats":{"Line":0}},{"line":2230,"address":[14313969],"length":1,"stats":{"Line":0}},{"line":2231,"address":[14314055,14314107],"length":1,"stats":{"Line":0}},{"line":2235,"address":[14314208],"length":1,"stats":{"Line":0}},{"line":2242,"address":[14314419],"length":1,"stats":{"Line":0}},{"line":2243,"address":[14314505,14314588,14314557],"length":1,"stats":{"Line":0}},{"line":2244,"address":[14314581,14314621],"length":1,"stats":{"Line":0}},{"line":2249,"address":[14244544,14245808,14245959],"length":1,"stats":{"Line":0}},{"line":2250,"address":[14244551],"length":1,"stats":{"Line":0}},{"line":2251,"address":[14244580],"length":1,"stats":{"Line":0}},{"line":2252,"address":[14244646],"length":1,"stats":{"Line":0}},{"line":2255,"address":[14244691],"length":1,"stats":{"Line":0}},{"line":2257,"address":[14244744],"length":1,"stats":{"Line":0}},{"line":2258,"address":[14244768],"length":1,"stats":{"Line":0}},{"line":2259,"address":[14244833],"length":1,"stats":{"Line":0}},{"line":2260,"address":[14244857],"length":1,"stats":{"Line":0}},{"line":2261,"address":[14244935,14244983],"length":1,"stats":{"Line":0}},{"line":2262,"address":[14245124],"length":1,"stats":{"Line":0}},{"line":2264,"address":[14245156],"length":1,"stats":{"Line":0}},{"line":2265,"address":[14245232],"length":1,"stats":{"Line":0}},{"line":2266,"address":[14245239],"length":1,"stats":{"Line":0}},{"line":2267,"address":[14245389],"length":1,"stats":{"Line":0}},{"line":2270,"address":[14245420],"length":1,"stats":{"Line":0}},{"line":2277,"address":[14245396],"length":1,"stats":{"Line":0}},{"line":2279,"address":[14245635],"length":1,"stats":{"Line":0}},{"line":2282,"address":[14245658],"length":1,"stats":{"Line":0}},{"line":2283,"address":[14245665],"length":1,"stats":{"Line":0}},{"line":2284,"address":[14245760,14245708],"length":1,"stats":{"Line":0}},{"line":2773,"address":[14235984,14238149,14238173],"length":1,"stats":{"Line":0}},{"line":2774,"address":[14235991],"length":1,"stats":{"Line":0}},{"line":2775,"address":[14236040],"length":1,"stats":{"Line":0}},{"line":2776,"address":[14236115],"length":1,"stats":{"Line":0}},{"line":2778,"address":[14236163],"length":1,"stats":{"Line":0}},{"line":2779,"address":[14236227],"length":1,"stats":{"Line":0}},{"line":2780,"address":[14236295],"length":1,"stats":{"Line":0}},{"line":2781,"address":[14236335,14236383],"length":1,"stats":{"Line":0}},{"line":2782,"address":[14236524],"length":1,"stats":{"Line":0}},{"line":2785,"address":[14236630],"length":1,"stats":{"Line":0}},{"line":2792,"address":[14236559],"length":1,"stats":{"Line":0}},{"line":2794,"address":[14236845],"length":1,"stats":{"Line":0}},{"line":2797,"address":[14236852],"length":1,"stats":{"Line":0}},{"line":2798,"address":[14236887],"length":1,"stats":{"Line":0}},{"line":2800,"address":[14237006],"length":1,"stats":{"Line":0}},{"line":2803,"address":[14237070],"length":1,"stats":{"Line":0}},{"line":2804,"address":[14237100],"length":1,"stats":{"Line":0}},{"line":2806,"address":[14237212],"length":1,"stats":{"Line":0}},{"line":2807,"address":[14237235,14237291],"length":1,"stats":{"Line":0}},{"line":2809,"address":[14237330],"length":1,"stats":{"Line":0}},{"line":2810,"address":[14237400,14237496],"length":1,"stats":{"Line":0}},{"line":2811,"address":[14237544],"length":1,"stats":{"Line":0}},{"line":2812,"address":[14237648],"length":1,"stats":{"Line":0}},{"line":2813,"address":[14237752],"length":1,"stats":{"Line":0}},{"line":2818,"address":[14321781,14319472,14321757],"length":1,"stats":{"Line":0}},{"line":2819,"address":[14319479],"length":1,"stats":{"Line":0}},{"line":2820,"address":[14319528],"length":1,"stats":{"Line":0}},{"line":2821,"address":[14319603],"length":1,"stats":{"Line":0}},{"line":2823,"address":[14319651],"length":1,"stats":{"Line":0}},{"line":2824,"address":[14319715],"length":1,"stats":{"Line":0}},{"line":2825,"address":[14319783],"length":1,"stats":{"Line":0}},{"line":2826,"address":[14319851],"length":1,"stats":{"Line":0}},{"line":2827,"address":[14319891,14319939],"length":1,"stats":{"Line":0}},{"line":2828,"address":[14320080],"length":1,"stats":{"Line":0}},{"line":2831,"address":[14320186],"length":1,"stats":{"Line":0}},{"line":2838,"address":[14320115],"length":1,"stats":{"Line":0}},{"line":2840,"address":[14320401],"length":1,"stats":{"Line":0}},{"line":2843,"address":[14320408],"length":1,"stats":{"Line":0}},{"line":2844,"address":[14320575],"length":1,"stats":{"Line":0}},{"line":2847,"address":[14320626],"length":1,"stats":{"Line":0}},{"line":2848,"address":[14320661],"length":1,"stats":{"Line":0}},{"line":2850,"address":[14320780],"length":1,"stats":{"Line":0}},{"line":2853,"address":[14320844],"length":1,"stats":{"Line":0}},{"line":2854,"address":[14320874],"length":1,"stats":{"Line":0}},{"line":2856,"address":[14320986],"length":1,"stats":{"Line":0}},{"line":2857,"address":[14321065,14321009],"length":1,"stats":{"Line":0}},{"line":2859,"address":[14321104],"length":1,"stats":{"Line":0}},{"line":2860,"address":[14321270,14321174],"length":1,"stats":{"Line":0}},{"line":2861,"address":[14321318],"length":1,"stats":{"Line":0}},{"line":2862,"address":[14321422],"length":1,"stats":{"Line":0}},{"line":2867,"address":[14340865,14339504,14340871],"length":1,"stats":{"Line":0}},{"line":2868,"address":[14339511],"length":1,"stats":{"Line":0}},{"line":2869,"address":[14339540],"length":1,"stats":{"Line":0}},{"line":2870,"address":[14339606],"length":1,"stats":{"Line":0}},{"line":2872,"address":[14339651],"length":1,"stats":{"Line":0}},{"line":2873,"address":[14339712],"length":1,"stats":{"Line":0}},{"line":2874,"address":[14339777],"length":1,"stats":{"Line":0}},{"line":2875,"address":[14339842],"length":1,"stats":{"Line":0}},{"line":2876,"address":[14339927,14339879],"length":1,"stats":{"Line":0}},{"line":2877,"address":[14340068],"length":1,"stats":{"Line":0}},{"line":2880,"address":[14340168],"length":1,"stats":{"Line":0}},{"line":2887,"address":[14340100],"length":1,"stats":{"Line":0}},{"line":2889,"address":[14340383],"length":1,"stats":{"Line":0}},{"line":2892,"address":[14340390],"length":1,"stats":{"Line":0}},{"line":2893,"address":[14340422],"length":1,"stats":{"Line":0}},{"line":2895,"address":[14340538,14340596],"length":1,"stats":{"Line":0}},{"line":2897,"address":[14340628],"length":1,"stats":{"Line":0}},{"line":2902,"address":[14331840,14333354,14333348],"length":1,"stats":{"Line":0}},{"line":2903,"address":[14331847],"length":1,"stats":{"Line":0}},{"line":2904,"address":[14331876],"length":1,"stats":{"Line":0}},{"line":2905,"address":[14331942],"length":1,"stats":{"Line":0}},{"line":2907,"address":[14331987],"length":1,"stats":{"Line":0}},{"line":2908,"address":[14332048],"length":1,"stats":{"Line":0}},{"line":2909,"address":[14332113],"length":1,"stats":{"Line":0}},{"line":2910,"address":[14332198,14332150],"length":1,"stats":{"Line":0}},{"line":2911,"address":[14332339],"length":1,"stats":{"Line":0}},{"line":2914,"address":[14332439],"length":1,"stats":{"Line":0}},{"line":2921,"address":[14332371],"length":1,"stats":{"Line":0}},{"line":2923,"address":[14332654],"length":1,"stats":{"Line":0}},{"line":2926,"address":[14332661],"length":1,"stats":{"Line":0}},{"line":2927,"address":[14332693],"length":1,"stats":{"Line":0}},{"line":2929,"address":[14332809],"length":1,"stats":{"Line":0}},{"line":2932,"address":[14332857],"length":1,"stats":{"Line":0}},{"line":2933,"address":[14332889],"length":1,"stats":{"Line":0}},{"line":2935,"address":[14333002,14333060],"length":1,"stats":{"Line":0}},{"line":2937,"address":[14333092],"length":1,"stats":{"Line":0}},{"line":2942,"address":[14271693,14271699,14270224],"length":1,"stats":{"Line":0}},{"line":2943,"address":[14270231],"length":1,"stats":{"Line":0}},{"line":2944,"address":[14270260],"length":1,"stats":{"Line":0}},{"line":2945,"address":[14270326],"length":1,"stats":{"Line":0}},{"line":2947,"address":[14270371],"length":1,"stats":{"Line":0}},{"line":2948,"address":[14270432],"length":1,"stats":{"Line":0}},{"line":2949,"address":[14270497],"length":1,"stats":{"Line":0}},{"line":2950,"address":[14270562],"length":1,"stats":{"Line":0}},{"line":2951,"address":[14270647,14270599],"length":1,"stats":{"Line":0}},{"line":2952,"address":[14270788],"length":1,"stats":{"Line":0}},{"line":2955,"address":[14270820],"length":1,"stats":{"Line":0}},{"line":2956,"address":[14270896],"length":1,"stats":{"Line":0}},{"line":2959,"address":[14270927],"length":1,"stats":{"Line":0}},{"line":2966,"address":[14270903],"length":1,"stats":{"Line":0}},{"line":2968,"address":[14271142],"length":1,"stats":{"Line":0}},{"line":2970,"address":[14271149],"length":1,"stats":{"Line":0}},{"line":2971,"address":[14271181],"length":1,"stats":{"Line":0}},{"line":2973,"address":[14271297],"length":1,"stats":{"Line":0}},{"line":2976,"address":[14271369],"length":1,"stats":{"Line":0}},{"line":2979,"address":[14271392],"length":1,"stats":{"Line":0}},{"line":2980,"address":[14271422],"length":1,"stats":{"Line":0}},{"line":2985,"address":[14243166,14240992,14243142],"length":1,"stats":{"Line":0}},{"line":2986,"address":[14240999],"length":1,"stats":{"Line":0}},{"line":2987,"address":[14241039],"length":1,"stats":{"Line":0}},{"line":2988,"address":[14241108],"length":1,"stats":{"Line":0}},{"line":2990,"address":[14241156],"length":1,"stats":{"Line":0}},{"line":2991,"address":[14241217],"length":1,"stats":{"Line":0}},{"line":2992,"address":[14241282],"length":1,"stats":{"Line":0}},{"line":2993,"address":[14241347],"length":1,"stats":{"Line":0}},{"line":2994,"address":[14241432,14241384],"length":1,"stats":{"Line":0}},{"line":2995,"address":[14241573],"length":1,"stats":{"Line":0}},{"line":2998,"address":[14241605],"length":1,"stats":{"Line":0}},{"line":2999,"address":[14241681],"length":1,"stats":{"Line":0}},{"line":3002,"address":[14241712],"length":1,"stats":{"Line":0}},{"line":3009,"address":[14241688],"length":1,"stats":{"Line":0}},{"line":3011,"address":[14241927],"length":1,"stats":{"Line":0}},{"line":3013,"address":[14241934],"length":1,"stats":{"Line":0}},{"line":3014,"address":[14241966],"length":1,"stats":{"Line":0}},{"line":3016,"address":[14242082],"length":1,"stats":{"Line":0}},{"line":3019,"address":[14242154],"length":1,"stats":{"Line":0}},{"line":3026,"address":[14242225],"length":1,"stats":{"Line":0}},{"line":3029,"address":[14242292],"length":1,"stats":{"Line":0}},{"line":3030,"address":[14242322],"length":1,"stats":{"Line":0}},{"line":3032,"address":[14242434],"length":1,"stats":{"Line":0}},{"line":3033,"address":[14242457,14242513],"length":1,"stats":{"Line":0}},{"line":3035,"address":[14242552],"length":1,"stats":{"Line":0}},{"line":3036,"address":[14242622,14242718],"length":1,"stats":{"Line":0}},{"line":3037,"address":[14242766],"length":1,"stats":{"Line":0}},{"line":3038,"address":[14242870],"length":1,"stats":{"Line":0}},{"line":3043,"address":[14323741,14323735,14321808],"length":1,"stats":{"Line":0}},{"line":3044,"address":[14321815],"length":1,"stats":{"Line":0}},{"line":3045,"address":[14321844],"length":1,"stats":{"Line":0}},{"line":3046,"address":[14321910],"length":1,"stats":{"Line":0}},{"line":3048,"address":[14321955],"length":1,"stats":{"Line":0}},{"line":3049,"address":[14322016],"length":1,"stats":{"Line":0}},{"line":3050,"address":[14322081],"length":1,"stats":{"Line":0}},{"line":3051,"address":[14322146],"length":1,"stats":{"Line":0}},{"line":3052,"address":[14322183,14322231],"length":1,"stats":{"Line":0}},{"line":3053,"address":[14322372],"length":1,"stats":{"Line":0}},{"line":3056,"address":[14322472],"length":1,"stats":{"Line":0}},{"line":3063,"address":[14322404],"length":1,"stats":{"Line":0}},{"line":3066,"address":[14322695],"length":1,"stats":{"Line":0}},{"line":3073,"address":[14322671],"length":1,"stats":{"Line":0}},{"line":3076,"address":[14322910],"length":1,"stats":{"Line":0}},{"line":3077,"address":[14322933],"length":1,"stats":{"Line":0}},{"line":3080,"address":[14322940],"length":1,"stats":{"Line":0}},{"line":3081,"address":[14322972],"length":1,"stats":{"Line":0}},{"line":3083,"address":[14323088],"length":1,"stats":{"Line":0}},{"line":3085,"address":[14323176],"length":1,"stats":{"Line":0}},{"line":3088,"address":[14323199],"length":1,"stats":{"Line":0}},{"line":3089,"address":[14323214,14323273],"length":1,"stats":{"Line":0}},{"line":3090,"address":[14323390],"length":1,"stats":{"Line":0}},{"line":3091,"address":[14323460],"length":1,"stats":{"Line":0}},{"line":3096,"address":[14346272,14343504,14346266],"length":1,"stats":{"Line":0}},{"line":3097,"address":[14343511],"length":1,"stats":{"Line":0}},{"line":3098,"address":[14343540],"length":1,"stats":{"Line":0}},{"line":3099,"address":[14343606],"length":1,"stats":{"Line":0}},{"line":3101,"address":[14343651],"length":1,"stats":{"Line":0}},{"line":3102,"address":[14343712],"length":1,"stats":{"Line":0}},{"line":3103,"address":[14343777],"length":1,"stats":{"Line":0}},{"line":3104,"address":[14343842],"length":1,"stats":{"Line":0}},{"line":3105,"address":[14343879,14343927],"length":1,"stats":{"Line":0}},{"line":3106,"address":[14344068],"length":1,"stats":{"Line":0}},{"line":3109,"address":[14344100],"length":1,"stats":{"Line":0}},{"line":3110,"address":[14344176],"length":1,"stats":{"Line":0}},{"line":3113,"address":[14344207],"length":1,"stats":{"Line":0}},{"line":3120,"address":[14344183],"length":1,"stats":{"Line":0}},{"line":3123,"address":[14344422],"length":1,"stats":{"Line":0}},{"line":3125,"address":[14344429],"length":1,"stats":{"Line":0}},{"line":3126,"address":[14344461],"length":1,"stats":{"Line":0}},{"line":3128,"address":[14344577],"length":1,"stats":{"Line":0}},{"line":3131,"address":[14344625],"length":1,"stats":{"Line":0}},{"line":3132,"address":[14344663,14344719],"length":1,"stats":{"Line":0}},{"line":3133,"address":[14344838],"length":1,"stats":{"Line":0}},{"line":3136,"address":[14345060],"length":1,"stats":{"Line":0}},{"line":3139,"address":[14345067],"length":1,"stats":{"Line":0}},{"line":3140,"address":[14345164,14345105],"length":1,"stats":{"Line":0}},{"line":3141,"address":[14345283],"length":1,"stats":{"Line":0}},{"line":3144,"address":[14345481],"length":1,"stats":{"Line":0}},{"line":3145,"address":[14345545],"length":1,"stats":{"Line":0}},{"line":3148,"address":[14345596],"length":1,"stats":{"Line":0}},{"line":3149,"address":[14345690,14345634],"length":1,"stats":{"Line":0}},{"line":3150,"address":[14345809],"length":1,"stats":{"Line":0}},{"line":3155,"address":[14256771,14256765,14255152],"length":1,"stats":{"Line":0}},{"line":3156,"address":[14255159],"length":1,"stats":{"Line":0}},{"line":3157,"address":[14255191],"length":1,"stats":{"Line":0}},{"line":3158,"address":[14255260],"length":1,"stats":{"Line":0}},{"line":3160,"address":[14255308],"length":1,"stats":{"Line":0}},{"line":3161,"address":[14255369],"length":1,"stats":{"Line":0}},{"line":3162,"address":[14255434],"length":1,"stats":{"Line":0}},{"line":3163,"address":[14255519,14255471],"length":1,"stats":{"Line":0}},{"line":3164,"address":[14255660],"length":1,"stats":{"Line":0}},{"line":3167,"address":[14255760],"length":1,"stats":{"Line":0}},{"line":3174,"address":[14255692],"length":1,"stats":{"Line":0}},{"line":3176,"address":[14255975],"length":1,"stats":{"Line":0}},{"line":3179,"address":[14256004],"length":1,"stats":{"Line":0}},{"line":3180,"address":[14256011],"length":1,"stats":{"Line":0}},{"line":3182,"address":[14256185,14256127],"length":1,"stats":{"Line":0}},{"line":3183,"address":[14256217],"length":1,"stats":{"Line":0}},{"line":3186,"address":[14256271],"length":1,"stats":{"Line":0}},{"line":3187,"address":[14256325],"length":1,"stats":{"Line":0}},{"line":3189,"address":[14256474,14256416],"length":1,"stats":{"Line":0}},{"line":3190,"address":[14256506],"length":1,"stats":{"Line":0}}],"covered":3,"coverable":436},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_bid.rs"],"content":"/// Minimized test suite for bid functionality\n/// Coverage: placement/withdrawal, invoice status gating, indexing/query correctness\n///\n/// Test Categories (Core Only):\n/// 1. Status Gating - verify bids only work on verified invoices\n/// 2. Withdrawal - authorize only bid owner can withdraw\n/// 3. Indexing - multiple bids properly indexed and queryable\n/// 4. Ranking - profit-based bid comparison works correctly\nuse super::*;\nuse crate::bid::BidStatus;\nuse crate::invoice::InvoiceCategory;\nuse soroban_sdk::{\n    testutils::{Address as _, Ledger},\n    Address, BytesN, Env, String, Vec,\n};\n\n// Helper: Setup contract with admin\nfn setup() -\u003e (Env, QuickLendXContractClient\u003c'static\u003e) {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    (env, client)\n}\n\n// Helper: Create verified investor - using same pattern as test.rs\nfn add_verified_investor(env: \u0026Env, client: \u0026QuickLendXContractClient, limit: i128) -\u003e Address {\n    let investor = Address::generate(env);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(env, \"KYC\"));\n    client.verify_investor(\u0026investor, \u0026limit);\n    investor\n}\n\n// Helper: Create verified invoice\nfn create_verified_invoice(\n    env: \u0026Env,\n    client: \u0026QuickLendXContractClient,\n    _admin: \u0026Address,\n    business: \u0026Address,\n    amount: i128,\n) -\u003e BytesN\u003c32\u003e {\n    let currency = Address::generate(env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(env, \"Invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(env),\n    );\n\n    let _ = client.try_verify_invoice(\u0026invoice_id);\n    invoice_id\n}\n\n// ============================================================================\n// Category 1: Status Gating - Invoice Verification Required\n// ============================================================================\n\n/// Core Test: Bid on pending (non-verified) invoice fails\n#[test]\nfn test_bid_placement_non_verified_invoice_fails() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Create pending invoice (not verified)\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u002610_000,\n        \u0026currency,\n        \u0026(env.ledger().timestamp() + 86400),\n        \u0026String::from_str(\u0026env, \"Pending\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Attempt bid on pending invoice should fail\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n    assert!(result.is_err(), \"Bid on pending invoice must fail\");\n}\n\n/// Core Test: Bid on verified invoice succeeds\n#[test]\nfn test_bid_placement_verified_invoice_succeeds() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Bid on verified invoice should succeed\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n    assert!(result.is_ok(), \"Bid on verified invoice must succeed\");\n\n    let bid_id = result.unwrap().unwrap();\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some());\n    assert_eq!(bid.unwrap().status, BidStatus::Placed);\n}\n\n/// Core Test: Investment limit enforced\n#[test]\nfn test_bid_placement_respects_investment_limit() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 1_000); // Low limit\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Bid exceeding limit should fail\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00262_000, \u00263_000);\n    assert!(result.is_err(), \"Bid exceeding investment limit must fail\");\n}\n\n// ============================================================================\n// Category 2: Withdrawal - Authorization and State Constraints\n// ============================================================================\n\n/// Core Test: Bid owner can withdraw own bid\n#[test]\nfn test_bid_withdrawal_by_owner_succeeds() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n\n    // Withdraw should succeed\n    let result = client.try_withdraw_bid(\u0026bid_id);\n    assert!(result.is_ok(), \"Owner bid withdrawal must succeed\");\n\n    // Verify withdrawn\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some());\n    assert_eq!(bid.unwrap().status, BidStatus::Withdrawn);\n}\n\n/// Core Test: Only Placed bids can be withdrawn\n#[test]\nfn test_bid_withdrawal_only_placed_bids() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n\n    // Withdraw once\n    let _ = client.try_withdraw_bid(\u0026bid_id);\n\n    // Second withdraw attempt should fail\n    let result = client.try_withdraw_bid(\u0026bid_id);\n    assert!(result.is_err(), \"Cannot withdraw non-Placed bid\");\n}\n\n// ============================================================================\n// Category 3: Indexing \u0026 Query Correctness - Multiple Bids\n// ============================================================================\n\n/// Core Test: Multiple bids indexed and queryable by status\n#[test]\nfn test_multiple_bids_indexing_and_query() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor3 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // Place 3 bids\n    let bid_id_1 = client.place_bid(\u0026investor1, \u0026invoice_id, \u002610_000, \u002612_000);\n    let bid_id_2 = client.place_bid(\u0026investor2, \u0026invoice_id, \u002615_000, \u002618_000);\n    let bid_id_3 = client.place_bid(\u0026investor3, \u0026invoice_id, \u002620_000, \u002624_000);\n\n    // Query placed bids\n    let placed_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed_bids.len(), 3, \"Should have 3 placed bids\");\n\n    // Verify all bid IDs present\n    let found_1 = placed_bids.iter().any(|b| b.bid_id == bid_id_1);\n    let found_2 = placed_bids.iter().any(|b| b.bid_id == bid_id_2);\n    let found_3 = placed_bids.iter().any(|b| b.bid_id == bid_id_3);\n    assert!(found_1 \u0026\u0026 found_2 \u0026\u0026 found_3, \"All bid IDs must be indexed\");\n\n    // Withdraw one and verify status filtering\n    let _ = client.try_withdraw_bid(\u0026bid_id_1);\n    let placed_after = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(\n        placed_after.len(),\n        2,\n        \"Should have 2 placed bids after withdrawal\"\n    );\n\n    let withdrawn_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Withdrawn);\n    assert_eq!(withdrawn_bids.len(), 1, \"Should have 1 withdrawn bid\");\n}\n\n/// Core Test: Query by investor works correctly\n#[test]\nfn test_query_bids_by_investor() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id_1 = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n    let invoice_id_2 = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // Investor1 places 2 bids on different invoices\n    let _bid_1a = client.place_bid(\u0026investor1, \u0026invoice_id_1, \u002610_000, \u002612_000);\n    let _bid_1b = client.place_bid(\u0026investor1, \u0026invoice_id_2, \u002615_000, \u002618_000);\n\n    // Investor2 places 1 bid\n    let _bid_2 = client.place_bid(\u0026investor2, \u0026invoice_id_1, \u002620_000, \u002624_000);\n\n    // Query investor1 bids on invoice 1\n    let inv1_bids = client.get_bids_by_investor(\u0026invoice_id_1, \u0026investor1);\n    assert_eq!(\n        inv1_bids.len(),\n        1,\n        \"Investor1 should have 1 bid on invoice 1\"\n    );\n\n    // Query investor2 bids on invoice 1\n    let inv2_bids = client.get_bids_by_investor(\u0026invoice_id_1, \u0026investor2);\n    assert_eq!(\n        inv2_bids.len(),\n        1,\n        \"Investor2 should have 1 bid on invoice 1\"\n    );\n}\n\n// ============================================================================\n// Category 4: Bid Ranking - Profit-Based Comparison Logic\n// ============================================================================\n\n/// Core Test: Best bid selection based on profit margin\n#[test]\nfn test_bid_ranking_by_profit() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor3 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // Place bids with different profit margins\n    // investor1: profit = 12k - 10k = 2k\n    let _bid_1 = client.place_bid(\u0026investor1, \u0026invoice_id, \u002610_000, \u002612_000);\n\n    // investor2: profit = 18k - 15k = 3k (highest)\n    let _bid_2 = client.place_bid(\u0026investor2, \u0026invoice_id, \u002615_000, \u002618_000);\n\n    // investor3: profit = 13k - 12k = 1k (lowest)\n    let _bid_3 = client.place_bid(\u0026investor3, \u0026invoice_id, \u002612_000, \u002613_000);\n\n    // Best bid should be investor2 (highest profit)\n    let best_bid = client.get_best_bid(\u0026invoice_id);\n    assert!(best_bid.is_some());\n    assert_eq!(\n        best_bid.unwrap().investor,\n        investor2,\n        \"Best bid must have highest profit\"\n    );\n\n    // Ranked bids should order by profit descending\n    let ranked = client.get_ranked_bids(\u0026invoice_id);\n    assert_eq!(ranked.len(), 3, \"Should have 3 ranked bids\");\n    assert_eq!(\n        ranked.get(0).unwrap().investor,\n        investor2,\n        \"Rank 1: investor2 (profit 3k)\"\n    );\n    assert_eq!(\n        ranked.get(1).unwrap().investor,\n        investor1,\n        \"Rank 2: investor1 (profit 2k)\"\n    );\n    assert_eq!(\n        ranked.get(2).unwrap().investor,\n        investor3,\n        \"Rank 3: investor3 (profit 1k)\"\n    );\n}\n\n/// Core Test: Best bid ignores withdrawn bids\n#[test]\nfn test_best_bid_excludes_withdrawn() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // investor1: profit = 2k\n    let _bid_1 = client.place_bid(\u0026investor1, \u0026invoice_id, \u002610_000, \u002612_000);\n\n    // investor2: profit = 10k (best initially)\n    let bid_2 = client.place_bid(\u0026investor2, \u0026invoice_id, \u002615_000, \u002625_000);\n\n    // Withdraw best bid\n    let _ = client.try_withdraw_bid(\u0026bid_2);\n\n    // Best bid should now be investor1\n    let best = client.get_best_bid(\u0026invoice_id);\n    assert!(best.is_some());\n    assert_eq!(\n        best.unwrap().investor,\n        investor1,\n        \"Best bid must skip withdrawn bids\"\n    );\n}\n\n/// Core Test: Bid expiration cleanup\n#[test]\nfn test_bid_expiration_and_cleanup() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n\n    let placed = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed.len(), 1, \"Should have 1 placed bid\");\n\n    // Advance time past expiration (7 days = 604800 seconds)\n    env.ledger()\n        .set_timestamp(env.ledger().timestamp() + 604800 + 1);\n\n    // Query to trigger cleanup\n    let placed_after = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(\n        placed_after.len(),\n        0,\n        \"Placed bids should be empty after expiration\"\n    );\n\n    // Bid should be marked expired\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some());\n    assert_eq!(\n        bid.unwrap().status,\n        BidStatus::Expired,\n        \"Bid must be marked expired\"\n    );\n}\n","traces":[{"line":18,"address":[15427872,15428263,15428269],"length":1,"stats":{"Line":0}},{"line":19,"address":[15427888],"length":1,"stats":{"Line":0}},{"line":20,"address":[15427933],"length":1,"stats":{"Line":0}},{"line":21,"address":[15427996],"length":1,"stats":{"Line":0}},{"line":22,"address":[15428045],"length":1,"stats":{"Line":0}},{"line":26,"address":[15409759,15409753,15409488],"length":1,"stats":{"Line":0}},{"line":27,"address":[15409540],"length":1,"stats":{"Line":0}},{"line":28,"address":[15409638,15409559],"length":1,"stats":{"Line":0}},{"line":29,"address":[15409713],"length":1,"stats":{"Line":0}},{"line":30,"address":[15409725],"length":1,"stats":{"Line":0}},{"line":34,"address":[15410529,15410523,15409776],"length":1,"stats":{"Line":0}},{"line":41,"address":[15409856],"length":1,"stats":{"Line":0}},{"line":42,"address":[15409931,15409883],"length":1,"stats":{"Line":0}},{"line":44,"address":[15410182],"length":1,"stats":{"Line":0}},{"line":49,"address":[15410077],"length":1,"stats":{"Line":0}},{"line":51,"address":[15410109],"length":1,"stats":{"Line":0}},{"line":54,"address":[15410435],"length":1,"stats":{"Line":0}},{"line":55,"address":[15410481],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":18},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_escrow.rs"],"content":"/// Comprehensive test suite for escrow funding flow\n/// \n/// Test Coverage:\n/// 1. Authorization: Only invoice owner can accept bids\n/// 2. State Validation: Only verified invoices can be funded\n/// 3. Token Transfer: Funds are locked exactly once with correct amounts\n/// 4. Idempotency: Rejects double-accept attempts\n/// 5. Edge Cases: Invalid states, unauthorized access, fund verification\n/// \n/// Security Notes:\n/// - Uses soroban-sdk testutils token patterns for realistic token simulation\n/// - All auth requirements verified via require_auth() checks\n/// - Escrow state transitions validated at each step\n/// - Token balances verified before/after transfers\n\nuse super::*;\nuse crate::bid::BidStatus;\nuse crate::invoice::{InvoiceCategory, InvoiceStatus};\nuse crate::payments::EscrowStatus;\nuse soroban_sdk::{\n    testutils::Address as _,\n    token, Address, BytesN, Env, String, Vec,\n};\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/// Setup test environment with contract and admin\nfn setup() -\u003e (Env, QuickLendXContractClient\u003c'static\u003e, Address) {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    (env, client, admin)\n}\n\n/// Create a Stellar Asset Contract token for testing with proper balances\nfn setup_token(env: \u0026Env, business: \u0026Address, investor: \u0026Address, contract_id: \u0026Address) -\u003e Address {\n    let token_admin = Address::generate(env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    \n    let token_client = token::Client::new(env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(env, \u0026currency);\n\n    // Mint tokens to business and investor\n    let initial_balance = 100_000i128;\n    sac_client.mint(business, \u0026initial_balance);\n    sac_client.mint(investor, \u0026initial_balance);\n\n    // Approve contract to spend tokens\n    let expiration = env.ledger().sequence() + 10_000;\n    token_client.approve(business, contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(investor, contract_id, \u0026initial_balance, \u0026expiration);\n\n    currency\n}\n\n/// Create and verify a business\nfn setup_verified_business(env: \u0026Env, client: \u0026QuickLendXContractClient, admin: \u0026Address) -\u003e Address {\n    let business = Address::generate(env);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(env, \"Business KYC\"));\n    client.verify_business(admin, \u0026business);\n    business\n}\n\n/// Create and verify an investor with specified limit\nfn setup_verified_investor(env: \u0026Env, client: \u0026QuickLendXContractClient, limit: i128) -\u003e Address {\n    let investor = Address::generate(env);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(env, \"Investor KYC\"));\n    client.verify_investor(\u0026investor, \u0026limit);\n    investor\n}\n\n/// Create a verified invoice ready for bidding\nfn create_verified_invoice(\n    env: \u0026Env,\n    client: \u0026QuickLendXContractClient,\n    business: \u0026Address,\n    amount: i128,\n    currency: \u0026Address,\n) -\u003e BytesN\u003c32\u003e {\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    let invoice_id = client.store_invoice(\n        business,\n        \u0026amount,\n        currency,\n        \u0026due_date,\n        \u0026String::from_str(env, \"Test Invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n    invoice_id\n}\n\n/// Place a bid on an invoice\nfn place_test_bid(\n    client: \u0026QuickLendXContractClient,\n    investor: \u0026Address,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    bid_amount: i128,\n    expected_return: i128,\n) -\u003e BytesN\u003c32\u003e {\n    client.place_bid(investor, invoice_id, \u0026bid_amount, \u0026expected_return)\n}\n\n// ============================================================================\n// Test Cases\n// ============================================================================\n\n#[test]\nfn test_only_invoice_owner_can_accept_bid() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Business owner should succeed (with mock_all_auths this always succeeds)\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_ok(), \"Invoice owner should be able to accept bid\");\n    \n    // Verify bid was accepted\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n}\n\n#[test]\nfn test_only_verified_invoice_can_be_funded() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create invoice but DON'T verify it (leave in Pending status)\n    let amount = 10_000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Unverified Invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    \n    // Attempt to place bid on unverified invoice - should fail\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026amount, \u0026(amount + 1000));\n    assert!(result.is_err(), \"Should not be able to bid on unverified invoice\");\n    \n    // Verify the invoice\n    client.verify_invoice(\u0026invoice_id);\n    \n    // Now bidding should work\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026amount, \u0026(amount + 1000));\n    \n    // Accepting bid should work on verified invoice\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_ok(), \"Should be able to accept bid on verified invoice\");\n}\n\n#[test]\nfn test_funds_locked_exactly_once() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Check initial balances\n    let investor_balance_before = token_client.balance(\u0026investor);\n    let contract_balance_before = token_client.balance(\u0026contract_id);\n    \n    // Place and accept bid\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Check balances after escrow creation\n    let investor_balance_after = token_client.balance(\u0026investor);\n    let contract_balance_after = token_client.balance(\u0026contract_id);\n    \n    // Verify exact amounts transferred\n    assert_eq!(\n        investor_balance_before - investor_balance_after,\n        amount,\n        \"Investor should have paid exactly the bid amount\"\n    );\n    assert_eq!(\n        contract_balance_after - contract_balance_before,\n        amount,\n        \"Contract should hold exactly the bid amount in escrow\"\n    );\n    \n    // Verify escrow details\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow_details.amount, amount, \"Escrow should hold exact bid amount\");\n    assert_eq!(escrow_details.status, EscrowStatus::Held, \"Escrow should be in Held status\");\n    assert_eq!(escrow_details.investor, investor, \"Escrow should reference correct investor\");\n    assert_eq!(escrow_details.business, business, \"Escrow should reference correct business\");\n}\n\n#[test]\nfn test_rejects_double_accept() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Accept bid first time - should succeed\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_ok(), \"First accept should succeed\");\n    \n    // Verify invoice is now funded\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n    \n    // Attempt to accept same bid again - should fail\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_err(), \"Double accept should fail\");\n    \n    // Also verify we can't accept a different bid on same invoice\n    let investor2 = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Need to setup token for second investor\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n    let initial_balance = 100_000i128;\n    sac_client.mint(\u0026investor2, \u0026initial_balance);\n    let expiration = env.ledger().sequence() + 10_000;\n    token_client.approve(\u0026investor2, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    \n    // Try to place another bid on funded invoice\n    let result = client.try_place_bid(\u0026investor2, \u0026invoice_id, \u0026amount, \u0026(amount + 500));\n    assert!(result.is_err(), \"Should not be able to bid on funded invoice\");\n}\n\n#[test]\nfn test_accept_bid_state_transitions() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Initial state: Invoice should be Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n    \n    // Place bid\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Bid should be Placed\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Placed);\n    \n    // Accept bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // After accept: Invoice should be Funded\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n    \n    // After accept: Bid should be Accepted\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Accepted);\n    \n    // After accept: Escrow should exist and be Held\n    let escrow = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow.status, EscrowStatus::Held);\n    assert_eq!(escrow.amount, amount);\n}\n\n#[test]\nfn test_cannot_accept_withdrawn_bid() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Withdraw the bid\n    client.withdraw_bid(\u0026bid_id);\n    \n    // Verify bid is withdrawn\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Withdrawn);\n    \n    // Attempt to accept withdrawn bid - should fail\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_err(), \"Should not be able to accept withdrawn bid\");\n}\n\n#[test]\nfn test_escrow_creation_validates_amount() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice\n    let invoice_amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, invoice_amount, \u0026currency);\n    \n    // Place bid with exact amount\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, invoice_amount, invoice_amount + 1000);\n    \n    // Accept bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Verify escrow has correct amount\n    let escrow = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(\n        escrow.amount, invoice_amount,\n        \"Escrow amount should match bid amount\"\n    );\n    \n    // Verify invoice funded amount matches\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(\n        invoice.funded_amount, invoice_amount,\n        \"Invoice funded amount should match bid amount\"\n    );\n}\n\n#[test]\nfn test_multiple_bids_only_one_accepted() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor1 = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    let investor2 = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor1, \u0026contract_id);\n    \n    // Setup token for investor2\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n    let initial_balance = 100_000i128;\n    sac_client.mint(\u0026investor2, \u0026initial_balance);\n    let expiration = env.ledger().sequence() + 10_000;\n    token_client.approve(\u0026investor2, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    \n    // Create verified invoice\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Place multiple bids\n    let bid_id1 = place_test_bid(\u0026client, \u0026investor1, \u0026invoice_id, amount, amount + 1000);\n    let bid_id2 = place_test_bid(\u0026client, \u0026investor2, \u0026invoice_id, amount, amount + 500);\n    \n    // Accept first bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id1);\n    \n    // Verify first bid is accepted\n    let bid1 = client.get_bid(\u0026bid_id1).unwrap();\n    assert_eq!(bid1.status, BidStatus::Accepted);\n    \n    // Second bid should still be Placed but can't be accepted\n    let bid2 = client.get_bid(\u0026bid_id2).unwrap();\n    assert_eq!(bid2.status, BidStatus::Placed);\n    \n    // Attempt to accept second bid should fail\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id2);\n    assert!(result.is_err(), \"Should not accept second bid on funded invoice\");\n}\n\n#[test]\nfn test_token_transfer_idempotency() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    \n    // Create verified invoice\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Record balances\n    let investor_before = token_client.balance(\u0026investor);\n    let contract_before = token_client.balance(\u0026contract_id);\n    \n    // Place and accept bid\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Record balances after first accept\n    let investor_after_first = token_client.balance(\u0026investor);\n    let contract_after_first = token_client.balance(\u0026contract_id);\n    \n    // Attempt second accept (should fail)\n    let _ = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Balances should remain unchanged after failed second accept\n    let investor_after_second = token_client.balance(\u0026investor);\n    let contract_after_second = token_client.balance(\u0026contract_id);\n    \n    assert_eq!(\n        investor_after_first, investor_after_second,\n        \"Investor balance should not change on failed accept\"\n    );\n    assert_eq!(\n        contract_after_first, contract_after_second,\n        \"Contract balance should not change on failed accept\"\n    );\n    \n    // Verify amounts transferred only once\n    assert_eq!(investor_before - investor_after_first, amount);\n    assert_eq!(contract_after_first - contract_before, amount);\n}\n\n#[test]\nfn test_escrow_invariants() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Accept bid to create escrow\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Verify escrow invariants\n    let escrow = client.get_escrow_details(\u0026invoice_id);\n    \n    // Invariant 1: Escrow amount must be positive\n    assert!(escrow.amount \u003e 0, \"Escrow amount must be positive\");\n    \n    // Invariant 2: Escrow invoice_id must match\n    assert_eq!(escrow.invoice_id, invoice_id, \"Escrow invoice_id must match\");\n    \n    // Invariant 3: Escrow investor must match bid investor\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(escrow.investor, bid.investor, \"Escrow investor must match bid investor\");\n    \n    // Invariant 4: Escrow business must match invoice business\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(escrow.business, invoice.business, \"Escrow business must match invoice business\");\n    \n    // Invariant 5: Escrow status must be Held after creation\n    assert_eq!(escrow.status, EscrowStatus::Held, \"Escrow status must be Held after creation\");\n    \n    // Invariant 6: Created timestamp must be set (\u003e= 0)\n    assert!(\n        escrow.created_at \u003c= env.ledger().timestamp(),\n        \"Escrow created_at cannot be in future\"\n    );\n}\n","traces":[{"line":30,"address":[14428865,14428859,14428112],"length":1,"stats":{"Line":0}},{"line":31,"address":[14428128],"length":1,"stats":{"Line":0}},{"line":32,"address":[14428168],"length":1,"stats":{"Line":0}},{"line":33,"address":[14428230],"length":1,"stats":{"Line":0}},{"line":34,"address":[14428252],"length":1,"stats":{"Line":0}},{"line":35,"address":[14428297],"length":1,"stats":{"Line":0}},{"line":36,"address":[14428368],"length":1,"stats":{"Line":0}},{"line":37,"address":[14428420],"length":1,"stats":{"Line":0}},{"line":41,"address":[14403920,14404831,14404856],"length":1,"stats":{"Line":0}},{"line":42,"address":[14403989],"length":1,"stats":{"Line":0}},{"line":44,"address":[14404082,14404029],"length":1,"stats":{"Line":0}},{"line":47,"address":[14404247],"length":1,"stats":{"Line":0}},{"line":48,"address":[14404276],"length":1,"stats":{"Line":0}},{"line":51,"address":[14404346],"length":1,"stats":{"Line":0}},{"line":52,"address":[14404370],"length":1,"stats":{"Line":0}},{"line":53,"address":[14404443],"length":1,"stats":{"Line":0}},{"line":56,"address":[14404483],"length":1,"stats":{"Line":0}},{"line":57,"address":[14404636],"length":1,"stats":{"Line":0}},{"line":58,"address":[14404681],"length":1,"stats":{"Line":0}},{"line":60,"address":[14404721],"length":1,"stats":{"Line":0}},{"line":64,"address":[14408016,14408287,14408293],"length":1,"stats":{"Line":0}},{"line":65,"address":[14408072],"length":1,"stats":{"Line":0}},{"line":66,"address":[14408091,14408171],"length":1,"stats":{"Line":0}},{"line":67,"address":[14408247],"length":1,"stats":{"Line":0}},{"line":68,"address":[14408259],"length":1,"stats":{"Line":0}},{"line":72,"address":[14408585,14408591,14408320],"length":1,"stats":{"Line":0}},{"line":73,"address":[14408372],"length":1,"stats":{"Line":0}},{"line":74,"address":[14408391,14408470],"length":1,"stats":{"Line":0}},{"line":75,"address":[14408545],"length":1,"stats":{"Line":0}},{"line":76,"address":[14408557],"length":1,"stats":{"Line":0}},{"line":80,"address":[14407376,14407995,14408001],"length":1,"stats":{"Line":0}},{"line":87,"address":[14407634,14407465],"length":1,"stats":{"Line":0}},{"line":88,"address":[14407713],"length":1,"stats":{"Line":0}},{"line":93,"address":[14407585],"length":1,"stats":{"Line":0}},{"line":95,"address":[14407615],"length":1,"stats":{"Line":0}},{"line":97,"address":[14407952],"length":1,"stats":{"Line":0}},{"line":98,"address":[14407964],"length":1,"stats":{"Line":0}},{"line":102,"address":[14404880],"length":1,"stats":{"Line":0}},{"line":109,"address":[14404927],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":39},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_fees.rs"],"content":"use super::*;\nuse crate::fees::FeeType;\nuse soroban_sdk::{testutils::Address as _, Address, Env, Map, String};\n\n/// Helper function to set up admin for testing\nfn setup_admin(env: \u0026Env, client: \u0026QuickLendXContractClient) -\u003e Address {\n    let admin = Address::generate(env);\n    client.set_admin(\u0026admin);\n    admin\n}\n\n/// Helper function to create and verify a business\nfn setup_business(env: \u0026Env, client: \u0026QuickLendXContractClient, admin: \u0026Address) -\u003e Address {\n    let business = Address::generate(env);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(env, \"Business KYC\"));\n    client.verify_business(admin, \u0026business);\n    business\n}\n\n/// Helper function to create and verify an investor\nfn setup_investor(env: \u0026Env, client: \u0026QuickLendXContractClient, admin: \u0026Address) -\u003e Address {\n    let investor = Address::generate(env);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(env, \"Investor KYC\"));\n    client.verify_investor(\u0026investor, \u00261_000_000); // 1000 XLM limit\n    investor\n}\n\n/// Simple test to verify the module is loaded\n#[test]\nfn test_module_loaded() {\n    assert_eq!(2 + 2, 4);\n}\n\n/// Test default platform fee configuration (2%)\n#[test]\nfn test_default_platform_fee() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Get default platform fee config\n    let fee_config = client.get_platform_fee();\n    assert_eq!(fee_config.fee_bps, 200); // 2%\n    assert_eq!(fee_config.updated_at, 0); // Not updated yet\n}\n\n/// Test custom platform fee BPS configuration\n#[test]\nfn test_custom_platform_fee_bps() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Test setting custom fee BPS\n    let new_fee_bps = 500; // 5%\n    client.set_platform_fee(\u0026new_fee_bps);\n\n    let updated_config = client.get_platform_fee();\n    assert_eq!(updated_config.fee_bps, new_fee_bps);\n    assert_eq!(updated_config.updated_by, admin);\n}\n\n/// Test that only admin can update platform fee configuration\n#[test]\nfn test_only_admin_can_update_platform_fee() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Test invalid fee (too high) - this should fail\n    let result = client.try_set_platform_fee(\u00261200);\n    assert!(result.is_err());\n\n    // Admin should be able to update fee with valid value\n    client.set_platform_fee(\u0026300);\n}\n\n/// Test platform fee calculation accuracy\n#[test]\nfn test_platform_fee_calculation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Test default 2% fee calculation\n    let investment_amount = 1000; // 1000 units\n    let payment_amount = 1100; // 1100 units (100 profit)\n\n    let (investor_return, platform_fee) =\n        client.calculate_profit(\u0026investment_amount, \u0026payment_amount);\n\n    // Expected: 2% of profit (100) = 2 units\n    assert_eq!(platform_fee, 2);\n    assert_eq!(investor_return, 1098); // 1100 - 2\n\n    // Test with custom fee\n    let admin = setup_admin(\u0026env, \u0026client);\n    client.set_platform_fee(\u0026500); // 5%\n\n    let (investor_return, platform_fee) =\n        client.calculate_profit(\u0026investment_amount, \u0026payment_amount);\n\n    // Expected: 5% of profit (100) = 5 units\n    assert_eq!(platform_fee, 5);\n    assert_eq!(investor_return, 1095); // 1100 - 5\n}\n\n/// Test fee calculation edge cases\n#[test]\nfn test_platform_fee_edge_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Test case: no profit (payment \u003c= investment)\n    let investment_amount = 1000;\n    let payment_amount = 900; // Loss\n\n    let (investor_return, platform_fee) =\n        client.calculate_profit(\u0026investment_amount, \u0026payment_amount);\n\n    assert_eq!(platform_fee, 0);\n    assert_eq!(investor_return, 900);\n\n    // Test case: zero payment\n    let (investor_return, platform_fee) = client.calculate_profit(\u0026investment_amount, \u00260);\n\n    assert_eq!(platform_fee, 0);\n    assert_eq!(investor_return, 0);\n}\n\n/// Test fee initialization\n#[test]\nfn test_fee_system_initialization() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Verify fee structures are initialized\n    let platform_fee = client.get_fee_structure(\u0026FeeType::Platform);\n    assert_eq!(platform_fee.base_fee_bps, 200); // 2%\n    assert!(platform_fee.is_active);\n}\n\n/// Test fee structure updates\n#[test]\nfn test_fee_structure_updates() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Update platform fee structure\n    client.update_fee_structure(\n        \u0026admin,\n        \u0026FeeType::Platform,\n        \u0026300,  // 3%\n        \u002650,   // min fee\n        \u00265000, // max fee\n        \u0026true, // active\n    );\n\n    // Verify update\n    let updated_fee = client.get_fee_structure(\u0026FeeType::Platform);\n    assert_eq!(updated_fee.base_fee_bps, 300);\n    assert_eq!(updated_fee.min_fee, 50);\n    assert_eq!(updated_fee.max_fee, 5000);\n    assert!(updated_fee.is_active);\n}\n\n/// Test only admin can update fee structures\n#[test]\nfn test_only_admin_can_update_fee_structure() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let non_admin = Address::generate(\u0026env);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Non-admin should not be able to update (this would require a try_ method which doesn't exist)\n    // For now, we'll just test that admin can update successfully\n    client.update_fee_structure(\u0026admin, \u0026FeeType::Platform, \u0026400, \u002650, \u00265000, \u0026true);\n}\n\n/// Test transaction fee calculation\n#[test]\nfn test_transaction_fee_calculation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    let transaction_amount = 10_000; // 10,000 units\n\n    // Calculate fees for standard transaction\n    let total_fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026false, // not early payment\n        \u0026false, // not late payment\n    );\n\n    // Platform fee should be 2% of 10,000 = 200\n    // Processing fee should be 0.5% of 10,000 = 50\n    // Verification fee should be 1% of 10,000 = 100\n    // Total: 350\n    assert_eq!(total_fees, 350);\n}\n\n/// Test volume tier discounts\n#[test]\nfn test_volume_tier_discounts() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Get initial volume data (should be Standard tier)\n    let volume_data = client.get_user_volume_data(\u0026user);\n    assert_eq!(volume_data.current_tier, crate::fees::VolumeTier::Standard);\n\n    // Simulate high volume to reach Gold tier\n    for _ in 0..6 {\n        client.update_user_transaction_volume(\u0026user, \u0026100_000_000_000); // 100k XLM\n    }\n\n    let volume_data = client.get_user_volume_data(\u0026user);\n    assert_eq!(volume_data.current_tier, crate::fees::VolumeTier::Gold);\n\n    // Calculate fees - should get 10% discount\n    let transaction_amount = 10_000;\n    let total_fees = client.calculate_transaction_fees(\u0026user, \u0026transaction_amount, \u0026false, \u0026false);\n\n    // Standard fee would be 350, Gold tier gets 10% discount = 315\n    assert_eq!(total_fees, 315);\n}\n\n/// Test early payment discounts\n#[test]\nfn test_early_payment_discounts() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    let transaction_amount = 10_000;\n\n    // Calculate fees for early payment\n    let early_payment_fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026true, // early payment\n        \u0026false,\n    );\n\n    // Calculate fees for regular payment\n    let regular_fees =\n        client.calculate_transaction_fees(\u0026user, \u0026transaction_amount, \u0026false, \u0026false);\n\n    // Early payment should have lower fees\n    assert!(early_payment_fees \u003c regular_fees);\n}\n\n/// Test late payment penalties\n#[test]\nfn test_late_payment_penalties() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Add LatePayment fee structure for testing penalties\n    client.update_fee_structure(\n        \u0026admin,\n        \u0026FeeType::LatePayment,\n        \u0026100,  // 1%\n        \u002650,   // min fee\n        \u00261000, // max fee\n        \u0026true, // active\n    );\n\n    let transaction_amount = 10_000;\n\n    // Calculate fees for late payment\n    let late_payment_fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026false,\n        \u0026true, // late payment\n    );\n\n    // Calculate fees for regular payment\n    let regular_fees =\n        client.calculate_transaction_fees(\u0026user, \u0026transaction_amount, \u0026false, \u0026false);\n\n    // Late payment should have higher fees\n    assert!(late_payment_fees \u003e regular_fees);\n}\n\n/// Test revenue distribution configuration\n#[test]\nfn test_revenue_distribution_config() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let treasury = Address::generate(\u0026env);\n\n    // Configure revenue distribution\n    client.configure_revenue_distribution(\n        \u0026admin, \u0026treasury, \u00265000, // 50% treasury\n        \u00263000, // 30% developer\n        \u00262000, // 20% platform\n        \u0026true, // auto distribution\n        \u00261000, // min distribution amount\n    );\n}\n\n/// Test revenue distribution execution\n#[test]\nfn test_revenue_distribution_execution() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n    let treasury = Address::generate(\u0026env);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Configure revenue distribution\n    client.configure_revenue_distribution(\n        \u0026admin, \u0026treasury, \u00266000,  // 60% treasury\n        \u00262000,  // 20% developer\n        \u00262000,  // 20% platform\n        \u0026false, // manual distribution\n        \u0026100,   // min distribution amount\n    );\n\n    // Collect some fees\n    let mut fees_by_type = Map::new(\u0026env);\n    fees_by_type.set(FeeType::Platform, 200);\n    fees_by_type.set(FeeType::Processing, 50);\n\n    client.collect_transaction_fees(\u0026user, \u0026fees_by_type, \u0026250);\n\n    // Get current period\n    let current_period = env.ledger().timestamp() / 2_592_000; // Weeks\n\n    // Distribute revenue\n    let (treasury_amount, developer_amount, platform_amount) =\n        client.distribute_revenue(\u0026admin, \u0026current_period);\n\n    // Verify distribution: 250 total * 60% = 150 treasury\n    assert_eq!(treasury_amount, 150);\n    assert_eq!(developer_amount, 50); // 250 * 20%\n    assert_eq!(platform_amount, 50); // 250 * 20%\n}\n\n/// Test fee analytics\n#[test]\nfn test_fee_analytics() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Collect some fees\n    let mut fees_by_type = Map::new(\u0026env);\n    fees_by_type.set(FeeType::Platform, 200);\n\n    client.collect_transaction_fees(\u0026user, \u0026fees_by_type, \u0026200);\n\n    // Get current period\n    let current_period = env.ledger().timestamp() / 2_592_000;\n\n    // Get analytics\n    let analytics = client.get_fee_analytics(\u0026current_period);\n    assert_eq!(analytics.total_fees, 200);\n    assert_eq!(analytics.total_transactions, 1);\n}\n\n/// Test fee parameter validation\n#[test]\nfn test_fee_parameter_validation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Test valid parameters\n    client.validate_fee_parameters(\u0026200, \u002610, \u00261000);\n\n    // Test invalid base fee BPS (too high) - this would need a try_ method\n    // For now, we'll just test the valid case\n    // let result = client.validate_fee_parameters(\u00261500, \u002610, \u00261000);\n    // assert!(result.is_err());\n\n    // Test invalid min/max fees - this would need a try_ method\n    // let result = client.validate_fee_parameters(\u0026200, \u00261000, \u0026500);\n    // assert!(result.is_err()); // min \u003e max\n}\n\n/// Test treasury receives exact amount in distribution\n#[test]\nfn test_treasury_receives_exact_amount() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n    let treasury = Address::generate(\u0026env);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Configure revenue distribution with 70% to treasury\n    client.configure_revenue_distribution(\n        \u0026admin, \u0026treasury, \u00267000, // 70% treasury\n        \u00262000, // 20% developer\n        \u00261000, // 10% platform\n        \u0026false, \u0026100,\n    );\n\n    // Collect fees\n    let mut fees_by_type = Map::new(\u0026env);\n    fees_by_type.set(FeeType::Platform, 1000);\n\n    client.collect_transaction_fees(\u0026user, \u0026fees_by_type, \u00261000);\n\n    // Get current period\n    let current_period = env.ledger().timestamp() / 2_592_000;\n\n    // Distribute revenue\n    let (treasury_amount, _, _) = client.distribute_revenue(\u0026admin, \u0026current_period);\n\n    // Treasury should receive exactly 70% of 1000 = 700\n    assert_eq!(treasury_amount, 700);\n}\n\n/// Test comprehensive fee calculation with all factors\n#[test]\nfn test_comprehensive_fee_calculation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Build up user volume to Platinum tier (15% discount)\n    for _ in 0..20 {\n        client.update_user_transaction_volume(\u0026user, \u0026500_000_000_000); // 500k XLM\n    }\n\n    let volume_data = client.get_user_volume_data(\u0026user);\n    assert_eq!(volume_data.current_tier, crate::fees::VolumeTier::Platinum);\n\n    let transaction_amount = 50_000;\n\n    // Test early payment with Platinum tier discount\n    let fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026true, // early payment\n        \u0026false,\n    );\n\n    // Calculate expected fees:\n    // Platform: 2% of 50k = 1000, minus tier discount (15%) = 850, minus early payment (10%) = 765\n    // Processing: 0.5% = 250, minus tier discount (15%) = 212.5 -\u003e 213\n    // Verification: 1% = 500, minus tier discount (15%) = 425\n    // Total: 765 + 213 + 425 = 1403\n\n    assert_eq!(fees, 1403);\n}\n","traces":[{"line":6,"address":[13825312,13825439,13825445],"length":1,"stats":{"Line":0}},{"line":7,"address":[13825341],"length":1,"stats":{"Line":0}},{"line":8,"address":[13825370],"length":1,"stats":{"Line":0}},{"line":9,"address":[13825414],"length":1,"stats":{"Line":0}},{"line":13,"address":[13825456,13825733,13825727],"length":1,"stats":{"Line":0}},{"line":14,"address":[13825512],"length":1,"stats":{"Line":0}},{"line":15,"address":[13825611,13825531],"length":1,"stats":{"Line":0}},{"line":16,"address":[13825687],"length":1,"stats":{"Line":0}},{"line":17,"address":[13825699],"length":1,"stats":{"Line":0}},{"line":21,"address":[13825760,13826025,13826031],"length":1,"stats":{"Line":0}},{"line":22,"address":[13825810],"length":1,"stats":{"Line":0}},{"line":23,"address":[13825908,13825829],"length":1,"stats":{"Line":0}},{"line":24,"address":[13825973],"length":1,"stats":{"Line":0}},{"line":25,"address":[13825997],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_partial_payments.rs"],"content":"use soroban_sdk::{testutils::{Address as _}, Address, String, Vec, Env, vec, token};\nuse crate::{QuickLendXContract, QuickLendXContractClient};\nuse crate::invoice::{InvoiceCategory, InvoiceStatus};\n\n/// Test partial payment tracking, cumulative totals, and full settlement detection\npub fn test_partial_payments_comprehensive() {\n    let env = Env::default();\n    env.mock_all_auths();\n\n    // Register the contract\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    // Set up token contract\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    // Mint tokens and set up approvals\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\"));\n    client.verify_business(\u0026admin, \u0026business);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\"));\n    client.verify_investor(\u0026investor, \u002610000);\n\n    // Test Case 1: Single partial payment\n    let invoice_id_1 = client.store_invoice(\n        \u0026business,\n        \u00261000, // $10.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice 1 - partial payment\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    // Verify and fund invoice 1\n    client.verify_invoice(\u0026invoice_id_1);\n    let bid_id_1 = client.place_bid(\u0026investor, \u0026invoice_id_1, \u00261000, \u00261050);\n    client.accept_bid(\u0026invoice_id_1, \u0026bid_id_1);\n\n    // Single partial payment\n    let tx1 = String::from_str(\u0026env, \"partial-tx-1\");\n    client.process_partial_payment(\u0026invoice_id_1, \u0026400, \u0026tx1);\n\n    // Verify payment tracking\n    let invoice = client.get_invoice(\u0026invoice_id_1);\n    assert_eq!(invoice.total_paid, 400);\n    assert_eq!(invoice.payment_history.len(), 1);\n    assert_eq!(invoice.payment_progress(), 40);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n\n    // Test Case 2: Multiple partial payments\n    let invoice_id_2 = client.store_invoice(\n        \u0026business,\n        \u00262000, // $20.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice 2 - multiple payments\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    // Verify and fund invoice 2\n    client.verify_invoice(\u0026invoice_id_2);\n    let bid_id_2 = client.place_bid(\u0026investor, \u0026invoice_id_2, \u00262000, \u00262100);\n    client.accept_bid(\u0026invoice_id_2, \u0026bid_id_2);\n\n    // Multiple partial payments\n    let tx2_1 = String::from_str(\u0026env, \"partial-tx-2-1\");\n    client.process_partial_payment(\u0026invoice_id_2, \u0026500, \u0026tx2_1);\n\n    let tx2_2 = String::from_str(\u0026env, \"partial-tx-2-2\");\n    client.process_partial_payment(\u0026invoice_id_2, \u0026800, \u0026tx2_2);\n\n    let tx2_3 = String::from_str(\u0026env, \"partial-tx-2-3\");\n    client.process_partial_payment(\u0026invoice_id_2, \u0026700, \u0026tx2_3);\n\n    // Verify cumulative totals and settlement\n    let invoice = client.get_invoice(\u0026invoice_id_2);\n    assert_eq!(invoice.total_paid, 2000);\n    assert_eq!(invoice.payment_history.len(), 3);\n    assert_eq!(invoice.payment_progress(), 100);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert!(invoice.is_fully_paid());\n\n    // Test Case 3: Overpayment handling\n    let invoice_id_3 = client.store_invoice(\n        \u0026business,\n        \u00261500, // $15.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice 3 - overpayment\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    // Verify and fund invoice 3\n    client.verify_invoice(\u0026invoice_id_3);\n    let bid_id_3 = client.place_bid(\u0026investor, \u0026invoice_id_3, \u00261500, \u00261575);\n    client.accept_bid(\u0026invoice_id_3, \u0026bid_id_3);\n\n    // Overpayment - pay more than invoice amount\n    let tx3 = String::from_str(\u0026env, \"overpayment-tx-3\");\n    client.process_partial_payment(\u0026invoice_id_3, \u00261800, \u0026tx3);\n\n    // Verify overpayment handling\n    let invoice = client.get_invoice(\u0026invoice_id_3);\n    assert_eq!(invoice.total_paid, 1800);\n    assert_eq!(invoice.payment_history.len(), 1);\n    assert_eq!(invoice.payment_progress(), 100);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert!(invoice.is_fully_paid());\n\n    // Test Case 4: Payment history integrity\n    // Check that payment records are properly stored\n    let invoice = client.get_invoice(\u0026invoice_id_2);\n\n    // Verify cumulative total matches sum of records\n    let mut calculated_total = 0i128;\n    for record in invoice.payment_history.iter() {\n        calculated_total = calculated_total.saturating_add(record.amount);\n    }\n    assert_eq!(calculated_total, invoice.total_paid);\n\n    // Verify transaction IDs are unique and properly stored\n    let mut tx_ids = Vec::new(\u0026env);\n    for record in invoice.payment_history.iter() {\n        assert!(!tx_ids.contains(\u0026record.transaction_id));\n        tx_ids.push_back(record.transaction_id.clone());\n    }\n}\n\n/// Test settlement edge cases and validation\npub fn test_settlement_edge_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    // Set up token contract\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    // Mint tokens and set up approvals\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"KYC\"));\n    client.verify_investor(\u0026investor, \u002610000);\n\n    // Test settlement with exact amount\n    let invoice_id_exact = client.store_invoice(\n        \u0026business, \u00261000, \u0026currency, \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Exact settlement\"), \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    client.verify_invoice(\u0026invoice_id_exact);\n    let bid_id_exact = client.place_bid(\u0026investor, \u0026invoice_id_exact, \u00261000, \u00261050);\n    client.accept_bid(\u0026invoice_id_exact, \u0026bid_id_exact);\n\n    client.settle_invoice(\u0026invoice_id_exact, \u00261000);\n\n    let invoice = client.get_invoice(\u0026invoice_id_exact);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert_eq!(invoice.total_paid, 1000);\n    assert!(invoice.is_fully_paid());\n\n    // Test settlement with overpayment\n    let invoice_id_over = client.store_invoice(\n        \u0026business, \u0026800, \u0026currency, \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Over settlement\"), \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    client.verify_invoice(\u0026invoice_id_over);\n    let bid_id_over = client.place_bid(\u0026investor, \u0026invoice_id_over, \u0026800, \u0026840);\n    client.accept_bid(\u0026invoice_id_over, \u0026bid_id_over);\n\n    client.settle_invoice(\u0026invoice_id_over, \u00261000);\n\n    let invoice = client.get_invoice(\u0026invoice_id_over);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert_eq!(invoice.total_paid, 1000);\n    assert!(invoice.is_fully_paid());\n\n    // Test settlement validation errors - skipped as Soroban panics on invalid inputs\n    let invoice_id_invalid = client.store_invoice(\n        \u0026business, \u0026500, \u0026currency, \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invalid settlement\"), \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    client.verify_invoice(\u0026invoice_id_invalid);\n    // Note: Invalid settlement operations would panic in Soroban\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_partial_payments_validation() {\n        test_partial_payments_comprehensive();\n    }\n\n    #[test]\n    fn test_settlement_validation() {\n        test_settlement_edge_cases();\n    }\n}\n","traces":[{"line":6,"address":[13857881,13857791,13850400],"length":1,"stats":{"Line":1}},{"line":7,"address":[13850422],"length":1,"stats":{"Line":1}},{"line":8,"address":[13850455],"length":1,"stats":{"Line":1}},{"line":11,"address":[13850526],"length":1,"stats":{"Line":1}},{"line":12,"address":[13850557],"length":1,"stats":{"Line":1}},{"line":14,"address":[13850605],"length":1,"stats":{"Line":1}},{"line":15,"address":[13850669],"length":1,"stats":{"Line":1}},{"line":16,"address":[13850737],"length":1,"stats":{"Line":1}},{"line":17,"address":[13850805],"length":1,"stats":{"Line":1}},{"line":21,"address":[13850937,13850889],"length":1,"stats":{"Line":2}},{"line":23,"address":[13851103],"length":1,"stats":{"Line":1}},{"line":24,"address":[13851138],"length":1,"stats":{"Line":1}},{"line":27,"address":[13851217],"length":1,"stats":{"Line":1}},{"line":28,"address":[13851241],"length":1,"stats":{"Line":1}},{"line":29,"address":[13851317],"length":1,"stats":{"Line":1}},{"line":31,"address":[13851368],"length":1,"stats":{"Line":1}},{"line":32,"address":[13851523],"length":1,"stats":{"Line":1}},{"line":33,"address":[13851574],"length":1,"stats":{"Line":1}},{"line":35,"address":[13851641],"length":1,"stats":{"Line":1}},{"line":38,"address":[13851821],"length":1,"stats":{"Line":1}},{"line":39,"address":[13851828],"length":1,"stats":{"Line":1}},{"line":40,"address":[13851981],"length":1,"stats":{"Line":1}},{"line":41,"address":[13851988],"length":1,"stats":{"Line":1}},{"line":42,"address":[13852117],"length":1,"stats":{"Line":1}},{"line":45,"address":[13852340],"length":1,"stats":{"Line":1}},{"line":50,"address":[13852147],"length":1,"stats":{"Line":1}},{"line":52,"address":[13852261,13852182],"length":1,"stats":{"Line":2}},{"line":56,"address":[13852614],"length":1,"stats":{"Line":1}},{"line":57,"address":[13852621],"length":1,"stats":{"Line":1}},{"line":58,"address":[13852698],"length":1,"stats":{"Line":1}},{"line":61,"address":[13852749],"length":1,"stats":{"Line":1}},{"line":62,"address":[13852784],"length":1,"stats":{"Line":1}},{"line":65,"address":[13852890],"length":1,"stats":{"Line":1}},{"line":66,"address":[13852897],"length":1,"stats":{"Line":1}},{"line":67,"address":[13853012,13853081],"length":1,"stats":{"Line":2}},{"line":68,"address":[13853190],"length":1,"stats":{"Line":1}},{"line":69,"address":[13853312],"length":1,"stats":{"Line":1}},{"line":72,"address":[13853615],"length":1,"stats":{"Line":1}},{"line":77,"address":[13853422],"length":1,"stats":{"Line":1}},{"line":79,"address":[13853536,13853457],"length":1,"stats":{"Line":2}},{"line":83,"address":[13853889],"length":1,"stats":{"Line":1}},{"line":84,"address":[13853896],"length":1,"stats":{"Line":1}},{"line":85,"address":[13853973],"length":1,"stats":{"Line":1}},{"line":88,"address":[13854024],"length":1,"stats":{"Line":1}},{"line":89,"address":[13854059],"length":1,"stats":{"Line":1}},{"line":91,"address":[13854141],"length":1,"stats":{"Line":1}},{"line":92,"address":[13854176],"length":1,"stats":{"Line":1}},{"line":94,"address":[13854258],"length":1,"stats":{"Line":1}},{"line":95,"address":[13854293],"length":1,"stats":{"Line":1}},{"line":98,"address":[13854399],"length":1,"stats":{"Line":1}},{"line":99,"address":[13854406],"length":1,"stats":{"Line":1}},{"line":100,"address":[13854521,13854590],"length":1,"stats":{"Line":2}},{"line":101,"address":[13854699],"length":1,"stats":{"Line":1}},{"line":102,"address":[13854821],"length":1,"stats":{"Line":1}},{"line":103,"address":[13854927],"length":1,"stats":{"Line":1}},{"line":106,"address":[13855174],"length":1,"stats":{"Line":1}},{"line":111,"address":[13854981],"length":1,"stats":{"Line":1}},{"line":113,"address":[13855095,13855016],"length":1,"stats":{"Line":2}},{"line":117,"address":[13855448],"length":1,"stats":{"Line":1}},{"line":118,"address":[13855455],"length":1,"stats":{"Line":1}},{"line":119,"address":[13855532],"length":1,"stats":{"Line":1}},{"line":122,"address":[13855583],"length":1,"stats":{"Line":1}},{"line":123,"address":[13855618],"length":1,"stats":{"Line":1}},{"line":126,"address":[13855724],"length":1,"stats":{"Line":1}},{"line":127,"address":[13855731],"length":1,"stats":{"Line":1}},{"line":128,"address":[13855840,13855903],"length":1,"stats":{"Line":2}},{"line":129,"address":[13856012],"length":1,"stats":{"Line":1}},{"line":130,"address":[13856128],"length":1,"stats":{"Line":1}},{"line":131,"address":[13856234],"length":1,"stats":{"Line":1}},{"line":135,"address":[13856312],"length":1,"stats":{"Line":1}},{"line":138,"address":[13856319],"length":1,"stats":{"Line":1}},{"line":139,"address":[13856515,13856343,13856422],"length":1,"stats":{"Line":3}},{"line":140,"address":[13856626,13857847],"length":1,"stats":{"Line":2}},{"line":142,"address":[13856693],"length":1,"stats":{"Line":1}},{"line":145,"address":[13856805],"length":1,"stats":{"Line":1}},{"line":146,"address":[13856832,13856915,13857011],"length":1,"stats":{"Line":3}},{"line":147,"address":[13857713,13857684,13857118],"length":1,"stats":{"Line":2}},{"line":148,"address":[13857746,13857690],"length":1,"stats":{"Line":2}},{"line":153,"address":[13846000,13850368,13850374],"length":1,"stats":{"Line":1}},{"line":154,"address":[13846019],"length":1,"stats":{"Line":1}},{"line":155,"address":[13846043],"length":1,"stats":{"Line":1}},{"line":157,"address":[13846108],"length":1,"stats":{"Line":1}},{"line":158,"address":[13846136],"length":1,"stats":{"Line":1}},{"line":160,"address":[13846184],"length":1,"stats":{"Line":1}},{"line":161,"address":[13846245],"length":1,"stats":{"Line":1}},{"line":162,"address":[13846310],"length":1,"stats":{"Line":1}},{"line":163,"address":[13846375],"length":1,"stats":{"Line":1}},{"line":167,"address":[13846504,13846456],"length":1,"stats":{"Line":2}},{"line":169,"address":[13846667],"length":1,"stats":{"Line":1}},{"line":170,"address":[13846699],"length":1,"stats":{"Line":1}},{"line":173,"address":[13846772],"length":1,"stats":{"Line":1}},{"line":174,"address":[13846796],"length":1,"stats":{"Line":1}},{"line":175,"address":[13846872],"length":1,"stats":{"Line":1}},{"line":177,"address":[13846920],"length":1,"stats":{"Line":1}},{"line":178,"address":[13847063],"length":1,"stats":{"Line":1}},{"line":179,"address":[13847114],"length":1,"stats":{"Line":1}},{"line":181,"address":[13847178],"length":1,"stats":{"Line":1}},{"line":184,"address":[13847346],"length":1,"stats":{"Line":1}},{"line":185,"address":[13847353],"length":1,"stats":{"Line":1}},{"line":186,"address":[13847503],"length":1,"stats":{"Line":1}},{"line":187,"address":[13847510],"length":1,"stats":{"Line":1}},{"line":188,"address":[13847636],"length":1,"stats":{"Line":1}},{"line":191,"address":[13847850],"length":1,"stats":{"Line":1}},{"line":193,"address":[13847666],"length":1,"stats":{"Line":1}},{"line":194,"address":[13847698,13847774],"length":1,"stats":{"Line":2}},{"line":197,"address":[13848124],"length":1,"stats":{"Line":1}},{"line":198,"address":[13848131],"length":1,"stats":{"Line":1}},{"line":199,"address":[13848208],"length":1,"stats":{"Line":1}},{"line":201,"address":[13848259],"length":1,"stats":{"Line":1}},{"line":203,"address":[13848313],"length":1,"stats":{"Line":1}},{"line":204,"address":[13848411,13848320],"length":1,"stats":{"Line":2}},{"line":205,"address":[13848458],"length":1,"stats":{"Line":1}},{"line":206,"address":[13848575],"length":1,"stats":{"Line":1}},{"line":209,"address":[13848813],"length":1,"stats":{"Line":1}},{"line":211,"address":[13848629],"length":1,"stats":{"Line":1}},{"line":212,"address":[13848661,13848737],"length":1,"stats":{"Line":2}},{"line":215,"address":[13849087],"length":1,"stats":{"Line":1}},{"line":216,"address":[13849094],"length":1,"stats":{"Line":1}},{"line":217,"address":[13849171],"length":1,"stats":{"Line":1}},{"line":219,"address":[13849222],"length":1,"stats":{"Line":1}},{"line":221,"address":[13849276],"length":1,"stats":{"Line":1}},{"line":222,"address":[13849374,13849283],"length":1,"stats":{"Line":2}},{"line":223,"address":[13849421],"length":1,"stats":{"Line":1}},{"line":224,"address":[13849538],"length":1,"stats":{"Line":1}},{"line":227,"address":[13849776],"length":1,"stats":{"Line":1}},{"line":229,"address":[13849592],"length":1,"stats":{"Line":1}},{"line":230,"address":[13849624,13849700],"length":1,"stats":{"Line":2}},{"line":233,"address":[13850050],"length":1,"stats":{"Line":1}}],"covered":128,"coverable":128},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","verification.rs"],"content":"use crate::bid::{BidStatus, BidStorage};\nuse crate::errors::QuickLendXError;\nuse crate::invoice::{Invoice, InvoiceMetadata};\nuse soroban_sdk::{contracttype, symbol_short, vec, Address, Env, String, Vec};\n\n#[contracttype]\npub enum BusinessVerificationStatus {\n    Pending,\n    Verified,\n    Rejected,\n}\n\n#[contracttype]\npub struct BusinessVerification {\n    pub business: Address,\n    pub status: BusinessVerificationStatus,\n    pub verified_at: Option\u003cu64\u003e,\n    pub verified_by: Option\u003cAddress\u003e,\n    pub kyc_data: String, // Encrypted KYC data\n    pub submitted_at: u64,\n    pub rejection_reason: Option\u003cString\u003e,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, PartialEq)]\npub enum InvestorTier {\n    Basic,\n    Silver,\n    Gold,\n    Platinum,\n    VIP,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, PartialEq)]\npub enum InvestorRiskLevel {\n    Low,\n    Medium,\n    High,\n    VeryHigh,\n}\n\n#[contracttype]\npub struct InvestorVerification {\n    pub investor: Address,\n    pub status: BusinessVerificationStatus,\n    pub verified_at: Option\u003cu64\u003e,\n    pub verified_by: Option\u003cAddress\u003e,\n    pub kyc_data: String,\n    pub investment_limit: i128,\n    pub submitted_at: u64,\n    pub tier: InvestorTier,\n    pub risk_level: InvestorRiskLevel,\n    pub risk_score: u32,\n    pub total_invested: i128,\n    pub total_returns: i128,\n    pub successful_investments: u32,\n    pub defaulted_investments: u32,\n    pub last_activity: u64,\n    pub rejection_reason: Option\u003cString\u003e,\n    pub compliance_notes: Option\u003cString\u003e,\n}\n\nconst MIN_BID_AMOUNT: i128 = 100;\n\npub struct BusinessVerificationStorage;\n\nimpl BusinessVerificationStorage {\n    const VERIFIED_BUSINESSES_KEY: \u0026'static str = \"verified_businesses\";\n    const PENDING_BUSINESSES_KEY: \u0026'static str = \"pending_businesses\";\n    const REJECTED_BUSINESSES_KEY: \u0026'static str = \"rejected_businesses\";\n    const ADMIN_KEY: \u0026'static str = \"admin_address\";\n\n    pub fn store_verification(env: \u0026Env, verification: \u0026BusinessVerification) {\n        env.storage()\n            .instance()\n            .set(\u0026verification.business, verification);\n\n        // Add to status-specific lists\n        match verification.status {\n            BusinessVerificationStatus::Verified =\u003e {\n                Self::add_to_verified_businesses(env, \u0026verification.business);\n            }\n            BusinessVerificationStatus::Pending =\u003e {\n                Self::add_to_pending_businesses(env, \u0026verification.business);\n            }\n            BusinessVerificationStatus::Rejected =\u003e {\n                Self::add_to_rejected_businesses(env, \u0026verification.business);\n            }\n        }\n    }\n\n    pub fn get_verification(env: \u0026Env, business: \u0026Address) -\u003e Option\u003cBusinessVerification\u003e {\n        env.storage().instance().get(business)\n    }\n\n    pub fn update_verification(env: \u0026Env, verification: \u0026BusinessVerification) {\n        let old_verification = Self::get_verification(env, \u0026verification.business);\n\n        // Remove from old status list\n        if let Some(old_ver) = old_verification {\n            match old_ver.status {\n                BusinessVerificationStatus::Verified =\u003e {\n                    Self::remove_from_verified_businesses(env, \u0026verification.business);\n                }\n                BusinessVerificationStatus::Pending =\u003e {\n                    Self::remove_from_pending_businesses(env, \u0026verification.business);\n                }\n                BusinessVerificationStatus::Rejected =\u003e {\n                    Self::remove_from_rejected_businesses(env, \u0026verification.business);\n                }\n            }\n        }\n\n        // Store new verification\n        Self::store_verification(env, verification);\n    }\n\n    pub fn is_business_verified(env: \u0026Env, business: \u0026Address) -\u003e bool {\n        if let Some(verification) = Self::get_verification(env, business) {\n            matches!(verification.status, BusinessVerificationStatus::Verified)\n        } else {\n            false\n        }\n    }\n\n    pub fn get_verified_businesses(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::VERIFIED_BUSINESSES_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_pending_businesses(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::PENDING_BUSINESSES_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_rejected_businesses(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::REJECTED_BUSINESSES_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    fn add_to_verified_businesses(env: \u0026Env, business: \u0026Address) {\n        let mut verified = Self::get_verified_businesses(env);\n        verified.push_back(business.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_BUSINESSES_KEY, \u0026verified);\n    }\n\n    fn add_to_pending_businesses(env: \u0026Env, business: \u0026Address) {\n        let mut pending = Self::get_pending_businesses(env);\n        pending.push_back(business.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_BUSINESSES_KEY, \u0026pending);\n    }\n\n    fn add_to_rejected_businesses(env: \u0026Env, business: \u0026Address) {\n        let mut rejected = Self::get_rejected_businesses(env);\n        rejected.push_back(business.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_BUSINESSES_KEY, \u0026rejected);\n    }\n\n    fn remove_from_verified_businesses(env: \u0026Env, business: \u0026Address) {\n        let verified = Self::get_verified_businesses(env);\n        let mut new_verified = vec![env];\n        for addr in verified.iter() {\n            if addr != *business {\n                new_verified.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_BUSINESSES_KEY, \u0026new_verified);\n    }\n\n    fn remove_from_pending_businesses(env: \u0026Env, business: \u0026Address) {\n        let pending = Self::get_pending_businesses(env);\n        let mut new_pending = vec![env];\n        for addr in pending.iter() {\n            if addr != *business {\n                new_pending.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_BUSINESSES_KEY, \u0026new_pending);\n    }\n\n    fn remove_from_rejected_businesses(env: \u0026Env, business: \u0026Address) {\n        let rejected = Self::get_rejected_businesses(env);\n        let mut new_rejected = vec![env];\n        for addr in rejected.iter() {\n            if addr != *business {\n                new_rejected.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_BUSINESSES_KEY, \u0026new_rejected);\n    }\n\n    pub fn set_admin(env: \u0026Env, admin: \u0026Address) {\n        env.storage().instance().set(\u0026Self::ADMIN_KEY, admin);\n    }\n\n    pub fn get_admin(env: \u0026Env) -\u003e Option\u003cAddress\u003e {\n        env.storage().instance().get(\u0026Self::ADMIN_KEY)\n    }\n\n    pub fn is_admin(env: \u0026Env, address: \u0026Address) -\u003e bool {\n        if let Some(admin) = Self::get_admin(env) {\n            admin == *address\n        } else {\n            false\n        }\n    }\n}\n\npub struct InvestorVerificationStorage;\n\nimpl InvestorVerificationStorage {\n    const VERIFIED_INVESTORS_KEY: \u0026'static str = \"verified_investors\";\n    const PENDING_INVESTORS_KEY: \u0026'static str = \"pending_investors\";\n    const REJECTED_INVESTORS_KEY: \u0026'static str = \"rejected_investors\";\n    const INVESTOR_HISTORY_KEY: \u0026'static str = \"investor_history\";\n    const INVESTOR_ANALYTICS_KEY: \u0026'static str = \"investor_analytics\";\n\n    pub fn submit(env: \u0026Env, investor: \u0026Address, kyc_data: String) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut verification = Self::get(env, investor);\n        match verification {\n            Some(ref existing) =\u003e match existing.status {\n                BusinessVerificationStatus::Pending =\u003e {\n                    return Err(QuickLendXError::KYCAlreadyPending)\n                }\n                BusinessVerificationStatus::Verified =\u003e {\n                    return Err(QuickLendXError::KYCAlreadyVerified)\n                }\n                BusinessVerificationStatus::Rejected =\u003e {\n                    verification = Some(InvestorVerification {\n                        investor: investor.clone(),\n                        status: BusinessVerificationStatus::Pending,\n                        verified_at: None,\n                        verified_by: None,\n                        kyc_data,\n                        investment_limit: existing.investment_limit,\n                        submitted_at: env.ledger().timestamp(),\n                        tier: existing.tier.clone(),\n                        risk_level: existing.risk_level.clone(),\n                        risk_score: existing.risk_score,\n                        total_invested: existing.total_invested,\n                        total_returns: existing.total_returns,\n                        successful_investments: existing.successful_investments,\n                        defaulted_investments: existing.defaulted_investments,\n                        last_activity: existing.last_activity,\n                        rejection_reason: None,\n                        compliance_notes: None,\n                    });\n                }\n            },\n            None =\u003e {\n                verification = Some(InvestorVerification {\n                    investor: investor.clone(),\n                    status: BusinessVerificationStatus::Pending,\n                    verified_at: None,\n                    verified_by: None,\n                    kyc_data,\n                    investment_limit: 0,\n                    submitted_at: env.ledger().timestamp(),\n                    tier: InvestorTier::Basic,\n                    risk_level: InvestorRiskLevel::High, // Default to high risk for new investors\n                    risk_score: 100,                     // Default high risk score\n                    total_invested: 0,\n                    total_returns: 0,\n                    successful_investments: 0,\n                    defaulted_investments: 0,\n                    last_activity: env.ledger().timestamp(),\n                    rejection_reason: None,\n                    compliance_notes: None,\n                });\n            }\n        }\n\n        if let Some(v) = verification {\n            Self::store(env, \u0026v);\n            Self::add_to_pending_investors(env, investor);\n        }\n        Ok(())\n    }\n\n    pub fn store(env: \u0026Env, verification: \u0026InvestorVerification) {\n        env.storage()\n            .instance()\n            .set(\u0026verification.investor, verification);\n    }\n\n    pub fn get(env: \u0026Env, investor: \u0026Address) -\u003e Option\u003cInvestorVerification\u003e {\n        env.storage().instance().get(investor)\n    }\n\n    pub fn update(env: \u0026Env, verification: \u0026InvestorVerification) {\n        let old_verification = Self::get(env, \u0026verification.investor);\n\n        // Remove from old status list\n        if let Some(old_ver) = old_verification {\n            match old_ver.status {\n                BusinessVerificationStatus::Verified =\u003e {\n                    Self::remove_from_verified_investors(env, \u0026verification.investor);\n                }\n                BusinessVerificationStatus::Pending =\u003e {\n                    Self::remove_from_pending_investors(env, \u0026verification.investor);\n                }\n                BusinessVerificationStatus::Rejected =\u003e {\n                    Self::remove_from_rejected_investors(env, \u0026verification.investor);\n                }\n            }\n        }\n\n        // Store new verification\n        Self::store(env, verification);\n\n        // Add to new status list\n        match verification.status {\n            BusinessVerificationStatus::Verified =\u003e {\n                Self::add_to_verified_investors(env, \u0026verification.investor);\n            }\n            BusinessVerificationStatus::Pending =\u003e {\n                Self::add_to_pending_investors(env, \u0026verification.investor);\n            }\n            BusinessVerificationStatus::Rejected =\u003e {\n                Self::add_to_rejected_investors(env, \u0026verification.investor);\n            }\n        }\n    }\n\n    pub fn is_investor_verified(env: \u0026Env, investor: \u0026Address) -\u003e bool {\n        if let Some(verification) = Self::get(env, investor) {\n            matches!(verification.status, BusinessVerificationStatus::Verified)\n        } else {\n            false\n        }\n    }\n\n    pub fn get_verified_investors(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::VERIFIED_INVESTORS_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_pending_investors(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::PENDING_INVESTORS_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_rejected_investors(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::REJECTED_INVESTORS_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_investors_by_tier(env: \u0026Env, tier: InvestorTier) -\u003e Vec\u003cAddress\u003e {\n        let verified_investors = Self::get_verified_investors(env);\n        let mut tier_investors = Vec::new(env);\n\n        for investor in verified_investors.iter() {\n            if let Some(verification) = Self::get(env, \u0026investor) {\n                if verification.tier == tier {\n                    tier_investors.push_back(investor);\n                }\n            }\n        }\n\n        tier_investors\n    }\n\n    pub fn get_investors_by_risk_level(env: \u0026Env, risk_level: InvestorRiskLevel) -\u003e Vec\u003cAddress\u003e {\n        let verified_investors = Self::get_verified_investors(env);\n        let mut risk_investors = Vec::new(env);\n\n        for investor in verified_investors.iter() {\n            if let Some(verification) = Self::get(env, \u0026investor) {\n                if verification.risk_level == risk_level {\n                    risk_investors.push_back(investor);\n                }\n            }\n        }\n\n        risk_investors\n    }\n\n    fn add_to_verified_investors(env: \u0026Env, investor: \u0026Address) {\n        let mut verified = Self::get_verified_investors(env);\n        verified.push_back(investor.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_INVESTORS_KEY, \u0026verified);\n    }\n\n    fn add_to_pending_investors(env: \u0026Env, investor: \u0026Address) {\n        let mut pending = Self::get_pending_investors(env);\n        pending.push_back(investor.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_INVESTORS_KEY, \u0026pending);\n    }\n\n    fn add_to_rejected_investors(env: \u0026Env, investor: \u0026Address) {\n        let mut rejected = Self::get_rejected_investors(env);\n        rejected.push_back(investor.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_INVESTORS_KEY, \u0026rejected);\n    }\n\n    fn remove_from_verified_investors(env: \u0026Env, investor: \u0026Address) {\n        let verified = Self::get_verified_investors(env);\n        let mut new_verified = vec![env];\n        for addr in verified.iter() {\n            if addr != *investor {\n                new_verified.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_INVESTORS_KEY, \u0026new_verified);\n    }\n\n    fn remove_from_pending_investors(env: \u0026Env, investor: \u0026Address) {\n        let pending = Self::get_pending_investors(env);\n        let mut new_pending = vec![env];\n        for addr in pending.iter() {\n            if addr != *investor {\n                new_pending.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_INVESTORS_KEY, \u0026new_pending);\n    }\n\n    fn remove_from_rejected_investors(env: \u0026Env, investor: \u0026Address) {\n        let rejected = Self::get_rejected_investors(env);\n        let mut new_rejected = vec![env];\n        for addr in rejected.iter() {\n            if addr != *investor {\n                new_rejected.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_INVESTORS_KEY, \u0026new_rejected);\n    }\n}\n\npub fn validate_bid(\n    env: \u0026Env,\n    invoice: \u0026Invoice,\n    bid_amount: i128,\n    expected_return: i128,\n    investor: \u0026Address,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if bid_amount \u003c= 0 || bid_amount \u003c MIN_BID_AMOUNT {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    if bid_amount \u003e invoice.amount {\n        return Err(QuickLendXError::InvoiceAmountInvalid);\n    }\n\n    if expected_return \u003c= bid_amount {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Validate investor can make this investment\n    validate_investor_investment(env, investor, bid_amount)?;\n\n    BidStorage::cleanup_expired_bids(env, \u0026invoice.id);\n    let existing_bids = BidStorage::get_bids_for_invoice(env, \u0026invoice.id);\n    for bid_id in existing_bids.iter() {\n        if let Some(existing_bid) = BidStorage::get_bid(env, \u0026bid_id) {\n            if existing_bid.investor == *investor \u0026\u0026 existing_bid.status == BidStatus::Placed {\n                return Err(QuickLendXError::OperationNotAllowed);\n            }\n        }\n    }\n\n    Ok(())\n}\n\npub fn submit_kyc_application(\n    env: \u0026Env,\n    business: \u0026Address,\n    kyc_data: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Only the business can submit their own KYC\n    business.require_auth();\n\n    // Check if business already has a verification record\n    if let Some(existing_verification) =\n        BusinessVerificationStorage::get_verification(env, business)\n    {\n        match existing_verification.status {\n            BusinessVerificationStatus::Pending =\u003e {\n                return Err(QuickLendXError::KYCAlreadyPending);\n            }\n            BusinessVerificationStatus::Verified =\u003e {\n                return Err(QuickLendXError::KYCAlreadyVerified);\n            }\n            BusinessVerificationStatus::Rejected =\u003e {\n                // Allow resubmission if previously rejected\n            }\n        }\n    }\n\n    let verification = BusinessVerification {\n        business: business.clone(),\n        status: BusinessVerificationStatus::Pending,\n        verified_at: None,\n        verified_by: None,\n        kyc_data,\n        submitted_at: env.ledger().timestamp(),\n        rejection_reason: None,\n    };\n\n    BusinessVerificationStorage::store_verification(env, \u0026verification);\n    emit_kyc_submitted(env, business);\n    Ok(())\n}\n\npub fn verify_business(\n    env: \u0026Env,\n    admin: \u0026Address,\n    business: \u0026Address,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Only admin can verify businesses\n    admin.require_auth();\n    if !BusinessVerificationStorage::is_admin(env, admin) {\n        return Err(QuickLendXError::NotAdmin);\n    }\n\n    let mut verification = BusinessVerificationStorage::get_verification(env, business)\n        .ok_or(QuickLendXError::KYCNotFound)?;\n\n    if !matches!(verification.status, BusinessVerificationStatus::Pending) {\n        return Err(QuickLendXError::InvalidKYCStatus);\n    }\n\n    verification.status = BusinessVerificationStatus::Verified;\n    verification.verified_at = Some(env.ledger().timestamp());\n    verification.verified_by = Some(admin.clone());\n\n    BusinessVerificationStorage::update_verification(env, \u0026verification);\n    emit_business_verified(env, business, admin);\n    Ok(())\n}\n\npub fn reject_business(\n    env: \u0026Env,\n    admin: \u0026Address,\n    business: \u0026Address,\n    reason: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Only admin can reject businesses\n    admin.require_auth();\n    if !BusinessVerificationStorage::is_admin(env, admin) {\n        return Err(QuickLendXError::NotAdmin);\n    }\n\n    let mut verification = BusinessVerificationStorage::get_verification(env, business)\n        .ok_or(QuickLendXError::KYCNotFound)?;\n\n    if !matches!(verification.status, BusinessVerificationStatus::Pending) {\n        return Err(QuickLendXError::InvalidKYCStatus);\n    }\n\n    verification.status = BusinessVerificationStatus::Rejected;\n    verification.rejection_reason = Some(reason);\n\n    BusinessVerificationStorage::update_verification(env, \u0026verification);\n    emit_business_rejected(env, business, admin);\n    Ok(())\n}\n\npub fn get_business_verification_status(\n    env: \u0026Env,\n    business: \u0026Address,\n) -\u003e Option\u003cBusinessVerification\u003e {\n    BusinessVerificationStorage::get_verification(env, business)\n}\n\npub fn require_business_verification(env: \u0026Env, business: \u0026Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if !BusinessVerificationStorage::is_business_verified(env, business) {\n        return Err(QuickLendXError::BusinessNotVerified);\n    }\n    Ok(())\n}\n\n// Keep the existing invoice verification function\npub fn verify_invoice_data(\n    env: \u0026Env,\n    _business: \u0026Address,\n    amount: i128,\n    _currency: \u0026Address,\n    due_date: u64,\n    description: \u0026String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // First check if business is verified (temporarily disabled for debugging)\n    // require_business_verification(env, business)?;\n\n    if amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n    let current_timestamp = env.ledger().timestamp();\n    if due_date \u003c= current_timestamp {\n        return Err(QuickLendXError::InvoiceDueDateInvalid);\n    }\n    if description.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n    Ok(())\n}\n\n// Event emission functions (from main)\nfn emit_kyc_submitted(env: \u0026Env, business: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"kyc_sub\"),),\n        (business.clone(), env.ledger().timestamp()),\n    );\n}\n\nfn emit_business_verified(env: \u0026Env, business: \u0026Address, admin: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"bus_ver\"),),\n        (business.clone(), admin.clone(), env.ledger().timestamp()),\n    );\n}\n\nfn emit_business_rejected(env: \u0026Env, business: \u0026Address, admin: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"bus_rej\"),),\n        (business.clone(), admin.clone()),\n    );\n}\n\n/// Validate invoice category\npub fn validate_invoice_category(\n    category: \u0026crate::invoice::InvoiceCategory,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // All categories are valid as they are defined in the enum\n    // This function can be extended to add additional validation logic if needed\n    match category {\n        crate::invoice::InvoiceCategory::Services =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Products =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Consulting =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Manufacturing =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Technology =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Healthcare =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Other =\u003e Ok(()),\n    }\n}\n\n/// Validate invoice tags\npub fn validate_invoice_tags(tags: \u0026Vec\u003cString\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Check tag count limit (max 10 tags per invoice)\n    if tags.len() \u003e 10 {\n        return Err(QuickLendXError::TagLimitExceeded);\n    }\n\n    // Validate each tag\n    for tag in tags.iter() {\n        // Check tag length (1-50 characters)\n        if tag.len() \u003c 1 || tag.len() \u003e 50 {\n            return Err(QuickLendXError::InvalidTag);\n        }\n\n        // Check for empty tags (length 0 is already checked above)\n        // Note: Soroban String doesn't have trim() method\n    }\n\n    Ok(())\n}\n\npub fn submit_investor_kyc(\n    env: \u0026Env,\n    investor: \u0026Address,\n    kyc_data: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    investor.require_auth();\n    InvestorVerificationStorage::submit(env, investor, kyc_data)\n}\n\npub fn verify_investor(\n    env: \u0026Env,\n    admin: \u0026Address,\n    investor: \u0026Address,\n    investment_limit: i128,\n) -\u003e Result\u003cInvestorVerification, QuickLendXError\u003e {\n    admin.require_auth();\n\n    if investment_limit \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    let mut verification =\n        InvestorVerificationStorage::get(env, investor).ok_or(QuickLendXError::KYCNotFound)?;\n\n    match verification.status {\n        BusinessVerificationStatus::Verified =\u003e return Err(QuickLendXError::KYCAlreadyVerified),\n        BusinessVerificationStatus::Pending | BusinessVerificationStatus::Rejected =\u003e {\n            // Calculate risk score and determine tier\n            let risk_score = calculate_investor_risk_score(env, investor, \u0026verification.kyc_data)?;\n            let tier = determine_investor_tier(env, investor, risk_score)?;\n            let risk_level = determine_risk_level(risk_score);\n\n            // Calculate final investment limit based on tier and risk\n            let calculated_limit = calculate_investment_limit(\u0026tier, \u0026risk_level, investment_limit);\n\n            verification.status = BusinessVerificationStatus::Verified;\n            verification.verified_at = Some(env.ledger().timestamp());\n            verification.verified_by = Some(admin.clone());\n            verification.investment_limit = calculated_limit;\n            verification.tier = tier;\n            verification.risk_level = risk_level;\n            verification.risk_score = risk_score;\n            verification.compliance_notes = Some(String::from_str(env, \"Verified by admin\"));\n\n            InvestorVerificationStorage::update(env, \u0026verification);\n            Ok(verification)\n        }\n    }\n}\n\npub fn reject_investor(\n    env: \u0026Env,\n    admin: \u0026Address,\n    investor: \u0026Address,\n    reason: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    admin.require_auth();\n    let mut verification =\n        InvestorVerificationStorage::get(env, investor).ok_or(QuickLendXError::KYCNotFound)?;\n\n    verification.status = BusinessVerificationStatus::Rejected;\n    verification.verified_at = Some(env.ledger().timestamp());\n    verification.verified_by = Some(admin.clone());\n    verification.rejection_reason = Some(reason);\n    verification.compliance_notes = Some(String::from_str(env, \"Rejected by admin\"));\n\n    InvestorVerificationStorage::update(env, \u0026verification);\n    Ok(())\n}\n\npub fn get_investor_verification(env: \u0026Env, investor: \u0026Address) -\u003e Option\u003cInvestorVerification\u003e {\n    InvestorVerificationStorage::get(env, investor)\n}\n\n/// Calculate investor risk score based on various factors\npub fn calculate_investor_risk_score(\n    env: \u0026Env,\n    investor: \u0026Address,\n    kyc_data: \u0026String,\n) -\u003e Result\u003cu32, QuickLendXError\u003e {\n    let mut risk_score = 0u32;\n\n    // Base risk score from KYC data analysis (simplified)\n    // In a real implementation, this would analyze the KYC data\n    let kyc_length = kyc_data.len();\n    if kyc_length \u003c 100 {\n        risk_score += 30; // High risk for incomplete KYC\n    } else if kyc_length \u003c 500 {\n        risk_score += 20; // Medium risk\n    } else {\n        risk_score += 10; // Lower risk for comprehensive KYC\n    }\n\n    // Check investment history if available\n    if let Some(verification) = InvestorVerificationStorage::get(env, investor) {\n        let total_investments =\n            verification.successful_investments + verification.defaulted_investments;\n\n        if total_investments \u003e 0 {\n            let default_rate = (verification.defaulted_investments * 100) / total_investments;\n            risk_score += default_rate;\n        }\n\n        // Adjust based on total invested amount\n        if verification.total_invested \u003e 1000000 {\n            // 1M+ invested\n            risk_score = risk_score.saturating_sub(20);\n        } else if verification.total_invested \u003e 100000 {\n            // 100K+ invested\n            risk_score = risk_score.saturating_sub(10);\n        }\n    }\n\n    // Cap risk score at 100\n    if risk_score \u003e 100 {\n        risk_score = 100;\n    }\n\n    Ok(risk_score)\n}\n\n/// Determine investor tier based on risk score and investment history\npub fn determine_investor_tier(\n    env: \u0026Env,\n    investor: \u0026Address,\n    risk_score: u32,\n) -\u003e Result\u003cInvestorTier, QuickLendXError\u003e {\n    if let Some(verification) = InvestorVerificationStorage::get(env, investor) {\n        let total_invested = verification.total_invested;\n        let successful_investments = verification.successful_investments;\n\n        // VIP tier: Very low risk, high investment volume, many successful investments\n        if risk_score \u003c= 10 \u0026\u0026 total_invested \u003e 5000000 \u0026\u0026 successful_investments \u003e 50 {\n            return Ok(InvestorTier::VIP);\n        }\n\n        // Platinum tier: Low risk, high investment volume\n        if risk_score \u003c= 20 \u0026\u0026 total_invested \u003e 1000000 \u0026\u0026 successful_investments \u003e 20 {\n            return Ok(InvestorTier::Platinum);\n        }\n\n        // Gold tier: Medium-low risk, moderate investment volume\n        if risk_score \u003c= 40 \u0026\u0026 total_invested \u003e 100000 \u0026\u0026 successful_investments \u003e 10 {\n            return Ok(InvestorTier::Gold);\n        }\n\n        // Silver tier: Medium risk, some investment history\n        if risk_score \u003c= 60 \u0026\u0026 total_invested \u003e 10000 \u0026\u0026 successful_investments \u003e 3 {\n            return Ok(InvestorTier::Silver);\n        }\n    }\n\n    // Default to Basic tier\n    Ok(InvestorTier::Basic)\n}\n\n/// Determine risk level based on risk score\npub fn determine_risk_level(risk_score: u32) -\u003e InvestorRiskLevel {\n    match risk_score {\n        0..=25 =\u003e InvestorRiskLevel::Low,\n        26..=50 =\u003e InvestorRiskLevel::Medium,\n        51..=75 =\u003e InvestorRiskLevel::High,\n        _ =\u003e InvestorRiskLevel::VeryHigh,\n    }\n}\n\n/// Calculate investment limit based on tier and risk level\npub fn calculate_investment_limit(\n    tier: \u0026InvestorTier,\n    risk_level: \u0026InvestorRiskLevel,\n    base_limit: i128,\n) -\u003e i128 {\n    let tier_multiplier = match tier {\n        InvestorTier::VIP =\u003e 10,\n        InvestorTier::Platinum =\u003e 5,\n        InvestorTier::Gold =\u003e 3,\n        InvestorTier::Silver =\u003e 2,\n        InvestorTier::Basic =\u003e 1,\n    };\n\n    let risk_multiplier = match risk_level {\n        InvestorRiskLevel::Low =\u003e 100,     // 100% of calculated limit\n        InvestorRiskLevel::Medium =\u003e 75,   // 75% of calculated limit\n        InvestorRiskLevel::High =\u003e 50,     // 50% of calculated limit\n        InvestorRiskLevel::VeryHigh =\u003e 25, // 25% of calculated limit\n    };\n\n    let calculated_limit = base_limit.saturating_mul(tier_multiplier);\n    calculated_limit\n        .saturating_mul(risk_multiplier)\n        .saturating_div(100)\n}\n\n/// Update investor analytics after an investment\npub fn update_investor_analytics(\n    env: \u0026Env,\n    investor: \u0026Address,\n    investment_amount: i128,\n    is_successful: bool,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if let Some(mut verification) = InvestorVerificationStorage::get(env, investor) {\n        verification.total_invested = verification\n            .total_invested\n            .saturating_add(investment_amount);\n        verification.last_activity = env.ledger().timestamp();\n\n        if is_successful {\n            verification.successful_investments =\n                verification.successful_investments.saturating_add(1);\n            // Calculate returns (simplified - would need actual return data)\n            let estimated_return = investment_amount.saturating_mul(110).saturating_div(100); // 10% return\n            verification.total_returns =\n                verification.total_returns.saturating_add(estimated_return);\n        } else {\n            verification.defaulted_investments =\n                verification.defaulted_investments.saturating_add(1);\n        }\n\n        // Recalculate risk score and tier\n        verification.risk_score =\n            calculate_investor_risk_score(env, investor, \u0026verification.kyc_data)?;\n        verification.risk_level = determine_risk_level(verification.risk_score);\n        verification.tier = determine_investor_tier(env, investor, verification.risk_score)?;\n\n        // Update investment limit based on new tier and risk\n        let base_limit = 100000; // Base limit of 100K\n        verification.investment_limit =\n            calculate_investment_limit(\u0026verification.tier, \u0026verification.risk_level, base_limit);\n\n        InvestorVerificationStorage::update(env, \u0026verification);\n    }\n\n    Ok(())\n}\n\n/// Get investor analytics summary\npub fn get_investor_analytics(\n    env: \u0026Env,\n    investor: \u0026Address,\n) -\u003e Result\u003cInvestorVerification, QuickLendXError\u003e {\n    InvestorVerificationStorage::get(env, investor).ok_or(QuickLendXError::KYCNotFound)\n}\n\n/// Validate investor can make investment based on limits and risk\npub fn validate_investor_investment(\n    env: \u0026Env,\n    investor: \u0026Address,\n    investment_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if let Some(verification) = InvestorVerificationStorage::get(env, investor) {\n        // Check if investor is verified\n        if !matches!(verification.status, BusinessVerificationStatus::Verified) {\n            return Err(QuickLendXError::BusinessNotVerified);\n        }\n\n        // Check investment limit\n        if investment_amount \u003e verification.investment_limit {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        // Check risk level restrictions\n        match verification.risk_level {\n            InvestorRiskLevel::VeryHigh =\u003e {\n                // Very high risk investors have additional restrictions\n                if investment_amount \u003e 10000 {\n                    return Err(QuickLendXError::InvalidAmount);\n                }\n            }\n            InvestorRiskLevel::High =\u003e {\n                // High risk investors have moderate restrictions\n                if investment_amount \u003e 50000 {\n                    return Err(QuickLendXError::InvalidAmount);\n                }\n            }\n            _ =\u003e {\n                // Medium and low risk investors can invest up to their limit\n            }\n        }\n\n        Ok(())\n    } else {\n        Err(QuickLendXError::KYCNotFound)\n    }\n}\n\n/// Validate structured invoice metadata against the invoice amount\npub fn validate_invoice_metadata(\n    metadata: \u0026InvoiceMetadata,\n    invoice_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if metadata.customer_name.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    if metadata.customer_address.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    if metadata.tax_id.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    if metadata.line_items.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    let mut computed_total = 0i128;\n    for record in metadata.line_items.iter() {\n        if record.0.len() == 0 {\n            return Err(QuickLendXError::InvalidDescription);\n        }\n\n        if record.1 \u003c= 0 || record.2 \u003c 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let expected_total = record.1.saturating_mul(record.2);\n        if expected_total != record.3 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        computed_total = computed_total.saturating_add(record.3);\n    }\n\n    if computed_total != invoice_amount {\n        return Err(QuickLendXError::InvoiceAmountInvalid);\n    }\n\n    Ok(())\n}\n","traces":[{"line":74,"address":[14557121,14557115,14556800],"length":1,"stats":{"Line":3}},{"line":75,"address":[14556846],"length":1,"stats":{"Line":3}},{"line":77,"address":[14556918,14556872],"length":1,"stats":{"Line":3}},{"line":80,"address":[14557010],"length":1,"stats":{"Line":3}},{"line":82,"address":[14557077],"length":1,"stats":{"Line":2}},{"line":85,"address":[14557056],"length":1,"stats":{"Line":1}},{"line":88,"address":[14557098],"length":1,"stats":{"Line":0}},{"line":93,"address":[14556772,14556778,14556560],"length":1,"stats":{"Line":2}},{"line":94,"address":[14556687,14556605],"length":1,"stats":{"Line":6}},{"line":97,"address":[14557423,14557136,14557429],"length":1,"stats":{"Line":1}},{"line":98,"address":[14557175],"length":1,"stats":{"Line":2}},{"line":101,"address":[14557189],"length":1,"stats":{"Line":1}},{"line":102,"address":[14557241,14557297],"length":1,"stats":{"Line":2}},{"line":104,"address":[14557330,14557419],"length":1,"stats":{"Line":0}},{"line":107,"address":[14557399,14557309],"length":1,"stats":{"Line":3}},{"line":110,"address":[14557351,14557421],"length":1,"stats":{"Line":0}},{"line":116,"address":[14557284],"length":1,"stats":{"Line":1}},{"line":119,"address":[14557456],"length":1,"stats":{"Line":0}},{"line":120,"address":[14557485],"length":1,"stats":{"Line":0}},{"line":121,"address":[14557543],"length":1,"stats":{"Line":0}},{"line":123,"address":[14557579],"length":1,"stats":{"Line":0}},{"line":127,"address":[14558684,14558336,14558690],"length":1,"stats":{"Line":1}},{"line":128,"address":[14558366,14558590],"length":1,"stats":{"Line":4}},{"line":130,"address":[14558524,14558457],"length":1,"stats":{"Line":3}},{"line":131,"address":[14558674,14558532,14558551,14558611],"length":1,"stats":{"Line":2}},{"line":134,"address":[14557954,14557600,14557948],"length":1,"stats":{"Line":3}},{"line":135,"address":[14557630,14557854],"length":1,"stats":{"Line":4}},{"line":137,"address":[14557721,14557788],"length":1,"stats":{"Line":4}},{"line":138,"address":[14557796,14557938,14557815,14557875],"length":1,"stats":{"Line":5}},{"line":141,"address":[14558316,14557968,14558322],"length":1,"stats":{"Line":0}},{"line":142,"address":[14557998,14558222],"length":1,"stats":{"Line":0}},{"line":144,"address":[14558089,14558156],"length":1,"stats":{"Line":0}},{"line":145,"address":[14558243,14558306,14558164,14558183],"length":1,"stats":{"Line":0}},{"line":148,"address":[14559408,14559737,14559743],"length":1,"stats":{"Line":1}},{"line":149,"address":[14559452],"length":1,"stats":{"Line":2}},{"line":150,"address":[14559515,14559467],"length":1,"stats":{"Line":3}},{"line":151,"address":[14559549],"length":1,"stats":{"Line":2}},{"line":153,"address":[14559580],"length":1,"stats":{"Line":0}},{"line":156,"address":[14558704,14559039,14559033],"length":1,"stats":{"Line":3}},{"line":157,"address":[14558748],"length":1,"stats":{"Line":3}},{"line":158,"address":[14558811,14558763],"length":1,"stats":{"Line":6}},{"line":159,"address":[14558845],"length":1,"stats":{"Line":3}},{"line":161,"address":[14558876],"length":1,"stats":{"Line":0}},{"line":164,"address":[14559385,14559056,14559391],"length":1,"stats":{"Line":0}},{"line":165,"address":[14559100],"length":1,"stats":{"Line":0}},{"line":166,"address":[14559163,14559115],"length":1,"stats":{"Line":0}},{"line":167,"address":[14559197],"length":1,"stats":{"Line":0}},{"line":169,"address":[14559228],"length":1,"stats":{"Line":0}},{"line":172,"address":[14562129,14561488,14562334],"length":1,"stats":{"Line":0}},{"line":173,"address":[14561527],"length":1,"stats":{"Line":0}},{"line":174,"address":[14561550],"length":1,"stats":{"Line":0}},{"line":175,"address":[14562288,14561768,14561620,14561678],"length":1,"stats":{"Line":0}},{"line":176,"address":[14561856,14562180],"length":1,"stats":{"Line":0}},{"line":177,"address":[14562198],"length":1,"stats":{"Line":0}},{"line":180,"address":[14561910],"length":1,"stats":{"Line":0}},{"line":182,"address":[14561944],"length":1,"stats":{"Line":0}},{"line":185,"address":[14560401,14559760,14560606],"length":1,"stats":{"Line":2}},{"line":186,"address":[14559799],"length":1,"stats":{"Line":1}},{"line":187,"address":[14559822],"length":1,"stats":{"Line":2}},{"line":188,"address":[14560560,14560040,14559950,14559892],"length":1,"stats":{"Line":6}},{"line":189,"address":[14560128,14560452],"length":1,"stats":{"Line":3}},{"line":190,"address":[14560470],"length":1,"stats":{"Line":0}},{"line":193,"address":[14560182],"length":1,"stats":{"Line":1}},{"line":195,"address":[14560216],"length":1,"stats":{"Line":0}},{"line":198,"address":[14560624,14561265,14561470],"length":1,"stats":{"Line":0}},{"line":199,"address":[14560663],"length":1,"stats":{"Line":0}},{"line":200,"address":[14560686],"length":1,"stats":{"Line":0}},{"line":201,"address":[14560756,14560904,14560814,14561424],"length":1,"stats":{"Line":0}},{"line":202,"address":[14560992,14561316],"length":1,"stats":{"Line":0}},{"line":203,"address":[14561334],"length":1,"stats":{"Line":0}},{"line":206,"address":[14561046],"length":1,"stats":{"Line":0}},{"line":208,"address":[14561080],"length":1,"stats":{"Line":0}},{"line":211,"address":[14562977,14562784,14562983],"length":1,"stats":{"Line":1}},{"line":212,"address":[14562822],"length":1,"stats":{"Line":1}},{"line":215,"address":[14562576,14562774,14562768],"length":1,"stats":{"Line":1}},{"line":216,"address":[14562608,14562674],"length":1,"stats":{"Line":2}},{"line":219,"address":[14562352,14562555,14562561],"length":1,"stats":{"Line":1}},{"line":220,"address":[14562386,14562480],"length":1,"stats":{"Line":1}},{"line":221,"address":[14562524,14562455],"length":1,"stats":{"Line":5}},{"line":223,"address":[14562475],"length":1,"stats":{"Line":0}},{"line":237,"address":[14572615,14570000,14571205],"length":1,"stats":{"Line":1}},{"line":238,"address":[14570134,14570054],"length":1,"stats":{"Line":2}},{"line":239,"address":[14570142],"length":1,"stats":{"Line":1}},{"line":240,"address":[14570178],"length":1,"stats":{"Line":0}},{"line":242,"address":[14571355],"length":1,"stats":{"Line":0}},{"line":245,"address":[14571365],"length":1,"stats":{"Line":0}},{"line":248,"address":[14571802],"length":1,"stats":{"Line":0}},{"line":249,"address":[14571388],"length":1,"stats":{"Line":0}},{"line":252,"address":[14571458],"length":1,"stats":{"Line":0}},{"line":253,"address":[14571466],"length":1,"stats":{"Line":0}},{"line":254,"address":[14571509],"length":1,"stats":{"Line":0}},{"line":255,"address":[14571594,14571543],"length":1,"stats":{"Line":0}},{"line":256,"address":[14571662],"length":1,"stats":{"Line":0}},{"line":257,"address":[14571681],"length":1,"stats":{"Line":0}},{"line":258,"address":[14571724],"length":1,"stats":{"Line":0}},{"line":259,"address":[14571732],"length":1,"stats":{"Line":0}},{"line":260,"address":[14571748],"length":1,"stats":{"Line":0}},{"line":261,"address":[14571764],"length":1,"stats":{"Line":0}},{"line":262,"address":[14571771],"length":1,"stats":{"Line":0}},{"line":263,"address":[14571778],"length":1,"stats":{"Line":0}},{"line":264,"address":[14571786],"length":1,"stats":{"Line":0}},{"line":265,"address":[14571794],"length":1,"stats":{"Line":0}},{"line":270,"address":[14570611],"length":1,"stats":{"Line":2}},{"line":271,"address":[14570245],"length":1,"stats":{"Line":1}},{"line":274,"address":[14570319],"length":1,"stats":{"Line":2}},{"line":275,"address":[14570327],"length":1,"stats":{"Line":2}},{"line":277,"address":[14570429,14570378],"length":1,"stats":{"Line":4}},{"line":285,"address":[14570510],"length":1,"stats":{"Line":2}},{"line":286,"address":[14570595],"length":1,"stats":{"Line":2}},{"line":287,"address":[14570603],"length":1,"stats":{"Line":2}},{"line":292,"address":[14571168,14572329],"length":1,"stats":{"Line":4}},{"line":293,"address":[14572382],"length":1,"stats":{"Line":2}},{"line":294,"address":[14572460],"length":1,"stats":{"Line":1}},{"line":296,"address":[14572389],"length":1,"stats":{"Line":1}},{"line":299,"address":[14569969,14569975,14569776],"length":1,"stats":{"Line":2}},{"line":300,"address":[14569814],"length":1,"stats":{"Line":2}},{"line":302,"address":[14569880,14569840],"length":1,"stats":{"Line":2}},{"line":305,"address":[14569748,14569536,14569754],"length":1,"stats":{"Line":1}},{"line":306,"address":[14569581,14569663],"length":1,"stats":{"Line":2}},{"line":309,"address":[14572991,14572656,14572985],"length":1,"stats":{"Line":2}},{"line":310,"address":[14572695],"length":1,"stats":{"Line":2}},{"line":313,"address":[14572709],"length":1,"stats":{"Line":2}},{"line":314,"address":[14572761],"length":1,"stats":{"Line":2}},{"line":316,"address":[14572892,14572981],"length":1,"stats":{"Line":2}},{"line":319,"address":[14572871,14572961],"length":1,"stats":{"Line":4}},{"line":322,"address":[14572983,14572913],"length":1,"stats":{"Line":0}},{"line":328,"address":[14572806],"length":1,"stats":{"Line":2}},{"line":331,"address":[14572816],"length":1,"stats":{"Line":2}},{"line":333,"address":[14573035],"length":1,"stats":{"Line":2}},{"line":336,"address":[14573014],"length":1,"stats":{"Line":0}},{"line":339,"address":[14573056],"length":1,"stats":{"Line":0}},{"line":344,"address":[14563008],"length":1,"stats":{"Line":0}},{"line":345,"address":[14563037],"length":1,"stats":{"Line":0}},{"line":346,"address":[14563095],"length":1,"stats":{"Line":0}},{"line":348,"address":[14563131],"length":1,"stats":{"Line":0}},{"line":352,"address":[14564704,14565052,14565058],"length":1,"stats":{"Line":2}},{"line":353,"address":[14564734,14564958],"length":1,"stats":{"Line":4}},{"line":355,"address":[14564892,14564825],"length":1,"stats":{"Line":4}},{"line":356,"address":[14564919,14564979,14565042,14564900],"length":1,"stats":{"Line":4}},{"line":359,"address":[14563968,14564322,14564316],"length":1,"stats":{"Line":1}},{"line":360,"address":[14563998,14564222],"length":1,"stats":{"Line":2}},{"line":362,"address":[14564156,14564089],"length":1,"stats":{"Line":2}},{"line":363,"address":[14564306,14564183,14564243,14564164],"length":1,"stats":{"Line":2}},{"line":366,"address":[14564336,14564684,14564690],"length":1,"stats":{"Line":0}},{"line":367,"address":[14564590,14564366],"length":1,"stats":{"Line":0}},{"line":369,"address":[14564457,14564524],"length":1,"stats":{"Line":0}},{"line":370,"address":[14564611,14564532,14564551,14564674],"length":1,"stats":{"Line":0}},{"line":373,"address":[14563152,14563894,14563954],"length":1,"stats":{"Line":0}},{"line":374,"address":[14563188],"length":1,"stats":{"Line":0}},{"line":375,"address":[14563211],"length":1,"stats":{"Line":0}},{"line":377,"address":[14563435,14563342,14563281,14563908],"length":1,"stats":{"Line":0}},{"line":378,"address":[14563646,14563539],"length":1,"stats":{"Line":0}},{"line":379,"address":[14563704,14563791],"length":1,"stats":{"Line":0}},{"line":380,"address":[14563812],"length":1,"stats":{"Line":0}},{"line":385,"address":[14563566],"length":1,"stats":{"Line":0}},{"line":388,"address":[14566870,14566128,14566930],"length":1,"stats":{"Line":0}},{"line":389,"address":[14566164],"length":1,"stats":{"Line":0}},{"line":390,"address":[14566187],"length":1,"stats":{"Line":0}},{"line":392,"address":[14566318,14566884,14566411,14566257],"length":1,"stats":{"Line":0}},{"line":393,"address":[14566515,14566622],"length":1,"stats":{"Line":0}},{"line":394,"address":[14566680,14566767],"length":1,"stats":{"Line":0}},{"line":395,"address":[14566788],"length":1,"stats":{"Line":0}},{"line":400,"address":[14566542],"length":1,"stats":{"Line":0}},{"line":403,"address":[14566111,14565776,14566105],"length":1,"stats":{"Line":2}},{"line":404,"address":[14565820],"length":1,"stats":{"Line":2}},{"line":405,"address":[14565883,14565835],"length":1,"stats":{"Line":4}},{"line":406,"address":[14565917],"length":1,"stats":{"Line":2}},{"line":408,"address":[14565948],"length":1,"stats":{"Line":0}},{"line":411,"address":[14565401,14565407,14565072],"length":1,"stats":{"Line":1}},{"line":412,"address":[14565116],"length":1,"stats":{"Line":1}},{"line":413,"address":[14565131,14565179],"length":1,"stats":{"Line":2}},{"line":414,"address":[14565213],"length":1,"stats":{"Line":1}},{"line":416,"address":[14565244],"length":1,"stats":{"Line":0}},{"line":419,"address":[14565424,14565759,14565753],"length":1,"stats":{"Line":0}},{"line":420,"address":[14565468],"length":1,"stats":{"Line":0}},{"line":421,"address":[14565531,14565483],"length":1,"stats":{"Line":0}},{"line":422,"address":[14565565],"length":1,"stats":{"Line":0}},{"line":424,"address":[14565596],"length":1,"stats":{"Line":0}},{"line":427,"address":[14569518,14569313,14568672],"length":1,"stats":{"Line":1}},{"line":428,"address":[14568711],"length":1,"stats":{"Line":1}},{"line":429,"address":[14568734],"length":1,"stats":{"Line":1}},{"line":430,"address":[14569472,14568862,14568804,14568952],"length":1,"stats":{"Line":4}},{"line":431,"address":[14569364,14569040],"length":1,"stats":{"Line":2}},{"line":432,"address":[14569382],"length":1,"stats":{"Line":0}},{"line":435,"address":[14569094],"length":1,"stats":{"Line":1}},{"line":437,"address":[14569128],"length":1,"stats":{"Line":0}},{"line":440,"address":[14567790,14566944,14567585],"length":1,"stats":{"Line":2}},{"line":441,"address":[14566983],"length":1,"stats":{"Line":2}},{"line":442,"address":[14567006],"length":1,"stats":{"Line":2}},{"line":443,"address":[14567076,14567134,14567224,14567744],"length":1,"stats":{"Line":8}},{"line":444,"address":[14567636,14567312],"length":1,"stats":{"Line":4}},{"line":445,"address":[14567654],"length":1,"stats":{"Line":0}},{"line":448,"address":[14567366],"length":1,"stats":{"Line":2}},{"line":450,"address":[14567400],"length":1,"stats":{"Line":0}},{"line":453,"address":[14568449,14567808,14568654],"length":1,"stats":{"Line":0}},{"line":454,"address":[14567847],"length":1,"stats":{"Line":0}},{"line":455,"address":[14567870],"length":1,"stats":{"Line":0}},{"line":456,"address":[14567998,14567940,14568088,14568608],"length":1,"stats":{"Line":0}},{"line":457,"address":[14568500,14568176],"length":1,"stats":{"Line":0}},{"line":458,"address":[14568518],"length":1,"stats":{"Line":0}},{"line":461,"address":[14568230],"length":1,"stats":{"Line":0}},{"line":463,"address":[14568264],"length":1,"stats":{"Line":0}},{"line":467,"address":[14538832,14539873,14539867],"length":1,"stats":{"Line":1}},{"line":474,"address":[14538930],"length":1,"stats":{"Line":2}},{"line":475,"address":[14538969],"length":1,"stats":{"Line":0}},{"line":478,"address":[14538997],"length":1,"stats":{"Line":1}},{"line":479,"address":[14539051],"length":1,"stats":{"Line":0}},{"line":482,"address":[14539041],"length":1,"stats":{"Line":1}},{"line":483,"address":[14539129],"length":1,"stats":{"Line":0}},{"line":487,"address":[14539084,14539142],"length":1,"stats":{"Line":2}},{"line":489,"address":[14539184],"length":1,"stats":{"Line":1}},{"line":490,"address":[14539218],"length":1,"stats":{"Line":1}},{"line":491,"address":[14539300,14539393,14539236],"length":1,"stats":{"Line":4}},{"line":492,"address":[14539586,14539489],"length":1,"stats":{"Line":0}},{"line":493,"address":[14539737,14539758,14539648],"length":1,"stats":{"Line":0}},{"line":494,"address":[14539794],"length":1,"stats":{"Line":0}},{"line":499,"address":[14539511],"length":1,"stats":{"Line":2}},{"line":502,"address":[14552416,14553389,14553282],"length":1,"stats":{"Line":3}},{"line":508,"address":[14552467],"length":1,"stats":{"Line":2}},{"line":511,"address":[14552550],"length":1,"stats":{"Line":3}},{"line":514,"address":[14552609,14552664],"length":1,"stats":{"Line":0}},{"line":516,"address":[14552666],"length":1,"stats":{"Line":0}},{"line":519,"address":[14552676],"length":1,"stats":{"Line":0}},{"line":528,"address":[14552657],"length":1,"stats":{"Line":3}},{"line":533,"address":[14552859,14552808],"length":1,"stats":{"Line":6}},{"line":537,"address":[14553232],"length":1,"stats":{"Line":3}},{"line":538,"address":[14553249],"length":1,"stats":{"Line":3}},{"line":539,"address":[14553256],"length":1,"stats":{"Line":2}},{"line":542,"address":[14541920,14542660,14542666],"length":1,"stats":{"Line":1}},{"line":548,"address":[14541979],"length":1,"stats":{"Line":2}},{"line":549,"address":[14541995],"length":1,"stats":{"Line":1}},{"line":550,"address":[14542004],"length":1,"stats":{"Line":0}},{"line":553,"address":[14542063,14542024,14542140],"length":1,"stats":{"Line":6}},{"line":554,"address":[14542037,14542126],"length":1,"stats":{"Line":3}},{"line":556,"address":[14542207],"length":1,"stats":{"Line":3}},{"line":557,"address":[14542221],"length":1,"stats":{"Line":0}},{"line":560,"address":[14542246],"length":1,"stats":{"Line":3}},{"line":561,"address":[14542262,14542306],"length":1,"stats":{"Line":6}},{"line":562,"address":[14542422,14542496],"length":1,"stats":{"Line":3}},{"line":564,"address":[14542608],"length":1,"stats":{"Line":2}},{"line":565,"address":[14542630],"length":1,"stats":{"Line":1}},{"line":566,"address":[14542637],"length":1,"stats":{"Line":2}},{"line":569,"address":[14540654,14539888,14540635],"length":1,"stats":{"Line":0}},{"line":576,"address":[14539952],"length":1,"stats":{"Line":0}},{"line":577,"address":[14540030],"length":1,"stats":{"Line":0}},{"line":578,"address":[14540051],"length":1,"stats":{"Line":0}},{"line":581,"address":[14540195,14540146,14540645,14540079],"length":1,"stats":{"Line":0}},{"line":582,"address":[14540123,14540181],"length":1,"stats":{"Line":0}},{"line":584,"address":[14540265],"length":1,"stats":{"Line":0}},{"line":585,"address":[14540279],"length":1,"stats":{"Line":0}},{"line":588,"address":[14540307],"length":1,"stats":{"Line":0}},{"line":589,"address":[14540315],"length":1,"stats":{"Line":0}},{"line":591,"address":[14540537],"length":1,"stats":{"Line":0}},{"line":592,"address":[14540596],"length":1,"stats":{"Line":0}},{"line":593,"address":[14540603],"length":1,"stats":{"Line":0}},{"line":596,"address":[14574288],"length":1,"stats":{"Line":0}},{"line":600,"address":[14574309],"length":1,"stats":{"Line":0}},{"line":603,"address":[14574224],"length":1,"stats":{"Line":0}},{"line":604,"address":[14574238],"length":1,"stats":{"Line":0}},{"line":605,"address":[14574247],"length":1,"stats":{"Line":0}},{"line":607,"address":[14574257],"length":1,"stats":{"Line":0}},{"line":611,"address":[14545136,14545399,14545405],"length":1,"stats":{"Line":0}},{"line":622,"address":[14545202],"length":1,"stats":{"Line":0}},{"line":623,"address":[14545255],"length":1,"stats":{"Line":0}},{"line":625,"address":[14545229,14545265],"length":1,"stats":{"Line":0}},{"line":626,"address":[14545337],"length":1,"stats":{"Line":0}},{"line":627,"address":[14545359],"length":1,"stats":{"Line":0}},{"line":629,"address":[14545347],"length":1,"stats":{"Line":0}},{"line":630,"address":[14545379],"length":1,"stats":{"Line":0}},{"line":632,"address":[14545369],"length":1,"stats":{"Line":0}},{"line":636,"address":[14544876,14544913,14544384],"length":1,"stats":{"Line":1}},{"line":637,"address":[14544724,14544423],"length":1,"stats":{"Line":2}},{"line":638,"address":[14544446],"length":1,"stats":{"Line":2}},{"line":639,"address":[14544498,14544555],"length":1,"stats":{"Line":3}},{"line":643,"address":[14552319,14551632,14552260],"length":1,"stats":{"Line":2}},{"line":644,"address":[14552102,14551684],"length":1,"stats":{"Line":2}},{"line":645,"address":[14551707],"length":1,"stats":{"Line":2}},{"line":646,"address":[14551759,14551816,14552266],"length":1,"stats":{"Line":3}},{"line":650,"address":[14551615,14551200,14551581],"length":1,"stats":{"Line":0}},{"line":651,"address":[14551247,14551524],"length":1,"stats":{"Line":0}},{"line":652,"address":[14551270],"length":1,"stats":{"Line":0}},{"line":653,"address":[14551322,14551383],"length":1,"stats":{"Line":0}},{"line":658,"address":[14555232],"length":1,"stats":{"Line":1}},{"line":675,"address":[14550736,14551170,14551176],"length":1,"stats":{"Line":1}},{"line":677,"address":[14550756],"length":1,"stats":{"Line":1}},{"line":678,"address":[14550821],"length":1,"stats":{"Line":0}},{"line":682,"address":[14550850,14550897,14550771],"length":1,"stats":{"Line":3}},{"line":684,"address":[14550980,14551072,14551125],"length":1,"stats":{"Line":6}},{"line":685,"address":[14551095],"length":1,"stats":{"Line":0}},{"line":692,"address":[14551004],"length":1,"stats":{"Line":1}},{"line":695,"address":[14545096,14545122,14544928],"length":1,"stats":{"Line":1}},{"line":700,"address":[14544973],"length":1,"stats":{"Line":1}},{"line":701,"address":[14545037],"length":1,"stats":{"Line":1}},{"line":704,"address":[14542688,14544317,14544333],"length":1,"stats":{"Line":1}},{"line":710,"address":[14542790],"length":1,"stats":{"Line":1}},{"line":712,"address":[14542815],"length":1,"stats":{"Line":1}},{"line":713,"address":[14542935],"length":1,"stats":{"Line":0}},{"line":716,"address":[14542837,14542962],"length":1,"stats":{"Line":1}},{"line":719,"address":[14543063],"length":1,"stats":{"Line":1}},{"line":720,"address":[14543141],"length":1,"stats":{"Line":0}},{"line":723,"address":[14543110,14543221,14544328],"length":1,"stats":{"Line":4}},{"line":724,"address":[14544323,14543340],"length":1,"stats":{"Line":2}},{"line":725,"address":[14543530],"length":1,"stats":{"Line":2}},{"line":728,"address":[14543584],"length":1,"stats":{"Line":2}},{"line":730,"address":[14543632],"length":1,"stats":{"Line":2}},{"line":731,"address":[14543648],"length":1,"stats":{"Line":2}},{"line":732,"address":[14543852,14543778],"length":1,"stats":{"Line":2}},{"line":733,"address":[14543976],"length":1,"stats":{"Line":2}},{"line":734,"address":[14543992],"length":1,"stats":{"Line":2}},{"line":735,"address":[14544006],"length":1,"stats":{"Line":2}},{"line":736,"address":[14544020],"length":1,"stats":{"Line":2}},{"line":737,"address":[14544121,14544027],"length":1,"stats":{"Line":2}},{"line":739,"address":[14544242],"length":1,"stats":{"Line":2}},{"line":740,"address":[14544249],"length":1,"stats":{"Line":2}},{"line":745,"address":[14540688,14541883,14541856],"length":1,"stats":{"Line":0}},{"line":751,"address":[14540752],"length":1,"stats":{"Line":0}},{"line":752,"address":[14540838,14541871],"length":1,"stats":{"Line":0}},{"line":755,"address":[14541031],"length":1,"stats":{"Line":0}},{"line":756,"address":[14541091,14541047],"length":1,"stats":{"Line":0}},{"line":757,"address":[14541207],"length":1,"stats":{"Line":0}},{"line":758,"address":[14541388],"length":1,"stats":{"Line":0}},{"line":759,"address":[14541608],"length":1,"stats":{"Line":0}},{"line":761,"address":[14541817],"length":1,"stats":{"Line":0}},{"line":762,"address":[14541824],"length":1,"stats":{"Line":0}},{"line":765,"address":[14553872],"length":1,"stats":{"Line":1}},{"line":766,"address":[14553893],"length":1,"stats":{"Line":1}},{"line":770,"address":[14574176,14574170,14573456],"length":1,"stats":{"Line":1}},{"line":775,"address":[14573510],"length":1,"stats":{"Line":2}},{"line":779,"address":[14573518],"length":1,"stats":{"Line":1}},{"line":780,"address":[14573534,14573717],"length":1,"stats":{"Line":2}},{"line":781,"address":[14573552,14573713,14573719],"length":1,"stats":{"Line":2}},{"line":782,"address":[14573694,14573624,14573543],"length":1,"stats":{"Line":0}},{"line":783,"address":[14573597,14573690,14573696],"length":1,"stats":{"Line":0}},{"line":785,"address":[14573626,14573578,14573620],"length":1,"stats":{"Line":0}},{"line":789,"address":[14573649,14573732],"length":1,"stats":{"Line":2}},{"line":790,"address":[14573801,14573815,14573755],"length":1,"stats":{"Line":3}},{"line":793,"address":[14574035,14573808],"length":1,"stats":{"Line":3}},{"line":794,"address":[14574006,14573915],"length":1,"stats":{"Line":1}},{"line":795,"address":[14574031,14574040,14573988],"length":1,"stats":{"Line":2}},{"line":799,"address":[14573875,14574168],"length":1,"stats":{"Line":2}},{"line":801,"address":[14574094,14574164],"length":1,"stats":{"Line":0}},{"line":802,"address":[14574158,14574061],"length":1,"stats":{"Line":2}},{"line":804,"address":[14574132],"length":1,"stats":{"Line":0}},{"line":809,"address":[14574211,14573781],"length":1,"stats":{"Line":2}},{"line":810,"address":[14574203],"length":1,"stats":{"Line":0}},{"line":813,"address":[14574189],"length":1,"stats":{"Line":2}},{"line":817,"address":[14553424],"length":1,"stats":{"Line":2}},{"line":822,"address":[14553466],"length":1,"stats":{"Line":2}},{"line":823,"address":[14553532],"length":1,"stats":{"Line":2}},{"line":824,"address":[14553573],"length":1,"stats":{"Line":2}},{"line":827,"address":[14553591,14553633],"length":1,"stats":{"Line":2}},{"line":828,"address":[14553657],"length":1,"stats":{"Line":0}},{"line":832,"address":[14553692,14553617],"length":1,"stats":{"Line":2}},{"line":833,"address":[14553716],"length":1,"stats":{"Line":0}},{"line":837,"address":[14553676,14553748],"length":1,"stats":{"Line":4}},{"line":838,"address":[14553772],"length":1,"stats":{"Line":0}},{"line":842,"address":[14553811,14553732],"length":1,"stats":{"Line":4}},{"line":843,"address":[14553835],"length":1,"stats":{"Line":0}},{"line":848,"address":[14553598],"length":1,"stats":{"Line":2}},{"line":852,"address":[14550624],"length":1,"stats":{"Line":2}},{"line":854,"address":[14550657,14550632],"length":1,"stats":{"Line":4}},{"line":855,"address":[14550688,14550642],"length":1,"stats":{"Line":4}},{"line":856,"address":[14550673,14550711],"length":1,"stats":{"Line":0}},{"line":857,"address":[14550700],"length":1,"stats":{"Line":0}},{"line":862,"address":[14556192],"length":1,"stats":{"Line":2}},{"line":867,"address":[14556234],"length":1,"stats":{"Line":2}},{"line":868,"address":[14556345],"length":1,"stats":{"Line":0}},{"line":869,"address":[14556325],"length":1,"stats":{"Line":0}},{"line":870,"address":[14556305],"length":1,"stats":{"Line":0}},{"line":871,"address":[14556285],"length":1,"stats":{"Line":0}},{"line":872,"address":[14556265],"length":1,"stats":{"Line":2}},{"line":875,"address":[14556368],"length":1,"stats":{"Line":2}},{"line":876,"address":[14556397],"length":1,"stats":{"Line":0}},{"line":877,"address":[14556417],"length":1,"stats":{"Line":2}},{"line":878,"address":[14556437],"length":1,"stats":{"Line":0}},{"line":879,"address":[14556457],"length":1,"stats":{"Line":0}},{"line":882,"address":[14556485],"length":1,"stats":{"Line":2}},{"line":884,"address":[14556516],"length":1,"stats":{"Line":2}},{"line":889,"address":[14555212,14553920,14555206],"length":1,"stats":{"Line":1}},{"line":895,"address":[14554059],"length":1,"stats":{"Line":1}},{"line":896,"address":[14554146,14554265],"length":1,"stats":{"Line":2}},{"line":898,"address":[14554162],"length":1,"stats":{"Line":1}},{"line":899,"address":[14554289],"length":1,"stats":{"Line":1}},{"line":901,"address":[14554688,14554409],"length":1,"stats":{"Line":2}},{"line":902,"address":[14554534],"length":1,"stats":{"Line":1}},{"line":903,"address":[14554438],"length":1,"stats":{"Line":1}},{"line":905,"address":[14554550],"length":1,"stats":{"Line":1}},{"line":906,"address":[14554672],"length":1,"stats":{"Line":1}},{"line":907,"address":[14554629],"length":1,"stats":{"Line":1}},{"line":909,"address":[14554465],"length":1,"stats":{"Line":0}},{"line":910,"address":[14554415],"length":1,"stats":{"Line":0}},{"line":914,"address":[14554802],"length":1,"stats":{"Line":1}},{"line":915,"address":[14554488,14555182,14554701],"length":1,"stats":{"Line":2}},{"line":916,"address":[14554809],"length":1,"stats":{"Line":1}},{"line":917,"address":[14555156,14554854],"length":1,"stats":{"Line":1}},{"line":920,"address":[14554035],"length":1,"stats":{"Line":1}},{"line":921,"address":[14555103],"length":1,"stats":{"Line":1}},{"line":922,"address":[14555051],"length":1,"stats":{"Line":1}},{"line":924,"address":[14555127],"length":1,"stats":{"Line":1}},{"line":927,"address":[14554185],"length":1,"stats":{"Line":1}},{"line":931,"address":[14552336],"length":1,"stats":{"Line":0}},{"line":935,"address":[14552368],"length":1,"stats":{"Line":0}},{"line":939,"address":[14573088],"length":1,"stats":{"Line":1}},{"line":944,"address":[14573228,14573146],"length":1,"stats":{"Line":2}},{"line":946,"address":[14573204],"length":1,"stats":{"Line":1}},{"line":947,"address":[14573233],"length":1,"stats":{"Line":0}},{"line":951,"address":[14573253],"length":1,"stats":{"Line":2}},{"line":952,"address":[14573329],"length":1,"stats":{"Line":0}},{"line":956,"address":[14573297],"length":1,"stats":{"Line":1}},{"line":959,"address":[14573406],"length":1,"stats":{"Line":0}},{"line":960,"address":[14573429],"length":1,"stats":{"Line":0}},{"line":965,"address":[14573379],"length":1,"stats":{"Line":0}},{"line":966,"address":[14573416],"length":1,"stats":{"Line":0}},{"line":974,"address":[14573339],"length":1,"stats":{"Line":2}},{"line":976,"address":[14573220],"length":1,"stats":{"Line":0}},{"line":981,"address":[14556135,14556141,14555248],"length":1,"stats":{"Line":0}},{"line":985,"address":[14555294],"length":1,"stats":{"Line":0}},{"line":986,"address":[14555325],"length":1,"stats":{"Line":0}},{"line":989,"address":[14555309],"length":1,"stats":{"Line":0}},{"line":990,"address":[14555359],"length":1,"stats":{"Line":0}},{"line":993,"address":[14555343],"length":1,"stats":{"Line":0}},{"line":994,"address":[14555396],"length":1,"stats":{"Line":0}},{"line":997,"address":[14555377],"length":1,"stats":{"Line":0}},{"line":998,"address":[14555495],"length":1,"stats":{"Line":0}},{"line":1001,"address":[14555414],"length":1,"stats":{"Line":0}},{"line":1002,"address":[14555524,14555432,14555571],"length":1,"stats":{"Line":0}},{"line":1003,"address":[14555702,14555833],"length":1,"stats":{"Line":0}},{"line":1004,"address":[14555866],"length":1,"stats":{"Line":0}},{"line":1007,"address":[14555879,14555838],"length":1,"stats":{"Line":0}},{"line":1008,"address":[14555894],"length":1,"stats":{"Line":0}},{"line":1011,"address":[14555907],"length":1,"stats":{"Line":0}},{"line":1012,"address":[14555982],"length":1,"stats":{"Line":0}},{"line":1013,"address":[14556054],"length":1,"stats":{"Line":0}},{"line":1016,"address":[14556074,14556011],"length":1,"stats":{"Line":0}},{"line":1019,"address":[14555736],"length":1,"stats":{"Line":0}},{"line":1020,"address":[14555769],"length":1,"stats":{"Line":0}},{"line":1023,"address":[14555759],"length":1,"stats":{"Line":0}}],"covered":226,"coverable":437},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","test.rs"],"content":"#![cfg(test)]\n\nuse super::*;\nuse soroban_sdk::{Address, BytesN, Env, String};\n\n#[test]\nfn test_basic_invoice_creation() {\n    let env = Env::default();\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000;\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    let description = String::from_str(\u0026env, \"Test invoice for services\");\n    let category = invoice::InvoiceCategory::Services;\n    let tags = vec![\u0026env, String::from_str(\u0026env, \"test\")];\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026category,\n        \u0026tags,\n    );\n\n    // Verify invoice was stored\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n    assert_eq!(invoice.currency, currency);\n    assert_eq!(invoice.due_date, due_date);\n    assert_eq!(invoice.description, description);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.funded_amount, 0);\n    assert!(invoice.investor.is_none());\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","test_queries.rs"],"content":"use soroban_sdk::{Address, String, Vec, vec, BytesN, Env};\nuse quicklendx_contracts::{QuickLendXContract, QuickLendXContractClient};\nuse quicklendx_contracts::invoice::{InvoiceCategory, InvoiceStatus};\nuse quicklendx_contracts::verification::{BusinessVerificationStatus, InvestorTier, InvestorRiskLevel};\nuse quicklendx_contracts::analytics::{TimePeriod};\n\n/// Test all documented queries from README.md\npub fn test_all_documented_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    \n    println!(\"=== Testing QuickLendX Protocol Queries ===\");\n    println!(\"Contract ID: {:?}\", contract_id);\n    println!(\"Admin: {:?}\", admin);\n    println!(\"Business: {:?}\", business);\n    println!(\"Investor: {:?}\", investor);\n    println!(\"Currency: {:?}\", currency);\n    println!();\n    \n    // Test 1: Set admin\n    println!(\"1. Setting admin...\");\n    match client.try_set_admin(\u0026admin) {\n        Ok(_) =\u003e println!(\" Admin set successfully\"),\n        Err(e) =\u003e println!(\" Failed to set admin: {:?}\", e),\n    }\n    \n    // Test 2: Business KYC submission\n    println!(\"\\n2. Testing business KYC submission...\");\n    match client.try_submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\")) {\n        Ok(_) =\u003e println!(\" Business KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit business KYC: {:?}\", e),\n    }\n    \n    // Test 3: Business verification\n    println!(\"\\n3. Testing business verification...\");\n    match client.try_verify_business(\u0026admin, \u0026business) {\n        Ok(_) =\u003e println!(\" Business verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify business: {:?}\", e),\n    }\n    \n    // Test 4: Create invoice\n    println!(\"\\n4. Testing invoice creation...\");\n    let invoice_id = match client.try_store_invoice(\n        \u0026business,\n        \u002610000, // $100.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice for services\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\"), String::from_str(\u0026env, \"services\")]\n    ) {\n        Ok(id) =\u003e {\n            println!(\" Invoice created successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to create invoice: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 5: Verify invoice\n    println!(\"\\n5. Testing invoice verification...\");\n    match client.try_verify_invoice(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Invoice verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify invoice: {:?}\", e),\n    }\n    \n    // Test 6: Investor KYC submission\n    println!(\"\\n6. Testing investor KYC submission...\");\n    match client.try_submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\")) {\n        Ok(_) =\u003e println!(\" Investor KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit investor KYC: {:?}\", e),\n    }\n    \n    // Test 7: Investor verification\n    println!(\"\\n7. Testing investor verification...\");\n    match client.try_verify_investor(\u0026investor, \u00261000) {\n        Ok(_) =\u003e println!(\" Investor verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify investor: {:?}\", e),\n    }\n    \n    // Test 8: Place bid\n    println!(\"\\n8. Testing bid placement...\");\n    let bid_id = match client.try_place_bid(\u0026investor, \u0026invoice_id, \u00269500, \u002610000) {\n        Ok(id) =\u003e {\n            println!(\" Bid placed successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to place bid: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 9: Accept bid\n    println!(\"\\n9. Testing bid acceptance...\");\n    match client.try_accept_bid(\u0026invoice_id, \u0026bid_id) {\n        Ok(_) =\u003e println!(\" Bid accepted successfully\"),\n        Err(e) =\u003e println!(\" Failed to accept bid: {:?}\", e),\n    }\n    \n    // Test 10: Release escrow funds\n    println!(\"\\n10. Testing escrow fund release...\");\n    match client.try_release_escrow_funds(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Escrow funds released successfully\"),\n        Err(e) =\u003e println!(\" Failed to release escrow funds: {:?}\", e),\n    }\n    \n    // Test 11: Query functions\n    println!(\"\\n11. Testing query functions...\");\n    \n    // Get invoice\n    match client.try_get_invoice(\u0026invoice_id) {\n        Ok(invoice) =\u003e println!(\" Retrieved invoice: amount={}, status={:?}\", invoice.amount, invoice.status),\n        Err(e) =\u003e println!(\" Failed to get invoice: {:?}\", e),\n    }\n    \n    // Get business invoices\n    let business_invoices = client.get_business_invoices(\u0026business);\n    println!(\" Retrieved {} business invoices\", business_invoices.len());\n    \n    // Get invoices by status\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    let funded_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Funded);\n    println!(\" Retrieved invoices by status - Pending: {}, Verified: {}, Funded: {}\", \n             pending_invoices.len(), verified_invoices.len(), funded_invoices.len());\n    \n    // Get available invoices\n    let available_invoices = client.get_available_invoices();\n    println!(\" Retrieved {} available invoices\", available_invoices.len());\n    \n    // Test 12: Verification queries\n    println!(\"\\n12. Testing verification queries...\");\n    \n    // Get verified businesses\n    let verified_businesses = client.get_verified_businesses();\n    println!(\" Retrieved {} verified businesses\", verified_businesses.len());\n    \n    // Get pending businesses\n    let pending_businesses = client.get_pending_businesses();\n    println!(\" Retrieved {} pending businesses\", pending_businesses.len());\n    \n    // Get business verification status\n    match client.try_get_business_verification_status(\u0026business) {\n        Ok(Some(verification)) =\u003e println!(\" Retrieved business verification: status={:?}\", verification.status),\n        Ok(None) =\u003e println!(\" No business verification found\"),\n        Err(e) =\u003e println!(\" Failed to get business verification: {:?}\", e),\n    }\n    \n    // Test 13: Investor verification queries\n    println!(\"\\n13. Testing investor verification queries...\");\n    \n    // Get verified investors\n    let verified_investors = client.get_verified_investors();\n    println!(\" Retrieved {} verified investors\", verified_investors.len());\n    \n    // Get pending investors\n    let pending_investors = client.get_pending_investors();\n    println!(\" Retrieved {} pending investors\", pending_investors.len());\n    \n    // Get investor verification\n    match client.try_get_investor_verification(\u0026investor) {\n        Ok(Some(verification)) =\u003e {\n            println!(\" Retrieved investor verification: tier={:?}, risk_level={:?}, limit={}\", \n                     verification.tier, verification.risk_level, verification.investment_limit);\n        },\n        Ok(None) =\u003e println!(\" No investor verification found\"),\n        Err(e) =\u003e println!(\" Failed to get investor verification: {:?}\", e),\n    }\n    \n    // Test 14: Analytics queries\n    println!(\"\\n14. Testing analytics queries...\");\n    \n    // Get platform metrics\n    match client.try_get_platform_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved platform metrics: total_invoices={}, total_volume={}\", \n                               metrics.total_invoices, metrics.total_volume),\n        Err(e) =\u003e println!(\" Failed to get platform metrics: {:?}\", e),\n    }\n    \n    // Get performance metrics\n    match client.try_get_performance_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved performance metrics: success_rate={}, satisfaction={}\", \n                               metrics.transaction_success_rate, metrics.user_satisfaction_score),\n        Err(e) =\u003e println!(\" Failed to get performance metrics: {:?}\", e),\n    }\n    \n    // Test 15: Audit queries\n    println!(\"\\n15. Testing audit queries...\");\n    \n    // Get audit trail\n    let audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    println!(\" Retrieved {} audit entries for invoice\", audit_trail.len());\n    \n    // Get audit stats\n    let audit_stats = client.get_audit_stats();\n    println!(\" Retrieved audit stats: total_entries={}\", audit_stats.total_entries);\n    \n    // Test 16: Backup queries\n    println!(\"\\n16. Testing backup queries...\");\n    \n    // Create backup\n    match client.try_create_backup(\u0026String::from_str(\u0026env, \"Test backup\")) {\n        Ok(backup_id) =\u003e {\n            println!(\" Created backup: {:?}\", backup_id);\n            \n            // Get backup details\n            match client.try_get_backup_details(\u0026backup_id) {\n                Ok(Some(backup)) =\u003e println!(\" Retrieved backup details: status={:?}, count={}\", \n                                           backup.status, backup.invoice_count),\n                Ok(None) =\u003e println!(\" No backup found\"),\n                Err(e) =\u003e println!(\" Failed to get backup details: {:?}\", e),\n            }\n        },\n        Err(e) =\u003e println!(\" Failed to create backup: {:?}\", e),\n    }\n    \n    // Get all backups\n    let backups = client.get_backups();\n    println!(\" Retrieved {} backups\", backups.len());\n    \n    // Test 17: Category and tag queries\n    println!(\"\\n17. Testing category and tag queries...\");\n    \n    // Get invoices by category\n    let services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    println!(\" Retrieved {} invoices in Services category\", services_invoices.len());\n    \n    // Get invoices by tag\n    let test_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"test\"));\n    println!(\" Retrieved {} invoices with 'test' tag\", test_tag_invoices.len());\n    \n    // Get all categories\n    let all_categories = client.get_all_categories();\n    println!(\" Retrieved {} categories\", all_categories.len());\n    \n    // Test 18: Rating queries\n    println!(\"\\n18. Testing rating queries...\");\n    \n    // Get invoices with ratings\n    let invoices_with_ratings = client.get_invoices_with_ratings_count();\n    println!(\" Retrieved {} invoices with ratings\", invoices_with_ratings);\n    \n    // Get invoices with rating above threshold\n    let high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    println!(\" Retrieved {} invoices with rating above 4\", high_rated_invoices.len());\n    \n    // Test 19: Notification queries\n    println!(\"\\n19. Testing notification queries...\");\n    \n    // Get user notifications\n    let user_notifications = client.get_user_notifications(\u0026business);\n    println!(\" Retrieved {} notifications for business\", user_notifications.len());\n    \n    // Get notification preferences\n    let preferences = client.get_notification_preferences(\u0026business);\n    println!(\" Retrieved notification preferences: email={}, push={}\", \n             preferences.email_enabled, preferences.push_enabled);\n    \n    // Get notification stats\n    let notification_stats = client.get_user_notification_stats(\u0026business);\n    println!(\" Retrieved notification stats: total_sent={}, total_delivered={}\", \n             notification_stats.total_sent, notification_stats.total_delivered);\n    \n    // Test 20: Advanced analytics queries\n    println!(\"\\n20. Testing advanced analytics queries...\");\n    \n    // Get financial metrics\n    match client.try_get_financial_metrics(\u0026TimePeriod::Monthly) {\n        Ok(metrics) =\u003e println!(\" Retrieved financial metrics: total_volume={}, total_fees={}\", \n                               metrics.total_volume, metrics.total_fees),\n        Err(e) =\u003e println!(\" Failed to get financial metrics: {:?}\", e),\n    }\n    \n    // Get user behavior metrics\n    match client.try_get_user_behavior_metrics(\u0026business) {\n        Ok(metrics) =\u003e println!(\" Retrieved user behavior metrics: invoices_uploaded={}, risk_score={}\", \n                               metrics.total_invoices_uploaded, metrics.risk_score),\n        Err(e) =\u003e println!(\" Failed to get user behavior metrics: {:?}\", e),\n    }\n    \n    // Get analytics summary\n    match client.try_get_analytics_summary() {\n        Ok((platform_metrics, performance_metrics)) =\u003e {\n            println!(\" Retrieved analytics summary: platform_invoices={}, performance_success_rate={}\", \n                     platform_metrics.total_invoices, performance_metrics.transaction_success_rate);\n        },\n        Err(e) =\u003e println!(\" Failed to get analytics summary: {:?}\", e),\n    }\n    \n    // Test 21: Investor analytics queries\n    println!(\"\\n21. Testing investor analytics queries...\");\n    \n    // Get investors by tier\n    let basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    println!(\" Retrieved {} investors in Basic tier\", basic_investors.len());\n    \n    // Get investors by risk level\n    let medium_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Medium);\n    println!(\" Retrieved {} investors with Medium risk\", medium_risk_investors.len());\n    \n    // Calculate investor analytics\n    match client.try_calculate_investor_analytics(\u0026investor) {\n        Ok(analytics) =\u003e println!(\" Calculated investor analytics: tier={:?}, success_rate={}\", \n                                 analytics.tier, analytics.success_rate),\n        Err(e) =\u003e println!(\" Failed to calculate investor analytics: {:?}\", e),\n    }\n    \n    // Get investor performance metrics\n    match client.try_calc_investor_perf_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved investor performance metrics: total_investors={}, verified={}\", \n                               metrics.total_investors, metrics.verified_investors),\n        Err(e) =\u003e println!(\" Failed to get investor performance metrics: {:?}\", e),\n    }\n    \n    println!(\"\\n=== Query Testing Complete ===\");\n    println!(\"All documented queries have been tested.\");\n    println!(\"Some queries may fail due to:\");\n    println!(\"- Insufficient test data\");\n    println!(\"- Missing dependencies\");\n    println!(\"- Contract state requirements\");\n    println!(\"- Network connectivity issues\");\n}\n\nuse soroban_sdk::{Address, String, Vec, vec, BytesN, Env};\nuse quicklendx_contracts::{QuickLendXContract, QuickLendXContractClient};\nuse quicklendx_contracts::invoice::{InvoiceCategory, InvoiceStatus};\nuse quicklendx_contracts::verification::{BusinessVerificationStatus, InvestorTier, InvestorRiskLevel};\nuse quicklendx_contracts::analytics::{TimePeriod};\n\n/// Test all documented queries from README.md\npub fn test_all_documented_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    \n    println!(\"=== Testing QuickLendX Protocol Queries ===\");\n    println!(\"Contract ID: {:?}\", contract_id);\n    println!(\"Admin: {:?}\", admin);\n    println!(\"Business: {:?}\", business);\n    println!(\"Investor: {:?}\", investor);\n    println!(\"Currency: {:?}\", currency);\n    println!();\n    \n    // Test 1: Set admin\n    println!(\"1. Setting admin...\");\n    match client.try_set_admin(\u0026admin) {\n        Ok(_) =\u003e println!(\" Admin set successfully\"),\n        Err(e) =\u003e println!(\" Failed to set admin: {:?}\", e),\n    }\n    \n    // Test 2: Business KYC submission\n    println!(\"\\n2. Testing business KYC submission...\");\n    match client.try_submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\")) {\n        Ok(_) =\u003e println!(\" Business KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit business KYC: {:?}\", e),\n    }\n    \n    // Test 3: Business verification\n    println!(\"\\n3. Testing business verification...\");\n    match client.try_verify_business(\u0026admin, \u0026business) {\n        Ok(_) =\u003e println!(\" Business verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify business: {:?}\", e),\n    }\n    \n    // Test 4: Create invoice\n    println!(\"\\n4. Testing invoice creation...\");\n    let invoice_id = match client.try_store_invoice(\n        \u0026business,\n        \u002610000, // $100.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice for services\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\"), String::from_str(\u0026env, \"services\")]\n    ) {\n        Ok(id) =\u003e {\n            println!(\" Invoice created successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to create invoice: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 5: Verify invoice\n    println!(\"\\n5. Testing invoice verification...\");\n    match client.try_verify_invoice(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Invoice verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify invoice: {:?}\", e),\n    }\n    \n    // Test 6: Investor KYC submission\n    println!(\"\\n6. Testing investor KYC submission...\");\n    match client.try_submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\")) {\n        Ok(_) =\u003e println!(\" Investor KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit investor KYC: {:?}\", e),\n    }\n    \n    // Test 7: Investor verification\n    println!(\"\\n7. Testing investor verification...\");\n    match client.try_verify_investor(\u0026investor, \u00261000) {\n        Ok(_) =\u003e println!(\" Investor verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify investor: {:?}\", e),\n    }\n    \n    // Test 8: Place bid\n    println!(\"\\n8. Testing bid placement...\");\n    let bid_id = match client.try_place_bid(\u0026investor, \u0026invoice_id, \u00269500, \u002610000) {\n        Ok(id) =\u003e {\n            println!(\" Bid placed successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to place bid: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 9: Accept bid\n    println!(\"\\n9. Testing bid acceptance...\");\n    match client.try_accept_bid(\u0026invoice_id, \u0026bid_id) {\n        Ok(_) =\u003e println!(\" Bid accepted successfully\"),\n        Err(e) =\u003e println!(\" Failed to accept bid: {:?}\", e),\n    }\n    \n    // Test 10: Release escrow funds\n    println!(\"\\n10. Testing escrow fund release...\");\n    match client.try_release_escrow_funds(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Escrow funds released successfully\"),\n        Err(e) =\u003e println!(\" Failed to release escrow funds: {:?}\", e),\n    }\n    \n    // Test 11: Query functions\n    println!(\"\\n11. Testing query functions...\");\n    \n    // Get invoice\n    match client.try_get_invoice(\u0026invoice_id) {\n        Ok(invoice) =\u003e println!(\" Retrieved invoice: amount={}, status={:?}\", invoice.amount, invoice.status),\n        Err(e) =\u003e println!(\" Failed to get invoice: {:?}\", e),\n    }\n    \n    // Get business invoices\n    let business_invoices = client.get_business_invoices(\u0026business);\n    println!(\" Retrieved {} business invoices\", business_invoices.len());\n    \n    // Get invoices by status\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    let funded_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Funded);\n    println!(\" Retrieved invoices by status - Pending: {}, Verified: {}, Funded: {}\", \n             pending_invoices.len(), verified_invoices.len(), funded_invoices.len());\n    \n    // Get available invoices\n    let available_invoices = client.get_available_invoices();\n    println!(\" Retrieved {} available invoices\", available_invoices.len());\n    \n    // Test 12: Verification queries\n    println!(\"\\n12. Testing verification queries...\");\n    \n    // Get verified businesses\n    let verified_businesses = client.get_verified_businesses();\n    println!(\" Retrieved {} verified businesses\", verified_businesses.len());\n    \n    // Get pending businesses\n    let pending_businesses = client.get_pending_businesses();\n    println!(\" Retrieved {} pending businesses\", pending_businesses.len());\n    \n    // Get business verification status\n    match client.try_get_business_verification_status(\u0026business) {\n        Ok(Some(verification)) =\u003e println!(\" Retrieved business verification: status={:?}\", verification.status),\n        Ok(None) =\u003e println!(\" No business verification found\"),\n        Err(e) =\u003e println!(\" Failed to get business verification: {:?}\", e),\n    }\n    \n    // Test 13: Investor verification queries\n    println!(\"\\n13. Testing investor verification queries...\");\n    \n    // Get verified investors\n    let verified_investors = client.get_verified_investors();\n    println!(\" Retrieved {} verified investors\", verified_investors.len());\n    \n    // Get pending investors\n    let pending_investors = client.get_pending_investors();\n    println!(\" Retrieved {} pending investors\", pending_investors.len());\n    \n    // Get investor verification\n    match client.try_get_investor_verification(\u0026investor) {\n        Ok(Some(verification)) =\u003e {\n            println!(\" Retrieved investor verification: tier={:?}, risk_level={:?}, limit={}\", \n                     verification.tier, verification.risk_level, verification.investment_limit);\n        },\n        Ok(None) =\u003e println!(\" No investor verification found\"),\n        Err(e) =\u003e println!(\" Failed to get investor verification: {:?}\", e),\n    }\n    \n    // Test 14: Analytics queries\n    println!(\"\\n14. Testing analytics queries...\");\n    \n    // Get platform metrics\n    match client.try_get_platform_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved platform metrics: total_invoices={}, total_volume={}\", \n                               metrics.total_invoices, metrics.total_volume),\n        Err(e) =\u003e println!(\" Failed to get platform metrics: {:?}\", e),\n    }\n    \n    // Get performance metrics\n    match client.try_get_performance_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved performance metrics: success_rate={}, satisfaction={}\", \n                               metrics.transaction_success_rate, metrics.user_satisfaction_score),\n        Err(e) =\u003e println!(\" Failed to get performance metrics: {:?}\", e),\n    }\n    \n    // Test 15: Audit queries\n    println!(\"\\n15. Testing audit queries...\");\n    \n    // Get audit trail\n    let audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    println!(\" Retrieved {} audit entries for invoice\", audit_trail.len());\n    \n    // Get audit stats\n    let audit_stats = client.get_audit_stats();\n    println!(\" Retrieved audit stats: total_entries={}\", audit_stats.total_entries);\n    \n    // Test 16: Backup queries\n    println!(\"\\n16. Testing backup queries...\");\n    \n    // Create backup\n    match client.try_create_backup(\u0026String::from_str(\u0026env, \"Test backup\")) {\n        Ok(backup_id) =\u003e {\n            println!(\" Created backup: {:?}\", backup_id);\n            \n            // Get backup details\n            match client.try_get_backup_details(\u0026backup_id) {\n                Ok(Some(backup)) =\u003e println!(\" Retrieved backup details: status={:?}, count={}\", \n                                           backup.status, backup.invoice_count),\n                Ok(None) =\u003e println!(\" No backup found\"),\n                Err(e) =\u003e println!(\" Failed to get backup details: {:?}\", e),\n            }\n        },\n        Err(e) =\u003e println!(\" Failed to create backup: {:?}\", e),\n    }\n    \n    // Get all backups\n    let backups = client.get_backups();\n    println!(\" Retrieved {} backups\", backups.len());\n    \n    // Test 17: Category and tag queries\n    println!(\"\\n17. Testing category and tag queries...\");\n    \n    // Get invoices by category\n    let services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    println!(\" Retrieved {} invoices in Services category\", services_invoices.len());\n    \n    // Get invoices by tag\n    let test_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"test\"));\n    println!(\" Retrieved {} invoices with 'test' tag\", test_tag_invoices.len());\n    \n    // Get all categories\n    let all_categories = client.get_all_categories();\n    println!(\" Retrieved {} categories\", all_categories.len());\n    \n    // Test 18: Rating queries\n    println!(\"\\n18. Testing rating queries...\");\n    \n    // Get invoices with ratings\n    let invoices_with_ratings = client.get_invoices_with_ratings_count();\n    println!(\" Retrieved {} invoices with ratings\", invoices_with_ratings);\n    \n    // Get invoices with rating above threshold\n    let high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    println!(\" Retrieved {} invoices with rating above 4\", high_rated_invoices.len());\n    \n    // Test 19: Notification queries\n    println!(\"\\n19. Testing notification queries...\");\n    \n    // Get user notifications\n    let user_notifications = client.get_user_notifications(\u0026business);\n    println!(\" Retrieved {} notifications for business\", user_notifications.len());\n    \n    // Get notification preferences\n    let preferences = client.get_notification_preferences(\u0026business);\n    println!(\" Retrieved notification preferences: email={}, push={}\", \n             preferences.email_enabled, preferences.push_enabled);\n    \n    // Get notification stats\n    let notification_stats = client.get_user_notification_stats(\u0026business);\n    println!(\" Retrieved notification stats: total_sent={}, total_delivered={}\", \n             notification_stats.total_sent, notification_stats.total_delivered);\n    \n    // Test 20: Advanced analytics queries\n    println!(\"\\n20. Testing advanced analytics queries...\");\n    \n    // Get financial metrics\n    match client.try_get_financial_metrics(\u0026TimePeriod::Monthly) {\n        Ok(metrics) =\u003e println!(\" Retrieved financial metrics: total_volume={}, total_fees={}\", \n                               metrics.total_volume, metrics.total_fees),\n        Err(e) =\u003e println!(\" Failed to get financial metrics: {:?}\", e),\n    }\n    \n    // Get user behavior metrics\n    match client.try_get_user_behavior_metrics(\u0026business) {\n        Ok(metrics) =\u003e println!(\" Retrieved user behavior metrics: invoices_uploaded={}, risk_score={}\", \n                               metrics.total_invoices_uploaded, metrics.risk_score),\n        Err(e) =\u003e println!(\" Failed to get user behavior metrics: {:?}\", e),\n    }\n    \n    // Get analytics summary\n    match client.try_get_analytics_summary() {\n        Ok((platform_metrics, performance_metrics)) =\u003e {\n            println!(\" Retrieved analytics summary: platform_invoices={}, performance_success_rate={}\", \n                     platform_metrics.total_invoices, performance_metrics.transaction_success_rate);\n        },\n        Err(e) =\u003e println!(\" Failed to get analytics summary: {:?}\", e),\n    }\n    \n    // Test 21: Investor analytics queries\n    println!(\"\\n21. Testing investor analytics queries...\");\n    \n    // Get investors by tier\n    let basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    println!(\" Retrieved {} investors in Basic tier\", basic_investors.len());\n    \n    // Get investors by risk level\n    let medium_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Medium);\n    println!(\" Retrieved {} investors with Medium risk\", medium_risk_investors.len());\n    \n    // Calculate investor analytics\n    match client.try_calculate_investor_analytics(\u0026investor) {\n        Ok(analytics) =\u003e println!(\" Calculated investor analytics: tier={:?}, success_rate={}\", \n                                 analytics.tier, analytics.success_rate),\n        Err(e) =\u003e println!(\" Failed to calculate investor analytics: {:?}\", e),\n    }\n    \n    // Get investor performance metrics\n    match client.try_calc_investor_perf_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved investor performance metrics: total_investors={}, verified={}\", \n                               metrics.total_investors, metrics.verified_investors),\n        Err(e) =\u003e println!(\" Failed to get investor performance metrics: {:?}\", e),\n    }\n    \n    println!(\"\\n=== Query Testing Complete ===\");\n    println!(\"All documented queries have been tested.\");\n    println!(\"Some queries may fail due to:\");\n    println!(\"- Insufficient test data\");\n    println!(\"- Missing dependencies\");\n    println!(\"- Contract state requirements\");\n    println!(\"- Network connectivity issues\");\n}\n\n/// Test query functions with empty results and edge cases\npub fn test_query_edge_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let non_existent_address = Address::generate(\u0026env);\n    let invalid_invoice_id = BytesN::\u003c32\u003e::from_array(\u0026env, \u0026[0u8; 32]);\n    \n    println!(\"=== Testing Query Edge Cases ===\");\n    \n    // Test 1: Empty results - no data in contract\n    println!(\"\\n1. Testing empty results (no data)...\");\n    \n    // Invoice queries with no data\n    let empty_business_invoices = client.get_business_invoices(\u0026non_existent_address);\n    assert_eq!(empty_business_invoices.len(), 0, \"Should return empty vec for non-existent business\");\n    println!(\" get_business_invoices returns empty for non-existent business\");\n    \n    let empty_pending = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(empty_pending.len(), 0, \"Should return empty vec when no invoices exist\");\n    println!(\" get_invoices_by_status returns empty when no invoices exist\");\n    \n    let empty_available = client.get_available_invoices();\n    assert_eq!(empty_available.len(), 0, \"Should return empty vec when no verified invoices exist\");\n    println!(\" get_available_invoices returns empty when no verified invoices exist\");\n    \n    let empty_categories = client.get_all_categories();\n    assert_eq!(empty_categories.len(), 0, \"Should return empty vec when no categories used\");\n    println!(\" get_all_categories returns empty when no categories used\");\n    \n    let empty_ratings_count = client.get_invoices_with_ratings_count();\n    assert_eq!(empty_ratings_count, 0, \"Should return 0 when no invoices have ratings\");\n    println!(\" get_invoices_with_ratings_count returns 0 when no ratings exist\");\n    \n    let empty_high_ratings = client.get_invoices_with_rating_above(\u00263);\n    assert_eq!(empty_high_ratings.len(), 0, \"Should return empty vec when no high ratings exist\");\n    println!(\" get_invoices_with_rating_above returns empty when no high ratings exist\");\n    \n    // Verification queries with no data\n    let empty_verified_businesses = client.get_verified_businesses();\n    assert_eq!(empty_verified_businesses.len(), 0, \"Should return empty vec when no businesses verified\");\n    println!(\" get_verified_businesses returns empty when no businesses verified\");\n    \n    let empty_pending_businesses = client.get_pending_businesses();\n    assert_eq!(empty_pending_businesses.len(), 0, \"Should return empty vec when no businesses pending\");\n    println!(\" get_pending_businesses returns empty when no businesses pending\");\n    \n    let empty_verified_investors = client.get_verified_investors();\n    assert_eq!(empty_verified_investors.len(), 0, \"Should return empty vec when no investors verified\");\n    println!(\" get_verified_investors returns empty when no investors verified\");\n    \n    let empty_pending_investors = client.get_pending_investors();\n    assert_eq!(empty_pending_investors.len(), 0, \"Should return empty vec when no investors pending\");\n    println!(\" get_pending_investors returns empty when no investors pending\");\n    \n    // Bid queries with no data\n    let empty_best_bid = client.get_best_bid(\u0026invalid_invoice_id);\n    assert!(empty_best_bid.is_none(), \"Should return None for non-existent invoice\");\n    println!(\" get_best_bid returns None for non-existent invoice\");\n    \n    let empty_ranked_bids = client.get_ranked_bids(\u0026invalid_invoice_id);\n    assert_eq!(empty_ranked_bids.len(), 0, \"Should return empty vec for non-existent invoice\");\n    println!(\" get_ranked_bids returns empty for non-existent invoice\");\n    \n    // Audit queries with no data\n    let empty_audit_trail = client.get_invoice_audit_trail(\u0026invalid_invoice_id);\n    assert_eq!(empty_audit_trail.len(), 0, \"Should return empty vec for non-existent invoice\");\n    println!(\" get_invoice_audit_trail returns empty for non-existent invoice\");\n    \n    let audit_stats = client.get_audit_stats();\n    assert_eq!(audit_stats.total_entries, 0, \"Should return 0 entries when no audit data exists\");\n    println!(\" get_audit_stats returns 0 entries when no audit data exists\");\n    \n    // Backup queries with no data\n    let empty_backups = client.get_backups();\n    assert_eq!(empty_backups.len(), 0, \"Should return empty vec when no backups exist\");\n    println!(\" get_backups returns empty when no backups exist\");\n    \n    // Notification queries with no data\n    let empty_notifications = client.get_user_notifications(\u0026non_existent_address);\n    assert_eq!(empty_notifications.len(), 0, \"Should return empty vec for user with no notifications\");\n    println!(\" get_user_notifications returns empty for user with no notifications\");\n    \n    let notification_stats = client.get_user_notification_stats(\u0026non_existent_address);\n    assert_eq!(notification_stats.total_sent, 0, \"Should return 0 sent for user with no notifications\");\n    assert_eq!(notification_stats.total_delivered, 0, \"Should return 0 delivered for user with no notifications\");\n    println!(\" get_user_notification_stats returns zeros for user with no notifications\");\n    \n    // Test 2: Invalid parameters\n    println!(\"\\n2. Testing invalid parameters...\");\n    \n    // Try to get non-existent invoice\n    match client.try_get_invoice(\u0026invalid_invoice_id) {\n        Ok(_) =\u003e panic!(\"Should fail for non-existent invoice\"),\n        Err(_) =\u003e println!(\" get_invoice correctly fails for non-existent invoice\"),\n    }\n    \n    // Try to get non-existent bid\n    let non_existent_bid = client.get_bid(\u0026invalid_invoice_id);\n    assert!(non_existent_bid.is_none(), \"Should return None for non-existent bid\");\n    println!(\" get_bid returns None for non-existent bid\");\n    \n    // Try to get business verification for non-existent business\n    match client.try_get_business_verification_status(\u0026non_existent_address) {\n        Ok(None) =\u003e println!(\" get_business_verification_status returns None for non-existent business\"),\n        Ok(Some(_)) =\u003e panic!(\"Should return None for non-existent business\"),\n        Err(e) =\u003e println!(\" Unexpected error: {:?}\", e),\n    }\n    \n    // Try to get investor verification for non-existent investor\n    match client.try_get_investor_verification(\u0026non_existent_address) {\n        Ok(None) =\u003e println!(\" get_investor_verification returns None for non-existent investor\"),\n        Ok(Some(_)) =\u003e panic!(\"Should return None for non-existent investor\"),\n        Err(e) =\u003e println!(\" Unexpected error: {:?}\", e),\n    }\n    \n    // Test 3: Filter combinations and boundary conditions\n    println!(\"\\n3. Testing filter combinations and boundaries...\");\n    \n    // Test with empty tag\n    let empty_tag_results = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"\"));\n    assert_eq!(empty_tag_results.len(), 0, \"Should return empty for empty tag\");\n    println!(\" get_invoices_by_tag returns empty for empty tag\");\n    \n    // Test with non-existent tag\n    let non_existent_tag_results = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"nonexistent\"));\n    assert_eq!(non_existent_tag_results.len(), 0, \"Should return empty for non-existent tag\");\n    println!(\" get_invoices_by_tag returns empty for non-existent tag\");\n    \n    // Test rating threshold boundaries\n    let zero_threshold = client.get_invoices_with_rating_above(\u00260);\n    assert_eq!(zero_threshold.len(), 0, \"Should return empty for threshold 0 (no ratings exist)\");\n    println!(\" get_invoices_with_rating_above returns empty for threshold 0\");\n    \n    let max_threshold = client.get_invoices_with_rating_above(\u00265);\n    assert_eq!(max_threshold.len(), 0, \"Should return empty for threshold 5 (above max possible)\");\n    println!(\" get_invoices_with_rating_above returns empty for threshold 5\");\n    \n    // Test investor tier and risk level filters\n    let basic_tier_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    assert_eq!(basic_tier_investors.len(), 0, \"Should return empty for Basic tier when no investors exist\");\n    println!(\" get_investors_by_tier returns empty for Basic tier\");\n    \n    let low_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Low);\n    assert_eq!(low_risk_investors.len(), 0, \"Should return empty for Low risk level when no investors exist\");\n    println!(\" get_investors_by_risk_level returns empty for Low risk level\");\n    \n    // Test invoice count methods\n    let pending_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_count, 0, \"Should return 0 for Pending status when no invoices exist\");\n    println!(\" get_invoice_count_by_status returns 0 for Pending status\");\n    \n    let total_count = client.get_total_invoice_count();\n    assert_eq!(total_count, 0, \"Should return 0 when no invoices exist\");\n    println!(\" get_total_invoice_count returns 0 when no invoices exist\");\n    \n    // Test analytics queries with no data\n    match client.try_get_platform_metrics() {\n        Ok(metrics) =\u003e {\n            assert_eq!(metrics.total_invoices, 0, \"Platform metrics should show 0 invoices\");\n            assert_eq!(metrics.total_volume, 0, \"Platform metrics should show 0 volume\");\n            println!(\" get_platform_metrics returns zeros when no data exists\");\n        },\n        Err(e) =\u003e println!(\" get_platform_metrics failed: {:?}\", e),\n    }\n    \n    match client.try_get_performance_metrics() {\n        Ok(metrics) =\u003e {\n            // These might have default values, just check they don't panic\n            println!(\" get_performance_metrics succeeds even with no data\");\n        },\n        Err(e) =\u003e println!(\" get_performance_metrics failed: {:?}\", e),\n    }\n    \n    // Test investor analytics with non-existent investor\n    match client.try_calculate_investor_analytics(\u0026non_existent_address) {\n        Ok(_) =\u003e println!(\" calculate_investor_analytics succeeds for non-existent investor\"),\n        Err(e) =\u003e println!(\" calculate_investor_analytics failed for non-existent investor: {:?}\", e),\n    }\n    \n    println!(\"\\n=== Edge Case Testing Complete ===\");\n    println!(\"All edge cases handled correctly:\");\n    println!(\"- Empty results return appropriate empty collections or zeros\");\n    println!(\"- Invalid parameters return None or fail gracefully\");\n    println!(\"- Boundary conditions are handled properly\");\n    println!(\"- No panics or unexpected errors\");\n}\n\n/// Test query functions with populated data to verify correct results\npub fn test_query_correctness_with_data() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let investor1 = Address::generate(\u0026env);\n    let investor2 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    \n    println!(\"=== Testing Query Correctness with Data ===\");\n    \n    // Set up initial state\n    client.try_set_admin(\u0026admin).unwrap();\n    \n    // Create multiple businesses and verify them\n    client.try_submit_kyc_application(\u0026business1, \u0026String::from_str(\u0026env, \"Business 1 KYC\")).unwrap();\n    client.try_submit_kyc_application(\u0026business2, \u0026String::from_str(\u0026env, \"Business 2 KYC\")).unwrap();\n    client.try_verify_business(\u0026admin, \u0026business1).unwrap();\n    client.try_verify_business(\u0026admin, \u0026business2).unwrap();\n    \n    // Create multiple investors and verify them\n    client.try_submit_investor_kyc(\u0026investor1, \u0026String::from_str(\u0026env, \"Investor 1 KYC\")).unwrap();\n    client.try_submit_investor_kyc(\u0026investor2, \u0026String::from_str(\u0026env, \"Investor 2 KYC\")).unwrap();\n    client.try_verify_investor(\u0026investor1, \u00265000).unwrap();\n    client.try_verify_investor(\u0026investor2, \u002610000).unwrap();\n    \n    // Create multiple invoices with different categories and tags\n    let invoice1_id = client.try_store_invoice(\n        \u0026business1,\n        \u00265000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"urgent\"), String::from_str(\u0026env, \"services\")]\n    ).unwrap();\n    \n    let invoice2_id = client.try_store_invoice(\n        \u0026business1,\n        \u00267500,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Goods,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"urgent\"), String::from_str(\u0026env, \"goods\")]\n    ).unwrap();\n    \n    let invoice3_id = client.try_store_invoice(\n        \u0026business2,\n        \u002610000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 3\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"standard\"), String::from_str(\u0026env, \"services\")]\n    ).unwrap();\n    \n    // Verify invoices\n    client.try_verify_invoice(\u0026invoice1_id).unwrap();\n    client.try_verify_invoice(\u0026invoice2_id).unwrap();\n    client.try_verify_invoice(\u0026invoice3_id).unwrap();\n    \n    // Test correctness\n    println!(\"\\n1. Testing invoice queries correctness...\");\n    \n    // Get business invoices\n    let business1_invoices = client.get_business_invoices(\u0026business1);\n    assert_eq!(business1_invoices.len(), 2, \"Business 1 should have 2 invoices\");\n    assert!(business1_invoices.contains(\u0026invoice1_id), \"Should contain invoice1\");\n    assert!(business1_invoices.contains(\u0026invoice2_id), \"Should contain invoice2\");\n    println!(\" get_business_invoices returns correct invoices for business1\");\n    \n    let business2_invoices = client.get_business_invoices(\u0026business2);\n    assert_eq!(business2_invoices.len(), 1, \"Business 2 should have 1 invoice\");\n    assert!(business2_invoices.contains(\u0026invoice3_id), \"Should contain invoice3\");\n    println!(\" get_business_invoices returns correct invoices for business2\");\n    \n    // Get invoices by status\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_invoices.len(), 3, \"Should have 3 verified invoices\");\n    println!(\" get_invoices_by_status returns correct count for Verified\");\n    \n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_invoices.len(), 0, \"Should have 0 pending invoices\");\n    println!(\" get_invoices_by_status returns correct count for Pending\");\n    \n    // Get available invoices (verified but not funded)\n    let available_invoices = client.get_available_invoices();\n    assert_eq!(available_invoices.len(), 3, \"Should have 3 available invoices\");\n    println!(\" get_available_invoices returns all verified invoices\");\n    \n    // Get invoices by category\n    let services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    assert_eq!(services_invoices.len(), 2, \"Should have 2 services invoices\");\n    println!(\" get_invoices_by_category returns correct count for Services\");\n    \n    let goods_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Goods);\n    assert_eq!(goods_invoices.len(), 1, \"Should have 1 goods invoice\");\n    println!(\" get_invoices_by_category returns correct count for Goods\");\n    \n    // Get invoices by tag\n    let urgent_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"urgent\"));\n    assert_eq!(urgent_invoices.len(), 2, \"Should have 2 urgent invoices\");\n    println!(\" get_invoices_by_tag returns correct count for 'urgent'\");\n    \n    let services_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"services\"));\n    assert_eq!(services_tag_invoices.len(), 2, \"Should have 2 services-tagged invoices\");\n    println!(\" get_invoices_by_tag returns correct count for 'services'\");\n    \n    // Get all categories\n    let all_categories = client.get_all_categories();\n    assert!(all_categories.contains(\u0026InvoiceCategory::Services), \"Should contain Services\");\n    assert!(all_categories.contains(\u0026InvoiceCategory::Goods), \"Should contain Goods\");\n    assert_eq!(all_categories.len(), 2, \"Should have 2 unique categories\");\n    println!(\" get_all_categories returns correct categories\");\n    \n    // Get invoice counts\n    let verified_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_count, 3, \"Should have 3 verified invoices\");\n    println!(\" get_invoice_count_by_status returns correct count\");\n    \n    let total_count = client.get_total_invoice_count();\n    assert_eq!(total_count, 3, \"Should have 3 total invoices\");\n    println!(\" get_total_invoice_count returns correct total\");\n    \n    println!(\"\\n2. Testing verification queries correctness...\");\n    \n    // Get verified businesses\n    let verified_businesses = client.get_verified_businesses();\n    assert_eq!(verified_businesses.len(), 2, \"Should have 2 verified businesses\");\n    assert!(verified_businesses.contains(\u0026business1), \"Should contain business1\");\n    assert!(verified_businesses.contains(\u0026business2), \"Should contain business2\");\n    println!(\" get_verified_businesses returns correct businesses\");\n    \n    // Get verified investors\n    let verified_investors = client.get_verified_investors();\n    assert_eq!(verified_investors.len(), 2, \"Should have 2 verified investors\");\n    assert!(verified_investors.contains(\u0026investor1), \"Should contain investor1\");\n    assert!(verified_investors.contains(\u0026investor2), \"Should contain investor2\");\n    println!(\" get_verified_investors returns correct investors\");\n    \n    // Get pending businesses/investors (should be empty)\n    let pending_businesses = client.get_pending_businesses();\n    assert_eq!(pending_businesses.len(), 0, \"Should have 0 pending businesses\");\n    println!(\" get_pending_businesses returns empty when all verified\");\n    \n    let pending_investors = client.get_pending_investors();\n    assert_eq!(pending_investors.len(), 0, \"Should have 0 pending investors\");\n    println!(\" get_pending_investors returns empty when all verified\");\n    \n    println!(\"\\n3. Testing investor tier and risk level queries...\");\n    \n    // Get investors by tier (both should be Basic by default)\n    let basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    assert_eq!(basic_investors.len(), 2, \"Should have 2 basic tier investors\");\n    println!(\" get_investors_by_tier returns correct count for Basic tier\");\n    \n    // Get investors by risk level (should be Low by default)\n    let low_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Low);\n    assert_eq!(low_risk_investors.len(), 2, \"Should have 2 low risk investors\");\n    println!(\" get_investors_by_risk_level returns correct count for Low risk\");\n    \n    println!(\"\\n=== Query Correctness Testing Complete ===\");\n    println!(\"All queries return correct data when populated with test data.\");\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_all_queries() {\n        test_all_documented_queries();\n    }\n    \n    #[test]\n    fn test_edge_cases() {\n        test_query_edge_cases();\n    }\n    \n    #[test]\n    fn test_correctness_with_data() {\n        test_query_correctness_with_data();\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","lib.rs"],"content":"#![no_std]\nuse soroban_sdk::{contract, contractimpl, vec, Env, String, Vec};\n\n#[contract]\npub struct Contract;\n\n// This is a sample contract. Replace this placeholder with your own contract logic.\n// A corresponding test example is available in `test.rs`.\n//\n// For comprehensive examples, visit \u003chttps://github.com/stellar/soroban-examples\u003e.\n// The repository includes use cases for the Stellar ecosystem, such as data storage on\n// the blockchain, token swaps, liquidity pools, and more.\n//\n// Refer to the official documentation:\n// \u003chttps://developers.stellar.org/docs/build/smart-contracts/overview\u003e.\n#[contractimpl]\nimpl Contract {\n    pub fn hello(env: Env, to: String) -\u003e Vec\u003cString\u003e {\n        vec![\u0026env, String::from_str(\u0026env, \"Hello\"), to]\n    }\n}\n\nmod test;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","analytics.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::invoice::{InvoiceCategory, InvoiceStatus};\nuse soroban_sdk::{contracttype, symbol_short, Address, Bytes, BytesN, Env, String, Vec};\n\n/// Time period for analytics reports\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum TimePeriod {\n    Daily,\n    Weekly,\n    Monthly,\n    Quarterly,\n    Yearly,\n    AllTime,\n}\n\n/// Platform metrics structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct PlatformMetrics {\n    pub total_invoices: u32,\n    pub total_investments: u32,\n    pub total_volume: i128,\n    pub total_fees_collected: i128,\n    pub active_investors: u32,\n    pub verified_businesses: u32,\n    pub average_invoice_amount: i128,\n    pub average_investment_amount: i128,\n    pub platform_fee_rate: i128,\n    pub default_rate: i128,\n    pub success_rate: i128,\n    pub timestamp: u64,\n}\n\n/// User behavior analytics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct UserBehaviorMetrics {\n    pub user_address: Address,\n    pub total_invoices_uploaded: u32,\n    pub total_investments_made: u32,\n    pub total_bids_placed: u32,\n    pub average_bid_amount: i128,\n    pub average_investment_amount: i128,\n    pub success_rate: i128,\n    pub default_rate: i128,\n    pub last_activity: u64,\n    pub preferred_categories: Vec\u003cInvoiceCategory\u003e,\n    pub risk_score: u32,\n}\n\n/// Financial analytics structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct FinancialMetrics {\n    pub total_volume: i128,\n    pub total_fees: i128,\n    pub total_profits: i128,\n    pub average_return_rate: i128,\n    pub volume_by_category: Vec\u003c(InvoiceCategory, i128)\u003e,\n    pub volume_by_period: Vec\u003c(TimePeriod, i128)\u003e,\n    pub fee_breakdown: Vec\u003c(String, i128)\u003e,\n    pub profit_margins: Vec\u003c(String, i128)\u003e,\n    pub currency_distribution: Vec\u003c(Address, i128)\u003e,\n}\n\n/// Performance tracking metrics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct PerformanceMetrics {\n    pub platform_uptime: u64,\n    pub average_settlement_time: u64,\n    pub average_verification_time: u64,\n    pub dispute_resolution_time: u64,\n    pub system_response_time: u64,\n    pub transaction_success_rate: i128,\n    pub error_rate: i128,\n    pub user_satisfaction_score: u32,\n    pub platform_efficiency: i128,\n}\n\n/// Business report structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct BusinessReport {\n    pub report_id: BytesN\u003c32\u003e,\n    pub business_address: Address,\n    pub period: TimePeriod,\n    pub start_date: u64,\n    pub end_date: u64,\n    pub invoices_uploaded: u32,\n    pub invoices_funded: u32,\n    pub total_volume: i128,\n    pub average_funding_time: u64,\n    pub success_rate: i128,\n    pub default_rate: i128,\n    pub category_breakdown: Vec\u003c(InvoiceCategory, u32)\u003e,\n    pub rating_average: Option\u003cu32\u003e,\n    pub total_ratings: u32,\n    pub generated_at: u64,\n}\n\n/// Investor report structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvestorReport {\n    pub report_id: BytesN\u003c32\u003e,\n    pub investor_address: Address,\n    pub period: TimePeriod,\n    pub start_date: u64,\n    pub end_date: u64,\n    pub investments_made: u32,\n    pub total_invested: i128,\n    pub total_returns: i128,\n    pub average_return_rate: i128,\n    pub success_rate: i128,\n    pub default_rate: i128,\n    pub preferred_categories: Vec\u003c(InvoiceCategory, u32)\u003e,\n    pub risk_tolerance: u32,\n    pub portfolio_diversity: i128,\n    pub generated_at: u64,\n}\n\n/// Enhanced investor analytics structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvestorAnalytics {\n    pub investor_address: Address,\n    pub tier: crate::verification::InvestorTier,\n    pub risk_level: crate::verification::InvestorRiskLevel,\n    pub risk_score: u32,\n    pub investment_limit: i128,\n    pub total_invested: i128,\n    pub total_returns: i128,\n    pub successful_investments: u32,\n    pub defaulted_investments: u32,\n    pub success_rate: i128,\n    pub average_investment_size: i128,\n    pub portfolio_diversity_score: u32,\n    pub preferred_categories: Vec\u003c(InvoiceCategory, u32)\u003e,\n    pub last_activity: u64,\n    pub account_age: u64,\n    pub compliance_score: u32,\n    pub generated_at: u64,\n}\n\n/// Investor performance metrics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvestorPerformanceMetrics {\n    pub total_investors: u32,\n    pub verified_investors: u32,\n    pub pending_investors: u32,\n    pub rejected_investors: u32,\n    pub investors_by_tier: Vec\u003c(crate::verification::InvestorTier, u32)\u003e,\n    pub investors_by_risk: Vec\u003c(crate::verification::InvestorRiskLevel, u32)\u003e,\n    pub total_investment_volume: i128,\n    pub average_investment_size: i128,\n    pub platform_success_rate: i128,\n    pub average_risk_score: u32,\n    pub top_performing_investors: Vec\u003cAddress\u003e,\n    pub generated_at: u64,\n}\n\n/// Analytics storage structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AnalyticsData {\n    pub platform_metrics: PlatformMetrics,\n    pub performance_metrics: PerformanceMetrics,\n    pub last_updated: u64,\n    pub data_points: Vec\u003c(u64, PlatformMetrics)\u003e,\n}\n\npub struct AnalyticsStorage;\n\nimpl AnalyticsStorage {\n    fn platform_metrics_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"plt_met\"),)\n    }\n\n    fn performance_metrics_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"perf_met\"),)\n    }\n\n    fn user_behavior_key(user: \u0026Address) -\u003e (soroban_sdk::Symbol, Address) {\n        (symbol_short!(\"usr_beh\"), user.clone())\n    }\n\n    fn business_report_key(report_id: \u0026BytesN\u003c32\u003e) -\u003e (soroban_sdk::Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"biz_rpt\"), report_id.clone())\n    }\n\n    fn investor_report_key(report_id: \u0026BytesN\u003c32\u003e) -\u003e (soroban_sdk::Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"inv_rpt\"), report_id.clone())\n    }\n\n    fn investor_analytics_key(investor: \u0026Address) -\u003e (soroban_sdk::Symbol, Address) {\n        (symbol_short!(\"inv_anal\"), investor.clone())\n    }\n\n    fn investor_performance_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"inv_perf\"),)\n    }\n\n    fn analytics_data_key() -\u003e (soroban_sdk::Symbol,) {\n        (symbol_short!(\"analytics\"),)\n    }\n\n    pub fn store_platform_metrics(env: \u0026Env, metrics: \u0026PlatformMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::platform_metrics_key(), metrics);\n    }\n\n    pub fn get_platform_metrics(env: \u0026Env) -\u003e Option\u003cPlatformMetrics\u003e {\n        env.storage().instance().get(\u0026Self::platform_metrics_key())\n    }\n\n    pub fn store_performance_metrics(env: \u0026Env, metrics: \u0026PerformanceMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::performance_metrics_key(), metrics);\n    }\n\n    pub fn get_performance_metrics(env: \u0026Env) -\u003e Option\u003cPerformanceMetrics\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::performance_metrics_key())\n    }\n\n    pub fn store_user_behavior(env: \u0026Env, user: \u0026Address, behavior: \u0026UserBehaviorMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::user_behavior_key(user), behavior);\n    }\n\n    pub fn store_business_report(env: \u0026Env, report: \u0026BusinessReport) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::business_report_key(\u0026report.report_id), report);\n    }\n\n    pub fn get_business_report(env: \u0026Env, report_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBusinessReport\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::business_report_key(report_id))\n    }\n\n    pub fn store_investor_report(env: \u0026Env, report: \u0026InvestorReport) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::investor_report_key(\u0026report.report_id), report);\n    }\n\n    pub fn get_investor_report(env: \u0026Env, report_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvestorReport\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::investor_report_key(report_id))\n    }\n\n    pub fn store_investor_analytics(env: \u0026Env, investor: \u0026Address, analytics: \u0026InvestorAnalytics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::investor_analytics_key(investor), analytics);\n    }\n\n    pub fn get_investor_analytics(env: \u0026Env, investor: \u0026Address) -\u003e Option\u003cInvestorAnalytics\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::investor_analytics_key(investor))\n    }\n\n    pub fn store_investor_performance(env: \u0026Env, metrics: \u0026InvestorPerformanceMetrics) {\n        env.storage()\n            .instance()\n            .set(\u0026Self::investor_performance_key(), metrics);\n    }\n\n    pub fn get_investor_performance(env: \u0026Env) -\u003e Option\u003cInvestorPerformanceMetrics\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::investor_performance_key())\n    }\n\n    pub fn generate_report_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let sequence = env.ledger().sequence();\n        let _combined = timestamp.wrapping_add(sequence as u64);\n        let bytes = Bytes::new(env);\n        let hash = env.crypto().sha256(\u0026bytes);\n        BytesN::from_array(\u0026env, \u0026hash.to_array())\n    }\n}\n\n/// Analytics calculation functions\npub struct AnalyticsCalculator;\n\nimpl AnalyticsCalculator {\n    /// Calculate comprehensive platform metrics\n    pub fn calculate_platform_metrics(env: \u0026Env) -\u003e Result\u003cPlatformMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Get all invoices by status\n        let pending_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Pending);\n        let verified_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Verified);\n        let funded_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Funded);\n        let paid_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Paid);\n        let defaulted_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Defaulted);\n\n        let total_invoices = (pending_invoices.len()\n            + verified_invoices.len()\n            + funded_invoices.len()\n            + paid_invoices.len()\n            + defaulted_invoices.len()) as u32;\n\n        // Calculate total volume\n        let mut total_volume = 0i128;\n        for invoice_id in [\n            \u0026pending_invoices,\n            \u0026verified_invoices,\n            \u0026funded_invoices,\n            \u0026paid_invoices,\n            \u0026defaulted_invoices,\n        ]\n        .iter()\n        {\n            for id in invoice_id.iter() {\n                if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026id) {\n                    total_volume = total_volume.saturating_add(invoice.amount);\n                }\n            }\n        }\n\n        // Calculate total investments by counting funded invoices\n        let total_investments = funded_invoices.len() as u32;\n\n        // Calculate total fees collected\n        let mut total_fees = 0i128;\n        for invoice_id in paid_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if let Some(investment) =\n                    crate::investment::InvestmentStorage::get_investment_by_invoice(\n                        env,\n                        \u0026invoice_id,\n                    )\n                {\n                    let (_, platform_fee) =\n                        crate::profits::calculate_profit(env, investment.amount, invoice.amount);\n                    total_fees = total_fees.saturating_add(platform_fee);\n                }\n            }\n        }\n\n        // Count active investors (simplified - would need proper tracking)\n        let active_investors = 0u32; // Placeholder - would need investor tracking\n\n        // Count verified businesses\n        let verified_businesses =\n            crate::verification::BusinessVerificationStorage::get_verified_businesses(env);\n        let verified_businesses_count = verified_businesses.len() as u32;\n\n        // Calculate averages\n        let average_invoice_amount = if total_invoices \u003e 0 {\n            total_volume.saturating_div(total_invoices as i128)\n        } else {\n            0\n        };\n\n        let average_investment_amount = if total_investments \u003e 0 {\n            let mut total_invested = 0i128;\n            for invoice_id in funded_invoices.iter() {\n                if let Some(investment) =\n                    crate::investment::InvestmentStorage::get_investment_by_invoice(\n                        env,\n                        \u0026invoice_id,\n                    )\n                {\n                    total_invested = total_invested.saturating_add(investment.amount);\n                }\n            }\n            total_invested.saturating_div(total_investments as i128)\n        } else {\n            0\n        };\n\n        // Get platform fee rate\n        let platform_fee_config = crate::profits::PlatformFee::get_config(env);\n        let platform_fee_rate = platform_fee_config.fee_bps;\n\n        // Calculate default rate\n        let _current_timestamp = env.ledger().timestamp();\n        let default_rate = if total_investments \u003e 0 {\n            let defaulted_count = defaulted_invoices.len() as u32;\n            (defaulted_count.saturating_mul(10000)).saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        // Calculate success rate\n        let success_rate = if total_investments \u003e 0 {\n            let successful_count = paid_invoices.len() as u32;\n            (successful_count.saturating_mul(10000)).saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        Ok(PlatformMetrics {\n            total_invoices,\n            total_investments,\n            total_volume,\n            total_fees_collected: total_fees,\n            active_investors,\n            verified_businesses: verified_businesses_count,\n            average_invoice_amount,\n            average_investment_amount,\n            platform_fee_rate,\n            default_rate,\n            success_rate,\n            timestamp: current_timestamp,\n        })\n    }\n\n    /// Calculate user behavior metrics\n    pub fn calculate_user_behavior_metrics(\n        env: \u0026Env,\n        user: \u0026Address,\n    ) -\u003e Result\u003cUserBehaviorMetrics, QuickLendXError\u003e {\n        let _current_timestamp = env.ledger().timestamp();\n\n        // Get user's invoices\n        let user_invoices = crate::invoice::InvoiceStorage::get_business_invoices(env, user);\n        let total_invoices_uploaded = user_invoices.len() as u32;\n\n        // Get user's investments (simplified - would need proper tracking)\n        let total_investments_made = 0u32; // Placeholder - would need investor tracking\n\n        // Get user's bids (simplified - would need proper tracking)\n        let total_bids_placed = 0u32;\n        let total_bid_amount = 0i128;\n\n        let average_bid_amount = if total_bids_placed \u003e 0 {\n            total_bid_amount.saturating_div(total_bids_placed as i128)\n        } else {\n            0\n        };\n\n        let average_investment_amount = 0i128; // Placeholder\n\n        // Calculate success and default rates (simplified)\n        let preferred_categories = Vec::new(env);\n\n        let success_rate = 0i128; // Placeholder\n\n        let default_rate = 0i128; // Placeholder\n\n        // Calculate risk score based on default rate and investment patterns\n        let risk_score = if default_rate \u003e 1000 {\n            // \u003e 10%\n            100\n        } else if default_rate \u003e 500 {\n            // \u003e 5%\n            75\n        } else if default_rate \u003e 200 {\n            // \u003e 2%\n            50\n        } else {\n            25\n        };\n\n        // Find last activity\n        let mut last_activity = 0u64;\n        for invoice_id in user_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.created_at \u003e last_activity {\n                    last_activity = invoice.created_at;\n                }\n            }\n        }\n\n        Ok(UserBehaviorMetrics {\n            user_address: user.clone(),\n            total_invoices_uploaded,\n            total_investments_made,\n            total_bids_placed,\n            average_bid_amount,\n            average_investment_amount,\n            success_rate,\n            default_rate,\n            last_activity,\n            preferred_categories,\n            risk_score,\n        })\n    }\n\n    /// Calculate financial metrics\n    pub fn calculate_financial_metrics(\n        env: \u0026Env,\n        period: TimePeriod,\n    ) -\u003e Result\u003cFinancialMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let (start_date, end_date) = Self::get_period_dates(current_timestamp, period.clone());\n\n        let mut total_volume = 0i128;\n        let mut total_fees = 0i128;\n        let mut total_profits = 0i128;\n        let mut volume_by_category = Vec::new(env);\n        let mut currency_distribution = Vec::new(env);\n\n        // Initialize category tracking\n        let categories = [\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ];\n\n        for category in categories.iter() {\n            volume_by_category.push_back((category.clone(), 0i128));\n        }\n\n        // Get all invoices in the period by combining all statuses\n        let mut all_invoices = Vec::new(env);\n        for status in [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n        ]\n        .iter()\n        {\n            let invoices = crate::invoice::InvoiceStorage::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                all_invoices.push_back(invoice_id);\n            }\n        }\n        for invoice_id in all_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.created_at \u003e= start_date \u0026\u0026 invoice.created_at \u003c= end_date {\n                    total_volume = total_volume.saturating_add(invoice.amount);\n\n                    // Update category volume\n                    for i in 0..volume_by_category.len() {\n                        let (cat, vol) = volume_by_category.get(i).unwrap();\n                        if cat == invoice.category {\n                            volume_by_category.set(i, (cat, vol.saturating_add(invoice.amount)));\n                            break;\n                        }\n                    }\n\n                    // Track currency distribution\n                    let mut found_currency = false;\n                    for i in 0..currency_distribution.len() {\n                        let (curr, amount): (Address, i128) = currency_distribution.get(i).unwrap();\n                        if curr == invoice.currency {\n                            currency_distribution\n                                .set(i, (curr, amount.saturating_add(invoice.amount)));\n                            found_currency = true;\n                            break;\n                        }\n                    }\n                    if !found_currency {\n                        currency_distribution.push_back((invoice.currency.clone(), invoice.amount));\n                    }\n\n                    // Calculate fees and profits for paid invoices\n                    if invoice.status == InvoiceStatus::Paid {\n                        if let Some(investment) =\n                            crate::investment::InvestmentStorage::get_investment_by_invoice(\n                                env,\n                                \u0026invoice_id,\n                            )\n                        {\n                            let (profit, platform_fee) = crate::profits::calculate_profit(\n                                env,\n                                investment.amount,\n                                invoice.amount,\n                            );\n                            total_fees = total_fees.saturating_add(platform_fee);\n                            total_profits = total_profits.saturating_add(profit);\n                        }\n                    }\n                }\n            }\n        }\n\n        // Calculate average return rate\n        let average_return_rate = if total_volume \u003e 0 {\n            total_profits\n                .saturating_mul(10000)\n                .saturating_div(total_volume)\n        } else {\n            0\n        };\n\n        // Create fee breakdown\n        let mut fee_breakdown = Vec::new(env);\n        fee_breakdown.push_back((String::from_str(env, \"platform_fees\"), total_fees));\n\n        // Create profit margins\n        let mut profit_margins = Vec::new(env);\n        profit_margins.push_back((String::from_str(env, \"gross_profit\"), total_profits));\n        profit_margins.push_back((\n            String::from_str(env, \"net_profit\"),\n            total_profits.saturating_sub(total_fees),\n        ));\n\n        // Create volume by period (simplified for this implementation)\n        let mut volume_by_period = Vec::new(env);\n        volume_by_period.push_back((period, total_volume));\n\n        Ok(FinancialMetrics {\n            total_volume,\n            total_fees,\n            total_profits,\n            average_return_rate,\n            volume_by_category,\n            volume_by_period,\n            fee_breakdown,\n            profit_margins,\n            currency_distribution,\n        })\n    }\n\n    /// Calculate performance metrics\n    pub fn calculate_performance_metrics(env: \u0026Env) -\u003e Result\u003cPerformanceMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Calculate average settlement time (simplified)\n        let total_settlement_time = 0u64;\n        let settlement_count = 0u32;\n\n        let average_settlement_time = if settlement_count \u003e 0 {\n            total_settlement_time.saturating_div(settlement_count as u64)\n        } else {\n            0\n        };\n\n        // Calculate average verification time (simplified)\n        let total_verification_time = 0u64;\n        let verification_count = 0u32;\n\n        let average_verification_time = if verification_count \u003e 0 {\n            total_verification_time.saturating_div(verification_count as u64)\n        } else {\n            0\n        };\n\n        // Calculate dispute resolution time\n        let mut total_dispute_time = 0u64;\n        let mut dispute_count = 0u32;\n        let invoices_with_disputes = crate::defaults::get_invoices_with_disputes(env);\n\n        for invoice_id in invoices_with_disputes.iter() {\n            if let Some(dispute) =\n                crate::defaults::get_dispute_details(env, \u0026invoice_id).unwrap_or(None)\n            {\n                if dispute.resolved_at \u003e 0 {\n                    let resolution_time = dispute.resolved_at.saturating_sub(dispute.created_at);\n                    total_dispute_time = total_dispute_time.saturating_add(resolution_time);\n                    dispute_count += 1;\n                }\n            }\n        }\n\n        let dispute_resolution_time = if dispute_count \u003e 0 {\n            total_dispute_time.saturating_div(dispute_count as u64)\n        } else {\n            0\n        };\n\n        // Calculate transaction success rate\n        let mut total_transactions = 0u32;\n        let mut successful_transactions = 0u32;\n        for status in [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n        ]\n        .iter()\n        {\n            let count =\n                crate::invoice::InvoiceStorage::get_invoices_by_status(env, status).len() as u32;\n            total_transactions += count;\n            if *status == InvoiceStatus::Paid {\n                successful_transactions = count;\n            }\n        }\n        let transaction_success_rate = if total_transactions \u003e 0 {\n            (successful_transactions.saturating_mul(10000)).saturating_div(total_transactions)\n                as i128\n        } else {\n            0\n        };\n\n        // Calculate error rate (simplified)\n        let defaulted_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Defaulted);\n        let error_rate = if total_transactions \u003e 0 {\n            (defaulted_invoices.len() as u32)\n                .saturating_mul(10000)\n                .saturating_div(total_transactions) as i128\n        } else {\n            0\n        };\n\n        // Calculate user satisfaction score (based on ratings)\n        let mut total_rating = 0u32;\n        let mut rating_count = 0u32;\n        let _invoices_with_ratings =\n            crate::invoice::InvoiceStorage::get_invoices_with_ratings_count(env);\n\n        // Get paid invoices for rating calculation\n        let paid_invoices =\n            crate::invoice::InvoiceStorage::get_invoices_by_status(env, \u0026InvoiceStatus::Paid);\n        for invoice_id in paid_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if let Some(avg_rating) = invoice.average_rating {\n                    total_rating = total_rating.saturating_add(avg_rating);\n                    rating_count += 1;\n                }\n            }\n        }\n\n        let user_satisfaction_score = if rating_count \u003e 0 {\n            total_rating.saturating_div(rating_count)\n        } else {\n            0\n        };\n\n        // Calculate platform efficiency\n        let platform_efficiency = {\n            let fee_config = crate::profits::PlatformFee::get_config(env);\n            fee_config.fee_bps\n        };\n\n        Ok(PerformanceMetrics {\n            platform_uptime: current_timestamp, // Simplified - would need more complex tracking\n            average_settlement_time,\n            average_verification_time,\n            dispute_resolution_time,\n            system_response_time: 0, // Would need system-level tracking\n            transaction_success_rate,\n            error_rate,\n            user_satisfaction_score,\n            platform_efficiency,\n        })\n    }\n\n    /// Generate business report\n    pub fn generate_business_report(\n        env: \u0026Env,\n        business: \u0026Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cBusinessReport, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let (start_date, end_date) = Self::get_period_dates(current_timestamp, period.clone());\n        let report_id = AnalyticsStorage::generate_report_id(env);\n\n        // Get business invoices in the period\n        let all_invoices = crate::invoice::InvoiceStorage::get_business_invoices(env, business);\n        let mut invoices_uploaded = 0u32;\n        let mut invoices_funded = 0u32;\n        let mut total_volume = 0i128;\n        let mut total_funding_time = 0u64;\n        let mut successful_invoices = 0u32;\n        let mut defaulted_invoices = 0u32;\n        let mut category_breakdown = Vec::new(env);\n        let mut total_rating = 0u32;\n        let mut rating_count = 0u32;\n\n        // Initialize category tracking\n        let categories = [\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ];\n\n        for category in categories.iter() {\n            category_breakdown.push_back((category.clone(), 0u32));\n        }\n\n        for invoice_id in all_invoices.iter() {\n            if let Some(invoice) = crate::invoice::InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.created_at \u003e= start_date \u0026\u0026 invoice.created_at \u003c= end_date {\n                    invoices_uploaded += 1;\n                    total_volume = total_volume.saturating_add(invoice.amount);\n\n                    // Update category breakdown\n                    for i in 0..category_breakdown.len() {\n                        let (cat, count) = category_breakdown.get(i).unwrap();\n                        if cat == invoice.category {\n                            category_breakdown.set(i, (cat, count.saturating_add(1)));\n                            break;\n                        }\n                    }\n\n                    // Track funding and success\n                    if invoice.status == InvoiceStatus::Funded\n                        || invoice.status == InvoiceStatus::Paid\n                    {\n                        invoices_funded += 1;\n                        if let Some(investment) =\n                            crate::investment::InvestmentStorage::get_investment_by_invoice(\n                                env,\n                                \u0026invoice_id,\n                            )\n                        {\n                            let funding_time =\n                                investment.funded_at.saturating_sub(invoice.created_at);\n                            total_funding_time = total_funding_time.saturating_add(funding_time);\n                        }\n                    }\n\n                    match invoice.status {\n                        InvoiceStatus::Paid =\u003e successful_invoices += 1,\n                        InvoiceStatus::Defaulted =\u003e defaulted_invoices += 1,\n                        _ =\u003e {}\n                    }\n\n                    // Track ratings\n                    if let Some(avg_rating) = invoice.average_rating {\n                        total_rating = total_rating.saturating_add(avg_rating);\n                        rating_count += 1;\n                    }\n                }\n            }\n        }\n\n        let average_funding_time = if invoices_funded \u003e 0 {\n            total_funding_time.saturating_div(invoices_funded as u64)\n        } else {\n            0\n        };\n\n        let success_rate = if invoices_uploaded \u003e 0 {\n            (successful_invoices.saturating_mul(10000)).saturating_div(invoices_uploaded) as i128\n        } else {\n            0\n        };\n\n        let default_rate = if invoices_uploaded \u003e 0 {\n            (defaulted_invoices.saturating_mul(10000)).saturating_div(invoices_uploaded) as i128\n        } else {\n            0\n        };\n\n        let rating_average = if rating_count \u003e 0 {\n            Some(total_rating.saturating_div(rating_count))\n        } else {\n            None\n        };\n\n        Ok(BusinessReport {\n            report_id,\n            business_address: business.clone(),\n            period,\n            start_date,\n            end_date,\n            invoices_uploaded,\n            invoices_funded,\n            total_volume,\n            average_funding_time,\n            success_rate,\n            default_rate,\n            category_breakdown,\n            rating_average,\n            total_ratings: rating_count,\n            generated_at: current_timestamp,\n        })\n    }\n\n    /// Generate investor report\n    pub fn generate_investor_report(\n        env: \u0026Env,\n        investor: \u0026Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cInvestorReport, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let (start_date, end_date) = Self::get_period_dates(current_timestamp, period.clone());\n        let report_id = AnalyticsStorage::generate_report_id(env);\n\n        // Get investor's investments in the period (simplified)\n        let all_investments: Vec\u003ccrate::investment::Investment\u003e = Vec::new(env); // Placeholder - would need proper tracking\n        let mut investments_made = 0u32;\n        let mut total_invested = 0i128;\n        let mut total_returns = 0i128;\n        let mut successful_investments = 0u32;\n        let mut defaulted_investments = 0u32;\n        let mut preferred_categories = Vec::new(env);\n\n        // Initialize category tracking\n        let categories = [\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ];\n\n        for category in categories.iter() {\n            preferred_categories.push_back((category.clone(), 0u32));\n        }\n\n        for investment in all_investments.iter() {\n            if investment.funded_at \u003e= start_date \u0026\u0026 investment.funded_at \u003c= end_date {\n                investments_made += 1;\n                total_invested = total_invested.saturating_add(investment.amount);\n\n                if let Some(invoice) =\n                    crate::invoice::InvoiceStorage::get_invoice(env, \u0026investment.invoice_id)\n                {\n                    // Update category preferences\n                    for i in 0..preferred_categories.len() {\n                        let (cat, count) = preferred_categories.get(i).unwrap();\n                        if cat == invoice.category {\n                            preferred_categories.set(i, (cat, count.saturating_add(1)));\n                            break;\n                        }\n                    }\n\n                    match invoice.status {\n                        InvoiceStatus::Paid =\u003e {\n                            successful_investments += 1;\n                            let (profit, _) = crate::profits::calculate_profit(\n                                env,\n                                investment.amount,\n                                invoice.amount,\n                            );\n                            total_returns = total_returns\n                                .saturating_add(investment.amount.saturating_add(profit));\n                        }\n                        InvoiceStatus::Defaulted =\u003e defaulted_investments += 1,\n                        _ =\u003e {}\n                    }\n                }\n            }\n        }\n\n        let average_return_rate = if total_invested \u003e 0 {\n            let profit = total_returns.saturating_sub(total_invested);\n            profit.saturating_mul(10000).saturating_div(total_invested)\n        } else {\n            0\n        };\n\n        let success_rate = if investments_made \u003e 0 {\n            (successful_investments.saturating_mul(10000)).saturating_div(investments_made) as i128\n        } else {\n            0\n        };\n\n        let default_rate = if investments_made \u003e 0 {\n            (defaulted_investments.saturating_mul(10000)).saturating_div(investments_made) as i128\n        } else {\n            0\n        };\n\n        // Calculate risk tolerance based on investment patterns\n        let risk_tolerance = if default_rate \u003e 1000 {\n            // \u003e 10%\n            100\n        } else if default_rate \u003e 500 {\n            // \u003e 5%\n            75\n        } else if default_rate \u003e 200 {\n            // \u003e 2%\n            50\n        } else {\n            25\n        };\n\n        // Calculate portfolio diversity (simplified)\n        let portfolio_diversity = if investments_made \u003e 0 {\n            let unique_categories = preferred_categories\n                .iter()\n                .filter(|(_, count)| *count \u003e 0)\n                .count() as u32;\n            (unique_categories.saturating_mul(10000)).saturating_div(investments_made) as i128\n        } else {\n            0\n        };\n\n        Ok(InvestorReport {\n            report_id,\n            investor_address: investor.clone(),\n            period,\n            start_date,\n            end_date,\n            investments_made,\n            total_invested,\n            total_returns,\n            average_return_rate,\n            success_rate,\n            default_rate,\n            preferred_categories,\n            risk_tolerance,\n            portfolio_diversity,\n            generated_at: current_timestamp,\n        })\n    }\n\n    /// Get period dates based on time period\n    pub fn get_period_dates(current_timestamp: u64, period: TimePeriod) -\u003e (u64, u64) {\n        match period {\n            TimePeriod::Daily =\u003e {\n                let day_start = current_timestamp.saturating_sub(24 * 60 * 60);\n                (day_start, current_timestamp)\n            }\n            TimePeriod::Weekly =\u003e {\n                let week_start = current_timestamp.saturating_sub(7 * 24 * 60 * 60);\n                (week_start, current_timestamp)\n            }\n            TimePeriod::Monthly =\u003e {\n                let month_start = current_timestamp.saturating_sub(30 * 24 * 60 * 60);\n                (month_start, current_timestamp)\n            }\n            TimePeriod::Quarterly =\u003e {\n                let quarter_start = current_timestamp.saturating_sub(90 * 24 * 60 * 60);\n                (quarter_start, current_timestamp)\n            }\n            TimePeriod::Yearly =\u003e {\n                let year_start = current_timestamp.saturating_sub(365 * 24 * 60 * 60);\n                (year_start, current_timestamp)\n            }\n            TimePeriod::AllTime =\u003e (0, current_timestamp),\n        }\n    }\n\n    /// Calculate comprehensive investor analytics\n    pub fn calculate_investor_analytics(\n        env: \u0026Env,\n        investor: \u0026Address,\n    ) -\u003e Result\u003cInvestorAnalytics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Get investor verification data\n        let verification = crate::verification::InvestorVerificationStorage::get(env, investor)\n            .ok_or(QuickLendXError::KYCNotFound)?;\n\n        // Calculate success rate\n        let total_investments =\n            verification.successful_investments + verification.defaulted_investments;\n        let success_rate = if total_investments \u003e 0 {\n            (verification.successful_investments.saturating_mul(10000))\n                .saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        // Calculate average investment size\n        let average_investment_size = if total_investments \u003e 0 {\n            verification\n                .total_invested\n                .saturating_div(total_investments as i128)\n        } else {\n            0\n        };\n\n        // Calculate portfolio diversity score (simplified)\n        let portfolio_diversity_score = if total_investments \u003e 0 {\n            // In a real implementation, this would analyze category distribution\n            let diversity = if total_investments \u003e 10 {\n                80\n            } else if total_investments \u003e 5 {\n                60\n            } else {\n                40\n            };\n            diversity\n        } else {\n            0\n        };\n\n        // Calculate account age\n        let account_age = current_timestamp.saturating_sub(verification.submitted_at);\n\n        // Calculate compliance score based on various factors\n        let mut compliance_score = 100u32;\n\n        // Reduce score for defaults\n        if verification.defaulted_investments \u003e 0 {\n            let default_rate =\n                (verification.defaulted_investments * 100) / total_investments.max(1);\n            compliance_score = compliance_score.saturating_sub(default_rate);\n        }\n\n        // Reduce score for high risk\n        if verification.risk_score \u003e 75 {\n            compliance_score = compliance_score.saturating_sub(20);\n        } else if verification.risk_score \u003e 50 {\n            compliance_score = compliance_score.saturating_sub(10);\n        }\n\n        // Get preferred categories (simplified - would need actual investment data)\n        let preferred_categories = Vec::new(env);\n\n        Ok(InvestorAnalytics {\n            investor_address: investor.clone(),\n            tier: verification.tier,\n            risk_level: verification.risk_level,\n            risk_score: verification.risk_score,\n            investment_limit: verification.investment_limit,\n            total_invested: verification.total_invested,\n            total_returns: verification.total_returns,\n            successful_investments: verification.successful_investments,\n            defaulted_investments: verification.defaulted_investments,\n            success_rate,\n            average_investment_size,\n            portfolio_diversity_score,\n            preferred_categories,\n            last_activity: verification.last_activity,\n            account_age,\n            compliance_score,\n            generated_at: current_timestamp,\n        })\n    }\n\n    /// Calculate investor performance metrics for the platform\n    pub fn calc_investor_perf_metrics(\n        env: \u0026Env,\n    ) -\u003e Result\u003cInvestorPerformanceMetrics, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n\n        // Get investor counts by status\n        let verified_investors =\n            crate::verification::InvestorVerificationStorage::get_verified_investors(env);\n        let pending_investors =\n            crate::verification::InvestorVerificationStorage::get_pending_investors(env);\n        let rejected_investors =\n            crate::verification::InvestorVerificationStorage::get_rejected_investors(env);\n\n        let total_investors =\n            verified_investors.len() + pending_investors.len() + rejected_investors.len();\n\n        // Calculate investors by tier\n        let mut investors_by_tier = Vec::new(env);\n        let tiers = [\n            crate::verification::InvestorTier::Basic,\n            crate::verification::InvestorTier::Silver,\n            crate::verification::InvestorTier::Gold,\n            crate::verification::InvestorTier::Platinum,\n            crate::verification::InvestorTier::VIP,\n        ];\n\n        for tier in tiers.iter() {\n            let tier_investors =\n                crate::verification::InvestorVerificationStorage::get_investors_by_tier(\n                    env,\n                    tier.clone(),\n                );\n            investors_by_tier.push_back((tier.clone(), tier_investors.len() as u32));\n        }\n\n        // Calculate investors by risk level\n        let mut investors_by_risk = Vec::new(env);\n        let risk_levels = [\n            crate::verification::InvestorRiskLevel::Low,\n            crate::verification::InvestorRiskLevel::Medium,\n            crate::verification::InvestorRiskLevel::High,\n            crate::verification::InvestorRiskLevel::VeryHigh,\n        ];\n\n        for risk_level in risk_levels.iter() {\n            let risk_investors =\n                crate::verification::InvestorVerificationStorage::get_investors_by_risk_level(\n                    env,\n                    risk_level.clone(),\n                );\n            investors_by_risk.push_back((risk_level.clone(), risk_investors.len() as u32));\n        }\n\n        // Calculate total investment volume and average\n        let mut total_investment_volume = 0i128;\n        let mut total_investments = 0u32;\n        let mut total_risk_score = 0u32;\n        let mut successful_investments = 0u32;\n\n        for investor in verified_investors.iter() {\n            if let Some(verification) =\n                crate::verification::InvestorVerificationStorage::get(env, \u0026investor)\n            {\n                total_investment_volume =\n                    total_investment_volume.saturating_add(verification.total_invested);\n                let investor_total =\n                    verification.successful_investments + verification.defaulted_investments;\n                total_investments = total_investments.saturating_add(investor_total);\n                total_risk_score = total_risk_score.saturating_add(verification.risk_score);\n                successful_investments =\n                    successful_investments.saturating_add(verification.successful_investments);\n            }\n        }\n\n        let average_investment_size = if total_investments \u003e 0 {\n            total_investment_volume.saturating_div(total_investments as i128)\n        } else {\n            0\n        };\n\n        let platform_success_rate = if total_investments \u003e 0 {\n            (successful_investments.saturating_mul(10000)).saturating_div(total_investments) as i128\n        } else {\n            0\n        };\n\n        let average_risk_score = if verified_investors.len() \u003e 0 {\n            total_risk_score.saturating_div(verified_investors.len() as u32)\n        } else {\n            0\n        };\n\n        // Get top performing investors (simplified)\n        let mut top_performing_investors = Vec::new(env);\n        for investor in verified_investors.iter() {\n            if let Some(verification) =\n                crate::verification::InvestorVerificationStorage::get(env, \u0026investor)\n            {\n                if verification.successful_investments \u003e 5 \u0026\u0026 verification.risk_score \u003c 30 {\n                    top_performing_investors.push_back(investor);\n                    if top_performing_investors.len() \u003e= 10 {\n                        break;\n                    }\n                }\n            }\n        }\n\n        Ok(InvestorPerformanceMetrics {\n            total_investors: total_investors as u32,\n            verified_investors: verified_investors.len() as u32,\n            pending_investors: pending_investors.len() as u32,\n            rejected_investors: rejected_investors.len() as u32,\n            investors_by_tier,\n            investors_by_risk,\n            total_investment_volume,\n            average_investment_size,\n            platform_success_rate,\n            average_risk_score,\n            top_performing_investors,\n            generated_at: current_timestamp,\n        })\n    }\n}\n","traces":[{"line":178,"address":[12071456],"length":1,"stats":{"Line":0}},{"line":179,"address":[12071464],"length":1,"stats":{"Line":0}},{"line":182,"address":[12073152],"length":1,"stats":{"Line":0}},{"line":183,"address":[12073160],"length":1,"stats":{"Line":0}},{"line":186,"address":[12069056,12069221,12069215],"length":1,"stats":{"Line":0}},{"line":187,"address":[12069077],"length":1,"stats":{"Line":0}},{"line":190,"address":[12070035,12069872,12070041],"length":1,"stats":{"Line":0}},{"line":191,"address":[12069893],"length":1,"stats":{"Line":0}},{"line":194,"address":[12070841,12070835,12070672],"length":1,"stats":{"Line":0}},{"line":195,"address":[12070693],"length":1,"stats":{"Line":0}},{"line":198,"address":[12072559,12072400,12072565],"length":1,"stats":{"Line":0}},{"line":199,"address":[12072421],"length":1,"stats":{"Line":0}},{"line":202,"address":[12073472],"length":1,"stats":{"Line":0}},{"line":203,"address":[12073480],"length":1,"stats":{"Line":0}},{"line":206,"address":[12069232],"length":1,"stats":{"Line":0}},{"line":207,"address":[12069240],"length":1,"stats":{"Line":0}},{"line":210,"address":[12072576,12072846,12072840],"length":1,"stats":{"Line":0}},{"line":211,"address":[12072620],"length":1,"stats":{"Line":0}},{"line":213,"address":[12072646],"length":1,"stats":{"Line":0}},{"line":216,"address":[12071428,12071434,12071168],"length":1,"stats":{"Line":0}},{"line":217,"address":[12071275,12071335,12071203],"length":1,"stats":{"Line":0}},{"line":220,"address":[12073808,12074072,12074078],"length":1,"stats":{"Line":0}},{"line":221,"address":[12073852],"length":1,"stats":{"Line":0}},{"line":223,"address":[12073878],"length":1,"stats":{"Line":0}},{"line":226,"address":[12073124,12072864,12073130],"length":1,"stats":{"Line":0}},{"line":227,"address":[12072899],"length":1,"stats":{"Line":0}},{"line":229,"address":[12072971,12073031],"length":1,"stats":{"Line":0}},{"line":232,"address":[12070864,12071152,12071146],"length":1,"stats":{"Line":0}},{"line":233,"address":[12070921],"length":1,"stats":{"Line":0}},{"line":235,"address":[12070947],"length":1,"stats":{"Line":0}},{"line":238,"address":[12071488,12071767,12071761],"length":1,"stats":{"Line":0}},{"line":239,"address":[12071532],"length":1,"stats":{"Line":0}},{"line":241,"address":[12071558,12071604],"length":1,"stats":{"Line":0}},{"line":244,"address":[12070064,12070348,12070342],"length":1,"stats":{"Line":0}},{"line":245,"address":[12070112],"length":1,"stats":{"Line":0}},{"line":247,"address":[12070249,12070189],"length":1,"stats":{"Line":0}},{"line":250,"address":[12072071,12072065,12071792],"length":1,"stats":{"Line":0}},{"line":251,"address":[12071836],"length":1,"stats":{"Line":0}},{"line":253,"address":[12071862,12071908],"length":1,"stats":{"Line":0}},{"line":256,"address":[12070652,12070646,12070368],"length":1,"stats":{"Line":0}},{"line":257,"address":[12070416],"length":1,"stats":{"Line":0}},{"line":259,"address":[12070493,12070553],"length":1,"stats":{"Line":0}},{"line":262,"address":[12073792,12073504,12073786],"length":1,"stats":{"Line":0}},{"line":263,"address":[12073561],"length":1,"stats":{"Line":0}},{"line":265,"address":[12073587],"length":1,"stats":{"Line":0}},{"line":268,"address":[12072096,12072380,12072374],"length":1,"stats":{"Line":0}},{"line":269,"address":[12072144],"length":1,"stats":{"Line":0}},{"line":271,"address":[12072281,12072221],"length":1,"stats":{"Line":0}},{"line":274,"address":[12074360,12074096,12074366],"length":1,"stats":{"Line":0}},{"line":275,"address":[12074140],"length":1,"stats":{"Line":0}},{"line":277,"address":[12074166],"length":1,"stats":{"Line":0}},{"line":280,"address":[12073450,12073444,12073184],"length":1,"stats":{"Line":0}},{"line":281,"address":[12073219],"length":1,"stats":{"Line":0}},{"line":283,"address":[12073351,12073291],"length":1,"stats":{"Line":0}},{"line":286,"address":[12069848,12069264,12069854],"length":1,"stats":{"Line":0}},{"line":287,"address":[12069286],"length":1,"stats":{"Line":0}},{"line":288,"address":[12069395],"length":1,"stats":{"Line":0}},{"line":289,"address":[12069510],"length":1,"stats":{"Line":0}},{"line":290,"address":[12069527],"length":1,"stats":{"Line":0}},{"line":291,"address":[12069545,12069609],"length":1,"stats":{"Line":0}},{"line":292,"address":[12069744],"length":1,"stats":{"Line":0}},{"line":301,"address":[12089837,12091060,12086688],"length":1,"stats":{"Line":0}},{"line":302,"address":[12086779],"length":1,"stats":{"Line":0}},{"line":305,"address":[12086896],"length":1,"stats":{"Line":0}},{"line":307,"address":[12086924],"length":1,"stats":{"Line":0}},{"line":309,"address":[12086998],"length":1,"stats":{"Line":0}},{"line":311,"address":[12087069],"length":1,"stats":{"Line":0}},{"line":313,"address":[12087140],"length":1,"stats":{"Line":0}},{"line":316,"address":[12087410,12087442,12087302,12087373,12087339,12087687,12087479,12087514,12087211],"length":1,"stats":{"Line":0}},{"line":317,"address":[12087274],"length":1,"stats":{"Line":0}},{"line":318,"address":[12087325],"length":1,"stats":{"Line":0}},{"line":319,"address":[12087396],"length":1,"stats":{"Line":0}},{"line":320,"address":[12087465],"length":1,"stats":{"Line":0}},{"line":323,"address":[12087547],"length":1,"stats":{"Line":0}},{"line":324,"address":[12087579,12087724],"length":1,"stats":{"Line":0}},{"line":331,"address":[12087664],"length":1,"stats":{"Line":0}},{"line":333,"address":[12090586,12087865,12090682],"length":1,"stats":{"Line":0}},{"line":334,"address":[12090781,12090850],"length":1,"stats":{"Line":0}},{"line":335,"address":[12090908,12091029],"length":1,"stats":{"Line":0}},{"line":341,"address":[12087894],"length":1,"stats":{"Line":0}},{"line":344,"address":[12087922],"length":1,"stats":{"Line":0}},{"line":345,"address":[12087962,12088081],"length":1,"stats":{"Line":0}},{"line":346,"address":[12090140,12088180],"length":1,"stats":{"Line":0}},{"line":347,"address":[12090310],"length":1,"stats":{"Line":0}},{"line":353,"address":[12090356,12090461],"length":1,"stats":{"Line":0}},{"line":355,"address":[12090493],"length":1,"stats":{"Line":0}},{"line":361,"address":[12086752],"length":1,"stats":{"Line":0}},{"line":364,"address":[12088221],"length":1,"stats":{"Line":0}},{"line":366,"address":[12088236,12088308],"length":1,"stats":{"Line":0}},{"line":369,"address":[12088315,12088344],"length":1,"stats":{"Line":0}},{"line":370,"address":[12088424,12088353],"length":1,"stats":{"Line":0}},{"line":372,"address":[12088320],"length":1,"stats":{"Line":0}},{"line":375,"address":[12088466,12088404],"length":1,"stats":{"Line":0}},{"line":376,"address":[12088468],"length":1,"stats":{"Line":0}},{"line":377,"address":[12088508,12088557,12088653],"length":1,"stats":{"Line":0}},{"line":378,"address":[12089906],"length":1,"stats":{"Line":0}},{"line":384,"address":[12090065,12089944],"length":1,"stats":{"Line":0}},{"line":387,"address":[12088784],"length":1,"stats":{"Line":0}},{"line":389,"address":[12088442],"length":1,"stats":{"Line":0}},{"line":393,"address":[12088531],"length":1,"stats":{"Line":0}},{"line":394,"address":[12088864],"length":1,"stats":{"Line":0}},{"line":397,"address":[12088914,12088961],"length":1,"stats":{"Line":0}},{"line":398,"address":[12089211,12089065,12089094],"length":1,"stats":{"Line":0}},{"line":399,"address":[12089133,12089104],"length":1,"stats":{"Line":0}},{"line":400,"address":[12089145],"length":1,"stats":{"Line":0}},{"line":402,"address":[12089070],"length":1,"stats":{"Line":0}},{"line":406,"address":[12089122,12089697,12089237],"length":1,"stats":{"Line":0}},{"line":407,"address":[12089619,12089247],"length":1,"stats":{"Line":0}},{"line":408,"address":[12089631],"length":1,"stats":{"Line":0}},{"line":410,"address":[12089213],"length":1,"stats":{"Line":0}},{"line":413,"address":[12089377],"length":1,"stats":{"Line":0}},{"line":416,"address":[12089281],"length":1,"stats":{"Line":0}},{"line":417,"address":[12089297],"length":1,"stats":{"Line":0}},{"line":420,"address":[12089313],"length":1,"stats":{"Line":0}},{"line":421,"address":[12089329],"length":1,"stats":{"Line":0}},{"line":423,"address":[12089345],"length":1,"stats":{"Line":0}},{"line":424,"address":[12089361],"length":1,"stats":{"Line":0}},{"line":430,"address":[12101280,12102546,12102540],"length":1,"stats":{"Line":0}},{"line":434,"address":[12101416],"length":1,"stats":{"Line":0}},{"line":437,"address":[12101530],"length":1,"stats":{"Line":0}},{"line":438,"address":[12101596,12101540],"length":1,"stats":{"Line":0}},{"line":441,"address":[12101323],"length":1,"stats":{"Line":0}},{"line":444,"address":[12101603],"length":1,"stats":{"Line":0}},{"line":445,"address":[12101334],"length":1,"stats":{"Line":0}},{"line":450,"address":[12101614],"length":1,"stats":{"Line":0}},{"line":453,"address":[12101358],"length":1,"stats":{"Line":0}},{"line":456,"address":[12101651],"length":1,"stats":{"Line":0}},{"line":458,"address":[12101382],"length":1,"stats":{"Line":0}},{"line":460,"address":[12101658],"length":1,"stats":{"Line":0}},{"line":466,"address":[12101682],"length":1,"stats":{"Line":0}},{"line":469,"address":[12101684],"length":1,"stats":{"Line":0}},{"line":473,"address":[12101686],"length":1,"stats":{"Line":0}},{"line":477,"address":[12101697],"length":1,"stats":{"Line":0}},{"line":478,"address":[12101785,12101878,12101722],"length":1,"stats":{"Line":0}},{"line":479,"address":[12101974,12102411],"length":1,"stats":{"Line":0}},{"line":480,"address":[12102465,12102538],"length":1,"stats":{"Line":0}},{"line":481,"address":[12102522],"length":1,"stats":{"Line":0}},{"line":486,"address":[12102106],"length":1,"stats":{"Line":0}},{"line":487,"address":[12102012],"length":1,"stats":{"Line":0}},{"line":491,"address":[12102023],"length":1,"stats":{"Line":0}},{"line":495,"address":[12102039],"length":1,"stats":{"Line":0}},{"line":496,"address":[12102047],"length":1,"stats":{"Line":0}},{"line":497,"address":[12102095],"length":1,"stats":{"Line":0}},{"line":502,"address":[12096526,12094032,12091088],"length":1,"stats":{"Line":0}},{"line":506,"address":[12091151],"length":1,"stats":{"Line":0}},{"line":507,"address":[12091308],"length":1,"stats":{"Line":0}},{"line":509,"address":[12091375],"length":1,"stats":{"Line":0}},{"line":510,"address":[12091399],"length":1,"stats":{"Line":0}},{"line":511,"address":[12091423],"length":1,"stats":{"Line":0}},{"line":512,"address":[12091447],"length":1,"stats":{"Line":0}},{"line":513,"address":[12091532,12091484],"length":1,"stats":{"Line":0}},{"line":516,"address":[12091540],"length":1,"stats":{"Line":0}},{"line":526,"address":[12091609,12091689],"length":1,"stats":{"Line":0}},{"line":527,"address":[12091830,12096478],"length":1,"stats":{"Line":0}},{"line":531,"address":[12091855],"length":1,"stats":{"Line":0}},{"line":532,"address":[12091969],"length":1,"stats":{"Line":0}},{"line":539,"address":[12091874],"length":1,"stats":{"Line":0}},{"line":541,"address":[12092126],"length":1,"stats":{"Line":0}},{"line":542,"address":[12096183,12096279,12096116],"length":1,"stats":{"Line":0}},{"line":543,"address":[12096354,12096466],"length":1,"stats":{"Line":0}},{"line":546,"address":[12092152,12092271],"length":1,"stats":{"Line":0}},{"line":547,"address":[12092370,12094082],"length":1,"stats":{"Line":0}},{"line":548,"address":[12094144,12094201],"length":1,"stats":{"Line":0}},{"line":549,"address":[12094211,12094322],"length":1,"stats":{"Line":0}},{"line":552,"address":[12094346],"length":1,"stats":{"Line":0}},{"line":553,"address":[12094535,12094575],"length":1,"stats":{"Line":0}},{"line":554,"address":[12094682],"length":1,"stats":{"Line":0}},{"line":555,"address":[12094744],"length":1,"stats":{"Line":0}},{"line":561,"address":[12094542],"length":1,"stats":{"Line":0}},{"line":562,"address":[12094558,12094829,12095332],"length":1,"stats":{"Line":0}},{"line":563,"address":[12094970,12094996],"length":1,"stats":{"Line":0}},{"line":564,"address":[12095200,12095124],"length":1,"stats":{"Line":0}},{"line":566,"address":[12095337,12095235],"length":1,"stats":{"Line":0}},{"line":567,"address":[12095482],"length":1,"stats":{"Line":0}},{"line":571,"address":[12094977],"length":1,"stats":{"Line":0}},{"line":572,"address":[12095503,12095552],"length":1,"stats":{"Line":0}},{"line":576,"address":[12095664,12095526],"length":1,"stats":{"Line":0}},{"line":577,"address":[12095723],"length":1,"stats":{"Line":0}},{"line":585,"address":[12095773],"length":1,"stats":{"Line":0}},{"line":586,"address":[12095789],"length":1,"stats":{"Line":0}},{"line":588,"address":[12095934],"length":1,"stats":{"Line":0}},{"line":589,"address":[12096003],"length":1,"stats":{"Line":0}},{"line":597,"address":[12092395,12092447],"length":1,"stats":{"Line":0}},{"line":598,"address":[12092591,12092449],"length":1,"stats":{"Line":0}},{"line":600,"address":[12092536],"length":1,"stats":{"Line":0}},{"line":602,"address":[12092423],"length":1,"stats":{"Line":0}},{"line":606,"address":[12092513],"length":1,"stats":{"Line":0}},{"line":607,"address":[12092684,12092617],"length":1,"stats":{"Line":0}},{"line":610,"address":[12092803],"length":1,"stats":{"Line":0}},{"line":611,"address":[12092885,12092818],"length":1,"stats":{"Line":0}},{"line":612,"address":[12093138],"length":1,"stats":{"Line":0}},{"line":613,"address":[12092996],"length":1,"stats":{"Line":0}},{"line":614,"address":[12093023],"length":1,"stats":{"Line":0}},{"line":618,"address":[12093241],"length":1,"stats":{"Line":0}},{"line":619,"address":[12093248],"length":1,"stats":{"Line":0}},{"line":621,"address":[12093655],"length":1,"stats":{"Line":0}},{"line":622,"address":[12093335],"length":1,"stats":{"Line":0}},{"line":623,"address":[12093351],"length":1,"stats":{"Line":0}},{"line":624,"address":[12093367],"length":1,"stats":{"Line":0}},{"line":625,"address":[12093383],"length":1,"stats":{"Line":0}},{"line":626,"address":[12093399],"length":1,"stats":{"Line":0}},{"line":627,"address":[12093455],"length":1,"stats":{"Line":0}},{"line":628,"address":[12093503],"length":1,"stats":{"Line":0}},{"line":629,"address":[12093551],"length":1,"stats":{"Line":0}},{"line":630,"address":[12093599],"length":1,"stats":{"Line":0}},{"line":635,"address":[12098288,12101256,12100693],"length":1,"stats":{"Line":0}},{"line":636,"address":[12098387],"length":1,"stats":{"Line":0}},{"line":639,"address":[12098347],"length":1,"stats":{"Line":0}},{"line":640,"address":[12098493],"length":1,"stats":{"Line":0}},{"line":645,"address":[12098504],"length":1,"stats":{"Line":0}},{"line":649,"address":[12098359],"length":1,"stats":{"Line":0}},{"line":650,"address":[12098516],"length":1,"stats":{"Line":0}},{"line":655,"address":[12098527],"length":1,"stats":{"Line":0}},{"line":659,"address":[12098547],"length":1,"stats":{"Line":0}},{"line":660,"address":[12098559],"length":1,"stats":{"Line":0}},{"line":661,"address":[12098586],"length":1,"stats":{"Line":0}},{"line":663,"address":[12098607,12098770,12098674],"length":1,"stats":{"Line":0}},{"line":664,"address":[12101001],"length":1,"stats":{"Line":0}},{"line":667,"address":[12101035,12101230],"length":1,"stats":{"Line":0}},{"line":668,"address":[12101158,12101085],"length":1,"stats":{"Line":0}},{"line":669,"address":[12101166],"length":1,"stats":{"Line":0}},{"line":670,"address":[12101235,12101199],"length":1,"stats":{"Line":0}},{"line":675,"address":[12098916,12098894],"length":1,"stats":{"Line":0}},{"line":676,"address":[12099022,12098918],"length":1,"stats":{"Line":0}},{"line":678,"address":[12098904],"length":1,"stats":{"Line":0}},{"line":682,"address":[12098957],"length":1,"stats":{"Line":0}},{"line":683,"address":[12098968],"length":1,"stats":{"Line":0}},{"line":684,"address":[12099048],"length":1,"stats":{"Line":0}},{"line":691,"address":[12098979],"length":1,"stats":{"Line":0}},{"line":693,"address":[12099198,12100707],"length":1,"stats":{"Line":0}},{"line":695,"address":[12100796,12100849],"length":1,"stats":{"Line":0}},{"line":696,"address":[12100874,12100894,12100831],"length":1,"stats":{"Line":0}},{"line":697,"address":[12100887],"length":1,"stats":{"Line":0}},{"line":700,"address":[12099208,12099352,12099242],"length":1,"stats":{"Line":0}},{"line":701,"address":[12099301,12099244],"length":1,"stats":{"Line":0}},{"line":704,"address":[12099218],"length":1,"stats":{"Line":0}},{"line":708,"address":[12099275],"length":1,"stats":{"Line":0}},{"line":710,"address":[12099388,12099569,12099354],"length":1,"stats":{"Line":0}},{"line":711,"address":[12099398,12099547],"length":1,"stats":{"Line":0}},{"line":712,"address":[12099503],"length":1,"stats":{"Line":0}},{"line":713,"address":[12099518],"length":1,"stats":{"Line":0}},{"line":715,"address":[12099364],"length":1,"stats":{"Line":0}},{"line":719,"address":[12099417],"length":1,"stats":{"Line":0}},{"line":720,"address":[12099428],"length":1,"stats":{"Line":0}},{"line":721,"address":[12099439,12099586],"length":1,"stats":{"Line":0}},{"line":725,"address":[12099593],"length":1,"stats":{"Line":0}},{"line":727,"address":[12099631,12099794,12099698],"length":1,"stats":{"Line":0}},{"line":728,"address":[12100449,12099893],"length":1,"stats":{"Line":0}},{"line":729,"address":[12100542,12100671,12100503],"length":1,"stats":{"Line":0}},{"line":730,"address":[12100556,12100633],"length":1,"stats":{"Line":0}},{"line":731,"address":[12100673,12100640],"length":1,"stats":{"Line":0}},{"line":736,"address":[12099939,12099918],"length":1,"stats":{"Line":0}},{"line":737,"address":[12100000,12099941],"length":1,"stats":{"Line":0}},{"line":739,"address":[12099928],"length":1,"stats":{"Line":0}},{"line":744,"address":[12099989],"length":1,"stats":{"Line":0}},{"line":745,"address":[12100009],"length":1,"stats":{"Line":0}},{"line":748,"address":[12100155],"length":1,"stats":{"Line":0}},{"line":750,"address":[12100092],"length":1,"stats":{"Line":0}},{"line":751,"address":[12100100],"length":1,"stats":{"Line":0}},{"line":752,"address":[12100108],"length":1,"stats":{"Line":0}},{"line":754,"address":[12100116],"length":1,"stats":{"Line":0}},{"line":755,"address":[12100132],"length":1,"stats":{"Line":0}},{"line":756,"address":[12100148],"length":1,"stats":{"Line":0}},{"line":762,"address":[12077599,12075424,12078932],"length":1,"stats":{"Line":0}},{"line":767,"address":[12075498],"length":1,"stats":{"Line":0}},{"line":768,"address":[12075639],"length":1,"stats":{"Line":0}},{"line":769,"address":[12075706],"length":1,"stats":{"Line":0}},{"line":772,"address":[12075751],"length":1,"stats":{"Line":0}},{"line":773,"address":[12075807],"length":1,"stats":{"Line":0}},{"line":774,"address":[12075818],"length":1,"stats":{"Line":0}},{"line":775,"address":[12075829],"length":1,"stats":{"Line":0}},{"line":776,"address":[12075853],"length":1,"stats":{"Line":0}},{"line":777,"address":[12075865],"length":1,"stats":{"Line":0}},{"line":778,"address":[12075876],"length":1,"stats":{"Line":0}},{"line":779,"address":[12075895],"length":1,"stats":{"Line":0}},{"line":780,"address":[12075946],"length":1,"stats":{"Line":0}},{"line":781,"address":[12075957],"length":1,"stats":{"Line":0}},{"line":784,"address":[12075968],"length":1,"stats":{"Line":0}},{"line":794,"address":[12076037,12076116],"length":1,"stats":{"Line":0}},{"line":795,"address":[12078907,12076257],"length":1,"stats":{"Line":0}},{"line":798,"address":[12076290,12076409],"length":1,"stats":{"Line":0}},{"line":799,"address":[12076508,12077649],"length":1,"stats":{"Line":0}},{"line":800,"address":[12077768,12077711],"length":1,"stats":{"Line":0}},{"line":801,"address":[12077778,12077858],"length":1,"stats":{"Line":0}},{"line":802,"address":[12077928,12077809],"length":1,"stats":{"Line":0}},{"line":805,"address":[12077952],"length":1,"stats":{"Line":0}},{"line":806,"address":[12078152,12078100],"length":1,"stats":{"Line":0}},{"line":807,"address":[12078205],"length":1,"stats":{"Line":0}},{"line":808,"address":[12078254],"length":1,"stats":{"Line":0}},{"line":814,"address":[12078115,12078305],"length":1,"stats":{"Line":0}},{"line":815,"address":[12078363,12078311],"length":1,"stats":{"Line":0}},{"line":817,"address":[12078426,12078456,12078337],"length":1,"stats":{"Line":0}},{"line":818,"address":[12078496],"length":1,"stats":{"Line":0}},{"line":824,"address":[12078538,12078611],"length":1,"stats":{"Line":0}},{"line":826,"address":[12078619],"length":1,"stats":{"Line":0}},{"line":830,"address":[12078369],"length":1,"stats":{"Line":0}},{"line":831,"address":[12078690,12078738],"length":1,"stats":{"Line":0}},{"line":832,"address":[12078772,12078712],"length":1,"stats":{"Line":0}},{"line":837,"address":[12078670,12078802,12078874],"length":1,"stats":{"Line":0}},{"line":838,"address":[12078816],"length":1,"stats":{"Line":0}},{"line":839,"address":[12078879,12078845],"length":1,"stats":{"Line":0}},{"line":845,"address":[12076555,12076533],"length":1,"stats":{"Line":0}},{"line":846,"address":[12076616,12076557],"length":1,"stats":{"Line":0}},{"line":848,"address":[12076543],"length":1,"stats":{"Line":0}},{"line":851,"address":[12076754,12076650,12076596],"length":1,"stats":{"Line":0}},{"line":852,"address":[12076697,12076652],"length":1,"stats":{"Line":0}},{"line":854,"address":[12076626],"length":1,"stats":{"Line":0}},{"line":857,"address":[12076678,12076780,12076884],"length":1,"stats":{"Line":0}},{"line":858,"address":[12076782,12076827],"length":1,"stats":{"Line":0}},{"line":860,"address":[12076756],"length":1,"stats":{"Line":0}},{"line":863,"address":[12077032,12076808,12076897],"length":1,"stats":{"Line":0}},{"line":864,"address":[12076899,12077014],"length":1,"stats":{"Line":0}},{"line":866,"address":[12076886],"length":1,"stats":{"Line":0}},{"line":869,"address":[12077234],"length":1,"stats":{"Line":0}},{"line":870,"address":[12076939],"length":1,"stats":{"Line":0}},{"line":871,"address":[12077003],"length":1,"stats":{"Line":0}},{"line":875,"address":[12077094],"length":1,"stats":{"Line":0}},{"line":876,"address":[12077102],"length":1,"stats":{"Line":0}},{"line":877,"address":[12077109],"length":1,"stats":{"Line":0}},{"line":878,"address":[12077125],"length":1,"stats":{"Line":0}},{"line":879,"address":[12077133],"length":1,"stats":{"Line":0}},{"line":880,"address":[12077149],"length":1,"stats":{"Line":0}},{"line":881,"address":[12077165],"length":1,"stats":{"Line":0}},{"line":882,"address":[12077213],"length":1,"stats":{"Line":0}},{"line":883,"address":[12077227],"length":1,"stats":{"Line":0}},{"line":889,"address":[12082711,12078976,12081595],"length":1,"stats":{"Line":0}},{"line":894,"address":[12079050],"length":1,"stats":{"Line":0}},{"line":895,"address":[12079191],"length":1,"stats":{"Line":0}},{"line":896,"address":[12079258],"length":1,"stats":{"Line":0}},{"line":899,"address":[12079295],"length":1,"stats":{"Line":0}},{"line":900,"address":[12079351],"length":1,"stats":{"Line":0}},{"line":901,"address":[12079362],"length":1,"stats":{"Line":0}},{"line":902,"address":[12079386],"length":1,"stats":{"Line":0}},{"line":903,"address":[12079410],"length":1,"stats":{"Line":0}},{"line":904,"address":[12079421],"length":1,"stats":{"Line":0}},{"line":905,"address":[12079440],"length":1,"stats":{"Line":0}},{"line":908,"address":[12079487],"length":1,"stats":{"Line":0}},{"line":918,"address":[12079635,12079556],"length":1,"stats":{"Line":0}},{"line":919,"address":[12082686,12079776],"length":1,"stats":{"Line":0}},{"line":922,"address":[12079809,12079928],"length":1,"stats":{"Line":0}},{"line":923,"address":[12081627,12079989],"length":1,"stats":{"Line":0}},{"line":924,"address":[12081637,12081729],"length":1,"stats":{"Line":0}},{"line":925,"address":[12081674,12081813],"length":1,"stats":{"Line":0}},{"line":927,"address":[12081829],"length":1,"stats":{"Line":0}},{"line":931,"address":[12081977,12081922],"length":1,"stats":{"Line":0}},{"line":932,"address":[12082178,12082110],"length":1,"stats":{"Line":0}},{"line":933,"address":[12082231],"length":1,"stats":{"Line":0}},{"line":934,"address":[12082280],"length":1,"stats":{"Line":0}},{"line":939,"address":[12082125],"length":1,"stats":{"Line":0}},{"line":941,"address":[12082345,12082408,12082462],"length":1,"stats":{"Line":0}},{"line":944,"address":[12082415],"length":1,"stats":{"Line":0}},{"line":945,"address":[12082431],"length":1,"stats":{"Line":0}},{"line":947,"address":[12082621,12082515],"length":1,"stats":{"Line":0}},{"line":948,"address":[12082541],"length":1,"stats":{"Line":0}},{"line":950,"address":[12082646,12082367],"length":1,"stats":{"Line":0}},{"line":957,"address":[12080023,12080075],"length":1,"stats":{"Line":0}},{"line":958,"address":[12080077,12080167],"length":1,"stats":{"Line":0}},{"line":959,"address":[12080192],"length":1,"stats":{"Line":0}},{"line":961,"address":[12080051],"length":1,"stats":{"Line":0}},{"line":964,"address":[12080331,12080132,12080435],"length":1,"stats":{"Line":0}},{"line":965,"address":[12080333,12080378],"length":1,"stats":{"Line":0}},{"line":967,"address":[12080307],"length":1,"stats":{"Line":0}},{"line":970,"address":[12080359,12080461,12080586],"length":1,"stats":{"Line":0}},{"line":971,"address":[12080529,12080463],"length":1,"stats":{"Line":0}},{"line":973,"address":[12080437],"length":1,"stats":{"Line":0}},{"line":977,"address":[12080632,12080489],"length":1,"stats":{"Line":0}},{"line":979,"address":[12080621],"length":1,"stats":{"Line":0}},{"line":980,"address":[12080588,12080678],"length":1,"stats":{"Line":0}},{"line":982,"address":[12080667],"length":1,"stats":{"Line":0}},{"line":983,"address":[12080634,12080691],"length":1,"stats":{"Line":0}},{"line":985,"address":[12080693],"length":1,"stats":{"Line":0}},{"line":987,"address":[12080680],"length":1,"stats":{"Line":0}},{"line":991,"address":[12080991,12080738,12080704],"length":1,"stats":{"Line":0}},{"line":992,"address":[12080899],"length":1,"stats":{"Line":0}},{"line":993,"address":[12080756],"length":1,"stats":{"Line":0}},{"line":994,"address":[12080861],"length":1,"stats":{"Line":0}},{"line":995,"address":[12080876],"length":1,"stats":{"Line":0}},{"line":996,"address":[12080913],"length":1,"stats":{"Line":0}},{"line":998,"address":[12080714],"length":1,"stats":{"Line":0}},{"line":1001,"address":[12081198],"length":1,"stats":{"Line":0}},{"line":1002,"address":[12080771],"length":1,"stats":{"Line":0}},{"line":1003,"address":[12080835],"length":1,"stats":{"Line":0}},{"line":1007,"address":[12081040],"length":1,"stats":{"Line":0}},{"line":1008,"address":[12081047],"length":1,"stats":{"Line":0}},{"line":1009,"address":[12081063],"length":1,"stats":{"Line":0}},{"line":1010,"address":[12081079],"length":1,"stats":{"Line":0}},{"line":1011,"address":[12081095],"length":1,"stats":{"Line":0}},{"line":1012,"address":[12081111],"length":1,"stats":{"Line":0}},{"line":1013,"address":[12081127],"length":1,"stats":{"Line":0}},{"line":1014,"address":[12081175],"length":1,"stats":{"Line":0}},{"line":1015,"address":[12081182],"length":1,"stats":{"Line":0}},{"line":1021,"address":[12074480],"length":1,"stats":{"Line":0}},{"line":1022,"address":[12074510],"length":1,"stats":{"Line":0}},{"line":1024,"address":[12074733,12074541,12074815],"length":1,"stats":{"Line":0}},{"line":1025,"address":[12074797],"length":1,"stats":{"Line":0}},{"line":1028,"address":[12074980,12074857,12074573],"length":1,"stats":{"Line":0}},{"line":1029,"address":[12074959],"length":1,"stats":{"Line":0}},{"line":1032,"address":[12074605,12074998,12075121],"length":1,"stats":{"Line":0}},{"line":1033,"address":[12075100],"length":1,"stats":{"Line":0}},{"line":1036,"address":[12075139,12075262,12074637],"length":1,"stats":{"Line":0}},{"line":1037,"address":[12075241],"length":1,"stats":{"Line":0}},{"line":1040,"address":[12075280,12074669,12075401],"length":1,"stats":{"Line":0}},{"line":1041,"address":[12075380],"length":1,"stats":{"Line":0}},{"line":1043,"address":[12074706],"length":1,"stats":{"Line":0}},{"line":1048,"address":[12098258,12096560,12098264],"length":1,"stats":{"Line":0}},{"line":1052,"address":[12096626],"length":1,"stats":{"Line":0}},{"line":1055,"address":[12096739,12096846,12096778],"length":1,"stats":{"Line":0}},{"line":1056,"address":[12096752,12096832],"length":1,"stats":{"Line":0}},{"line":1059,"address":[12096957,12096915],"length":1,"stats":{"Line":0}},{"line":1061,"address":[12096950,12097129,12097041],"length":1,"stats":{"Line":0}},{"line":1062,"address":[12097107,12097043],"length":1,"stats":{"Line":0}},{"line":1063,"address":[12097085],"length":1,"stats":{"Line":0}},{"line":1065,"address":[12097017],"length":1,"stats":{"Line":0}},{"line":1069,"address":[12097070,12097155],"length":1,"stats":{"Line":0}},{"line":1070,"address":[12097161,12097223],"length":1,"stats":{"Line":0}},{"line":1072,"address":[12097177],"length":1,"stats":{"Line":0}},{"line":1074,"address":[12097131],"length":1,"stats":{"Line":0}},{"line":1078,"address":[12097252,12097355,12097206],"length":1,"stats":{"Line":0}},{"line":1080,"address":[12097315,12097258],"length":1,"stats":{"Line":0}},{"line":1081,"address":[12097304],"length":1,"stats":{"Line":0}},{"line":1082,"address":[12097297,12097328],"length":1,"stats":{"Line":0}},{"line":1083,"address":[12097330],"length":1,"stats":{"Line":0}},{"line":1085,"address":[12097317],"length":1,"stats":{"Line":0}},{"line":1087,"address":[12097341],"length":1,"stats":{"Line":0}},{"line":1089,"address":[12097241],"length":1,"stats":{"Line":0}},{"line":1093,"address":[12097362,12097273],"length":1,"stats":{"Line":0}},{"line":1096,"address":[12097370],"length":1,"stats":{"Line":0}},{"line":1099,"address":[12097381,12097558],"length":1,"stats":{"Line":0}},{"line":1100,"address":[12097526,12097410],"length":1,"stats":{"Line":0}},{"line":1102,"address":[12097551,12097508],"length":1,"stats":{"Line":0}},{"line":1106,"address":[12097391,12097665],"length":1,"stats":{"Line":0}},{"line":1107,"address":[12097658,12097575],"length":1,"stats":{"Line":0}},{"line":1108,"address":[12097563,12097652],"length":1,"stats":{"Line":0}},{"line":1109,"address":[12097618],"length":1,"stats":{"Line":0}},{"line":1113,"address":[12097611],"length":1,"stats":{"Line":0}},{"line":1115,"address":[12097936],"length":1,"stats":{"Line":0}},{"line":1116,"address":[12097680],"length":1,"stats":{"Line":0}},{"line":1117,"address":[12097727],"length":1,"stats":{"Line":0}},{"line":1118,"address":[12097738],"length":1,"stats":{"Line":0}},{"line":1119,"address":[12097746],"length":1,"stats":{"Line":0}},{"line":1120,"address":[12097753],"length":1,"stats":{"Line":0}},{"line":1121,"address":[12097769],"length":1,"stats":{"Line":0}},{"line":1122,"address":[12097785],"length":1,"stats":{"Line":0}},{"line":1123,"address":[12097801],"length":1,"stats":{"Line":0}},{"line":1124,"address":[12097809],"length":1,"stats":{"Line":0}},{"line":1125,"address":[12097817],"length":1,"stats":{"Line":0}},{"line":1126,"address":[12097833],"length":1,"stats":{"Line":0}},{"line":1127,"address":[12097849],"length":1,"stats":{"Line":0}},{"line":1128,"address":[12097860],"length":1,"stats":{"Line":0}},{"line":1129,"address":[12097908],"length":1,"stats":{"Line":0}},{"line":1131,"address":[12097921],"length":1,"stats":{"Line":0}},{"line":1137,"address":[12082752,12086665,12085873],"length":1,"stats":{"Line":0}},{"line":1140,"address":[12082797],"length":1,"stats":{"Line":0}},{"line":1143,"address":[12082946],"length":1,"stats":{"Line":0}},{"line":1145,"address":[12082967],"length":1,"stats":{"Line":0}},{"line":1147,"address":[12083034],"length":1,"stats":{"Line":0}},{"line":1150,"address":[12083304,12083153,12083090],"length":1,"stats":{"Line":0}},{"line":1154,"address":[12083297],"length":1,"stats":{"Line":0}},{"line":1155,"address":[12083322],"length":1,"stats":{"Line":0}},{"line":1163,"address":[12083375,12083454],"length":1,"stats":{"Line":0}},{"line":1167,"address":[12083603],"length":1,"stats":{"Line":0}},{"line":1169,"address":[12086608,12086545],"length":1,"stats":{"Line":0}},{"line":1173,"address":[12083636],"length":1,"stats":{"Line":0}},{"line":1174,"address":[12083643],"length":1,"stats":{"Line":0}},{"line":1181,"address":[12083688,12083767],"length":1,"stats":{"Line":0}},{"line":1185,"address":[12083907],"length":1,"stats":{"Line":0}},{"line":1187,"address":[12086382,12086445],"length":1,"stats":{"Line":0}},{"line":1191,"address":[12083921],"length":1,"stats":{"Line":0}},{"line":1192,"address":[12083945],"length":1,"stats":{"Line":0}},{"line":1193,"address":[12083956],"length":1,"stats":{"Line":0}},{"line":1194,"address":[12083967],"length":1,"stats":{"Line":0}},{"line":1196,"address":[12083994,12084113],"length":1,"stats":{"Line":0}},{"line":1197,"address":[12085997],"length":1,"stats":{"Line":0}},{"line":1200,"address":[12086156],"length":1,"stats":{"Line":0}},{"line":1201,"address":[12086035],"length":1,"stats":{"Line":0}},{"line":1202,"address":[12086225,12086172],"length":1,"stats":{"Line":0}},{"line":1204,"address":[12086207,12086250],"length":1,"stats":{"Line":0}},{"line":1205,"address":[12086257],"length":1,"stats":{"Line":0}},{"line":1206,"address":[12086322],"length":1,"stats":{"Line":0}},{"line":1207,"address":[12086293],"length":1,"stats":{"Line":0}},{"line":1211,"address":[12084271,12084237],"length":1,"stats":{"Line":0}},{"line":1212,"address":[12084341,12084273],"length":1,"stats":{"Line":0}},{"line":1214,"address":[12084247],"length":1,"stats":{"Line":0}},{"line":1217,"address":[12084319,12084383,12084482],"length":1,"stats":{"Line":0}},{"line":1218,"address":[12084385,12084431],"length":1,"stats":{"Line":0}},{"line":1220,"address":[12084359],"length":1,"stats":{"Line":0}},{"line":1223,"address":[12084504,12084488,12084416],"length":1,"stats":{"Line":0}},{"line":1224,"address":[12084506,12084571],"length":1,"stats":{"Line":0}},{"line":1226,"address":[12084493],"length":1,"stats":{"Line":0}},{"line":1230,"address":[12084544],"length":1,"stats":{"Line":0}},{"line":1231,"address":[12084781,12084685,12085887,12084618],"length":1,"stats":{"Line":0}},{"line":1232,"address":[12084974],"length":1,"stats":{"Line":0}},{"line":1235,"address":[12085054,12085008],"length":1,"stats":{"Line":0}},{"line":1236,"address":[12085064],"length":1,"stats":{"Line":0}},{"line":1237,"address":[12085195],"length":1,"stats":{"Line":0}},{"line":1244,"address":[12085540],"length":1,"stats":{"Line":0}},{"line":1246,"address":[12085255],"length":1,"stats":{"Line":0}},{"line":1247,"address":[12085274],"length":1,"stats":{"Line":0}},{"line":1248,"address":[12085293],"length":1,"stats":{"Line":0}},{"line":1249,"address":[12085341],"length":1,"stats":{"Line":0}},{"line":1250,"address":[12085389],"length":1,"stats":{"Line":0}},{"line":1251,"address":[12085437],"length":1,"stats":{"Line":0}},{"line":1252,"address":[12085453],"length":1,"stats":{"Line":0}},{"line":1253,"address":[12085469],"length":1,"stats":{"Line":0}},{"line":1254,"address":[12085485],"length":1,"stats":{"Line":0}},{"line":1255,"address":[12085492],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":506},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","audit.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::invoice::{Invoice, InvoiceStatus};\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env, String, Vec};\n\n/// Audit operation types\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum AuditOperation {\n    InvoiceCreated,\n    InvoiceUploaded,\n    InvoiceVerified,\n    InvoiceFunded,\n    InvoicePaid,\n    InvoiceDefaulted,\n    InvoiceStatusChanged,\n    InvoiceRated,\n    BidPlaced,\n    BidAccepted,\n    BidWithdrawn,\n    EscrowCreated,\n    EscrowReleased,\n    EscrowRefunded,\n    PaymentProcessed,\n    SettlementCompleted,\n}\n\n/// Audit log entry structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AuditLogEntry {\n    pub audit_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub operation: AuditOperation,\n    pub actor: Address,\n    pub timestamp: u64,\n    pub old_value: Option\u003cString\u003e,\n    pub new_value: Option\u003cString\u003e,\n    pub amount: Option\u003ci128\u003e,\n    pub additional_data: Option\u003cString\u003e,\n    pub block_height: u32,\n    pub transaction_hash: Option\u003cBytesN\u003c32\u003e\u003e,\n}\n\n/// Audit operation filter\n#[contracttype]\n#[derive(Clone, Debug)]\npub enum AuditOperationFilter {\n    Any,\n    Specific(AuditOperation),\n}\n\n/// Audit query filters\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AuditQueryFilter {\n    pub invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    pub operation: AuditOperationFilter,\n    pub actor: Option\u003cAddress\u003e,\n    pub start_timestamp: Option\u003cu64\u003e,\n    pub end_timestamp: Option\u003cu64\u003e,\n}\n\n/// Audit statistics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct AuditStats {\n    pub total_entries: u32,\n    pub operations_count: Vec\u003c(AuditOperation, u32)\u003e,\n    pub unique_actors: u32,\n    pub date_range: (u64, u64),\n}\n\nimpl AuditLogEntry {\n    /// Create a new audit log entry\n    pub fn new(\n        env: \u0026Env,\n        invoice_id: BytesN\u003c32\u003e,\n        operation: AuditOperation,\n        actor: Address,\n        old_value: Option\u003cString\u003e,\n        new_value: Option\u003cString\u003e,\n        amount: Option\u003ci128\u003e,\n        additional_data: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let audit_id = Self::generate_audit_id(env);\n        let timestamp = env.ledger().timestamp();\n        let block_height = env.ledger().sequence();\n\n        Self {\n            audit_id,\n            invoice_id,\n            operation,\n            actor,\n            timestamp,\n            old_value,\n            new_value,\n            amount,\n            additional_data,\n            block_height,\n            transaction_hash: None, // Could be populated if available\n        }\n    }\n\n    /// Generate unique audit ID\n    fn generate_audit_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let sequence = env.ledger().sequence();\n        let counter_key = symbol_short!(\"aud_cnt\");\n        let counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add audit prefix\n        id_bytes[0] = 0xAD; // 'A' for Audit\n        id_bytes[1] = 0x1F; // 'U' for aUdit\n                            // Embed timestamp\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed sequence\n        id_bytes[10..14].copy_from_slice(\u0026sequence.to_be_bytes());\n        // Embed counter\n        id_bytes[14..22].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining with pattern\n        for i in 22..32 {\n            id_bytes[i] = ((timestamp + sequence as u64 + counter + 0xAD1F) % 256) as u8;\n        }\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    /// Validate audit log entry integrity\n    pub fn validate_integrity(\u0026self, env: \u0026Env) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        // Check timestamp is not in future\n        if self.timestamp \u003e env.ledger().timestamp() {\n            return Ok(false);\n        }\n\n        // Check block height is valid\n        if self.block_height \u003e env.ledger().sequence() {\n            return Ok(false);\n        }\n\n        // Validate operation-specific data\n        match self.operation {\n            AuditOperation::InvoiceFunded | AuditOperation::PaymentProcessed =\u003e {\n                if self.amount.is_none() || self.amount.unwrap() \u003c= 0 {\n                    return Ok(false);\n                }\n            }\n            AuditOperation::InvoiceStatusChanged =\u003e {\n                if self.old_value.is_none() || self.new_value.is_none() {\n                    return Ok(false);\n                }\n            }\n            _ =\u003e {}\n        }\n\n        Ok(true)\n    }\n}\n\n/// Audit storage and management\npub struct AuditStorage;\n\nimpl AuditStorage {\n    /// Store an audit log entry\n    pub fn store_audit_entry(env: \u0026Env, entry: \u0026AuditLogEntry) {\n        // Store individual entry\n        env.storage().instance().set(\u0026entry.audit_id, entry);\n\n        // Add to invoice audit trail\n        Self::add_to_invoice_audit_trail(env, \u0026entry.invoice_id, \u0026entry.audit_id);\n\n        // Add to operation index\n        Self::add_to_operation_index(env, \u0026entry.operation, \u0026entry.audit_id);\n\n        // Add to actor index\n        Self::add_to_actor_index(env, \u0026entry.actor, \u0026entry.audit_id);\n\n        // Add to timestamp index\n        Self::add_to_timestamp_index(env, entry.timestamp, \u0026entry.audit_id);\n\n        // Add to global entries list\n        Self::add_to_all_audit_entries(env, \u0026entry.audit_id);\n    }\n\n    /// Get audit entry by ID\n    pub fn get_audit_entry(env: \u0026Env, audit_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cAuditLogEntry\u003e {\n        env.storage().instance().get(audit_id)\n    }\n\n    /// Get audit trail for an invoice\n    pub fn get_invoice_audit_trail(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"inv_aud\"), invoice_id.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get audit entries by operation type\n    pub fn get_audit_entries_by_operation(\n        env: \u0026Env,\n        operation: \u0026AuditOperation,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"op_aud\"), operation.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get audit entries by actor\n    pub fn get_audit_entries_by_actor(env: \u0026Env, actor: \u0026Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"act_aud\"), actor.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Query audit logs with filters\n    pub fn query_audit_logs(\n        env: \u0026Env,\n        filter: \u0026AuditQueryFilter,\n        limit: u32,\n    ) -\u003e Vec\u003cAuditLogEntry\u003e {\n        let mut results = Vec::new(env);\n        let mut count = 0u32;\n\n        // Start with invoice-specific entries if invoice_id is provided\n        let audit_ids = if let Some(invoice_id) = \u0026filter.invoice_id {\n            Self::get_invoice_audit_trail(env, invoice_id)\n        } else if let AuditOperationFilter::Specific(operation) = \u0026filter.operation {\n            Self::get_audit_entries_by_operation(env, operation)\n        } else if let Some(actor) = \u0026filter.actor {\n            Self::get_audit_entries_by_actor(env, actor)\n        } else {\n            // Get all audit entries (expensive operation)\n            Self::get_all_audit_entries(env)\n        };\n\n        for audit_id in audit_ids.iter() {\n            if count \u003e= limit {\n                break;\n            }\n\n            if let Some(entry) = Self::get_audit_entry(env, \u0026audit_id) {\n                // Apply filters\n                if Self::matches_filter(\u0026entry, filter) {\n                    results.push_back(entry);\n                    count += 1;\n                }\n            }\n        }\n\n        results\n    }\n\n    /// Get audit statistics\n    pub fn get_audit_stats(env: \u0026Env) -\u003e AuditStats {\n        let all_entries = Self::get_all_audit_entries(env);\n        let total_entries = all_entries.len() as u32;\n\n        let operations_count = Vec::new(env);\n        let mut unique_actors: Vec\u003cAddress\u003e = Vec::new(env);\n        let mut min_timestamp = u64::MAX;\n        let mut max_timestamp = 0u64;\n\n        for audit_id in all_entries.iter() {\n            if let Some(entry) = Self::get_audit_entry(env, \u0026audit_id) {\n                // Track unique actors\n                if !unique_actors.iter().any(|a| a == entry.actor) {\n                    unique_actors.push_back(entry.actor.clone());\n                }\n\n                // Update timestamp range\n                if entry.timestamp \u003c min_timestamp {\n                    min_timestamp = entry.timestamp;\n                }\n                if entry.timestamp \u003e max_timestamp {\n                    max_timestamp = entry.timestamp;\n                }\n            }\n        }\n\n        AuditStats {\n            total_entries,\n            operations_count,\n            unique_actors: unique_actors.len() as u32,\n            date_range: (min_timestamp, max_timestamp),\n        }\n    }\n\n    /// Validate audit log integrity for an invoice\n    pub fn validate_invoice_audit_integrity(\n        env: \u0026Env,\n        invoice_id: \u0026BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let audit_trail = Self::get_invoice_audit_trail(env, invoice_id);\n\n        for audit_id in audit_trail.iter() {\n            if let Some(entry) = Self::get_audit_entry(env, \u0026audit_id) {\n                if !entry.validate_integrity(env)? {\n                    return Ok(false);\n                }\n            } else {\n                return Ok(false); // Missing audit entry\n            }\n        }\n\n        Ok(true)\n    }\n\n    // Helper methods\n    fn add_to_invoice_audit_trail(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"inv_aud\"), invoice_id.clone());\n        let mut trail = Self::get_invoice_audit_trail(env, invoice_id);\n        trail.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026trail);\n    }\n\n    fn add_to_operation_index(env: \u0026Env, operation: \u0026AuditOperation, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"op_aud\"), operation.clone());\n        let mut entries = Self::get_audit_entries_by_operation(env, operation);\n        entries.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026entries);\n    }\n\n    fn add_to_actor_index(env: \u0026Env, actor: \u0026Address, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"act_aud\"), actor.clone());\n        let mut entries = Self::get_audit_entries_by_actor(env, actor);\n        entries.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026entries);\n    }\n\n    fn add_to_timestamp_index(env: \u0026Env, timestamp: u64, audit_id: \u0026BytesN\u003c32\u003e) {\n        let day_key = timestamp / 86400; // Group by day\n        let key = (symbol_short!(\"ts_aud\"), day_key);\n        let mut entries: Vec\u003cBytesN\u003c32\u003e\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env));\n        entries.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026entries);\n    }\n\n    fn add_to_all_audit_entries(env: \u0026Env, audit_id: \u0026BytesN\u003c32\u003e) {\n        let key = symbol_short!(\"all_aud\");\n        let mut all: Vec\u003cBytesN\u003c32\u003e\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env));\n        all.push_back(audit_id.clone());\n        env.storage().instance().set(\u0026key, \u0026all);\n    }\n\n    fn get_all_audit_entries(env: \u0026Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = symbol_short!(\"all_aud\");\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    fn matches_filter(entry: \u0026AuditLogEntry, filter: \u0026AuditQueryFilter) -\u003e bool {\n        if let Some(invoice_id) = \u0026filter.invoice_id {\n            if entry.invoice_id != *invoice_id {\n                return false;\n            }\n        }\n\n        match \u0026filter.operation {\n            AuditOperationFilter::Any =\u003e {}\n            AuditOperationFilter::Specific(operation) =\u003e {\n                if entry.operation != *operation {\n                    return false;\n                }\n            }\n        }\n\n        if let Some(actor) = \u0026filter.actor {\n            if entry.actor != *actor {\n                return false;\n            }\n        }\n\n        if let Some(start_ts) = filter.start_timestamp {\n            if entry.timestamp \u003c start_ts {\n                return false;\n            }\n        }\n\n        if let Some(end_ts) = filter.end_timestamp {\n            if entry.timestamp \u003e end_ts {\n                return false;\n            }\n        }\n\n        true\n    }\n}\n\n/// Audit trail helper functions\npub fn log_invoice_operation(\n    env: \u0026Env,\n    invoice_id: BytesN\u003c32\u003e,\n    operation: AuditOperation,\n    actor: Address,\n    old_value: Option\u003cString\u003e,\n    new_value: Option\u003cString\u003e,\n    amount: Option\u003ci128\u003e,\n    additional_data: Option\u003cString\u003e,\n) {\n    let entry = AuditLogEntry::new(\n        env,\n        invoice_id,\n        operation,\n        actor,\n        old_value,\n        new_value,\n        amount,\n        additional_data,\n    );\n\n    AuditStorage::store_audit_entry(env, \u0026entry);\n}\n\n/// Log invoice creation\npub fn log_invoice_created(env: \u0026Env, invoice: \u0026Invoice) {\n    log_invoice_operation(\n        env,\n        invoice.id.clone(),\n        AuditOperation::InvoiceCreated,\n        invoice.business.clone(),\n        None,\n        Some(String::from_str(env, \"Invoice created\")),\n        Some(invoice.amount),\n        Some(invoice.description.clone()),\n    );\n}\n\n/// Log invoice status change\npub fn log_invoice_status_change(\n    env: \u0026Env,\n    invoice_id: BytesN\u003c32\u003e,\n    actor: Address,\n    _old_status: InvoiceStatus,\n    _new_status: InvoiceStatus,\n) {\n    let old_value = String::from_str(env, \"Status changed\");\n    let new_value = String::from_str(env, \"Status updated\");\n\n    log_invoice_operation(\n        env,\n        invoice_id,\n        AuditOperation::InvoiceStatusChanged,\n        actor,\n        Some(old_value),\n        Some(new_value),\n        None,\n        None,\n    );\n}\n\n/// Log invoice funding\npub fn log_invoice_funded(env: \u0026Env, invoice_id: BytesN\u003c32\u003e, investor: Address, amount: i128) {\n    log_invoice_operation(\n        env,\n        invoice_id,\n        AuditOperation::InvoiceFunded,\n        investor,\n        None,\n        Some(String::from_str(env, \"Funded\")),\n        Some(amount),\n        None,\n    );\n}\n\n/// Log payment processing\npub fn log_payment_processed(\n    env: \u0026Env,\n    invoice_id: BytesN\u003c32\u003e,\n    actor: Address,\n    amount: i128,\n    payment_type: String,\n) {\n    log_invoice_operation(\n        env,\n        invoice_id,\n        AuditOperation::PaymentProcessed,\n        actor,\n        None,\n        Some(String::from_str(env, \"Payment processed\")),\n        Some(amount),\n        Some(payment_type),\n    );\n}\n","traces":[{"line":75,"address":[15264076,15264146,15262944],"length":1,"stats":{"Line":1}},{"line":85,"address":[15263131],"length":1,"stats":{"Line":1}},{"line":86,"address":[15263240,15263192],"length":1,"stats":{"Line":2}},{"line":87,"address":[15263350],"length":1,"stats":{"Line":1}},{"line":105,"address":[15262344,15260416,15262338],"length":1,"stats":{"Line":1}},{"line":106,"address":[15260471],"length":1,"stats":{"Line":1}},{"line":107,"address":[15260604],"length":1,"stats":{"Line":1}},{"line":108,"address":[15260718],"length":1,"stats":{"Line":1}},{"line":109,"address":[15260822,15260771],"length":1,"stats":{"Line":2}},{"line":110,"address":[15261079],"length":1,"stats":{"Line":1}},{"line":112,"address":[15261334],"length":1,"stats":{"Line":1}},{"line":114,"address":[15261354],"length":1,"stats":{"Line":1}},{"line":115,"address":[15261362],"length":1,"stats":{"Line":1}},{"line":117,"address":[15261370],"length":1,"stats":{"Line":1}},{"line":119,"address":[15261556],"length":1,"stats":{"Line":1}},{"line":121,"address":[15261730],"length":1,"stats":{"Line":1}},{"line":123,"address":[15262302,15261886],"length":1,"stats":{"Line":2}},{"line":124,"address":[15262148,15262048,15262312],"length":1,"stats":{"Line":2}},{"line":126,"address":[15262086],"length":1,"stats":{"Line":1}},{"line":130,"address":[15262915,15262921,15262368],"length":1,"stats":{"Line":0}},{"line":132,"address":[15262577,15262401],"length":1,"stats":{"Line":0}},{"line":133,"address":[15262588],"length":1,"stats":{"Line":0}},{"line":137,"address":[15262727,15262529,15262603],"length":1,"stats":{"Line":0}},{"line":138,"address":[15262741],"length":1,"stats":{"Line":0}},{"line":142,"address":[15262681],"length":1,"stats":{"Line":0}},{"line":144,"address":[15262853,15262770],"length":1,"stats":{"Line":0}},{"line":145,"address":[15262903],"length":1,"stats":{"Line":0}},{"line":149,"address":[15262786],"length":1,"stats":{"Line":0}},{"line":150,"address":[15262825],"length":1,"stats":{"Line":0}},{"line":156,"address":[15262753],"length":1,"stats":{"Line":0}},{"line":165,"address":[15253552,15253882,15253876],"length":1,"stats":{"Line":1}},{"line":167,"address":[15253594],"length":1,"stats":{"Line":1}},{"line":170,"address":[15253753],"length":1,"stats":{"Line":1}},{"line":173,"address":[15253778],"length":1,"stats":{"Line":2}},{"line":176,"address":[15253806],"length":1,"stats":{"Line":1}},{"line":179,"address":[15253834],"length":1,"stats":{"Line":1}},{"line":182,"address":[15253859],"length":1,"stats":{"Line":2}},{"line":186,"address":[15251050,15251044,15250832],"length":1,"stats":{"Line":0}},{"line":187,"address":[15250959,15250877],"length":1,"stats":{"Line":0}},{"line":191,"address":[15256948,15256352,15256942],"length":1,"stats":{"Line":1}},{"line":192,"address":[15256401],"length":1,"stats":{"Line":1}},{"line":193,"address":[15256600],"length":1,"stats":{"Line":1}},{"line":195,"address":[15256729],"length":1,"stats":{"Line":1}},{"line":196,"address":[12250449,12250432],"length":1,"stats":{"Line":3}},{"line":200,"address":[15259494,15259488,15258944],"length":1,"stats":{"Line":1}},{"line":204,"address":[15258995],"length":1,"stats":{"Line":2}},{"line":205,"address":[15259146],"length":1,"stats":{"Line":1}},{"line":207,"address":[15259275],"length":1,"stats":{"Line":2}},{"line":208,"address":[12250593,12250576],"length":1,"stats":{"Line":4}},{"line":212,"address":[15258928,15258336,15258922],"length":1,"stats":{"Line":2}},{"line":213,"address":[15258385],"length":1,"stats":{"Line":1}},{"line":214,"address":[15258580],"length":1,"stats":{"Line":2}},{"line":216,"address":[15258709],"length":1,"stats":{"Line":1}},{"line":217,"address":[12250545,12250528],"length":1,"stats":{"Line":4}},{"line":221,"address":[15253435,15253523,15252320],"length":1,"stats":{"Line":0}},{"line":226,"address":[15252374],"length":1,"stats":{"Line":0}},{"line":227,"address":[15252413],"length":1,"stats":{"Line":0}},{"line":230,"address":[15252424],"length":1,"stats":{"Line":0}},{"line":231,"address":[15252580,15252485],"length":1,"stats":{"Line":0}},{"line":232,"address":[15252618,15252497],"length":1,"stats":{"Line":0}},{"line":233,"address":[15252683,15252634],"length":1,"stats":{"Line":0}},{"line":234,"address":[15252646,15252695],"length":1,"stats":{"Line":0}},{"line":235,"address":[15252711,15252738],"length":1,"stats":{"Line":0}},{"line":238,"address":[15252743,15252731],"length":1,"stats":{"Line":0}},{"line":241,"address":[15252904,15252598,15252808],"length":1,"stats":{"Line":0}},{"line":242,"address":[15252961],"length":1,"stats":{"Line":0}},{"line":246,"address":[15253011,15253081,15253397],"length":1,"stats":{"Line":0}},{"line":248,"address":[15253176,15253367,15253254],"length":1,"stats":{"Line":0}},{"line":249,"address":[15253276],"length":1,"stats":{"Line":0}},{"line":250,"address":[15253336,15253369],"length":1,"stats":{"Line":0}},{"line":255,"address":[15253446],"length":1,"stats":{"Line":0}},{"line":259,"address":[15252303,15251072,15251833],"length":1,"stats":{"Line":0}},{"line":260,"address":[15251102],"length":1,"stats":{"Line":0}},{"line":261,"address":[15251130,15251191],"length":1,"stats":{"Line":0}},{"line":263,"address":[15251203],"length":1,"stats":{"Line":0}},{"line":264,"address":[15251223],"length":1,"stats":{"Line":0}},{"line":265,"address":[15251280],"length":1,"stats":{"Line":0}},{"line":266,"address":[15251292],"length":1,"stats":{"Line":0}},{"line":268,"address":[15251474,15251381,15251317],"length":1,"stats":{"Line":0}},{"line":269,"address":[15251570,15251883],"length":1,"stats":{"Line":0}},{"line":271,"address":[12250208,12250235],"length":1,"stats":{"Line":0}},{"line":272,"address":[15252144],"length":1,"stats":{"Line":0}},{"line":276,"address":[15252196,15252250],"length":1,"stats":{"Line":0}},{"line":277,"address":[15252234],"length":1,"stats":{"Line":0}},{"line":279,"address":[15252286,15252214],"length":1,"stats":{"Line":0}},{"line":280,"address":[15252270],"length":1,"stats":{"Line":0}},{"line":288,"address":[15251653],"length":1,"stats":{"Line":0}},{"line":289,"address":[15251717],"length":1,"stats":{"Line":0}},{"line":294,"address":[15260399,15259520,15260362],"length":1,"stats":{"Line":0}},{"line":298,"address":[15259564],"length":1,"stats":{"Line":0}},{"line":300,"address":[15259582,15259643,15259733],"length":1,"stats":{"Line":0}},{"line":301,"address":[15259929,15259829],"length":1,"stats":{"Line":0}},{"line":302,"address":[15260320,15260088,15260016],"length":1,"stats":{"Line":0}},{"line":303,"address":[15260252],"length":1,"stats":{"Line":0}},{"line":306,"address":[15260028],"length":1,"stats":{"Line":0}},{"line":310,"address":[15259851],"length":1,"stats":{"Line":0}},{"line":314,"address":[15258323,15258317,15257696],"length":1,"stats":{"Line":1}},{"line":315,"address":[15257742],"length":1,"stats":{"Line":1}},{"line":316,"address":[15257946],"length":1,"stats":{"Line":1}},{"line":317,"address":[15257995,15258055],"length":1,"stats":{"Line":2}},{"line":318,"address":[15258095],"length":1,"stats":{"Line":1}},{"line":321,"address":[15254992,15255584,15255578],"length":1,"stats":{"Line":1}},{"line":322,"address":[15255051],"length":1,"stats":{"Line":1}},{"line":323,"address":[15255207],"length":1,"stats":{"Line":2}},{"line":324,"address":[15255316,15255256],"length":1,"stats":{"Line":3}},{"line":325,"address":[15255356],"length":1,"stats":{"Line":2}},{"line":328,"address":[15254527,15253904,15254521],"length":1,"stats":{"Line":1}},{"line":329,"address":[15253950],"length":1,"stats":{"Line":2}},{"line":330,"address":[15254150],"length":1,"stats":{"Line":1}},{"line":331,"address":[15254259,15254199],"length":1,"stats":{"Line":3}},{"line":332,"address":[15254299],"length":1,"stats":{"Line":2}},{"line":335,"address":[15255600,15256322,15256328],"length":1,"stats":{"Line":2}},{"line":336,"address":[15255656],"length":1,"stats":{"Line":1}},{"line":337,"address":[15255671],"length":1,"stats":{"Line":2}},{"line":341,"address":[15255850],"length":1,"stats":{"Line":1}},{"line":342,"address":[12250401,12250384],"length":1,"stats":{"Line":3}},{"line":343,"address":[15256051],"length":1,"stats":{"Line":2}},{"line":344,"address":[15256106],"length":1,"stats":{"Line":1}},{"line":347,"address":[15257665,15257671,15256976],"length":1,"stats":{"Line":1}},{"line":348,"address":[15257014],"length":1,"stats":{"Line":1}},{"line":352,"address":[15257192],"length":1,"stats":{"Line":2}},{"line":353,"address":[12250497,12250480],"length":1,"stats":{"Line":3}},{"line":354,"address":[15257393],"length":1,"stats":{"Line":1}},{"line":355,"address":[15257448],"length":1,"stats":{"Line":2}},{"line":358,"address":[15254970,15254976,15254544],"length":1,"stats":{"Line":0}},{"line":359,"address":[15254574],"length":1,"stats":{"Line":0}},{"line":360,"address":[15254618],"length":1,"stats":{"Line":0}},{"line":362,"address":[15254752],"length":1,"stats":{"Line":0}},{"line":363,"address":[12250336,12250353],"length":1,"stats":{"Line":0}},{"line":366,"address":[15250432],"length":1,"stats":{"Line":0}},{"line":367,"address":[15250456],"length":1,"stats":{"Line":0}},{"line":368,"address":[15250506],"length":1,"stats":{"Line":0}},{"line":369,"address":[15250566],"length":1,"stats":{"Line":0}},{"line":373,"address":[15250524],"length":1,"stats":{"Line":0}},{"line":375,"address":[15250592],"length":1,"stats":{"Line":0}},{"line":376,"address":[15250597],"length":1,"stats":{"Line":0}},{"line":377,"address":[15250654],"length":1,"stats":{"Line":0}},{"line":382,"address":[15250618,15250670],"length":1,"stats":{"Line":0}},{"line":383,"address":[15250675],"length":1,"stats":{"Line":0}},{"line":384,"address":[15250708],"length":1,"stats":{"Line":0}},{"line":388,"address":[15250728,15250697],"length":1,"stats":{"Line":0}},{"line":389,"address":[15250737],"length":1,"stats":{"Line":0}},{"line":390,"address":[15250763],"length":1,"stats":{"Line":0}},{"line":394,"address":[15250751,15250783],"length":1,"stats":{"Line":0}},{"line":395,"address":[15250792],"length":1,"stats":{"Line":0}},{"line":400,"address":[15250816],"length":1,"stats":{"Line":0}},{"line":405,"address":[15271019,15270560],"length":1,"stats":{"Line":1}},{"line":426,"address":[15270957],"length":1,"stats":{"Line":1}},{"line":430,"address":[15265434,15264800,15265496],"length":1,"stats":{"Line":1}},{"line":433,"address":[15264865],"length":1,"stats":{"Line":1}},{"line":435,"address":[15264961,15264896],"length":1,"stats":{"Line":2}},{"line":436,"address":[15264969],"length":1,"stats":{"Line":1}},{"line":437,"address":[15264985,15265058],"length":1,"stats":{"Line":2}},{"line":438,"address":[15265114],"length":1,"stats":{"Line":1}},{"line":439,"address":[15265138,15265216],"length":1,"stats":{"Line":2}},{"line":444,"address":[15272356,15271728,15272322],"length":1,"stats":{"Line":1}},{"line":451,"address":[15271888,15271778],"length":1,"stats":{"Line":3}},{"line":452,"address":[15271896],"length":1,"stats":{"Line":2}},{"line":456,"address":[15271976],"length":1,"stats":{"Line":3}},{"line":458,"address":[15272019],"length":1,"stats":{"Line":3}},{"line":459,"address":[15272062],"length":1,"stats":{"Line":3}},{"line":460,"address":[15272157],"length":1,"stats":{"Line":3}},{"line":462,"address":[15272205],"length":1,"stats":{"Line":3}},{"line":467,"address":[15264730,15264256,15264767],"length":1,"stats":{"Line":1}},{"line":470,"address":[15264332],"length":1,"stats":{"Line":2}},{"line":472,"address":[15264366],"length":1,"stats":{"Line":1}},{"line":473,"address":[15264409],"length":1,"stats":{"Line":2}},{"line":474,"address":[15264508,15264425],"length":1,"stats":{"Line":3}},{"line":476,"address":[15264556],"length":1,"stats":{"Line":1}},{"line":481,"address":[15271040,15271688,15271623],"length":1,"stats":{"Line":1}},{"line":490,"address":[15271137],"length":1,"stats":{"Line":1}},{"line":492,"address":[15271171],"length":1,"stats":{"Line":1}},{"line":493,"address":[15271214],"length":1,"stats":{"Line":1}},{"line":494,"address":[15271230,15271318],"length":1,"stats":{"Line":2}},{"line":496,"address":[15271366],"length":1,"stats":{"Line":1}}],"covered":98,"coverable":175},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","backup.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::invoice::Invoice;\nuse soroban_sdk::{contracttype, symbol_short, BytesN, Env, String, Vec};\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Backup {\n    pub backup_id: BytesN\u003c32\u003e,\n    pub timestamp: u64,\n    pub description: String,\n    pub invoice_count: u32,\n    pub status: BackupStatus,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum BackupStatus {\n    Active,\n    Archived,\n    Corrupted,\n}\n\npub struct BackupStorage;\n\nimpl BackupStorage {\n    /// Generate a unique backup ID\n    pub fn generate_backup_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"bkup_cnt\");\n        let counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add backup prefix\n        id_bytes[0] = 0xB4; // 'B' for Backup\n        id_bytes[1] = 0xC4; // 'C' for baCkup\n                            // Embed timestamp\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter\n        id_bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes\n        for i in 18..32 {\n            id_bytes[i] = ((timestamp + counter + 0xB4C4) % 256) as u8;\n        }\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    /// Store a backup record\n    pub fn store_backup(env: \u0026Env, backup: \u0026Backup) {\n        env.storage().instance().set(\u0026backup.backup_id, backup);\n    }\n\n    /// Get a backup by ID\n    pub fn get_backup(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBackup\u003e {\n        env.storage().instance().get(backup_id)\n    }\n\n    /// Update a backup record\n    pub fn update_backup(env: \u0026Env, backup: \u0026Backup) {\n        env.storage().instance().set(\u0026backup.backup_id, backup);\n    }\n\n    /// Get all backup IDs\n    pub fn get_all_backups(env: \u0026Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = symbol_short!(\"backups\");\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Add backup to the list of all backups\n    pub fn add_to_backup_list(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) {\n        let mut backups = Self::get_all_backups(env);\n        backups.push_back(backup_id.clone());\n        env.storage()\n            .instance()\n            .set(\u0026symbol_short!(\"backups\"), \u0026backups);\n    }\n\n    /// Remove backup from the list (when archived or corrupted)\n    pub fn remove_from_backup_list(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) {\n        let backups = Self::get_all_backups(env);\n        let mut new_backups = Vec::new(env);\n        for id in backups.iter() {\n            if id != *backup_id {\n                new_backups.push_back(id);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026symbol_short!(\"backups\"), \u0026new_backups);\n    }\n\n    /// Store invoice data for a backup\n    pub fn store_backup_data(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, invoices: \u0026Vec\u003cInvoice\u003e) {\n        let key = (symbol_short!(\"bkup_data\"), backup_id.clone());\n        env.storage().instance().set(\u0026key, invoices);\n    }\n\n    /// Get invoice data from a backup\n    pub fn get_backup_data(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cVec\u003cInvoice\u003e\u003e {\n        let key = (symbol_short!(\"bkup_data\"), backup_id.clone());\n        env.storage().instance().get(\u0026key)\n    }\n\n    /// Validate backup data integrity\n    pub fn validate_backup(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let backup = Self::get_backup(env, backup_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        let data =\n            Self::get_backup_data(env, backup_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Check if count matches\n        if data.len() as u32 != backup.invoice_count {\n            return Err(QuickLendXError::StorageError);\n        }\n\n        // Check each invoice has valid data\n        for invoice in data.iter() {\n            if invoice.amount \u003c= 0 {\n                return Err(QuickLendXError::StorageError);\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Clean up old backups (keep only the last N)\n    pub fn cleanup_old_backups(env: \u0026Env, max_backups: u32) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let backups = Self::get_all_backups(env);\n        let max_backups: usize = max_backups.try_into().unwrap();\n\n        if backups.len() \u003c= max_backups.try_into().unwrap() {\n            return Ok(());\n        }\n\n        // Create a vector of tuples (backup_id, timestamp) for sorting\n        let mut backup_timestamps = Vec::new(env);\n        for backup_id in backups.iter() {\n            if let Some(backup) = Self::get_backup(env, \u0026backup_id) {\n                backup_timestamps.push_back((backup_id, backup.timestamp));\n            }\n        }\n\n        // Sort by timestamp (oldest first) using bubble sort\n        // This is a simple sorting algorithm that works well for small lists\n        let len = backup_timestamps.len();\n        for i in 0..len {\n            for j in 0..len - i - 1 {\n                if backup_timestamps.get(j).unwrap().1 \u003e backup_timestamps.get(j + 1).unwrap().1 {\n                    let temp = backup_timestamps.get(j).unwrap().clone();\n                    backup_timestamps.set(j, backup_timestamps.get(j + 1).unwrap().clone());\n                    backup_timestamps.set(j + 1, temp);\n                }\n            }\n        }\n\n        // Remove oldest backups until we're under the limit\n        while backup_timestamps.len() \u003e max_backups.try_into().unwrap() {\n            if let Some((oldest_id, _)) = backup_timestamps.first() {\n                Self::remove_from_backup_list(env, \u0026oldest_id);\n                backup_timestamps.remove(0);\n            }\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":27,"address":[12855933,12855927,12854384],"length":1,"stats":{"Line":0}},{"line":28,"address":[12854439],"length":1,"stats":{"Line":0}},{"line":29,"address":[12854556],"length":1,"stats":{"Line":0}},{"line":30,"address":[12854609,12854660],"length":1,"stats":{"Line":0}},{"line":31,"address":[12854917],"length":1,"stats":{"Line":0}},{"line":33,"address":[12855172],"length":1,"stats":{"Line":0}},{"line":35,"address":[12855192],"length":1,"stats":{"Line":0}},{"line":36,"address":[12855200],"length":1,"stats":{"Line":0}},{"line":38,"address":[12855208],"length":1,"stats":{"Line":0}},{"line":40,"address":[12855376],"length":1,"stats":{"Line":0}},{"line":42,"address":[12855532,12855891],"length":1,"stats":{"Line":0}},{"line":43,"address":[12855783,12855695,12855901],"length":1,"stats":{"Line":0}},{"line":46,"address":[12855729],"length":1,"stats":{"Line":0}},{"line":50,"address":[12851025,12850832,12851031],"length":1,"stats":{"Line":0}},{"line":51,"address":[12850870],"length":1,"stats":{"Line":0}},{"line":55,"address":[12850804,12850592,12850810],"length":1,"stats":{"Line":0}},{"line":56,"address":[12850637,12850719],"length":1,"stats":{"Line":0}},{"line":60,"address":[12851255,12851056,12851249],"length":1,"stats":{"Line":0}},{"line":61,"address":[12851094],"length":1,"stats":{"Line":0}},{"line":65,"address":[12851706,12851712,12851280],"length":1,"stats":{"Line":0}},{"line":66,"address":[12851310],"length":1,"stats":{"Line":0}},{"line":67,"address":[12851354],"length":1,"stats":{"Line":0}},{"line":69,"address":[12851488],"length":1,"stats":{"Line":0}},{"line":70,"address":[12851543],"length":1,"stats":{"Line":0}},{"line":74,"address":[12854360,12853920,12854366],"length":1,"stats":{"Line":0}},{"line":75,"address":[12853963],"length":1,"stats":{"Line":0}},{"line":76,"address":[12853973,12854030],"length":1,"stats":{"Line":0}},{"line":77,"address":[12854063],"length":1,"stats":{"Line":0}},{"line":79,"address":[12854094,12854135],"length":1,"stats":{"Line":0}},{"line":83,"address":[12859370,12858624,12859575],"length":1,"stats":{"Line":0}},{"line":84,"address":[12858663],"length":1,"stats":{"Line":0}},{"line":85,"address":[12858686],"length":1,"stats":{"Line":0}},{"line":86,"address":[12859529,12858814,12858904,12858756],"length":1,"stats":{"Line":0}},{"line":87,"address":[12859000,12859421],"length":1,"stats":{"Line":0}},{"line":88,"address":[12859439],"length":1,"stats":{"Line":0}},{"line":91,"address":[12859042],"length":1,"stats":{"Line":0}},{"line":93,"address":[12859120,12859076],"length":1,"stats":{"Line":0}},{"line":97,"address":[12853887,12853893,12853424],"length":1,"stats":{"Line":0}},{"line":98,"address":[12853464],"length":1,"stats":{"Line":0}},{"line":99,"address":[12853653,12853697],"length":1,"stats":{"Line":0}},{"line":103,"address":[12852283,12852289,12851728],"length":1,"stats":{"Line":0}},{"line":104,"address":[12851777],"length":1,"stats":{"Line":0}},{"line":105,"address":[12852102,12852020,12851976],"length":1,"stats":{"Line":0}},{"line":109,"address":[12852304,12853405,12853377],"length":1,"stats":{"Line":0}},{"line":110,"address":[12852343],"length":1,"stats":{"Line":0}},{"line":112,"address":[12852754,12852689,12853399],"length":1,"stats":{"Line":0}},{"line":116,"address":[12852950,12853003],"length":1,"stats":{"Line":0}},{"line":117,"address":[12853035],"length":1,"stats":{"Line":0}},{"line":121,"address":[12853064,12853028,12853160],"length":1,"stats":{"Line":0}},{"line":122,"address":[12853218],"length":1,"stats":{"Line":0}},{"line":123,"address":[12853324],"length":1,"stats":{"Line":0}},{"line":127,"address":[12853261],"length":1,"stats":{"Line":0}},{"line":131,"address":[12855952,12858604,12857130],"length":1,"stats":{"Line":0}},{"line":132,"address":[12855988],"length":1,"stats":{"Line":0}},{"line":133,"address":[12856021,12856108],"length":1,"stats":{"Line":0}},{"line":135,"address":[12856152],"length":1,"stats":{"Line":0}},{"line":136,"address":[12856249],"length":1,"stats":{"Line":0}},{"line":140,"address":[12856242],"length":1,"stats":{"Line":0}},{"line":141,"address":[12856295,12856358,12858558,12856451],"length":1,"stats":{"Line":0}},{"line":142,"address":[12858197,12856555],"length":1,"stats":{"Line":0}},{"line":143,"address":[12858340],"length":1,"stats":{"Line":0}},{"line":149,"address":[12856588],"length":1,"stats":{"Line":0}},{"line":150,"address":[12856610],"length":1,"stats":{"Line":0}},{"line":151,"address":[12856735,12857140],"length":1,"stats":{"Line":0}},{"line":152,"address":[12858133,12857343],"length":1,"stats":{"Line":0}},{"line":153,"address":[12857626],"length":1,"stats":{"Line":0}},{"line":154,"address":[12857794],"length":1,"stats":{"Line":0}},{"line":155,"address":[12857994],"length":1,"stats":{"Line":0}},{"line":161,"address":[12856764],"length":1,"stats":{"Line":0}},{"line":162,"address":[12856883,12856919],"length":1,"stats":{"Line":0}},{"line":163,"address":[12857007],"length":1,"stats":{"Line":0}},{"line":164,"address":[12857104],"length":1,"stats":{"Line":0}},{"line":168,"address":[12856841],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","bid.rs"],"content":"use core::cmp::Ordering;\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env, Vec};\n\nuse crate::events::emit_bid_expired;\n\nconst DEFAULT_BID_TTL: u64 = 7 * 24 * 60 * 60;\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum BidStatus {\n    Placed,\n    Withdrawn,\n    Accepted,\n    Expired,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Bid {\n    pub bid_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub investor: Address,\n    pub bid_amount: i128,\n    pub expected_return: i128,\n    pub timestamp: u64,\n    pub status: BidStatus,\n    pub expiration_timestamp: u64,\n}\n\nimpl Bid {\n    pub fn is_expired(\u0026self, current_timestamp: u64) -\u003e bool {\n        current_timestamp \u003e self.expiration_timestamp\n    }\n\n    pub fn default_expiration(now: u64) -\u003e u64 {\n        now.saturating_add(DEFAULT_BID_TTL)\n    }\n}\n\npub struct BidStorage;\n\nimpl BidStorage {\n    fn invoice_key(invoice_id: \u0026BytesN\u003c32\u003e) -\u003e (soroban_sdk::Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"bids\"), invoice_id.clone())\n    }\n\n    pub fn store_bid(env: \u0026Env, bid: \u0026Bid) {\n        env.storage().instance().set(\u0026bid.bid_id, bid);\n    }\n    pub fn get_bid(env: \u0026Env, bid_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        env.storage().instance().get(bid_id)\n    }\n    pub fn update_bid(env: \u0026Env, bid: \u0026Bid) {\n        env.storage().instance().set(\u0026bid.bid_id, bid);\n    }\n    pub fn get_bids_for_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::invoice_key(invoice_id))\n            .unwrap_or_else(|| Vec::new(env))\n    }\n    pub fn add_bid_to_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, bid_id: \u0026BytesN\u003c32\u003e) {\n        let mut bids = Self::get_bids_for_invoice(env, invoice_id);\n        let mut exists = false;\n        let mut idx: u32 = 0;\n        while idx \u003c bids.len() {\n            if bids.get(idx).unwrap() == *bid_id {\n                exists = true;\n                break;\n            }\n            idx += 1;\n        }\n        if !exists {\n            bids.push_back(bid_id.clone());\n            env.storage()\n                .instance()\n                .set(\u0026Self::invoice_key(invoice_id), \u0026bids);\n        }\n    }\n    fn refresh_expired_bids(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e u32 {\n        let current_timestamp = env.ledger().timestamp();\n        let bid_ids = Self::get_bids_for_invoice(env, invoice_id);\n        let mut active = Vec::new(env);\n        let mut expired = 0u32;\n        let mut idx: u32 = 0;\n        while idx \u003c bid_ids.len() {\n            let bid_id = bid_ids.get(idx).unwrap();\n            if let Some(mut bid) = Self::get_bid(env, \u0026bid_id) {\n                if bid.status == BidStatus::Placed \u0026\u0026 bid.is_expired(current_timestamp) {\n                    bid.status = BidStatus::Expired;\n                    Self::update_bid(env, \u0026bid);\n                    emit_bid_expired(env, \u0026bid);\n                    expired += 1;\n                } else {\n                    active.push_back(bid_id);\n                }\n            }\n            idx += 1;\n        }\n\n        env.storage()\n            .instance()\n            .set(\u0026Self::invoice_key(invoice_id), \u0026active);\n\n        expired\n    }\n\n    pub fn cleanup_expired_bids(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e u32 {\n        Self::refresh_expired_bids(env, invoice_id)\n    }\n\n    pub fn get_bid_records_for_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        let _ = Self::refresh_expired_bids(env, invoice_id);\n        let mut bids = Vec::new(env);\n        for bid_id in Self::get_bids_for_invoice(env, invoice_id).iter() {\n            if let Some(bid) = Self::get_bid(env, \u0026bid_id) {\n                bids.push_back(bid);\n            }\n        }\n        bids\n    }\n    pub fn get_bids_by_status(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, status: BidStatus) -\u003e Vec\u003cBid\u003e {\n        let mut filtered = Vec::new(env);\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let bid = records.get(idx).unwrap();\n            if bid.status == status {\n                filtered.push_back(bid);\n            }\n            idx += 1;\n        }\n        filtered\n    }\n    pub fn get_bids_by_investor(\n        env: \u0026Env,\n        invoice_id: \u0026BytesN\u003c32\u003e,\n        investor: \u0026Address,\n    ) -\u003e Vec\u003cBid\u003e {\n        let mut filtered = Vec::new(env);\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let bid = records.get(idx).unwrap();\n            if \u0026bid.investor == investor {\n                filtered.push_back(bid);\n            }\n            idx += 1;\n        }\n        filtered\n    }\n    pub fn compare_bids(bid1: \u0026Bid, bid2: \u0026Bid) -\u003e Ordering {\n        let profit1 = bid1.expected_return - bid1.bid_amount;\n        let profit2 = bid2.expected_return - bid2.bid_amount;\n        if profit1 != profit2 {\n            return profit1.cmp(\u0026profit2);\n        }\n        if bid1.expected_return != bid2.expected_return {\n            return bid1.expected_return.cmp(\u0026bid2.expected_return);\n        }\n        if bid1.bid_amount != bid2.bid_amount {\n            return bid1.bid_amount.cmp(\u0026bid2.bid_amount);\n        }\n        if bid1.timestamp != bid2.timestamp {\n            return bid2.timestamp.cmp(\u0026bid1.timestamp);\n        }\n        Ordering::Equal\n    }\n    pub fn get_best_bid(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut best: Option\u003cBid\u003e = None;\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let candidate = records.get(idx).unwrap();\n            if candidate.status != BidStatus::Placed {\n                idx += 1;\n                continue;\n            }\n            best = match best {\n                None =\u003e Some(candidate),\n                Some(current) =\u003e {\n                    if Self::compare_bids(\u0026candidate, \u0026current) == Ordering::Greater {\n                        Some(candidate)\n                    } else {\n                        Some(current)\n                    }\n                }\n            };\n            idx += 1;\n        }\n        best\n    }\n    pub fn rank_bids(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        let records = Self::get_bid_records_for_invoice(env, invoice_id);\n        let mut remaining = Vec::new(env);\n        let mut idx: u32 = 0;\n        while idx \u003c records.len() {\n            let bid = records.get(idx).unwrap();\n            if bid.status == BidStatus::Placed {\n                remaining.push_back(bid);\n            }\n            idx += 1;\n        }\n\n        let mut ranked = Vec::new(env);\n\n        while remaining.len() \u003e 0 {\n            let mut best_idx: u32 = 0;\n            let mut best_bid = remaining.get(0).unwrap();\n            let mut search_idx: u32 = 1;\n            while search_idx \u003c remaining.len() {\n                let candidate = remaining.get(search_idx).unwrap();\n                if Self::compare_bids(\u0026candidate, \u0026best_bid) == Ordering::Greater {\n                    best_idx = search_idx;\n                    best_bid = candidate;\n                }\n                search_idx += 1;\n            }\n            ranked.push_back(best_bid);\n\n            let mut new_remaining = Vec::new(env);\n            let mut copy_idx: u32 = 0;\n            while copy_idx \u003c remaining.len() {\n                if copy_idx != best_idx {\n                    new_remaining.push_back(remaining.get(copy_idx).unwrap());\n                }\n                copy_idx += 1;\n            }\n            remaining = new_remaining;\n        }\n\n        ranked\n    }\n    /// Generates a unique 32-byte bid ID using timestamp and a simple counter.\n    /// This approach avoids potential serialization issues with large counters.\n    pub fn generate_unique_bid_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"bid_cnt\");\n        let mut counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        counter += 1;\n        env.storage().instance().set(\u0026counter_key, \u0026counter);\n\n        let mut bytes = [0u8; 32];\n        // Add bid prefix to distinguish from other entity types\n        bytes[0] = 0xB1; // 'B' for Bid\n        bytes[1] = 0xD0; // 'D' for biD\n                         // Embed timestamp in next 8 bytes\n        bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter in next 8 bytes\n        bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes with a pattern to ensure uniqueness\n        for i in 18..32 {\n            bytes[i] = ((timestamp + counter as u64 + 0xB1D0) % 256) as u8;\n        }\n        BytesN::from_array(env, \u0026bytes)\n    }\n}\n","traces":[{"line":31,"address":[12641984],"length":1,"stats":{"Line":3}},{"line":32,"address":[12641994],"length":1,"stats":{"Line":3}},{"line":35,"address":[12642016],"length":1,"stats":{"Line":1}},{"line":36,"address":[12642021],"length":1,"stats":{"Line":2}},{"line":43,"address":[12630153,12630147,12629984],"length":1,"stats":{"Line":2}},{"line":44,"address":[12630005],"length":1,"stats":{"Line":2}},{"line":47,"address":[12640119,12639920,12640113],"length":1,"stats":{"Line":2}},{"line":48,"address":[12639958],"length":1,"stats":{"Line":1}},{"line":50,"address":[12637744,12637956,12637962],"length":1,"stats":{"Line":3}},{"line":51,"address":[12637789,12637871],"length":1,"stats":{"Line":6}},{"line":53,"address":[12629760,12629959,12629953],"length":1,"stats":{"Line":1}},{"line":54,"address":[12629798],"length":1,"stats":{"Line":2}},{"line":56,"address":[12634145,12634139,12633808],"length":1,"stats":{"Line":2}},{"line":57,"address":[12633863],"length":1,"stats":{"Line":2}},{"line":59,"address":[12633945,12634008],"length":1,"stats":{"Line":4}},{"line":60,"address":[12634062],"length":1,"stats":{"Line":5}},{"line":62,"address":[12631696,12632420,12632426],"length":1,"stats":{"Line":3}},{"line":63,"address":[12631751],"length":1,"stats":{"Line":2}},{"line":64,"address":[12631761],"length":1,"stats":{"Line":3}},{"line":65,"address":[12631766],"length":1,"stats":{"Line":3}},{"line":66,"address":[12632045,12631774,12631847],"length":1,"stats":{"Line":6}},{"line":67,"address":[12631867],"length":1,"stats":{"Line":0}},{"line":68,"address":[12632070],"length":1,"stats":{"Line":0}},{"line":71,"address":[12632050,12632022],"length":1,"stats":{"Line":0}},{"line":73,"address":[12631851],"length":1,"stats":{"Line":3}},{"line":74,"address":[12632085,12632123],"length":1,"stats":{"Line":5}},{"line":75,"address":[12632160],"length":1,"stats":{"Line":1}},{"line":77,"address":[12632194],"length":1,"stats":{"Line":0}},{"line":80,"address":[12634854,12635462,12634160],"length":1,"stats":{"Line":2}},{"line":81,"address":[12634199],"length":1,"stats":{"Line":2}},{"line":82,"address":[12634326],"length":1,"stats":{"Line":2}},{"line":83,"address":[12634336],"length":1,"stats":{"Line":2}},{"line":84,"address":[12634396],"length":1,"stats":{"Line":2}},{"line":85,"address":[12634407],"length":1,"stats":{"Line":3}},{"line":86,"address":[12634494,12635416,12634418],"length":1,"stats":{"Line":9}},{"line":87,"address":[12634518,12634860],"length":1,"stats":{"Line":2}},{"line":88,"address":[12634967,12634919],"length":1,"stats":{"Line":6}},{"line":89,"address":[12635225,12635345,12635024,12635123],"length":1,"stats":{"Line":9}},{"line":90,"address":[12635251],"length":1,"stats":{"Line":0}},{"line":91,"address":[12635267],"length":1,"stats":{"Line":0}},{"line":92,"address":[12635307],"length":1,"stats":{"Line":0}},{"line":93,"address":[12635347,12635314],"length":1,"stats":{"Line":0}},{"line":95,"address":[12635274,12635129],"length":1,"stats":{"Line":6}},{"line":98,"address":[12635390,12635050,12635371],"length":1,"stats":{"Line":6}},{"line":101,"address":[12634511],"length":1,"stats":{"Line":3}},{"line":103,"address":[12634575],"length":1,"stats":{"Line":0}},{"line":105,"address":[12634801],"length":1,"stats":{"Line":3}},{"line":108,"address":[12633104],"length":1,"stats":{"Line":1}},{"line":109,"address":[12633118],"length":1,"stats":{"Line":2}},{"line":112,"address":[12637056,12637721,12637727],"length":1,"stats":{"Line":0}},{"line":113,"address":[12637115],"length":1,"stats":{"Line":0}},{"line":114,"address":[12637130],"length":1,"stats":{"Line":0}},{"line":115,"address":[12637153,12637364,12637213,12637274],"length":1,"stats":{"Line":0}},{"line":116,"address":[12637460,12637578],"length":1,"stats":{"Line":0}},{"line":117,"address":[12637719,12637678],"length":1,"stats":{"Line":0}},{"line":120,"address":[12637506],"length":1,"stats":{"Line":0}},{"line":122,"address":[12632448,12633063,12633069],"length":1,"stats":{"Line":0}},{"line":123,"address":[12632497],"length":1,"stats":{"Line":0}},{"line":124,"address":[12632546],"length":1,"stats":{"Line":0}},{"line":125,"address":[12632594],"length":1,"stats":{"Line":0}},{"line":126,"address":[12632605,12632674,12633025],"length":1,"stats":{"Line":0}},{"line":127,"address":[12632729,12632777],"length":1,"stats":{"Line":0}},{"line":128,"address":[12632815,12632884],"length":1,"stats":{"Line":0}},{"line":129,"address":[12632912],"length":1,"stats":{"Line":0}},{"line":131,"address":[12632978,12632890,12632997],"length":1,"stats":{"Line":0}},{"line":133,"address":[12632683],"length":1,"stats":{"Line":0}},{"line":135,"address":[12633770,12633136,12633776],"length":1,"stats":{"Line":0}},{"line":140,"address":[12633184],"length":1,"stats":{"Line":0}},{"line":141,"address":[12633233],"length":1,"stats":{"Line":0}},{"line":142,"address":[12633281],"length":1,"stats":{"Line":0}},{"line":143,"address":[12633732,12633292,12633361],"length":1,"stats":{"Line":0}},{"line":144,"address":[12633416,12633464],"length":1,"stats":{"Line":0}},{"line":145,"address":[12633591,12633502],"length":1,"stats":{"Line":0}},{"line":146,"address":[12633619],"length":1,"stats":{"Line":0}},{"line":148,"address":[12633685,12633597,12633704],"length":1,"stats":{"Line":0}},{"line":150,"address":[12633370],"length":1,"stats":{"Line":0}},{"line":152,"address":[12630176],"length":1,"stats":{"Line":0}},{"line":153,"address":[12630303,12630200],"length":1,"stats":{"Line":0}},{"line":154,"address":[12630326,12630263,12630363],"length":1,"stats":{"Line":0}},{"line":155,"address":[12630336],"length":1,"stats":{"Line":0}},{"line":156,"address":[12630411],"length":1,"stats":{"Line":0}},{"line":158,"address":[12630386],"length":1,"stats":{"Line":0}},{"line":159,"address":[12630478],"length":1,"stats":{"Line":0}},{"line":161,"address":[12630445],"length":1,"stats":{"Line":0}},{"line":162,"address":[12630529],"length":1,"stats":{"Line":0}},{"line":164,"address":[12630507],"length":1,"stats":{"Line":0}},{"line":165,"address":[12630557],"length":1,"stats":{"Line":0}},{"line":167,"address":[12630540],"length":1,"stats":{"Line":0}},{"line":169,"address":[12631553,12630592,12631668],"length":1,"stats":{"Line":0}},{"line":170,"address":[12630625],"length":1,"stats":{"Line":0}},{"line":171,"address":[12630659],"length":1,"stats":{"Line":0}},{"line":172,"address":[12630675],"length":1,"stats":{"Line":0}},{"line":173,"address":[12631533,12630686,12630777],"length":1,"stats":{"Line":0}},{"line":174,"address":[12630840],"length":1,"stats":{"Line":0}},{"line":175,"address":[12630905,12630976],"length":1,"stats":{"Line":0}},{"line":176,"address":[12631585,12631011,12631563],"length":1,"stats":{"Line":0}},{"line":179,"address":[12630982,12631175],"length":1,"stats":{"Line":0}},{"line":180,"address":[12631115],"length":1,"stats":{"Line":0}},{"line":181,"address":[12631040],"length":1,"stats":{"Line":0}},{"line":182,"address":[12631382,12631279,12631101],"length":1,"stats":{"Line":0}},{"line":183,"address":[12631384],"length":1,"stats":{"Line":0}},{"line":185,"address":[12631322],"length":1,"stats":{"Line":0}},{"line":189,"address":[12631505,12631206,12631486],"length":1,"stats":{"Line":0}},{"line":191,"address":[12630786],"length":1,"stats":{"Line":0}},{"line":193,"address":[12637984,12639897,12639142],"length":1,"stats":{"Line":0}},{"line":194,"address":[12638022],"length":1,"stats":{"Line":0}},{"line":195,"address":[12638077],"length":1,"stats":{"Line":0}},{"line":196,"address":[12638121],"length":1,"stats":{"Line":0}},{"line":197,"address":[12639859,12638204,12638132],"length":1,"stats":{"Line":0}},{"line":198,"address":[12639605,12638228],"length":1,"stats":{"Line":0}},{"line":199,"address":[12639643,12639714],"length":1,"stats":{"Line":0}},{"line":200,"address":[12639742],"length":1,"stats":{"Line":0}},{"line":202,"address":[12639811,12639830,12639720],"length":1,"stats":{"Line":0}},{"line":205,"address":[12638258,12638221],"length":1,"stats":{"Line":0}},{"line":207,"address":[12638323,12638976,12638268],"length":1,"stats":{"Line":0}},{"line":208,"address":[12638383],"length":1,"stats":{"Line":0}},{"line":209,"address":[12638442,12638412],"length":1,"stats":{"Line":0}},{"line":210,"address":[12638480],"length":1,"stats":{"Line":0}},{"line":211,"address":[12638491,12638570,12639549],"length":1,"stats":{"Line":0}},{"line":212,"address":[12638637,12639148],"length":1,"stats":{"Line":0}},{"line":213,"address":[12639492,12639202,12639258],"length":1,"stats":{"Line":0}},{"line":214,"address":[12639330],"length":1,"stats":{"Line":0}},{"line":215,"address":[12639344,12639397],"length":1,"stats":{"Line":0}},{"line":217,"address":[12639501,12639520,12639301],"length":1,"stats":{"Line":0}},{"line":219,"address":[12638574],"length":1,"stats":{"Line":0}},{"line":221,"address":[12638683],"length":1,"stats":{"Line":0}},{"line":222,"address":[12638698],"length":1,"stats":{"Line":0}},{"line":223,"address":[12639099,12638788,12638709],"length":1,"stats":{"Line":0}},{"line":224,"address":[12638863],"length":1,"stats":{"Line":0}},{"line":225,"address":[12639003],"length":1,"stats":{"Line":0}},{"line":227,"address":[12638981,12639104,12639092],"length":1,"stats":{"Line":0}},{"line":229,"address":[12638792,12638881],"length":1,"stats":{"Line":0}},{"line":232,"address":[12638333],"length":1,"stats":{"Line":0}},{"line":236,"address":[12635488,12637025,12637031],"length":1,"stats":{"Line":3}},{"line":237,"address":[12635543],"length":1,"stats":{"Line":3}},{"line":238,"address":[12635660],"length":1,"stats":{"Line":3}},{"line":239,"address":[12635713,12635764],"length":1,"stats":{"Line":5}},{"line":240,"address":[12636072,12636005],"length":1,"stats":{"Line":2}},{"line":241,"address":[12636065,12636092],"length":1,"stats":{"Line":3}},{"line":243,"address":[12636273],"length":1,"stats":{"Line":1}},{"line":245,"address":[12636293],"length":1,"stats":{"Line":2}},{"line":246,"address":[12636301],"length":1,"stats":{"Line":1}},{"line":248,"address":[12636309],"length":1,"stats":{"Line":2}},{"line":250,"address":[12636477],"length":1,"stats":{"Line":1}},{"line":252,"address":[12636989,12636633],"length":1,"stats":{"Line":3}},{"line":253,"address":[12636999,12636788,12636881],"length":1,"stats":{"Line":3}},{"line":255,"address":[12636827],"length":1,"stats":{"Line":2}}],"covered":54,"coverable":147},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","defaults.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::events::{\n    emit_dispute_created, emit_dispute_resolved, emit_dispute_under_review, emit_insurance_claimed,\n    emit_invoice_defaulted, emit_invoice_expired,\n};\nuse crate::investment::{InvestmentStatus, InvestmentStorage};\nuse crate::invoice::{Dispute, DisputeStatus, InvoiceStatus, InvoiceStorage};\nuse crate::notifications::NotificationSystem;\nuse soroban_sdk::{Address, BytesN, Env, String, Vec};\n\npub fn handle_default(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n    if !invoice.is_overdue(env.ledger().timestamp()) {\n        return Err(QuickLendXError::OperationNotAllowed);\n    }\n    InvoiceStorage::remove_from_status_invoices(env, \u0026InvoiceStatus::Funded, invoice_id);\n    invoice.mark_as_defaulted();\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n    InvoiceStorage::add_to_status_invoices(env, \u0026InvoiceStatus::Defaulted, invoice_id);\n    emit_invoice_expired(env, \u0026invoice);\n    if let Some(mut investment) = InvestmentStorage::get_investment_by_invoice(env, invoice_id) {\n        investment.status = InvestmentStatus::Defaulted;\n\n        let claim_details = investment\n            .process_insurance_claim()\n            .and_then(|(provider, amount)| {\n                if amount \u003e 0 {\n                    Some((provider, amount))\n                } else {\n                    None\n                }\n            });\n\n        InvestmentStorage::update_investment(env, \u0026investment);\n\n        if let Some((provider, coverage_amount)) = claim_details {\n            emit_insurance_claimed(\n                env,\n                \u0026investment.investment_id,\n                \u0026investment.invoice_id,\n                \u0026provider,\n                coverage_amount,\n            );\n        }\n    }\n    emit_invoice_defaulted(env, \u0026invoice);\n    let _ = NotificationSystem::notify_invoice_defaulted(env, \u0026invoice);\n    Ok(())\n}\n\n/// Create a dispute for an invoice\npub fn create_dispute(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    creator: \u0026Address,\n    reason: String,\n    evidence: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    creator.require_auth();\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    // Check if dispute already exists\n    if invoice.dispute_status != DisputeStatus::None {\n        return Err(QuickLendXError::DisputeAlreadyExists);\n    }\n\n    // Validate creator has stake in invoice (business or investor)\n    if creator != \u0026invoice.business {\n        if let Some(investor) = \u0026invoice.investor {\n            if creator != investor {\n                return Err(QuickLendXError::DisputeNotAuthorized);\n            }\n        } else {\n            return Err(QuickLendXError::DisputeNotAuthorized);\n        }\n    }\n\n    // Validate reason and evidence\n    if reason.len() == 0 || reason.len() \u003e 500 {\n        return Err(QuickLendXError::InvalidDisputeReason);\n    }\n\n    if evidence.len() == 0 || evidence.len() \u003e 1000 {\n        return Err(QuickLendXError::InvalidDisputeEvidence);\n    }\n\n    // Create dispute\n    let dispute = Dispute {\n        created_by: creator.clone(),\n        created_at: env.ledger().timestamp(),\n        reason: reason.clone(),\n        evidence,\n        resolution: String::from_str(env, \"\"),\n        resolved_by: Address::from_str(\n            env,\n            \"GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF\",\n        ),\n        resolved_at: 0,\n    };\n\n    // Update invoice with dispute\n    invoice.dispute_status = DisputeStatus::Disputed;\n    invoice.dispute = dispute;\n\n    // Update invoice in storage\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    // Emit dispute created event\n    emit_dispute_created(env, invoice_id, creator, \u0026reason);\n\n    Ok(())\n}\n\n/// Put a dispute under review (admin function)\npub fn put_dispute_under_review(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    reviewer: \u0026Address,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    reviewer.require_auth();\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    // Check if dispute exists and is in disputed status\n    if invoice.dispute_status != DisputeStatus::Disputed {\n        return Err(QuickLendXError::DisputeNotFound);\n    }\n\n    // Update dispute status\n    invoice.dispute_status = DisputeStatus::UnderReview;\n\n    // Update invoice in storage\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    // Emit dispute under review event\n    emit_dispute_under_review(env, invoice_id, reviewer);\n\n    Ok(())\n}\n\n/// Resolve a dispute (admin function)\npub fn resolve_dispute(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    resolver: \u0026Address,\n    resolution: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    resolver.require_auth();\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    // Check if dispute exists and is under review\n    if invoice.dispute_status != DisputeStatus::UnderReview {\n        return Err(QuickLendXError::DisputeNotUnderReview);\n    }\n\n    // Validate resolution\n    if resolution.len() == 0 || resolution.len() \u003e 500 {\n        return Err(QuickLendXError::InvalidDisputeReason);\n    }\n\n    // Update dispute with resolution\n    if invoice.dispute_status != DisputeStatus::None {\n        invoice.dispute.resolution = resolution.clone();\n        invoice.dispute.resolved_by = resolver.clone();\n        invoice.dispute.resolved_at = env.ledger().timestamp();\n    }\n\n    // Update dispute status\n    invoice.dispute_status = DisputeStatus::Resolved;\n\n    // Update invoice in storage\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    // Emit dispute resolved event\n    emit_dispute_resolved(env, invoice_id, resolver, \u0026resolution);\n\n    Ok(())\n}\n\n/// Get dispute details for an invoice\npub fn get_dispute_details(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n) -\u003e Result\u003cOption\u003cDispute\u003e, QuickLendXError\u003e {\n    let invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.dispute_status != DisputeStatus::None {\n        Ok(Some(invoice.dispute))\n    } else {\n        Ok(None)\n    }\n}\n\n/// Get all invoices with disputes\npub fn get_invoices_with_disputes(env: \u0026Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n    let mut disputed_invoices = Vec::new(env);\n\n    // Check all invoice statuses for disputes\n    let all_statuses = [\n        InvoiceStatus::Pending,\n        InvoiceStatus::Verified,\n        InvoiceStatus::Funded,\n        InvoiceStatus::Paid,\n        InvoiceStatus::Defaulted,\n    ];\n\n    for status in all_statuses.iter() {\n        let invoices = InvoiceStorage::get_invoices_by_status(env, status);\n        for invoice_id in invoices.iter() {\n            if let Some(invoice) = InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.dispute_status != DisputeStatus::None {\n                    disputed_invoices.push_back(invoice_id);\n                }\n            }\n        }\n    }\n\n    disputed_invoices\n}\n\n/// Get invoices by dispute status\npub fn get_invoices_by_dispute_status(env: \u0026Env, dispute_status: DisputeStatus) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n    let mut filtered_invoices = Vec::new(env);\n\n    // Check all invoice statuses for specific dispute status\n    let all_statuses = [\n        InvoiceStatus::Pending,\n        InvoiceStatus::Verified,\n        InvoiceStatus::Funded,\n        InvoiceStatus::Paid,\n        InvoiceStatus::Defaulted,\n    ];\n\n    for status in all_statuses.iter() {\n        let invoices = InvoiceStorage::get_invoices_by_status(env, status);\n        for invoice_id in invoices.iter() {\n            if let Some(invoice) = InvoiceStorage::get_invoice(env, \u0026invoice_id) {\n                if invoice.dispute_status == dispute_status {\n                    filtered_invoices.push_back(invoice_id);\n                }\n            }\n        }\n    }\n\n    filtered_invoices\n}\n","traces":[{"line":11,"address":[12200288,12201532,12201417],"length":1,"stats":{"Line":0}},{"line":12,"address":[12200350],"length":1,"stats":{"Line":0}},{"line":14,"address":[12200540,12200607],"length":1,"stats":{"Line":0}},{"line":15,"address":[12200633],"length":1,"stats":{"Line":0}},{"line":17,"address":[12200646,12200626],"length":1,"stats":{"Line":0}},{"line":18,"address":[12200780],"length":1,"stats":{"Line":0}},{"line":20,"address":[12200813],"length":1,"stats":{"Line":0}},{"line":21,"address":[12200832],"length":1,"stats":{"Line":0}},{"line":22,"address":[12200849],"length":1,"stats":{"Line":0}},{"line":23,"address":[12200866],"length":1,"stats":{"Line":0}},{"line":24,"address":[12200890],"length":1,"stats":{"Line":0}},{"line":25,"address":[12200915],"length":1,"stats":{"Line":0}},{"line":26,"address":[12200987],"length":1,"stats":{"Line":0}},{"line":30,"address":[13887296,13887312],"length":1,"stats":{"Line":0}},{"line":31,"address":[13887390,13887408],"length":1,"stats":{"Line":0}},{"line":32,"address":[13887427],"length":1,"stats":{"Line":0}},{"line":34,"address":[13887404],"length":1,"stats":{"Line":0}},{"line":38,"address":[12201114],"length":1,"stats":{"Line":0}},{"line":40,"address":[12201174],"length":1,"stats":{"Line":0}},{"line":43,"address":[12201294],"length":1,"stats":{"Line":0}},{"line":44,"address":[12201302],"length":1,"stats":{"Line":0}},{"line":50,"address":[12201020],"length":1,"stats":{"Line":0}},{"line":51,"address":[12201495],"length":1,"stats":{"Line":0}},{"line":52,"address":[12201502],"length":1,"stats":{"Line":0}},{"line":56,"address":[12200275,12200114,12198400],"length":1,"stats":{"Line":0}},{"line":63,"address":[12198463],"length":1,"stats":{"Line":0}},{"line":65,"address":[12198562,12200199],"length":1,"stats":{"Line":0}},{"line":69,"address":[12198753,12198823],"length":1,"stats":{"Line":0}},{"line":70,"address":[12198869],"length":1,"stats":{"Line":0}},{"line":74,"address":[12198829,12198886],"length":1,"stats":{"Line":0}},{"line":75,"address":[12198908],"length":1,"stats":{"Line":0}},{"line":76,"address":[12199008,12198980],"length":1,"stats":{"Line":0}},{"line":77,"address":[12199014],"length":1,"stats":{"Line":0}},{"line":80,"address":[12198991],"length":1,"stats":{"Line":0}},{"line":85,"address":[12198897,12199069,12199031],"length":1,"stats":{"Line":0}},{"line":86,"address":[12199052],"length":1,"stats":{"Line":0}},{"line":89,"address":[12199081,12199134],"length":1,"stats":{"Line":0}},{"line":90,"address":[12199117],"length":1,"stats":{"Line":0}},{"line":95,"address":[12199141],"length":1,"stats":{"Line":0}},{"line":96,"address":[12199225,12199174],"length":1,"stats":{"Line":0}},{"line":97,"address":[12199306],"length":1,"stats":{"Line":0}},{"line":99,"address":[12199383],"length":1,"stats":{"Line":0}},{"line":100,"address":[12199439],"length":1,"stats":{"Line":0}},{"line":108,"address":[12199844],"length":1,"stats":{"Line":0}},{"line":109,"address":[12199852],"length":1,"stats":{"Line":0}},{"line":112,"address":[12200008],"length":1,"stats":{"Line":0}},{"line":115,"address":[12200030],"length":1,"stats":{"Line":0}},{"line":117,"address":[12200042],"length":1,"stats":{"Line":0}},{"line":121,"address":[12204408,12204402,12203952],"length":1,"stats":{"Line":0}},{"line":126,"address":[12204026],"length":1,"stats":{"Line":0}},{"line":128,"address":[12204042],"length":1,"stats":{"Line":0}},{"line":132,"address":[12204232,12204299],"length":1,"stats":{"Line":0}},{"line":133,"address":[12204330],"length":1,"stats":{"Line":0}},{"line":137,"address":[12204310],"length":1,"stats":{"Line":0}},{"line":140,"address":[12204323],"length":1,"stats":{"Line":0}},{"line":143,"address":[12204365],"length":1,"stats":{"Line":0}},{"line":145,"address":[12204372],"length":1,"stats":{"Line":0}},{"line":149,"address":[12201552,12202599,12202640],"length":1,"stats":{"Line":0}},{"line":155,"address":[12201631],"length":1,"stats":{"Line":0}},{"line":157,"address":[12202634,12201701],"length":1,"stats":{"Line":0}},{"line":161,"address":[12201889,12201956],"length":1,"stats":{"Line":0}},{"line":162,"address":[12201978],"length":1,"stats":{"Line":0}},{"line":166,"address":[12202033,12201967,12201995],"length":1,"stats":{"Line":0}},{"line":167,"address":[12202016],"length":1,"stats":{"Line":0}},{"line":171,"address":[12202040],"length":1,"stats":{"Line":0}},{"line":172,"address":[12202117],"length":1,"stats":{"Line":0}},{"line":173,"address":[12202268],"length":1,"stats":{"Line":0}},{"line":174,"address":[12202419],"length":1,"stats":{"Line":0}},{"line":178,"address":[12202081],"length":1,"stats":{"Line":0}},{"line":181,"address":[12202094],"length":1,"stats":{"Line":0}},{"line":184,"address":[12202549],"length":1,"stats":{"Line":0}},{"line":186,"address":[12202556],"length":1,"stats":{"Line":0}},{"line":190,"address":[12202656,12203910,12203931],"length":1,"stats":{"Line":0}},{"line":194,"address":[12202886,12202712],"length":1,"stats":{"Line":0}},{"line":197,"address":[12203021,12202917,12202984],"length":1,"stats":{"Line":0}},{"line":198,"address":[12203023],"length":1,"stats":{"Line":0}},{"line":200,"address":[12202995],"length":1,"stats":{"Line":0}},{"line":205,"address":[12204432,12205381,12205441],"length":1,"stats":{"Line":0}},{"line":206,"address":[12204462],"length":1,"stats":{"Line":0}},{"line":209,"address":[12204484],"length":1,"stats":{"Line":0}},{"line":217,"address":[12204519,12204587],"length":1,"stats":{"Line":0}},{"line":218,"address":[12204723],"length":1,"stats":{"Line":0}},{"line":219,"address":[12204779,12204942,12205395,12204846],"length":1,"stats":{"Line":0}},{"line":220,"address":[12205131,12205046],"length":1,"stats":{"Line":0}},{"line":221,"address":[12205278,12205189],"length":1,"stats":{"Line":0}},{"line":222,"address":[12205299],"length":1,"stats":{"Line":0}},{"line":228,"address":[12204735],"length":1,"stats":{"Line":0}},{"line":232,"address":[12206487,12206427,12205456],"length":1,"stats":{"Line":0}},{"line":233,"address":[12205492],"length":1,"stats":{"Line":0}},{"line":236,"address":[12205514],"length":1,"stats":{"Line":0}},{"line":244,"address":[12205567,12205635],"length":1,"stats":{"Line":0}},{"line":245,"address":[12205771],"length":1,"stats":{"Line":0}},{"line":246,"address":[12205894,12206441,12205990,12205827],"length":1,"stats":{"Line":0}},{"line":247,"address":[12206179,12206094],"length":1,"stats":{"Line":0}},{"line":248,"address":[12206237,12206324],"length":1,"stats":{"Line":0}},{"line":249,"address":[12206345],"length":1,"stats":{"Line":0}},{"line":255,"address":[12205783],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":97},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","errors.rs"],"content":"use soroban_sdk::{contracterror, symbol_short, Symbol};\n\n/// Custom error types for the QuickLendX contract\n#[contracterror]\n#[derive(Copy, Clone, Debug, Eq, PartialEq, PartialOrd, Ord)]\n#[repr(u32)]\npub enum QuickLendXError {\n    // Invoice errors (1000-1099)\n    InvoiceNotFound = 1000,\n    InvoiceAlreadyExists = 1001,\n    InvoiceNotAvailableForFunding = 1002,\n    InvoiceAlreadyFunded = 1003,\n    InvoiceAmountInvalid = 1004,\n    InvoiceDueDateInvalid = 1005,\n    InvoiceNotVerified = 1006,\n    InvoiceNotFunded = 1007,\n    InvoiceAlreadyPaid = 1008,\n    InvoiceAlreadyDefaulted = 1009,\n\n    // Authorization errors (1100-1199)\n    Unauthorized = 1100,\n    NotBusinessOwner = 1101,\n    NotInvestor = 1102,\n    NotAdmin = 1103,\n\n    // Validation errors (1200-1299)\n    InvalidAmount = 1200,\n    InvalidAddress = 1201,\n    InvalidCurrency = 1202,\n    InvalidTimestamp = 1203,\n    InvalidDescription = 1204,\n\n    // Storage errors (1300-1399)\n    StorageError = 1300,\n    StorageKeyNotFound = 1301,\n\n    // Business logic errors (1400-1499)\n    InsufficientFunds = 1400,\n    InvalidStatus = 1401,\n    OperationNotAllowed = 1402,\n    PaymentTooLow = 1403,\n    PlatformAccountNotConfigured = 1404,\n    InvalidCoveragePercentage = 1405,\n\n    // Rating errors (1500-1599)\n    InvalidRating = 1500,\n    NotFunded = 1501,\n    AlreadyRated = 1502,\n    NotRater = 1503,\n\n    // KYC/Verification errors (1600-1699)\n    BusinessNotVerified = 1600,\n    KYCAlreadyPending = 1601,\n    KYCAlreadyVerified = 1602,\n    KYCNotFound = 1603,\n    InvalidKYCStatus = 1604,\n\n    // Audit errors (1700-1799)\n    AuditLogNotFound = 1700,\n    AuditIntegrityError = 1701,\n    AuditQueryError = 1702,\n\n    // Category and Tag errors (1800-1899)\n    InvalidTag = 1802,\n    TagLimitExceeded = 1803,\n\n    // Dispute errors (1900-1999)\n    DisputeNotFound = 1900,\n    DisputeAlreadyExists = 1901,\n    DisputeNotAuthorized = 1902,\n    DisputeAlreadyResolved = 1903,\n    DisputeNotUnderReview = 1904,\n    InvalidDisputeReason = 1905,\n    InvalidDisputeEvidence = 1906,\n\n    // Notification errors\n    NotificationNotFound = 2000,\n    NotificationBlocked = 2001,\n}\n\nimpl From\u003cQuickLendXError\u003e for Symbol {\n    fn from(error: QuickLendXError) -\u003e Self {\n        match error {\n            QuickLendXError::InvoiceNotFound =\u003e symbol_short!(\"INV_NF\"),\n            QuickLendXError::InvoiceAlreadyExists =\u003e symbol_short!(\"INV_EX\"),\n            QuickLendXError::InvoiceNotAvailableForFunding =\u003e symbol_short!(\"INV_NA\"),\n            QuickLendXError::InvoiceAlreadyFunded =\u003e symbol_short!(\"INV_FD\"),\n            QuickLendXError::InvoiceAmountInvalid =\u003e symbol_short!(\"INV_AI\"),\n            QuickLendXError::InvoiceDueDateInvalid =\u003e symbol_short!(\"INV_DI\"),\n            QuickLendXError::InvoiceNotVerified =\u003e symbol_short!(\"INV_NV\"),\n            QuickLendXError::InvoiceNotFunded =\u003e symbol_short!(\"INV_NF\"),\n            QuickLendXError::InvoiceAlreadyPaid =\u003e symbol_short!(\"INV_PD\"),\n            QuickLendXError::InvoiceAlreadyDefaulted =\u003e symbol_short!(\"INV_DF\"),\n            QuickLendXError::Unauthorized =\u003e symbol_short!(\"UNAUTH\"),\n            QuickLendXError::NotBusinessOwner =\u003e symbol_short!(\"NOT_OWN\"),\n            QuickLendXError::NotInvestor =\u003e symbol_short!(\"NOT_INV\"),\n            QuickLendXError::NotAdmin =\u003e symbol_short!(\"NOT_ADM\"),\n            QuickLendXError::InvalidAmount =\u003e symbol_short!(\"INV_AMT\"),\n            QuickLendXError::InvalidAddress =\u003e symbol_short!(\"INV_ADR\"),\n            QuickLendXError::InvalidCurrency =\u003e symbol_short!(\"INV_CR\"),\n            QuickLendXError::InvalidTimestamp =\u003e symbol_short!(\"INV_TM\"),\n            QuickLendXError::InvalidDescription =\u003e symbol_short!(\"INV_DS\"),\n            QuickLendXError::StorageError =\u003e symbol_short!(\"STORE\"),\n            QuickLendXError::StorageKeyNotFound =\u003e symbol_short!(\"KEY_NF\"),\n            QuickLendXError::InsufficientFunds =\u003e symbol_short!(\"INSUF\"),\n            QuickLendXError::InvalidStatus =\u003e symbol_short!(\"INV_ST\"),\n            QuickLendXError::OperationNotAllowed =\u003e symbol_short!(\"OP_NA\"),\n            QuickLendXError::PaymentTooLow =\u003e symbol_short!(\"PAY_LOW\"),\n            QuickLendXError::PlatformAccountNotConfigured =\u003e symbol_short!(\"PLT_NC\"),\n            QuickLendXError::InvalidCoveragePercentage =\u003e symbol_short!(\"INS_CV\"),\n            QuickLendXError::InvalidRating =\u003e symbol_short!(\"INV_RT\"),\n            QuickLendXError::NotFunded =\u003e symbol_short!(\"NOT_FD\"),\n            QuickLendXError::AlreadyRated =\u003e symbol_short!(\"ALR_RT\"),\n            QuickLendXError::NotRater =\u003e symbol_short!(\"NOT_RT\"),\n            QuickLendXError::BusinessNotVerified =\u003e symbol_short!(\"BUS_NV\"),\n            QuickLendXError::KYCAlreadyPending =\u003e symbol_short!(\"KYC_PD\"),\n            QuickLendXError::KYCAlreadyVerified =\u003e symbol_short!(\"KYC_VF\"),\n            QuickLendXError::KYCNotFound =\u003e symbol_short!(\"KYC_NF\"),\n            QuickLendXError::InvalidKYCStatus =\u003e symbol_short!(\"KYC_IS\"),\n            QuickLendXError::AuditLogNotFound =\u003e symbol_short!(\"AUD_NF\"),\n            QuickLendXError::AuditIntegrityError =\u003e symbol_short!(\"AUD_IE\"),\n            QuickLendXError::AuditQueryError =\u003e symbol_short!(\"AUD_QE\"),\n            QuickLendXError::InvalidTag =\u003e symbol_short!(\"INV_TAG\"),\n            QuickLendXError::TagLimitExceeded =\u003e symbol_short!(\"TAG_LIM\"),\n            // Dispute errors\n            QuickLendXError::DisputeNotFound =\u003e symbol_short!(\"DSP_NF\"),\n            QuickLendXError::DisputeAlreadyExists =\u003e symbol_short!(\"DSP_EX\"),\n            QuickLendXError::DisputeNotAuthorized =\u003e symbol_short!(\"DSP_NA\"),\n            QuickLendXError::DisputeAlreadyResolved =\u003e symbol_short!(\"DSP_RS\"),\n            QuickLendXError::DisputeNotUnderReview =\u003e symbol_short!(\"DSP_UR\"),\n            QuickLendXError::InvalidDisputeReason =\u003e symbol_short!(\"DSP_RN\"),\n            QuickLendXError::InvalidDisputeEvidence =\u003e symbol_short!(\"DSP_EV\"),\n            // Notification errors\n            QuickLendXError::NotificationNotFound =\u003e symbol_short!(\"NOT_NF\"),\n            QuickLendXError::NotificationBlocked =\u003e symbol_short!(\"NOT_BL\"),\n        }\n    }\n}\n","traces":[{"line":82,"address":[15678288],"length":1,"stats":{"Line":0}},{"line":83,"address":[15678310],"length":1,"stats":{"Line":0}},{"line":84,"address":[15679152],"length":1,"stats":{"Line":0}},{"line":85,"address":[15679179],"length":1,"stats":{"Line":0}},{"line":86,"address":[15679206],"length":1,"stats":{"Line":0}},{"line":87,"address":[15679233],"length":1,"stats":{"Line":0}},{"line":88,"address":[15679260],"length":1,"stats":{"Line":0}},{"line":89,"address":[15679287],"length":1,"stats":{"Line":0}},{"line":90,"address":[15679314],"length":1,"stats":{"Line":0}},{"line":91,"address":[15679341],"length":1,"stats":{"Line":0}},{"line":92,"address":[15679368],"length":1,"stats":{"Line":0}},{"line":93,"address":[15679395],"length":1,"stats":{"Line":0}},{"line":94,"address":[15679422],"length":1,"stats":{"Line":0}},{"line":95,"address":[15679449],"length":1,"stats":{"Line":0}},{"line":96,"address":[15679476],"length":1,"stats":{"Line":0}},{"line":97,"address":[15679503],"length":1,"stats":{"Line":0}},{"line":98,"address":[15679530],"length":1,"stats":{"Line":0}},{"line":99,"address":[15679557],"length":1,"stats":{"Line":0}},{"line":100,"address":[15679584],"length":1,"stats":{"Line":0}},{"line":101,"address":[15679611],"length":1,"stats":{"Line":0}},{"line":102,"address":[15679638],"length":1,"stats":{"Line":0}},{"line":103,"address":[15679665],"length":1,"stats":{"Line":0}},{"line":104,"address":[15679692],"length":1,"stats":{"Line":0}},{"line":105,"address":[15679719],"length":1,"stats":{"Line":0}},{"line":106,"address":[15679746],"length":1,"stats":{"Line":0}},{"line":107,"address":[15679773],"length":1,"stats":{"Line":0}},{"line":108,"address":[15679800],"length":1,"stats":{"Line":0}},{"line":109,"address":[15679827],"length":1,"stats":{"Line":0}},{"line":110,"address":[15679854],"length":1,"stats":{"Line":0}},{"line":111,"address":[15679881],"length":1,"stats":{"Line":0}},{"line":112,"address":[15679908],"length":1,"stats":{"Line":0}},{"line":113,"address":[15679935],"length":1,"stats":{"Line":0}},{"line":114,"address":[15679962],"length":1,"stats":{"Line":0}},{"line":115,"address":[15679989],"length":1,"stats":{"Line":0}},{"line":116,"address":[15680016],"length":1,"stats":{"Line":3}},{"line":117,"address":[15680043],"length":1,"stats":{"Line":3}},{"line":118,"address":[15680070],"length":1,"stats":{"Line":2}},{"line":119,"address":[15680097],"length":1,"stats":{"Line":0}},{"line":120,"address":[15680124],"length":1,"stats":{"Line":0}},{"line":121,"address":[15680151],"length":1,"stats":{"Line":0}},{"line":122,"address":[15680178],"length":1,"stats":{"Line":0}},{"line":123,"address":[15680205],"length":1,"stats":{"Line":0}},{"line":124,"address":[15680232],"length":1,"stats":{"Line":0}},{"line":126,"address":[15680259],"length":1,"stats":{"Line":0}},{"line":127,"address":[15680286],"length":1,"stats":{"Line":0}},{"line":128,"address":[15680313],"length":1,"stats":{"Line":0}},{"line":129,"address":[15680340],"length":1,"stats":{"Line":0}},{"line":130,"address":[15680364],"length":1,"stats":{"Line":0}},{"line":131,"address":[15680388],"length":1,"stats":{"Line":0}},{"line":132,"address":[15680412],"length":1,"stats":{"Line":0}},{"line":134,"address":[15680436],"length":1,"stats":{"Line":0}},{"line":135,"address":[15680460],"length":1,"stats":{"Line":0}}],"covered":3,"coverable":52},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","events.rs"],"content":"use crate::bid::Bid;\nuse crate::invoice::{Invoice, InvoiceMetadata};\nuse crate::payments::Escrow;\nuse crate::profits::PlatformFeeConfig;\nuse crate::verification::InvestorVerification;\nuse soroban_sdk::{symbol_short, Address, BytesN, Env, String};\n\npub fn emit_invoice_uploaded(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_up\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            invoice.amount,\n            invoice.currency.clone(),\n            invoice.due_date,\n        ),\n    );\n}\n\npub fn emit_invoice_verified(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_ver\"),),\n        (invoice.id.clone(), invoice.business.clone()),\n    );\n}\n\npub fn emit_invoice_cancelled(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_canc\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\npub fn emit_invoice_metadata_updated(env: \u0026Env, invoice: \u0026Invoice, metadata: \u0026InvoiceMetadata) {\n    let mut total = 0i128;\n    for record in metadata.line_items.iter() {\n        total = total.saturating_add(record.3);\n    }\n\n    env.events().publish(\n        (symbol_short!(\"inv_meta\"),),\n        (\n            invoice.id.clone(),\n            metadata.customer_name.clone(),\n            metadata.tax_id.clone(),\n            metadata.line_items.len() as u32,\n            total,\n        ),\n    );\n}\n\npub fn emit_invoice_metadata_cleared(env: \u0026Env, invoice: \u0026Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_mclr\"),),\n        (invoice.id.clone(), invoice.business.clone()),\n    );\n}\n\npub fn emit_investor_verified(env: \u0026Env, verification: \u0026InvestorVerification) {\n    env.events().publish(\n        (symbol_short!(\"inv_veri\"),),\n        (\n            verification.investor.clone(),\n            verification.investment_limit,\n            verification.verified_at,\n        ),\n    );\n}\n\npub fn emit_invoice_settled(\n    env: \u0026Env,\n    invoice: \u0026crate::invoice::Invoice,\n    investor_return: i128,\n    platform_fee: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_set\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            investor_return,\n            platform_fee,\n        ),\n    );\n}\n\npub fn emit_partial_payment(\n    env: \u0026Env,\n    invoice: \u0026Invoice,\n    payment_amount: i128,\n    total_paid: i128,\n    progress: u32,\n    transaction_id: String,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_pp\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            payment_amount,\n            total_paid,\n            progress,\n            transaction_id,\n        ),\n    );\n}\n\npub fn emit_invoice_expired(env: \u0026Env, invoice: \u0026crate::invoice::Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_exp\"),),\n        (\n            invoice.id.clone(),\n            invoice.business.clone(),\n            invoice.due_date,\n        ),\n    );\n}\n\npub fn emit_invoice_defaulted(env: \u0026Env, invoice: \u0026crate::invoice::Invoice) {\n    env.events().publish(\n        (symbol_short!(\"inv_def\"),),\n        (invoice.id.clone(), invoice.business.clone()),\n    );\n}\n\npub fn emit_insurance_added(\n    env: \u0026Env,\n    investment_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    provider: \u0026Address,\n    coverage_percentage: u32,\n    coverage_amount: i128,\n    premium_amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"ins_add\"),),\n        (\n            investment_id.clone(),\n            invoice_id.clone(),\n            investor.clone(),\n            provider.clone(),\n            coverage_percentage,\n            coverage_amount,\n            premium_amount,\n        ),\n    );\n}\n\npub fn emit_insurance_premium_collected(\n    env: \u0026Env,\n    investment_id: \u0026BytesN\u003c32\u003e,\n    provider: \u0026Address,\n    premium_amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"ins_prm\"),),\n        (investment_id.clone(), provider.clone(), premium_amount),\n    );\n}\n\npub fn emit_insurance_claimed(\n    env: \u0026Env,\n    investment_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    provider: \u0026Address,\n    coverage_amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"ins_clm\"),),\n        (\n            investment_id.clone(),\n            invoice_id.clone(),\n            provider.clone(),\n            coverage_amount,\n        ),\n    );\n}\n\npub fn emit_platform_fee_updated(env: \u0026Env, config: \u0026PlatformFeeConfig) {\n    env.events().publish(\n        (symbol_short!(\"fee_upd\"),),\n        (config.fee_bps, config.updated_at, config.updated_by.clone()),\n    );\n}\n\n/// Emit event when escrow is created\npub fn emit_escrow_created(env: \u0026Env, escrow: \u0026Escrow) {\n    env.events().publish(\n        (symbol_short!(\"esc_cr\"),),\n        (\n            escrow.escrow_id.clone(),\n            escrow.invoice_id.clone(),\n            escrow.investor.clone(),\n            escrow.business.clone(),\n            escrow.amount,\n        ),\n    );\n}\n\n/// Emit event when escrow funds are released to business\npub fn emit_escrow_released(\n    env: \u0026Env,\n    escrow_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"esc_rel\"),),\n        (\n            escrow_id.clone(),\n            invoice_id.clone(),\n            business.clone(),\n            amount,\n        ),\n    );\n}\n\n/// Emit event when escrow funds are refunded to investor\npub fn emit_escrow_refunded(\n    env: \u0026Env,\n    escrow_id: \u0026BytesN\u003c32\u003e,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    amount: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"esc_ref\"),),\n        (\n            escrow_id.clone(),\n            invoice_id.clone(),\n            investor.clone(),\n            amount,\n        ),\n    );\n}\n\npub fn emit_bid_expired(env: \u0026Env, bid: \u0026Bid) {\n    env.events().publish(\n        (symbol_short!(\"bid_exp\"),),\n        (\n            bid.bid_id.clone(),\n            bid.invoice_id.clone(),\n            bid.investor.clone(),\n            bid.bid_amount,\n            bid.expiration_timestamp,\n        ),\n    );\n}\n\n/// Emit event when a bid is placed\npub fn emit_bid_placed(env: \u0026Env, bid: \u0026Bid) {\n    env.events().publish(\n        (symbol_short!(\"bid_plc\"),),\n        (\n            bid.bid_id.clone(),\n            bid.invoice_id.clone(),\n            bid.investor.clone(),\n            bid.bid_amount,\n            bid.expected_return,\n            bid.timestamp,\n            bid.expiration_timestamp,\n        ),\n    );\n}\n\n/// Emit event when a bid is withdrawn\npub fn emit_bid_withdrawn(env: \u0026Env, bid: \u0026Bid) {\n    env.events().publish(\n        (symbol_short!(\"bid_wdr\"),),\n        (\n            bid.bid_id.clone(),\n            bid.invoice_id.clone(),\n            bid.investor.clone(),\n            bid.bid_amount,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when backup is created\npub fn emit_backup_created(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, invoice_count: u32) {\n    env.events().publish(\n        (symbol_short!(\"bkup_crt\"),),\n        (backup_id.clone(), invoice_count, env.ledger().timestamp()),\n    );\n}\n\n/// Emit event when backup is restored\npub fn emit_backup_restored(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, invoice_count: u32) {\n    env.events().publish(\n        (symbol_short!(\"bkup_rstr\"),),\n        (backup_id.clone(), invoice_count, env.ledger().timestamp()),\n    );\n}\n\n/// Emit event when backup is validated\npub fn emit_backup_validated(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e, success: bool) {\n    env.events().publish(\n        (symbol_short!(\"bkup_vd\"),),\n        (backup_id.clone(), success, env.ledger().timestamp()),\n    );\n}\n\n/// Emit event when backup is archived\npub fn emit_backup_archived(env: \u0026Env, backup_id: \u0026BytesN\u003c32\u003e) {\n    env.events().publish(\n        (symbol_short!(\"bkup_ar\"),),\n        (backup_id.clone(), env.ledger().timestamp()),\n    );\n}\n\n/// Emit audit validation event\npub fn emit_audit_validation(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, is_valid: bool) {\n    env.events().publish(\n        (symbol_short!(\"aud_val\"),),\n        (invoice_id.clone(), is_valid, env.ledger().timestamp()),\n    );\n}\n\n/// Emit audit query event\npub fn emit_audit_query(env: \u0026Env, query_type: String, result_count: u32) {\n    env.events()\n        .publish((symbol_short!(\"aud_qry\"),), (query_type, result_count));\n}\n\n/// Emit event when invoice category is updated\npub fn emit_invoice_category_updated(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    old_category: \u0026crate::invoice::InvoiceCategory,\n    new_category: \u0026crate::invoice::InvoiceCategory,\n) {\n    env.events().publish(\n        (symbol_short!(\"cat_upd\"),),\n        (\n            invoice_id.clone(),\n            business.clone(),\n            old_category.clone(),\n            new_category.clone(),\n        ),\n    );\n}\n\n/// Emit event when a tag is added to an invoice\npub fn emit_invoice_tag_added(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    tag: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"tag_add\"),),\n        (invoice_id.clone(), business.clone(), tag.clone()),\n    );\n}\n\n/// Emit event when a tag is removed from an invoice\npub fn emit_invoice_tag_removed(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    tag: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"tag_rm\"),),\n        (invoice_id.clone(), business.clone(), tag.clone()),\n    );\n}\n\n/// Emit event when a dispute is created\npub fn emit_dispute_created(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    created_by: \u0026Address,\n    reason: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"dsp_cr\"),),\n        (\n            invoice_id.clone(),\n            created_by.clone(),\n            reason.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when a dispute is put under review\npub fn emit_dispute_under_review(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e, reviewed_by: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"dsp_ur\"),),\n        (\n            invoice_id.clone(),\n            reviewed_by.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when a dispute is resolved\npub fn emit_dispute_resolved(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    resolved_by: \u0026Address,\n    resolution: \u0026String,\n) {\n    env.events().publish(\n        (symbol_short!(\"dsp_rs\"),),\n        (\n            invoice_id.clone(),\n            resolved_by.clone(),\n            resolution.clone(),\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n// Analytics Events\n\n/// Emit event when platform metrics are updated\npub fn emit_platform_metrics_updated(\n    env: \u0026Env,\n    total_invoices: u32,\n    total_volume: i128,\n    total_fees: i128,\n    success_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"plt_met\"),),\n        (\n            total_invoices,\n            total_volume,\n            total_fees,\n            success_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when performance metrics are updated\npub fn emit_performance_metrics_updated(\n    env: \u0026Env,\n    average_settlement_time: u64,\n    transaction_success_rate: i128,\n    user_satisfaction_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"perf_met\"),),\n        (\n            average_settlement_time,\n            transaction_success_rate,\n            user_satisfaction_score,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when user behavior metrics are calculated\npub fn emit_user_behavior_analyzed(\n    env: \u0026Env,\n    user: \u0026Address,\n    total_investments: u32,\n    success_rate: i128,\n    risk_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"usr_beh\"),),\n        (\n            user.clone(),\n            total_investments,\n            success_rate,\n            risk_score,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when financial metrics are calculated\npub fn emit_financial_metrics_calculated(\n    env: \u0026Env,\n    period: \u0026crate::analytics::TimePeriod,\n    total_volume: i128,\n    total_fees: i128,\n    average_return_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"fin_met\"),),\n        (\n            period.clone(),\n            total_volume,\n            total_fees,\n            average_return_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when business report is generated\npub fn emit_business_report_generated(\n    env: \u0026Env,\n    report_id: \u0026BytesN\u003c32\u003e,\n    business: \u0026Address,\n    period: \u0026crate::analytics::TimePeriod,\n    invoices_uploaded: u32,\n    success_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"biz_rpt\"),),\n        (\n            report_id.clone(),\n            business.clone(),\n            period.clone(),\n            invoices_uploaded,\n            success_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when investor report is generated\npub fn emit_investor_report_generated(\n    env: \u0026Env,\n    report_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    period: \u0026crate::analytics::TimePeriod,\n    investments_made: u32,\n    average_return_rate: i128,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_rpt\"),),\n        (\n            report_id.clone(),\n            investor.clone(),\n            period.clone(),\n            investments_made,\n            average_return_rate,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when analytics query is performed\npub fn emit_analytics_query(\n    env: \u0026Env,\n    query_type: \u0026String,\n    filters_applied: u32,\n    result_count: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"anal_qry\"),),\n        (\n            query_type.clone(),\n            filters_applied,\n            result_count,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\n/// Emit event when analytics export is requested\npub fn emit_analytics_export(\n    env: \u0026Env,\n    export_type: \u0026String,\n    requested_by: \u0026Address,\n    record_count: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"anal_exp\"),),\n        (\n            export_type.clone(),\n            requested_by.clone(),\n            record_count,\n            env.ledger().timestamp(),\n        ),\n    );\n}\n\npub fn emit_investor_analytics_updated(\n    env: \u0026Env,\n    investor: \u0026Address,\n    success_rate: i128,\n    risk_score: u32,\n    compliance_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_anal\"),),\n        (investor.clone(), success_rate, risk_score, compliance_score),\n    );\n}\n\npub fn emit_investor_performance_updated(\n    env: \u0026Env,\n    total_investors: u32,\n    verified_investors: u32,\n    platform_success_rate: i128,\n    average_risk_score: u32,\n) {\n    env.events().publish(\n        (symbol_short!(\"inv_perf\"),),\n        (\n            total_investors,\n            verified_investors,\n            platform_success_rate,\n            average_risk_score,\n        ),\n    );\n}\n","traces":[{"line":8,"address":[12400769,12400208,12400803],"length":1,"stats":{"Line":0}},{"line":9,"address":[12400242,12400712],"length":1,"stats":{"Line":0}},{"line":10,"address":[12400265],"length":1,"stats":{"Line":0}},{"line":12,"address":[12400309],"length":1,"stats":{"Line":0}},{"line":13,"address":[12400378],"length":1,"stats":{"Line":0}},{"line":14,"address":[12400443],"length":1,"stats":{"Line":0}},{"line":15,"address":[12400466],"length":1,"stats":{"Line":0}},{"line":16,"address":[12400540],"length":1,"stats":{"Line":0}},{"line":21,"address":[12401224,12401190,12400816],"length":1,"stats":{"Line":3}},{"line":22,"address":[12401133,12400849],"length":1,"stats":{"Line":6}},{"line":23,"address":[12400871],"length":1,"stats":{"Line":3}},{"line":24,"address":[12400915,12400983],"length":1,"stats":{"Line":6}},{"line":28,"address":[12402240,12402859,12402918],"length":1,"stats":{"Line":0}},{"line":29,"address":[12402279,12402704],"length":1,"stats":{"Line":0}},{"line":30,"address":[12402302],"length":1,"stats":{"Line":0}},{"line":32,"address":[12402346],"length":1,"stats":{"Line":0}},{"line":33,"address":[12402411],"length":1,"stats":{"Line":0}},{"line":34,"address":[12402484,12402532],"length":1,"stats":{"Line":0}},{"line":39,"address":[12407232,12408247,12408207],"length":1,"stats":{"Line":0}},{"line":40,"address":[12407291],"length":1,"stats":{"Line":0}},{"line":41,"address":[12407441,12407317],"length":1,"stats":{"Line":0}},{"line":42,"address":[12408310,12407568],"length":1,"stats":{"Line":0}},{"line":45,"address":[12407640,12408138],"length":1,"stats":{"Line":0}},{"line":46,"address":[12407650],"length":1,"stats":{"Line":0}},{"line":48,"address":[12407703],"length":1,"stats":{"Line":0}},{"line":49,"address":[12407780],"length":1,"stats":{"Line":0}},{"line":50,"address":[12407833],"length":1,"stats":{"Line":0}},{"line":51,"address":[12407898],"length":1,"stats":{"Line":0}},{"line":52,"address":[12407961],"length":1,"stats":{"Line":0}},{"line":57,"address":[12406800,12407208,12407174],"length":1,"stats":{"Line":0}},{"line":58,"address":[12406833,12407117],"length":1,"stats":{"Line":0}},{"line":59,"address":[12406855],"length":1,"stats":{"Line":0}},{"line":60,"address":[12406899,12406967],"length":1,"stats":{"Line":0}},{"line":64,"address":[12402221,12401872,12402215],"length":1,"stats":{"Line":2}},{"line":65,"address":[12401905,12402130],"length":1,"stats":{"Line":3}},{"line":66,"address":[12401927],"length":1,"stats":{"Line":2}},{"line":68,"address":[12401971],"length":1,"stats":{"Line":2}},{"line":69,"address":[12402035],"length":1,"stats":{"Line":1}},{"line":70,"address":[12402049],"length":1,"stats":{"Line":1}},{"line":75,"address":[12396632,12396666,12396144],"length":1,"stats":{"Line":1}},{"line":81,"address":[12396229,12396572],"length":1,"stats":{"Line":2}},{"line":82,"address":[12396252],"length":1,"stats":{"Line":2}},{"line":84,"address":[12396296],"length":1,"stats":{"Line":1}},{"line":85,"address":[12396365],"length":1,"stats":{"Line":1}},{"line":92,"address":[12396688,12397376,12397413],"length":1,"stats":{"Line":1}},{"line":100,"address":[12397311,12396797],"length":1,"stats":{"Line":2}},{"line":101,"address":[12396878],"length":1,"stats":{"Line":1}},{"line":103,"address":[12396925],"length":1,"stats":{"Line":1}},{"line":104,"address":[12396993],"length":1,"stats":{"Line":1}},{"line":105,"address":[19334948,19334954,19334432],"length":1,"stats":{"Line":0}},{"line":106,"address":[19334470],"length":1,"stats":{"Line":0}},{"line":108,"address":[12397082],"length":1,"stats":{"Line":1}},{"line":113,"address":[12396089,12396123,12395696],"length":1,"stats":{"Line":0}},{"line":114,"address":[19334894,19334992,19335997],"length":1,"stats":{"Line":0}},{"line":115,"address":[12395751],"length":1,"stats":{"Line":0}},{"line":117,"address":[12395795],"length":1,"stats":{"Line":0}},{"line":118,"address":[12395863],"length":1,"stats":{"Line":0}},{"line":119,"address":[12395927],"length":1,"stats":{"Line":0}},{"line":124,"address":[12403352,12403318,12402944],"length":1,"stats":{"Line":0}},{"line":125,"address":[12402977,12403261],"length":1,"stats":{"Line":0}},{"line":126,"address":[12402999],"length":1,"stats":{"Line":0}},{"line":127,"address":[12403111,12403043],"length":1,"stats":{"Line":0}},{"line":131,"address":[12394864,12395671,12395637],"length":1,"stats":{"Line":0}},{"line":141,"address":[12395577,12395002],"length":1,"stats":{"Line":0}},{"line":142,"address":[12395025],"length":1,"stats":{"Line":0}},{"line":144,"address":[12395075],"length":1,"stats":{"Line":0}},{"line":145,"address":[12395140],"length":1,"stats":{"Line":0}},{"line":146,"address":[12395213],"length":1,"stats":{"Line":0}},{"line":147,"address":[12395274],"length":1,"stats":{"Line":0}},{"line":155,"address":[12411451,12411485,12411008],"length":1,"stats":{"Line":0}},{"line":161,"address":[12411081,12411391],"length":1,"stats":{"Line":0}},{"line":162,"address":[12411104],"length":1,"stats":{"Line":0}},{"line":163,"address":[12411148,12411221],"length":1,"stats":{"Line":0}},{"line":167,"address":[12401248,12401849,12401815],"length":1,"stats":{"Line":0}},{"line":174,"address":[12401755,12401333],"length":1,"stats":{"Line":0}},{"line":175,"address":[12401356],"length":1,"stats":{"Line":0}},{"line":177,"address":[12401400],"length":1,"stats":{"Line":0}},{"line":178,"address":[12401465],"length":1,"stats":{"Line":0}},{"line":179,"address":[12401537],"length":1,"stats":{"Line":0}},{"line":185,"address":[12405200,12405568,12405562],"length":1,"stats":{"Line":0}},{"line":186,"address":[12405234,12405474],"length":1,"stats":{"Line":0}},{"line":187,"address":[12405257],"length":1,"stats":{"Line":0}},{"line":188,"address":[12405402,12405301],"length":1,"stats":{"Line":0}},{"line":193,"address":[12391002,12390336,12390968],"length":1,"stats":{"Line":3}},{"line":194,"address":[12390911,12390369],"length":1,"stats":{"Line":6}},{"line":195,"address":[12390391],"length":1,"stats":{"Line":3}},{"line":197,"address":[12390435],"length":1,"stats":{"Line":3}},{"line":198,"address":[12390503],"length":1,"stats":{"Line":3}},{"line":199,"address":[12390571],"length":1,"stats":{"Line":3}},{"line":200,"address":[12390635],"length":1,"stats":{"Line":3}},{"line":201,"address":[12390702],"length":1,"stats":{"Line":3}},{"line":207,"address":[12394807,12394240,12394841],"length":1,"stats":{"Line":0}},{"line":214,"address":[12394747,12394325],"length":1,"stats":{"Line":0}},{"line":215,"address":[12394348],"length":1,"stats":{"Line":0}},{"line":217,"address":[12394392],"length":1,"stats":{"Line":0}},{"line":218,"address":[12394457],"length":1,"stats":{"Line":0}},{"line":219,"address":[12394529],"length":1,"stats":{"Line":0}},{"line":226,"address":[12394183,12394217,12393616],"length":1,"stats":{"Line":0}},{"line":233,"address":[12394123,12393701],"length":1,"stats":{"Line":0}},{"line":234,"address":[12393724],"length":1,"stats":{"Line":0}},{"line":236,"address":[12393768],"length":1,"stats":{"Line":0}},{"line":237,"address":[12393833],"length":1,"stats":{"Line":0}},{"line":238,"address":[12393905],"length":1,"stats":{"Line":0}},{"line":244,"address":[12388804,12388838,12388272],"length":1,"stats":{"Line":0}},{"line":245,"address":[12388305,12388747],"length":1,"stats":{"Line":0}},{"line":246,"address":[12388327],"length":1,"stats":{"Line":0}},{"line":248,"address":[12388371],"length":1,"stats":{"Line":0}},{"line":249,"address":[12388439],"length":1,"stats":{"Line":0}},{"line":250,"address":[12388507],"length":1,"stats":{"Line":0}},{"line":251,"address":[12388574],"length":1,"stats":{"Line":0}},{"line":252,"address":[12388581],"length":1,"stats":{"Line":0}},{"line":258,"address":[12387280,12387848,12387882],"length":1,"stats":{"Line":3}},{"line":259,"address":[12387313,12387791],"length":1,"stats":{"Line":6}},{"line":260,"address":[12387335],"length":1,"stats":{"Line":3}},{"line":262,"address":[12387379],"length":1,"stats":{"Line":3}},{"line":263,"address":[12387447],"length":1,"stats":{"Line":3}},{"line":264,"address":[12387515],"length":1,"stats":{"Line":3}},{"line":265,"address":[12387582],"length":1,"stats":{"Line":3}},{"line":266,"address":[12387589],"length":1,"stats":{"Line":3}},{"line":267,"address":[12387597],"length":1,"stats":{"Line":3}},{"line":268,"address":[12387601],"length":1,"stats":{"Line":3}},{"line":274,"address":[12389657,12389735,12388864],"length":1,"stats":{"Line":0}},{"line":275,"address":[12388903,12389499],"length":1,"stats":{"Line":0}},{"line":276,"address":[12388926],"length":1,"stats":{"Line":0}},{"line":278,"address":[12388970],"length":1,"stats":{"Line":0}},{"line":279,"address":[12389035],"length":1,"stats":{"Line":0}},{"line":280,"address":[12389104],"length":1,"stats":{"Line":0}},{"line":281,"address":[12389177],"length":1,"stats":{"Line":0}},{"line":282,"address":[12389250,12389202],"length":1,"stats":{"Line":0}},{"line":288,"address":[12390323,12389760,12390286],"length":1,"stats":{"Line":0}},{"line":289,"address":[12389810,12390131],"length":1,"stats":{"Line":0}},{"line":290,"address":[12389833],"length":1,"stats":{"Line":0}},{"line":291,"address":[12389946,12389877],"length":1,"stats":{"Line":0}},{"line":296,"address":[12392755,12392192,12392718],"length":1,"stats":{"Line":0}},{"line":297,"address":[12392242,12392563],"length":1,"stats":{"Line":0}},{"line":298,"address":[12392265],"length":1,"stats":{"Line":0}},{"line":299,"address":[12392378,12392309],"length":1,"stats":{"Line":0}},{"line":304,"address":[12399341,12399304,12398768],"length":1,"stats":{"Line":0}},{"line":305,"address":[12399149,12398822],"length":1,"stats":{"Line":0}},{"line":306,"address":[12398845],"length":1,"stats":{"Line":0}},{"line":307,"address":[12398958,12398889],"length":1,"stats":{"Line":0}},{"line":312,"address":[12392165,12392128,12391632],"length":1,"stats":{"Line":0}},{"line":313,"address":[12391976,12391671],"length":1,"stats":{"Line":0}},{"line":314,"address":[12391694],"length":1,"stats":{"Line":0}},{"line":315,"address":[12391807,12391738],"length":1,"stats":{"Line":0}},{"line":320,"address":[12398749,12398712,12398176],"length":1,"stats":{"Line":0}},{"line":321,"address":[12398557,12398230],"length":1,"stats":{"Line":0}},{"line":322,"address":[12398253],"length":1,"stats":{"Line":0}},{"line":323,"address":[12398366,12398297],"length":1,"stats":{"Line":0}},{"line":328,"address":[12387904,12388237],"length":1,"stats":{"Line":0}},{"line":329,"address":[12387941],"length":1,"stats":{"Line":0}},{"line":330,"address":[12388019],"length":1,"stats":{"Line":0}},{"line":334,"address":[12406786,12406240,12406752],"length":1,"stats":{"Line":0}},{"line":341,"address":[12406692,12406313],"length":1,"stats":{"Line":0}},{"line":342,"address":[12406336],"length":1,"stats":{"Line":0}},{"line":344,"address":[12406380],"length":1,"stats":{"Line":0}},{"line":345,"address":[12406453],"length":1,"stats":{"Line":0}},{"line":346,"address":[12406506],"length":1,"stats":{"Line":0}},{"line":347,"address":[12406563],"length":1,"stats":{"Line":0}},{"line":353,"address":[12403376,12403915,12403881],"length":1,"stats":{"Line":0}},{"line":359,"address":[12403824,12403435],"length":1,"stats":{"Line":0}},{"line":360,"address":[12403458],"length":1,"stats":{"Line":0}},{"line":361,"address":[12403574,12403502],"length":1,"stats":{"Line":0}},{"line":366,"address":[12404475,12404441,12403936],"length":1,"stats":{"Line":0}},{"line":372,"address":[12403995,12404384],"length":1,"stats":{"Line":0}},{"line":373,"address":[12404018],"length":1,"stats":{"Line":0}},{"line":374,"address":[12404062,12404134],"length":1,"stats":{"Line":0}},{"line":379,"address":[12392768,12393520,12393598],"length":1,"stats":{"Line":0}},{"line":385,"address":[12392833,12393362],"length":1,"stats":{"Line":0}},{"line":386,"address":[12392856],"length":1,"stats":{"Line":0}},{"line":388,"address":[12392900],"length":1,"stats":{"Line":0}},{"line":389,"address":[12392969],"length":1,"stats":{"Line":0}},{"line":390,"address":[12393030],"length":1,"stats":{"Line":0}},{"line":391,"address":[12393091,12393139],"length":1,"stats":{"Line":0}},{"line":397,"address":[12405128,12404496,12405187],"length":1,"stats":{"Line":0}},{"line":398,"address":[12404970,12404548],"length":1,"stats":{"Line":0}},{"line":399,"address":[12404571],"length":1,"stats":{"Line":0}},{"line":401,"address":[12404615],"length":1,"stats":{"Line":0}},{"line":402,"address":[12404684],"length":1,"stats":{"Line":0}},{"line":403,"address":[12404793,12404745],"length":1,"stats":{"Line":0}},{"line":409,"address":[12400190,12400112,12399360],"length":1,"stats":{"Line":0}},{"line":415,"address":[12399954,12399425],"length":1,"stats":{"Line":0}},{"line":416,"address":[12399448],"length":1,"stats":{"Line":0}},{"line":418,"address":[12399492],"length":1,"stats":{"Line":0}},{"line":419,"address":[12399561],"length":1,"stats":{"Line":0}},{"line":420,"address":[12399622],"length":1,"stats":{"Line":0}},{"line":421,"address":[12399683,12399731],"length":1,"stats":{"Line":0}},{"line":429,"address":[12408912,12408352,12408906],"length":1,"stats":{"Line":0}},{"line":436,"address":[12408758,12408466],"length":1,"stats":{"Line":0}},{"line":437,"address":[12408489],"length":1,"stats":{"Line":0}},{"line":443,"address":[12408591,12408547],"length":1,"stats":{"Line":0}},{"line":449,"address":[12411986,12411504,12411980],"length":1,"stats":{"Line":0}},{"line":455,"address":[12411832,12411582],"length":1,"stats":{"Line":0}},{"line":456,"address":[12411605],"length":1,"stats":{"Line":0}},{"line":461,"address":[12411660,12411704],"length":1,"stats":{"Line":0}},{"line":467,"address":[12406225,12405584,12406188],"length":1,"stats":{"Line":0}},{"line":474,"address":[12405673,12406033],"length":1,"stats":{"Line":0}},{"line":475,"address":[12405696],"length":1,"stats":{"Line":0}},{"line":477,"address":[12405751],"length":1,"stats":{"Line":0}},{"line":481,"address":[12405808,12405856],"length":1,"stats":{"Line":0}},{"line":487,"address":[12412000,12412587,12412593],"length":1,"stats":{"Line":0}},{"line":494,"address":[12412117,12412433],"length":1,"stats":{"Line":0}},{"line":495,"address":[12412140],"length":1,"stats":{"Line":0}},{"line":497,"address":[12412193],"length":1,"stats":{"Line":0}},{"line":501,"address":[12412257],"length":1,"stats":{"Line":0}},{"line":507,"address":[12409743,12408928,12409684],"length":1,"stats":{"Line":0}},{"line":515,"address":[12409032,12409526],"length":1,"stats":{"Line":0}},{"line":516,"address":[12409055],"length":1,"stats":{"Line":0}},{"line":518,"address":[12409105],"length":1,"stats":{"Line":0}},{"line":519,"address":[12409174],"length":1,"stats":{"Line":0}},{"line":520,"address":[12409227],"length":1,"stats":{"Line":0}},{"line":523,"address":[12409292],"length":1,"stats":{"Line":0}},{"line":529,"address":[12409760,12410575,12410516],"length":1,"stats":{"Line":0}},{"line":537,"address":[12410358,12409864],"length":1,"stats":{"Line":0}},{"line":538,"address":[12409887],"length":1,"stats":{"Line":0}},{"line":540,"address":[12409937],"length":1,"stats":{"Line":0}},{"line":541,"address":[12410006],"length":1,"stats":{"Line":0}},{"line":542,"address":[12410059],"length":1,"stats":{"Line":0}},{"line":545,"address":[12410124],"length":1,"stats":{"Line":0}},{"line":551,"address":[12391608,12391024,12391571],"length":1,"stats":{"Line":0}},{"line":557,"address":[12391085,12391416],"length":1,"stats":{"Line":0}},{"line":558,"address":[12391108],"length":1,"stats":{"Line":0}},{"line":560,"address":[12391160],"length":1,"stats":{"Line":0}},{"line":563,"address":[12391217,12391265],"length":1,"stats":{"Line":0}},{"line":569,"address":[12398104,12397456,12398163],"length":1,"stats":{"Line":0}},{"line":575,"address":[12397946,12397519],"length":1,"stats":{"Line":0}},{"line":576,"address":[12397542],"length":1,"stats":{"Line":0}},{"line":578,"address":[12397594],"length":1,"stats":{"Line":0}},{"line":579,"address":[12397651],"length":1,"stats":{"Line":0}},{"line":581,"address":[12397712,12397760],"length":1,"stats":{"Line":0}},{"line":586,"address":[12410985,12410991,12410592],"length":1,"stats":{"Line":0}},{"line":593,"address":[12410678,12410897],"length":1,"stats":{"Line":0}},{"line":594,"address":[12410701],"length":1,"stats":{"Line":0}},{"line":595,"address":[12410819,12410753],"length":1,"stats":{"Line":0}},{"line":599,"address":[12412881,12412887,12412608],"length":1,"stats":{"Line":0}},{"line":606,"address":[12412817,12412698],"length":1,"stats":{"Line":0}},{"line":607,"address":[12412730],"length":1,"stats":{"Line":0}}],"covered":39,"coverable":237},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","fees.rs"],"content":"use crate::errors::QuickLendXError;\nuse soroban_sdk::{contracttype, symbol_short, vec, Address, Env, Map, Symbol, Vec};\n\n// Constants\nconst MAX_FEE_BPS: u32 = 1000;\nconst MIN_FEE_BPS: u32 = 0;\nconst BPS_DENOMINATOR: i128 = 10_000;\n\n// Storage keys\nconst FEE_CONFIG_KEY: Symbol = symbol_short!(\"fee_cfg\");\nconst REVENUE_KEY: Symbol = symbol_short!(\"revenue\");\nconst VOLUME_KEY: Symbol = symbol_short!(\"volume\");\n\n/// Fee types supported by the platform\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum FeeType {\n    Platform,\n    Processing,\n    Verification,\n    EarlyPayment,\n    LatePayment,\n}\n\n/// Volume tier for discounted fees\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum VolumeTier {\n    Standard,\n    Silver,\n    Gold,\n    Platinum,\n}\n\n/// Fee structure configuration\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct FeeStructure {\n    pub fee_type: FeeType,\n    pub base_fee_bps: u32,\n    pub min_fee: i128,\n    pub max_fee: i128,\n    pub is_active: bool,\n    pub updated_at: u64,\n    pub updated_by: Address,\n}\n\n/// User volume data\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct UserVolumeData {\n    pub user: Address,\n    pub total_volume: i128,\n    pub transaction_count: u32,\n    pub current_tier: VolumeTier,\n    pub last_updated: u64,\n}\n\n/// Revenue configuration\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct RevenueConfig {\n    pub treasury_address: Address,\n    pub treasury_share_bps: u32,\n    pub developer_share_bps: u32,\n    pub platform_share_bps: u32,\n    pub auto_distribution: bool,\n    pub min_distribution_amount: i128,\n}\n\n/// Revenue tracking\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct RevenueData {\n    pub period: u64,\n    pub total_collected: i128,\n    pub fees_by_type: Map\u003cFeeType, i128\u003e,\n    pub total_distributed: i128,\n    pub pending_distribution: i128,\n    pub transaction_count: u32,\n}\n\n/// Fee analytics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct FeeAnalytics {\n    pub period: u64,\n    pub total_fees: i128,\n    pub average_fee_rate: i128,\n    pub total_transactions: u32,\n    pub fee_efficiency_score: u32,\n}\n\npub struct FeeManager;\n\nimpl FeeManager {\n    pub fn initialize(env: \u0026Env, admin: \u0026Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        admin.require_auth();\n        let default_fees = vec![\n            env,\n            FeeStructure {\n                fee_type: FeeType::Platform,\n                base_fee_bps: 200,\n                min_fee: 100,\n                max_fee: 1_000_000,\n                is_active: true,\n                updated_at: env.ledger().timestamp(),\n                updated_by: admin.clone(),\n            },\n            FeeStructure {\n                fee_type: FeeType::Processing,\n                base_fee_bps: 50,\n                min_fee: 50,\n                max_fee: 500_000,\n                is_active: true,\n                updated_at: env.ledger().timestamp(),\n                updated_by: admin.clone(),\n            },\n            FeeStructure {\n                fee_type: FeeType::Verification,\n                base_fee_bps: 100,\n                min_fee: 100,\n                max_fee: 100_000,\n                is_active: true,\n                updated_at: env.ledger().timestamp(),\n                updated_by: admin.clone(),\n            },\n        ];\n        env.storage().instance().set(\u0026FEE_CONFIG_KEY, \u0026default_fees);\n        Ok(())\n    }\n\n    pub fn get_fee_structure(\n        env: \u0026Env,\n        fee_type: \u0026FeeType,\n    ) -\u003e Result\u003cFeeStructure, QuickLendXError\u003e {\n        let fee_structures: Vec\u003cFeeStructure\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026FEE_CONFIG_KEY)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        for i in 0..fee_structures.len() {\n            let structure = fee_structures.get(i).unwrap();\n            if structure.fee_type == *fee_type {\n                return Ok(structure);\n            }\n        }\n        Err(QuickLendXError::StorageKeyNotFound)\n    }\n\n    pub fn update_fee_structure(\n        env: \u0026Env,\n        admin: \u0026Address,\n        fee_type: FeeType,\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n        is_active: bool,\n    ) -\u003e Result\u003cFeeStructure, QuickLendXError\u003e {\n        admin.require_auth();\n        if base_fee_bps \u003e MAX_FEE_BPS {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        if min_fee \u003c 0 || max_fee \u003c min_fee {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let mut fee_structures: Vec\u003cFeeStructure\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026FEE_CONFIG_KEY)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let mut found = false;\n        let updated_structure = FeeStructure {\n            fee_type: fee_type.clone(),\n            base_fee_bps,\n            min_fee,\n            max_fee,\n            is_active,\n            updated_at: env.ledger().timestamp(),\n            updated_by: admin.clone(),\n        };\n        for i in 0..fee_structures.len() {\n            let structure = fee_structures.get(i).unwrap();\n            if structure.fee_type == fee_type {\n                fee_structures.set(i, updated_structure.clone());\n                found = true;\n                break;\n            }\n        }\n        if !found {\n            fee_structures.push_back(updated_structure.clone());\n        }\n        env.storage()\n            .instance()\n            .set(\u0026FEE_CONFIG_KEY, \u0026fee_structures);\n        Ok(updated_structure)\n    }\n\n    pub fn calculate_total_fees(\n        env: \u0026Env,\n        user: \u0026Address,\n        transaction_amount: i128,\n        is_early_payment: bool,\n        is_late_payment: bool,\n    ) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        if transaction_amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let fee_structures: Vec\u003cFeeStructure\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026FEE_CONFIG_KEY)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let user_volume_data = Self::get_user_volume(env, user);\n        let tier_discount = Self::get_tier_discount(\u0026user_volume_data.current_tier);\n        let mut total_fees: i128 = 0;\n        for i in 0..fee_structures.len() {\n            let structure = fee_structures.get(i).unwrap();\n            if !structure.is_active {\n                continue;\n            }\n            if structure.fee_type == FeeType::EarlyPayment \u0026\u0026 !is_early_payment {\n                continue;\n            }\n            if structure.fee_type == FeeType::LatePayment \u0026\u0026 !is_late_payment {\n                continue;\n            }\n            let mut fee = Self::calculate_base_fee(\u0026structure, transaction_amount)?;\n            if structure.fee_type != FeeType::LatePayment {\n                fee = fee - (fee * tier_discount as i128 / BPS_DENOMINATOR);\n            }\n            if is_early_payment \u0026\u0026 structure.fee_type == FeeType::Platform {\n                fee = fee - (fee * 1000 / BPS_DENOMINATOR);\n            }\n            if is_late_payment \u0026\u0026 structure.fee_type == FeeType::LatePayment {\n                fee = fee + (fee * 2000 / BPS_DENOMINATOR);\n            }\n            total_fees += fee;\n        }\n        Ok(total_fees)\n    }\n\n    fn calculate_base_fee(structure: \u0026FeeStructure, amount: i128) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        let fee = amount * structure.base_fee_bps as i128 / BPS_DENOMINATOR;\n        let fee = if fee \u003c structure.min_fee {\n            structure.min_fee\n        } else if fee \u003e structure.max_fee {\n            structure.max_fee\n        } else {\n            fee\n        };\n        Ok(fee)\n    }\n\n    fn get_tier_discount(tier: \u0026VolumeTier) -\u003e u32 {\n        match tier {\n            VolumeTier::Standard =\u003e 0,\n            VolumeTier::Silver =\u003e 500,\n            VolumeTier::Gold =\u003e 1000,\n            VolumeTier::Platinum =\u003e 1500,\n        }\n    }\n\n    pub fn get_user_volume(env: \u0026Env, user: \u0026Address) -\u003e UserVolumeData {\n        let key = (VOLUME_KEY, user.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or(UserVolumeData {\n                user: user.clone(),\n                total_volume: 0,\n                transaction_count: 0,\n                current_tier: VolumeTier::Standard,\n                last_updated: env.ledger().timestamp(),\n            })\n    }\n\n    pub fn update_user_volume(\n        env: \u0026Env,\n        user: \u0026Address,\n        transaction_amount: i128,\n    ) -\u003e Result\u003cUserVolumeData, QuickLendXError\u003e {\n        let mut volume_data = Self::get_user_volume(env, user);\n        volume_data.total_volume = volume_data.total_volume.saturating_add(transaction_amount);\n        volume_data.transaction_count = volume_data.transaction_count.saturating_add(1);\n        volume_data.last_updated = env.ledger().timestamp();\n        volume_data.current_tier = if volume_data.total_volume \u003e= 1_000_000_000_000 {\n            VolumeTier::Platinum\n        } else if volume_data.total_volume \u003e= 500_000_000_000 {\n            VolumeTier::Gold\n        } else if volume_data.total_volume \u003e= 100_000_000_000 {\n            VolumeTier::Silver\n        } else {\n            VolumeTier::Standard\n        };\n        let key = (VOLUME_KEY, user.clone());\n        env.storage().instance().set(\u0026key, \u0026volume_data);\n        Ok(volume_data)\n    }\n\n    pub fn collect_fees(\n        env: \u0026Env,\n        user: \u0026Address,\n        fees_collected: Map\u003cFeeType, i128\u003e,\n        total_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let period = Self::get_current_period(env);\n        let key = (REVENUE_KEY, period);\n        let mut revenue_data: RevenueData =\n            env.storage().instance().get(\u0026key).unwrap_or(RevenueData {\n                period,\n                total_collected: 0,\n                fees_by_type: Map::new(env),\n                total_distributed: 0,\n                pending_distribution: 0,\n                transaction_count: 0,\n            });\n        revenue_data.total_collected = revenue_data.total_collected.saturating_add(total_amount);\n        revenue_data.pending_distribution = revenue_data\n            .pending_distribution\n            .saturating_add(total_amount);\n        revenue_data.transaction_count = revenue_data.transaction_count.saturating_add(1);\n        // Copy fees by type into revenue data\n        revenue_data.fees_by_type = fees_collected;\n        env.storage().instance().set(\u0026key, \u0026revenue_data);\n        Self::update_user_volume(env, user, total_amount)?;\n        Ok(())\n    }\n\n    fn get_current_period(env: \u0026Env) -\u003e u64 {\n        env.ledger().timestamp() / 2_592_000\n    }\n\n    pub fn configure_revenue_distribution(\n        env: \u0026Env,\n        admin: \u0026Address,\n        config: RevenueConfig,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        admin.require_auth();\n        let total_shares =\n            config.treasury_share_bps + config.developer_share_bps + config.platform_share_bps;\n        if total_shares != 10_000 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let key = symbol_short!(\"rev_cfg\");\n        env.storage().instance().set(\u0026key, \u0026config);\n        Ok(())\n    }\n\n    pub fn distribute_revenue(\n        env: \u0026Env,\n        admin: \u0026Address,\n        period: u64,\n    ) -\u003e Result\u003c(i128, i128, i128), QuickLendXError\u003e {\n        admin.require_auth();\n        let config: RevenueConfig = env\n            .storage()\n            .instance()\n            .get(\u0026symbol_short!(\"rev_cfg\"))\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let revenue_key = (REVENUE_KEY, period);\n        let mut revenue_data: RevenueData = env\n            .storage()\n            .instance()\n            .get(\u0026revenue_key)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        if revenue_data.pending_distribution \u003c config.min_distribution_amount {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        let amount = revenue_data.pending_distribution;\n        let treasury_amount = amount * config.treasury_share_bps as i128 / BPS_DENOMINATOR;\n        let developer_amount = amount * config.developer_share_bps as i128 / BPS_DENOMINATOR;\n        let platform_amount = amount - treasury_amount - developer_amount;\n        revenue_data.total_distributed = revenue_data.total_distributed.saturating_add(amount);\n        revenue_data.pending_distribution = 0;\n        env.storage().instance().set(\u0026revenue_key, \u0026revenue_data);\n        Ok((treasury_amount, developer_amount, platform_amount))\n    }\n\n    pub fn get_analytics(env: \u0026Env, period: u64) -\u003e Result\u003cFeeAnalytics, QuickLendXError\u003e {\n        let revenue_key = (REVENUE_KEY, period);\n        let revenue_data: RevenueData = env\n            .storage()\n            .instance()\n            .get(\u0026revenue_key)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let average_fee_rate = if revenue_data.transaction_count \u003e 0 {\n            revenue_data.total_collected / revenue_data.transaction_count as i128\n        } else {\n            0\n        };\n        let efficiency_score = if revenue_data.total_collected \u003e 0 {\n            let distributed_pct =\n                revenue_data.total_distributed * 100 / revenue_data.total_collected;\n            distributed_pct.min(100) as u32\n        } else {\n            0\n        };\n        Ok(FeeAnalytics {\n            period,\n            total_fees: revenue_data.total_collected,\n            average_fee_rate,\n            total_transactions: revenue_data.transaction_count,\n            fee_efficiency_score: efficiency_score,\n        })\n    }\n\n    pub fn validate_fee_params(\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        if base_fee_bps \u003c MIN_FEE_BPS || base_fee_bps \u003e MAX_FEE_BPS {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        if min_fee \u003c 0 || max_fee \u003c 0 || max_fee \u003c min_fee {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":97,"address":[13746688,13748406,13748400],"length":1,"stats":{"Line":0}},{"line":98,"address":[13746734],"length":1,"stats":{"Line":0}},{"line":99,"address":[13747552,13747079,13748427,13747015,13747359,13747295],"length":1,"stats":{"Line":0}},{"line":101,"address":[13746861],"length":1,"stats":{"Line":0}},{"line":107,"address":[13746761],"length":1,"stats":{"Line":0}},{"line":108,"address":[13746844],"length":1,"stats":{"Line":0}},{"line":110,"address":[13747141],"length":1,"stats":{"Line":0}},{"line":111,"address":[24170064,24166087,24165029,24166016,24166848,24170139,24165024,24166950],"length":1,"stats":{"Line":0}},{"line":116,"address":[13747000,13747047],"length":1,"stats":{"Line":0}},{"line":117,"address":[13747124],"length":1,"stats":{"Line":0}},{"line":119,"address":[24170087,24166893,24166061],"length":1,"stats":{"Line":0}},{"line":125,"address":[13747280,13747327],"length":1,"stats":{"Line":0}},{"line":126,"address":[13747404],"length":1,"stats":{"Line":0}},{"line":129,"address":[13748087],"length":1,"stats":{"Line":0}},{"line":130,"address":[24166075,24166933,24166876,24170107],"length":1,"stats":{"Line":0}},{"line":133,"address":[13753957,13753963,13752960],"length":1,"stats":{"Line":0}},{"line":137,"address":[13753245,13753295],"length":1,"stats":{"Line":0}},{"line":140,"address":[13753084],"length":1,"stats":{"Line":0}},{"line":141,"address":[13753396,13753040,13753160,13753284,13753976],"length":1,"stats":{"Line":0}},{"line":142,"address":[13753577],"length":1,"stats":{"Line":0}},{"line":143,"address":[13753726,13753771],"length":1,"stats":{"Line":0}},{"line":144,"address":[13753806,13753869],"length":1,"stats":{"Line":0}},{"line":145,"address":[24070405],"length":1,"stats":{"Line":0}},{"line":148,"address":[13753738],"length":1,"stats":{"Line":0}},{"line":151,"address":[13762240,13764278,13764272],"length":1,"stats":{"Line":0}},{"line":160,"address":[13762385],"length":1,"stats":{"Line":0}},{"line":161,"address":[13762399],"length":1,"stats":{"Line":0}},{"line":162,"address":[13762428],"length":1,"stats":{"Line":0}},{"line":164,"address":[13762466,13762416],"length":1,"stats":{"Line":0}},{"line":165,"address":[13762481],"length":1,"stats":{"Line":0}},{"line":167,"address":[13762804,13762751],"length":1,"stats":{"Line":0}},{"line":170,"address":[24070687],"length":1,"stats":{"Line":0}},{"line":171,"address":[24070658],"length":1,"stats":{"Line":0}},{"line":172,"address":[13763096],"length":1,"stats":{"Line":0}},{"line":174,"address":[13763112],"length":1,"stats":{"Line":0}},{"line":179,"address":[13763136],"length":1,"stats":{"Line":0}},{"line":180,"address":[13763224],"length":1,"stats":{"Line":0}},{"line":182,"address":[13763457],"length":1,"stats":{"Line":0}},{"line":183,"address":[13763639,13763613],"length":1,"stats":{"Line":0}},{"line":184,"address":[13763740,13763669],"length":1,"stats":{"Line":0}},{"line":185,"address":[13763780],"length":1,"stats":{"Line":0}},{"line":186,"address":[13763814],"length":1,"stats":{"Line":0}},{"line":190,"address":[13763620],"length":1,"stats":{"Line":0}},{"line":191,"address":[13763856,13763899],"length":1,"stats":{"Line":0}},{"line":193,"address":[24070808],"length":1,"stats":{"Line":0}},{"line":195,"address":[13763979,13763935],"length":1,"stats":{"Line":0}},{"line":196,"address":[13764197],"length":1,"stats":{"Line":0}},{"line":199,"address":[13762105,13762111,13759088],"length":1,"stats":{"Line":0}},{"line":206,"address":[13759240],"length":1,"stats":{"Line":0}},{"line":207,"address":[13759316],"length":1,"stats":{"Line":0}},{"line":209,"address":[13759598,13759542],"length":1,"stats":{"Line":0}},{"line":212,"address":[13759378],"length":1,"stats":{"Line":0}},{"line":213,"address":[13759584,13759334,13759454,13759711,13762124],"length":1,"stats":{"Line":0}},{"line":214,"address":[13759914],"length":1,"stats":{"Line":0}},{"line":215,"address":[13759987,13759921],"length":1,"stats":{"Line":0}},{"line":216,"address":[13759994],"length":1,"stats":{"Line":0}},{"line":217,"address":[24107308],"length":1,"stats":{"Line":0}},{"line":218,"address":[13760297,13760208],"length":1,"stats":{"Line":0}},{"line":219,"address":[24107301],"length":1,"stats":{"Line":0}},{"line":222,"address":[13760431,13760355,13760473],"length":1,"stats":{"Line":0}},{"line":225,"address":[13760489,13760437,13760541],"length":1,"stats":{"Line":0}},{"line":226,"address":[24107432],"length":1,"stats":{"Line":0}},{"line":228,"address":[13760566,13760527],"length":1,"stats":{"Line":0}},{"line":229,"address":[24107449],"length":1,"stats":{"Line":0}},{"line":230,"address":[13761113,13760744],"length":1,"stats":{"Line":0}},{"line":232,"address":[13760724,13761537,13761154],"length":1,"stats":{"Line":0}},{"line":233,"address":[13761542,13761196],"length":1,"stats":{"Line":0}},{"line":235,"address":[13761627,13761141,13761966],"length":1,"stats":{"Line":0}},{"line":236,"address":[13761971,13761663],"length":1,"stats":{"Line":0}},{"line":238,"address":[13761563,13762002,13762036],"length":1,"stats":{"Line":0}},{"line":240,"address":[13760223],"length":1,"stats":{"Line":0}},{"line":243,"address":[13754160],"length":1,"stats":{"Line":0}},{"line":244,"address":[13754449,13754211],"length":1,"stats":{"Line":0}},{"line":245,"address":[24069448],"length":1,"stats":{"Line":0}},{"line":246,"address":[13754500],"length":1,"stats":{"Line":0}},{"line":247,"address":[24069452],"length":1,"stats":{"Line":0}},{"line":248,"address":[13754546],"length":1,"stats":{"Line":0}},{"line":250,"address":[24069697,24069490],"length":1,"stats":{"Line":0}},{"line":252,"address":[13754574],"length":1,"stats":{"Line":0}},{"line":255,"address":[13754080],"length":1,"stats":{"Line":0}},{"line":256,"address":[13754085],"length":1,"stats":{"Line":0}},{"line":257,"address":[13754116],"length":1,"stats":{"Line":0}},{"line":258,"address":[13754126],"length":1,"stats":{"Line":0}},{"line":259,"address":[13754136],"length":1,"stats":{"Line":0}},{"line":260,"address":[24069833],"length":1,"stats":{"Line":0}},{"line":264,"address":[13751888,13752901,13752937],"length":1,"stats":{"Line":0}},{"line":265,"address":[13751939],"length":1,"stats":{"Line":0}},{"line":266,"address":[13752145,13752621],"length":1,"stats":{"Line":0}},{"line":268,"address":[13752323,13752274],"length":1,"stats":{"Line":0}},{"line":269,"address":[13752522,13752645],"length":1,"stats":{"Line":0}},{"line":270,"address":[13752339],"length":1,"stats":{"Line":0}},{"line":271,"address":[24069665],"length":1,"stats":{"Line":0}},{"line":272,"address":[24069682],"length":1,"stats":{"Line":0}},{"line":274,"address":[13752396,13752444],"length":1,"stats":{"Line":0}},{"line":278,"address":[13758885,13758891,13757776],"length":1,"stats":{"Line":0}},{"line":283,"address":[13757845],"length":1,"stats":{"Line":0}},{"line":284,"address":[13757881,13757959],"length":1,"stats":{"Line":0}},{"line":285,"address":[13757969],"length":1,"stats":{"Line":0}},{"line":286,"address":[13758016],"length":1,"stats":{"Line":0}},{"line":287,"address":[13758190,13758257,13758118],"length":1,"stats":{"Line":0}},{"line":288,"address":[13758182],"length":1,"stats":{"Line":0}},{"line":289,"address":[13758232,13758150],"length":1,"stats":{"Line":0}},{"line":290,"address":[13758224],"length":1,"stats":{"Line":0}},{"line":291,"address":[24068643],"length":1,"stats":{"Line":0}},{"line":292,"address":[24068652],"length":1,"stats":{"Line":0}},{"line":294,"address":[13758234],"length":1,"stats":{"Line":0}},{"line":296,"address":[13758271],"length":1,"stats":{"Line":0}},{"line":297,"address":[13758484,13758531],"length":1,"stats":{"Line":0}},{"line":298,"address":[13758711],"length":1,"stats":{"Line":0}},{"line":301,"address":[13750148,13750172,13748464],"length":1,"stats":{"Line":0}},{"line":307,"address":[13748615,13748528],"length":1,"stats":{"Line":0}},{"line":308,"address":[24068822],"length":1,"stats":{"Line":0}},{"line":309,"address":[13748864,13748722,13748811,13748678,13748930],"length":1,"stats":{"Line":0}},{"line":311,"address":[24068867],"length":1,"stats":{"Line":0}},{"line":312,"address":[24068871],"length":1,"stats":{"Line":0}},{"line":313,"address":[13748880],"length":1,"stats":{"Line":0}},{"line":316,"address":[24068902],"length":1,"stats":{"Line":0}},{"line":318,"address":[13749245],"length":1,"stats":{"Line":0}},{"line":319,"address":[13749357,13749314],"length":1,"stats":{"Line":0}},{"line":320,"address":[24069216],"length":1,"stats":{"Line":0}},{"line":321,"address":[24069238],"length":1,"stats":{"Line":0}},{"line":322,"address":[24069243],"length":1,"stats":{"Line":0}},{"line":324,"address":[13749412],"length":1,"stats":{"Line":0}},{"line":325,"address":[13749588],"length":1,"stats":{"Line":0}},{"line":326,"address":[24069285,24069256,24069280],"length":1,"stats":{"Line":0}},{"line":327,"address":[24069274],"length":1,"stats":{"Line":0}},{"line":330,"address":[13757632,13757753,13757759],"length":1,"stats":{"Line":0}},{"line":331,"address":[24068970],"length":1,"stats":{"Line":0}},{"line":334,"address":[24069120],"length":1,"stats":{"Line":0}},{"line":339,"address":[13764446],"length":1,"stats":{"Line":0}},{"line":340,"address":[13764579,13764499],"length":1,"stats":{"Line":0}},{"line":342,"address":[13764570],"length":1,"stats":{"Line":0}},{"line":343,"address":[13764658],"length":1,"stats":{"Line":0}},{"line":345,"address":[24069096],"length":1,"stats":{"Line":0}},{"line":346,"address":[13764717,13764646],"length":1,"stats":{"Line":0}},{"line":347,"address":[13764877],"length":1,"stats":{"Line":0}},{"line":350,"address":[13757430,13757504,13754608],"length":1,"stats":{"Line":0}},{"line":355,"address":[13754690],"length":1,"stats":{"Line":0}},{"line":356,"address":[24069888],"length":1,"stats":{"Line":0}},{"line":359,"address":[13754799],"length":1,"stats":{"Line":0}},{"line":360,"address":[13755005,13757517,13754875,13754755,13755196],"length":1,"stats":{"Line":0}},{"line":361,"address":[13755391],"length":1,"stats":{"Line":0}},{"line":362,"address":[13755683,13755739],"length":1,"stats":{"Line":0}},{"line":365,"address":[24069983,24069999],"length":1,"stats":{"Line":0}},{"line":366,"address":[13755526,13755725,13755598,13757451,13755980],"length":1,"stats":{"Line":0}},{"line":367,"address":[13756099],"length":1,"stats":{"Line":0}},{"line":368,"address":[13756334],"length":1,"stats":{"Line":0}},{"line":370,"address":[13756145],"length":1,"stats":{"Line":0}},{"line":371,"address":[13756618,13756365,13756190],"length":1,"stats":{"Line":0}},{"line":372,"address":[13756506,13756639,13756811],"length":1,"stats":{"Line":0}},{"line":373,"address":[13756786,13756852,13756969],"length":1,"stats":{"Line":0}},{"line":374,"address":[13756937,13757007],"length":1,"stats":{"Line":0}},{"line":375,"address":[13757023],"length":1,"stats":{"Line":0}},{"line":376,"address":[13757055],"length":1,"stats":{"Line":0}},{"line":377,"address":[13757281],"length":1,"stats":{"Line":0}},{"line":380,"address":[13751808,13751867,13750208],"length":1,"stats":{"Line":0}},{"line":381,"address":[13750246],"length":1,"stats":{"Line":0}},{"line":382,"address":[13750538,13750591],"length":1,"stats":{"Line":0}},{"line":385,"address":[13750446],"length":1,"stats":{"Line":0}},{"line":386,"address":[13751814,13750381,13750832,13750453,13750577],"length":1,"stats":{"Line":0}},{"line":387,"address":[13751198,13750951,13750985],"length":1,"stats":{"Line":0}},{"line":388,"address":[13751096,13750987,13751203],"length":1,"stats":{"Line":0}},{"line":390,"address":[13750961],"length":1,"stats":{"Line":0}},{"line":392,"address":[13751777,13751232,13751041],"length":1,"stats":{"Line":0}},{"line":393,"address":[13751237,13751542,13751745],"length":1,"stats":{"Line":0}},{"line":395,"address":[13751770,13751734],"length":1,"stats":{"Line":0}},{"line":397,"address":[13751221],"length":1,"stats":{"Line":0}},{"line":399,"address":[13751428],"length":1,"stats":{"Line":0}},{"line":400,"address":[24070234],"length":1,"stats":{"Line":0}},{"line":401,"address":[13751382],"length":1,"stats":{"Line":0}},{"line":402,"address":[13751398],"length":1,"stats":{"Line":0}},{"line":403,"address":[13751414],"length":1,"stats":{"Line":0}},{"line":404,"address":[13751421],"length":1,"stats":{"Line":0}},{"line":408,"address":[13758928],"length":1,"stats":{"Line":0}},{"line":413,"address":[13758976],"length":1,"stats":{"Line":0}},{"line":414,"address":[13758992],"length":1,"stats":{"Line":0}},{"line":416,"address":[13759056,13759007],"length":1,"stats":{"Line":0}},{"line":417,"address":[13759026],"length":1,"stats":{"Line":0}},{"line":419,"address":[13759066],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":179},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","investment.rs"],"content":"use crate::errors::QuickLendXError;\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env, Symbol, Vec};\n\n/// Premium rate applied to the covered amount expressed in basis points (1/10,000).\npub const DEFAULT_INSURANCE_PREMIUM_BPS: i128 = 200; // 2% of the covered amount.\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct InsuranceCoverage {\n    pub provider: Address,\n    pub coverage_amount: i128,\n    pub premium_amount: i128,\n    pub coverage_percentage: u32,\n    pub active: bool,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum InvestmentStatus {\n    Active,\n    Withdrawn,\n    Completed,\n    Defaulted,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Investment {\n    pub investment_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub investor: Address,\n    pub amount: i128,\n    pub funded_at: u64,\n    pub status: InvestmentStatus,\n    pub insurance: Vec\u003cInsuranceCoverage\u003e,\n}\n\nimpl Investment {\n    pub fn calculate_premium(amount: i128, coverage_percentage: u32) -\u003e i128 {\n        if amount \u003c= 0 || coverage_percentage == 0 {\n            return 0;\n        }\n\n        let coverage_amount = amount\n            .saturating_mul(coverage_percentage as i128)\n            .checked_div(100)\n            .unwrap_or(0);\n\n        let premium = coverage_amount\n            .saturating_mul(DEFAULT_INSURANCE_PREMIUM_BPS)\n            .checked_div(10_000)\n            .unwrap_or(0);\n\n        if premium == 0 \u0026\u0026 coverage_amount \u003e 0 {\n            1\n        } else {\n            premium\n        }\n    }\n\n    pub fn add_insurance(\n        \u0026mut self,\n        provider: Address,\n        coverage_percentage: u32,\n        premium: i128,\n    ) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        if coverage_percentage == 0 || coverage_percentage \u003e 100 {\n            return Err(QuickLendXError::InvalidCoveragePercentage);\n        }\n\n        if premium \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        for coverage in self.insurance.iter() {\n            if coverage.active {\n                return Err(QuickLendXError::OperationNotAllowed);\n            }\n        }\n\n        let coverage_amount = self\n            .amount\n            .saturating_mul(coverage_percentage as i128)\n            .checked_div(100)\n            .unwrap_or(0);\n\n        self.insurance.push_back(InsuranceCoverage {\n            provider,\n            coverage_amount,\n            premium_amount: premium,\n            coverage_percentage,\n            active: true,\n        });\n\n        Ok(coverage_amount)\n    }\n\n    pub fn has_active_insurance(\u0026self) -\u003e bool {\n        for coverage in self.insurance.iter() {\n            if coverage.active {\n                return true;\n            }\n        }\n        false\n    }\n\n    pub fn process_insurance_claim(\u0026mut self) -\u003e Option\u003c(Address, i128)\u003e {\n        let len = self.insurance.len();\n        for idx in 0..len {\n            if let Some(mut coverage) = self.insurance.get(idx) {\n                if coverage.active {\n                    coverage.active = false;\n                    let provider = coverage.provider.clone();\n                    let amount = coverage.coverage_amount;\n                    self.insurance.set(idx, coverage);\n                    return Some((provider, amount));\n                }\n            }\n        }\n        None\n    }\n}\n\npub struct InvestmentStorage;\n\nimpl InvestmentStorage {\n    fn invoice_index_key(invoice_id: \u0026BytesN\u003c32\u003e) -\u003e (Symbol, BytesN\u003c32\u003e) {\n        (symbol_short!(\"inv_map\"), invoice_id.clone())\n    }\n\n    /// Generate a unique investment ID using timestamp and counter\n    pub fn generate_unique_investment_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"invst_cnt\");\n        let counter = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add investment prefix to distinguish from other entity types\n        id_bytes[0] = 0x1A; // 'I' for Investment\n        id_bytes[1] = 0x4E; // 'N' for iNvestment\n                            // Embed timestamp in next 8 bytes\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter in next 8 bytes\n        id_bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes with a pattern to ensure uniqueness\n        for i in 18..32 {\n            id_bytes[i] = ((timestamp + counter as u64 + 0x1A4E) % 256) as u8;\n        }\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    pub fn store_investment(env: \u0026Env, investment: \u0026Investment) {\n        env.storage()\n            .instance()\n            .set(\u0026investment.investment_id, investment);\n\n        env.storage().instance().set(\n            \u0026Self::invoice_index_key(\u0026investment.invoice_id),\n            \u0026investment.investment_id,\n        );\n    }\n    pub fn get_investment(env: \u0026Env, investment_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvestment\u003e {\n        env.storage().instance().get(investment_id)\n    }\n    pub fn get_investment_by_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvestment\u003e {\n        let index_key = Self::invoice_index_key(invoice_id);\n        let investment_id: Option\u003cBytesN\u003c32\u003e\u003e = env.storage().instance().get(\u0026index_key);\n        investment_id.and_then(|id| Self::get_investment(env, \u0026id))\n    }\n    pub fn update_investment(env: \u0026Env, investment: \u0026Investment) {\n        env.storage()\n            .instance()\n            .set(\u0026investment.investment_id, investment);\n\n        env.storage().instance().set(\n            \u0026Self::invoice_index_key(\u0026investment.invoice_id),\n            \u0026investment.investment_id,\n        );\n    }\n}\n","traces":[{"line":39,"address":[12580800],"length":1,"stats":{"Line":0}},{"line":40,"address":[12580835],"length":1,"stats":{"Line":0}},{"line":41,"address":[12580856],"length":1,"stats":{"Line":0}},{"line":45,"address":[12580893],"length":1,"stats":{"Line":0}},{"line":50,"address":[12581020],"length":1,"stats":{"Line":0}},{"line":54,"address":[12581155,12581128],"length":1,"stats":{"Line":0}},{"line":55,"address":[12581178],"length":1,"stats":{"Line":0}},{"line":57,"address":[12581145],"length":1,"stats":{"Line":0}},{"line":61,"address":[12579872,12580764],"length":1,"stats":{"Line":0}},{"line":67,"address":[12579944],"length":1,"stats":{"Line":0}},{"line":68,"address":[12579979],"length":1,"stats":{"Line":0}},{"line":71,"address":[12580007],"length":1,"stats":{"Line":0}},{"line":72,"address":[12580051],"length":1,"stats":{"Line":0}},{"line":75,"address":[12580024,12580213,12580123],"length":1,"stats":{"Line":0}},{"line":76,"address":[12580266],"length":1,"stats":{"Line":0}},{"line":77,"address":[12580708],"length":1,"stats":{"Line":0}},{"line":81,"address":[12580376,12580309,12580465],"length":1,"stats":{"Line":0}},{"line":83,"address":[12580316],"length":1,"stats":{"Line":0}},{"line":87,"address":[12580534,12580481],"length":1,"stats":{"Line":0}},{"line":88,"address":[12580488],"length":1,"stats":{"Line":0}},{"line":95,"address":[12580658],"length":1,"stats":{"Line":0}},{"line":98,"address":[12581216,12581493,12581487],"length":1,"stats":{"Line":0}},{"line":99,"address":[12581234,12581343],"length":1,"stats":{"Line":0}},{"line":100,"address":[12581396],"length":1,"stats":{"Line":0}},{"line":101,"address":[12581455],"length":1,"stats":{"Line":0}},{"line":104,"address":[12581418],"length":1,"stats":{"Line":0}},{"line":107,"address":[12582244,12581520,12582238],"length":1,"stats":{"Line":0}},{"line":108,"address":[12581558],"length":1,"stats":{"Line":0}},{"line":109,"address":[12581587,12581603],"length":1,"stats":{"Line":0}},{"line":110,"address":[12581722,12581784,12581654],"length":1,"stats":{"Line":0}},{"line":111,"address":[12581753],"length":1,"stats":{"Line":0}},{"line":112,"address":[12581789],"length":1,"stats":{"Line":0}},{"line":113,"address":[12581797],"length":1,"stats":{"Line":0}},{"line":114,"address":[12581870],"length":1,"stats":{"Line":0}},{"line":115,"address":[12581911],"length":1,"stats":{"Line":0}},{"line":116,"address":[12582095],"length":1,"stats":{"Line":0}},{"line":120,"address":[12581705],"length":1,"stats":{"Line":0}},{"line":127,"address":[12583267,12583104,12583273],"length":1,"stats":{"Line":3}},{"line":128,"address":[12583125],"length":1,"stats":{"Line":3}},{"line":132,"address":[12584336,12585879,12585885],"length":1,"stats":{"Line":1}},{"line":133,"address":[12584391],"length":1,"stats":{"Line":1}},{"line":134,"address":[12584508],"length":1,"stats":{"Line":2}},{"line":135,"address":[12584612,12584561],"length":1,"stats":{"Line":6}},{"line":136,"address":[12584869],"length":1,"stats":{"Line":3}},{"line":138,"address":[12585124],"length":1,"stats":{"Line":3}},{"line":140,"address":[12585144],"length":1,"stats":{"Line":2}},{"line":141,"address":[12585152],"length":1,"stats":{"Line":3}},{"line":143,"address":[12585160],"length":1,"stats":{"Line":3}},{"line":145,"address":[12585328],"length":1,"stats":{"Line":3}},{"line":147,"address":[12585484,12585843],"length":1,"stats":{"Line":6}},{"line":148,"address":[12585647,12585735,12585853],"length":1,"stats":{"Line":6}},{"line":151,"address":[12585681],"length":1,"stats":{"Line":3}},{"line":154,"address":[12583091,12582608,12583085],"length":1,"stats":{"Line":1}},{"line":155,"address":[12582657],"length":1,"stats":{"Line":2}},{"line":157,"address":[12582729,12582683],"length":1,"stats":{"Line":3}},{"line":159,"address":[12582988,12582834],"length":1,"stats":{"Line":6}},{"line":160,"address":[12582909],"length":1,"stats":{"Line":3}},{"line":161,"address":[12582971],"length":1,"stats":{"Line":3}},{"line":164,"address":[12582586,12582580,12582368],"length":1,"stats":{"Line":1}},{"line":165,"address":[12582413,12582495],"length":1,"stats":{"Line":2}},{"line":167,"address":[12584321,12583792,12584293],"length":1,"stats":{"Line":1}},{"line":168,"address":[12583841],"length":1,"stats":{"Line":1}},{"line":169,"address":[12583916,12583872],"length":1,"stats":{"Line":2}},{"line":170,"address":[12584191],"length":1,"stats":{"Line":3}},{"line":172,"address":[12583779,12583773,12583296],"length":1,"stats":{"Line":1}},{"line":173,"address":[12583345],"length":1,"stats":{"Line":1}},{"line":175,"address":[12583417,12583371],"length":1,"stats":{"Line":1}},{"line":177,"address":[12583676,12583522],"length":1,"stats":{"Line":2}},{"line":178,"address":[12583597],"length":1,"stats":{"Line":1}},{"line":179,"address":[12583659],"length":1,"stats":{"Line":1}}],"covered":33,"coverable":70},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","invoice.rs"],"content":"use core::cmp::{max, min};\nuse soroban_sdk::{contracttype, symbol_short, vec, Address, BytesN, Env, String, Vec};\n\nuse crate::errors::QuickLendXError;\n\nconst DEFAULT_INVOICE_GRACE_PERIOD: u64 = 14 * 24 * 60 * 60;\n\n/// Invoice status enumeration\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum InvoiceStatus {\n    Pending,   // Invoice uploaded, awaiting verification\n    Verified,  // Invoice verified and available for bidding\n    Funded,    // Invoice has been funded by an investor\n    Paid,      // Invoice has been paid and settled\n    Defaulted, // Invoice payment is overdue/defaulted\n    Cancelled, // Invoice has been cancelled by the business owner\n}\n\n/// Dispute status enumeration\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum DisputeStatus {\n    None,        // No dispute exists\n    Disputed,    // Dispute has been created\n    UnderReview, // Dispute is under review\n    Resolved,    // Dispute has been resolved\n}\n\n/// Dispute structure\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Dispute {\n    pub created_by: Address,  // Address of the party who created the dispute\n    pub created_at: u64,      // Timestamp when dispute was created\n    pub reason: String,       // Reason for the dispute\n    pub evidence: String,     // Evidence provided by the disputing party\n    pub resolution: String,   // Resolution description (empty if not resolved)\n    pub resolved_by: Address, // Address of the party who resolved the dispute (zero address if not resolved)\n    pub resolved_at: u64,     // Timestamp when dispute was resolved (0 if not resolved)\n}\n\n/// Invoice category enumeration\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum InvoiceCategory {\n    Services,      // Professional services\n    Products,      // Physical products\n    Consulting,    // Consulting services\n    Manufacturing, // Manufacturing services\n    Technology,    // Technology services/products\n    Healthcare,    // Healthcare services\n    Other,         // Other categories\n}\n\n/// Invoice rating structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct InvoiceRating {\n    pub rating: u32,       // 1-5 stars\n    pub feedback: String,  // Feedback text\n    pub rated_by: Address, // Investor who provided the rating\n    pub rated_at: u64,     // Timestamp of rating\n}\n\n/// Compact representation of a line item stored on-chain\n#[contracttype]\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct LineItemRecord(pub String, pub i128, pub i128, pub i128);\n\n/// Metadata associated with an invoice\n#[contracttype]\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct InvoiceMetadata {\n    pub customer_name: String,\n    pub customer_address: String,\n    pub tax_id: String,\n    pub line_items: Vec\u003cLineItemRecord\u003e,\n    pub notes: String,\n}\n\n/// Individual payment record for an invoice\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct PaymentRecord {\n    pub amount: i128,           // Amount paid in this transaction\n    pub timestamp: u64,         // When the payment was recorded\n    pub transaction_id: String, // External transaction reference\n}\n\n/// Core invoice data structure\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Invoice {\n    pub id: BytesN\u003c32\u003e,        // Unique invoice identifier\n    pub business: Address,     // Business that uploaded the invoice\n    pub amount: i128,          // Total invoice amount\n    pub currency: Address,     // Currency token address (XLM = Address::random())\n    pub due_date: u64,         // Due date timestamp\n    pub status: InvoiceStatus, // Current status of the invoice\n    pub created_at: u64,       // Creation timestamp\n    pub description: String,   // Invoice description/metadata\n    pub metadata_customer_name: Option\u003cString\u003e,\n    pub metadata_customer_address: Option\u003cString\u003e,\n    pub metadata_tax_id: Option\u003cString\u003e,\n    pub metadata_notes: Option\u003cString\u003e,\n    pub metadata_line_items: Vec\u003cLineItemRecord\u003e,\n    pub category: InvoiceCategory,           // Invoice category\n    pub tags: Vec\u003cString\u003e,                   // Invoice tags for better discoverability\n    pub funded_amount: i128,                 // Amount funded by investors\n    pub funded_at: Option\u003cu64\u003e,              // When the invoice was funded\n    pub investor: Option\u003cAddress\u003e,           // Address of the investor who funded\n    pub settled_at: Option\u003cu64\u003e,             // When the invoice was settled\n    pub average_rating: Option\u003cu32\u003e,         // Average rating (1-5)\n    pub total_ratings: u32,                  // Total number of ratings\n    pub ratings: Vec\u003cInvoiceRating\u003e,         // List of all ratings\n    pub dispute_status: DisputeStatus,       // Current dispute status\n    pub dispute: Dispute,                    // Dispute details if any\n    pub total_paid: i128,                    // Aggregate amount paid towards the invoice\n    pub payment_history: Vec\u003cPaymentRecord\u003e, // History of partial payments\n}\n\n// Use the main error enum from errors.rs\nuse crate::audit::{log_invoice_created, log_invoice_funded, log_invoice_status_change};\n\nimpl Invoice {\n    /// Create a new invoice with audit logging\n    pub fn new(\n        env: \u0026Env,\n        business: Address,\n        amount: i128,\n        currency: Address,\n        due_date: u64,\n        description: String,\n        category: InvoiceCategory,\n        tags: Vec\u003cString\u003e,\n    ) -\u003e Self {\n        let id = Self::generate_unique_invoice_id(env);\n        let created_at = env.ledger().timestamp();\n\n        let invoice = Self {\n            id,\n            business,\n            amount,\n            currency,\n            due_date,\n            status: InvoiceStatus::Pending,\n            created_at,\n            description,\n            metadata_customer_name: None,\n            metadata_customer_address: None,\n            metadata_tax_id: None,\n            metadata_notes: None,\n            metadata_line_items: Vec::new(env),\n            category,\n            tags,\n            funded_amount: 0,\n            funded_at: None,\n            investor: None,\n            settled_at: None,\n            average_rating: None,\n            total_ratings: 0,\n            ratings: vec![env],\n            dispute_status: DisputeStatus::None,\n            dispute: Dispute {\n                created_by: Address::from_str(\n                    env,\n                    \"GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF\",\n                ),\n                created_at: 0,\n                reason: String::from_str(env, \"\"),\n                evidence: String::from_str(env, \"\"),\n                resolution: String::from_str(env, \"\"),\n                resolved_by: Address::from_str(\n                    env,\n                    \"GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF\",\n                ),\n                resolved_at: 0,\n            },\n            total_paid: 0,\n            payment_history: vec![env],\n        };\n\n        // Log invoice creation\n        log_invoice_created(env, \u0026invoice);\n\n        invoice\n    }\n\n    /// Generate a unique invoice ID\n    fn generate_unique_invoice_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let sequence = env.ledger().sequence();\n        let counter_key = symbol_short!(\"inv_cnt\");\n        let counter: u32 = env.storage().instance().get(\u0026counter_key).unwrap_or(0);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        // Create a unique ID from timestamp, sequence, and counter\n        let mut id_bytes = [0u8; 32];\n        id_bytes[0..8].copy_from_slice(\u0026timestamp.to_be_bytes());\n        id_bytes[8..12].copy_from_slice(\u0026sequence.to_be_bytes());\n        id_bytes[12..16].copy_from_slice(\u0026counter.to_be_bytes());\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n\n    /// Check if invoice is available for funding\n    pub fn is_available_for_funding(\u0026self) -\u003e bool {\n        self.status == InvoiceStatus::Verified \u0026\u0026 self.funded_amount == 0\n    }\n\n    pub const DEFAULT_GRACE_PERIOD: u64 = DEFAULT_INVOICE_GRACE_PERIOD;\n\n    /// Check if invoice is overdue\n    pub fn is_overdue(\u0026self, current_timestamp: u64) -\u003e bool {\n        current_timestamp \u003e self.due_date\n    }\n\n    /// Calculate the timestamp when the grace period ends\n    pub fn grace_deadline(\u0026self, grace_period: u64) -\u003e u64 {\n        self.due_date.saturating_add(grace_period)\n    }\n\n    /// Check if the invoice should be defaulted and handle it if necessary\n    pub fn check_and_handle_expiration(\n        \u0026self,\n        env: \u0026Env,\n        grace_period: u64,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        if self.status != InvoiceStatus::Funded {\n            return Ok(false);\n        }\n\n        let now = env.ledger().timestamp();\n        if now \u003c= self.grace_deadline(grace_period) {\n            return Ok(false);\n        }\n\n        crate::defaults::handle_default(env, \u0026self.id)?;\n        Ok(true)\n    }\n\n    /// Mark invoice as funded with audit logging\n    pub fn mark_as_funded(\n        \u0026mut self,\n        env: \u0026Env,\n        investor: Address,\n        funded_amount: i128,\n        timestamp: u64,\n    ) {\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Funded;\n        self.funded_amount = funded_amount;\n        self.funded_at = Some(timestamp);\n        self.investor = Some(investor.clone());\n\n        // Log status change and funding\n        log_invoice_status_change(\n            env,\n            self.id.clone(),\n            investor.clone(),\n            old_status,\n            self.status.clone(),\n        );\n        log_invoice_funded(env, self.id.clone(), investor, funded_amount);\n    }\n\n    /// Mark invoice as paid with audit logging\n    pub fn mark_as_paid(\u0026mut self, env: \u0026Env, actor: Address, timestamp: u64) {\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Paid;\n        self.settled_at = Some(timestamp);\n\n        // Log status change\n        log_invoice_status_change(env, self.id.clone(), actor, old_status, self.status.clone());\n    }\n\n    /// Add a payment record and update totals\n    pub fn record_payment(\n        \u0026mut self,\n        env: \u0026Env,\n        amount: i128,\n        transaction_id: String,\n    ) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        if amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let record = PaymentRecord {\n            amount,\n            timestamp: env.ledger().timestamp(),\n            transaction_id,\n        };\n        self.payment_history.push_back(record);\n        self.total_paid = self.total_paid.saturating_add(amount);\n\n        Ok(self.payment_progress())\n    }\n\n    /// Calculate the payment progress percentage (0-100)\n    pub fn payment_progress(\u0026self) -\u003e u32 {\n        if self.amount \u003c= 0 {\n            return 0;\n        }\n\n        let capped_total = max(self.total_paid, 0i128);\n        let mut percentage = (capped_total.saturating_mul(100i128)) / max(self.amount, 1i128);\n        percentage = min(percentage, 100i128);\n        percentage as u32\n    }\n\n    /// Check if the invoice has been fully paid\n    pub fn is_fully_paid(\u0026self) -\u003e bool {\n        self.total_paid \u003e= self.amount\n    }\n\n    /// Retrieve metadata if present\n    pub fn metadata(\u0026self) -\u003e Option\u003cInvoiceMetadata\u003e {\n        let name = self.metadata_customer_name.clone()?;\n        let address = self.metadata_customer_address.clone()?;\n        let tax = self.metadata_tax_id.clone()?;\n        let notes = self.metadata_notes.clone()?;\n\n        Some(InvoiceMetadata {\n            customer_name: name,\n            customer_address: address,\n            tax_id: tax,\n            line_items: self.metadata_line_items.clone(),\n            notes,\n        })\n    }\n\n    /// Update structured metadata attached to the invoice\n    pub fn set_metadata(\u0026mut self, env: \u0026Env, metadata: Option\u003cInvoiceMetadata\u003e) {\n        match metadata {\n            Some(data) =\u003e {\n                self.metadata_customer_name = Some(data.customer_name);\n                self.metadata_customer_address = Some(data.customer_address);\n                self.metadata_tax_id = Some(data.tax_id);\n                self.metadata_notes = Some(data.notes);\n                self.metadata_line_items = data.line_items;\n            }\n            None =\u003e {\n                self.metadata_customer_name = None;\n                self.metadata_customer_address = None;\n                self.metadata_tax_id = None;\n                self.metadata_notes = None;\n                self.metadata_line_items = Vec::new(env);\n            }\n        }\n    }\n\n    /// Verify the invoice with audit logging\n    pub fn verify(\u0026mut self, env: \u0026Env, actor: Address) {\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Verified;\n\n        // Log status change\n        log_invoice_status_change(env, self.id.clone(), actor, old_status, self.status.clone());\n    }\n\n    /// Mark invoice as defaulted\n    pub fn mark_as_defaulted(\u0026mut self) {\n        self.status = InvoiceStatus::Defaulted;\n    }\n\n    /// Cancel the invoice (only if Pending or Verified, not Funded)\n    pub fn cancel(\u0026mut self, env: \u0026Env, actor: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Can only cancel if Pending or Verified (not yet funded)\n        if self.status != InvoiceStatus::Pending \u0026\u0026 self.status != InvoiceStatus::Verified {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        let old_status = self.status.clone();\n        self.status = InvoiceStatus::Cancelled;\n\n        // Log status change\n        log_invoice_status_change(env, self.id.clone(), actor, old_status, self.status.clone());\n\n        Ok(())\n    }\n\n    /// Add a rating to the invoice\n    pub fn add_rating(\n        \u0026mut self,\n        rating: u32,\n        feedback: String,\n        rater: Address,\n        timestamp: u64,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Validate invoice is funded\n        if self.status != InvoiceStatus::Funded \u0026\u0026 self.status != InvoiceStatus::Paid {\n            return Err(QuickLendXError::NotFunded);\n        }\n\n        // Verify rater is the investor\n        if self.investor.as_ref() != Some(\u0026rater) {\n            return Err(QuickLendXError::NotRater);\n        }\n\n        // Validate rating value\n        if rating \u003c 1 || rating \u003e 5 {\n            return Err(QuickLendXError::InvalidRating);\n        }\n\n        // Check if rater has already rated\n        for existing_rating in self.ratings.iter() {\n            if existing_rating.rated_by == rater {\n                return Err(QuickLendXError::AlreadyRated);\n            }\n        }\n\n        // Create new rating\n        let invoice_rating = InvoiceRating {\n            rating,\n            feedback,\n            rated_by: rater,\n            rated_at: timestamp,\n        };\n\n        // Add rating\n        self.ratings.push_back(invoice_rating);\n        self.total_ratings += 1;\n\n        // Calculate new average rating\n        let sum: u64 = self.ratings.iter().map(|r| r.rating as u64).sum();\n        self.average_rating = Some((sum / self.total_ratings as u64) as u32);\n\n        Ok(())\n    }\n\n    /// Get ratings above a threshold\n    pub fn get_ratings_above(\u0026self, env: \u0026Env, threshold: u32) -\u003e Vec\u003cInvoiceRating\u003e {\n        let mut filtered = vec![env];\n        for rating in self.ratings.iter() {\n            if rating.rating \u003e= threshold {\n                filtered.push_back(rating);\n            }\n        }\n        filtered\n    }\n\n    /// Get all ratings for the invoice\n    pub fn get_all_ratings(\u0026self) -\u003e \u0026Vec\u003cInvoiceRating\u003e {\n        \u0026self.ratings\n    }\n\n    /// Check if invoice has ratings\n    pub fn has_ratings(\u0026self) -\u003e bool {\n        self.total_ratings \u003e 0\n    }\n\n    /// Get the highest rating received\n    pub fn get_highest_rating(\u0026self) -\u003e Option\u003cu32\u003e {\n        if self.ratings.is_empty() {\n            None\n        } else {\n            Some(self.ratings.iter().map(|r| r.rating).max().unwrap())\n        }\n    }\n\n    /// Get the lowest rating received\n    pub fn get_lowest_rating(\u0026self) -\u003e Option\u003cu32\u003e {\n        if self.ratings.is_empty() {\n            None\n        } else {\n            Some(self.ratings.iter().map(|r| r.rating).min().unwrap())\n        }\n    }\n\n    /// Add a tag to the invoice\n    pub fn add_tag(\n        \u0026mut self,\n        _env: \u0026Env,\n        tag: String,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        // Validate tag length (1-50 characters)\n        if tag.len() \u003c 1 || tag.len() \u003e 50 {\n            return Err(crate::errors::QuickLendXError::InvalidTag);\n        }\n\n        // Check tag limit (max 10 tags per invoice)\n        if self.tags.len() \u003e= 10 {\n            return Err(crate::errors::QuickLendXError::TagLimitExceeded);\n        }\n\n        // Check if tag already exists\n        for existing_tag in self.tags.iter() {\n            if existing_tag == tag {\n                return Ok(()); // Tag already exists, no need to add\n            }\n        }\n\n        self.tags.push_back(tag);\n        Ok(())\n    }\n\n    /// Remove a tag from the invoice\n    pub fn remove_tag(\u0026mut self, tag: String) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let mut new_tags = Vec::new(\u0026self.tags.env());\n        let mut found = false;\n\n        for existing_tag in self.tags.iter() {\n            if existing_tag != tag {\n                new_tags.push_back(existing_tag.clone());\n            } else {\n                found = true;\n            }\n        }\n\n        if !found {\n            return Err(crate::errors::QuickLendXError::InvalidTag);\n        }\n\n        self.tags = new_tags;\n        Ok(())\n    }\n\n    /// Check if invoice has a specific tag\n    pub fn has_tag(\u0026self, tag: String) -\u003e bool {\n        for existing_tag in self.tags.iter() {\n            if existing_tag == tag {\n                return true;\n            }\n        }\n        false\n    }\n\n    /// Update the invoice category\n    pub fn update_category(\u0026mut self, category: InvoiceCategory) {\n        self.category = category;\n    }\n\n    /// Get all tags as a vector\n    pub fn get_tags(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.tags.clone()\n    }\n}\n\n/// Storage keys for invoice data\npub struct InvoiceStorage;\n\nimpl InvoiceStorage {\n    /// Store an invoice\n    pub fn store_invoice(env: \u0026Env, invoice: \u0026Invoice) {\n        env.storage().instance().set(\u0026invoice.id, invoice);\n\n        // Add to business invoices list\n        Self::add_to_business_invoices(env, \u0026invoice.business, \u0026invoice.id);\n\n        // Add to status invoices list\n        Self::add_to_status_invoices(env, \u0026invoice.status, \u0026invoice.id);\n    }\n\n    /// Get an invoice by ID\n    pub fn get_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cInvoice\u003e {\n        env.storage().instance().get(invoice_id)\n    }\n\n    /// Update an invoice\n    pub fn update_invoice(env: \u0026Env, invoice: \u0026Invoice) {\n        env.storage().instance().set(\u0026invoice.id, invoice);\n    }\n\n    /// Get all invoices for a business\n    pub fn get_business_invoices(env: \u0026Env, business: \u0026Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = (symbol_short!(\"business\"), business.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get all invoices by status\n    pub fn get_invoices_by_status(env: \u0026Env, status: \u0026InvoiceStatus) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = match status {\n            InvoiceStatus::Pending =\u003e symbol_short!(\"pending\"),\n            InvoiceStatus::Verified =\u003e symbol_short!(\"verified\"),\n            InvoiceStatus::Funded =\u003e symbol_short!(\"funded\"),\n            InvoiceStatus::Paid =\u003e symbol_short!(\"paid\"),\n            InvoiceStatus::Defaulted =\u003e symbol_short!(\"default\"),\n            InvoiceStatus::Cancelled =\u003e symbol_short!(\"canceld\"),\n        };\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Add invoice to business invoices list\n    fn add_to_business_invoices(env: \u0026Env, business: \u0026Address, invoice_id: \u0026BytesN\u003c32\u003e) {\n        let key = (symbol_short!(\"business\"), business.clone());\n        let mut invoices = Self::get_business_invoices(env, business);\n        invoices.push_back(invoice_id.clone());\n        env.storage().instance().set(\u0026key, \u0026invoices);\n    }\n\n    /// Add invoice to status invoices list\n    pub fn add_to_status_invoices(env: \u0026Env, status: \u0026InvoiceStatus, invoice_id: \u0026BytesN\u003c32\u003e) {\n        let key = match status {\n            InvoiceStatus::Pending =\u003e symbol_short!(\"pending\"),\n            InvoiceStatus::Verified =\u003e symbol_short!(\"verified\"),\n            InvoiceStatus::Funded =\u003e symbol_short!(\"funded\"),\n            InvoiceStatus::Paid =\u003e symbol_short!(\"paid\"),\n            InvoiceStatus::Defaulted =\u003e symbol_short!(\"default\"),\n            InvoiceStatus::Cancelled =\u003e symbol_short!(\"canceld\"),\n        };\n        let mut invoices = env\n            .storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env));\n        invoices.push_back(invoice_id.clone());\n        env.storage().instance().set(\u0026key, \u0026invoices);\n    }\n\n    /// Remove invoice from status invoices list\n    pub fn remove_from_status_invoices(env: \u0026Env, status: \u0026InvoiceStatus, invoice_id: \u0026BytesN\u003c32\u003e) {\n        let key = match status {\n            InvoiceStatus::Pending =\u003e symbol_short!(\"pending\"),\n            InvoiceStatus::Verified =\u003e symbol_short!(\"verified\"),\n            InvoiceStatus::Funded =\u003e symbol_short!(\"funded\"),\n            InvoiceStatus::Paid =\u003e symbol_short!(\"paid\"),\n            InvoiceStatus::Defaulted =\u003e symbol_short!(\"default\"),\n            InvoiceStatus::Cancelled =\u003e symbol_short!(\"canceld\"),\n        };\n        let invoices = Self::get_invoices_by_status(env, status);\n\n        // Find and remove the invoice ID\n        let mut new_invoices = Vec::new(env);\n        for id in invoices.iter() {\n            if id != *invoice_id {\n                new_invoices.push_back(id);\n            }\n        }\n\n        env.storage().instance().set(\u0026key, \u0026new_invoices);\n    }\n\n    /// Get invoices with ratings above a threshold\n    pub fn get_invoices_with_rating_above(env: \u0026Env, threshold: u32) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut high_rated_invoices = vec![env];\n        // Get all invoices and filter by rating\n        let all_statuses = [InvoiceStatus::Funded, InvoiceStatus::Paid];\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if let Some(avg_rating) = invoice.average_rating {\n                        if avg_rating \u003e= threshold {\n                            high_rated_invoices.push_back(invoice_id);\n                        }\n                    }\n                }\n            }\n        }\n        high_rated_invoices\n    }\n\n    /// Get invoices for a business with ratings above a threshold\n    pub fn get_business_invoices_with_rating_above(\n        env: \u0026Env,\n        business: \u0026Address,\n        threshold: u32,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut high_rated_invoices = vec![env];\n        let business_invoices = Self::get_business_invoices(env, business);\n        for invoice_id in business_invoices.iter() {\n            if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                if let Some(avg_rating) = invoice.average_rating {\n                    if avg_rating \u003e= threshold {\n                        high_rated_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        high_rated_invoices\n    }\n\n    /// Get count of invoices with ratings\n    pub fn get_invoices_with_ratings_count(env: \u0026Env) -\u003e u32 {\n        let mut count = 0;\n        let all_statuses = [InvoiceStatus::Funded, InvoiceStatus::Paid];\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if invoice.has_ratings() {\n                        count += 1;\n                    }\n                }\n            }\n        }\n        count\n    }\n\n    /// Get invoices by category\n    pub fn get_invoices_by_category(env: \u0026Env, category: \u0026InvoiceCategory) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut category_invoices = vec![env];\n        let all_statuses = [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ];\n\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if invoice.category == *category {\n                        category_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        category_invoices\n    }\n\n    /// Get invoices by category and status\n    pub fn get_invoices_by_category_and_status(\n        env: \u0026Env,\n        category: \u0026InvoiceCategory,\n        status: \u0026InvoiceStatus,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut filtered_invoices = vec![env];\n        let invoices = Self::get_invoices_by_status(env, status);\n\n        for invoice_id in invoices.iter() {\n            if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                if invoice.category == *category {\n                    filtered_invoices.push_back(invoice_id);\n                }\n            }\n        }\n        filtered_invoices\n    }\n\n    /// Get invoices by tag\n    pub fn get_invoices_by_tag(env: \u0026Env, tag: \u0026String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut tagged_invoices = vec![env];\n        let all_statuses = [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ];\n\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    if invoice.has_tag(tag.clone()) {\n                        tagged_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        tagged_invoices\n    }\n\n    /// Get invoices by multiple tags (AND logic - must have all tags)\n    pub fn get_invoices_by_tags(env: \u0026Env, tags: \u0026Vec\u003cString\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let mut tagged_invoices = vec![env];\n        let all_statuses = [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ];\n\n        for status in all_statuses.iter() {\n            let invoices = Self::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                if let Some(invoice) = Self::get_invoice(env, \u0026invoice_id) {\n                    let mut has_all_tags = true;\n                    for tag in tags.iter() {\n                        if !invoice.has_tag(tag.clone()) {\n                            has_all_tags = false;\n                            break;\n                        }\n                    }\n                    if has_all_tags {\n                        tagged_invoices.push_back(invoice_id);\n                    }\n                }\n            }\n        }\n        tagged_invoices\n    }\n\n    /// Get invoice count by category\n    pub fn get_invoice_count_by_category(env: \u0026Env, category: \u0026InvoiceCategory) -\u003e u32 {\n        Self::get_invoices_by_category(env, category).len() as u32\n    }\n\n    /// Get invoice count by tag\n    pub fn get_invoice_count_by_tag(env: \u0026Env, tag: \u0026String) -\u003e u32 {\n        Self::get_invoices_by_tag(env, tag).len() as u32\n    }\n\n    /// Get all available categories\n    pub fn get_all_categories(env: \u0026Env) -\u003e Vec\u003cInvoiceCategory\u003e {\n        vec![\n            env,\n            InvoiceCategory::Services,\n            InvoiceCategory::Products,\n            InvoiceCategory::Consulting,\n            InvoiceCategory::Manufacturing,\n            InvoiceCategory::Technology,\n            InvoiceCategory::Healthcare,\n            InvoiceCategory::Other,\n        ]\n    }\n\n    fn metadata_customer_key(customer: \u0026String) -\u003e (soroban_sdk::Symbol, String) {\n        (symbol_short!(\"meta_c\"), customer.clone())\n    }\n\n    fn metadata_tax_key(tax_id: \u0026String) -\u003e (soroban_sdk::Symbol, String) {\n        (symbol_short!(\"meta_t\"), tax_id.clone())\n    }\n\n    fn add_to_metadata_index(\n        env: \u0026Env,\n        key: \u0026(soroban_sdk::Symbol, String),\n        invoice_id: \u0026BytesN\u003c32\u003e,\n    ) {\n        let mut invoices = env\n            .storage()\n            .instance()\n            .get(key)\n            .unwrap_or_else(|| Vec::new(env));\n        for existing in invoices.iter() {\n            if existing == *invoice_id {\n                return;\n            }\n        }\n        invoices.push_back(invoice_id.clone());\n        env.storage().instance().set(key, \u0026invoices);\n    }\n\n    fn remove_from_metadata_index(\n        env: \u0026Env,\n        key: \u0026(soroban_sdk::Symbol, String),\n        invoice_id: \u0026BytesN\u003c32\u003e,\n    ) {\n        let existing: Option\u003cVec\u003cBytesN\u003c32\u003e\u003e\u003e = env.storage().instance().get(key);\n        if let Some(invoices) = existing {\n            let mut filtered = Vec::new(env);\n            for id in invoices.iter() {\n                if id != *invoice_id {\n                    filtered.push_back(id);\n                }\n            }\n            env.storage().instance().set(key, \u0026filtered);\n        }\n    }\n\n    pub fn add_metadata_indexes(env: \u0026Env, invoice: \u0026Invoice) {\n        if let Some(name) = \u0026invoice.metadata_customer_name {\n            if name.len() \u003e 0 {\n                let key = Self::metadata_customer_key(name);\n                Self::add_to_metadata_index(env, \u0026key, \u0026invoice.id);\n            }\n        }\n\n        if let Some(tax) = \u0026invoice.metadata_tax_id {\n            if tax.len() \u003e 0 {\n                let key = Self::metadata_tax_key(tax);\n                Self::add_to_metadata_index(env, \u0026key, \u0026invoice.id);\n            }\n        }\n    }\n\n    pub fn remove_metadata_indexes(env: \u0026Env, metadata: \u0026InvoiceMetadata, invoice_id: \u0026BytesN\u003c32\u003e) {\n        if metadata.customer_name.len() \u003e 0 {\n            let key = Self::metadata_customer_key(\u0026metadata.customer_name);\n            Self::remove_from_metadata_index(env, \u0026key, invoice_id);\n        }\n\n        if metadata.tax_id.len() \u003e 0 {\n            let key = Self::metadata_tax_key(\u0026metadata.tax_id);\n            Self::remove_from_metadata_index(env, \u0026key, invoice_id);\n        }\n    }\n\n    pub fn get_invoices_by_customer(env: \u0026Env, customer_name: \u0026String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::metadata_customer_key(customer_name))\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    pub fn get_invoices_by_tax_id(env: \u0026Env, tax_id: \u0026String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::metadata_tax_key(tax_id))\n            .unwrap_or_else(|| Vec::new(env))\n    }\n}\n","traces":[{"line":128,"address":[16242144,16244855,16244573],"length":1,"stats":{"Line":1}},{"line":138,"address":[16242260,16242390],"length":1,"stats":{"Line":2}},{"line":139,"address":[16242406,16242451],"length":1,"stats":{"Line":2}},{"line":154,"address":[16242787],"length":1,"stats":{"Line":1}},{"line":163,"address":[16242907],"length":1,"stats":{"Line":1}},{"line":165,"address":[16243323],"length":1,"stats":{"Line":1}},{"line":181,"address":[16243595],"length":1,"stats":{"Line":1}},{"line":185,"address":[16244482],"length":1,"stats":{"Line":1}},{"line":187,"address":[16244534],"length":1,"stats":{"Line":1}},{"line":191,"address":[16240336,16241757,16241763],"length":1,"stats":{"Line":1}},{"line":192,"address":[16240391],"length":1,"stats":{"Line":1}},{"line":193,"address":[16240524],"length":1,"stats":{"Line":1}},{"line":194,"address":[16240638],"length":1,"stats":{"Line":1}},{"line":195,"address":[16240691,16240742],"length":1,"stats":{"Line":2}},{"line":196,"address":[16240984],"length":1,"stats":{"Line":1}},{"line":199,"address":[16241223],"length":1,"stats":{"Line":1}},{"line":200,"address":[16241242],"length":1,"stats":{"Line":1}},{"line":201,"address":[16241397],"length":1,"stats":{"Line":1}},{"line":202,"address":[16241547],"length":1,"stats":{"Line":1}},{"line":204,"address":[16241708],"length":1,"stats":{"Line":1}},{"line":208,"address":[16240240],"length":1,"stats":{"Line":0}},{"line":209,"address":[16240253],"length":1,"stats":{"Line":0}},{"line":215,"address":[16233792],"length":1,"stats":{"Line":0}},{"line":216,"address":[16233802],"length":1,"stats":{"Line":0}},{"line":220,"address":[16237296],"length":1,"stats":{"Line":0}},{"line":221,"address":[16237310],"length":1,"stats":{"Line":0}},{"line":225,"address":[16242129,16241776,16242123],"length":1,"stats":{"Line":0}},{"line":230,"address":[16241813],"length":1,"stats":{"Line":0}},{"line":231,"address":[16241875],"length":1,"stats":{"Line":0}},{"line":234,"address":[16241890,16241850],"length":1,"stats":{"Line":0}},{"line":235,"address":[16241965],"length":1,"stats":{"Line":0}},{"line":236,"address":[16242042],"length":1,"stats":{"Line":0}},{"line":239,"address":[16241993,16242054],"length":1,"stats":{"Line":0}},{"line":240,"address":[16242100],"length":1,"stats":{"Line":0}},{"line":244,"address":[16237328,16238112,16238140],"length":1,"stats":{"Line":1}},{"line":251,"address":[16237405,16237526],"length":1,"stats":{"Line":3}},{"line":252,"address":[16237534],"length":1,"stats":{"Line":2}},{"line":253,"address":[16237541],"length":1,"stats":{"Line":1}},{"line":254,"address":[16237555],"length":1,"stats":{"Line":2}},{"line":255,"address":[16237571],"length":1,"stats":{"Line":1}},{"line":260,"address":[16237732],"length":1,"stats":{"Line":2}},{"line":261,"address":[16237776,16237829],"length":1,"stats":{"Line":3}},{"line":263,"address":[16237837],"length":1,"stats":{"Line":1}},{"line":265,"address":[16237973],"length":1,"stats":{"Line":2}},{"line":269,"address":[16235129,16234704,16235154],"length":1,"stats":{"Line":1}},{"line":270,"address":[16234755,16234860],"length":1,"stats":{"Line":2}},{"line":271,"address":[16234867],"length":1,"stats":{"Line":1}},{"line":272,"address":[16234874],"length":1,"stats":{"Line":1}},{"line":275,"address":[16234886,16235098,16235135],"length":1,"stats":{"Line":1}},{"line":279,"address":[16238176,16238869],"length":1,"stats":{"Line":2}},{"line":285,"address":[16238240],"length":1,"stats":{"Line":2}},{"line":286,"address":[16238301],"length":1,"stats":{"Line":0}},{"line":291,"address":[16238289,16238369],"length":1,"stats":{"Line":4}},{"line":294,"address":[16238627],"length":1,"stats":{"Line":2}},{"line":295,"address":[16238743],"length":1,"stats":{"Line":2}},{"line":297,"address":[16238803],"length":1,"stats":{"Line":2}},{"line":301,"address":[16238960],"length":1,"stats":{"Line":2}},{"line":302,"address":[16238974],"length":1,"stats":{"Line":2}},{"line":303,"address":[16239151],"length":1,"stats":{"Line":0}},{"line":306,"address":[16239009],"length":1,"stats":{"Line":2}},{"line":307,"address":[16239184,16239317,16239064],"length":1,"stats":{"Line":4}},{"line":308,"address":[16239273],"length":1,"stats":{"Line":2}},{"line":309,"address":[16239307],"length":1,"stats":{"Line":2}},{"line":313,"address":[16237248],"length":1,"stats":{"Line":1}},{"line":314,"address":[16237253],"length":1,"stats":{"Line":1}},{"line":318,"address":[16248604,16248798,16247216],"length":1,"stats":{"Line":0}},{"line":319,"address":[16247246],"length":1,"stats":{"Line":0}},{"line":320,"address":[16248783,16247517,16247438],"length":1,"stats":{"Line":0}},{"line":321,"address":[16248738,16247675,16247754],"length":1,"stats":{"Line":0}},{"line":322,"address":[16247991,16247912],"length":1,"stats":{"Line":0}},{"line":324,"address":[16248392],"length":1,"stats":{"Line":0}},{"line":325,"address":[16248141],"length":1,"stats":{"Line":0}},{"line":326,"address":[16248188],"length":1,"stats":{"Line":0}},{"line":327,"address":[16248244],"length":1,"stats":{"Line":0}},{"line":328,"address":[16248300],"length":1,"stats":{"Line":0}},{"line":329,"address":[16248366],"length":1,"stats":{"Line":0}},{"line":334,"address":[16236119,16237146,16235184],"length":1,"stats":{"Line":0}},{"line":335,"address":[16235222],"length":1,"stats":{"Line":0}},{"line":336,"address":[16235289],"length":1,"stats":{"Line":0}},{"line":337,"address":[16236137,16235345],"length":1,"stats":{"Line":0}},{"line":338,"address":[16236239],"length":1,"stats":{"Line":0}},{"line":339,"address":[16236459],"length":1,"stats":{"Line":0}},{"line":340,"address":[16236688],"length":1,"stats":{"Line":0}},{"line":341,"address":[16236917],"length":1,"stats":{"Line":0}},{"line":344,"address":[16235458],"length":1,"stats":{"Line":0}},{"line":345,"address":[16235591],"length":1,"stats":{"Line":0}},{"line":346,"address":[16235724],"length":1,"stats":{"Line":0}},{"line":347,"address":[16235857],"length":1,"stats":{"Line":0}},{"line":348,"address":[16236003],"length":1,"stats":{"Line":0}},{"line":354,"address":[16245892,16245867,16245472],"length":1,"stats":{"Line":2}},{"line":355,"address":[16245510,16245610],"length":1,"stats":{"Line":3}},{"line":356,"address":[16245617],"length":1,"stats":{"Line":1}},{"line":359,"address":[16245624,16245873,16245836],"length":1,"stats":{"Line":2}},{"line":363,"address":[16240080],"length":1,"stats":{"Line":0}},{"line":364,"address":[16240085],"length":1,"stats":{"Line":0}},{"line":368,"address":[16244896,16245411,16245436],"length":1,"stats":{"Line":0}},{"line":370,"address":[16244934,16245036,16245070],"length":1,"stats":{"Line":0}},{"line":371,"address":[16245110],"length":1,"stats":{"Line":0}},{"line":374,"address":[16245047,16245138],"length":1,"stats":{"Line":0}},{"line":375,"address":[16245145],"length":1,"stats":{"Line":0}},{"line":378,"address":[16245380,16245152,16245417],"length":1,"stats":{"Line":0}},{"line":380,"address":[16245360],"length":1,"stats":{"Line":0}},{"line":384,"address":[16233680,16232304,16233752],"length":1,"stats":{"Line":0}},{"line":392,"address":[16232495,16232460,16232358],"length":1,"stats":{"Line":0}},{"line":393,"address":[16232530],"length":1,"stats":{"Line":0}},{"line":397,"address":[16232553,16232471],"length":1,"stats":{"Line":0}},{"line":398,"address":[16232605],"length":1,"stats":{"Line":0}},{"line":402,"address":[16232622,16232598],"length":1,"stats":{"Line":0}},{"line":403,"address":[16232627],"length":1,"stats":{"Line":0}},{"line":407,"address":[16232645,16232773],"length":1,"stats":{"Line":0}},{"line":408,"address":[16232921,16233602],"length":1,"stats":{"Line":0}},{"line":409,"address":[16233626],"length":1,"stats":{"Line":0}},{"line":422,"address":[16233183],"length":1,"stats":{"Line":0}},{"line":423,"address":[16233378,16233322],"length":1,"stats":{"Line":0}},{"line":426,"address":[16233414,16233356],"length":1,"stats":{"Line":0}},{"line":427,"address":[16233459,16233525],"length":1,"stats":{"Line":0}},{"line":429,"address":[16233515],"length":1,"stats":{"Line":0}},{"line":433,"address":[16240057,16240051,16239488],"length":1,"stats":{"Line":0}},{"line":434,"address":[16239550],"length":1,"stats":{"Line":0}},{"line":435,"address":[16239735,16239645,16240031,16239573],"length":1,"stats":{"Line":0}},{"line":436,"address":[16239800],"length":1,"stats":{"Line":0}},{"line":437,"address":[16239878],"length":1,"stats":{"Line":0}},{"line":440,"address":[16239831],"length":1,"stats":{"Line":0}},{"line":444,"address":[16238912],"length":1,"stats":{"Line":0}},{"line":445,"address":[16238920],"length":1,"stats":{"Line":0}},{"line":449,"address":[16234672],"length":1,"stats":{"Line":0}},{"line":450,"address":[16234677],"length":1,"stats":{"Line":0}},{"line":454,"address":[16240096],"length":1,"stats":{"Line":0}},{"line":455,"address":[16240206,16240115],"length":1,"stats":{"Line":0}},{"line":456,"address":[16240208],"length":1,"stats":{"Line":0}},{"line":458,"address":[13094624,13094644],"length":1,"stats":{"Line":0}},{"line":463,"address":[16239344],"length":1,"stats":{"Line":0}},{"line":464,"address":[16239363,16239454],"length":1,"stats":{"Line":0}},{"line":465,"address":[16239456],"length":1,"stats":{"Line":0}},{"line":467,"address":[13094576,13094596],"length":1,"stats":{"Line":0}},{"line":472,"address":[16245936,16246623],"length":1,"stats":{"Line":0}},{"line":478,"address":[16246054,16245982,16246092],"length":1,"stats":{"Line":0}},{"line":479,"address":[16246075],"length":1,"stats":{"Line":0}},{"line":483,"address":[16246102],"length":1,"stats":{"Line":0}},{"line":484,"address":[16246153],"length":1,"stats":{"Line":0}},{"line":488,"address":[16246176,16246134,16246269],"length":1,"stats":{"Line":0}},{"line":489,"address":[16246349,16246537],"length":1,"stats":{"Line":0}},{"line":490,"address":[16246565],"length":1,"stats":{"Line":0}},{"line":494,"address":[16246400],"length":1,"stats":{"Line":0}},{"line":495,"address":[16246469],"length":1,"stats":{"Line":0}},{"line":499,"address":[16234634,16233824,16234659],"length":1,"stats":{"Line":0}},{"line":500,"address":[16233849,16233926],"length":1,"stats":{"Line":0}},{"line":501,"address":[16233965],"length":1,"stats":{"Line":0}},{"line":503,"address":[16233970,16234043,16234133],"length":1,"stats":{"Line":0}},{"line":504,"address":[16234550,16234213,16234561],"length":1,"stats":{"Line":0}},{"line":505,"address":[16234579,16234608],"length":1,"stats":{"Line":0}},{"line":507,"address":[16234556],"length":1,"stats":{"Line":0}},{"line":511,"address":[16234254],"length":1,"stats":{"Line":0}},{"line":512,"address":[16234261],"length":1,"stats":{"Line":0}},{"line":515,"address":[16234391,16234290],"length":1,"stats":{"Line":0}},{"line":516,"address":[16234478],"length":1,"stats":{"Line":0}},{"line":520,"address":[16247137,16246672],"length":1,"stats":{"Line":0}},{"line":521,"address":[16246858,16246768,16246698],"length":1,"stats":{"Line":0}},{"line":522,"address":[16247054,16246938],"length":1,"stats":{"Line":0}},{"line":523,"address":[16247082],"length":1,"stats":{"Line":0}},{"line":526,"address":[16246981],"length":1,"stats":{"Line":0}},{"line":530,"address":[16238928],"length":1,"stats":{"Line":0}},{"line":531,"address":[16238940],"length":1,"stats":{"Line":0}},{"line":535,"address":[16247168],"length":1,"stats":{"Line":0}},{"line":536,"address":[16247185],"length":1,"stats":{"Line":0}},{"line":545,"address":[16205971,16205965,16205712],"length":1,"stats":{"Line":2}},{"line":546,"address":[16205754],"length":1,"stats":{"Line":1}},{"line":549,"address":[16205913],"length":1,"stats":{"Line":2}},{"line":552,"address":[16205938],"length":1,"stats":{"Line":2}},{"line":556,"address":[16205690,16205472,16205684],"length":1,"stats":{"Line":2}},{"line":557,"address":[16205599,16205517],"length":1,"stats":{"Line":6}},{"line":561,"address":[16206183,16206177,16205984],"length":1,"stats":{"Line":3}},{"line":562,"address":[16206022],"length":1,"stats":{"Line":3}},{"line":566,"address":[16210448,16211034,16211040],"length":1,"stats":{"Line":2}},{"line":567,"address":[16210497],"length":1,"stats":{"Line":1}},{"line":568,"address":[16210692],"length":1,"stats":{"Line":2}},{"line":570,"address":[16210821],"length":1,"stats":{"Line":1}},{"line":571,"address":[13050929,13050912],"length":1,"stats":{"Line":5}},{"line":575,"address":[16212672,16212678,16212096],"length":1,"stats":{"Line":3}},{"line":576,"address":[16212134],"length":1,"stats":{"Line":3}},{"line":577,"address":[16212165],"length":1,"stats":{"Line":3}},{"line":578,"address":[16212189],"length":1,"stats":{"Line":0}},{"line":579,"address":[16212213],"length":1,"stats":{"Line":1}},{"line":580,"address":[16212237],"length":1,"stats":{"Line":0}},{"line":581,"address":[16212261],"length":1,"stats":{"Line":0}},{"line":582,"address":[16212285],"length":1,"stats":{"Line":0}},{"line":584,"address":[16212320],"length":1,"stats":{"Line":3}},{"line":586,"address":[16212454],"length":1,"stats":{"Line":3}},{"line":587,"address":[16212509],"length":1,"stats":{"Line":7}},{"line":591,"address":[16213999,16213376,16213993],"length":1,"stats":{"Line":1}},{"line":592,"address":[16213422],"length":1,"stats":{"Line":2}},{"line":593,"address":[16213622],"length":1,"stats":{"Line":1}},{"line":594,"address":[16213731,16213671],"length":1,"stats":{"Line":3}},{"line":595,"address":[16213771],"length":1,"stats":{"Line":1}},{"line":599,"address":[16212080,16211232,16212074],"length":1,"stats":{"Line":1}},{"line":600,"address":[16211273],"length":1,"stats":{"Line":2}},{"line":601,"address":[16211304],"length":1,"stats":{"Line":1}},{"line":602,"address":[16211328],"length":1,"stats":{"Line":3}},{"line":603,"address":[16211352],"length":1,"stats":{"Line":0}},{"line":604,"address":[16211376],"length":1,"stats":{"Line":1}},{"line":605,"address":[16211400],"length":1,"stats":{"Line":0}},{"line":606,"address":[16211424],"length":1,"stats":{"Line":0}},{"line":611,"address":[16211596],"length":1,"stats":{"Line":2}},{"line":612,"address":[16211603,16211534],"length":1,"stats":{"Line":3}},{"line":613,"address":[16211801],"length":1,"stats":{"Line":1}},{"line":614,"address":[16211857],"length":1,"stats":{"Line":2}},{"line":618,"address":[16217763,16216864,16217971],"length":1,"stats":{"Line":3}},{"line":619,"address":[16216910],"length":1,"stats":{"Line":3}},{"line":620,"address":[16216949],"length":1,"stats":{"Line":3}},{"line":621,"address":[16216973],"length":1,"stats":{"Line":0}},{"line":622,"address":[16216997],"length":1,"stats":{"Line":1}},{"line":623,"address":[16217021],"length":1,"stats":{"Line":0}},{"line":624,"address":[16217045],"length":1,"stats":{"Line":0}},{"line":625,"address":[16217069],"length":1,"stats":{"Line":0}},{"line":627,"address":[16217106],"length":1,"stats":{"Line":3}},{"line":630,"address":[16217159],"length":1,"stats":{"Line":2}},{"line":631,"address":[16217386,16217925,16217293,16217229],"length":1,"stats":{"Line":9}},{"line":632,"address":[16217814,16217482],"length":1,"stats":{"Line":6}},{"line":633,"address":[16217832],"length":1,"stats":{"Line":0}},{"line":637,"address":[16217524],"length":1,"stats":{"Line":3}},{"line":641,"address":[16219057,16218112,16219117],"length":1,"stats":{"Line":0}},{"line":642,"address":[16218153],"length":1,"stats":{"Line":0}},{"line":644,"address":[16218175],"length":1,"stats":{"Line":0}},{"line":645,"address":[16218263,16218195],"length":1,"stats":{"Line":0}},{"line":646,"address":[16218397],"length":1,"stats":{"Line":0}},{"line":647,"address":[16219071,16218520,16218453,16218616],"length":1,"stats":{"Line":0}},{"line":648,"address":[16218720,16218805],"length":1,"stats":{"Line":0}},{"line":649,"address":[16218899,16218859],"length":1,"stats":{"Line":0}},{"line":650,"address":[16218913],"length":1,"stats":{"Line":0}},{"line":651,"address":[16218932,16219052],"length":1,"stats":{"Line":0}},{"line":657,"address":[16218409],"length":1,"stats":{"Line":0}},{"line":661,"address":[16221664,16221604,16220784],"length":1,"stats":{"Line":0}},{"line":666,"address":[16220838],"length":1,"stats":{"Line":0}},{"line":667,"address":[16220891],"length":1,"stats":{"Line":0}},{"line":668,"address":[16221013,16220952,16221106,16221618],"length":1,"stats":{"Line":0}},{"line":669,"address":[16221210,16221352],"length":1,"stats":{"Line":0}},{"line":670,"address":[16221446,16221406],"length":1,"stats":{"Line":0}},{"line":671,"address":[16221460],"length":1,"stats":{"Line":0}},{"line":672,"address":[16221479,16221599],"length":1,"stats":{"Line":0}},{"line":677,"address":[16221240],"length":1,"stats":{"Line":0}},{"line":681,"address":[16219853,16219136,16219859],"length":1,"stats":{"Line":0}},{"line":682,"address":[16219156],"length":1,"stats":{"Line":0}},{"line":683,"address":[16219164],"length":1,"stats":{"Line":0}},{"line":684,"address":[16219174,16219210],"length":1,"stats":{"Line":0}},{"line":685,"address":[16219281],"length":1,"stats":{"Line":0}},{"line":686,"address":[16219372,16219299,16219462],"length":1,"stats":{"Line":0}},{"line":687,"address":[16219558,16219640],"length":1,"stats":{"Line":0}},{"line":688,"address":[16219831,16219708,16219785],"length":1,"stats":{"Line":0}},{"line":689,"address":[16219833,16219806],"length":1,"stats":{"Line":0}},{"line":694,"address":[16219306],"length":1,"stats":{"Line":0}},{"line":698,"address":[16215190,16215130,16214144],"length":1,"stats":{"Line":0}},{"line":699,"address":[16214187],"length":1,"stats":{"Line":0}},{"line":700,"address":[16214209],"length":1,"stats":{"Line":0}},{"line":709,"address":[16214338,16214270],"length":1,"stats":{"Line":0}},{"line":710,"address":[16214474],"length":1,"stats":{"Line":0}},{"line":711,"address":[16215144,16214530,16214597,16214693],"length":1,"stats":{"Line":0}},{"line":712,"address":[16214882,16214797],"length":1,"stats":{"Line":0}},{"line":713,"address":[16214945,16215027],"length":1,"stats":{"Line":0}},{"line":714,"address":[16215048],"length":1,"stats":{"Line":0}},{"line":719,"address":[16214486],"length":1,"stats":{"Line":0}},{"line":723,"address":[16220750,16219872,16220690],"length":1,"stats":{"Line":0}},{"line":728,"address":[16219928],"length":1,"stats":{"Line":0}},{"line":729,"address":[16219981],"length":1,"stats":{"Line":0}},{"line":731,"address":[16220704,16220103,16220196,16220042],"length":1,"stats":{"Line":0}},{"line":732,"address":[16220300,16220442],"length":1,"stats":{"Line":0}},{"line":733,"address":[16220505,16220587],"length":1,"stats":{"Line":0}},{"line":734,"address":[16220608],"length":1,"stats":{"Line":0}},{"line":738,"address":[16220330],"length":1,"stats":{"Line":0}},{"line":742,"address":[16206512,16207521,16207581],"length":1,"stats":{"Line":0}},{"line":743,"address":[16206555],"length":1,"stats":{"Line":0}},{"line":744,"address":[16206577],"length":1,"stats":{"Line":0}},{"line":753,"address":[16206706,16206638],"length":1,"stats":{"Line":0}},{"line":754,"address":[16206842],"length":1,"stats":{"Line":0}},{"line":755,"address":[16207535,16207061,16206898,16206965],"length":1,"stats":{"Line":0}},{"line":756,"address":[16207165,16207250],"length":1,"stats":{"Line":0}},{"line":757,"address":[16207321,16207403],"length":1,"stats":{"Line":0}},{"line":758,"address":[16207439],"length":1,"stats":{"Line":0}},{"line":763,"address":[16206854],"length":1,"stats":{"Line":0}},{"line":767,"address":[16208000,16209408,16209348],"length":1,"stats":{"Line":0}},{"line":768,"address":[16208043],"length":1,"stats":{"Line":0}},{"line":769,"address":[16208065],"length":1,"stats":{"Line":0}},{"line":778,"address":[16208194,16208126],"length":1,"stats":{"Line":0}},{"line":779,"address":[16208330],"length":1,"stats":{"Line":0}},{"line":780,"address":[16208386,16208453,16209362,16208549],"length":1,"stats":{"Line":0}},{"line":781,"address":[16208738,16208653],"length":1,"stats":{"Line":0}},{"line":782,"address":[16208801],"length":1,"stats":{"Line":0}},{"line":783,"address":[16208899,16208992,16208817],"length":1,"stats":{"Line":0}},{"line":784,"address":[16209168,16209083],"length":1,"stats":{"Line":0}},{"line":785,"address":[16209189],"length":1,"stats":{"Line":0}},{"line":789,"address":[16209238],"length":1,"stats":{"Line":0}},{"line":790,"address":[16209266],"length":1,"stats":{"Line":0}},{"line":795,"address":[16208342],"length":1,"stats":{"Line":0}},{"line":799,"address":[16218087,16218093,16217984],"length":1,"stats":{"Line":0}},{"line":800,"address":[16218014],"length":1,"stats":{"Line":0}},{"line":804,"address":[16214119,16214016,16214125],"length":1,"stats":{"Line":0}},{"line":805,"address":[16214046],"length":1,"stats":{"Line":0}},{"line":809,"address":[16206384],"length":1,"stats":{"Line":0}},{"line":810,"address":[16206401],"length":1,"stats":{"Line":0}},{"line":822,"address":[16211221,16211215,16211056],"length":1,"stats":{"Line":0}},{"line":823,"address":[16211077],"length":1,"stats":{"Line":0}},{"line":826,"address":[16206367,16206208,16206373],"length":1,"stats":{"Line":0}},{"line":827,"address":[16206229],"length":1,"stats":{"Line":0}},{"line":830,"address":[16209424,16210288,16210420],"length":1,"stats":{"Line":0}},{"line":838,"address":[16209580],"length":1,"stats":{"Line":0}},{"line":839,"address":[13050864,13050881],"length":1,"stats":{"Line":0}},{"line":840,"address":[16209909,16209790],"length":1,"stats":{"Line":0}},{"line":841,"address":[16210342,16209997],"length":1,"stats":{"Line":0}},{"line":845,"address":[16210031],"length":1,"stats":{"Line":0}},{"line":846,"address":[16210087],"length":1,"stats":{"Line":0}},{"line":849,"address":[16215568,16216826,16216608],"length":1,"stats":{"Line":0}},{"line":854,"address":[16215620],"length":1,"stats":{"Line":0}},{"line":855,"address":[16215916],"length":1,"stats":{"Line":0}},{"line":856,"address":[16215992],"length":1,"stats":{"Line":0}},{"line":857,"address":[16216087,16216244,16216770,16216151],"length":1,"stats":{"Line":0}},{"line":858,"address":[16216659,16216340],"length":1,"stats":{"Line":0}},{"line":859,"address":[16216677],"length":1,"stats":{"Line":0}},{"line":862,"address":[16216382],"length":1,"stats":{"Line":0}},{"line":866,"address":[16207841,16207600,16207847],"length":1,"stats":{"Line":0}},{"line":867,"address":[16207633],"length":1,"stats":{"Line":0}},{"line":868,"address":[16207686],"length":1,"stats":{"Line":0}},{"line":869,"address":[16207761],"length":1,"stats":{"Line":0}},{"line":870,"address":[16207781],"length":1,"stats":{"Line":0}},{"line":874,"address":[16207865,16207701],"length":1,"stats":{"Line":0}},{"line":875,"address":[16207873],"length":1,"stats":{"Line":0}},{"line":876,"address":[16207909],"length":1,"stats":{"Line":0}},{"line":877,"address":[16207929],"length":1,"stats":{"Line":0}},{"line":882,"address":[16213344,16213056,16213350],"length":1,"stats":{"Line":0}},{"line":883,"address":[16213115],"length":1,"stats":{"Line":0}},{"line":884,"address":[16213161],"length":1,"stats":{"Line":0}},{"line":885,"address":[16213181],"length":1,"stats":{"Line":0}},{"line":888,"address":[16213130],"length":1,"stats":{"Line":0}},{"line":889,"address":[16213250],"length":1,"stats":{"Line":0}},{"line":890,"address":[16213285],"length":1,"stats":{"Line":0}},{"line":894,"address":[16215553,16215547,16215216],"length":1,"stats":{"Line":0}},{"line":895,"address":[16215271],"length":1,"stats":{"Line":0}},{"line":897,"address":[16215353,16215416],"length":1,"stats":{"Line":0}},{"line":898,"address":[13051104,13051121],"length":1,"stats":{"Line":0}},{"line":901,"address":[16213041,16213035,16212704],"length":1,"stats":{"Line":0}},{"line":902,"address":[16212759],"length":1,"stats":{"Line":0}},{"line":904,"address":[16212841,16212904],"length":1,"stats":{"Line":0}},{"line":905,"address":[13051073,13051056],"length":1,"stats":{"Line":0}}],"covered":96,"coverable":341},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","lib.rs"],"content":"#![no_std]\nuse soroban_sdk::{contract, contractimpl, symbol_short, Address, BytesN, Env, Map, String, Vec};\n\nmod analytics;\nmod audit;\nmod backup;\nmod bid;\nmod defaults;\nmod errors;\nmod events;\nmod fees;\nmod investment;\nmod invoice;\nmod notifications;\nmod payments;\nmod profits;\nmod settlement;\n#[cfg(test)]\nmod test_fees;\nmod verification;\n\nuse bid::{Bid, BidStatus, BidStorage};\nuse defaults::{\n    create_dispute as do_create_dispute, get_dispute_details as do_get_dispute_details,\n    get_invoices_by_dispute_status as do_get_invoices_by_dispute_status,\n    get_invoices_with_disputes as do_get_invoices_with_disputes,\n    handle_default as do_handle_default, put_dispute_under_review as do_put_dispute_under_review,\n    resolve_dispute as do_resolve_dispute,\n};\nuse errors::QuickLendXError;\nuse events::{\n    emit_audit_query, emit_audit_validation, emit_bid_placed, emit_bid_withdrawn,\n    emit_escrow_created, emit_escrow_refunded, emit_escrow_released, emit_insurance_added,\n    emit_insurance_premium_collected, emit_investor_verified, emit_invoice_cancelled,\n    emit_invoice_metadata_cleared, emit_invoice_metadata_updated, emit_invoice_uploaded,\n    emit_invoice_verified,\n};\nuse investment::{Investment, InvestmentStatus, InvestmentStorage};\nuse invoice::{DisputeStatus, Invoice, InvoiceMetadata, InvoiceStatus, InvoiceStorage};\nuse payments::{create_escrow, refund_escrow, release_escrow, EscrowStorage};\nuse profits::{calculate_profit as do_calculate_profit, PlatformFee, PlatformFeeConfig};\nuse settlement::{\n    process_partial_payment as do_process_partial_payment, settle_invoice as do_settle_invoice,\n};\nuse verification::{\n    calculate_investment_limit, calculate_investor_risk_score, determine_investor_tier,\n    get_business_verification_status, get_investor_analytics,\n    get_investor_verification as do_get_investor_verification, reject_business,\n    reject_investor as do_reject_investor, submit_investor_kyc as do_submit_investor_kyc,\n    submit_kyc_application, update_investor_analytics, validate_bid, validate_investor_investment,\n    validate_invoice_metadata, verify_business, verify_investor as do_verify_investor,\n    verify_invoice_data, BusinessVerificationStatus, BusinessVerificationStorage,\n    InvestorRiskLevel, InvestorTier, InvestorVerification, InvestorVerificationStorage,\n};\n\nuse crate::backup::{Backup, BackupStatus, BackupStorage};\nuse crate::notifications::{\n    Notification, NotificationDeliveryStatus, NotificationPreferences, NotificationStats,\n    NotificationSystem,\n};\nuse analytics::{\n    AnalyticsCalculator, AnalyticsStorage, BusinessReport, FinancialMetrics, InvestorAnalytics,\n    InvestorPerformanceMetrics, InvestorReport, PerformanceMetrics, PlatformMetrics, TimePeriod,\n    UserBehaviorMetrics,\n};\nuse audit::{AuditLogEntry, AuditOperation, AuditQueryFilter, AuditStats, AuditStorage};\n\n#[contract]\npub struct QuickLendXContract;\n\n#[contractimpl]\nimpl QuickLendXContract {\n    /// Store an invoice in the contract\n    pub fn store_invoice(\n        env: Env,\n        business: Address,\n        amount: i128,\n        currency: Address,\n        due_date: u64,\n        description: String,\n        category: invoice::InvoiceCategory,\n        tags: Vec\u003cString\u003e,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Validate input parameters\n        if amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let current_timestamp = env.ledger().timestamp();\n        if due_date \u003c= current_timestamp {\n            return Err(QuickLendXError::InvoiceDueDateInvalid);\n        }\n\n        if description.len() == 0 {\n            return Err(QuickLendXError::InvalidDescription);\n        }\n\n        // Check if business is verified (temporarily disabled for debugging)\n        // if !verification::BusinessVerificationStorage::is_business_verified(\u0026env, \u0026business) {\n        //     return Err(QuickLendXError::BusinessNotVerified);\n        // }\n\n        // Validate category and tags\n        verification::validate_invoice_category(\u0026category)?;\n        verification::validate_invoice_tags(\u0026tags)?;\n\n        // Create new invoice\n        let invoice = Invoice::new(\n            \u0026env,\n            business.clone(),\n            amount,\n            currency.clone(),\n            due_date,\n            description,\n            category,\n            tags,\n        );\n\n        // Store the invoice\n        InvoiceStorage::store_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        env.events().publish(\n            (symbol_short!(\"created\"),),\n            (invoice.id.clone(), business, amount, currency, due_date),\n        );\n\n        Ok(invoice.id)\n    }\n\n    /// Upload an invoice (business only)\n    pub fn upload_invoice(\n        env: Env,\n        business: Address,\n        amount: i128,\n        currency: Address,\n        due_date: u64,\n        description: String,\n        category: invoice::InvoiceCategory,\n        tags: Vec\u003cString\u003e,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Only the business can upload their own invoice\n        business.require_auth();\n\n        // Check if business is verified\n        let verification = get_business_verification_status(\u0026env, \u0026business);\n        if verification.is_none()\n            || !matches!(\n                verification.unwrap().status,\n                verification::BusinessVerificationStatus::Verified\n            )\n        {\n            return Err(QuickLendXError::BusinessNotVerified);\n        }\n\n        // Basic validation\n        verify_invoice_data(\u0026env, \u0026business, amount, \u0026currency, due_date, \u0026description)?;\n\n        // Validate category and tags\n        verification::validate_invoice_category(\u0026category)?;\n        verification::validate_invoice_tags(\u0026tags)?;\n\n        // Create and store invoice\n        let invoice = Invoice::new(\n            \u0026env,\n            business.clone(),\n            amount,\n            currency.clone(),\n            due_date,\n            description.clone(),\n            category,\n            tags,\n        );\n        InvoiceStorage::store_invoice(\u0026env, \u0026invoice);\n        emit_invoice_uploaded(\u0026env, \u0026invoice);\n\n        // Send notification\n        let _ = NotificationSystem::notify_invoice_created(\u0026env, \u0026invoice);\n\n        Ok(invoice.id)\n    }\n\n    /// Verify an invoice (admin or automated process)\n    pub fn verify_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        // Only allow verification if pending\n        if invoice.status != InvoiceStatus::Pending {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        // Remove from pending status list\n        // Remove from old status list (Pending)\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026InvoiceStatus::Pending, \u0026invoice_id);\n\n        invoice.verify(\u0026env, admin.clone());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Add to verified status list\n        // Add to new status list (Verified)\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026InvoiceStatus::Verified, \u0026invoice_id);\n\n        emit_invoice_verified(\u0026env, \u0026invoice);\n\n        // Send notification\n        let _ = NotificationSystem::notify_invoice_verified(\u0026env, \u0026invoice);\n\n        // If invoice is funded (has escrow), release escrow funds to business\n        if invoice.status == InvoiceStatus::Funded {\n            Self::release_escrow_funds(env.clone(), invoice_id)?;\n        }\n\n        Ok(())\n    }\n\n    /// Cancel an invoice (business only, before funding)\n    pub fn cancel_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can cancel their own invoice\n        invoice.business.require_auth();\n\n        // Remove from old status list\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026invoice.status, \u0026invoice_id);\n\n        // Cancel the invoice (only works if Pending or Verified)\n        invoice.cancel(\u0026env, invoice.business.clone())?;\n\n        // Update storage\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Add to cancelled status list\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026InvoiceStatus::Cancelled, \u0026invoice_id);\n\n        // Emit event\n        emit_invoice_cancelled(\u0026env, \u0026invoice);\n\n        // Send notification (optional - could notify interested investors)\n        let _ = NotificationSystem::notify_invoice_status_changed(\n            \u0026env,\n            \u0026invoice,\n            \u0026InvoiceStatus::Pending, // Could be Pending or Verified\n            \u0026InvoiceStatus::Cancelled,\n        );\n\n        Ok(())\n    }\n\n    /// Get an invoice by ID\n    pub fn get_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003cInvoice, QuickLendXError\u003e {\n        InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).ok_or(QuickLendXError::InvoiceNotFound)\n    }\n\n    /// Get all invoices for a business\n    pub fn get_invoice_by_business(env: Env, business: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_business_invoices(\u0026env, \u0026business)\n    }\n\n    /// Get all invoices for a specific business\n    pub fn get_business_invoices(env: Env, business: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_business_invoices(\u0026env, \u0026business)\n    }\n\n    /// Update structured metadata for an invoice\n    pub fn update_invoice_metadata(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        metadata: InvoiceMetadata,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        invoice.business.require_auth();\n        validate_invoice_metadata(\u0026metadata, invoice.amount)?;\n\n        if let Some(existing) = invoice.metadata() {\n            InvoiceStorage::remove_metadata_indexes(\u0026env, \u0026existing, \u0026invoice.id);\n        }\n\n        invoice.set_metadata(\u0026env, Some(metadata.clone()));\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n        InvoiceStorage::add_metadata_indexes(\u0026env, \u0026invoice);\n\n        emit_invoice_metadata_updated(\u0026env, \u0026invoice, \u0026metadata);\n        Ok(())\n    }\n\n    /// Clear metadata attached to an invoice\n    pub fn clear_invoice_metadata(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        invoice.business.require_auth();\n\n        if let Some(existing) = invoice.metadata() {\n            InvoiceStorage::remove_metadata_indexes(\u0026env, \u0026existing, \u0026invoice.id);\n            invoice.set_metadata(\u0026env, None);\n            InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n            emit_invoice_metadata_cleared(\u0026env, \u0026invoice);\n        }\n\n        Ok(())\n    }\n\n    /// Get invoices indexed by customer name\n    pub fn get_invoices_by_customer(env: Env, customer_name: String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_customer(\u0026env, \u0026customer_name)\n    }\n\n    /// Get invoices indexed by tax id\n    pub fn get_invoices_by_tax_id(env: Env, tax_id: String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_tax_id(\u0026env, \u0026tax_id)\n    }\n\n    /// Get all invoices by status\n    pub fn get_invoices_by_status(env: Env, status: InvoiceStatus) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_status(\u0026env, \u0026status)\n    }\n\n    /// Get all available invoices (verified and not funded)\n    pub fn get_available_invoices(env: Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Verified)\n    }\n\n    /// Update invoice status (admin function)\n    pub fn update_invoice_status(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        new_status: InvoiceStatus,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Remove from old status list\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026invoice.status, \u0026invoice_id);\n\n        // Update status\n        match new_status {\n            InvoiceStatus::Verified =\u003e invoice.verify(\u0026env, invoice.business.clone()),\n            InvoiceStatus::Paid =\u003e {\n                invoice.mark_as_paid(\u0026env, invoice.business.clone(), env.ledger().timestamp())\n            }\n            InvoiceStatus::Defaulted =\u003e invoice.mark_as_defaulted(),\n            InvoiceStatus::Funded =\u003e {\n                // For testing purposes - normally funding happens via accept_bid\n                invoice.mark_as_funded(\n                    \u0026env,\n                    invoice.business.clone(),\n                    invoice.amount,\n                    env.ledger().timestamp(),\n                );\n            }\n            _ =\u003e return Err(QuickLendXError::InvalidStatus),\n        }\n\n        // Store updated invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Add to new status list\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026invoice.status, \u0026invoice_id);\n\n        // Emit event\n        env.events().publish(\n            (symbol_short!(\"updated\"),),\n            (invoice_id, new_status.clone()),\n        );\n\n        // Send notifications based on status change\n        match new_status {\n            InvoiceStatus::Verified =\u003e {\n                let _ = NotificationSystem::notify_invoice_verified(\u0026env, \u0026invoice);\n            }\n            InvoiceStatus::Paid =\u003e {\n                let _ = NotificationSystem::notify_payment_received(\u0026env, \u0026invoice, invoice.amount);\n            }\n            InvoiceStatus::Defaulted =\u003e {\n                let _ = NotificationSystem::notify_invoice_defaulted(\u0026env, \u0026invoice);\n            }\n            _ =\u003e {}\n        }\n\n        Ok(())\n    }\n\n    /// Get invoice count by status\n    pub fn get_invoice_count_by_status(env: Env, status: InvoiceStatus) -\u003e u32 {\n        let invoices = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026status);\n        invoices.len() as u32\n    }\n\n    /// Get total invoice count\n    pub fn get_total_invoice_count(env: Env) -\u003e u32 {\n        let pending = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Pending);\n        let verified = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Verified);\n        let funded = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Funded);\n        let paid = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Paid);\n        let defaulted = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Defaulted);\n        let cancelled = Self::get_invoice_count_by_status(env.clone(), InvoiceStatus::Cancelled);\n\n        pending + verified + funded + paid + defaulted + cancelled\n    }\n\n    /// Get a bid by ID\n    pub fn get_bid(env: Env, bid_id: BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        BidStorage::get_bid(\u0026env, \u0026bid_id)\n    }\n\n    /// Get the highest ranked bid for an invoice\n    pub fn get_best_bid(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Option\u003cBid\u003e {\n        BidStorage::get_best_bid(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get all bids for an invoice sorted using the platform ranking rules\n    pub fn get_ranked_bids(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        BidStorage::rank_bids(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get bids filtered by status\n    pub fn get_bids_by_status(env: Env, invoice_id: BytesN\u003c32\u003e, status: BidStatus) -\u003e Vec\u003cBid\u003e {\n        BidStorage::get_bids_by_status(\u0026env, \u0026invoice_id, status)\n    }\n\n    /// Get bids filtered by investor\n    pub fn get_bids_by_investor(env: Env, invoice_id: BytesN\u003c32\u003e, investor: Address) -\u003e Vec\u003cBid\u003e {\n        BidStorage::get_bids_by_investor(\u0026env, \u0026invoice_id, \u0026investor)\n    }\n\n    /// Get all bids for an invoice\n    /// Returns a list of all bid records (including expired, withdrawn, etc.)\n    /// Use get_bids_by_status to filter by status if needed\n    pub fn get_bids_for_invoice(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Vec\u003cBid\u003e {\n        BidStorage::get_bid_records_for_invoice(\u0026env, \u0026invoice_id)\n    }\n\n    /// Remove bids that have passed their expiration window\n    pub fn cleanup_expired_bids(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e u32 {\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id)\n    }\n\n    /// Place a bid on an invoice\n    ///\n    /// Validates:\n    /// - Invoice exists and is verified\n    /// - Bid amount is positive\n    /// - Investor is authorized and verified\n    /// - Creates and stores the bid\n    pub fn place_bid(\n        env: Env,\n        investor: Address,\n        invoice_id: BytesN\u003c32\u003e,\n        bid_amount: i128,\n        expected_return: i128,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Authorization check: Only the investor can place their own bid\n        investor.require_auth();\n\n        // Validate bid amount is positive\n        if bid_amount \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        // Validate invoice exists and is verified\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        if invoice.status != InvoiceStatus::Verified {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        let verification = do_get_investor_verification(\u0026env, \u0026investor)\n            .ok_or(QuickLendXError::BusinessNotVerified)?;\n        match verification.status {\n            BusinessVerificationStatus::Verified =\u003e {\n                if bid_amount \u003e verification.investment_limit {\n                    return Err(QuickLendXError::InvalidAmount);\n                }\n            }\n            BusinessVerificationStatus::Pending =\u003e return Err(QuickLendXError::KYCAlreadyPending),\n            BusinessVerificationStatus::Rejected =\u003e {\n                return Err(QuickLendXError::BusinessNotVerified)\n            }\n        }\n\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id);\n        validate_bid(\u0026env, \u0026invoice, bid_amount, expected_return, \u0026investor)?;\n        // Create bid\n        let bid_id = BidStorage::generate_unique_bid_id(\u0026env);\n        let current_timestamp = env.ledger().timestamp();\n        let bid = Bid {\n            bid_id: bid_id.clone(),\n            invoice_id: invoice_id.clone(),\n            investor: investor.clone(),\n            bid_amount,\n            expected_return,\n            timestamp: current_timestamp,\n            status: BidStatus::Placed,\n            expiration_timestamp: Bid::default_expiration(current_timestamp),\n        };\n        BidStorage::store_bid(\u0026env, \u0026bid);\n        // Track bid for this invoice\n        BidStorage::add_bid_to_invoice(\u0026env, \u0026invoice_id, \u0026bid_id);\n\n        // Emit bid placed event\n        emit_bid_placed(\u0026env, \u0026bid);\n\n        // Send notification for business about new bid\n        let _ = NotificationSystem::notify_bid_received(\u0026env, \u0026invoice, \u0026bid);\n\n        Ok(bid_id)\n    }\n\n    /// Accept a bid (business only)\n    pub fn accept_bid(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        bid_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id);\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        let bid = BidStorage::get_bid(\u0026env, \u0026bid_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n        let invoice_id = bid.invoice_id.clone();\n        BidStorage::cleanup_expired_bids(\u0026env, \u0026invoice_id);\n        let mut bid =\n            BidStorage::get_bid(\u0026env, \u0026bid_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n        // Only the business owner can accept a bid\n        invoice.business.require_auth();\n        // Only allow accepting if invoice is verified and bid is placed\n        if invoice.status != InvoiceStatus::Verified || bid.status != BidStatus::Placed {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        // Create escrow\n        let escrow_id = create_escrow(\n            \u0026env,\n            \u0026invoice_id,\n            \u0026bid.investor,\n            \u0026invoice.business,\n            bid.bid_amount,\n            \u0026invoice.currency,\n        )?;\n        // Mark bid as accepted\n        bid.status = BidStatus::Accepted;\n        BidStorage::update_bid(\u0026env, \u0026bid);\n        // Mark invoice as funded\n        invoice.mark_as_funded(\n            \u0026env,\n            bid.investor.clone(),\n            bid.bid_amount,\n            env.ledger().timestamp(),\n        );\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n        // Track investment\n        let investment_id = InvestmentStorage::generate_unique_investment_id(\u0026env);\n        let investment = Investment {\n            investment_id: investment_id.clone(),\n            invoice_id: invoice_id.clone(),\n            investor: bid.investor.clone(),\n            amount: bid.bid_amount,\n            funded_at: env.ledger().timestamp(),\n            status: InvestmentStatus::Active,\n            insurance: Vec::new(\u0026env),\n        };\n        InvestmentStorage::store_investment(\u0026env, \u0026investment);\n\n        let escrow = EscrowStorage::get_escrow(\u0026env, \u0026escrow_id)\n            .expect(\"Escrow should exist after creation\");\n        emit_escrow_created(\u0026env, \u0026escrow);\n\n        // Send notification to investor for bid acceptance\n        let _ = NotificationSystem::notify_bid_accepted(\u0026env, \u0026invoice, \u0026bid);\n\n        // Send notification about invoice status change\n        let _ = NotificationSystem::notify_invoice_status_changed(\n            \u0026env,\n            \u0026invoice,\n            \u0026InvoiceStatus::Verified,\n            \u0026InvoiceStatus::Funded,\n        );\n\n        Ok(())\n    }\n\n    pub fn add_investment_insurance(\n        env: Env,\n        investment_id: BytesN\u003c32\u003e,\n        provider: Address,\n        coverage_percentage: u32,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut investment = InvestmentStorage::get_investment(\u0026env, \u0026investment_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        investment.investor.require_auth();\n\n        if investment.status != InvestmentStatus::Active {\n            return Err(QuickLendXError::InvalidStatus);\n        }\n\n        let premium = Investment::calculate_premium(investment.amount, coverage_percentage);\n        if premium \u003c= 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let coverage_amount =\n            investment.add_insurance(provider.clone(), coverage_percentage, premium)?;\n\n        InvestmentStorage::update_investment(\u0026env, \u0026investment);\n\n        emit_insurance_added(\n            \u0026env,\n            \u0026investment_id,\n            \u0026investment.invoice_id,\n            \u0026investment.investor,\n            \u0026provider,\n            coverage_percentage,\n            coverage_amount,\n            premium,\n        );\n        emit_insurance_premium_collected(\u0026env, \u0026investment_id, \u0026provider, premium);\n\n        Ok(())\n    }\n\n    /// Withdraw a bid (investor only, before acceptance)\n    ///\n    /// Validates:\n    /// - Bid exists\n    /// - Caller is the bid owner (authorization check)\n    /// - Bid is in Placed status (prevents withdrawal of accepted/expired/withdrawn bids)\n    /// - Updates bid status to Withdrawn\n    pub fn withdraw_bid(env: Env, bid_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Get bid and validate it exists\n        let mut bid =\n            BidStorage::get_bid(\u0026env, \u0026bid_id).ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Authorization check: Only the investor who owns the bid can withdraw it\n        bid.investor.require_auth();\n\n        // Status validation: Only allow withdrawal if bid is placed\n        // Prevents withdrawal of accepted, withdrawn, or expired bids\n        if bid.status != BidStatus::Placed {\n            return Err(QuickLendXError::OperationNotAllowed);\n        }\n        bid.status = BidStatus::Withdrawn;\n        BidStorage::update_bid(\u0026env, \u0026bid);\n\n        // Emit bid withdrawn event\n        emit_bid_withdrawn(\u0026env, \u0026bid);\n\n        Ok(())\n    }\n\n    /// Settle an invoice (business or automated process)\n    pub fn settle_invoice(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        payment_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Get the investment to track investor analytics\n        let investment = InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id);\n\n        let result = do_settle_invoice(\u0026env, \u0026invoice_id, payment_amount);\n\n        // Update investor analytics if settlement was successful\n        if result.is_ok() {\n            if let Some(inv) = investment {\n                let is_successful = payment_amount \u003e= inv.amount;\n                let _ = update_investor_analytics(\u0026env, \u0026inv.investor, inv.amount, is_successful);\n            }\n        }\n\n        result\n    }\n\n    pub fn get_invoice_investment(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cInvestment, QuickLendXError\u003e {\n        InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)\n    }\n\n    pub fn get_investment(\n        env: Env,\n        investment_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cInvestment, QuickLendXError\u003e {\n        InvestmentStorage::get_investment(\u0026env, \u0026investment_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)\n    }\n\n    /// Process a partial payment towards an invoice\n    pub fn process_partial_payment(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        payment_amount: i128,\n        transaction_id: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_process_partial_payment(\u0026env, \u0026invoice_id, payment_amount, transaction_id)\n    }\n\n    /// Handle invoice default (admin or automated process)\n    pub fn handle_default(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Get the investment to track investor analytics\n        let investment = InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id);\n\n        let result = do_handle_default(\u0026env, \u0026invoice_id);\n\n        // Update investor analytics for failed investment\n        if result.is_ok() {\n            if let Some(inv) = investment {\n                let _ = update_investor_analytics(\u0026env, \u0026inv.investor, inv.amount, false);\n            }\n        }\n\n        result\n    }\n\n    /// Calculate profit and platform fee\n    pub fn calculate_profit(\n        env: Env,\n        investment_amount: i128,\n        payment_amount: i128,\n    ) -\u003e (i128, i128) {\n        do_calculate_profit(\u0026env, investment_amount, payment_amount)\n    }\n\n    /// Retrieve the current platform fee configuration\n    pub fn get_platform_fee(env: Env) -\u003e PlatformFeeConfig {\n        PlatformFee::get_config(\u0026env)\n    }\n\n    /// Update the platform fee basis points (admin only)\n    pub fn set_platform_fee(env: Env, new_fee_bps: i128) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        PlatformFee::set_config(\u0026env, \u0026admin, new_fee_bps)?;\n        Ok(())\n    }\n\n    // Rating Functions (from feat-invoice_rating_system)\n\n    /// Add a rating to an invoice (investor only)\n    pub fn add_invoice_rating(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        rating: u32,\n        feedback: String,\n        rater: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the investor who funded the invoice can rate it\n        rater.require_auth();\n\n        invoice.add_rating(rating, feedback, rater.clone(), env.ledger().timestamp())?;\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit rating event\n        env.events()\n            .publish((symbol_short!(\"rated\"),), (invoice_id, rating, rater));\n\n        Ok(())\n    }\n\n    /// Get invoices with ratings above a threshold\n    pub fn get_invoices_with_rating_above(env: Env, threshold: u32) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_with_rating_above(\u0026env, threshold)\n    }\n\n    /// Get business invoices with ratings above a threshold\n    pub fn get_business_rated_invoices(\n        env: Env,\n        business: Address,\n        threshold: u32,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_business_invoices_with_rating_above(\u0026env, \u0026business, threshold)\n    }\n\n    /// Get count of invoices with ratings\n    pub fn get_invoices_with_ratings_count(env: Env) -\u003e u32 {\n        InvoiceStorage::get_invoices_with_ratings_count(\u0026env)\n    }\n\n    /// Get invoice rating statistics\n    pub fn get_invoice_rating_stats(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003c(Option\u003cu32\u003e, u32, Option\u003cu32\u003e, Option\u003cu32\u003e), QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        Ok((\n            invoice.average_rating,\n            invoice.total_ratings,\n            invoice.get_highest_rating(),\n            invoice.get_lowest_rating(),\n        ))\n    }\n\n    // Business KYC/Verification Functions (from main)\n\n    /// Submit KYC application (business only)\n    pub fn submit_kyc_application(\n        env: Env,\n        business: Address,\n        kyc_data: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        submit_kyc_application(\u0026env, \u0026business, kyc_data)\n    }\n\n    /// Submit investor verification request\n    pub fn submit_investor_kyc(\n        env: Env,\n        investor: Address,\n        kyc_data: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_submit_investor_kyc(\u0026env, \u0026investor, kyc_data)\n    }\n\n    /// Verify an investor and set an investment limit\n    pub fn verify_investor(\n        env: Env,\n        investor: Address,\n        investment_limit: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        let verification = do_verify_investor(\u0026env, \u0026admin, \u0026investor, investment_limit)?;\n        emit_investor_verified(\u0026env, \u0026verification);\n        Ok(())\n    }\n\n    /// Reject an investor verification request\n    pub fn reject_investor(\n        env: Env,\n        investor: Address,\n        reason: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        do_reject_investor(\u0026env, \u0026admin, \u0026investor, reason)\n    }\n\n    /// Get investor verification record if available\n    pub fn get_investor_verification(env: Env, investor: Address) -\u003e Option\u003cInvestorVerification\u003e {\n        do_get_investor_verification(\u0026env, \u0026investor)\n    }\n\n    /// Verify business (admin only)\n    pub fn verify_business(\n        env: Env,\n        admin: Address,\n        business: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        verify_business(\u0026env, \u0026admin, \u0026business)\n    }\n\n    /// Reject business (admin only)\n    pub fn reject_business(\n        env: Env,\n        admin: Address,\n        business: Address,\n        reason: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        reject_business(\u0026env, \u0026admin, \u0026business, reason)\n    }\n\n    /// Get business verification status\n    pub fn get_business_verification_status(\n        env: Env,\n        business: Address,\n    ) -\u003e Option\u003cverification::BusinessVerification\u003e {\n        get_business_verification_status(\u0026env, \u0026business)\n    }\n\n    /// Set admin address (initialization function)\n    pub fn set_admin(env: Env, admin: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        if let Some(current_admin) = BusinessVerificationStorage::get_admin(\u0026env) {\n            current_admin.require_auth();\n        } else {\n            admin.require_auth();\n        }\n        BusinessVerificationStorage::set_admin(\u0026env, \u0026admin);\n        Ok(())\n    }\n\n    /// Get admin address\n    pub fn get_admin(env: Env) -\u003e Option\u003cAddress\u003e {\n        BusinessVerificationStorage::get_admin(\u0026env)\n    }\n\n    /// Get all verified businesses\n    pub fn get_verified_businesses(env: Env) -\u003e Vec\u003cAddress\u003e {\n        BusinessVerificationStorage::get_verified_businesses(\u0026env)\n    }\n\n    /// Get all pending businesses\n    pub fn get_pending_businesses(env: Env) -\u003e Vec\u003cAddress\u003e {\n        BusinessVerificationStorage::get_pending_businesses(\u0026env)\n    }\n\n    /// Get all rejected businesses\n    pub fn get_rejected_businesses(env: Env) -\u003e Vec\u003cAddress\u003e {\n        BusinessVerificationStorage::get_rejected_businesses(\u0026env)\n    }\n\n    // ========================================\n    // Enhanced Investor Verification Functions\n    // ========================================\n\n    /// Get all verified investors\n    pub fn get_verified_investors(env: Env) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_verified_investors(\u0026env)\n    }\n\n    /// Get all pending investors\n    pub fn get_pending_investors(env: Env) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_pending_investors(\u0026env)\n    }\n\n    /// Get all rejected investors\n    pub fn get_rejected_investors(env: Env) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_rejected_investors(\u0026env)\n    }\n\n    /// Get investors by tier\n    pub fn get_investors_by_tier(env: Env, tier: InvestorTier) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_investors_by_tier(\u0026env, tier)\n    }\n\n    /// Get investors by risk level\n    pub fn get_investors_by_risk_level(env: Env, risk_level: InvestorRiskLevel) -\u003e Vec\u003cAddress\u003e {\n        InvestorVerificationStorage::get_investors_by_risk_level(\u0026env, risk_level)\n    }\n\n    /// Calculate investor risk score\n    pub fn calculate_investor_risk_score(\n        env: Env,\n        investor: Address,\n        kyc_data: String,\n    ) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        calculate_investor_risk_score(\u0026env, \u0026investor, \u0026kyc_data)\n    }\n\n    /// Determine investor tier\n    pub fn determine_investor_tier(\n        env: Env,\n        investor: Address,\n        risk_score: u32,\n    ) -\u003e Result\u003cInvestorTier, QuickLendXError\u003e {\n        determine_investor_tier(\u0026env, \u0026investor, risk_score)\n    }\n\n    /// Calculate investment limit for investor\n    pub fn calculate_investment_limit(\n        _env: Env,\n        tier: InvestorTier,\n        risk_level: InvestorRiskLevel,\n        base_limit: i128,\n    ) -\u003e i128 {\n        calculate_investment_limit(\u0026tier, \u0026risk_level, base_limit)\n    }\n\n    /// Update investor analytics after investment\n    pub fn update_investor_analytics(\n        env: Env,\n        investor: Address,\n        investment_amount: i128,\n        is_successful: bool,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        update_investor_analytics(\u0026env, \u0026investor, investment_amount, is_successful)\n    }\n\n    /// Get investor analytics\n    pub fn get_investor_analytics(\n        env: Env,\n        investor: Address,\n    ) -\u003e Result\u003cInvestorVerification, QuickLendXError\u003e {\n        get_investor_analytics(\u0026env, \u0026investor)\n    }\n\n    /// Validate investor investment\n    pub fn validate_investor_investment(\n        env: Env,\n        investor: Address,\n        investment_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        validate_investor_investment(\u0026env, \u0026investor, investment_amount)\n    }\n\n    /// Check if investor is verified\n    pub fn is_investor_verified(env: Env, investor: Address) -\u003e bool {\n        InvestorVerificationStorage::is_investor_verified(\u0026env, \u0026investor)\n    }\n\n    /// Release escrow funds to business upon invoice verification\n    pub fn release_escrow_funds(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let escrow = EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Release escrow funds\n        release_escrow(\u0026env, \u0026invoice_id)?;\n\n        // Emit event\n        emit_escrow_released(\n            \u0026env,\n            \u0026escrow.escrow_id,\n            \u0026invoice_id,\n            \u0026escrow.business,\n            escrow.amount,\n        );\n\n        Ok(())\n    }\n\n    /// Refund escrow funds to investor if verification fails\n    pub fn refund_escrow_funds(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let escrow = EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Refund escrow funds\n        refund_escrow(\u0026env, \u0026invoice_id)?;\n\n        // Emit event\n        emit_escrow_refunded(\n            \u0026env,\n            \u0026escrow.escrow_id,\n            \u0026invoice_id,\n            \u0026escrow.investor,\n            escrow.amount,\n        );\n\n        Ok(())\n    }\n\n    /// Get escrow status for an invoice\n    pub fn get_escrow_status(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cpayments::EscrowStatus, QuickLendXError\u003e {\n        let escrow = EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n        Ok(escrow.status)\n    }\n\n    /// Get escrow details for an invoice\n    pub fn get_escrow_details(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cpayments::Escrow, QuickLendXError\u003e {\n        EscrowStorage::get_escrow_by_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)\n    }\n\n    ///== Notification Management Functions ==///\n\n    /// Get a notification by ID\n    pub fn get_notification(env: Env, notification_id: BytesN\u003c32\u003e) -\u003e Option\u003cNotification\u003e {\n        NotificationSystem::get_notification(\u0026env, \u0026notification_id)\n    }\n\n    /// Update notification delivery status\n    pub fn update_notification_status(\n        env: Env,\n        notification_id: BytesN\u003c32\u003e,\n        status: NotificationDeliveryStatus,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        NotificationSystem::update_notification_status(\u0026env, \u0026notification_id, status)\n    }\n\n    /// Get all notifications for a user\n    pub fn get_user_notifications(env: Env, user: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        NotificationSystem::get_user_notifications(\u0026env, \u0026user)\n    }\n\n    /// Get user notification preferences\n    pub fn get_notification_preferences(env: Env, user: Address) -\u003e NotificationPreferences {\n        NotificationSystem::get_user_preferences(\u0026env, \u0026user)\n    }\n\n    /// Update user notification preferences\n    pub fn update_notification_preferences(\n        env: Env,\n        user: Address,\n        preferences: NotificationPreferences,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        user.require_auth();\n        NotificationSystem::update_user_preferences(\u0026env, \u0026user, preferences);\n        Ok(())\n    }\n\n    /// Get notification statistics for a user\n    pub fn get_user_notification_stats(env: Env, user: Address) -\u003e NotificationStats {\n        NotificationSystem::get_user_notification_stats(\u0026env, \u0026user)\n    }\n\n    /// Check for overdue invoices and send notifications (admin or automated process)\n    pub fn check_overdue_invoices(env: Env) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        Self::check_overdue_invoices_grace(env, Invoice::DEFAULT_GRACE_PERIOD)\n    }\n\n    /// Check for overdue invoices with a custom grace period (in seconds)\n    pub fn check_overdue_invoices_grace(\n        env: Env,\n        grace_period: u64,\n    ) -\u003e Result\u003cu32, QuickLendXError\u003e {\n        let current_timestamp = env.ledger().timestamp();\n        let funded_invoices = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Funded);\n        let mut overdue_count = 0u32;\n\n        for invoice_id in funded_invoices.iter() {\n            if let Some(invoice) = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id) {\n                if invoice.is_overdue(current_timestamp) {\n                    let _ = NotificationSystem::notify_payment_overdue(\u0026env, \u0026invoice);\n                    overdue_count += 1;\n                }\n                let _ = invoice.check_and_handle_expiration(\u0026env, grace_period)?;\n            }\n        }\n\n        Ok(overdue_count)\n    }\n\n    /// Check whether a specific invoice has expired and trigger default handling when necessary\n    pub fn check_invoice_expiration(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        grace_period: Option\u003cu64\u003e,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        let grace = grace_period.unwrap_or(Invoice::DEFAULT_GRACE_PERIOD);\n        invoice.check_and_handle_expiration(\u0026env, grace)\n    }\n\n    /// Create a backup of all invoice data\n    pub fn create_backup(env: Env, description: String) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n        // Only admin can create backups\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        // Get all invoices\n        let pending = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Pending);\n        let verified = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Verified);\n        let funded = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Funded);\n        let paid = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Paid);\n        let defaulted = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Defaulted);\n\n        // Combine all invoices\n        let mut all_invoices = Vec::new(\u0026env);\n        for status_vec in [pending, verified, funded, paid, defaulted].iter() {\n            for invoice_id in status_vec.iter() {\n                if let Some(invoice) = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id) {\n                    all_invoices.push_back(invoice);\n                }\n            }\n        }\n\n        // Create backup\n        let backup_id = BackupStorage::generate_backup_id(\u0026env);\n        let backup = Backup {\n            backup_id: backup_id.clone(),\n            timestamp: env.ledger().timestamp(),\n            description,\n            invoice_count: all_invoices.len() as u32,\n            status: BackupStatus::Active,\n        };\n\n        // Store backup and data\n        BackupStorage::store_backup(\u0026env, \u0026backup);\n        BackupStorage::store_backup_data(\u0026env, \u0026backup_id, \u0026all_invoices);\n        BackupStorage::add_to_backup_list(\u0026env, \u0026backup_id);\n\n        // Clean up old backups (keep last 5)\n        BackupStorage::cleanup_old_backups(\u0026env, 5)?;\n\n        // Emit event\n        events::emit_backup_created(\u0026env, \u0026backup_id, backup.invoice_count);\n\n        Ok(backup_id)\n    }\n\n    /// Restore invoice data from a backup\n    pub fn restore_backup(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Only admin can restore backups\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        // Validate backup first\n        BackupStorage::validate_backup(\u0026env, \u0026backup_id)?;\n\n        // Get backup data\n        let invoices = BackupStorage::get_backup_data(\u0026env, \u0026backup_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        // Clear current invoice data\n        Self::clear_all_invoices(\u0026env)?;\n\n        // Restore invoices\n        for invoice in invoices.iter() {\n            InvoiceStorage::store_invoice(\u0026env, \u0026invoice);\n        }\n\n        // Emit event\n        events::emit_backup_restored(\u0026env, \u0026backup_id, invoices.len() as u32);\n\n        Ok(())\n    }\n\n    /// Validate a backup's integrity\n    pub fn validate_backup(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let result = BackupStorage::validate_backup(\u0026env, \u0026backup_id).is_ok();\n        events::emit_backup_validated(\u0026env, \u0026backup_id, result);\n        Ok(result)\n    }\n\n    /// Archive a backup (mark as no longer active)\n    pub fn archive_backup(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Only admin can archive backups\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let mut backup = BackupStorage::get_backup(\u0026env, \u0026backup_id)\n            .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n        backup.status = BackupStatus::Archived;\n        BackupStorage::update_backup(\u0026env, \u0026backup);\n        BackupStorage::remove_from_backup_list(\u0026env, \u0026backup_id);\n\n        events::emit_backup_archived(\u0026env, \u0026backup_id);\n\n        Ok(())\n    }\n\n    /// Get all available backups\n    pub fn get_backups(env: Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        BackupStorage::get_all_backups(\u0026env)\n    }\n\n    /// Get backup details\n    pub fn get_backup_details(env: Env, backup_id: BytesN\u003c32\u003e) -\u003e Option\u003cBackup\u003e {\n        BackupStorage::get_backup(\u0026env, \u0026backup_id)\n    }\n\n    /// Internal function to clear all invoice data\n    fn clear_all_invoices(env: \u0026Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        // Clear all status lists\n        for status in [\n            InvoiceStatus::Pending,\n            InvoiceStatus::Verified,\n            InvoiceStatus::Funded,\n            InvoiceStatus::Paid,\n            InvoiceStatus::Defaulted,\n            InvoiceStatus::Cancelled,\n        ]\n        .iter()\n        {\n            let invoices = InvoiceStorage::get_invoices_by_status(env, status);\n            for invoice_id in invoices.iter() {\n                // Remove from status list\n                InvoiceStorage::remove_from_status_invoices(env, status, \u0026invoice_id);\n                // Remove the invoice itself\n                env.storage().instance().remove(\u0026invoice_id);\n            }\n        }\n\n        // Clear all business invoices\n        let verified_businesses = BusinessVerificationStorage::get_verified_businesses(env);\n        for business in verified_businesses.iter() {\n            let _ = InvoiceStorage::get_business_invoices(env, \u0026business);\n            let key = (symbol_short!(\"business\"), business.clone());\n            env.storage().instance().remove(\u0026key);\n        }\n\n        Ok(())\n    }\n    /// Get audit trail for an invoice\n    pub fn get_invoice_audit_trail(env: Env, invoice_id: BytesN\u003c32\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        AuditStorage::get_invoice_audit_trail(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get audit entry by ID\n    pub fn get_audit_entry(\n        env: Env,\n        audit_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cAuditLogEntry, QuickLendXError\u003e {\n        AuditStorage::get_audit_entry(\u0026env, \u0026audit_id).ok_or(QuickLendXError::AuditLogNotFound)\n    }\n\n    /// Query audit logs with filters\n    pub fn query_audit_logs(env: Env, filter: AuditQueryFilter, limit: u32) -\u003e Vec\u003cAuditLogEntry\u003e {\n        let results = AuditStorage::query_audit_logs(\u0026env, \u0026filter, limit);\n        emit_audit_query(\n            \u0026env,\n            String::from_str(\u0026env, \"query_audit_logs\"),\n            results.len() as u32,\n        );\n        results\n    }\n\n    /// Get audit statistics\n    pub fn get_audit_stats(env: Env) -\u003e AuditStats {\n        AuditStorage::get_audit_stats(\u0026env)\n    }\n\n    /// Validate audit log integrity for an invoice\n    pub fn validate_invoice_audit_integrity(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let is_valid = AuditStorage::validate_invoice_audit_integrity(\u0026env, \u0026invoice_id)?;\n        emit_audit_validation(\u0026env, \u0026invoice_id, is_valid);\n        Ok(is_valid)\n    }\n\n    /// Get audit entries by operation type\n    pub fn get_audit_entries_by_operation(env: Env, operation: AuditOperation) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        AuditStorage::get_audit_entries_by_operation(\u0026env, \u0026operation)\n    }\n\n    /// Get audit entries by actor\n    pub fn get_audit_entries_by_actor(env: Env, actor: Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        AuditStorage::get_audit_entries_by_actor(\u0026env, \u0026actor)\n    }\n\n    // Category and Tag Management Functions\n\n    /// Get invoices by category\n    pub fn get_invoices_by_category(\n        env: Env,\n        category: invoice::InvoiceCategory,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_category(\u0026env, \u0026category)\n    }\n\n    /// Get invoices by category and status\n    pub fn get_invoices_by_cat_status(\n        env: Env,\n        category: invoice::InvoiceCategory,\n        status: InvoiceStatus,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_category_and_status(\u0026env, \u0026category, \u0026status)\n    }\n\n    /// Get invoices by tag\n    pub fn get_invoices_by_tag(env: Env, tag: String) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_tag(\u0026env, \u0026tag)\n    }\n\n    /// Get invoices by multiple tags (AND logic)\n    pub fn get_invoices_by_tags(env: Env, tags: Vec\u003cString\u003e) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        InvoiceStorage::get_invoices_by_tags(\u0026env, \u0026tags)\n    }\n\n    /// Get invoice count by category\n    pub fn get_invoice_count_by_category(env: Env, category: invoice::InvoiceCategory) -\u003e u32 {\n        InvoiceStorage::get_invoice_count_by_category(\u0026env, \u0026category)\n    }\n\n    /// Get invoice count by tag\n    pub fn get_invoice_count_by_tag(env: Env, tag: String) -\u003e u32 {\n        InvoiceStorage::get_invoice_count_by_tag(\u0026env, \u0026tag)\n    }\n\n    /// Get all available categories\n    pub fn get_all_categories(env: Env) -\u003e Vec\u003cinvoice::InvoiceCategory\u003e {\n        InvoiceStorage::get_all_categories(\u0026env)\n    }\n\n    /// Update invoice category (business owner only)\n    pub fn update_invoice_category(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        new_category: invoice::InvoiceCategory,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can update the category\n        invoice.business.require_auth();\n\n        let old_category = invoice.category.clone();\n        invoice.update_category(new_category.clone());\n\n        // Validate the new category\n        verification::validate_invoice_category(\u0026new_category)?;\n\n        // Update the invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        events::emit_invoice_category_updated(\n            \u0026env,\n            \u0026invoice_id,\n            \u0026invoice.business,\n            \u0026old_category,\n            \u0026new_category,\n        );\n\n        Ok(())\n    }\n\n    /// Add tag to invoice (business owner only)\n    pub fn add_invoice_tag(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        tag: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can add tags\n        invoice.business.require_auth();\n\n        // Add the tag\n        invoice.add_tag(\u0026env, tag.clone())?;\n\n        // Update the invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        events::emit_invoice_tag_added(\u0026env, \u0026invoice_id, \u0026invoice.business, \u0026tag);\n\n        Ok(())\n    }\n\n    /// Remove tag from invoice (business owner only)\n    pub fn remove_invoice_tag(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        tag: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n\n        // Only the business owner can remove tags\n        invoice.business.require_auth();\n\n        // Remove the tag\n        invoice.remove_tag(tag.clone())?;\n\n        // Update the invoice\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n\n        // Emit event\n        events::emit_invoice_tag_removed(\u0026env, \u0026invoice_id, \u0026invoice.business, \u0026tag);\n\n        Ok(())\n    }\n\n    /// Get all tags for an invoice\n    pub fn get_invoice_tags(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        Ok(invoice.get_tags())\n    }\n\n    /// Check if invoice has a specific tag\n    pub fn invoice_has_tag(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        tag: String,\n    ) -\u003e Result\u003cbool, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        Ok(invoice.has_tag(tag))\n    }\n\n    // Dispute Resolution Functions\n\n    /// Create a dispute for an invoice\n    pub fn create_dispute(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        creator: Address,\n        reason: String,\n        evidence: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_create_dispute(\u0026env, \u0026invoice_id, \u0026creator, reason, evidence)\n    }\n\n    /// Put a dispute under review (admin function)\n    pub fn put_dispute_under_review(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        reviewer: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_put_dispute_under_review(\u0026env, \u0026invoice_id, \u0026reviewer)\n    }\n\n    /// Resolve a dispute (admin function)\n    pub fn resolve_dispute(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n        resolver: Address,\n        resolution: String,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        do_resolve_dispute(\u0026env, \u0026invoice_id, \u0026resolver, resolution)\n    }\n\n    /// Get dispute details for an invoice\n    pub fn get_dispute_details(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cOption\u003cinvoice::Dispute\u003e, QuickLendXError\u003e {\n        do_get_dispute_details(\u0026env, \u0026invoice_id)\n    }\n\n    /// Get all invoices with disputes\n    pub fn get_invoices_with_disputes(env: Env) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        do_get_invoices_with_disputes(\u0026env)\n    }\n\n    /// Get invoices by dispute status\n    pub fn get_invoices_by_dispute_status(\n        env: Env,\n        dispute_status: DisputeStatus,\n    ) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        do_get_invoices_by_dispute_status(\u0026env, dispute_status)\n    }\n\n    /// Get dispute status for an invoice\n    pub fn get_invoice_dispute_status(\n        env: Env,\n        invoice_id: BytesN\u003c32\u003e,\n    ) -\u003e Result\u003cDisputeStatus, QuickLendXError\u003e {\n        let invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id)\n            .ok_or(QuickLendXError::InvoiceNotFound)?;\n        Ok(invoice.dispute_status)\n    }\n\n    // Analytics and Reporting Functions\n\n    /// Get current platform metrics\n    pub fn get_platform_metrics(env: Env) -\u003e Result\u003cPlatformMetrics, QuickLendXError\u003e {\n        AnalyticsCalculator::calculate_platform_metrics(\u0026env)\n    }\n\n    /// Update platform metrics (admin only)\n    pub fn update_platform_metrics(env: Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let metrics = AnalyticsCalculator::calculate_platform_metrics(\u0026env)?;\n        AnalyticsStorage::store_platform_metrics(\u0026env, \u0026metrics);\n\n        // Emit event\n        events::emit_platform_metrics_updated(\n            \u0026env,\n            metrics.total_invoices,\n            metrics.total_volume,\n            metrics.total_fees_collected,\n            metrics.success_rate,\n        );\n\n        Ok(())\n    }\n\n    /// Get performance metrics\n    pub fn get_performance_metrics(env: Env) -\u003e Result\u003cPerformanceMetrics, QuickLendXError\u003e {\n        AnalyticsCalculator::calculate_performance_metrics(\u0026env)\n    }\n\n    /// Update performance metrics (admin only)\n    pub fn update_performance_metrics(env: Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let metrics = AnalyticsCalculator::calculate_performance_metrics(\u0026env)?;\n        AnalyticsStorage::store_performance_metrics(\u0026env, \u0026metrics);\n\n        // Emit event\n        events::emit_performance_metrics_updated(\n            \u0026env,\n            metrics.average_settlement_time,\n            metrics.transaction_success_rate,\n            metrics.user_satisfaction_score,\n        );\n\n        Ok(())\n    }\n\n    /// Get user behavior metrics\n    pub fn get_user_behavior_metrics(\n        env: Env,\n        user: Address,\n    ) -\u003e Result\u003cUserBehaviorMetrics, QuickLendXError\u003e {\n        AnalyticsCalculator::calculate_user_behavior_metrics(\u0026env, \u0026user)\n    }\n\n    /// Update user behavior metrics\n    pub fn update_user_behavior_metrics(env: Env, user: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        user.require_auth();\n\n        let behavior = AnalyticsCalculator::calculate_user_behavior_metrics(\u0026env, \u0026user)?;\n        AnalyticsStorage::store_user_behavior(\u0026env, \u0026user, \u0026behavior);\n\n        // Emit event\n        events::emit_user_behavior_analyzed(\n            \u0026env,\n            \u0026user,\n            behavior.total_investments_made,\n            behavior.success_rate,\n            behavior.risk_score,\n        );\n\n        Ok(())\n    }\n\n    /// Get financial metrics for a specific period\n    pub fn get_financial_metrics(\n        env: Env,\n        period: TimePeriod,\n    ) -\u003e Result\u003cFinancialMetrics, QuickLendXError\u003e {\n        let metrics = AnalyticsCalculator::calculate_financial_metrics(\u0026env, period.clone())?;\n\n        // Emit event\n        events::emit_financial_metrics_calculated(\n            \u0026env,\n            \u0026period,\n            metrics.total_volume,\n            metrics.total_fees,\n            metrics.average_return_rate,\n        );\n\n        Ok(metrics)\n    }\n\n    /// Generate business report\n    pub fn generate_business_report(\n        env: Env,\n        business: Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cBusinessReport, QuickLendXError\u003e {\n        business.require_auth();\n\n        let report =\n            AnalyticsCalculator::generate_business_report(\u0026env, \u0026business, period.clone())?;\n        AnalyticsStorage::store_business_report(\u0026env, \u0026report);\n\n        // Emit event\n        events::emit_business_report_generated(\n            \u0026env,\n            \u0026report.report_id,\n            \u0026business,\n            \u0026period,\n            report.invoices_uploaded,\n            report.success_rate,\n        );\n\n        Ok(report)\n    }\n\n    /// Generate investor report\n    pub fn generate_investor_report(\n        env: Env,\n        investor: Address,\n        period: TimePeriod,\n    ) -\u003e Result\u003cInvestorReport, QuickLendXError\u003e {\n        investor.require_auth();\n\n        let report =\n            AnalyticsCalculator::generate_investor_report(\u0026env, \u0026investor, period.clone())?;\n        AnalyticsStorage::store_investor_report(\u0026env, \u0026report);\n\n        // Emit event\n        events::emit_investor_report_generated(\n            \u0026env,\n            \u0026report.report_id,\n            \u0026investor,\n            \u0026period,\n            report.investments_made,\n            report.average_return_rate,\n        );\n\n        Ok(report)\n    }\n\n    /// Get business report by ID\n    pub fn get_business_report(env: Env, report_id: BytesN\u003c32\u003e) -\u003e Option\u003cBusinessReport\u003e {\n        AnalyticsStorage::get_business_report(\u0026env, \u0026report_id)\n    }\n\n    /// Get investor report by ID\n    pub fn get_investor_report(env: Env, report_id: BytesN\u003c32\u003e) -\u003e Option\u003cInvestorReport\u003e {\n        AnalyticsStorage::get_investor_report(\u0026env, \u0026report_id)\n    }\n\n    /// Get analytics data summary\n    pub fn get_analytics_summary(\n        env: Env,\n    ) -\u003e Result\u003c(PlatformMetrics, PerformanceMetrics), QuickLendXError\u003e {\n        let platform_metrics = AnalyticsStorage::get_platform_metrics(\u0026env)\n            .unwrap_or_else(|| AnalyticsCalculator::calculate_platform_metrics(\u0026env).unwrap());\n\n        let performance_metrics = AnalyticsStorage::get_performance_metrics(\u0026env)\n            .unwrap_or_else(|| AnalyticsCalculator::calculate_performance_metrics(\u0026env).unwrap());\n\n        Ok((platform_metrics, performance_metrics))\n    }\n\n    /// Export analytics data (admin only)\n    pub fn export_analytics_data(\n        env: Env,\n        export_type: String,\n        filters: Vec\u003cString\u003e,\n    ) -\u003e Result\u003cString, QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        // Emit event\n        events::emit_analytics_export(\u0026env, \u0026export_type, \u0026admin, filters.len() as u32);\n\n        // Return a summary string\n        Ok(String::from_str(\u0026env, \"Analytics data exported\"))\n    }\n\n    /// Query analytics data with filters\n    pub fn query_analytics_data(\n        env: Env,\n        query_type: String,\n        filters: Vec\u003cString\u003e,\n        limit: u32,\n    ) -\u003e Result\u003cVec\u003cString\u003e, QuickLendXError\u003e {\n        // Emit event\n        events::emit_analytics_query(\u0026env, \u0026query_type, filters.len() as u32, limit);\n\n        // Return basic analytics data\n        let mut results = Vec::new(\u0026env);\n        results.push_back(String::from_str(\u0026env, \"Analytics query completed\"));\n\n        Ok(results)\n    }\n\n    /// Get analytics trends over time\n    pub fn get_analytics_trends(\n        env: Env,\n        period: TimePeriod,\n        _metric_type: String,\n    ) -\u003e Result\u003cVec\u003c(u64, i128)\u003e, QuickLendXError\u003e {\n        let mut trends = Vec::new(\u0026env);\n        let current_timestamp = env.ledger().timestamp();\n\n        // Generate sample trend data based on period\n        let (start_date, _) =\n            AnalyticsCalculator::get_period_dates(current_timestamp, period.clone());\n        let interval = match period {\n            TimePeriod::Daily =\u003e 24 * 60 * 60,          // 1 day\n            TimePeriod::Weekly =\u003e 7 * 24 * 60 * 60,     // 1 week\n            TimePeriod::Monthly =\u003e 30 * 24 * 60 * 60,   // 1 month\n            TimePeriod::Quarterly =\u003e 90 * 24 * 60 * 60, // 1 quarter\n            TimePeriod::Yearly =\u003e 365 * 24 * 60 * 60,   // 1 year\n            TimePeriod::AllTime =\u003e current_timestamp - start_date,\n        };\n\n        let mut timestamp = start_date;\n        while timestamp \u003c current_timestamp {\n            // Calculate metrics for this time period\n            let period_metrics =\n                AnalyticsCalculator::calculate_financial_metrics(\u0026env, period.clone())?;\n\n            let value = period_metrics.total_volume;\n\n            trends.push_back((timestamp, value));\n            timestamp = timestamp.saturating_add(interval);\n        }\n\n        Ok(trends)\n    }\n\n    // ========================================\n    // Enhanced Investor Analytics Functions\n    // ========================================\n\n    /// Calculate comprehensive investor analytics\n    pub fn calculate_investor_analytics(\n        env: Env,\n        investor: Address,\n    ) -\u003e Result\u003cInvestorAnalytics, QuickLendXError\u003e {\n        let analytics = AnalyticsCalculator::calculate_investor_analytics(\u0026env, \u0026investor)?;\n        AnalyticsStorage::store_investor_analytics(\u0026env, \u0026investor, \u0026analytics);\n        Ok(analytics)\n    }\n\n    /// Get stored investor analytics\n    pub fn get_investor_analytics_data(env: Env, investor: Address) -\u003e Option\u003cInvestorAnalytics\u003e {\n        AnalyticsStorage::get_investor_analytics(\u0026env, \u0026investor)\n    }\n\n    /// Calculate investor performance metrics for the platform\n    pub fn calc_investor_perf_metrics(\n        env: Env,\n    ) -\u003e Result\u003cInvestorPerformanceMetrics, QuickLendXError\u003e {\n        let metrics = AnalyticsCalculator::calc_investor_perf_metrics(\u0026env)?;\n        AnalyticsStorage::store_investor_performance(\u0026env, \u0026metrics);\n        Ok(metrics)\n    }\n\n    /// Get stored investor performance metrics\n    pub fn get_investor_performance_metrics(env: Env) -\u003e Option\u003cInvestorPerformanceMetrics\u003e {\n        AnalyticsStorage::get_investor_performance(\u0026env)\n    }\n\n    /// Update investor analytics (admin only)\n    pub fn update_investor_analytics_data(\n        env: Env,\n        investor: Address,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let analytics = AnalyticsCalculator::calculate_investor_analytics(\u0026env, \u0026investor)?;\n        AnalyticsStorage::store_investor_analytics(\u0026env, \u0026investor, \u0026analytics);\n\n        // Emit event\n        events::emit_investor_analytics_updated(\n            \u0026env,\n            \u0026investor,\n            analytics.success_rate,\n            analytics.risk_score,\n            analytics.compliance_score,\n        );\n\n        Ok(())\n    }\n\n    /// Update platform investor performance metrics (admin only)\n    pub fn update_investor_performance_data(env: Env) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let admin =\n            BusinessVerificationStorage::get_admin(\u0026env).ok_or(QuickLendXError::NotAdmin)?;\n        admin.require_auth();\n\n        let metrics = AnalyticsCalculator::calc_investor_perf_metrics(\u0026env)?;\n        AnalyticsStorage::store_investor_performance(\u0026env, \u0026metrics);\n\n        // Emit event\n        events::emit_investor_performance_updated(\n            \u0026env,\n            metrics.total_investors,\n            metrics.verified_investors,\n            metrics.platform_success_rate,\n            metrics.average_risk_score,\n        );\n\n        Ok(())\n    }\n    // ========================================\n    // Fee and Revenue Management Functions\n    // ========================================\n\n    /// Initialize fee management system\n    pub fn initialize_fee_system(env: Env, admin: Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n        fees::FeeManager::initialize(\u0026env, \u0026admin)\n    }\n\n    /// Update fee structure for a specific fee type\n    pub fn update_fee_structure(\n        env: Env,\n        admin: Address,\n        fee_type: fees::FeeType,\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n        is_active: bool,\n    ) -\u003e Result\u003cfees::FeeStructure, QuickLendXError\u003e {\n        fees::FeeManager::update_fee_structure(\n            \u0026env,\n            \u0026admin,\n            fee_type,\n            base_fee_bps,\n            min_fee,\n            max_fee,\n            is_active,\n        )\n    }\n\n    /// Get fee structure for a fee type\n    pub fn get_fee_structure(\n        env: Env,\n        fee_type: fees::FeeType,\n    ) -\u003e Result\u003cfees::FeeStructure, QuickLendXError\u003e {\n        fees::FeeManager::get_fee_structure(\u0026env, \u0026fee_type)\n    }\n\n    /// Calculate total fees for a transaction\n    pub fn calculate_transaction_fees(\n        env: Env,\n        user: Address,\n        transaction_amount: i128,\n        is_early_payment: bool,\n        is_late_payment: bool,\n    ) -\u003e Result\u003ci128, QuickLendXError\u003e {\n        fees::FeeManager::calculate_total_fees(\n            \u0026env,\n            \u0026user,\n            transaction_amount,\n            is_early_payment,\n            is_late_payment,\n        )\n    }\n\n    /// Get user volume data and tier\n    pub fn get_user_volume_data(env: Env, user: Address) -\u003e fees::UserVolumeData {\n        fees::FeeManager::get_user_volume(\u0026env, \u0026user)\n    }\n\n    /// Update user volume (called internally after transactions)\n    pub fn update_user_transaction_volume(\n        env: Env,\n        user: Address,\n        transaction_amount: i128,\n    ) -\u003e Result\u003cfees::UserVolumeData, QuickLendXError\u003e {\n        fees::FeeManager::update_user_volume(\u0026env, \u0026user, transaction_amount)\n    }\n\n    /// Configure revenue distribution\n    pub fn configure_revenue_distribution(\n        env: Env,\n        admin: Address,\n        treasury_address: Address,\n        treasury_share_bps: u32,\n        developer_share_bps: u32,\n        platform_share_bps: u32,\n        auto_distribution: bool,\n        min_distribution_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let config = fees::RevenueConfig {\n            treasury_address,\n            treasury_share_bps,\n            developer_share_bps,\n            platform_share_bps,\n            auto_distribution,\n            min_distribution_amount,\n        };\n        fees::FeeManager::configure_revenue_distribution(\u0026env, \u0026admin, config)\n    }\n\n    /// Distribute revenue for a period\n    pub fn distribute_revenue(\n        env: Env,\n        admin: Address,\n        period: u64,\n    ) -\u003e Result\u003c(i128, i128, i128), QuickLendXError\u003e {\n        fees::FeeManager::distribute_revenue(\u0026env, \u0026admin, period)\n    }\n\n    /// Get fee analytics for a period\n    pub fn get_fee_analytics(env: Env, period: u64) -\u003e Result\u003cfees::FeeAnalytics, QuickLendXError\u003e {\n        fees::FeeManager::get_analytics(\u0026env, period)\n    }\n\n    /// Collect fees (internal function called after fee calculation)\n    pub fn collect_transaction_fees(\n        env: Env,\n        user: Address,\n        fees_by_type: Map\u003cfees::FeeType, i128\u003e,\n        total_amount: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        fees::FeeManager::collect_fees(\u0026env, \u0026user, fees_by_type, total_amount)\n    }\n\n    /// Validate fee parameters\n    pub fn validate_fee_parameters(\n        _env: Env,\n        base_fee_bps: u32,\n        min_fee: i128,\n        max_fee: i128,\n    ) -\u003e Result\u003c(), QuickLendXError\u003e {\n        fees::FeeManager::validate_fee_params(base_fee_bps, min_fee, max_fee)\n    }\n}\n\n#[cfg(test)]\nmod test;\n\n#[cfg(test)]\nmod test_bid;\n\n#[cfg(test)]\nmod test_escrow;\n\n#[cfg(test)]\nmod test_partial_payments;\n","traces":[{"line":72,"address":[19930152],"length":1,"stats":{"Line":0}},{"line":74,"address":[16290915,16288560,16291292],"length":1,"stats":{"Line":1}},{"line":85,"address":[19931824],"length":1,"stats":{"Line":2}},{"line":86,"address":[31458402,31458221,31458205,31455603],"length":1,"stats":{"Line":1}},{"line":89,"address":[16288775,16288843],"length":1,"stats":{"Line":3}},{"line":90,"address":[16288953],"length":1,"stats":{"Line":2}},{"line":91,"address":[20587859],"length":1,"stats":{"Line":1}},{"line":94,"address":[42428212],"length":1,"stats":{"Line":4}},{"line":95,"address":[16289030],"length":1,"stats":{"Line":1}},{"line":104,"address":[16290998,16289014,16289049],"length":1,"stats":{"Line":2}},{"line":105,"address":[42436336],"length":1,"stats":{"Line":2}},{"line":109,"address":[41613825,41612724,41613047,41612567,41612484,41614038],"length":1,"stats":{"Line":1}},{"line":110,"address":[41612731,41613055,41614109,41613854,41612535,41612615],"length":1,"stats":{"Line":3}},{"line":111,"address":[41613063,41613883,41612655,41614177,41612738,41612583],"length":1,"stats":{"Line":0}},{"line":112,"address":[16289286],"length":1,"stats":{"Line":2}},{"line":113,"address":[31460743],"length":1,"stats":{"Line":0}},{"line":114,"address":[31460816],"length":1,"stats":{"Line":2}},{"line":115,"address":[31460771],"length":1,"stats":{"Line":0}},{"line":116,"address":[16289413],"length":1,"stats":{"Line":2}},{"line":120,"address":[31430635],"length":1,"stats":{"Line":1}},{"line":123,"address":[16290027,16289617],"length":1,"stats":{"Line":3}},{"line":124,"address":[42437043,42436994],"length":1,"stats":{"Line":3}},{"line":125,"address":[16289677,16289773],"length":1,"stats":{"Line":4}},{"line":128,"address":[42437056],"length":1,"stats":{"Line":3}},{"line":132,"address":[31461796,31461965,31462362],"length":1,"stats":{"Line":0}},{"line":143,"address":[16296300],"length":1,"stats":{"Line":0}},{"line":146,"address":[31460306],"length":1,"stats":{"Line":0}},{"line":147,"address":[16296433,16296486],"length":1,"stats":{"Line":0}},{"line":148,"address":[42366488],"length":1,"stats":{"Line":0}},{"line":149,"address":[32298470,32325996],"length":1,"stats":{"Line":0}},{"line":150,"address":[32326064,32298553],"length":1,"stats":{"Line":0}},{"line":153,"address":[25530288],"length":1,"stats":{"Line":0}},{"line":157,"address":[16296670,16298504],"length":1,"stats":{"Line":0}},{"line":160,"address":[32299383,32326593],"length":1,"stats":{"Line":3}},{"line":161,"address":[45220922,45247644],"length":1,"stats":{"Line":0}},{"line":165,"address":[45221254,45247916],"length":1,"stats":{"Line":1}},{"line":166,"address":[27182222,27182158,27182094,27182126],"length":1,"stats":{"Line":2}},{"line":167,"address":[20583138,20581370,20572562,20570802,20576074,20577842,20579608,20574324],"length":1,"stats":{"Line":2}},{"line":168,"address":[16297042,16297098],"length":1,"stats":{"Line":0}},{"line":169,"address":[27007286,27008976,27008565,27004263,27004960,26990279,27006567,27008199,27007632,26987331,27006912,27006592,27006016,26998579,26995152,26991760,27009328,26985792,27008224,27002499,27005664,27008592,27000592,27005300,27007312,27006004,27009669,26988880,27009316,27008950,27005312,26993456,27005652,26996739,27007648,27006928],"length":1,"stats":{"Line":1}},{"line":170,"address":[27005341,27007339,27009005,27008256,27009360,27006083,27005693,27006963,27004989,27006619,27007715,27008627],"length":1,"stats":{"Line":1}},{"line":171,"address":[27182053,27182181,27181989,27182021],"length":1,"stats":{"Line":0}},{"line":172,"address":[27182064,27182000,27182192,27182032],"length":1,"stats":{"Line":0}},{"line":174,"address":[31460909],"length":1,"stats":{"Line":1}},{"line":175,"address":[32327613,32300628],"length":1,"stats":{"Line":0}},{"line":178,"address":[42428343,42428497,42428285],"length":1,"stats":{"Line":0}},{"line":180,"address":[16297445],"length":1,"stats":{"Line":0}},{"line":184,"address":[32301481,32328105],"length":1,"stats":{"Line":7}},{"line":185,"address":[45249149,45223054],"length":1,"stats":{"Line":4}},{"line":187,"address":[33509520,33508672,33508704,33509560,33509792,33508016,33508021,33509812],"length":1,"stats":{"Line":2}},{"line":189,"address":[20583900,20578575,20575083,20571532,20582097,20583822,20576801,20571561,20583871,20575054,20580367,20575006,20582126,20573321,20573244,20578526,20576753,20578604,20580338,20576830,20573292,20580290,20571484,20582049],"length":1,"stats":{"Line":4}},{"line":190,"address":[42773413,42773573,42772581,42773454,42772957,42772862,42772798,42773502,42772926,42773013,42772629,42773317,42773205,42773157,42772533,42772669,42773246,42773358,42772718,42773109,42773054],"length":1,"stats":{"Line":3}},{"line":192,"address":[31437104],"length":1,"stats":{"Line":6}},{"line":193,"address":[17147437],"length":1,"stats":{"Line":0}},{"line":198,"address":[16299382],"length":1,"stats":{"Line":3}},{"line":200,"address":[45571808],"length":1,"stats":{"Line":3}},{"line":201,"address":[31461673],"length":1,"stats":{"Line":3}},{"line":205,"address":[31459760],"length":1,"stats":{"Line":3}},{"line":207,"address":[20575246,20578767,20571724,20575273,20580530,20582289,20577020,20576993,20578794,20571751,20573484,20584063,20573511,20584090,20580557,20582316],"length":1,"stats":{"Line":3}},{"line":210,"address":[33526848,33525573,33526935,33526647,33526762,33525568,33526705,33526248,33526624,33526387,33526299,33526224,33526872],"length":1,"stats":{"Line":3}},{"line":213,"address":[16299541],"length":1,"stats":{"Line":3}},{"line":214,"address":[26493705],"length":1,"stats":{"Line":0}},{"line":217,"address":[16299577],"length":1,"stats":{"Line":3}},{"line":221,"address":[16292304,16293054,16293025],"length":1,"stats":{"Line":0}},{"line":222,"address":[26493212,26493243],"length":1,"stats":{"Line":1}},{"line":223,"address":[26493238],"length":1,"stats":{"Line":0}},{"line":226,"address":[33527840],"length":1,"stats":{"Line":0}},{"line":229,"address":[16292645],"length":1,"stats":{"Line":0}},{"line":232,"address":[16292660,16292993],"length":1,"stats":{"Line":2}},{"line":235,"address":[45550038,45546374],"length":1,"stats":{"Line":0}},{"line":238,"address":[20587779,20587811],"length":1,"stats":{"Line":3}},{"line":241,"address":[45546871,45543166],"length":1,"stats":{"Line":0}},{"line":245,"address":[33525897],"length":1,"stats":{"Line":1}},{"line":246,"address":[31458035],"length":1,"stats":{"Line":0}},{"line":247,"address":[27235027,27234990,27182446,27261379,27208302,27261342,27182483,27208339],"length":1,"stats":{"Line":4}},{"line":248,"address":[41983918],"length":1,"stats":{"Line":3}},{"line":251,"address":[33501600,33501589,33507946,33502032,33502037,33501619,33507936,33501584],"length":1,"stats":{"Line":1}},{"line":255,"address":[45542754,45546498],"length":1,"stats":{"Line":1}},{"line":256,"address":[42267488],"length":1,"stats":{"Line":5}},{"line":260,"address":[42241920],"length":1,"stats":{"Line":48}},{"line":261,"address":[27191314,27266740,27187558,27188311,27244281,27266493,27190815,27270683,27215857,27240962,27268957,27187809,27270436,27187307,27187059,27189811,27191816,27270189,27269698,27239744,27271174,27266987,27242239,27216901,27216118,27192566,27218983,27241215,27271421,27267725,27214555,27218203,27266002,27189312,27241727,27189061,27215338,27214297,27243260,27213775,27268219,27266246,27215077,27218722,27192315,27267478,27266061,27190313,27188559,27242492,27244025,27189563,27216640,27267234,27190062,27246091,27192817,27213514,27188810,27192067,27218461,27245046,27242748,27217681,27245814,27214816,27243004,27244793,27217942,27190564,27213253,27191565,27245302,27241983,27191063,27240706,27243769,27240194,27268466,27245558,27269451,27271915,27212995,27241471,27268710,27188060,27267972,27269204,27187118,27213054,27240450,27217159,27193068,27216379,27219244,27193343,27239938,27271668,27219526,27269942,27270930,27243516,27239685,27214036,27217420,27215599,27244537,27272187],"length":1,"stats":{"Line":30}},{"line":265,"address":[20586350,20584754],"length":1,"stats":{"Line":2}},{"line":266,"address":[27246019,27272117,27219454,27193273],"length":1,"stats":{"Line":5}},{"line":270,"address":[16326880,16326240,16327215],"length":1,"stats":{"Line":35}},{"line":275,"address":[45549674,45546008,45543878,45547577],"length":1,"stats":{"Line":15}},{"line":276,"address":[16326417,16326359],"length":1,"stats":{"Line":0}},{"line":278,"address":[27259697,27203513,27253848,27206678,27280626,27284331,27258078,27227364,27254797,27285230,27207267,27256416,27229028,27233927,27233372,27206715,27231720,27205074,27259654,27260300,27285267,27282175,27258035,27280583,27203470,27279684,27279077,27253178,27231677,27233335,27282132,27205735,27200262,27279034,27255467,27254840,27258705,27282782,27204131,27283724,27205117,27226685,27230692,27201866,27200923,27230056,27283681,27226728,27228349,27281233,27230013,27232356,27253221,27256459,27200305,27201909,27228392,27257086,27202527,27285808],"length":1,"stats":{"Line":15}},{"line":279,"address":[16327148,16326580],"length":1,"stats":{"Line":0}},{"line":281,"address":[27010156,27010051,27010364,27010262,27009878,27009786],"length":1,"stats":{"Line":0}},{"line":282,"address":[27207862,27232434,27286358,27258984,27279760,27206011,27233813,27281687,27257566,27207510,27285710,27255746,27232854,27202403,27233996,27234545,27206411,27255947,27233064,27255344,27234362,27229316,27258582,27284407,27256963,27207686,27229736,27232224,27260546,27254328,27253926,27231190,27283047,27227232,27283236,27200999,27257164,27227652,27207158,27260369,27282669,27204607,27204207,27258783,27204007,27227442,27279571,27286196,27257767,27230560,27201599,27280327,27207334,27232644,27283425,27281876,27253725,27203003,27254127,27284218,27284974,27229106,27202803,27228896,27204807,27286034,27204407,27255545,27259386,27231400,27260192,27234179,27285872,27281120,27201399,27205811,27284596,27200799,27281309,27205611,27201199,27227862,27279949,27230980,27203203,27280138,27281498,27228072,27284785,27256148,27260723,27206211,27282858,27260900,27202603,27230770,27229526,27259185,27254529,27257365],"length":1,"stats":{"Line":38}},{"line":285,"address":[45549576,45545911],"length":1,"stats":{"Line":0}},{"line":286,"address":[16326951],"length":1,"stats":{"Line":0}},{"line":287,"address":[16326968],"length":1,"stats":{"Line":0}},{"line":289,"address":[27208043,27286528,27234733,27261080],"length":1,"stats":{"Line":1}},{"line":290,"address":[45549636,45545971],"length":1,"stats":{"Line":0}},{"line":294,"address":[42284146],"length":1,"stats":{"Line":0}},{"line":295,"address":[42755920],"length":1,"stats":{"Line":0}},{"line":296,"address":[42284200],"length":1,"stats":{"Line":0}},{"line":298,"address":[16321795],"length":1,"stats":{"Line":0}},{"line":300,"address":[16321864],"length":1,"stats":{"Line":0}},{"line":301,"address":[42284343],"length":1,"stats":{"Line":0}},{"line":302,"address":[20587349,20585753],"length":1,"stats":{"Line":0}},{"line":303,"address":[27011517,27012160,27010848,27010864,27011832,27011856,27012176,27011200,27011173,27012485,27011536,27010384],"length":1,"stats":{"Line":0}},{"line":304,"address":[45544148,45547841],"length":1,"stats":{"Line":0}},{"line":307,"address":[45544266,45547958],"length":1,"stats":{"Line":0}},{"line":311,"address":[44023635],"length":1,"stats":{"Line":0}},{"line":312,"address":[16332213],"length":1,"stats":{"Line":0}},{"line":316,"address":[20585995,20587591],"length":1,"stats":{"Line":0}},{"line":317,"address":[42753433,42757301,42752621,42756741,42755707,42757819,42754347,42754793,42753892,42752205,42758283,42755252],"length":1,"stats":{"Line":0}},{"line":321,"address":[31363329],"length":1,"stats":{"Line":0}},{"line":322,"address":[31363528],"length":1,"stats":{"Line":0}},{"line":326,"address":[31363651],"length":1,"stats":{"Line":1}},{"line":327,"address":[45544543,45548229],"length":1,"stats":{"Line":0}},{"line":331,"address":[42285831],"length":1,"stats":{"Line":0}},{"line":336,"address":[42427984],"length":1,"stats":{"Line":0}},{"line":337,"address":[45228416,45251532],"length":1,"stats":{"Line":0}},{"line":340,"address":[16320027],"length":1,"stats":{"Line":0}},{"line":343,"address":[45228633,45251633],"length":1,"stats":{"Line":1}},{"line":344,"address":[45251673,45228716],"length":1,"stats":{"Line":0}},{"line":345,"address":[45251713,45228799],"length":1,"stats":{"Line":0}},{"line":346,"address":[45228882,45251753],"length":1,"stats":{"Line":1}},{"line":348,"address":[31391534],"length":1,"stats":{"Line":3}},{"line":349,"address":[32330658,32307196],"length":1,"stats":{"Line":0}},{"line":351,"address":[31391581],"length":1,"stats":{"Line":0}},{"line":352,"address":[31363854],"length":1,"stats":{"Line":2}},{"line":353,"address":[27015008,27015311,27015184,27013664,27014112,27014400,27014256,27014848,27014128,27013504,27014537,27013824,27014416,27013958,27015024,27014681,27014831,27015158,27014560,27013984,27014704,27014272,27013808,27013680],"length":1,"stats":{"Line":0}},{"line":354,"address":[31427852,31428198,31429051,31427766,31429089,31428347,31428262,31428409,31429157,31428105,31428854,31429017,31428502,31428716],"length":1,"stats":{"Line":0}},{"line":355,"address":[42753185,42753009],"length":1,"stats":{"Line":2}},{"line":358,"address":[27014826,27015306,27014251,27013953,27013659,27014532,27015153,27013803,27014107,27014395,27015003,27014676],"length":1,"stats":{"Line":0}},{"line":362,"address":[31428000,31428576,31427680,31427888,31428912,31427952],"length":1,"stats":{"Line":1}},{"line":365,"address":[31428957,31428636,31427721,31428045,31427933,31427990],"length":1,"stats":{"Line":2}},{"line":368,"address":[32308060,32331180],"length":1,"stats":{"Line":0}},{"line":369,"address":[41845920,41845840,41846000,41846240,41846160,41846080],"length":1,"stats":{"Line":3}},{"line":370,"address":[31360577],"length":1,"stats":{"Line":3}},{"line":374,"address":[32331588,32308558],"length":1,"stats":{"Line":0}},{"line":375,"address":[31360720],"length":1,"stats":{"Line":1}},{"line":376,"address":[31429025,31429071],"length":1,"stats":{"Line":1}},{"line":378,"address":[32308890,32331860],"length":1,"stats":{"Line":2}},{"line":379,"address":[45549259,45545593],"length":1,"stats":{"Line":1}},{"line":381,"address":[45231074,45253475],"length":1,"stats":{"Line":3}},{"line":382,"address":[45231157,45253543],"length":1,"stats":{"Line":3}},{"line":384,"address":[17149453],"length":1,"stats":{"Line":4}},{"line":387,"address":[32309637,32332472],"length":1,"stats":{"Line":0}},{"line":391,"address":[45231904,45254155],"length":1,"stats":{"Line":0}},{"line":392,"address":[16336636],"length":1,"stats":{"Line":0}},{"line":393,"address":[16336680],"length":1,"stats":{"Line":1}},{"line":397,"address":[16324880,16324288],"length":1,"stats":{"Line":1}},{"line":398,"address":[32333220,32310550],"length":1,"stats":{"Line":2}},{"line":399,"address":[32310633,32333288],"length":1,"stats":{"Line":0}},{"line":400,"address":[31404000],"length":1,"stats":{"Line":0}},{"line":401,"address":[45254835,45232734],"length":1,"stats":{"Line":0}},{"line":402,"address":[41851907,41848627,41847971,41849283,41855632,41855792,41849939,41847315,41854832,41851251,41855472,41852563,41854192,41854672,41854992,41855952,41855312,41850595,41854352,41853219,41855152,41854512,41846659,41853875],"length":1,"stats":{"Line":2}},{"line":403,"address":[42744192],"length":1,"stats":{"Line":2}},{"line":405,"address":[32333696,32311131],"length":1,"stats":{"Line":2}},{"line":409,"address":[42744273],"length":1,"stats":{"Line":0}},{"line":410,"address":[32334036,32311546],"length":1,"stats":{"Line":0}},{"line":414,"address":[16284575,16284448],"length":1,"stats":{"Line":0}},{"line":415,"address":[45255787,45233896],"length":1,"stats":{"Line":1}},{"line":419,"address":[32334648,32312293],"length":1,"stats":{"Line":1}},{"line":420,"address":[32334716,32312376],"length":1,"stats":{"Line":2}},{"line":424,"address":[32334988,32312708],"length":1,"stats":{"Line":0}},{"line":425,"address":[32312791,32335056],"length":1,"stats":{"Line":2}},{"line":429,"address":[41881942,41884491,41879670,41890171,41891307,41878811,41880806,41889035,41891030,41886763,41886486,41883355,41882219,41879947,41878534,41888758,41887899,41881083,41885350,41885627,41889894,41884214,41887622,41883078],"length":1,"stats":{"Line":1}},{"line":430,"address":[45234726,45256467],"length":1,"stats":{"Line":0}},{"line":436,"address":[32335464,32313289],"length":1,"stats":{"Line":0}},{"line":437,"address":[32335532,32313372],"length":1,"stats":{"Line":1}},{"line":441,"address":[45257215,45235639],"length":1,"stats":{"Line":2}},{"line":442,"address":[16313341],"length":1,"stats":{"Line":1}},{"line":452,"address":[45258182,45236976],"length":1,"stats":{"Line":1}},{"line":460,"address":[45258502,45237640],"length":1,"stats":{"Line":1}},{"line":463,"address":[45258622,45237889],"length":1,"stats":{"Line":1}},{"line":464,"address":[16346918],"length":1,"stats":{"Line":0}},{"line":468,"address":[16346903,16348938,16346977,16347034],"length":1,"stats":{"Line":2}},{"line":469,"address":[31477231],"length":1,"stats":{"Line":1}},{"line":470,"address":[27027587,27017555,27024915,27021923,27035781,27044563],"length":1,"stats":{"Line":2}},{"line":471,"address":[31477415],"length":1,"stats":{"Line":0}},{"line":474,"address":[16348920,16347289,16347215,16347346],"length":1,"stats":{"Line":2}},{"line":475,"address":[42267810,42268226,42269474,42269890,42269058,42268642],"length":1,"stats":{"Line":2}},{"line":476,"address":[16347433],"length":1,"stats":{"Line":1}},{"line":477,"address":[33518590],"length":1,"stats":{"Line":0}},{"line":478,"address":[16347506],"length":1,"stats":{"Line":1}},{"line":479,"address":[27046960,27019744,27027056,27029984,27040272,27024320],"length":1,"stats":{"Line":0}},{"line":482,"address":[16347478],"length":1,"stats":{"Line":3}},{"line":483,"address":[42105742,42105710,42105774,42105806,42105838,42105678],"length":1,"stats":{"Line":3}},{"line":484,"address":[16347540],"length":1,"stats":{"Line":0}},{"line":488,"address":[41876916,41876148,41877108,41876340,41876532,41877300,41875572,41875764,41875380,41875956,41876724,41877492],"length":1,"stats":{"Line":2}},{"line":489,"address":[41877601,41876257,41875873,41877217,41877025,41875681,41876449,41875489,41876641,41876065,41877409,41876833],"length":1,"stats":{"Line":4}},{"line":491,"address":[16347820],"length":1,"stats":{"Line":3}},{"line":492,"address":[16347896,16347848],"length":1,"stats":{"Line":6}},{"line":494,"address":[41983083,41983429,41982277,41982923,41983605,41982603,41982763,41981765,41982107,41981941,41983253,41982443],"length":1,"stats":{"Line":4}},{"line":495,"address":[27045630,27028654,27037573,27018554,27025882,27023006],"length":1,"stats":{"Line":2}},{"line":496,"address":[16348101],"length":1,"stats":{"Line":1}},{"line":501,"address":[16348154],"length":1,"stats":{"Line":2}},{"line":503,"address":[16348462],"length":1,"stats":{"Line":3}},{"line":505,"address":[31468078],"length":1,"stats":{"Line":2}},{"line":508,"address":[16348547],"length":1,"stats":{"Line":2}},{"line":511,"address":[16348575],"length":1,"stats":{"Line":3}},{"line":513,"address":[16348590],"length":1,"stats":{"Line":1}},{"line":517,"address":[42741963],"length":1,"stats":{"Line":1}},{"line":522,"address":[42742160],"length":1,"stats":{"Line":5}},{"line":523,"address":[27026158,27023498,27029226,27038340,27019075,27026311,27045943,27029144,27046120,27026387,27038773,27018998,27028967,27018840,27023321,27046202,27038945,27023580],"length":1,"stats":{"Line":9}},{"line":524,"address":[33510286],"length":1,"stats":{"Line":6}},{"line":525,"address":[27029208,27046207,27023585,27029231,27019062,27038868,27023526,27046148,27038950,27023564,27046184,27019024,27026374,27026392,27019080,27038817,27029172,27026337],"length":1,"stats":{"Line":6}},{"line":526,"address":[31436212,31434038,31435254,31434453,31433646,31434862,31432832,31436836,31433248,31435669],"length":1,"stats":{"Line":3}},{"line":527,"address":[27018943,27046059,27018893,27038629,27026281,27038679,27029083,27018968,27046004,27026211,27026257,27046085,27023380,27023465,27029109,27029028,27038498,27023439],"length":1,"stats":{"Line":6}},{"line":528,"address":[27038778,27038645,27029149,27038696,27023503,27029088,27018947,27029126,27026298,27026261,27018985,27046102,27026316,27046064,27023482,27023444,27046125,27019003],"length":1,"stats":{"Line":5}},{"line":531,"address":[33509936],"length":1,"stats":{"Line":1}},{"line":533,"address":[31434296,31435116,31433503,31433900,31432696,31433112,31435957,31435512,31436581,31434719],"length":1,"stats":{"Line":3}},{"line":534,"address":[31435526,31433517,31435993,31432709,31434310,31436617,31434733,31435126,31433125,31433910],"length":1,"stats":{"Line":0}},{"line":539,"address":[33510095],"length":1,"stats":{"Line":1}},{"line":540,"address":[42195384,42185490,42120370,42167587,42169552,42151856,42181464,42126352,42163688,42177624,42157760,42136082,42128280,42140040,42155808,42205059,42189395,42147939,42134104,42165600,42201112,42141987,42179536,42145952,42193426,42149904,42138099,42187448,42161730,42183442,42199224,42132146,42173618,42116392,42118339,42191395,42112403,42124400,42171570,42143987,42122418,42203059,42159712,42153843,42197296,42175666,42114434,42130168],"length":1,"stats":{"Line":0}},{"line":541,"address":[16281983],"length":1,"stats":{"Line":1}},{"line":542,"address":[42122562,42171714,42159856,42146235,42197440,42183586,42193570,42181734,42191708,42132472,42169835,42148083,42128550,42185816,42167731,42122744,42114760,42136408,42120696,42187592,42124683,42175992,42205203,42161874,42132290,42138243,42154156,42162056,42191539,42175810,42124544,42155952,42120514,42165744,42203372,42116662,42112547,42203203,42163958,42183768,42187718,42159995,42173944,42179680,42116536,42201256,42130312,42114578,42199494,42171896,42195654,42142300,42165883,42167900,42197579,42128424,42193752,42185634,42118652,42134374,42140310,42156091,42189539,42173762,42126496,42150187,42158043,42205372,42150048,42163832,42152000,42144131,42118483,42126635,42134248,42130438,42112716,42153987,42142131,42177894,42169696,42152139,42146096,42136226,42189708,42138412,42144300,42177768,42181608,42157904,42201382,42179819,42140184,42199368,42195528,42148252],"length":1,"stats":{"Line":2}},{"line":543,"address":[33510131],"length":1,"stats":{"Line":1}},{"line":544,"address":[16282015],"length":1,"stats":{"Line":2}},{"line":547,"address":[16282245],"length":1,"stats":{"Line":1}},{"line":548,"address":[42121220,42146802,42123268,42164482,42140920,42174468,42188242,42123305,42136932,42182258,42156658,42131048,42180435,42168430,42154686,42113283,42137018,42196178,42158659,42180386,42125299,42184378,42200104,42117272,42142916,42164568,42186340,42162580,42198109,42178455,42166499,42176516,42146851,42156707,42148782,42113246,42168467,42119219,42200018,42140871,42192324,42168516,42162617,42117186,42127165,42182295,42158610,42162666,42121306,42146765,42190275,42148819,42127251,42182344,42129111,42188279,42133082,42139028,42186426,42129074,42203988,42188328,42201992,42203939,42134984,42132996,42150717,42150754,42152669,42201906,42178504,42176553,42170451,42130999,42134935,42194276,42180349,42115284,42205902,42115370,42138979,42130962,42136969,42123354,42190238,42160611,42121257,42115321,42117223,42176602,42160525,42198146,42196264,42166413,42138942,42198195,42152755,42190324,42174554,42194362,42172420,42174505,42129160,42166450,42178418,42154723,42119182,42119268,42156621,42133033,42172457,42170402,42144916,42192275,42148868,42158573,42194313,42184329,42164519,42186377,42150803,42203902,42127202,42113332,42140834,42184292,42125213,42154772,42142830,42125250,42196215,42205939,42144830,42201943,42152706,42142867,42170365,42160562,42200055,42205988,42172506,42144867,42192238,42134898],"length":1,"stats":{"Line":2}},{"line":550,"address":[42166605,42182450,42168622,42129266,42206094,42152861,42196370,42156813,42119374,42190430,42139134,42204094,42200210,42123460,42133188,42115476,42154878,42192430,42172612,42178610,42188434,42121412,42184484,42202098,42176708,42135090,42180541,42170557,42150909,42125405,42127357,42174660,42186532,42143022,42162772,42158765,42141026,42148974,42137124,42164674,42160717,42194468,42145022,42113438,42131154,42117378,42198301,42146957],"length":1,"stats":{"Line":2}},{"line":551,"address":[27019173,27029334,27026485,27023686,27039127,27046310],"length":1,"stats":{"Line":0}},{"line":552,"address":[42151020,42119485,42172720,42121520,42204205,42174768,42166716,42182558,42194576,42162880,42147068,42196478,42168733,42176816,42170668,42137232,42141134,42188542,42156924,42202206,42117486,42139245,42143133,42190541,42125516,42145133,42135198,42158876,42123568,42113549,42149085,42164782,42178718,42127468,42206205,42131262,42160828,42198412,42186640,42133296,42200318,42180652,42115584,42129374,42154989,42192541,42184592,42152972],"length":1,"stats":{"Line":1}},{"line":553,"address":[16282351],"length":1,"stats":{"Line":2}},{"line":554,"address":[16282436,16282385],"length":1,"stats":{"Line":2}},{"line":556,"address":[33510197],"length":1,"stats":{"Line":1}},{"line":558,"address":[42195161,42118051,42167306,42187225,42175353,42133881,42181242,42128058,42116169,42179283,42131827,42145703,42163465,42173305,42139815,42114119,42147658,42157514,42189107,42206775,42129939,42122105,42183123,42120055,42153562,42143703,42151610,42185177,42161418,42199002,42165347,42171258,42200883,42159466,42135763,42155559,42193111,42141699,42149655,42204775,42177401,42137817,42126106,42169303,42124153,42197043,42202771,42191111],"length":1,"stats":{"Line":1}},{"line":560,"address":[31473079],"length":1,"stats":{"Line":4}},{"line":561,"address":[16282699],"length":1,"stats":{"Line":3}},{"line":562,"address":[16282767],"length":1,"stats":{"Line":3}},{"line":563,"address":[16282839],"length":1,"stats":{"Line":4}},{"line":564,"address":[31439686],"length":1,"stats":{"Line":6}},{"line":566,"address":[42003009,41999121,42001713,42003441,42003873,42000849,42001281,42000417,41999553,42002145,42002577,41999985],"length":1,"stats":{"Line":4}},{"line":568,"address":[42002971,42000738,42000379,42000306,42001602,42002898,41999609,42001675,42001170,42000473,42003835,42001243,42004194,42000905,42002539,42002107,42002633,42003762,42001769,42000811,42004267,42003929,42001337,42000041,41999947,41999177,41999874,41999442,42002466,42003065,42003403,42003497,42002201,42003330,41999515,42002034],"length":1,"stats":{"Line":2}},{"line":570,"address":[16283357],"length":1,"stats":{"Line":5}},{"line":572,"address":[16283422],"length":1,"stats":{"Line":3}},{"line":575,"address":[33510366],"length":1,"stats":{"Line":3}},{"line":579,"address":[33510378],"length":1,"stats":{"Line":0}},{"line":580,"address":[41909631,41910415,41910527,41909967,41910191,41909295,41909407,41909519,41910303,41909743,41910079,41909855],"length":1,"stats":{"Line":1}},{"line":581,"address":[41909997,41910557,41909325,41909437,41909661,41910445,41909773,41910221,41909549,41910333,41909885,41910109],"length":1,"stats":{"Line":1}},{"line":582,"address":[41910253,41910365,41910029,41910589,41909917,41909693,41909805,41909581,41910477,41909357,41910141,41909469],"length":1,"stats":{"Line":1}},{"line":585,"address":[16283537],"length":1,"stats":{"Line":1}},{"line":588,"address":[16328112,16329200,16329152],"length":1,"stats":{"Line":1}},{"line":594,"address":[16328314,16328171,16328266,16329162],"length":1,"stats":{"Line":1}},{"line":595,"address":[16328243,16328300],"length":1,"stats":{"Line":0}},{"line":597,"address":[41984229,41986581,41992853,41988933,41988149,41985797,41987365,41989717,41985013,41990501,41992069,41991285],"length":1,"stats":{"Line":1}},{"line":599,"address":[41994967,41997441,41995319,41995089,41996257,41998727,41996967,41994103,41994577,41994455,41998849,41994225,41998545,41995905,41997319,41996673,41997089,41996135,41998071,41996551,41995783,41995441,41998423,41998193],"length":1,"stats":{"Line":0}},{"line":600,"address":[41994198,41994354,41994706,41994600,41998978,41996280,41996696,41998518,41994550,41998872,41995112,41997112,41996802,41998822,41997218,41995570,41997570,41998674,41995414,41998322,41996230,41998216,41998166,41998568,41997414,41995878,41997464,41995062,41994248,41995464,41995218,41995928,41996386,41996034,41996646,41997062],"length":1,"stats":{"Line":0}},{"line":603,"address":[41996069,41991417,41995253,41987497,41997253,41990633,41994389,41993648,41994880,41998336,41997232,41995232,41989849,41993829,41993925,41993669,41992985,41993904,41984361,41992201,41993856,41993877,41998357,41994720,41995584,41993808,41988281,41994741,41995605,41994368,41985929,41994901,41989065,41985145,41986713,41996048],"length":1,"stats":{"Line":1}},{"line":604,"address":[41984667,41985573,41990939,41989493,41987749,41991845,41986181,41993291,41987925,41991669,41993237,41984789,41989371,41988533,41988709,41986357,41987803,41984613,41991061,41987141,41993413,41985397,41992507,41990277,41990101,41985451,41992629,41991723,41986235,41988587,41990885,41987019,41992453,41990155,41989317,41986965],"length":1,"stats":{"Line":2}},{"line":605,"address":[41987077,41997948,41997920,41985509,41993980,41996400,41997696,41987770,41993349,41988645,41997808,41991781,41985418,41994796,41990122,41986202,41986986,41991690,41989429,41988554,41993952,41993564,41996816,41987861,41996844,41993724,41997612,41995660,41992565,41994768,41984725,41999020,41986293,41984634,41993536,41997836,41993258,41992474,41997584,41990213,41998992,41995632,41996428,41993696,41990906,41989338,41997724,41990997],"length":1,"stats":{"Line":1}},{"line":608,"address":[27025752,27018424,27022872,27045496,27037320,27028520],"length":1,"stats":{"Line":0}},{"line":611,"address":[16328809],"length":1,"stats":{"Line":0}},{"line":614,"address":[27037459,27022966,27018482,27018507,27025818,27025808,27022939,27037437,27028595,27037474,27025833,27028610,27045586,27045571,27022951,27018492,27028583,27045559],"length":1,"stats":{"Line":1}},{"line":616,"address":[17147925,17147948],"length":1,"stats":{"Line":0}},{"line":617,"address":[41918227,41915731,41933203,41968147,41938195,41948179,41953171,41910739,41913235,41965651,41950675,41940691,41930707,41945683,41923219,41960659,41920723,41925715,41935699,41955667,41943187,41958163,41963155,41928211],"length":1,"stats":{"Line":1}},{"line":618,"address":[41940756,41968212,41910804,41948244,41953236,41915796,41913300,41923284,41958228,41963220,41945748,41930772,41933268,41920788,41943252,41925780,41950740,41960724,41965716,41928276,41955732,41938260,41918292,41935764],"length":1,"stats":{"Line":1}},{"line":620,"address":[17140944],"length":1,"stats":{"Line":0}},{"line":621,"address":[41940939,41920971,41928459,41953419,41958411,41938443,41925963,41965899,41933451,41968395,41915979,41963403,41955915,41943435,41935947,41960907,41950923,41948427,41923467,41930955,41910987,41945931,41913483,41918475],"length":1,"stats":{"Line":0}},{"line":623,"address":[16328931],"length":1,"stats":{"Line":0}},{"line":625,"address":[17141408],"length":1,"stats":{"Line":0}},{"line":635,"address":[41941438,41938942,41923966,41936446,41963902,41918974,41968894,41946430,41913982,41961406,41933950,41916478,41948926,41958910,41928958,41926462,41953918,41931454,41943934,41951422,41966398,41956414,41911486,41921470],"length":1,"stats":{"Line":0}},{"line":637,"address":[17141670],"length":1,"stats":{"Line":0}},{"line":641,"address":[16284851],"length":1,"stats":{"Line":0}},{"line":645,"address":[16284907],"length":1,"stats":{"Line":0}},{"line":646,"address":[16284968],"length":1,"stats":{"Line":0}},{"line":648,"address":[16284948],"length":1,"stats":{"Line":0}},{"line":649,"address":[41972696,41974904,41979976,41972088,41975048,41978152,41979832,41970552,41978904,41980904,41977400,41980120,41971016,41978440,41978296,41972552,41979368,41977688,41971944,41975832,41977544,41975976,41974760,41971160],"length":1,"stats":{"Line":0}},{"line":652,"address":[16284998],"length":1,"stats":{"Line":0}},{"line":654,"address":[41927447,41935137,41967446,41944919,41939990,41947478,41920022,41934998,41967383,41942625,41942423,41934935,41950113,41915030,41922455,41947617,41969879,41915169,41922518,41912534,41937494,41930006,41912471,41954903,41962454,41917526,41917463,41959958,41967585,41940129,41917665,41960097,41919959,41957601,41947415,41962593,41937431,41925153,41957462,41952407,41949911,41957399,41969942,41912673,41955105,41922657,41939927,41959895,41932502,41945121,41930145,41920161,41932439,41937633,41952470,41944982,41962391,41949974,41914967,41970081,41965089,41932641,41954966,41929943,41927510,41925014,41927649,41942486,41964950,41964887,41924951,41952609],"length":1,"stats":{"Line":0}},{"line":658,"address":[16296156,16295536,16296014],"length":1,"stats":{"Line":1}},{"line":664,"address":[16295669,16295588],"length":1,"stats":{"Line":2}},{"line":666,"address":[42764322],"length":1,"stats":{"Line":2}},{"line":669,"address":[16295754],"length":1,"stats":{"Line":1}},{"line":670,"address":[16295811],"length":1,"stats":{"Line":1}},{"line":671,"address":[16295888],"length":1,"stats":{"Line":1}},{"line":672,"address":[16295921],"length":1,"stats":{"Line":1}},{"line":676,"address":[41932950,41927958,41932984,41970390,41912982,41952861,41962936,41940438,41937942,41942934,41912925,41942968,41925496,41967894,41970424,41917917,41915512,41920413,41952952,41965398,41927992,41965341,41918008,41967837,41957910,41915421,41937885,41947869,41965432,41915478,41960406,41937976,41945464,41940381,41960349,41923000,41913016,41950456,41935389,41917974,41955414,41947960,41930488,41925405,41952918,41950365,41960440,41922909,41945430,41955448,41920470,41932893,41942877,41935480,41922966,41962845,41935446,41950422,41955357,41920504,41947926,41927901,41967928,41925462,41957853,41930397,41970333,41957944,41945373,41940472,41962902,41930454],"length":1,"stats":{"Line":0}},{"line":679,"address":[41956493,41919053,41953548,41961485,41966477,41914061,41911116,41916557,41946060,41939021,41933580,41936525,41944013,41923596,41918604,41926092,41968973,41924045,41931533,41921100,41963981,41911565,41938572,41966028,41951052,41963532,41956044,41913612,41934029,41929037,41941068,41936076,41953997,41958989,41928588,41951501,41948556,41926541,41921549,41968524,41931084,41941517,41946509,41916108,41943564,41961036,41949005,41958540],"length":1,"stats":{"Line":0}},{"line":683,"address":[16322527],"length":1,"stats":{"Line":0}},{"line":684,"address":[16322586],"length":1,"stats":{"Line":0}},{"line":687,"address":[16293360,16293534],"length":1,"stats":{"Line":0}},{"line":691,"address":[16293391],"length":1,"stats":{"Line":0}},{"line":692,"address":[17145111],"length":1,"stats":{"Line":0}},{"line":696,"address":[16325008,16325177],"length":1,"stats":{"Line":1}},{"line":702,"address":[16325032],"length":1,"stats":{"Line":4}},{"line":706,"address":[16294105,16293963,16293568],"length":1,"stats":{"Line":0}},{"line":708,"address":[17138577,17149745,17148977,17150513,17151169,17146497,17147153],"length":1,"stats":{"Line":3}},{"line":710,"address":[42209451,42227115,42210635,42214971,42216075,42224987,42212763,42217259,42226011,42207243,42232635,42215051,42222699,42231611,42210555,42208427,42211659,42221595,42232715,42221675,42213867,42216155,42212843,42208347,42229403,42220571,42218283,42222779,42207323,42230427,42218363,42230507,42223803,42209531,42224907,42223883,42227195,42213947,42220491,42228219,42226091,42231531,42229323,42219387,42228299,42217179,42219467,42211739],"length":1,"stats":{"Line":0}},{"line":713,"address":[42229561,42214105,42207539,42220729,42230710,42219683,42226249,42232873,42222982,42227398,42215267,42208630,42231827,42209689,42219625,42220774,42209734,42213046,42228515,42218579,42224041,42221891,42217417,42214163,42209747,42211897,42230723,42219670,42214150,42232931,42213059,42216371,42227411,42227353,42225190,42222995,42218566,42229606,42220787,42229619,42216358,42207481,42210851,42215254,42221878,42224086,42207526,42226307,42215209,42208643,42210838,42228457,42216313,42217462,42222937,42218521,42231814,42210793,42232918,42225145,42211942,42221833,42228502,42213001,42226294,42230665,42217475,42225203,42211955,42224099,42231769,42208585],"length":1,"stats":{"Line":0}},{"line":714,"address":[16293804],"length":1,"stats":{"Line":0}},{"line":715,"address":[16293871],"length":1,"stats":{"Line":0}},{"line":719,"address":[42215597,42216617,42233177,42223241,42207869,42225533,42217805,42230813,42231053,42216701,42233261,42212285,42230969,42224189,42225449,42215513,42212201,42227501,42232073,42211181,42220013,42226637,42229709,42227657,42208733,42215357,42229865,42228845,42213305,42222137,42216461,42231917,42208973,42229949,42228605,42225293,42214493,42214409,42210941,42233021,42207629,42224429,42218669,42213389,42212045,42226397,42209993,42209837,42217565,42219773,42226553,42214253,42208889,42210077,42219929,42223325,42220877,42218909,42213149,42223085,42207785,42228761,42227741,42221117,42232157,42217721,42222221,42211097,42221981,42218825,42221033,42224345],"length":1,"stats":{"Line":0}},{"line":723,"address":[42235048,42239276,42239516,42236156,42234088,42241004,42237880,42233752,42234520,42238604,42235624,42240092,42239800,42236492,42238940,42241244,42235864,42240428,42237596,42238216,42239560,42238984,42236872,42241048,42240136,42236200,42236828,42237836,42240472,42235580,42238648,42237112,42234476,42239756,42236536,42234044,42240808,42233708,42237068,42238172,42235384,42239320,42235820,42237640,42235340,42241288,42240764,42235004],"length":1,"stats":{"Line":0}},{"line":728,"address":[16304324],"length":1,"stats":{"Line":0}},{"line":732,"address":[16305072,16305149],"length":1,"stats":{"Line":0}},{"line":733,"address":[16305089],"length":1,"stats":{"Line":0}},{"line":737,"address":[16305568,16306276,16306292],"length":1,"stats":{"Line":0}},{"line":738,"address":[16306286,16305620,16305689],"length":1,"stats":{"Line":1}},{"line":740,"address":[42043524,42070852,42080612,42018148,42014244,42051332,42090372,42068900,42010340,42086468,42094276,42025956,42037668,42092324,42078660,42020100,42082564,42047428,42084516,42096228,42027908,42035716,42045476,42076708,42022052,42031812,42057188,42006436,42063044,42061092,42012292,42004484,42055236,42008388,42039620,42074756,42029860,42049380,42024004,42053284,42072804,42016196,42059140,42066948,42064996,42088420,42041572,42033764],"length":1,"stats":{"Line":1}},{"line":741,"address":[16306192],"length":1,"stats":{"Line":0}},{"line":747,"address":[42087113,42059785,42055881,42051977,42034409,42028553,42065641,42038313,42024649,42092969,42091017,42089065,42032457,42005129,42007081,42010985,42016841,42044169,42020745,42061737,42063689,42067593,42048073,42075401,42040265,42073449,42046121,42081257,42085161,42036361,42079305,42094921,42018793,42012937,42026601,42083209,42077353,42071497,42053929,42069545,42042217,42022697,42057833,42050025,42096873,42014889,42009033,42030505],"length":1,"stats":{"Line":0}},{"line":754,"address":[31474096],"length":1,"stats":{"Line":0}},{"line":755,"address":[16307268,16307210],"length":1,"stats":{"Line":0}},{"line":758,"address":[16307375],"length":1,"stats":{"Line":0}},{"line":760,"address":[16308387,16307433,16308336],"length":1,"stats":{"Line":0}},{"line":761,"address":[42042284,42018860,42069612,42059852,42038380,42007148,42065708,42075468,42089132,42083276,42009100,42036428,42020812,42011052,42067660,42055948,42050092,42094988,42091084,42073516,42044236,42053996,42052044,42005196,42048140,42046188,42022764,42096940,42081324,42034476,42063756,42026668,42061804,42028620,42016908,42079372,42071564,42024716,42013004,42030572,42014956,42077420,42057900,42087180,42093036,42040332,42032524,42085228],"length":1,"stats":{"Line":0}},{"line":764,"address":[16307934],"length":1,"stats":{"Line":0}},{"line":765,"address":[16307955],"length":1,"stats":{"Line":0}},{"line":767,"address":[16308283],"length":1,"stats":{"Line":0}},{"line":771,"address":[16341120,16341198],"length":1,"stats":{"Line":0}},{"line":772,"address":[17132427,17132407,17132240,17132465,17132398,17132436,17132317,17132456],"length":1,"stats":{"Line":2}},{"line":776,"address":[16336326,16336192],"length":1,"stats":{"Line":0}},{"line":781,"address":[17132298],"length":1,"stats":{"Line":1}},{"line":785,"address":[16342536,16342464],"length":1,"stats":{"Line":1}},{"line":786,"address":[16342473],"length":1,"stats":{"Line":0}},{"line":790,"address":[16331408,16332055,16332020],"length":1,"stats":{"Line":0}},{"line":794,"address":[16331550,16331604,16331458],"length":1,"stats":{"Line":0}},{"line":795,"address":[16331527,16331590],"length":1,"stats":{"Line":0}},{"line":797,"address":[16331855],"length":1,"stats":{"Line":0}},{"line":798,"address":[16331698],"length":1,"stats":{"Line":0}},{"line":799,"address":[16331720],"length":1,"stats":{"Line":0}},{"line":800,"address":[16331731],"length":1,"stats":{"Line":0}},{"line":801,"address":[16331804],"length":1,"stats":{"Line":0}},{"line":808,"address":[16323612,16323456],"length":1,"stats":{"Line":1}},{"line":813,"address":[16323470],"length":1,"stats":{"Line":1}},{"line":817,"address":[16313308,16313152],"length":1,"stats":{"Line":1}},{"line":822,"address":[16313166],"length":1,"stats":{"Line":1}},{"line":826,"address":[16304203,16303488,16304272],"length":1,"stats":{"Line":1}},{"line":831,"address":[29422708,29423092,29423140,29422948,29422804,29422516,29422468,29422568,29423236,29423044,29423188,29423380,29423284,29422852,29422996,29423332,29422756,29422900],"length":1,"stats":{"Line":2}},{"line":833,"address":[30794065,30794209,30793921,30794017,30794305,30794449,30794401,30793969,30794113,30794257,30794161,30794353],"length":1,"stats":{"Line":3}},{"line":834,"address":[16304040],"length":1,"stats":{"Line":2}},{"line":835,"address":[16304087],"length":1,"stats":{"Line":2}},{"line":839,"address":[16302691,16302176,16302804],"length":1,"stats":{"Line":0}},{"line":844,"address":[16302204],"length":1,"stats":{"Line":0}},{"line":846,"address":[42772130,42771944],"length":1,"stats":{"Line":0}},{"line":850,"address":[16333023,16332896],"length":1,"stats":{"Line":0}},{"line":851,"address":[42772493],"length":1,"stats":{"Line":0}},{"line":855,"address":[17151939],"length":1,"stats":{"Line":2}},{"line":860,"address":[27044521,27032331,27044446,27035723,27035678,27049278,27021877,27049323,27033886,27033920,27032286,27021838],"length":1,"stats":{"Line":6}},{"line":864,"address":[42758541],"length":1,"stats":{"Line":1}},{"line":870,"address":[17152346],"length":1,"stats":{"Line":1}},{"line":874,"address":[16343232,16343359],"length":1,"stats":{"Line":0}},{"line":878,"address":[16343253],"length":1,"stats":{"Line":0}},{"line":882,"address":[16349220,16349301,16348992],"length":1,"stats":{"Line":1}},{"line":883,"address":[27034520,27034540,27032833,27042389,27048140,27032885,27048082,27034482,27020826,27042261,27048120,27031107,27020811,27020773,27031145,27042312,27032870,27031163],"length":1,"stats":{"Line":2}},{"line":884,"address":[16349118],"length":1,"stats":{"Line":0}},{"line":886,"address":[17152218],"length":1,"stats":{"Line":3}},{"line":888,"address":[27034835,27031416,27042987,27042936,27033145,27034858,27043067,27031454,27048435,27021106,27031475,27033108,27021050,27048458,27034797,27048397,27033163,27021088],"length":1,"stats":{"Line":1}},{"line":889,"address":[42767264],"length":1,"stats":{"Line":1}},{"line":893,"address":[42767692,42767361,42767715],"length":1,"stats":{"Line":1}},{"line":894,"address":[17137497],"length":1,"stats":{"Line":1}},{"line":898,"address":[27030720,27032496,27020416,27047696,27041440,27034096],"length":1,"stats":{"Line":2}},{"line":899,"address":[31431621,31430251,31431225,31432119,31430815],"length":1,"stats":{"Line":0}},{"line":903,"address":[42780656],"length":1,"stats":{"Line":0}},{"line":904,"address":[17135056],"length":1,"stats":{"Line":0}},{"line":908,"address":[16324192,16324269],"length":1,"stats":{"Line":0}},{"line":909,"address":[16324209],"length":1,"stats":{"Line":0}},{"line":917,"address":[16323373,16323296],"length":1,"stats":{"Line":0}},{"line":918,"address":[16323313],"length":1,"stats":{"Line":0}},{"line":922,"address":[16319392,16319469],"length":1,"stats":{"Line":0}},{"line":923,"address":[16319409],"length":1,"stats":{"Line":0}},{"line":927,"address":[31438265],"length":1,"stats":{"Line":0}},{"line":928,"address":[16323073],"length":1,"stats":{"Line":0}},{"line":932,"address":[17136104],"length":1,"stats":{"Line":0}},{"line":933,"address":[27034044,27020379,27020312,27034064,27030616,27020356,27033992,27032451,27047644,27041304,27041390,27030668,27047592,27032469,27041406,27030688,27032408,27047664],"length":1,"stats":{"Line":0}},{"line":937,"address":[16336579,16336496],"length":1,"stats":{"Line":0}},{"line":938,"address":[16336518],"length":1,"stats":{"Line":0}},{"line":942,"address":[17135859],"length":1,"stats":{"Line":0}},{"line":947,"address":[16339875],"length":1,"stats":{"Line":0}},{"line":951,"address":[16323783,16323632],"length":1,"stats":{"Line":0}},{"line":956,"address":[42744000],"length":1,"stats":{"Line":0}},{"line":960,"address":[16333952,16334091],"length":1,"stats":{"Line":0}},{"line":966,"address":[16334013],"length":1,"stats":{"Line":0}},{"line":970,"address":[31439056,31438864,31438768,31438960,31439152],"length":1,"stats":{"Line":0}},{"line":976,"address":[16333415],"length":1,"stats":{"Line":0}},{"line":980,"address":[16322479,16322352],"length":1,"stats":{"Line":0}},{"line":984,"address":[31437920],"length":1,"stats":{"Line":0}},{"line":988,"address":[17138328],"length":1,"stats":{"Line":0}},{"line":993,"address":[16339720],"length":1,"stats":{"Line":0}},{"line":997,"address":[16316128,16316252],"length":1,"stats":{"Line":0}},{"line":998,"address":[16316141],"length":1,"stats":{"Line":0}},{"line":1002,"address":[16316752,16317360,16317331],"length":1,"stats":{"Line":0}},{"line":1003,"address":[16317341,16316875,16316783,16316923],"length":1,"stats":{"Line":0}},{"line":1004,"address":[16316852,16316909],"length":1,"stats":{"Line":0}},{"line":1007,"address":[42743921],"length":1,"stats":{"Line":0}},{"line":1012,"address":[16317169],"length":1,"stats":{"Line":0}},{"line":1014,"address":[16317174],"length":1,"stats":{"Line":0}},{"line":1015,"address":[16317182],"length":1,"stats":{"Line":0}},{"line":1018,"address":[16317199],"length":1,"stats":{"Line":0}},{"line":1022,"address":[16312496,16313075,16313104],"length":1,"stats":{"Line":0}},{"line":1023,"address":[16312667,16312527,16313085,16312619],"length":1,"stats":{"Line":0}},{"line":1024,"address":[16312596,16312653],"length":1,"stats":{"Line":0}},{"line":1027,"address":[16312817,16313043,16312765],"length":1,"stats":{"Line":0}},{"line":1032,"address":[16312913],"length":1,"stats":{"Line":0}},{"line":1034,"address":[16312918],"length":1,"stats":{"Line":0}},{"line":1035,"address":[16312926],"length":1,"stats":{"Line":0}},{"line":1038,"address":[42780560],"length":1,"stats":{"Line":0}},{"line":1042,"address":[17136784],"length":1,"stats":{"Line":1}},{"line":1046,"address":[16306383,16306475,16306523,16306731],"length":1,"stats":{"Line":0}},{"line":1047,"address":[16306452,16306509],"length":1,"stats":{"Line":0}},{"line":1048,"address":[16306620],"length":1,"stats":{"Line":0}},{"line":1052,"address":[16311022,16310848],"length":1,"stats":{"Line":0}},{"line":1056,"address":[16310879],"length":1,"stats":{"Line":0}},{"line":1057,"address":[16310938],"length":1,"stats":{"Line":0}},{"line":1063,"address":[17135534,17135566,17135580],"length":1,"stats":{"Line":0}},{"line":1064,"address":[16304949],"length":1,"stats":{"Line":0}},{"line":1068,"address":[16335379,16335248],"length":1,"stats":{"Line":0}},{"line":1073,"address":[16335267],"length":1,"stats":{"Line":0}},{"line":1077,"address":[16323279,16323152],"length":1,"stats":{"Line":0}},{"line":1078,"address":[16323173],"length":1,"stats":{"Line":0}},{"line":1082,"address":[16338832,16338959],"length":1,"stats":{"Line":0}},{"line":1083,"address":[16338853],"length":1,"stats":{"Line":0}},{"line":1087,"address":[16343212,16342944],"length":1,"stats":{"Line":0}},{"line":1092,"address":[16342977],"length":1,"stats":{"Line":0}},{"line":1093,"address":[17134979],"length":1,"stats":{"Line":0}},{"line":1094,"address":[17135022],"length":1,"stats":{"Line":0}},{"line":1098,"address":[16336911,16336784],"length":1,"stats":{"Line":0}},{"line":1099,"address":[16336805],"length":1,"stats":{"Line":0}},{"line":1103,"address":[16321472],"length":1,"stats":{"Line":0}},{"line":1104,"address":[16321476],"length":1,"stats":{"Line":0}},{"line":1108,"address":[16337648,16338805],"length":1,"stats":{"Line":0}},{"line":1112,"address":[16337732,16337684],"length":1,"stats":{"Line":0}},{"line":1113,"address":[16337825],"length":1,"stats":{"Line":0}},{"line":1114,"address":[16337847],"length":1,"stats":{"Line":0}},{"line":1116,"address":[16338037,16337874,16337941],"length":1,"stats":{"Line":0}},{"line":1117,"address":[16338133,16338264],"length":1,"stats":{"Line":0}},{"line":1118,"address":[16338501,16338337,16338414],"length":1,"stats":{"Line":0}},{"line":1119,"address":[16338463],"length":1,"stats":{"Line":0}},{"line":1120,"address":[16338503,16338470],"length":1,"stats":{"Line":0}},{"line":1122,"address":[16338438,16338528,16338713],"length":1,"stats":{"Line":0}},{"line":1126,"address":[16338155],"length":1,"stats":{"Line":0}},{"line":1130,"address":[42746504,42745334,42747022,42746254,42745089,42744845,42746038,42745550,42746776,42747246,42745793,42744621],"length":1,"stats":{"Line":0}},{"line":1135,"address":[16329291,16329756,16329432,16329383],"length":1,"stats":{"Line":0}},{"line":1136,"address":[16329360,16329418],"length":1,"stats":{"Line":0}},{"line":1137,"address":[16329531,16329599],"length":1,"stats":{"Line":0}},{"line":1138,"address":[42746875,42746107,42746331,42745867,42745163,42745627,42747099,42744923,42744699,42746603,42747323,42745403],"length":1,"stats":{"Line":0}},{"line":1142,"address":[16288537,16285168,16287864],"length":1,"stats":{"Line":0}},{"line":1144,"address":[16285282,16288446,16285351],"length":1,"stats":{"Line":0}},{"line":1146,"address":[16285540],"length":1,"stats":{"Line":0}},{"line":1149,"address":[16285608],"length":1,"stats":{"Line":0}},{"line":1150,"address":[16285708,16285643],"length":1,"stats":{"Line":0}},{"line":1151,"address":[16285716,16285781],"length":1,"stats":{"Line":0}},{"line":1152,"address":[16285789,16285854],"length":1,"stats":{"Line":0}},{"line":1153,"address":[16285927,16285862],"length":1,"stats":{"Line":0}},{"line":1156,"address":[16285943],"length":1,"stats":{"Line":0}},{"line":1157,"address":[16285988,16286588],"length":1,"stats":{"Line":0}},{"line":1158,"address":[16286719,16288026,16287930],"length":1,"stats":{"Line":0}},{"line":1159,"address":[42285358],"length":1,"stats":{"Line":0}},{"line":1160,"address":[16288290,16288334],"length":1,"stats":{"Line":0}},{"line":1166,"address":[16286797],"length":1,"stats":{"Line":0}},{"line":1168,"address":[42768848],"length":1,"stats":{"Line":0}},{"line":1169,"address":[42768869],"length":1,"stats":{"Line":0}},{"line":1171,"address":[16287062],"length":1,"stats":{"Line":0}},{"line":1176,"address":[42285451,42284903],"length":1,"stats":{"Line":0}},{"line":1177,"address":[16287345],"length":1,"stats":{"Line":0}},{"line":1178,"address":[16287365],"length":1,"stats":{"Line":0}},{"line":1181,"address":[16287382],"length":1,"stats":{"Line":0}},{"line":1184,"address":[16287490],"length":1,"stats":{"Line":0}},{"line":1186,"address":[16287517],"length":1,"stats":{"Line":0}},{"line":1190,"address":[42768477],"length":1,"stats":{"Line":0}},{"line":1192,"address":[42768547],"length":1,"stats":{"Line":0}},{"line":1194,"address":[16294407],"length":1,"stats":{"Line":1}},{"line":1197,"address":[17132032],"length":1,"stats":{"Line":0}},{"line":1200,"address":[16294645,16295456,16294693,16294594],"length":1,"stats":{"Line":0}},{"line":1201,"address":[17132125],"length":1,"stats":{"Line":0}},{"line":1204,"address":[16295417,16294815,16294870],"length":1,"stats":{"Line":0}},{"line":1207,"address":[42265680],"length":1,"stats":{"Line":2}},{"line":1208,"address":[42265685],"length":1,"stats":{"Line":1}},{"line":1212,"address":[42265765],"length":1,"stats":{"Line":1}},{"line":1214,"address":[16295230],"length":1,"stats":{"Line":0}},{"line":1218,"address":[16303257,16303056],"length":1,"stats":{"Line":0}},{"line":1219,"address":[42265583],"length":1,"stats":{"Line":1}},{"line":1220,"address":[16303160],"length":1,"stats":{"Line":0}},{"line":1221,"address":[42265622],"length":1,"stats":{"Line":1}},{"line":1225,"address":[42265363],"length":1,"stats":{"Line":1}},{"line":1227,"address":[42265408],"length":1,"stats":{"Line":3}},{"line":1229,"address":[42265459],"length":1,"stats":{"Line":3}},{"line":1231,"address":[42265232],"length":1,"stats":{"Line":1}},{"line":1232,"address":[16291676,16291733],"length":1,"stats":{"Line":1}},{"line":1234,"address":[16291996],"length":1,"stats":{"Line":0}},{"line":1235,"address":[17140041],"length":1,"stats":{"Line":0}},{"line":1236,"address":[16292069],"length":1,"stats":{"Line":0}},{"line":1238,"address":[42267173],"length":1,"stats":{"Line":0}},{"line":1240,"address":[16292093],"length":1,"stats":{"Line":0}},{"line":1244,"address":[16284221,16284144],"length":1,"stats":{"Line":1}},{"line":1245,"address":[16284161],"length":1,"stats":{"Line":1}},{"line":1249,"address":[42266074,42266044,42265933],"length":1,"stats":{"Line":6}},{"line":1250,"address":[16310565],"length":1,"stats":{"Line":0}},{"line":1254,"address":[16308688,16309730,16309736],"length":1,"stats":{"Line":0}},{"line":1256,"address":[16308731,16308746],"length":1,"stats":{"Line":0}},{"line":1258,"address":[17144092,17143911,17144118,17144068],"length":1,"stats":{"Line":0}},{"line":1259,"address":[17143809,17144172],"length":1,"stats":{"Line":0}},{"line":1260,"address":[17144299,17143990],"length":1,"stats":{"Line":0}},{"line":1261,"address":[42249168],"length":1,"stats":{"Line":1}},{"line":1262,"address":[17144017,17144325],"length":1,"stats":{"Line":0}},{"line":1264,"address":[16308708],"length":1,"stats":{"Line":1}},{"line":1266,"address":[42252186,42251907,42250915,42250305,42251035,42251373,42252441,42252103,42251983,42250584,42250839,42252720,42251652,42251569,42252637,42252517,42251449,42249967,42250501,42249839,42249775,42250381,42250050,42251118],"length":1,"stats":{"Line":3}},{"line":1267,"address":[16309890,16308840,16309800],"length":1,"stats":{"Line":0}},{"line":1269,"address":[16309983],"length":1,"stats":{"Line":0}},{"line":1271,"address":[16310078],"length":1,"stats":{"Line":0}},{"line":1276,"address":[16308867],"length":1,"stats":{"Line":0}},{"line":1277,"address":[17144488],"length":1,"stats":{"Line":0}},{"line":1278,"address":[16309236,16309143],"length":1,"stats":{"Line":0}},{"line":1279,"address":[16309255],"length":1,"stats":{"Line":0}},{"line":1280,"address":[17144397,17144523,17144514],"length":1,"stats":{"Line":0}},{"line":1283,"address":[17144579],"length":1,"stats":{"Line":0}},{"line":1286,"address":[16323808,16323935],"length":1,"stats":{"Line":0}},{"line":1287,"address":[16323829],"length":1,"stats":{"Line":0}},{"line":1291,"address":[16301006,16300832],"length":1,"stats":{"Line":3}},{"line":1295,"address":[42258642,42260012,42258591,42253189,42253138,42257272,42255902,42254532,42254481,42255851,42257221,42259961],"length":1,"stats":{"Line":1}},{"line":1299,"address":[16305168,16305545],"length":1,"stats":{"Line":2}},{"line":1300,"address":[16305202],"length":1,"stats":{"Line":0}},{"line":1303,"address":[16305322,16305264],"length":1,"stats":{"Line":0}},{"line":1304,"address":[16305335],"length":1,"stats":{"Line":0}},{"line":1306,"address":[16305431],"length":1,"stats":{"Line":0}},{"line":1310,"address":[16301117,16301040],"length":1,"stats":{"Line":0}},{"line":1311,"address":[16301057],"length":1,"stats":{"Line":0}},{"line":1315,"address":[16344592,16344941],"length":1,"stats":{"Line":0}},{"line":1319,"address":[16344896,16344609,16344661],"length":1,"stats":{"Line":0}},{"line":1320,"address":[16344789],"length":1,"stats":{"Line":0}},{"line":1321,"address":[16344808],"length":1,"stats":{"Line":0}},{"line":1325,"address":[16340896,16340981],"length":1,"stats":{"Line":0}},{"line":1326,"address":[42264528],"length":1,"stats":{"Line":0}},{"line":1330,"address":[16334336,16334463],"length":1,"stats":{"Line":0}},{"line":1331,"address":[16334357],"length":1,"stats":{"Line":0}},{"line":1337,"address":[16332080,16332165],"length":1,"stats":{"Line":0}},{"line":1341,"address":[16332107],"length":1,"stats":{"Line":0}},{"line":1345,"address":[16335040,16334944],"length":1,"stats":{"Line":0}},{"line":1350,"address":[16334982],"length":1,"stats":{"Line":0}},{"line":1354,"address":[16312352,16312479],"length":1,"stats":{"Line":0}},{"line":1355,"address":[16312373],"length":1,"stats":{"Line":0}},{"line":1359,"address":[16315871,16315744],"length":1,"stats":{"Line":0}},{"line":1360,"address":[16315765],"length":1,"stats":{"Line":0}},{"line":1364,"address":[16340080,16340164],"length":1,"stats":{"Line":0}},{"line":1365,"address":[16340101],"length":1,"stats":{"Line":0}},{"line":1369,"address":[16331264,16331386],"length":1,"stats":{"Line":0}},{"line":1370,"address":[42261467],"length":1,"stats":{"Line":0}},{"line":1374,"address":[16310448,16310525],"length":1,"stats":{"Line":0}},{"line":1375,"address":[16310465],"length":1,"stats":{"Line":0}},{"line":1379,"address":[16326214,16326185,16325488],"length":1,"stats":{"Line":0}},{"line":1384,"address":[16326195,16325681,16325540,16325632],"length":1,"stats":{"Line":0}},{"line":1385,"address":[42264629],"length":1,"stats":{"Line":0}},{"line":1388,"address":[42264982],"length":1,"stats":{"Line":0}},{"line":1390,"address":[42265107,42265077],"length":1,"stats":{"Line":0}},{"line":1391,"address":[16325860],"length":1,"stats":{"Line":0}},{"line":1394,"address":[16326153,16325895],"length":1,"stats":{"Line":0}},{"line":1397,"address":[16326007],"length":1,"stats":{"Line":0}},{"line":1403,"address":[16326024],"length":1,"stats":{"Line":0}},{"line":1408,"address":[16326052],"length":1,"stats":{"Line":0}},{"line":1412,"address":[16300048,16300761,16300806],"length":1,"stats":{"Line":0}},{"line":1417,"address":[16300194,16300243,16300771,16300102],"length":1,"stats":{"Line":0}},{"line":1418,"address":[16300171,16300229],"length":1,"stats":{"Line":0}},{"line":1421,"address":[16300331],"length":1,"stats":{"Line":0}},{"line":1424,"address":[16300400,16300729],"length":1,"stats":{"Line":1}},{"line":1427,"address":[16300537],"length":1,"stats":{"Line":0}},{"line":1430,"address":[16300559],"length":1,"stats":{"Line":0}},{"line":1432,"address":[16300574],"length":1,"stats":{"Line":0}},{"line":1436,"address":[16311809,16311056,16311764],"length":1,"stats":{"Line":0}},{"line":1441,"address":[16311251,16311110,16311774,16311202],"length":1,"stats":{"Line":0}},{"line":1442,"address":[16311179,16311237],"length":1,"stats":{"Line":0}},{"line":1445,"address":[16311339],"length":1,"stats":{"Line":1}},{"line":1448,"address":[16311732,16311408],"length":1,"stats":{"Line":1}},{"line":1451,"address":[16311540],"length":1,"stats":{"Line":0}},{"line":1454,"address":[42243877],"length":1,"stats":{"Line":1}},{"line":1456,"address":[16311577],"length":1,"stats":{"Line":0}},{"line":1460,"address":[16304870,16304905,16304400],"length":1,"stats":{"Line":0}},{"line":1464,"address":[16304542,16304596,16304450],"length":1,"stats":{"Line":0}},{"line":1465,"address":[16304582,16304519],"length":1,"stats":{"Line":0}},{"line":1466,"address":[16304745,16304696],"length":1,"stats":{"Line":0}},{"line":1470,"address":[16301800,16301280,16301937],"length":1,"stats":{"Line":0}},{"line":1475,"address":[16301491,16301816,16301442,16301326],"length":1,"stats":{"Line":0}},{"line":1476,"address":[16301419,16301477],"length":1,"stats":{"Line":0}},{"line":1477,"address":[16301696,16301593],"length":1,"stats":{"Line":0}},{"line":1483,"address":[16293072,16293336],"length":1,"stats":{"Line":0}},{"line":1490,"address":[16293093],"length":1,"stats":{"Line":0}},{"line":1494,"address":[16332514,16332336],"length":1,"stats":{"Line":0}},{"line":1499,"address":[16332355],"length":1,"stats":{"Line":1}},{"line":1503,"address":[16303038,16302832],"length":1,"stats":{"Line":0}},{"line":1509,"address":[16302850],"length":1,"stats":{"Line":0}},{"line":1513,"address":[16312191,16312064],"length":1,"stats":{"Line":0}},{"line":1517,"address":[16312085],"length":1,"stats":{"Line":0}},{"line":1521,"address":[16335133,16335056],"length":1,"stats":{"Line":0}},{"line":1522,"address":[16335073],"length":1,"stats":{"Line":0}},{"line":1526,"address":[16341008,16341091],"length":1,"stats":{"Line":0}},{"line":1530,"address":[16341030],"length":1,"stats":{"Line":0}},{"line":1534,"address":[16334480,16334920],"length":1,"stats":{"Line":0}},{"line":1538,"address":[42266144],"length":1,"stats":{"Line":1}},{"line":1539,"address":[42266369,42266672,42266282],"length":1,"stats":{"Line":2}},{"line":1540,"address":[16334764],"length":1,"stats":{"Line":1}},{"line":1546,"address":[42267120],"length":1,"stats":{"Line":0}},{"line":1547,"address":[42267125],"length":1,"stats":{"Line":0}},{"line":1551,"address":[16327906,16327922,16327232],"length":1,"stats":{"Line":0}},{"line":1552,"address":[16327255,16327324,16327916],"length":1,"stats":{"Line":0}},{"line":1554,"address":[16327503],"length":1,"stats":{"Line":0}},{"line":1556,"address":[16327573,16327873],"length":1,"stats":{"Line":0}},{"line":1557,"address":[16327738],"length":1,"stats":{"Line":0}},{"line":1561,"address":[42261642],"length":1,"stats":{"Line":0}},{"line":1562,"address":[16327750],"length":1,"stats":{"Line":0}},{"line":1563,"address":[42261654],"length":1,"stats":{"Line":0}},{"line":1564,"address":[42261674],"length":1,"stats":{"Line":0}},{"line":1565,"address":[42261694],"length":1,"stats":{"Line":0}},{"line":1568,"address":[16327822],"length":1,"stats":{"Line":0}},{"line":1572,"address":[16324096,16324173],"length":1,"stats":{"Line":0}},{"line":1573,"address":[42261997,42261967],"length":1,"stats":{"Line":0}},{"line":1577,"address":[42261810],"length":1,"stats":{"Line":0}},{"line":1578,"address":[42261815,42261736],"length":1,"stats":{"Line":0}},{"line":1580,"address":[16335661],"length":1,"stats":{"Line":0}},{"line":1582,"address":[16336118,16335731],"length":1,"stats":{"Line":0}},{"line":1583,"address":[16336016],"length":1,"stats":{"Line":0}},{"line":1587,"address":[30340755,30341587,30337011,30340339,30337427,30337843,30338259,30339091,30338675,30339923,30339507,30341171],"length":1,"stats":{"Line":0}},{"line":1588,"address":[16336028],"length":1,"stats":{"Line":0}},{"line":1589,"address":[42262811],"length":1,"stats":{"Line":0}},{"line":1590,"address":[42262758],"length":1,"stats":{"Line":0}},{"line":1593,"address":[30546739,30545491,30547571,30546323,30545907,30547155],"length":1,"stats":{"Line":0}},{"line":1597,"address":[16333040,16333167],"length":1,"stats":{"Line":0}},{"line":1601,"address":[16333061],"length":1,"stats":{"Line":0}},{"line":1605,"address":[16339673,16339168,16339630],"length":1,"stats":{"Line":0}},{"line":1606,"address":[42264177,42263648,42263706],"length":1,"stats":{"Line":0}},{"line":1608,"address":[16339268,16339645],"length":1,"stats":{"Line":0}},{"line":1609,"address":[16339447],"length":1,"stats":{"Line":0}},{"line":1613,"address":[42264039],"length":1,"stats":{"Line":0}},{"line":1615,"address":[16339501],"length":1,"stats":{"Line":0}},{"line":1616,"address":[42264217],"length":1,"stats":{"Line":0}},{"line":1617,"address":[42264235],"length":1,"stats":{"Line":0}},{"line":1620,"address":[16339533],"length":1,"stats":{"Line":0}},{"line":1624,"address":[42261536],"length":1,"stats":{"Line":0}},{"line":1628,"address":[16318833,16318894],"length":1,"stats":{"Line":0}},{"line":1634,"address":[42265216],"length":1,"stats":{"Line":0}},{"line":1635,"address":[16319080],"length":1,"stats":{"Line":0}},{"line":1636,"address":[42265230],"length":1,"stats":{"Line":0}},{"line":1639,"address":[16319165],"length":1,"stats":{"Line":0}},{"line":1643,"address":[16330016,16330619,16330584],"length":1,"stats":{"Line":0}},{"line":1648,"address":[16330057],"length":1,"stats":{"Line":0}},{"line":1650,"address":[16330114],"length":1,"stats":{"Line":0}},{"line":1652,"address":[16330328],"length":1,"stats":{"Line":0}},{"line":1657,"address":[16330385],"length":1,"stats":{"Line":0}},{"line":1659,"address":[42282752,42282829],"length":1,"stats":{"Line":0}},{"line":1660,"address":[16330393],"length":1,"stats":{"Line":0}},{"line":1661,"address":[16330401],"length":1,"stats":{"Line":0}},{"line":1664,"address":[42282805],"length":1,"stats":{"Line":0}},{"line":1668,"address":[16330640,16331208,16331243],"length":1,"stats":{"Line":0}},{"line":1673,"address":[30550448,30550528,30550288,30550128,30550208,30550368],"length":1,"stats":{"Line":0}},{"line":1675,"address":[16330738],"length":1,"stats":{"Line":0}},{"line":1677,"address":[42242176],"length":1,"stats":{"Line":0}},{"line":1682,"address":[42242304],"length":1,"stats":{"Line":0}},{"line":1684,"address":[42242331],"length":1,"stats":{"Line":0}},{"line":1685,"address":[42243005,42242353],"length":1,"stats":{"Line":0}},{"line":1686,"address":[42242596],"length":1,"stats":{"Line":0}},{"line":1689,"address":[42242666],"length":1,"stats":{"Line":0}},{"line":1693,"address":[16312047,16311920],"length":1,"stats":{"Line":0}},{"line":1694,"address":[42243062],"length":1,"stats":{"Line":0}},{"line":1698,"address":[16312208,16312335],"length":1,"stats":{"Line":0}},{"line":1699,"address":[16312229],"length":1,"stats":{"Line":0}},{"line":1703,"address":[16318635,16318352],"length":1,"stats":{"Line":0}},{"line":1706,"address":[42242576],"length":1,"stats":{"Line":0}},{"line":1707,"address":[16318435],"length":1,"stats":{"Line":0}},{"line":1709,"address":[16318475],"length":1,"stats":{"Line":0}},{"line":1710,"address":[16318487],"length":1,"stats":{"Line":0}},{"line":1712,"address":[16318517],"length":1,"stats":{"Line":0}},{"line":1716,"address":[16318276,16318327,16317680],"length":1,"stats":{"Line":0}},{"line":1721,"address":[16317720,16317789],"length":1,"stats":{"Line":0}},{"line":1723,"address":[16317957],"length":1,"stats":{"Line":0}},{"line":1726,"address":[16318019],"length":1,"stats":{"Line":0}},{"line":1729,"address":[16318061],"length":1,"stats":{"Line":0}},{"line":1733,"address":[16316725,16316272],"length":1,"stats":{"Line":0}},{"line":1740,"address":[16316395,16316325],"length":1,"stats":{"Line":0}},{"line":1743,"address":[16316407],"length":1,"stats":{"Line":0}},{"line":1744,"address":[16316428,16316493],"length":1,"stats":{"Line":0}},{"line":1746,"address":[16316524],"length":1,"stats":{"Line":0}},{"line":1750,"address":[16313472,16315376,16315317],"length":1,"stats":{"Line":0}},{"line":1755,"address":[16313528],"length":1,"stats":{"Line":0}},{"line":1756,"address":[42286657],"length":1,"stats":{"Line":0}},{"line":1759,"address":[30550704,30550896,30550800,30550992,30551088,30550608],"length":1,"stats":{"Line":0}},{"line":1761,"address":[16313824],"length":1,"stats":{"Line":0}},{"line":1762,"address":[42286995],"length":1,"stats":{"Line":0}},{"line":1763,"address":[16314192,16313901],"length":1,"stats":{"Line":0}},{"line":1764,"address":[30551132,30550748,30550652,30551036,30550940,30550844],"length":1,"stats":{"Line":0}},{"line":1765,"address":[30347380,30348052,30347476,30348244,30347668,30347572,30347860,30347764,30348436,30347956,30348148,30348340],"length":1,"stats":{"Line":0}},{"line":1766,"address":[16314006,16314588],"length":1,"stats":{"Line":0}},{"line":1767,"address":[42286160],"length":1,"stats":{"Line":0}},{"line":1770,"address":[16314171],"length":1,"stats":{"Line":0}},{"line":1771,"address":[42286248],"length":1,"stats":{"Line":0}},{"line":1773,"address":[16314889,16314986],"length":1,"stats":{"Line":0}},{"line":1776,"address":[16315163],"length":1,"stats":{"Line":0}},{"line":1778,"address":[42286384],"length":1,"stats":{"Line":0}},{"line":1779,"address":[16315258],"length":1,"stats":{"Line":0}},{"line":1782,"address":[16314787],"length":1,"stats":{"Line":0}},{"line":1790,"address":[16337629,16337152,16337594],"length":1,"stats":{"Line":0}},{"line":1794,"address":[16337187,16337251],"length":1,"stats":{"Line":0}},{"line":1795,"address":[16337408],"length":1,"stats":{"Line":0}},{"line":1796,"address":[16337492],"length":1,"stats":{"Line":0}},{"line":1800,"address":[16336352,16336479],"length":1,"stats":{"Line":0}},{"line":1801,"address":[16336373],"length":1,"stats":{"Line":0}},{"line":1805,"address":[41905078],"length":1,"stats":{"Line":0}},{"line":1808,"address":[41905108],"length":1,"stats":{"Line":0}},{"line":1809,"address":[16333798],"length":1,"stats":{"Line":0}},{"line":1810,"address":[41905128],"length":1,"stats":{"Line":0}},{"line":1814,"address":[16343453,16343376],"length":1,"stats":{"Line":0}},{"line":1815,"address":[16343393],"length":1,"stats":{"Line":0}},{"line":1819,"address":[16341472,16342278,16342209],"length":1,"stats":{"Line":0}},{"line":1823,"address":[41905268,41905175],"length":1,"stats":{"Line":0}},{"line":1825,"address":[41905365,41908897],"length":1,"stats":{"Line":0}},{"line":1827,"address":[41905506],"length":1,"stats":{"Line":0}},{"line":1828,"address":[16341997],"length":1,"stats":{"Line":0}},{"line":1832,"address":[41905800,41905704],"length":1,"stats":{"Line":0}},{"line":1833,"address":[41905868],"length":1,"stats":{"Line":0}},{"line":1834,"address":[16342054],"length":1,"stats":{"Line":0}},{"line":1835,"address":[16342070],"length":1,"stats":{"Line":0}},{"line":1836,"address":[41906139],"length":1,"stats":{"Line":0}},{"line":1839,"address":[16342093],"length":1,"stats":{"Line":0}},{"line":1843,"address":[16344577,16343856,16344524],"length":1,"stats":{"Line":0}},{"line":1844,"address":[41906424],"length":1,"stats":{"Line":0}},{"line":1846,"address":[16344118],"length":1,"stats":{"Line":0}},{"line":1848,"address":[41906548],"length":1,"stats":{"Line":0}},{"line":1849,"address":[16344365],"length":1,"stats":{"Line":0}},{"line":1853,"address":[30332595,30334259,30331763,30333427,30332179,30335091,30334675,30336339,30333011,30335923,30333843,30335507],"length":1,"stats":{"Line":0}},{"line":1854,"address":[16344417],"length":1,"stats":{"Line":0}},{"line":1855,"address":[41906938],"length":1,"stats":{"Line":0}},{"line":1856,"address":[16344431],"length":1,"stats":{"Line":0}},{"line":1857,"address":[41907017],"length":1,"stats":{"Line":0}},{"line":1860,"address":[41907241,41907215],"length":1,"stats":{"Line":0}},{"line":1867,"address":[29427094,29425846,29427926,29427510,29429174,29429590,29426678,29428342,29432134,29430422,29425014,29425430,29430006,29431718,29431283,29426262,29428758,29430838],"length":1,"stats":{"Line":0}},{"line":1868,"address":[16319501],"length":1,"stats":{"Line":0}},{"line":1872,"address":[41907628],"length":1,"stats":{"Line":0}},{"line":1883,"address":[41907908,41907815],"length":1,"stats":{"Line":0}},{"line":1884,"address":[41907901,41907960],"length":1,"stats":{"Line":0}},{"line":1885,"address":[41908027],"length":1,"stats":{"Line":0}},{"line":1886,"address":[41907979,41908244],"length":1,"stats":{"Line":0}},{"line":1887,"address":[41908253],"length":1,"stats":{"Line":0}},{"line":1893,"address":[16306981,16306896],"length":1,"stats":{"Line":0}},{"line":1897,"address":[16306923],"length":1,"stats":{"Line":0}},{"line":1901,"address":[16334306,16334112],"length":1,"stats":{"Line":0}},{"line":1918,"address":[16315984,16316111],"length":1,"stats":{"Line":0}},{"line":1919,"address":[16316005],"length":1,"stats":{"Line":0}},{"line":1923,"address":[16342304,16342444],"length":1,"stats":{"Line":0}},{"line":1928,"address":[16342336],"length":1,"stats":{"Line":0}},{"line":1932,"address":[16340869,16340544],"length":1,"stats":{"Line":0}},{"line":1950,"address":[16340670],"length":1,"stats":{"Line":0}},{"line":1954,"address":[16310288,16310423],"length":1,"stats":{"Line":0}},{"line":1959,"address":[16310315],"length":1,"stats":{"Line":0}},{"line":1963,"address":[16306879,16306800],"length":1,"stats":{"Line":0}},{"line":1964,"address":[16306821],"length":1,"stats":{"Line":0}},{"line":1968,"address":[16329990,16329824],"length":1,"stats":{"Line":0}},{"line":1974,"address":[16329848],"length":1,"stats":{"Line":0}},{"line":1978,"address":[16327936,16328094],"length":1,"stats":{"Line":0}},{"line":1984,"address":[16328031],"length":1,"stats":{"Line":0}}],"covered":226,"coverable":744},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","notifications.rs"],"content":"use crate::bid::Bid;\nuse crate::invoice::{Invoice, InvoiceStatus};\nuse soroban_sdk::{contracttype, symbol_short, Address, Bytes, BytesN, Env, Map, String, Vec};\n\n/// Notification types for different events\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum NotificationType {\n    InvoiceCreated,\n    InvoiceVerified,\n    InvoiceStatusChanged,\n    BidReceived,\n    BidAccepted,\n    PaymentReceived,\n    PaymentOverdue,\n    InvoiceDefaulted,\n    SystemAlert,\n    General,\n}\n\n/// Notification priority levels\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum NotificationPriority {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Notification delivery status\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum NotificationDeliveryStatus {\n    Pending,\n    Sent,\n    Delivered,\n    Failed,\n    Read,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum DataKey {\n    UserNotifications(Address),\n    UserPreferences(Address),\n    Notification(BytesN\u003c32\u003e),\n    NotificationType(NotificationType),\n}\n\n/// Notification statistics\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct NotificationStats {\n    pub total_sent: u32,\n    pub total_delivered: u32,\n    pub total_read: u32,\n    pub total_failed: u32,\n}\n\n/// Notification data structure\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct Notification {\n    pub id: BytesN\u003c32\u003e,\n    pub recipient: Address,\n    pub notification_type: NotificationType,\n    pub priority: NotificationPriority,\n    pub title: String,\n    pub message: String,\n    pub related_invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    pub created_at: u64,\n    pub delivery_status: NotificationDeliveryStatus,\n    pub delivered_at: Option\u003cu64\u003e,\n    pub read_at: Option\u003cu64\u003e,\n    pub metadata: Map\u003cString, String\u003e,\n}\n\nimpl Notification {\n    /// Create a new notification\n    pub fn new(\n        env: \u0026Env,\n        recipient: Address,\n        notification_type: NotificationType,\n        priority: NotificationPriority,\n        title: String,\n        message: String,\n        related_invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    ) -\u003e Self {\n        let id = env.crypto().keccak256(\u0026Bytes::from_array(\n            \u0026env,\n            \u0026env.ledger().timestamp().to_be_bytes(),\n        ));\n        let created_at = env.ledger().timestamp();\n\n        Self {\n            id: id.into(),\n            recipient,\n            notification_type,\n            priority,\n            title,\n            message,\n            related_invoice_id,\n            created_at,\n            delivery_status: NotificationDeliveryStatus::Pending,\n            delivered_at: None,\n            read_at: None,\n            metadata: Map::new(env),\n        }\n    }\n\n    /// Mark notification as sent\n    pub fn mark_as_sent(\u0026mut self, timestamp: u64) {\n        self.delivery_status = NotificationDeliveryStatus::Sent;\n        self.delivered_at = Some(timestamp);\n    }\n\n    /// Mark notification as delivered\n    pub fn mark_as_delivered(\u0026mut self, timestamp: u64) {\n        self.delivery_status = NotificationDeliveryStatus::Delivered;\n        if self.delivered_at.is_none() {\n            self.delivered_at = Some(timestamp);\n        }\n    }\n\n    /// Mark notification as read\n    pub fn mark_as_read(\u0026mut self, timestamp: u64) {\n        self.delivery_status = NotificationDeliveryStatus::Read;\n        self.read_at = Some(timestamp);\n    }\n\n    /// Mark notification as failed\n    pub fn mark_as_failed(\u0026mut self) {\n        self.delivery_status = NotificationDeliveryStatus::Failed;\n    }\n}\n\n/// User notification preferences\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct NotificationPreferences {\n    pub user: Address,\n    pub invoice_created: bool,\n    pub invoice_verified: bool,\n    pub invoice_status_changed: bool,\n    pub bid_received: bool,\n    pub bid_accepted: bool,\n    pub payment_received: bool,\n    pub payment_overdue: bool,\n    pub invoice_defaulted: bool,\n    pub system_alerts: bool,\n    pub general: bool,\n    pub minimum_priority: NotificationPriority,\n    pub updated_at: u64,\n}\n\nimpl NotificationPreferences {\n    /// Create default notification preferences for a user\n    pub fn default_for_user(env: \u0026Env, user: Address) -\u003e Self {\n        Self {\n            user,\n            invoice_created: true,\n            invoice_verified: true,\n            invoice_status_changed: true,\n            bid_received: true,\n            bid_accepted: true,\n            payment_received: true,\n            payment_overdue: true,\n            invoice_defaulted: true,\n            system_alerts: true,\n            general: false,\n            minimum_priority: NotificationPriority::Medium,\n            updated_at: env.ledger().timestamp(),\n        }\n    }\n\n    /// Check if user wants notifications for a specific type\n    pub fn should_notify(\n        \u0026self,\n        notification_type: \u0026NotificationType,\n        priority: \u0026NotificationPriority,\n    ) -\u003e bool {\n        // Check minimum priority first\n        let priority_check = match (\u0026self.minimum_priority, priority) {\n            (NotificationPriority::Critical, NotificationPriority::Critical) =\u003e true,\n            (\n                NotificationPriority::High,\n                NotificationPriority::High | NotificationPriority::Critical,\n            ) =\u003e true,\n            (\n                NotificationPriority::Medium,\n                NotificationPriority::Medium\n                | NotificationPriority::High\n                | NotificationPriority::Critical,\n            ) =\u003e true,\n            (NotificationPriority::Low, _) =\u003e true,\n            _ =\u003e false,\n        };\n\n        if !priority_check {\n            return false;\n        }\n\n        // Check notification type preferences\n        match notification_type {\n            NotificationType::InvoiceCreated =\u003e self.invoice_created,\n            NotificationType::InvoiceVerified =\u003e self.invoice_verified,\n            NotificationType::InvoiceStatusChanged =\u003e self.invoice_status_changed,\n            NotificationType::BidReceived =\u003e self.bid_received,\n            NotificationType::BidAccepted =\u003e self.bid_accepted,\n            NotificationType::PaymentReceived =\u003e self.payment_received,\n            NotificationType::PaymentOverdue =\u003e self.payment_overdue,\n            NotificationType::InvoiceDefaulted =\u003e self.invoice_defaulted,\n            NotificationType::SystemAlert =\u003e self.system_alerts,\n            NotificationType::General =\u003e self.general,\n        }\n    }\n}\n\n/// Main notification system\npub struct NotificationSystem;\n\nimpl NotificationSystem {\n    /// Create and store a notification\n    pub fn create_notification(\n        env: \u0026Env,\n        recipient: Address,\n        notification_type: NotificationType,\n        priority: NotificationPriority,\n        title: String,\n        message: String,\n        related_invoice_id: Option\u003cBytesN\u003c32\u003e\u003e,\n    ) -\u003e Result\u003cBytesN\u003c32\u003e, crate::errors::QuickLendXError\u003e {\n        // Check if user wants this type of notification\n        let preferences = Self::get_user_preferences(env, \u0026recipient);\n        if !preferences.should_notify(\u0026notification_type, \u0026priority) {\n            return Err(crate::errors::QuickLendXError::NotificationBlocked);\n        }\n\n        // Create notification\n        let notification = Notification::new(\n            env,\n            recipient.clone(),\n            notification_type.clone(),\n            priority.clone(),\n            title,\n            message,\n            related_invoice_id,\n        );\n\n        // Store notification\n        Self::store_notification(env, \u0026notification);\n\n        // Add to user's notification list\n        Self::add_to_user_notifications(env, \u0026recipient, \u0026notification.id);\n\n        // Emit notification event\n        env.events().publish(\n            (symbol_short!(\"notif\"),),\n            (\n                notification.id.clone(),\n                recipient,\n                notification_type,\n                priority,\n            ),\n        );\n\n        Ok(notification.id)\n    }\n\n    /// Store a notification\n    fn store_notification(env: \u0026Env, notification: \u0026Notification) {\n        let key = Self::get_notification_key(\u0026notification.id);\n        env.storage().instance().set(\u0026key, notification);\n    }\n\n    /// Get a notification by ID\n    pub fn get_notification(env: \u0026Env, notification_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cNotification\u003e {\n        let key = Self::get_notification_key(notification_id);\n        env.storage().instance().get(\u0026key)\n    }\n\n    /// Update notification status\n    pub fn update_notification_status(\n        env: \u0026Env,\n        notification_id: \u0026BytesN\u003c32\u003e,\n        status: NotificationDeliveryStatus,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let mut notification = Self::get_notification(env, notification_id)\n            .ok_or(crate::errors::QuickLendXError::NotificationNotFound)?;\n\n        let timestamp = env.ledger().timestamp();\n\n        match status {\n            NotificationDeliveryStatus::Sent =\u003e notification.mark_as_sent(timestamp),\n            NotificationDeliveryStatus::Delivered =\u003e notification.mark_as_delivered(timestamp),\n            NotificationDeliveryStatus::Read =\u003e notification.mark_as_read(timestamp),\n            NotificationDeliveryStatus::Failed =\u003e notification.mark_as_failed(),\n            _ =\u003e {}\n        }\n\n        Self::store_notification(env, \u0026notification);\n\n        // Emit status update event\n        env.events().publish(\n            (symbol_short!(\"n_status\"),),\n            (notification_id.clone(), status),\n        );\n\n        Ok(())\n    }\n\n    /// Get user notifications\n    pub fn get_user_notifications(env: \u0026Env, user: \u0026Address) -\u003e Vec\u003cBytesN\u003c32\u003e\u003e {\n        let key = Self::get_user_notifications_key(user);\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| Vec::new(env))\n    }\n\n    /// Get user notification preferences\n    pub fn get_user_preferences(env: \u0026Env, user: \u0026Address) -\u003e NotificationPreferences {\n        let key = DataKey::UserPreferences(user.clone());\n        env.storage()\n            .instance()\n            .get(\u0026key)\n            .unwrap_or_else(|| NotificationPreferences::default_for_user(env, user.clone()))\n    }\n\n    /// Update user notification preferences\n    pub fn update_user_preferences(\n        env: \u0026Env,\n        user: \u0026Address,\n        preferences: NotificationPreferences,\n    ) {\n        let key = DataKey::UserPreferences(user.clone());\n        env.storage().instance().set(\u0026key, \u0026preferences);\n\n        // Emit preferences update event\n        env.events()\n            .publish((symbol_short!(\"pref_up\"),), (user.clone(),));\n    }\n\n    /// Get notification statistics for a user\n    pub fn get_user_notification_stats(env: \u0026Env, user: \u0026Address) -\u003e NotificationStats {\n        let notifications = Self::get_user_notifications(env, user);\n        let mut stats = NotificationStats {\n            total_sent: 0,\n            total_delivered: 0,\n            total_read: 0,\n            total_failed: 0,\n        };\n\n        for notification_id in notifications.iter() {\n            if let Some(notification) = Self::get_notification(env, \u0026notification_id) {\n                match notification.delivery_status {\n                    NotificationDeliveryStatus::Sent =\u003e stats.total_sent += 1,\n                    NotificationDeliveryStatus::Delivered =\u003e {\n                        stats.total_sent += 1;\n                        stats.total_delivered += 1;\n                    }\n                    NotificationDeliveryStatus::Read =\u003e {\n                        stats.total_sent += 1;\n                        stats.total_delivered += 1;\n                        stats.total_read += 1;\n                    }\n                    NotificationDeliveryStatus::Failed =\u003e stats.total_failed += 1,\n                    _ =\u003e {}\n                }\n            }\n        }\n\n        stats\n    }\n\n    // Storage key helpers\n    fn get_notification_key(notification_id: \u0026BytesN\u003c32\u003e) -\u003e DataKey {\n        DataKey::Notification(notification_id.clone())\n    }\n\n    fn get_user_notifications_key(user: \u0026Address) -\u003e DataKey {\n        DataKey::UserNotifications(user.clone())\n    }\n\n    // Helper methods for adding to lists\n    fn add_to_user_notifications(env: \u0026Env, user: \u0026Address, notification_id: \u0026BytesN\u003c32\u003e) {\n        let key = Self::get_user_notifications_key(user);\n        let mut notifications = Self::get_user_notifications(env, user);\n        notifications.push_back(notification_id.clone());\n        env.storage().instance().set(\u0026key, \u0026notifications);\n    }\n}\n\n// Notification helper functions for common scenarios\nimpl NotificationSystem {\n    /// Create invoice created notification\n    pub fn notify_invoice_created(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Created\");\n        let message = String::from_str(\n            env,\n            \"Your invoice has been successfully created and is pending verification\",\n        );\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceCreated,\n            NotificationPriority::Medium,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create invoice verified notification\n    pub fn notify_invoice_verified(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Verified\");\n        let message = String::from_str(\n            env,\n            \"Your invoice has been verified and is now available for funding\",\n        );\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceVerified,\n            NotificationPriority::High,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create invoice status changed notification\n    pub fn notify_invoice_status_changed(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        old_status: \u0026InvoiceStatus,\n        new_status: \u0026InvoiceStatus,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Status Updated\");\n\n        let status_text = match (old_status, new_status) {\n            (InvoiceStatus::Pending, InvoiceStatus::Verified) =\u003e {\n                \"Your invoice has been verified and is now available for funding\"\n            }\n            (InvoiceStatus::Verified, InvoiceStatus::Funded) =\u003e {\n                \"Your invoice has been funded by an investor\"\n            }\n            (InvoiceStatus::Funded, InvoiceStatus::Paid) =\u003e {\n                \"Your invoice has been paid successfully\"\n            }\n            (_, InvoiceStatus::Defaulted) =\u003e \"Your invoice has been marked as defaulted\",\n            _ =\u003e \"Your invoice status has been updated\",\n        };\n\n        let message = String::from_str(env, status_text);\n\n        let priority = match new_status {\n            InvoiceStatus::Funded | InvoiceStatus::Paid =\u003e NotificationPriority::High,\n            InvoiceStatus::Defaulted =\u003e NotificationPriority::Critical,\n            _ =\u003e NotificationPriority::Medium,\n        };\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceStatusChanged,\n            priority.clone(),\n            title.clone(),\n            message.clone(),\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor if applicable\n        if let Some(investor) = \u0026invoice.investor {\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::InvoiceStatusChanged,\n                priority,\n                title,\n                message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n        Ok(())\n    }\n\n    /// Create payment overdue notification\n    pub fn notify_payment_overdue(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Payment Overdue\");\n        let message = String::from_str(env, \"Your invoice payment is overdue\");\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::PaymentOverdue,\n            NotificationPriority::Critical,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor\n        if let Some(investor) = \u0026invoice.investor {\n            let investor_title = String::from_str(env, \"Invoice Payment Overdue\");\n            let investor_message =\n                String::from_str(env, \"An invoice you funded has an overdue payment\");\n\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::PaymentOverdue,\n                NotificationPriority::Critical,\n                investor_title,\n                investor_message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n\n        Ok(())\n    }\n\n    /// Create bid received notification for business\n    pub fn notify_bid_received(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        _: \u0026Bid, //bid\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"New Bid Received\");\n        let message = String::from_str(env, \"A new bid has been placed on your invoice\");\n\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::BidReceived,\n            NotificationPriority::Medium,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create bid accepted notification for investor\n    pub fn notify_bid_accepted(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        bid: \u0026Bid,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Bid Accepted\");\n        let message = String::from_str(\n            env,\n            \"Your bid has been accepted and funds are being escrowed\",\n        );\n\n        Self::create_notification(\n            env,\n            bid.investor.clone(),\n            NotificationType::BidAccepted,\n            NotificationPriority::High,\n            title,\n            message,\n            Some(invoice.id.clone()),\n        )?;\n\n        Ok(())\n    }\n\n    /// Create payment received notification\n    pub fn notify_payment_received(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n        _: i128, //amount\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Payment Received\");\n        let message = String::from_str(env, \"Payment has been received for your invoice\");\n\n        // Notify business\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::PaymentReceived,\n            NotificationPriority::High,\n            title.clone(),\n            message.clone(),\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor if applicable\n        if let Some(investor) = \u0026invoice.investor {\n            let investor_title = String::from_str(env, \"Investment Payment Received\");\n            let investor_message =\n                String::from_str(env, \"Payment has been received for an invoice you funded\");\n\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::PaymentReceived,\n                NotificationPriority::High,\n                investor_title,\n                investor_message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n\n        Ok(())\n    }\n\n    /// Create invoice defaulted notification\n    pub fn notify_invoice_defaulted(\n        env: \u0026Env,\n        invoice: \u0026Invoice,\n    ) -\u003e Result\u003c(), crate::errors::QuickLendXError\u003e {\n        let title = String::from_str(env, \"Invoice Defaulted\");\n        let message = String::from_str(env, \"Your invoice has been marked as defaulted\");\n\n        // Notify business\n        Self::create_notification(\n            env,\n            invoice.business.clone(),\n            NotificationType::InvoiceDefaulted,\n            NotificationPriority::Critical,\n            title.clone(),\n            message.clone(),\n            Some(invoice.id.clone()),\n        )?;\n\n        // Notify investor if applicable\n        if let Some(investor) = \u0026invoice.investor {\n            let investor_title = String::from_str(env, \"Investment Defaulted\");\n            let investor_message = String::from_str(env, \"An invoice you funded has defaulted\");\n\n            Self::create_notification(\n                env,\n                investor.clone(),\n                NotificationType::InvoiceDefaulted,\n                NotificationPriority::Critical,\n                investor_title,\n                investor_message,\n                Some(invoice.id.clone()),\n            )?;\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":81,"address":[15619748,15619932,15618352],"length":1,"stats":{"Line":2}},{"line":90,"address":[15618435,15618766],"length":1,"stats":{"Line":3}},{"line":91,"address":[15618568],"length":1,"stats":{"Line":2}},{"line":92,"address":[15618586,15618634,15618704],"length":1,"stats":{"Line":4}},{"line":94,"address":[15619037],"length":1,"stats":{"Line":1}},{"line":97,"address":[15619152],"length":1,"stats":{"Line":2}},{"line":108,"address":[15619424],"length":1,"stats":{"Line":1}},{"line":113,"address":[15618224],"length":1,"stats":{"Line":0}},{"line":114,"address":[15618234],"length":1,"stats":{"Line":0}},{"line":115,"address":[15618241],"length":1,"stats":{"Line":0}},{"line":119,"address":[15618272],"length":1,"stats":{"Line":0}},{"line":120,"address":[15618296],"length":1,"stats":{"Line":0}},{"line":121,"address":[15618303,15618339],"length":1,"stats":{"Line":0}},{"line":122,"address":[15618328],"length":1,"stats":{"Line":0}},{"line":127,"address":[15618192],"length":1,"stats":{"Line":0}},{"line":128,"address":[15618202],"length":1,"stats":{"Line":0}},{"line":129,"address":[15618209],"length":1,"stats":{"Line":0}},{"line":133,"address":[15618256],"length":1,"stats":{"Line":0}},{"line":134,"address":[15618261],"length":1,"stats":{"Line":0}},{"line":159,"address":[15645984,15646277,15646255],"length":1,"stats":{"Line":2}},{"line":173,"address":[15646088,15646040],"length":1,"stats":{"Line":3}},{"line":178,"address":[15645600],"length":1,"stats":{"Line":2}},{"line":184,"address":[15645630,15645674],"length":1,"stats":{"Line":3}},{"line":186,"address":[15645752],"length":1,"stats":{"Line":0}},{"line":190,"address":[15645745],"length":1,"stats":{"Line":1}},{"line":196,"address":[15645662],"length":1,"stats":{"Line":0}},{"line":197,"address":[15645738],"length":1,"stats":{"Line":0}},{"line":200,"address":[15645729],"length":1,"stats":{"Line":2}},{"line":201,"address":[15645759],"length":1,"stats":{"Line":0}},{"line":205,"address":[15645771,15645660],"length":1,"stats":{"Line":1}},{"line":206,"address":[15645812],"length":1,"stats":{"Line":0}},{"line":207,"address":[15645828],"length":1,"stats":{"Line":2}},{"line":208,"address":[15645844],"length":1,"stats":{"Line":2}},{"line":209,"address":[15645860],"length":1,"stats":{"Line":1}},{"line":210,"address":[15645876],"length":1,"stats":{"Line":3}},{"line":211,"address":[15645892],"length":1,"stats":{"Line":2}},{"line":212,"address":[15645908],"length":1,"stats":{"Line":0}},{"line":213,"address":[15645924],"length":1,"stats":{"Line":0}},{"line":214,"address":[15645943],"length":1,"stats":{"Line":0}},{"line":215,"address":[15645962],"length":1,"stats":{"Line":0}},{"line":225,"address":[15622537,15620752,15622415],"length":1,"stats":{"Line":2}},{"line":235,"address":[15620829],"length":1,"stats":{"Line":1}},{"line":236,"address":[15621026,15620977],"length":1,"stats":{"Line":2}},{"line":237,"address":[15621037],"length":1,"stats":{"Line":0}},{"line":243,"address":[15621271,15621072],"length":1,"stats":{"Line":3}},{"line":244,"address":[15621284],"length":1,"stats":{"Line":1}},{"line":245,"address":[15621341],"length":1,"stats":{"Line":2}},{"line":246,"address":[15621380],"length":1,"stats":{"Line":1}},{"line":247,"address":[15621426],"length":1,"stats":{"Line":2}},{"line":248,"address":[15621469],"length":1,"stats":{"Line":1}},{"line":252,"address":[15621605],"length":1,"stats":{"Line":2}},{"line":255,"address":[15621662],"length":1,"stats":{"Line":1}},{"line":258,"address":[15621690,15621984],"length":1,"stats":{"Line":4}},{"line":259,"address":[15621697],"length":1,"stats":{"Line":2}},{"line":261,"address":[15621750],"length":1,"stats":{"Line":3}},{"line":262,"address":[15621823],"length":1,"stats":{"Line":3}},{"line":268,"address":[15622055],"length":1,"stats":{"Line":3}},{"line":272,"address":[15620738,15620732,15620464],"length":1,"stats":{"Line":1}},{"line":273,"address":[15620496],"length":1,"stats":{"Line":2}},{"line":274,"address":[15620564,15620520],"length":1,"stats":{"Line":3}},{"line":278,"address":[15620431,15620064,15620437],"length":1,"stats":{"Line":0}},{"line":279,"address":[15620118],"length":1,"stats":{"Line":0}},{"line":280,"address":[15620180,15620256,15620136],"length":1,"stats":{"Line":0}},{"line":284,"address":[15635837,15635831,15634976],"length":1,"stats":{"Line":0}},{"line":289,"address":[15635028,15635411,15635075,15635138],"length":1,"stats":{"Line":0}},{"line":290,"address":[15635124,15635049],"length":1,"stats":{"Line":0}},{"line":292,"address":[15635283,15635239],"length":1,"stats":{"Line":0}},{"line":294,"address":[15635384],"length":1,"stats":{"Line":0}},{"line":295,"address":[15635423,15635493],"length":1,"stats":{"Line":0}},{"line":296,"address":[15635440,15635495],"length":1,"stats":{"Line":0}},{"line":297,"address":[15635499,15635469],"length":1,"stats":{"Line":0}},{"line":298,"address":[15635497,15635452],"length":1,"stats":{"Line":0}},{"line":302,"address":[15635486],"length":1,"stats":{"Line":0}},{"line":305,"address":[15635514,15635698],"length":1,"stats":{"Line":0}},{"line":306,"address":[15635526],"length":1,"stats":{"Line":0}},{"line":307,"address":[15635643,15635579],"length":1,"stats":{"Line":0}},{"line":310,"address":[15635764],"length":1,"stats":{"Line":0}},{"line":314,"address":[15625614,15625608,15625200],"length":1,"stats":{"Line":1}},{"line":315,"address":[15625254],"length":1,"stats":{"Line":2}},{"line":316,"address":[15625272],"length":1,"stats":{"Line":1}},{"line":318,"address":[15625398],"length":1,"stats":{"Line":2}},{"line":319,"address":[12717136,12717153],"length":1,"stats":{"Line":4}},{"line":323,"address":[15625185,15625179,15624720],"length":1,"stats":{"Line":2}},{"line":324,"address":[15624776],"length":1,"stats":{"Line":1}},{"line":325,"address":[15624832],"length":1,"stats":{"Line":2}},{"line":327,"address":[15624961],"length":1,"stats":{"Line":1}},{"line":328,"address":[12717082,12717040],"length":1,"stats":{"Line":4}},{"line":332,"address":[15631744,15632415],"length":1,"stats":{"Line":0}},{"line":337,"address":[15631844,15631782],"length":1,"stats":{"Line":0}},{"line":338,"address":[15631928,15631887],"length":1,"stats":{"Line":0}},{"line":341,"address":[15632113,15632282],"length":1,"stats":{"Line":0}},{"line":342,"address":[15632378,15632314,15632125],"length":1,"stats":{"Line":0}},{"line":346,"address":[15635856,15636878,15636884],"length":1,"stats":{"Line":0}},{"line":347,"address":[15635904],"length":1,"stats":{"Line":0}},{"line":355,"address":[15636024,15635960,15636117,15636442],"length":1,"stats":{"Line":0}},{"line":356,"address":[15636328,15636213],"length":1,"stats":{"Line":0}},{"line":357,"address":[15636386],"length":1,"stats":{"Line":0}},{"line":358,"address":[15636566,15636444],"length":1,"stats":{"Line":0}},{"line":359,"address":[15636685],"length":1,"stats":{"Line":0}},{"line":360,"address":[15636636,15636659,15636463],"length":1,"stats":{"Line":0}},{"line":361,"address":[15636690,15636640,15636681],"length":1,"stats":{"Line":0}},{"line":363,"address":[15636852],"length":1,"stats":{"Line":0}},{"line":364,"address":[15636746,15636769,15636518],"length":1,"stats":{"Line":0}},{"line":365,"address":[15636820,15636794,15636750],"length":1,"stats":{"Line":0}},{"line":366,"address":[15636857,15636798,15636845],"length":1,"stats":{"Line":0}},{"line":368,"address":[15636712,15636489],"length":1,"stats":{"Line":0}},{"line":374,"address":[15636240],"length":1,"stats":{"Line":0}},{"line":378,"address":[15624640],"length":1,"stats":{"Line":1}},{"line":379,"address":[15624658],"length":1,"stats":{"Line":2}},{"line":382,"address":[15634896],"length":1,"stats":{"Line":2}},{"line":383,"address":[15634914],"length":1,"stats":{"Line":1}},{"line":387,"address":[15634448,15634873,15634879],"length":1,"stats":{"Line":2}},{"line":388,"address":[15634498],"length":1,"stats":{"Line":1}},{"line":389,"address":[15634518],"length":1,"stats":{"Line":2}},{"line":390,"address":[15634623,15634566],"length":1,"stats":{"Line":3}},{"line":391,"address":[15634660],"length":1,"stats":{"Line":2}},{"line":398,"address":[15626611,15626530,15625632],"length":1,"stats":{"Line":0}},{"line":402,"address":[15625671],"length":1,"stats":{"Line":0}},{"line":410,"address":[15625886,15625824],"length":1,"stats":{"Line":0}},{"line":413,"address":[15625894],"length":1,"stats":{"Line":0}},{"line":414,"address":[15625949],"length":1,"stats":{"Line":0}},{"line":415,"address":[15626007,15626076],"length":1,"stats":{"Line":0}},{"line":418,"address":[15626437],"length":1,"stats":{"Line":0}},{"line":422,"address":[15628704,15629686,15629605],"length":1,"stats":{"Line":2}},{"line":426,"address":[15628743],"length":1,"stats":{"Line":1}},{"line":434,"address":[15628896,15628958],"length":1,"stats":{"Line":3}},{"line":437,"address":[15628966],"length":1,"stats":{"Line":1}},{"line":438,"address":[15629021],"length":1,"stats":{"Line":1}},{"line":439,"address":[15629148,15629079],"length":1,"stats":{"Line":3}},{"line":442,"address":[15629512],"length":1,"stats":{"Line":3}},{"line":446,"address":[15638891,15639190,15636912],"length":1,"stats":{"Line":1}},{"line":452,"address":[15636977],"length":1,"stats":{"Line":1}},{"line":454,"address":[15637076],"length":1,"stats":{"Line":2}},{"line":456,"address":[15637188],"length":1,"stats":{"Line":0}},{"line":459,"address":[15637254],"length":1,"stats":{"Line":1}},{"line":462,"address":[15637283],"length":1,"stats":{"Line":0}},{"line":464,"address":[15637312],"length":1,"stats":{"Line":0}},{"line":465,"address":[15637341],"length":1,"stats":{"Line":0}},{"line":468,"address":[15637220,15637419],"length":1,"stats":{"Line":3}},{"line":470,"address":[15637427],"length":1,"stats":{"Line":2}},{"line":471,"address":[15637470],"length":1,"stats":{"Line":1}},{"line":472,"address":[15637480],"length":1,"stats":{"Line":0}},{"line":473,"address":[15637460],"length":1,"stats":{"Line":0}},{"line":478,"address":[15637553,15637493],"length":1,"stats":{"Line":3}},{"line":480,"address":[15637569],"length":1,"stats":{"Line":2}},{"line":481,"address":[15637631],"length":1,"stats":{"Line":1}},{"line":482,"address":[15637662,15637712],"length":1,"stats":{"Line":3}},{"line":483,"address":[15637790,15637720],"length":1,"stats":{"Line":3}},{"line":487,"address":[15638157],"length":1,"stats":{"Line":1}},{"line":490,"address":[15638218,15638257],"length":1,"stats":{"Line":4}},{"line":492,"address":[15638265],"length":1,"stats":{"Line":1}},{"line":493,"address":[15638276],"length":1,"stats":{"Line":2}},{"line":494,"address":[15638334],"length":1,"stats":{"Line":1}},{"line":495,"address":[15638471,15638398],"length":1,"stats":{"Line":3}},{"line":498,"address":[15638225],"length":1,"stats":{"Line":2}},{"line":502,"address":[15626640,15628428,15628665],"length":1,"stats":{"Line":0}},{"line":506,"address":[15626679],"length":1,"stats":{"Line":0}},{"line":507,"address":[15626794,15626864],"length":1,"stats":{"Line":0}},{"line":511,"address":[15626934,15626872],"length":1,"stats":{"Line":0}},{"line":514,"address":[15626942],"length":1,"stats":{"Line":0}},{"line":515,"address":[15626997],"length":1,"stats":{"Line":0}},{"line":516,"address":[15627058,15627127],"length":1,"stats":{"Line":0}},{"line":520,"address":[15627496,15628347],"length":1,"stats":{"Line":0}},{"line":521,"address":[15627615,15627554],"length":1,"stats":{"Line":0}},{"line":522,"address":[15627623,15627696],"length":1,"stats":{"Line":0}},{"line":527,"address":[15627712,15627762],"length":1,"stats":{"Line":0}},{"line":530,"address":[15627770],"length":1,"stats":{"Line":0}},{"line":531,"address":[15627834],"length":1,"stats":{"Line":0}},{"line":532,"address":[15627898,15627967],"length":1,"stats":{"Line":0}},{"line":536,"address":[15627581],"length":1,"stats":{"Line":0}},{"line":540,"address":[15624606,15623616,15624525],"length":1,"stats":{"Line":3}},{"line":545,"address":[15623663],"length":1,"stats":{"Line":3}},{"line":546,"address":[15623808,15623738],"length":1,"stats":{"Line":6}},{"line":550,"address":[15623816,15623878],"length":1,"stats":{"Line":3}},{"line":553,"address":[15623886],"length":1,"stats":{"Line":2}},{"line":554,"address":[15623941],"length":1,"stats":{"Line":1}},{"line":555,"address":[15623999,15624068],"length":1,"stats":{"Line":3}},{"line":558,"address":[15624432],"length":1,"stats":{"Line":2}},{"line":562,"address":[15623496,15622576,15623577],"length":1,"stats":{"Line":3}},{"line":567,"address":[15622628],"length":1,"stats":{"Line":3}},{"line":575,"address":[15622846,15622781],"length":1,"stats":{"Line":6}},{"line":578,"address":[15622854],"length":1,"stats":{"Line":3}},{"line":579,"address":[15622909],"length":1,"stats":{"Line":3}},{"line":580,"address":[15623039,15622970],"length":1,"stats":{"Line":6}},{"line":583,"address":[15623403],"length":1,"stats":{"Line":3}},{"line":587,"address":[15631509,15629728,15631730],"length":1,"stats":{"Line":1}},{"line":592,"address":[15629783],"length":1,"stats":{"Line":1}},{"line":593,"address":[15629874],"length":1,"stats":{"Line":1}},{"line":598,"address":[15629944,15630001],"length":1,"stats":{"Line":2}},{"line":601,"address":[15630067,15630022],"length":1,"stats":{"Line":4}},{"line":602,"address":[15630088,15630138],"length":1,"stats":{"Line":4}},{"line":603,"address":[15630146,15630212],"length":1,"stats":{"Line":4}},{"line":607,"address":[15631430,15630581],"length":1,"stats":{"Line":3}},{"line":608,"address":[15630698,15630639],"length":1,"stats":{"Line":2}},{"line":609,"address":[15630706,15630779],"length":1,"stats":{"Line":2}},{"line":614,"address":[15630845,15630795],"length":1,"stats":{"Line":2}},{"line":617,"address":[15630853],"length":1,"stats":{"Line":1}},{"line":618,"address":[15630917],"length":1,"stats":{"Line":1}},{"line":619,"address":[15631050,15630981],"length":1,"stats":{"Line":2}},{"line":623,"address":[15630666],"length":1,"stats":{"Line":1}},{"line":627,"address":[15634434,15632448,15634213],"length":1,"stats":{"Line":0}},{"line":631,"address":[15632487],"length":1,"stats":{"Line":0}},{"line":632,"address":[15632578],"length":1,"stats":{"Line":0}},{"line":637,"address":[15632705,15632648],"length":1,"stats":{"Line":0}},{"line":640,"address":[15632726,15632771],"length":1,"stats":{"Line":0}},{"line":641,"address":[15632842,15632792],"length":1,"stats":{"Line":0}},{"line":642,"address":[15632850,15632916],"length":1,"stats":{"Line":0}},{"line":646,"address":[15634134,15633285],"length":1,"stats":{"Line":0}},{"line":647,"address":[15633402,15633343],"length":1,"stats":{"Line":0}},{"line":648,"address":[15633483,15633410],"length":1,"stats":{"Line":0}},{"line":652,"address":[15633549,15633499],"length":1,"stats":{"Line":0}},{"line":655,"address":[15633557],"length":1,"stats":{"Line":0}},{"line":656,"address":[15633621],"length":1,"stats":{"Line":0}},{"line":657,"address":[15633685,15633754],"length":1,"stats":{"Line":0}},{"line":661,"address":[15633370],"length":1,"stats":{"Line":0}}],"covered":113,"coverable":215},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","payments.rs"],"content":"use crate::errors::QuickLendXError;\nuse soroban_sdk::token;\nuse soroban_sdk::{contracttype, symbol_short, Address, BytesN, Env};\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub enum EscrowStatus {\n    Held,     // Funds are held in escrow\n    Released, // Funds released to business\n    Refunded, // Funds refunded to investor\n}\n\n#[contracttype]\n#[derive(Clone, Debug, Eq, PartialEq)]\npub struct Escrow {\n    pub escrow_id: BytesN\u003c32\u003e,\n    pub invoice_id: BytesN\u003c32\u003e,\n    pub investor: Address,\n    pub business: Address,\n    pub amount: i128,\n    pub currency: Address,\n    pub created_at: u64,\n    pub status: EscrowStatus,\n}\n\npub struct EscrowStorage;\n\nimpl EscrowStorage {\n    pub fn store_escrow(env: \u0026Env, escrow: \u0026Escrow) {\n        env.storage().instance().set(\u0026escrow.escrow_id, escrow);\n        // Also store by invoice_id for easy lookup\n        env.storage().instance().set(\n            \u0026(symbol_short!(\"escrow\"), \u0026escrow.invoice_id),\n            \u0026escrow.escrow_id,\n        );\n    }\n\n    pub fn get_escrow(env: \u0026Env, escrow_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cEscrow\u003e {\n        env.storage().instance().get(escrow_id)\n    }\n\n    pub fn get_escrow_by_invoice(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Option\u003cEscrow\u003e {\n        let escrow_id: Option\u003cBytesN\u003c32\u003e\u003e = env\n            .storage()\n            .instance()\n            .get(\u0026(symbol_short!(\"escrow\"), invoice_id));\n        if let Some(id) = escrow_id {\n            Self::get_escrow(env, \u0026id)\n        } else {\n            None\n        }\n    }\n\n    pub fn update_escrow(env: \u0026Env, escrow: \u0026Escrow) {\n        env.storage().instance().set(\u0026escrow.escrow_id, escrow);\n    }\n\n    pub fn generate_unique_escrow_id(env: \u0026Env) -\u003e BytesN\u003c32\u003e {\n        let timestamp = env.ledger().timestamp();\n        let counter_key = symbol_short!(\"esc_cnt\");\n        let counter: u64 = env.storage().instance().get(\u0026counter_key).unwrap_or(0u64);\n        env.storage().instance().set(\u0026counter_key, \u0026(counter + 1));\n\n        let mut id_bytes = [0u8; 32];\n        // Add escrow prefix to distinguish from other entity types\n        id_bytes[0] = 0xE5; // 'E' for Escrow\n        id_bytes[1] = 0xC0; // 'C' for sCrow\n                            // Embed timestamp in next 8 bytes\n        id_bytes[2..10].copy_from_slice(\u0026timestamp.to_be_bytes());\n        // Embed counter in next 8 bytes\n        id_bytes[10..18].copy_from_slice(\u0026counter.to_be_bytes());\n        // Fill remaining bytes with a pattern to ensure uniqueness\n        for i in 18..32 {\n            id_bytes[i] = ((timestamp + counter + 0xE5C0) % 256) as u8;\n        }\n\n        BytesN::from_array(env, \u0026id_bytes)\n    }\n}\n\n/// Create escrow when bid is accepted\npub fn create_escrow(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    investor: \u0026Address,\n    business: \u0026Address,\n    amount: i128,\n    currency: \u0026Address,\n) -\u003e Result\u003cBytesN\u003c32\u003e, QuickLendXError\u003e {\n    if amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Move funds from investor into contract-controlled escrow\n    let contract_address = env.current_contract_address();\n    transfer_funds(env, currency, investor, \u0026contract_address, amount)?;\n\n    let escrow_id = EscrowStorage::generate_unique_escrow_id(env);\n    let escrow = Escrow {\n        escrow_id: escrow_id.clone(),\n        invoice_id: invoice_id.clone(),\n        investor: investor.clone(),\n        business: business.clone(),\n        amount,\n        currency: currency.clone(),\n        created_at: env.ledger().timestamp(),\n        status: EscrowStatus::Held,\n    };\n\n    EscrowStorage::store_escrow(env, \u0026escrow);\n    Ok(escrow_id)\n}\n\n/// Release escrow funds to business upon invoice verification\npub fn release_escrow(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    let mut escrow = EscrowStorage::get_escrow_by_invoice(env, invoice_id)\n        .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n    if escrow.status != EscrowStatus::Held {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Transfer funds from escrow (contract) to business\n    let contract_address = env.current_contract_address();\n    transfer_funds(\n        env,\n        \u0026escrow.currency,\n        \u0026contract_address,\n        \u0026escrow.business,\n        escrow.amount,\n    )?;\n\n    // Update escrow status\n    escrow.status = EscrowStatus::Released;\n    EscrowStorage::update_escrow(env, \u0026escrow);\n\n    Ok(())\n}\n\n/// Refund escrow funds to investor if verification fails\npub fn refund_escrow(env: \u0026Env, invoice_id: \u0026BytesN\u003c32\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    let mut escrow = EscrowStorage::get_escrow_by_invoice(env, invoice_id)\n        .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n    if escrow.status != EscrowStatus::Held {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Refund funds from escrow (contract) back to investor\n    let contract_address = env.current_contract_address();\n    transfer_funds(\n        env,\n        \u0026escrow.currency,\n        \u0026contract_address,\n        \u0026escrow.investor,\n        escrow.amount,\n    )?;\n\n    // Update escrow status\n    escrow.status = EscrowStatus::Refunded;\n    EscrowStorage::update_escrow(env, \u0026escrow);\n\n    Ok(())\n}\n\n/// Transfer funds between addresses\npub fn transfer_funds(\n    env: \u0026Env,\n    currency: \u0026Address,\n    from: \u0026Address,\n    to: \u0026Address,\n    amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    if from == to {\n        return Ok(());\n    }\n\n    let token_client = token::Client::new(env, currency);\n    let contract_address = env.current_contract_address();\n\n    // Ensure sufficient balance exists before attempting transfer\n    let available_balance = token_client.balance(from);\n    if available_balance \u003c amount {\n        return Err(QuickLendXError::InsufficientFunds);\n    }\n\n    if from == \u0026contract_address {\n        token_client.transfer(from, to, \u0026amount);\n        return Ok(());\n    }\n\n    let allowance = token_client.allowance(from, \u0026contract_address);\n    if allowance \u003c amount {\n        return Err(QuickLendXError::OperationNotAllowed);\n    }\n\n    token_client.transfer_from(\u0026contract_address, from, to, \u0026amount);\n    Ok(())\n}\n","traces":[{"line":29,"address":[12313080,12313074,12312560],"length":1,"stats":{"Line":1}},{"line":30,"address":[12312609],"length":1,"stats":{"Line":2}},{"line":32,"address":[12312785,12312936],"length":1,"stats":{"Line":3}},{"line":33,"address":[12312859],"length":1,"stats":{"Line":2}},{"line":34,"address":[12312919],"length":1,"stats":{"Line":1}},{"line":38,"address":[12312532,12312320,12312538],"length":1,"stats":{"Line":3}},{"line":39,"address":[12312365,12312447],"length":1,"stats":{"Line":6}},{"line":42,"address":[12313328,12313969,12313985],"length":1,"stats":{"Line":0}},{"line":43,"address":[12313371],"length":1,"stats":{"Line":0}},{"line":46,"address":[12313467,12313418,12314014],"length":1,"stats":{"Line":0}},{"line":47,"address":[12313775,12313883],"length":1,"stats":{"Line":0}},{"line":48,"address":[12313864],"length":1,"stats":{"Line":0}},{"line":50,"address":[12313876],"length":1,"stats":{"Line":0}},{"line":54,"address":[12313303,12313104,12313297],"length":1,"stats":{"Line":0}},{"line":55,"address":[12313142],"length":1,"stats":{"Line":0}},{"line":58,"address":[12315591,12314048,12315597],"length":1,"stats":{"Line":1}},{"line":59,"address":[12314103],"length":1,"stats":{"Line":2}},{"line":60,"address":[12314220],"length":1,"stats":{"Line":1}},{"line":61,"address":[12314324,12314273],"length":1,"stats":{"Line":3}},{"line":62,"address":[12314581],"length":1,"stats":{"Line":2}},{"line":64,"address":[12314836],"length":1,"stats":{"Line":1}},{"line":66,"address":[12314856],"length":1,"stats":{"Line":2}},{"line":67,"address":[12314864],"length":1,"stats":{"Line":1}},{"line":69,"address":[12314872],"length":1,"stats":{"Line":2}},{"line":71,"address":[12315040],"length":1,"stats":{"Line":1}},{"line":73,"address":[12315196,12315555],"length":1,"stats":{"Line":3}},{"line":74,"address":[12315447,12315565,12315359],"length":1,"stats":{"Line":3}},{"line":77,"address":[12315393],"length":1,"stats":{"Line":2}},{"line":82,"address":[12315616,12316966,12317108],"length":1,"stats":{"Line":1}},{"line":90,"address":[12315748],"length":1,"stats":{"Line":2}},{"line":91,"address":[12315838],"length":1,"stats":{"Line":0}},{"line":95,"address":[12315773],"length":1,"stats":{"Line":1}},{"line":96,"address":[12315822,12315898],"length":1,"stats":{"Line":3}},{"line":98,"address":[12315999],"length":1,"stats":{"Line":2}},{"line":100,"address":[12316014],"length":1,"stats":{"Line":1}},{"line":101,"address":[12316087],"length":1,"stats":{"Line":2}},{"line":102,"address":[12316160],"length":1,"stats":{"Line":1}},{"line":103,"address":[12316221],"length":1,"stats":{"Line":2}},{"line":105,"address":[12316282],"length":1,"stats":{"Line":1}},{"line":106,"address":[12316343,12316391],"length":1,"stats":{"Line":3}},{"line":110,"address":[12316816],"length":1,"stats":{"Line":2}},{"line":111,"address":[12316828],"length":1,"stats":{"Line":1}},{"line":115,"address":[12318426,12317792,12318420],"length":1,"stats":{"Line":0}},{"line":116,"address":[12317826,12317927,12317865],"length":1,"stats":{"Line":0}},{"line":117,"address":[12317839,12317913],"length":1,"stats":{"Line":0}},{"line":119,"address":[12318015,12318082],"length":1,"stats":{"Line":0}},{"line":120,"address":[12318112],"length":1,"stats":{"Line":0}},{"line":124,"address":[12318093],"length":1,"stats":{"Line":0}},{"line":127,"address":[12318130],"length":1,"stats":{"Line":0}},{"line":129,"address":[12318138],"length":1,"stats":{"Line":0}},{"line":130,"address":[12318146],"length":1,"stats":{"Line":0}},{"line":134,"address":[12318312],"length":1,"stats":{"Line":0}},{"line":135,"address":[12318325],"length":1,"stats":{"Line":0}},{"line":137,"address":[12318332],"length":1,"stats":{"Line":0}},{"line":141,"address":[12317136,12317764,12317770],"length":1,"stats":{"Line":0}},{"line":142,"address":[12317170,12317209,12317271],"length":1,"stats":{"Line":0}},{"line":143,"address":[12317257,12317183],"length":1,"stats":{"Line":0}},{"line":145,"address":[12317359,12317426],"length":1,"stats":{"Line":0}},{"line":146,"address":[12317456],"length":1,"stats":{"Line":0}},{"line":150,"address":[12317437],"length":1,"stats":{"Line":0}},{"line":153,"address":[12317474],"length":1,"stats":{"Line":0}},{"line":155,"address":[12317482],"length":1,"stats":{"Line":0}},{"line":156,"address":[12317490],"length":1,"stats":{"Line":0}},{"line":160,"address":[12317656],"length":1,"stats":{"Line":0}},{"line":161,"address":[12317669],"length":1,"stats":{"Line":0}},{"line":163,"address":[12317676],"length":1,"stats":{"Line":0}},{"line":167,"address":[12318448,12319111,12319105],"length":1,"stats":{"Line":1}},{"line":174,"address":[12318501],"length":1,"stats":{"Line":2}},{"line":175,"address":[12318545],"length":1,"stats":{"Line":0}},{"line":178,"address":[12318523],"length":1,"stats":{"Line":1}},{"line":179,"address":[12318606],"length":1,"stats":{"Line":0}},{"line":182,"address":[12318568],"length":1,"stats":{"Line":2}},{"line":183,"address":[12318587],"length":1,"stats":{"Line":1}},{"line":186,"address":[12318742,12318660],"length":1,"stats":{"Line":3}},{"line":187,"address":[12318758],"length":1,"stats":{"Line":2}},{"line":188,"address":[12318822],"length":1,"stats":{"Line":0}},{"line":191,"address":[12318839,12318786],"length":1,"stats":{"Line":3}},{"line":192,"address":[12318884],"length":1,"stats":{"Line":0}},{"line":193,"address":[12319082],"length":1,"stats":{"Line":0}},{"line":196,"address":[12318845,12318928],"length":1,"stats":{"Line":3}},{"line":197,"address":[12318944],"length":1,"stats":{"Line":1}},{"line":198,"address":[12319003],"length":1,"stats":{"Line":0}},{"line":201,"address":[12318964],"length":1,"stats":{"Line":1}},{"line":202,"address":[12319013],"length":1,"stats":{"Line":2}}],"covered":45,"coverable":84},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","profits.rs"],"content":"use crate::errors::QuickLendXError;\nuse crate::events::emit_platform_fee_updated;\nuse soroban_sdk::{contracttype, symbol_short, Address, Env};\n\nconst DEFAULT_PLATFORM_FEE_BPS: i128 = 200; // 2%\nconst MAX_PLATFORM_FEE_BPS: i128 = 1_000; // 10%\n\n#[contracttype]\n#[derive(Clone, Debug)]\npub struct PlatformFeeConfig {\n    pub fee_bps: i128,\n    pub updated_at: u64,\n    pub updated_by: Address,\n}\n\npub struct PlatformFee;\n\nimpl PlatformFee {\n    const STORAGE_KEY: soroban_sdk::Symbol = symbol_short!(\"fee_cfg\");\n\n    fn default_config(env: \u0026Env) -\u003e PlatformFeeConfig {\n        PlatformFeeConfig {\n            fee_bps: DEFAULT_PLATFORM_FEE_BPS,\n            updated_at: 0,\n            updated_by: env.current_contract_address(),\n        }\n    }\n\n    pub fn get_config(env: \u0026Env) -\u003e PlatformFeeConfig {\n        env.storage()\n            .instance()\n            .get(\u0026Self::STORAGE_KEY)\n            .unwrap_or_else(|| Self::default_config(env))\n    }\n\n    pub fn set_config(\n        env: \u0026Env,\n        admin: \u0026Address,\n        new_fee_bps: i128,\n    ) -\u003e Result\u003cPlatformFeeConfig, QuickLendXError\u003e {\n        admin.require_auth();\n\n        if new_fee_bps \u003c 0 || new_fee_bps \u003e MAX_PLATFORM_FEE_BPS {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let config = PlatformFeeConfig {\n            fee_bps: new_fee_bps,\n            updated_at: env.ledger().timestamp(),\n            updated_by: admin.clone(),\n        };\n\n        env.storage().instance().set(\u0026Self::STORAGE_KEY, \u0026config);\n        emit_platform_fee_updated(env, \u0026config);\n        Ok(config)\n    }\n\n    pub fn calculate(env: \u0026Env, investment_amount: i128, payment_amount: i128) -\u003e (i128, i128) {\n        let config = Self::get_config(env);\n        let profit = payment_amount.saturating_sub(investment_amount);\n        if profit \u003c= 0 {\n            return (payment_amount.max(0), 0);\n        }\n\n        let platform_fee = profit.saturating_mul(config.fee_bps) / 10_000;\n        let investor_return = payment_amount.saturating_sub(platform_fee);\n        (investor_return, platform_fee)\n    }\n}\n\npub fn calculate_profit(env: \u0026Env, investment_amount: i128, payment_amount: i128) -\u003e (i128, i128) {\n    PlatformFee::calculate(env, investment_amount, payment_amount)\n}\n","traces":[{"line":21,"address":[15989952],"length":1,"stats":{"Line":1}},{"line":25,"address":[15989970],"length":1,"stats":{"Line":1}},{"line":29,"address":[15989144,15988784,15989138],"length":1,"stats":{"Line":1}},{"line":30,"address":[15988826],"length":1,"stats":{"Line":1}},{"line":32,"address":[15988896],"length":1,"stats":{"Line":1}},{"line":33,"address":[13872625,13872608],"length":1,"stats":{"Line":3}},{"line":36,"address":[15989168,15989921,15989927],"length":1,"stats":{"Line":0}},{"line":41,"address":[15989245],"length":1,"stats":{"Line":0}},{"line":43,"address":[15989259],"length":1,"stats":{"Line":0}},{"line":44,"address":[15989296],"length":1,"stats":{"Line":0}},{"line":49,"address":[15989328],"length":1,"stats":{"Line":0}},{"line":50,"address":[15989410],"length":1,"stats":{"Line":0}},{"line":53,"address":[15989555],"length":1,"stats":{"Line":0}},{"line":54,"address":[15989855],"length":1,"stats":{"Line":0}},{"line":55,"address":[15989862],"length":1,"stats":{"Line":0}},{"line":58,"address":[15990645,15990651,15990048],"length":1,"stats":{"Line":1}},{"line":59,"address":[15990133],"length":1,"stats":{"Line":1}},{"line":60,"address":[15990158,15990237],"length":1,"stats":{"Line":2}},{"line":61,"address":[15990253],"length":1,"stats":{"Line":1}},{"line":62,"address":[15990324,15990607],"length":1,"stats":{"Line":2}},{"line":65,"address":[15990490,15990281,15990353],"length":1,"stats":{"Line":2}},{"line":66,"address":[15990473,15990535],"length":1,"stats":{"Line":2}},{"line":67,"address":[15990551],"length":1,"stats":{"Line":1}},{"line":71,"address":[15990672],"length":1,"stats":{"Line":1}},{"line":72,"address":[15990708],"length":1,"stats":{"Line":1}}],"covered":16,"coverable":25},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","settlement.rs"],"content":"use crate::audit::log_payment_processed;\nuse crate::errors::QuickLendXError;\nuse crate::events::{emit_invoice_settled, emit_partial_payment};\nuse crate::investment::{InvestmentStatus, InvestmentStorage};\nuse crate::invoice::{InvoiceStatus, InvoiceStorage};\nuse crate::notifications::NotificationSystem;\nuse crate::payments::transfer_funds;\nuse crate::profits::calculate_profit;\nuse soroban_sdk::{BytesN, Env, String};\n\npub fn process_partial_payment(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    payment_amount: i128,\n    transaction_id: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if payment_amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    let business = invoice.business.clone();\n    business.require_auth();\n\n    let tx_for_event = transaction_id.clone();\n    let progress = invoice.record_payment(env, payment_amount, transaction_id)?;\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n\n    emit_partial_payment(\n        env,\n        \u0026invoice,\n        payment_amount,\n        invoice.total_paid,\n        progress,\n        tx_for_event,\n    );\n    log_payment_processed(\n        env,\n        invoice.id.clone(),\n        business.clone(),\n        payment_amount,\n        String::from_str(env, \"partial\"),\n    );\n\n    if invoice.is_fully_paid() {\n        // Use internal function to avoid duplicate require_auth call\n        settle_invoice_internal(env, invoice_id, invoice.total_paid)?;\n    }\n\n    Ok(())\n}\n\npub fn settle_invoice(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    payment_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if payment_amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Get and validate invoice\n    let invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Require business authorization for direct settlement calls\n    invoice.business.require_auth();\n\n    // Delegate to internal settlement logic\n    settle_invoice_internal(env, invoice_id, payment_amount)\n}\n\n/// Internal settlement logic - no auth required (caller must verify authorization)\nfn settle_invoice_internal(\n    env: \u0026Env,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    payment_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if payment_amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Get and validate invoice\n    let mut invoice =\n        InvoiceStorage::get_invoice(env, invoice_id).ok_or(QuickLendXError::InvoiceNotFound)?;\n\n    if invoice.status != InvoiceStatus::Funded {\n        return Err(QuickLendXError::InvalidStatus);\n    }\n\n    // Get investor from invoice\n    let investor_address = invoice\n        .investor\n        .clone()\n        .ok_or(QuickLendXError::NotInvestor)?;\n\n    // Get investment details\n    let investment = InvestmentStorage::get_investment_by_invoice(env, invoice_id)\n        .ok_or(QuickLendXError::StorageKeyNotFound)?;\n\n    // Ensure the recorded total reflects the latest payment attempt\n    let mut total_payment = invoice.total_paid;\n    if total_payment == 0 {\n        invoice.record_payment(env, payment_amount, String::from_str(env, \"settlement\"))?;\n        total_payment = invoice.total_paid;\n    } else if payment_amount \u003e total_payment {\n        let additional = payment_amount.saturating_sub(total_payment);\n        if additional \u003e 0 {\n            invoice.record_payment(env, additional, String::from_str(env, \"settlement_adj\"))?;\n        }\n        total_payment = invoice.total_paid;\n    } else {\n        total_payment = total_payment.max(payment_amount);\n        invoice.total_paid = total_payment;\n    }\n\n    if total_payment \u003c investment.amount || total_payment \u003c invoice.amount {\n        return Err(QuickLendXError::PaymentTooLow);\n    }\n\n    // Calculate profit and platform fee\n    let (investor_return, platform_fee) = calculate_profit(env, investment.amount, total_payment);\n\n    // Transfer funds to investor and platform\n    let business_address = invoice.business.clone();\n    transfer_funds(\n        env,\n        \u0026invoice.currency,\n        \u0026business_address,\n        \u0026investor_address,\n        investor_return,\n    )?;\n\n    if platform_fee \u003e 0 {\n        let platform_account = env.current_contract_address();\n        transfer_funds(\n            env,\n            \u0026invoice.currency,\n            \u0026business_address,\n            \u0026platform_account,\n            platform_fee,\n        )?;\n    }\n\n    // Update invoice status\n    let previous_status = invoice.status.clone();\n    invoice.mark_as_paid(env, business_address.clone(), env.ledger().timestamp());\n    InvoiceStorage::update_invoice(env, \u0026invoice);\n    if previous_status != invoice.status {\n        InvoiceStorage::remove_from_status_invoices(env, \u0026previous_status, invoice_id);\n        InvoiceStorage::add_to_status_invoices(env, \u0026invoice.status, invoice_id);\n    }\n\n    // Update investment status\n    let mut updated_investment = investment;\n    updated_investment.status = InvestmentStatus::Completed;\n    InvestmentStorage::update_investment(env, \u0026updated_investment);\n\n    log_payment_processed(\n        env,\n        invoice.id.clone(),\n        business_address.clone(),\n        total_payment,\n        String::from_str(env, \"final\"),\n    );\n\n    // Emit settlement event\n    emit_invoice_settled(env, \u0026invoice, investor_return, platform_fee);\n\n    // Send notification about payment received\n    let _ = NotificationSystem::notify_payment_received(env, \u0026invoice, total_payment);\n\n    Ok(())\n}\n","traces":[{"line":11,"address":[14579216,14580900,14580748],"length":1,"stats":{"Line":2}},{"line":17,"address":[14579298],"length":1,"stats":{"Line":2}},{"line":18,"address":[14579375],"length":1,"stats":{"Line":0}},{"line":21,"address":[14580891,14579453,14579368],"length":1,"stats":{"Line":4}},{"line":24,"address":[14579616,14579686],"length":1,"stats":{"Line":4}},{"line":25,"address":[14579715],"length":1,"stats":{"Line":0}},{"line":28,"address":[14579692],"length":1,"stats":{"Line":2}},{"line":29,"address":[14579731],"length":1,"stats":{"Line":2}},{"line":31,"address":[14579804],"length":1,"stats":{"Line":2}},{"line":32,"address":[14579965,14579842,14580780],"length":1,"stats":{"Line":4}},{"line":33,"address":[14580083],"length":1,"stats":{"Line":2}},{"line":39,"address":[14580112],"length":1,"stats":{"Line":2}},{"line":41,"address":[14580128],"length":1,"stats":{"Line":1}},{"line":45,"address":[14580216],"length":1,"stats":{"Line":1}},{"line":46,"address":[14580320,14580267],"length":1,"stats":{"Line":2}},{"line":48,"address":[14580328],"length":1,"stats":{"Line":1}},{"line":51,"address":[14580482],"length":1,"stats":{"Line":1}},{"line":53,"address":[14580707,14580554],"length":1,"stats":{"Line":1}},{"line":56,"address":[14580503],"length":1,"stats":{"Line":1}},{"line":59,"address":[14579194,14578720,14579200],"length":1,"stats":{"Line":1}},{"line":64,"address":[14578794],"length":1,"stats":{"Line":1}},{"line":65,"address":[14578906],"length":1,"stats":{"Line":0}},{"line":69,"address":[14578919,14578816],"length":1,"stats":{"Line":1}},{"line":72,"address":[14579021,14579088],"length":1,"stats":{"Line":2}},{"line":73,"address":[14579113],"length":1,"stats":{"Line":0}},{"line":77,"address":[14579094],"length":1,"stats":{"Line":1}},{"line":80,"address":[14579153],"length":1,"stats":{"Line":1}},{"line":84,"address":[14584569,14584814,14580960],"length":1,"stats":{"Line":1}},{"line":89,"address":[14581046],"length":1,"stats":{"Line":1}},{"line":90,"address":[14581196],"length":1,"stats":{"Line":0}},{"line":94,"address":[14581106,14581212],"length":1,"stats":{"Line":1}},{"line":97,"address":[14581338,14581414],"length":1,"stats":{"Line":2}},{"line":98,"address":[14581443],"length":1,"stats":{"Line":0}},{"line":102,"address":[14581551,14584805,14581420,14581503],"length":1,"stats":{"Line":2}},{"line":105,"address":[14581480,14581537],"length":1,"stats":{"Line":1}},{"line":108,"address":[14584771,14581790,14581838,14581695],"length":1,"stats":{"Line":2}},{"line":109,"address":[14581767,14581824],"length":1,"stats":{"Line":1}},{"line":112,"address":[14581958],"length":1,"stats":{"Line":1}},{"line":113,"address":[14582904,14581990],"length":1,"stats":{"Line":2}},{"line":114,"address":[14582742,14584707,14582063],"length":1,"stats":{"Line":2}},{"line":115,"address":[14582872],"length":1,"stats":{"Line":1}},{"line":116,"address":[14582029,14582440],"length":1,"stats":{"Line":1}},{"line":117,"address":[14582168,14582380],"length":1,"stats":{"Line":0}},{"line":118,"address":[14582398,14582665],"length":1,"stats":{"Line":0}},{"line":119,"address":[14582677,14582450],"length":1,"stats":{"Line":0}},{"line":121,"address":[14582408],"length":1,"stats":{"Line":0}},{"line":123,"address":[14582109,14582267],"length":1,"stats":{"Line":2}},{"line":124,"address":[14582283],"length":1,"stats":{"Line":1}},{"line":127,"address":[14582315,14582909],"length":1,"stats":{"Line":2}},{"line":128,"address":[14582951],"length":1,"stats":{"Line":0}},{"line":132,"address":[14582975],"length":1,"stats":{"Line":1}},{"line":135,"address":[14583106],"length":1,"stats":{"Line":1}},{"line":138,"address":[14583147],"length":1,"stats":{"Line":1}},{"line":144,"address":[14583329],"length":1,"stats":{"Line":1}},{"line":145,"address":[14583369],"length":1,"stats":{"Line":1}},{"line":148,"address":[14583406],"length":1,"stats":{"Line":1}},{"line":156,"address":[14583602,14583339],"length":1,"stats":{"Line":2}},{"line":157,"address":[14583625,14583731,14584597],"length":1,"stats":{"Line":1}},{"line":158,"address":[14583859],"length":1,"stats":{"Line":2}},{"line":159,"address":[14583866],"length":1,"stats":{"Line":1}},{"line":160,"address":[14583998],"length":1,"stats":{"Line":1}},{"line":161,"address":[14584021],"length":1,"stats":{"Line":2}},{"line":165,"address":[14583903],"length":1,"stats":{"Line":1}},{"line":166,"address":[14583959],"length":1,"stats":{"Line":1}},{"line":167,"address":[14583967],"length":1,"stats":{"Line":1}},{"line":171,"address":[14584081],"length":1,"stats":{"Line":1}},{"line":172,"address":[14584185,14584132],"length":1,"stats":{"Line":2}},{"line":173,"address":[14584193],"length":1,"stats":{"Line":2}},{"line":174,"address":[14584219],"length":1,"stats":{"Line":1}},{"line":178,"address":[14584401],"length":1,"stats":{"Line":2}},{"line":181,"address":[14584416],"length":1,"stats":{"Line":1}},{"line":183,"address":[14584447],"length":1,"stats":{"Line":2}}],"covered":61,"coverable":72},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test.rs"],"content":"use super::*;\nuse crate::audit::{AuditOperation, AuditOperationFilter, AuditQueryFilter};\nuse crate::bid::{BidStatus, BidStorage};\nuse crate::investment::{Investment, InvestmentStorage};\nuse crate::invoice::{DisputeStatus, InvoiceCategory, InvoiceMetadata, LineItemRecord};\nuse crate::verification::BusinessVerificationStatus;\nuse soroban_sdk::{\n    testutils::{Address as _, Ledger},\n    token, Address, BytesN, Env, String, Vec,\n};\n\nfn verify_investor_for_test(\n    env: \u0026Env,\n    client: \u0026QuickLendXContractClient,\n    investor: \u0026Address,\n    limit: i128,\n) {\n    client.submit_investor_kyc(investor, \u0026String::from_str(env, \"Investor KYC\"));\n    client.verify_investor(investor, \u0026limit);\n}\n\n#[test]\nfn test_store_invoice() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000;\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    let description = String::from_str(\u0026env, \"Test invoice for services\");\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify invoice was stored\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n    assert_eq!(invoice.currency, currency);\n    assert_eq!(invoice.due_date, due_date);\n    assert_eq!(invoice.description, description);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.funded_amount, 0);\n    assert!(invoice.investor.is_none());\n}\n\n#[test]\nfn test_store_invoice_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Valid invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify invoice was created\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.amount, 1000);\n    assert_eq!(invoice.business, business);\n}\n\n#[test]\nfn test_get_business_invoices() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices for business1\n    let invoice1_id = client.store_invoice(\n        \u0026business1,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice2_id = client.store_invoice(\n        \u0026business1,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Create invoice for business2\n    let invoice3_id = client.store_invoice(\n        \u0026business2,\n        \u00263000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 3\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get invoices for business1\n    let business1_invoices = client.get_business_invoices(\u0026business1);\n    assert_eq!(business1_invoices.len(), 2);\n    assert!(business1_invoices.contains(\u0026invoice1_id));\n    assert!(business1_invoices.contains(\u0026invoice2_id));\n\n    // Get invoices for business2\n    let business2_invoices = client.get_business_invoices(\u0026business2);\n    assert_eq!(business2_invoices.len(), 1);\n    assert!(business2_invoices.contains(\u0026invoice3_id));\n}\n\n#[test]\nfn test_get_invoices_by_status() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices\n    let invoice1_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice2_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get pending invoices\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_invoices.len(), 2);\n    assert!(pending_invoices.contains(\u0026invoice1_id));\n    assert!(pending_invoices.contains(\u0026invoice2_id));\n\n    // Get verified invoices (should be empty initially)\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_invoices.len(), 0);\n}\n\n#[test]\nfn test_update_invoice_status() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify invoice starts as pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    // Update to verified\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    // Check status lists\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_invoices.len(), 0);\n\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_invoices.len(), 1);\n    assert!(verified_invoices.contains(\u0026invoice_id));\n}\n\n#[test]\nfn test_update_invoice_metadata_and_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Metadata invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let mut line_items = Vec::new(\u0026env);\n    line_items.push_back(LineItemRecord(\n        String::from_str(\u0026env, \"Consulting\"),\n        5,\n        200,\n        1_000,\n    ));\n\n    let metadata = InvoiceMetadata {\n        customer_name: String::from_str(\u0026env, \"Acme Corp\"),\n        customer_address: String::from_str(\u0026env, \"123 Market St\"),\n        tax_id: String::from_str(\u0026env, \"TAX-123\"),\n        line_items,\n        notes: String::from_str(\u0026env, \"Net 30\"),\n    };\n\n    client.update_invoice_metadata(\u0026invoice_id, \u0026metadata);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    let stored_metadata = invoice.metadata().expect(\"metadata must be stored\");\n    assert_eq!(stored_metadata.customer_name, metadata.customer_name);\n    assert_eq!(stored_metadata.tax_id, metadata.tax_id);\n    assert_eq!(stored_metadata.line_items.len(), 1);\n    let stored_line_item = stored_metadata.line_items.get(0).expect(\"line item\");\n    assert_eq!(stored_line_item.3, 1_000);\n\n    let customer_invoices = client.get_invoices_by_customer(\u0026metadata.customer_name);\n    assert!(customer_invoices.contains(\u0026invoice_id));\n\n    let tax_invoices = client.get_invoices_by_tax_id(\u0026metadata.tax_id);\n    assert!(tax_invoices.contains(\u0026invoice_id));\n\n    client.clear_invoice_metadata(\u0026invoice_id);\n\n    let cleared_invoice = client.get_invoice(\u0026invoice_id);\n    assert!(cleared_invoice.metadata().is_none());\n\n    let customer_invoices_after_clear = client.get_invoices_by_customer(\u0026metadata.customer_name);\n    assert!(!customer_invoices_after_clear.contains(\u0026invoice_id));\n}\n\n#[test]\nfn test_invoice_metadata_validation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invalid metadata invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let mut invalid_items = Vec::new(\u0026env);\n    invalid_items.push_back(LineItemRecord(\n        String::from_str(\u0026env, \"Consulting\"),\n        2,\n        250,\n        500,\n    ));\n\n    let invalid_metadata = InvoiceMetadata {\n        customer_name: String::from_str(\u0026env, \"Beta LLC\"),\n        customer_address: String::from_str(\u0026env, \"456 Elm St\"),\n        tax_id: String::from_str(\u0026env, \"TAX-456\"),\n        line_items: invalid_items,\n        notes: String::from_str(\u0026env, \"Review\"),\n    };\n\n    let result = client.try_update_invoice_metadata(\u0026invoice_id, \u0026invalid_metadata);\n    let err = result.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::InvoiceAmountInvalid);\n\n    let mut invalid_line = Vec::new(\u0026env);\n    invalid_line.push_back(LineItemRecord(\n        String::from_str(\u0026env, \"Consulting\"),\n        0,\n        1,\n        0,\n    ));\n\n    let invalid_line_metadata = InvoiceMetadata {\n        customer_name: String::from_str(\u0026env, \"Gamma LLC\"),\n        customer_address: String::from_str(\u0026env, \"789 Oak St\"),\n        tax_id: String::from_str(\u0026env, \"TAX-789\"),\n        line_items: invalid_line,\n        notes: String::from_str(\u0026env, \"Invalid\"),\n    };\n\n    let result_line = client.try_update_invoice_metadata(\u0026invoice_id, \u0026invalid_line_metadata);\n    let err_line = result_line.err().expect(\"expected error\");\n    let contract_error_line = err_line.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error_line, QuickLendXError::InvalidAmount);\n}\n\n#[test]\nfn test_investor_verification_enforced() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Investor verification invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n\n    let bid_attempt = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n    let err = bid_attempt.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::BusinessNotVerified);\n\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC\"));\n\n    let pending_attempt = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n    let pending_err = pending_attempt.err().expect(\"expected pending error\");\n    let pending_contract_error = pending_err.expect(\"expected contract invoke error\");\n    assert_eq!(pending_contract_error, QuickLendXError::KYCAlreadyPending);\n\n    client.verify_investor(\u0026investor, \u00261_000);\n\n    let verification = client\n        .get_investor_verification(\u0026investor)\n        .expect(\"verification record\");\n    assert_eq!(verification.investment_limit, 750);\n    assert!(matches!(\n        verification.status,\n        BusinessVerificationStatus::Verified\n    ));\n\n    let _bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n\n    let over_limit = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00261_500, \u00261_700);\n    let limit_err = over_limit.err().expect(\"expected limit error\");\n    let limit_contract_error = limit_err.expect(\"expected invoke error\");\n    assert_eq!(limit_contract_error, QuickLendXError::InvalidAmount);\n}\n\n#[test]\nfn test_get_available_invoices() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices\n    let invoice1_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let _invoice2_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Initially no available invoices (all pending)\n    let available_invoices = client.get_available_invoices();\n    assert_eq!(available_invoices.len(), 0);\n\n    // Verify one invoice\n    client.update_invoice_status(\u0026invoice1_id, \u0026InvoiceStatus::Verified);\n\n    // Now one available invoice\n    let available_invoices = client.get_available_invoices();\n    assert_eq!(available_invoices.len(), 1);\n    assert!(available_invoices.contains(\u0026invoice1_id));\n}\n\n#[test]\nfn test_invoice_count_functions() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoices\n    client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Test count by status\n    let pending_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_count, 2);\n\n    let verified_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_count, 0);\n\n    // Test total count\n    let total_count = client.get_total_invoice_count();\n    assert_eq!(total_count, 2);\n}\n\n#[test]\nfn test_invoice_not_found() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let fake_id = BytesN::from_array(\u0026env, \u0026[0u8; 32]);\n\n    let result = client.try_get_invoice(\u0026fake_id);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_invoice_lifecycle() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Test lifecycle: Pending -\u003e Verified -\u003e Paid\n    let mut invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Paid);\n    invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert!(invoice.settled_at.is_some());\n}\n\n#[test]\nfn test_simple_bid_storage() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place a single bid to test basic functionality\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026900, \u00261000);\n\n    // Verify that the bid can be retrieved\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some(), \"Bid should be retrievable\");\n    let bid = bid.unwrap();\n    assert_eq!(bid.bid_amount, 900);\n    assert_eq!(bid.expected_return, 1000);\n}\n\n#[test]\nfn test_unique_bid_id_generation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n\n    env.as_contract(\u0026contract_id, || {\n        let mut ids = Vec::new(\u0026env);\n\n        // Generate 100 unique bid IDs (reduced for faster testing)\n        for _ in 0..100 {\n            let id = crate::bid::BidStorage::generate_unique_bid_id(\u0026env);\n\n            // Check if this ID already exists in our vector\n            for i in 0..ids.len() {\n                let existing_id = ids.get(i).unwrap();\n                assert_ne!(id, existing_id, \"Duplicate bid ID generated\");\n            }\n\n            ids.push_back(id);\n        }\n    });\n    env.mock_all_auths();\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place first bid\n    let bid_id_1 = client.place_bid(\u0026investor, \u0026invoice_id, \u0026900, \u00261100);\n\n    // Verify first bid was stored correctly\n    let bid_1 = client.get_bid(\u0026bid_id_1);\n    assert!(bid_1.is_some(), \"First bid should be retrievable\");\n\n    // Attempt duplicate bid from same investor should fail\n    let duplicate = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026950, \u00261200);\n    assert!(\n        duplicate.is_err(),\n        \"Duplicate active bids should be rejected\"\n    );\n}\n\n#[test]\nfn test_bid_ranking_and_filters() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor_a = Address::generate(\u0026env);\n    let investor_b = Address::generate(\u0026env);\n    let investor_c = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86_400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00262_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Ranking invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_a, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_b, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_c, 10_000);\n\n    let bid_a = client.place_bid(\u0026investor_a, \u0026invoice_id, \u0026700, \u0026880);\n    let bid_b = client.place_bid(\u0026investor_b, \u0026invoice_id, \u0026800, \u00261_050);\n    let _bid_c = client.place_bid(\u0026investor_c, \u0026invoice_id, \u0026900, \u00261_200);\n\n    let ranked = client.get_ranked_bids(\u0026invoice_id);\n    assert_eq!(ranked.len(), 3);\n\n    let best = client.get_best_bid(\u0026invoice_id).unwrap();\n    assert_eq!(best.bid_id, ranked.get(0).unwrap().bid_id);\n    assert_eq!(best.investor, investor_c);\n\n    env.as_contract(\u0026contract_id, || {\n        let mut bid = BidStorage::get_bid(\u0026env, \u0026bid_a).unwrap();\n        bid.status = BidStatus::Accepted;\n        BidStorage::update_bid(\u0026env, \u0026bid);\n    });\n\n    let placed = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed.len(), 2);\n    let accepted = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Accepted);\n    assert_eq!(accepted.len(), 1);\n\n    let investor_filter = client.get_bids_by_investor(\u0026invoice_id, \u0026investor_b);\n    assert_eq!(investor_filter.len(), 1);\n    assert_eq!(investor_filter.get(0).unwrap().bid_id, bid_b);\n}\n\n#[test]\nfn test_bid_expiration_cleanup() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86_400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Expiration invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026650);\n\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Placed);\n\n    let ranked = client.get_ranked_bids(\u0026invoice_id);\n    assert_eq!(ranked.len(), 1);\n\n    env.ledger().set_timestamp(bid.expiration_timestamp + 1);\n\n    let expired_count = client.cleanup_expired_bids(\u0026invoice_id);\n    assert_eq!(expired_count, 1);\n\n    let bid_after = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid_after.status, BidStatus::Expired);\n\n    assert!(client.get_ranked_bids(\u0026invoice_id).is_empty());\n    assert!(client.get_best_bid(\u0026invoice_id).is_none());\n}\n\n#[test]\nfn test_bid_validation_rules() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let other_investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Validation invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026other_investor, 10_000);\n\n    // Amount below minimum\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u002650, \u002660)\n        .is_err());\n\n    // Expected return must exceed bid amount\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u0026150, \u0026150)\n        .is_err());\n\n    // Amount cannot exceed invoice amount\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u00261500, \u00261600)\n        .is_err());\n\n    // Valid bid succeeds\n    let _bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026150, \u0026200);\n\n    // Duplicate bid from same investor is rejected\n    assert!(client\n        .try_place_bid(\u0026investor, \u0026invoice_id, \u0026180, \u0026240)\n        .is_err());\n\n    // Another investor can still bid\n    let second_bid = client.try_place_bid(\u0026other_investor, \u0026invoice_id, \u0026180, \u0026240);\n    assert!(second_bid.is_ok());\n}\n\n#[test]\nfn test_withdraw_bid() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Withdraw test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place a bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026500, \u0026600);\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Placed);\n\n    // Withdraw the bid\n    client.withdraw_bid(\u0026bid_id);\n    let withdrawn_bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(withdrawn_bid.status, BidStatus::Withdrawn);\n\n    // Verify bid is no longer in placed status\n    let placed_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed_bids.len(), 0);\n\n    // Verify bid appears in withdrawn status\n    let withdrawn_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Withdrawn);\n    assert_eq!(withdrawn_bids.len(), 1);\n    assert_eq!(withdrawn_bids.get(0).unwrap().bid_id, bid_id);\n\n    // Try to withdraw again (should fail)\n    assert!(client.try_withdraw_bid(\u0026bid_id).is_err());\n}\n\n#[test]\nfn test_get_bids_for_invoice() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor_a = Address::generate(\u0026env);\n    let investor_b = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Get bids test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_a, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor_b, 10_000);\n\n    // Place multiple bids\n    let bid_a = client.place_bid(\u0026investor_a, \u0026invoice_id, \u0026500, \u0026600);\n    let bid_b = client.place_bid(\u0026investor_b, \u0026invoice_id, \u0026600, \u0026750);\n\n    // Get all bids for invoice\n    let all_bids = client.get_bids_for_invoice(\u0026invoice_id);\n    assert_eq!(all_bids.len(), 2);\n\n    // Verify both bids are present\n    let mut found_a = false;\n    let mut found_b = false;\n    for bid in all_bids.iter() {\n        if bid.bid_id == bid_a {\n            found_a = true;\n            assert_eq!(bid.investor, investor_a);\n        }\n        if bid.bid_id == bid_b {\n            found_b = true;\n            assert_eq!(bid.investor, investor_b);\n        }\n    }\n    assert!(found_a \u0026\u0026 found_b, \"Both bids should be found\");\n\n    // Withdraw one bid\n    client.withdraw_bid(\u0026bid_a);\n\n    // Get all bids again (should still include withdrawn bid)\n    let all_bids_after = client.get_bids_for_invoice(\u0026invoice_id);\n    assert_eq!(all_bids_after.len(), 2);\n\n    // Verify withdrawn bid is still in the list\n    let withdrawn = all_bids_after.iter().find(|b| b.bid_id == bid_a).unwrap();\n    assert_eq!(withdrawn.status, BidStatus::Withdrawn);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn _test_escrow_creation_on_bid_acceptance() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n\n    // Accept bid (should create escrow)\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify escrow was created\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow_details.invoice_id, invoice_id);\n    assert_eq!(escrow_details.investor, investor);\n    assert_eq!(escrow_details.business, business);\n    assert_eq!(escrow_details.amount, bid_amount);\n    assert_eq!(escrow_details.currency, currency);\n    assert_eq!(escrow_details.status, crate::payments::EscrowStatus::Held);\n\n    // Verify escrow status\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Held);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn _test_escrow_release_on_verification() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    // Create invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place and accept bid (creates escrow)\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify escrow is held\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Held);\n\n    // Release escrow funds\n    client.release_escrow_funds(\u0026invoice_id);\n\n    // Verify escrow is released\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Released);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn test_escrow_refund() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n\n    // Create invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Place and accept bid (creates escrow)\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify escrow is held\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Held);\n\n    // Refund escrow funds\n    client.refund_escrow_funds(\u0026invoice_id);\n\n    // Verify escrow is refunded\n    let escrow_status = client.get_escrow_status(\u0026invoice_id);\n    assert_eq!(escrow_status, crate::payments::EscrowStatus::Refunded);\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn test_escrow_status_tracking() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Place and accept bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Test escrow details\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow_details.status, crate::payments::EscrowStatus::Held);\n    // created_at is set to ledger timestamp (u64 is always \u003e= 0)\n    assert_eq!(escrow_details.amount, bid_amount);\n\n    // Test status progression: Held -\u003e Released\n    client.release_escrow_funds(\u0026invoice_id);\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(\n        escrow_details.status,\n        crate::payments::EscrowStatus::Released\n    );\n}\n\n#[test]\nfn test_escrow_error_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let fake_invoice_id = BytesN::from_array(\u0026env, \u0026[1u8; 32]);\n\n    // Test getting escrow for non-existent invoice\n    let result = client.try_get_escrow_status(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    let result = client.try_get_escrow_details(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    // Test releasing escrow for non-existent invoice\n    let result = client.try_release_escrow_funds(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    // Test refunding escrow for non-existent invoice\n    let result = client.try_refund_escrow_funds(\u0026fake_invoice_id);\n    assert!(matches!(result, Err(_)));\n}\n\n// TODO: Fix type mismatch issues in escrow tests\n// #[test]\nfn test_escrow_double_operation_prevention() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let bid_amount = 1000i128;\n\n    // Create and verify invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026bid_amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Place and accept bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Release escrow funds\n    client.release_escrow_funds(\u0026invoice_id);\n\n    // Try to release again (should fail)\n    let result = client.try_release_escrow_funds(\u0026invoice_id);\n    assert!(matches!(result, Err(_)));\n\n    // Try to refund after release (should fail)\n    let result = client.try_refund_escrow_funds(\u0026invoice_id);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_unique_investment_id_generation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n\n    env.as_contract(\u0026contract_id, || {\n        let mut ids = Vec::new(\u0026env);\n\n        // Generate 100 unique investment IDs (reduced for faster testing)\n        for _ in 0..100 {\n            let id = crate::investment::InvestmentStorage::generate_unique_investment_id(\u0026env);\n\n            // Check if this ID already exists in our vector\n            for i in 0..ids.len() {\n                let existing_id = ids.get(i).unwrap();\n                assert_ne!(id, existing_id, \"Duplicate investment ID generated\");\n            }\n\n            ids.push_back(id);\n        }\n    });\n}\n\n// Rating System Tests (from feat-invoice_rating_system branch)\n\n#[test]\nfn test_add_invoice_rating() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund an invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify the invoice\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Fund the invoice properly\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add rating with proper authentication\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"Great service!\"),\n                investor,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Verify rating was added\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.average_rating, Some(5));\n    assert_eq!(invoice.total_ratings, 1);\n    assert!(invoice.has_ratings());\n    assert_eq!(invoice.get_highest_rating(), Some(5));\n    assert_eq!(invoice.get_lowest_rating(), Some(5));\n}\n\n#[test]\nfn test_add_invoice_rating_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Fund the invoice\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    let investor = Address::generate(\u0026env);\n\n    // Test invalid rating (0)\n    let result = client.try_add_invoice_rating(\n        \u0026invoice_id,\n        \u00260,\n        \u0026String::from_str(\u0026env, \"Invalid\"),\n        \u0026investor,\n    );\n    assert!(matches!(result, Err(_)));\n\n    // Test invalid rating (6)\n    let result = client.try_add_invoice_rating(\n        \u0026invoice_id,\n        \u00266,\n        \u0026String::from_str(\u0026env, \"Invalid\"),\n        \u0026investor,\n    );\n    assert!(matches!(result, Err(_)));\n\n    // Test rating on pending invoice (should fail)\n    let pending_invoice_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Pending invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    let result = client.try_add_invoice_rating(\n        \u0026pending_invoice_id,\n        \u00265,\n        \u0026String::from_str(\u0026env, \"Should fail\"),\n        \u0026investor,\n    );\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_multiple_ratings() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add a single rating (since only one investor can rate per invoice)\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"Excellent!\"),\n                investor,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Verify rating was added correctly\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.average_rating, Some(5));\n    assert_eq!(invoice.total_ratings, 1);\n    assert_eq!(invoice.get_highest_rating(), Some(5));\n    assert_eq!(invoice.get_lowest_rating(), Some(5));\n}\n\n#[test]\nfn test_duplicate_rating_prevention() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add first rating\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"First rating\"),\n                investor.clone(),\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Try to add duplicate rating (should fail)\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        let result = invoice.add_rating(\n            4,\n            String::from_str(\u0026env, \"Duplicate\"),\n            investor,\n            env.ledger().timestamp(),\n        );\n        // Check if the rating was actually added (it shouldn't be)\n        if result.is_ok() {\n            // If it succeeded, verify the rating count didn't increase\n            let updated_invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n            assert_eq!(\n                updated_invoice.total_ratings, 1,\n                \"Duplicate rating should not be added\"\n            );\n        }\n    });\n\n    // Verify only one rating exists\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.total_ratings, 1);\n    assert_eq!(invoice.average_rating, Some(5));\n}\n\n#[test]\nfn test_rating_queries() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business1 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund a single invoice first\n    let invoice1_id = client.store_invoice(\n        \u0026business1,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Add rating with proper authentication\n    env.as_contract(\u0026contract_id, || {\n        let investor1 = Address::generate(\u0026env);\n\n        // Update invoice to have investor and add to funded status list\n        let mut invoice1 = InvoiceStorage::get_invoice(\u0026env, \u0026invoice1_id).unwrap();\n        invoice1.mark_as_funded(\u0026env, investor1.clone(), 1000, env.ledger().timestamp());\n        invoice1\n            .add_rating(\n                5,\n                String::from_str(\u0026env, \"Excellent\"),\n                investor1,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice1);\n        InvoiceStorage::remove_from_status_invoices(\u0026env, \u0026InvoiceStatus::Pending, \u0026invoice1_id);\n        InvoiceStorage::add_to_status_invoices(\u0026env, \u0026InvoiceStatus::Funded, \u0026invoice1_id);\n    });\n\n    // Verify that invoice is properly moved to Funded status\n    env.as_contract(\u0026contract_id, || {\n        let pending_invoices =\n            InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Pending);\n        assert_eq!(\n            pending_invoices.len(),\n            0,\n            \"No invoices should be in Pending status\"\n        );\n\n        let funded_invoices = InvoiceStorage::get_invoices_by_status(\u0026env, \u0026InvoiceStatus::Funded);\n        assert_eq!(\n            funded_invoices.len(),\n            1,\n            \"Invoice should be in Funded status\"\n        );\n    });\n\n    // Test rating query\n    let high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    assert_eq!(high_rated_invoices.len(), 1); // invoice1 (5)\n    assert!(high_rated_invoices.contains(\u0026invoice1_id));\n\n    let rated_count = client.get_invoices_with_ratings_count();\n    assert_eq!(rated_count, 1);\n}\n\n#[test]\nfn test_rating_statistics() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create and fund invoice\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice.mark_as_funded(\u0026env, investor.clone(), 1000, env.ledger().timestamp());\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Add a single rating (since only one investor can rate per invoice)\n    env.as_contract(\u0026contract_id, || {\n        let mut invoice = InvoiceStorage::get_invoice(\u0026env, \u0026invoice_id).unwrap();\n        invoice\n            .add_rating(\n                3,\n                String::from_str(\u0026env, \"Average\"),\n                investor,\n                env.ledger().timestamp(),\n            )\n            .unwrap();\n        InvoiceStorage::update_invoice(\u0026env, \u0026invoice);\n    });\n\n    // Get rating statistics\n    let (avg_rating, total_ratings, highest, lowest) = client.get_invoice_rating_stats(\u0026invoice_id);\n\n    assert_eq!(avg_rating, Some(3)); // Single rating of 3\n    assert_eq!(total_ratings, 1);\n    assert_eq!(highest, Some(3));\n    assert_eq!(lowest, Some(3));\n}\n\n#[test]\nfn test_rating_on_unfunded_invoice() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Create invoice but don't fund it\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Unfunded invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Try to rate unfunded invoice (should fail)\n    // Note: This test is simplified since the client wrapper doesn't expose Result types\n    // In a real scenario, this would be tested at the contract level\n\n    // Verify no rating was added\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.total_ratings, 0);\n    assert!(!invoice.has_ratings());\n    assert!(invoice.average_rating.is_none());\n}\n\n// Business KYC/Verification Tests (from main branch)\n\n#[test]\nfn test_submit_kyc_application() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Mock business authorization\n    env.mock_all_auths();\n\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Verify KYC was submitted\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert_eq!(verification.business, business);\n    assert_eq!(verification.kyc_data, kyc_data);\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Pending\n    ));\n}\n\n#[test]\nfn test_verify_business() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC application\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Verify business\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Check verification status\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Verified\n    ));\n    assert!(verification.verified_at.is_some());\n    assert_eq!(verification.verified_by, Some(admin));\n}\n\n#[test]\nfn test_verify_invoice_requires_admin() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Admin gating\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    assert!(client.try_verify_invoice(\u0026invoice_id).is_err());\n\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    client.verify_invoice(\u0026invoice_id);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n}\n\n#[test]\nfn test_reject_business() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    let rejection_reason = String::from_str(\u0026env, \"Incomplete documentation\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC application\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Reject business\n    env.mock_all_auths();\n    client.reject_business(\u0026admin, \u0026business, \u0026rejection_reason);\n\n    // Check verification status\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Rejected\n    ));\n    assert_eq!(verification.rejection_reason, Some(rejection_reason));\n}\n\n#[test]\nfn test_upload_invoice_requires_verification() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Mock business authorization\n    env.mock_all_auths();\n\n    // Try to upload invoice without verification - should fail\n    let result = client.try_upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    assert!(result.is_err());\n\n    // Submit KYC and verify business\n    let admin = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Now try to upload invoice - should succeed\n    env.mock_all_auths();\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n}\n\n#[test]\nfn test_kyc_already_pending() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Mock business authorization\n    env.mock_all_auths();\n\n    // Submit KYC application\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Try to submit again - should fail\n    let result = client.try_submit_kyc_application(\u0026business, \u0026kyc_data);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_kyc_already_verified() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n\n    // Set admin and submit KYC\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Verify business\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Try to submit KYC again - should fail\n    let result = client.try_submit_kyc_application(\u0026business, \u0026kyc_data);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_kyc_resubmission_after_rejection() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    let rejection_reason = String::from_str(\u0026env, \"Incomplete documentation\");\n\n    // Set admin and submit KYC\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Reject business\n    env.mock_all_auths();\n    client.reject_business(\u0026admin, \u0026business, \u0026rejection_reason);\n\n    // Try to resubmit KYC - should succeed\n    let new_kyc_data = String::from_str(\u0026env, \"Updated business registration documents\");\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026new_kyc_data);\n\n    // Check status is back to pending\n    let verification = client.get_business_verification_status(\u0026business);\n    assert!(verification.is_some());\n    let verification = verification.unwrap();\n    assert!(matches!(\n        verification.status,\n        verification::BusinessVerificationStatus::Pending\n    ));\n    assert_eq!(verification.kyc_data, new_kyc_data);\n}\n\n#[test]\nfn test_verification_unauthorized_access() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let unauthorized_admin = Address::generate(\u0026env);\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC application\n    env.mock_all_auths();\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    client.submit_kyc_application(\u0026business, \u0026kyc_data);\n\n    // Try to verify with unauthorized admin - should fail\n    env.mock_all_auths();\n    let result = client.try_verify_business(\u0026unauthorized_admin, \u0026business);\n    assert!(matches!(result, Err(_)));\n}\n\n#[test]\nfn test_get_verification_lists() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let business3 = Address::generate(\u0026env);\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Submit KYC applications\n    env.mock_all_auths();\n    let kyc_data = String::from_str(\u0026env, \"Business registration documents\");\n    client.submit_kyc_application(\u0026business1, \u0026kyc_data);\n    client.submit_kyc_application(\u0026business2, \u0026kyc_data);\n    client.submit_kyc_application(\u0026business3, \u0026kyc_data);\n\n    // Verify business1, reject business2, leave business3 pending\n    env.mock_all_auths();\n    client.verify_business(\u0026admin, \u0026business1);\n    client.reject_business(\u0026admin, \u0026business2, \u0026String::from_str(\u0026env, \"Rejected\"));\n\n    // Check lists\n    let verified = client.get_verified_businesses();\n    let pending = client.get_pending_businesses();\n    let rejected = client.get_rejected_businesses();\n\n    assert_eq!(verified.len(), 1);\n    assert_eq!(pending.len(), 1);\n    assert_eq!(rejected.len(), 1);\n\n    assert!(verified.contains(\u0026business1));\n    assert!(pending.contains(\u0026business3));\n    assert!(rejected.contains(\u0026business2));\n}\n\n#[test]\nfn test_create_and_restore_backup() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create test invoices\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice1_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice2_id = client.store_invoice(\n        \u0026business,\n        \u00262000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Create backup\n    env.mock_all_auths();\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Initial backup\"));\n\n    // Verify backup was created\n    let backup = client.get_backup_details(\u0026backup_id);\n    assert!(backup.is_some());\n    let backup = backup.unwrap();\n    assert_eq!(backup.invoice_count, 2);\n    assert_eq!(backup.status, BackupStatus::Active);\n\n    // Clear invoices - use the contract's clear method\n    env.mock_all_auths();\n    env.as_contract(\u0026contract_id, || {\n        QuickLendXContract::clear_all_invoices(\u0026env).unwrap();\n    });\n\n    // Verify invoices are gone\n    assert!(client.try_get_invoice(\u0026invoice1_id).is_err());\n    assert!(client.try_get_invoice(\u0026invoice2_id).is_err());\n\n    // Restore backup\n    env.mock_all_auths();\n    client.restore_backup(\u0026backup_id);\n\n    // Verify invoices are back\n    let invoice1 = client.get_invoice(\u0026invoice1_id);\n    assert_eq!(invoice1.amount, 1000);\n    let invoice2 = client.get_invoice(\u0026invoice2_id);\n    assert_eq!(invoice2.amount, 2000);\n}\n\n#[test]\nfn test_backup_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create test invoice\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Create backup\n    env.mock_all_auths();\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Test backup\"));\n\n    // Validate backup\n    let is_valid = client.validate_backup(\u0026backup_id);\n    assert!(is_valid);\n\n    // Tamper with backup data (simulate corruption)\n    env.as_contract(\u0026contract_id, || {\n        let mut backup = BackupStorage::get_backup(\u0026env, \u0026backup_id).unwrap();\n        backup.invoice_count = 999; // Incorrect count\n        BackupStorage::update_backup(\u0026env, \u0026backup);\n    });\n\n    // Validate should fail now\n    let is_valid = client.validate_backup(\u0026backup_id);\n    assert!(!is_valid);\n}\n\n#[test]\nfn test_backup_cleanup() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create multiple backups with simple descriptions\n    env.mock_all_auths();\n    for i in 0..10 {\n        let description = if i == 0 {\n            String::from_str(\u0026env, \"Backup 0\")\n        } else if i == 1 {\n            String::from_str(\u0026env, \"Backup 1\")\n        } else {\n            // Continue this pattern or just use a generic description\n            String::from_str(\u0026env, \"Backup\")\n        };\n        client.create_backup(\u0026description);\n    }\n\n    // Verify only last 5 backups are kept\n    let backups = client.get_backups();\n    assert_eq!(backups.len(), 5);\n}\n\n#[test]\nfn test_archive_backup() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Set up admin\n    let admin = Address::generate(\u0026env);\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create backup\n    env.mock_all_auths();\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Test backup\"));\n\n    // Archive backup\n    client.archive_backup(\u0026backup_id);\n\n    // Verify backup is archived\n    let backup = client.get_backup_details(\u0026backup_id);\n    assert!(backup.is_some());\n    assert_eq!(backup.unwrap().status, BackupStatus::Archived);\n\n    // Verify backup is removed from active list\n    let backups = client.get_backups();\n    assert!(!backups.contains(\u0026backup_id));\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_trail_creation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Check audit trail was created\n    let audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    assert!(!audit_trail.is_empty());\n\n    // Verify audit entry details\n    let audit_entry = client.get_audit_entry(\u0026audit_trail.get(0).unwrap());\n    assert_eq!(audit_entry.invoice_id, invoice_id);\n    assert_eq!(audit_entry.operation, AuditOperation::InvoiceCreated);\n    assert_eq!(audit_entry.actor, business);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_integrity_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Validate audit integrity\n    let is_valid = client.validate_invoice_audit_integrity(\u0026invoice_id);\n    assert!(is_valid);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_query_functionality() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create multiple invoices\n    let invoice_id1 = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    let amount2 = amount * 2;\n    let _invoice_id2 = client.upload_invoice(\n        \u0026business,\n        \u0026amount2,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Query by operation type\n    let filter = AuditQueryFilter {\n        invoice_id: None,\n        operation: AuditOperationFilter::Specific(AuditOperation::InvoiceCreated),\n        actor: None,\n        start_timestamp: None,\n        end_timestamp: None,\n    };\n\n    let results = client.query_audit_logs(\u0026filter, \u002610);\n    assert_eq!(results.len(), 2);\n\n    // Query by specific invoice\n    let filter = AuditQueryFilter {\n        invoice_id: Some(invoice_id1.clone()),\n        operation: AuditOperationFilter::Any,\n        actor: None,\n        start_timestamp: None,\n        end_timestamp: None,\n    };\n\n    let results = client.query_audit_logs(\u0026filter, \u002610);\n    assert!(!results.is_empty());\n    assert_eq!(results.get(0).unwrap().invoice_id, invoice_id1);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_audit_statistics() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Allow unauthenticated calls for test simplicity\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    // Verify business setup\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create and process invoices\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Get audit statistics\n    let stats = client.get_audit_stats();\n    assert!(stats.total_entries \u003e 0);\n    assert!(stats.unique_actors \u003e 0);\n}\n\n// --- Start of merged content ---\n\n// Notification System Tests (from feat-notif)\n\n#[test]\nfn test_notification_preferences_default() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let user = Address::generate(\u0026env);\n\n    // Get default preferences\n    let preferences = client.get_notification_preferences(\u0026user);\n\n    // Verify default preferences are set correctly\n    assert_eq!(preferences.user, user);\n    assert!(preferences.invoice_created);\n    assert!(preferences.invoice_verified);\n    assert!(preferences.bid_received);\n    assert!(preferences.payment_received);\n}\n\n#[test]\nfn test_update_notification_preferences() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let user = Address::generate(\u0026env);\n    env.mock_all_auths();\n\n    // Get default preferences\n    let mut preferences = client.get_notification_preferences(\u0026user);\n\n    // Update preferences\n    preferences.invoice_created = false;\n    preferences.bid_received = false;\n\n    // Update preferences in contract\n    client.update_notification_preferences(\u0026user, \u0026preferences);\n\n    // Verify preferences were updated\n    let updated_preferences = client.get_notification_preferences(\u0026user);\n    assert_eq!(updated_preferences.invoice_created, false);\n    assert_eq!(updated_preferences.bid_received, false);\n    assert_eq!(updated_preferences.payment_received, true); // Should remain true\n}\n\n#[test]\nfn test_notification_creation_on_invoice_upload() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice (should trigger notification)\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Check that business has notifications\n    let notifications = client.get_user_notifications(\u0026business);\n    assert!(!notifications.is_empty());\n}\n\n#[test]\nfn test_notification_creation_on_bid_placement() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    // Place bid (should trigger notification to business)\n    let _bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261000, \u00261100);\n\n    // Check that business received bid notification\n    let business_notifications = client.get_user_notifications(\u0026business);\n    assert!(!business_notifications.is_empty());\n\n    // Verify notification content\n    let notification_id = business_notifications\n        .get(business_notifications.len() - 1)\n        .unwrap();\n    let notification = client.get_notification(\u0026notification_id);\n    assert!(notification.is_some());\n}\n\n#[test]\nfn test_notification_creation_on_invoice_status_change() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get initial notification count\n    let initial_notifications = client.get_user_notifications(\u0026business);\n    let initial_count = initial_notifications.len();\n\n    // Update invoice status (should trigger notification)\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n\n    // Check that business received verification notification\n    let updated_notifications = client.get_user_notifications(\u0026business);\n    assert!(updated_notifications.len() \u003e initial_count);\n}\n\n#[test]\nfn test_notification_delivery_status_update() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice to trigger notification\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get the notification\n    let notifications = client.get_user_notifications(\u0026business);\n    assert!(!notifications.is_empty());\n    let notification_id = notifications.get(0).unwrap();\n\n    // Update notification status\n    client.update_notification_status(\u0026notification_id, \u0026NotificationDeliveryStatus::Sent);\n\n    // Verify status was updated\n    let notification = client.get_notification(\u0026notification_id);\n    assert!(notification.is_some());\n    let notification = notification.unwrap();\n    assert_eq!(\n        notification.delivery_status,\n        NotificationDeliveryStatus::Sent\n    );\n}\n\n#[test]\nfn test_user_notification_stats() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    env.mock_all_auths();\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice to trigger notification\n    let _invoice_id = client.upload_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Get notification stats\n    let stats = client.get_user_notification_stats(\u0026business);\n\n    // Verify stats - check that notifications were created\n    assert!(stats.total_sent \u003e= 0);\n    assert!(stats.total_delivered \u003e= 0);\n    assert!(stats.total_read \u003e= 0);\n    assert!(stats.total_failed \u003e= 0);\n}\n\n#[test]\nfn test_platform_fee_configuration() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n\n    let default_config = client.get_platform_fee();\n    assert_eq!(default_config.fee_bps, 200);\n\n    client.set_platform_fee(\u0026300);\n    let updated_config = client.get_platform_fee();\n    assert_eq!(updated_config.fee_bps, 300);\n    assert_eq!(updated_config.updated_by, admin);\n\n    let (investor_return, platform_fee) = client.calculate_profit(\u00261_000, \u00261_200);\n    assert_eq!(investor_return, 1_194);\n    assert_eq!(platform_fee, 6);\n\n    let invalid = client.try_set_platform_fee(\u00261_200);\n    let err = invalid.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::InvalidAmount);\n}\n\n#[test]\nfn test_overdue_invoice_notifications() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    env.mock_all_auths();\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n\n    // Register a Stellar Asset Contract to represent the currency used in tests\n    let token_admin = Address::generate(\u0026env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    // Set up admin and verify business\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create invoice with future due date first\n    let future_due_date = env.ledger().timestamp() + 86400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261000,\n        \u0026currency,\n        \u0026future_due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Verify and fund the invoice\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261000, \u00261100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Check for overdue invoices (this will check current time vs due dates)\n    let overdue_count = client.check_overdue_invoices();\n\n    // Verify notifications were sent to both parties\n    let business_notifications = client.get_user_notifications(\u0026business);\n    let investor_notifications = client.get_user_notifications(\u0026investor);\n\n    // Both business and investor should have notifications from previous actions\n    assert!(!business_notifications.is_empty());\n    assert!(!investor_notifications.is_empty());\n\n    // The overdue check function should complete successfully\n    assert!(overdue_count \u003e= 0);\n}\n\n#[test]\nfn test_invoice_expiration_triggers_default() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 5_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let due_date = env.ledger().timestamp() + 60;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Expiring invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261_000, \u00261_100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n\n    env.ledger().set_timestamp(invoice.due_date + 1);\n\n    let defaulted = client.check_invoice_expiration(\u0026invoice_id, \u0026Some(0));\n    assert!(defaulted);\n\n    let updated_invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(updated_invoice.status, InvoiceStatus::Defaulted);\n}\n\n#[test]\nfn test_partial_payments_trigger_settlement() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 5_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC data\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let due_date = env.ledger().timestamp() + 86_400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Partial payment invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261_000, \u00261_100);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    let tx1 = String::from_str(\u0026env, \"tx-1\");\n    client.process_partial_payment(\u0026invoice_id, \u0026400, \u0026tx1);\n\n    let mid_invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(mid_invoice.total_paid, 400);\n    assert_eq!(mid_invoice.payment_history.len(), 1);\n    assert_eq!(mid_invoice.status, InvoiceStatus::Funded);\n    assert_eq!(mid_invoice.payment_progress(), 40);\n\n    let tx2 = String::from_str(\u0026env, \"tx-2\");\n    client.process_partial_payment(\u0026invoice_id, \u0026600, \u0026tx2);\n\n    let settled_invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(settled_invoice.status, InvoiceStatus::Paid);\n    assert_eq!(settled_invoice.total_paid, 1_000);\n    assert_eq!(settled_invoice.payment_history.len(), 2);\n    assert_eq!(settled_invoice.payment_progress(), 100);\n\n    let investment = env\n        .as_contract(\u0026contract_id, || {\n            InvestmentStorage::get_investment_by_invoice(\u0026env, \u0026invoice_id)\n        })\n        .expect(\"investment\");\n    assert_eq!(investment.status, InvestmentStatus::Completed);\n}\n\n// Dispute Resolution System Tests (from main)\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_create_dispute() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Create dispute as business\n    let reason = String::from_str(\u0026env, \"Payment not received\");\n    let evidence = String::from_str(\u0026env, \"Bank statement showing no payment\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Verify dispute was created\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::Disputed);\n\n    let dispute_details = client.get_dispute_details(\u0026invoice_id);\n    assert!(dispute_details.is_some());\n\n    let dispute = dispute_details.unwrap();\n    assert_eq!(dispute.created_by, business);\n    assert_eq!(dispute.reason, reason);\n    assert_eq!(dispute.evidence, evidence);\n    assert_eq!(dispute.resolution, String::from_str(\u0026env, \"\"));\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_create_dispute_as_investor() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create, verify, and fund invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Place and accept bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026amount, \u0026(amount + 100));\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Create dispute as investor\n    let reason = String::from_str(\u0026env, \"Invoice details are incorrect\");\n    let evidence = String::from_str(\u0026env, \"Original contract shows different terms\");\n\n    client.create_dispute(\u0026invoice_id, \u0026investor, \u0026reason, \u0026evidence);\n\n    // Verify dispute was created\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::Disputed);\n\n    let dispute_details = client.get_dispute_details(\u0026invoice_id);\n    assert!(dispute_details.is_some());\n\n    let dispute = dispute_details.unwrap();\n    assert_eq!(dispute.created_by, investor);\n    assert_eq!(dispute.reason, reason);\n    assert_eq!(dispute.evidence, evidence);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_unauthorized_dispute_creation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let unauthorized = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Try to create dispute as unauthorized party\n    let reason = String::from_str(\u0026env, \"Invalid dispute\");\n    let evidence = String::from_str(\u0026env, \"Invalid evidence\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026unauthorized, \u0026reason, \u0026evidence);\n\n    assert!(result.is_err());\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_duplicate_dispute_prevention() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Create first dispute\n    let reason1 = String::from_str(\u0026env, \"First dispute\");\n    let evidence1 = String::from_str(\u0026env, \"First evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason1, \u0026evidence1);\n\n    // Try to create second dispute\n    let reason2 = String::from_str(\u0026env, \"Second dispute\");\n    let evidence2 = String::from_str(\u0026env, \"Second evidence\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026business, \u0026reason2, \u0026evidence2);\n\n    assert!(result.is_err());\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_dispute_under_review() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create, verify invoice and create dispute\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Put dispute under review\n    client.put_dispute_under_review(\u0026invoice_id, \u0026admin);\n\n    // Verify dispute status\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::UnderReview);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_resolve_dispute() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create, verify invoice and create dispute\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Put dispute under review\n    client.put_dispute_under_review(\u0026invoice_id, \u0026admin);\n\n    // Resolve dispute\n    let resolution = String::from_str(\n        \u0026env,\n        \"Payment confirmed, dispute resolved in favor of business\",\n    );\n    client.resolve_dispute(\u0026invoice_id, \u0026admin, \u0026resolution);\n\n    // Verify dispute is resolved\n    let dispute_status = client.get_invoice_dispute_status(\u0026invoice_id);\n    assert_eq!(dispute_status, DisputeStatus::Resolved);\n\n    let dispute_details = client.get_dispute_details(\u0026invoice_id);\n    assert!(dispute_details.is_some());\n\n    let dispute = dispute_details.unwrap();\n    assert_eq!(dispute.resolution, resolution);\n    assert_eq!(dispute.resolved_by, admin);\n    assert!(dispute.resolved_at \u003e 0);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_get_invoices_with_disputes() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create invoices\n    let invoice_id1 = client.upload_invoice(\n        \u0026business1,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    let invoice_id2 = client.upload_invoice(\n        \u0026business2,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id1);\n    client.verify_invoice(\u0026invoice_id2);\n\n    // Create disputes\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id1, \u0026business1, \u0026reason, \u0026evidence);\n\n    client.create_dispute(\u0026invoice_id2, \u0026business2, \u0026reason, \u0026evidence);\n\n    // Get all invoices with disputes\n    let disputed_invoices = client.get_invoices_with_disputes();\n    assert_eq!(disputed_invoices.len(), 2);\n    assert!(disputed_invoices.contains(\u0026invoice_id1));\n    assert!(disputed_invoices.contains(\u0026invoice_id2));\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_get_invoices_by_dispute_status() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Set admin\n    env.mock_all_auths();\n    client.set_admin(\u0026admin);\n\n    // Create, verify invoice and create dispute\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n\n    let reason = String::from_str(\u0026env, \"Payment issue\");\n    let evidence = String::from_str(\u0026env, \"Payment evidence\");\n\n    client.create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026evidence);\n\n    // Get invoices with disputed status\n    let disputed_invoices = client.get_invoices_by_dispute_status(\u0026DisputeStatus::Disputed);\n    assert_eq!(disputed_invoices.len(), 1);\n    assert_eq!(disputed_invoices.get(0).unwrap(), invoice_id);\n\n    // Put under review\n    client.put_dispute_under_review(\u0026invoice_id, \u0026admin);\n\n    // Get invoices with under review status\n    let under_review_invoices = client.get_invoices_by_dispute_status(\u0026DisputeStatus::UnderReview);\n    assert_eq!(under_review_invoices.len(), 1);\n    assert_eq!(under_review_invoices.get(0).unwrap(), invoice_id);\n\n    // Resolve dispute\n    let resolution = String::from_str(\u0026env, \"Dispute resolved\");\n    client.resolve_dispute(\u0026invoice_id, \u0026admin, \u0026resolution);\n\n    // Get invoices with resolved status\n    let resolved_invoices = client.get_invoices_by_dispute_status(\u0026DisputeStatus::Resolved);\n    assert_eq!(resolved_invoices.len(), 1);\n    assert_eq!(resolved_invoices.get(0).unwrap(), invoice_id);\n}\n\n// TODO: Fix authorization issues in test environment\n// #[test]\nfn test_dispute_validation() {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n\n    // Create and verify invoice\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n\n    // Test empty reason\n    let empty_reason = String::from_str(\u0026env, \"\");\n    let evidence = String::from_str(\u0026env, \"Valid evidence\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026business, \u0026empty_reason, \u0026evidence);\n    assert!(result.is_err());\n\n    // Test empty evidence\n    let reason = String::from_str(\u0026env, \"Valid reason\");\n    let empty_evidence = String::from_str(\u0026env, \"\");\n\n    let result = client.try_create_dispute(\u0026invoice_id, \u0026business, \u0026reason, \u0026empty_evidence);\n    assert!(result.is_err());\n}\n\n#[test]\nfn test_investment_insurance_lifecycle() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let provider = Address::generate(\u0026env);\n    let admin = Address::generate(\u0026env);\n\n    let token_admin = Address::generate(\u0026env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    client.set_admin(\u0026admin);\n\n    let due_date = env.ledger().timestamp() + 86_400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u00261_000i128,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice with insurance\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    client.update_invoice_status(\u0026invoice_id, \u0026InvoiceStatus::Verified);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10_000);\n\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00261_000i128, \u00261_100i128);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    let investment = client.get_invoice_investment(\u0026invoice_id);\n    let investment_id = investment.investment_id.clone();\n\n    let invalid_attempt = client.try_add_investment_insurance(\u0026investment_id, \u0026provider, \u0026150u32);\n    let err = invalid_attempt.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::InvalidCoveragePercentage);\n\n    let coverage_percentage = 60u32;\n    client.add_investment_insurance(\u0026investment_id, \u0026provider, \u0026coverage_percentage);\n\n    let duplicate_provider = Address::generate(\u0026env);\n    let duplicate_attempt =\n        client.try_add_investment_insurance(\u0026investment_id, \u0026duplicate_provider, \u002630u32);\n    let err = duplicate_attempt.err().expect(\"expected contract error\");\n    let contract_error = err.expect(\"expected contract invoke error\");\n    assert_eq!(contract_error, QuickLendXError::OperationNotAllowed);\n\n    let insured_investment = client.get_invoice_investment(\u0026invoice_id);\n    let investment_amount = insured_investment.amount;\n    assert_eq!(insured_investment.insurance.len(), 1);\n    let insurance = insured_investment\n        .insurance\n        .get(0)\n        .expect(\"expected insurance entry\");\n    assert!(insurance.active);\n    assert_eq!(insurance.provider, provider);\n    assert_eq!(insurance.coverage_percentage, coverage_percentage);\n    let expected_coverage = investment_amount * coverage_percentage as i128 / 100;\n    assert_eq!(insurance.coverage_amount, expected_coverage);\n    let expected_premium = Investment::calculate_premium(investment_amount, coverage_percentage);\n    assert_eq!(insurance.premium_amount, expected_premium);\n\n    let stored_invoice = client.get_invoice(\u0026invoice_id);\n    env.ledger().set_timestamp(stored_invoice.due_date + 1);\n    let result = client.try_handle_default(\u0026invoice_id);\n    assert!(result.is_ok());\n\n    let after_default = client.get_invoice_investment(\u0026invoice_id);\n    assert_eq!(after_default.status, InvestmentStatus::Defaulted);\n    assert_eq!(after_default.insurance.len(), 1);\n    let insurance_after = after_default\n        .insurance\n        .get(0)\n        .expect(\"expected insurance entry after claim\");\n    assert!(!insurance_after.active);\n    assert_eq!(insurance_after.coverage_amount, expected_coverage);\n}\n\n// Test basic functionality from README.md\n#[test]\nfn test_basic_readme_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    \n    // Register a Stellar Asset Contract to represent the currency used in tests\n    let token_admin = Address::generate(\u0026env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    \n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    \n    // Test 1: Set admin\n    client.set_admin(\u0026admin);\n    \n    // Test 2: Business KYC submission\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\"));\n    \n    // Test 3: Business verification\n    client.verify_business(\u0026admin, \u0026business);\n    \n    // Test 4: Create invoice\n    let invoice_id = client.try_store_invoice(\n        \u0026business,\n        \u002610000, // $100.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice for services\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env)\n    ).unwrap().unwrap();\n    \n    // Test 5: Verify invoice\n    client.verify_invoice(\u0026invoice_id);\n    \n    // Test 6: Investor KYC submission\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\"));\n    \n    // Test 7: Investor verification (set limit high enough for the bid)\n    client.verify_investor(\u0026investor, \u002620000);\n    \n    // Test 8: Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00269500, \u002610000);\n    \n    // Test 9: Accept bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Test 10: Release escrow funds\n    client.release_escrow_funds(\u0026invoice_id);\n    \n    // Test 11: Query functions\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.amount, 10000);\n    \n    let business_invoices = client.get_business_invoices(\u0026business);\n    assert_eq!(business_invoices.len(), 1);\n    \n    let _pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    let _verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    let _funded_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Funded);\n    \n    let _available_invoices = client.get_available_invoices();\n    \n    // Test 12: Verification queries\n    let _verified_businesses = client.get_verified_businesses();\n    let _pending_businesses = client.get_pending_businesses();\n    \n    let business_verification = client.get_business_verification_status(\u0026business);\n    assert!(business_verification.is_some());\n    \n    // Test 13: Investor verification queries\n    let _verified_investors = client.get_verified_investors();\n    let _pending_investors = client.get_pending_investors();\n    \n    let investor_verification = client.get_investor_verification(\u0026investor);\n    assert!(investor_verification.is_some());\n    \n    // Test 14: Analytics queries\n    let _platform_metrics = client.get_platform_metrics();\n    let _performance_metrics = client.get_performance_metrics();\n    \n    // Test 15: Audit queries\n    let _audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    let _audit_stats = client.get_audit_stats();\n    \n    // Test 16: Backup queries\n    let backup_id = client.create_backup(\u0026String::from_str(\u0026env, \"Test backup\"));\n    let _backup_details = client.get_backup_details(\u0026backup_id);\n    let _backups = client.get_backups();\n    \n    // Test 17: Category and tag queries\n    let _services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    let _test_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"test\"));\n    let _all_categories = client.get_all_categories();\n    \n    // Test 18: Rating queries\n    let _invoices_with_ratings = client.get_invoices_with_ratings_count();\n    let _high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    \n    // Test 19: Notification queries\n    let _user_notifications = client.get_user_notifications(\u0026business);\n    let _preferences = client.get_notification_preferences(\u0026business);\n    let _notification_stats = client.get_user_notification_stats(\u0026business);\n    \n    // Test 20: Advanced analytics queries\n    let _financial_metrics = client.get_financial_metrics(\u0026TimePeriod::Monthly);\n    let _user_behavior_metrics = client.get_user_behavior_metrics(\u0026business);\n    let _analytics_summary = client.get_analytics_summary();\n    \n    // Test 21: Investor analytics queries\n    let _basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    let _medium_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Medium);\n    let _investor_analytics = client.calculate_investor_analytics(\u0026investor);\n    let _investor_performance_metrics = client.calc_investor_perf_metrics();\n    \n    // All tests passed\n    assert!(true);\n}\n\n// ========================================\n// Invoice Lifecycle Tests\n// ========================================\n\n#[test]\nfn test_upload_invoice_success() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Payment for consulting services\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Consulting,\n        \u0026tags,\n    );\n\n    // Verify invoice was created with correct status\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n    assert_eq!(invoice.due_date, due_date);\n}\n\n#[test]\n#[should_panic(expected = \"BusinessNotVerified\")]\nfn test_upload_invoice_not_verified_business() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Try to upload invoice without being verified\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n}\n\n#[test]\n#[should_panic(expected = \"InvalidAmount\")]\nfn test_upload_invoice_invalid_amount() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Try to upload invoice with negative amount\n    let amount = -100i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n}\n\n#[test]\n#[should_panic(expected = \"InvoiceDueDateInvalid\")]\nfn test_upload_invoice_past_due_date() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Try to upload invoice with past due date\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() - 86400; // Past date\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n}\n\n#[test]\nfn test_verify_invoice_success() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify invoice status is Pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    // Verify the invoice\n    client.verify_invoice(\u0026invoice_id);\n\n    // Check status changed to Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n}\n\n#[test]\n#[should_panic(expected = \"NotAdmin\")]\nfn test_verify_invoice_not_admin() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let non_admin = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Try to verify as non-admin (should fail in real scenario)\n    // Note: mock_all_auths() bypasses auth, so we set admin first\n    client.set_admin(\u0026non_admin);\n    client.verify_invoice(\u0026invoice_id);\n}\n\n#[test]\n#[should_panic(expected = \"InvalidStatus\")]\nfn test_verify_invoice_already_verified() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify once\n    client.verify_invoice(\u0026invoice_id);\n\n    // Try to verify again (should fail)\n    client.verify_invoice(\u0026invoice_id);\n}\n\n#[test]\nfn test_cancel_invoice_pending() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify invoice is Pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n\n    // Cancel the invoice\n    client.cancel_invoice(\u0026invoice_id);\n\n    // Verify status changed to Cancelled\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Cancelled);\n}\n\n#[test]\nfn test_cancel_invoice_verified() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Verify the invoice\n    client.verify_invoice(\u0026invoice_id);\n\n    // Verify invoice is Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    // Cancel the invoice\n    client.cancel_invoice(\u0026invoice_id);\n\n    // Verify status changed to Cancelled\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Cancelled);\n}\n\n#[test]\n#[should_panic(expected = \"InvalidStatus\")]\nfn test_cancel_invoice_funded() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Set admin and verify business and investor\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n    verify_investor_for_test(\u0026env, \u0026client, \u0026investor, 10000000);\n\n    // Upload and verify invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Test invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    client.verify_invoice(\u0026invoice_id);\n\n    // Investor places bid\n    let bid_amount = amount;\n    let expected_return = amount + 100000;\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026bid_amount, \u0026expected_return);\n\n    // Business accepts bid (invoice becomes Funded)\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n\n    // Verify invoice is Funded\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n\n    // Try to cancel funded invoice (should fail)\n    client.cancel_invoice(\u0026invoice_id);\n}\n\n#[test]\nfn test_complete_invoice_lifecycle_with_cancellation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Setup: Set admin and verify business\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Step 1: Upload invoice\n    let amount = 1000000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let description = String::from_str(\u0026env, \"Consulting services invoice\");\n    let tags = Vec::new(\u0026env);\n\n    let invoice_id = client.upload_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026InvoiceCategory::Consulting,\n        \u0026tags,\n    );\n\n    // Verify invoice is Pending\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n\n    // Step 2: Verify invoice\n    client.verify_invoice(\u0026invoice_id);\n\n    // Verify status changed to Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n\n    // Step 3: Cancel invoice (business changes mind)\n    client.cancel_invoice(\u0026invoice_id);\n\n    // Verify status changed to Cancelled\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Cancelled);\n\n    // Verify cancelled invoices are tracked\n    let cancelled_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Cancelled);\n    assert_eq!(cancelled_invoices.len(), 1);\n    assert_eq!(cancelled_invoices.get(0).unwrap(), invoice_id);\n}\n\n#[test]\nfn test_invoice_lifecycle_counts() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    // Create multiple invoices in different states\n    let due_date = env.ledger().timestamp() + 86400;\n    let tags = Vec::new(\u0026env);\n\n    // Invoice 1: Pending\n    let _invoice_id_1 = client.upload_invoice(\n        \u0026business,\n        \u00261000000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026tags,\n    );\n\n    // Invoice 2: Verified\n    let invoice_id_2 = client.upload_invoice(\n        \u0026business,\n        \u00262000000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Products,\n        \u0026tags,\n    );\n    client.verify_invoice(\u0026invoice_id_2);\n\n    // Invoice 3: Cancelled\n    let invoice_id_3 = client.upload_invoice(\n        \u0026business,\n        \u00263000000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 3\"),\n        \u0026InvoiceCategory::Consulting,\n        \u0026tags,\n    );\n    client.verify_invoice(\u0026invoice_id_3);\n    client.cancel_invoice(\u0026invoice_id_3);\n\n    // Verify counts\n    let pending_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Pending);\n    let verified_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Verified);\n    let cancelled_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Cancelled);\n    let total_count = client.get_total_invoice_count();\n\n    assert_eq!(pending_count, 1);\n    assert_eq!(verified_count, 1);\n    assert_eq!(cancelled_count, 1);\n    assert_eq!(total_count, 3);\n}\n\n#[test]\nfn test_get_invoices_by_status_cancelled() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n\n    let due_date = env.ledger().timestamp() + 86400;\n    let tags = Vec::new(\u0026env);\n\n    // Create and cancel multiple invoices\n    let mut cancelled_ids = Vec::new(\u0026env);\n    for i in 0..3 {\n        let desc = if i == 0 {\n            \"Invoice 1\"\n        } else if i == 1 {\n            \"Invoice 2\"\n        } else {\n            \"Invoice 3\"\n        };\n        let invoice_id = client.upload_invoice(\n            \u0026business,\n            \u0026((i + 1) * 1000000),\n            \u0026currency,\n            \u0026due_date,\n            \u0026String::from_str(\u0026env, desc),\n            \u0026InvoiceCategory::Services,\n            \u0026tags,\n        );\n        client.cancel_invoice(\u0026invoice_id);\n        cancelled_ids.push_back(invoice_id);\n    }\n\n    // Get all cancelled invoices\n    let cancelled_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Cancelled);\n    assert_eq!(cancelled_invoices.len(), 3);\n\n    // Verify all cancelled IDs are in the list\n    for id in cancelled_ids.iter() {\n        let found = cancelled_invoices.iter().any(|invoice_id| invoice_id == id);\n        assert!(found);\n    }\n}\n","traces":[{"line":12,"address":[14260283,14260289,14260112],"length":1,"stats":{"Line":1}},{"line":18,"address":[14260160],"length":1,"stats":{"Line":1}},{"line":19,"address":[14260265],"length":1,"stats":{"Line":1}},{"line":912,"address":[14367929,14367935,14365040],"length":1,"stats":{"Line":0}},{"line":913,"address":[14365047],"length":1,"stats":{"Line":0}},{"line":914,"address":[14365080],"length":1,"stats":{"Line":0}},{"line":915,"address":[14365151],"length":1,"stats":{"Line":0}},{"line":916,"address":[14365182],"length":1,"stats":{"Line":0}},{"line":918,"address":[14365230],"length":1,"stats":{"Line":0}},{"line":919,"address":[14365294],"length":1,"stats":{"Line":0}},{"line":920,"address":[14365362],"length":1,"stats":{"Line":0}},{"line":921,"address":[14365494,14365446],"length":1,"stats":{"Line":0}},{"line":922,"address":[14365635],"length":1,"stats":{"Line":0}},{"line":923,"address":[14365659],"length":1,"stats":{"Line":0}},{"line":924,"address":[14365702],"length":1,"stats":{"Line":0}},{"line":925,"address":[14365753],"length":1,"stats":{"Line":0}},{"line":926,"address":[14365796],"length":1,"stats":{"Line":0}},{"line":927,"address":[14365844],"length":1,"stats":{"Line":0}},{"line":928,"address":[14365887],"length":1,"stats":{"Line":0}},{"line":929,"address":[14365935],"length":1,"stats":{"Line":0}},{"line":930,"address":[14365978],"length":1,"stats":{"Line":0}},{"line":931,"address":[14366026],"length":1,"stats":{"Line":0}},{"line":932,"address":[14366069],"length":1,"stats":{"Line":0}},{"line":935,"address":[14366220],"length":1,"stats":{"Line":0}},{"line":940,"address":[14366117],"length":1,"stats":{"Line":0}},{"line":942,"address":[14366152],"length":1,"stats":{"Line":0}},{"line":944,"address":[14366479],"length":1,"stats":{"Line":0}},{"line":945,"address":[14366543],"length":1,"stats":{"Line":0}},{"line":946,"address":[14366584],"length":1,"stats":{"Line":0}},{"line":947,"address":[14366625],"length":1,"stats":{"Line":0}},{"line":948,"address":[14366666],"length":1,"stats":{"Line":0}},{"line":949,"address":[14366707],"length":1,"stats":{"Line":0}},{"line":952,"address":[14366714],"length":1,"stats":{"Line":0}},{"line":955,"address":[14366792],"length":1,"stats":{"Line":0}},{"line":958,"address":[14366867],"length":1,"stats":{"Line":0}},{"line":959,"address":[14366874,14366966],"length":1,"stats":{"Line":0}},{"line":960,"address":[14367014],"length":1,"stats":{"Line":0}},{"line":961,"address":[14367118],"length":1,"stats":{"Line":0}},{"line":962,"address":[14367230],"length":1,"stats":{"Line":0}},{"line":963,"address":[14367332],"length":1,"stats":{"Line":0}},{"line":964,"address":[14367436],"length":1,"stats":{"Line":0}},{"line":967,"address":[14367550],"length":1,"stats":{"Line":0}},{"line":968,"address":[14367580],"length":1,"stats":{"Line":0}},{"line":973,"address":[14355152,14357121,14357127],"length":1,"stats":{"Line":0}},{"line":974,"address":[14355159],"length":1,"stats":{"Line":0}},{"line":975,"address":[14355183],"length":1,"stats":{"Line":0}},{"line":976,"address":[14355245],"length":1,"stats":{"Line":0}},{"line":977,"address":[14355270],"length":1,"stats":{"Line":0}},{"line":979,"address":[14355315],"length":1,"stats":{"Line":0}},{"line":980,"address":[14355376],"length":1,"stats":{"Line":0}},{"line":981,"address":[14355441],"length":1,"stats":{"Line":0}},{"line":982,"address":[14355519,14355567],"length":1,"stats":{"Line":0}},{"line":983,"address":[14355708],"length":1,"stats":{"Line":0}},{"line":984,"address":[14355732],"length":1,"stats":{"Line":0}},{"line":985,"address":[14355772],"length":1,"stats":{"Line":0}},{"line":986,"address":[14355823],"length":1,"stats":{"Line":0}},{"line":987,"address":[14355863],"length":1,"stats":{"Line":0}},{"line":988,"address":[14355911],"length":1,"stats":{"Line":0}},{"line":989,"address":[14355951],"length":1,"stats":{"Line":0}},{"line":992,"address":[14356096],"length":1,"stats":{"Line":0}},{"line":997,"address":[14355999],"length":1,"stats":{"Line":0}},{"line":999,"address":[14356031],"length":1,"stats":{"Line":0}},{"line":1001,"address":[14356355],"length":1,"stats":{"Line":0}},{"line":1002,"address":[14356416],"length":1,"stats":{"Line":0}},{"line":1003,"address":[14356454],"length":1,"stats":{"Line":0}},{"line":1004,"address":[14356492],"length":1,"stats":{"Line":0}},{"line":1007,"address":[14356499],"length":1,"stats":{"Line":0}},{"line":1008,"address":[14356577],"length":1,"stats":{"Line":0}},{"line":1011,"address":[14356644],"length":1,"stats":{"Line":0}},{"line":1012,"address":[14356674],"length":1,"stats":{"Line":0}},{"line":1015,"address":[14356778],"length":1,"stats":{"Line":0}},{"line":1018,"address":[14356801],"length":1,"stats":{"Line":0}},{"line":1019,"address":[14356831],"length":1,"stats":{"Line":0}},{"line":1024,"address":[14231854,14230320,14231860],"length":1,"stats":{"Line":0}},{"line":1025,"address":[14230327],"length":1,"stats":{"Line":0}},{"line":1026,"address":[14230351],"length":1,"stats":{"Line":0}},{"line":1027,"address":[14230413],"length":1,"stats":{"Line":0}},{"line":1028,"address":[14230438],"length":1,"stats":{"Line":0}},{"line":1030,"address":[14230483],"length":1,"stats":{"Line":0}},{"line":1031,"address":[14230544],"length":1,"stats":{"Line":0}},{"line":1032,"address":[14230609],"length":1,"stats":{"Line":0}},{"line":1033,"address":[14230687,14230735],"length":1,"stats":{"Line":0}},{"line":1034,"address":[14230876],"length":1,"stats":{"Line":0}},{"line":1037,"address":[14231000],"length":1,"stats":{"Line":0}},{"line":1042,"address":[14230900],"length":1,"stats":{"Line":0}},{"line":1044,"address":[14230932],"length":1,"stats":{"Line":0}},{"line":1046,"address":[14231259],"length":1,"stats":{"Line":0}},{"line":1049,"address":[14231289],"length":1,"stats":{"Line":0}},{"line":1050,"address":[14231367],"length":1,"stats":{"Line":0}},{"line":1053,"address":[14231434],"length":1,"stats":{"Line":0}},{"line":1054,"address":[14231464],"length":1,"stats":{"Line":0}},{"line":1057,"address":[14231568],"length":1,"stats":{"Line":0}},{"line":1060,"address":[14231591],"length":1,"stats":{"Line":0}},{"line":1061,"address":[14231621],"length":1,"stats":{"Line":0}},{"line":1066,"address":[14287666,14285904,14287660],"length":1,"stats":{"Line":0}},{"line":1067,"address":[14285911],"length":1,"stats":{"Line":0}},{"line":1068,"address":[14285935],"length":1,"stats":{"Line":0}},{"line":1069,"address":[14286000],"length":1,"stats":{"Line":0}},{"line":1070,"address":[14286028],"length":1,"stats":{"Line":0}},{"line":1072,"address":[14286076],"length":1,"stats":{"Line":0}},{"line":1073,"address":[14286137],"length":1,"stats":{"Line":0}},{"line":1074,"address":[14286202],"length":1,"stats":{"Line":0}},{"line":1075,"address":[14286280,14286328],"length":1,"stats":{"Line":0}},{"line":1076,"address":[14286469],"length":1,"stats":{"Line":0}},{"line":1079,"address":[14286593],"length":1,"stats":{"Line":0}},{"line":1084,"address":[14286493],"length":1,"stats":{"Line":0}},{"line":1086,"address":[14286525],"length":1,"stats":{"Line":0}},{"line":1088,"address":[14286852],"length":1,"stats":{"Line":0}},{"line":1091,"address":[14286882],"length":1,"stats":{"Line":0}},{"line":1092,"address":[14286960],"length":1,"stats":{"Line":0}},{"line":1095,"address":[14287035],"length":1,"stats":{"Line":0}},{"line":1096,"address":[14287133,14287042],"length":1,"stats":{"Line":0}},{"line":1098,"address":[14287188],"length":1,"stats":{"Line":0}},{"line":1101,"address":[14287306],"length":1,"stats":{"Line":0}},{"line":1102,"address":[14287337],"length":1,"stats":{"Line":0}},{"line":1103,"address":[14287344,14287435],"length":1,"stats":{"Line":0}},{"line":1136,"address":[14369448,14367952,14369454],"length":1,"stats":{"Line":0}},{"line":1137,"address":[14367959],"length":1,"stats":{"Line":0}},{"line":1138,"address":[14367983],"length":1,"stats":{"Line":0}},{"line":1139,"address":[14368045],"length":1,"stats":{"Line":0}},{"line":1140,"address":[14368070],"length":1,"stats":{"Line":0}},{"line":1142,"address":[14368115],"length":1,"stats":{"Line":0}},{"line":1143,"address":[14368176],"length":1,"stats":{"Line":0}},{"line":1144,"address":[14368241],"length":1,"stats":{"Line":0}},{"line":1145,"address":[14368367,14368319],"length":1,"stats":{"Line":0}},{"line":1146,"address":[14368508],"length":1,"stats":{"Line":0}},{"line":1149,"address":[14368632],"length":1,"stats":{"Line":0}},{"line":1154,"address":[14368532],"length":1,"stats":{"Line":0}},{"line":1156,"address":[14368564],"length":1,"stats":{"Line":0}},{"line":1158,"address":[14368891],"length":1,"stats":{"Line":0}},{"line":1161,"address":[14368921],"length":1,"stats":{"Line":0}},{"line":1162,"address":[14368999],"length":1,"stats":{"Line":0}},{"line":1165,"address":[14369066],"length":1,"stats":{"Line":0}},{"line":1168,"address":[14369089],"length":1,"stats":{"Line":0}},{"line":1169,"address":[14369130],"length":1,"stats":{"Line":0}},{"line":1172,"address":[14369204],"length":1,"stats":{"Line":0}},{"line":1173,"address":[14369245],"length":1,"stats":{"Line":0}},{"line":2097,"address":[14262195,14260304,14262201],"length":1,"stats":{"Line":0}},{"line":2098,"address":[14260311],"length":1,"stats":{"Line":0}},{"line":2099,"address":[14260343],"length":1,"stats":{"Line":0}},{"line":2100,"address":[14260412],"length":1,"stats":{"Line":0}},{"line":2103,"address":[14260460],"length":1,"stats":{"Line":0}},{"line":2105,"address":[14260513],"length":1,"stats":{"Line":0}},{"line":2106,"address":[14260537],"length":1,"stats":{"Line":0}},{"line":2107,"address":[14260602],"length":1,"stats":{"Line":0}},{"line":2108,"address":[14260626],"length":1,"stats":{"Line":0}},{"line":2109,"address":[14260752,14260704],"length":1,"stats":{"Line":0}},{"line":2110,"address":[14260893],"length":1,"stats":{"Line":0}},{"line":2112,"address":[14260925],"length":1,"stats":{"Line":0}},{"line":2113,"address":[14261001],"length":1,"stats":{"Line":0}},{"line":2114,"address":[14261008],"length":1,"stats":{"Line":0}},{"line":2115,"address":[14261158],"length":1,"stats":{"Line":0}},{"line":2118,"address":[14261189],"length":1,"stats":{"Line":0}},{"line":2125,"address":[14261165],"length":1,"stats":{"Line":0}},{"line":2129,"address":[14261412],"length":1,"stats":{"Line":0}},{"line":2130,"address":[14261483,14261427,14261514],"length":1,"stats":{"Line":0}},{"line":2133,"address":[14261547,14261507],"length":1,"stats":{"Line":0}},{"line":2134,"address":[14261711],"length":1,"stats":{"Line":0}},{"line":2135,"address":[14261811],"length":1,"stats":{"Line":0}},{"line":2136,"address":[14261909],"length":1,"stats":{"Line":0}},{"line":2141,"address":[14318128,14319457,14319451],"length":1,"stats":{"Line":0}},{"line":2142,"address":[14318135],"length":1,"stats":{"Line":0}},{"line":2143,"address":[14318164],"length":1,"stats":{"Line":0}},{"line":2144,"address":[14318230],"length":1,"stats":{"Line":0}},{"line":2147,"address":[14318275],"length":1,"stats":{"Line":0}},{"line":2149,"address":[14318328],"length":1,"stats":{"Line":0}},{"line":2150,"address":[14318352],"length":1,"stats":{"Line":0}},{"line":2151,"address":[14318417],"length":1,"stats":{"Line":0}},{"line":2152,"address":[14318441],"length":1,"stats":{"Line":0}},{"line":2153,"address":[14318519,14318567],"length":1,"stats":{"Line":0}},{"line":2154,"address":[14318708],"length":1,"stats":{"Line":0}},{"line":2156,"address":[14318740],"length":1,"stats":{"Line":0}},{"line":2157,"address":[14318816],"length":1,"stats":{"Line":0}},{"line":2158,"address":[14318823],"length":1,"stats":{"Line":0}},{"line":2159,"address":[14318973],"length":1,"stats":{"Line":0}},{"line":2162,"address":[14319004],"length":1,"stats":{"Line":0}},{"line":2169,"address":[14318980],"length":1,"stats":{"Line":0}},{"line":2171,"address":[14319219],"length":1,"stats":{"Line":0}},{"line":2174,"address":[14319242],"length":1,"stats":{"Line":0}},{"line":2175,"address":[14319269],"length":1,"stats":{"Line":0}},{"line":2180,"address":[14315039,14312432,14315033],"length":1,"stats":{"Line":0}},{"line":2181,"address":[14312439],"length":1,"stats":{"Line":0}},{"line":2182,"address":[14312471],"length":1,"stats":{"Line":0}},{"line":2183,"address":[14312540],"length":1,"stats":{"Line":0}},{"line":2186,"address":[14312588],"length":1,"stats":{"Line":0}},{"line":2188,"address":[14312641],"length":1,"stats":{"Line":0}},{"line":2189,"address":[14312665],"length":1,"stats":{"Line":0}},{"line":2190,"address":[14312730],"length":1,"stats":{"Line":0}},{"line":2191,"address":[14312754],"length":1,"stats":{"Line":0}},{"line":2192,"address":[14312832,14312880],"length":1,"stats":{"Line":0}},{"line":2193,"address":[14313021],"length":1,"stats":{"Line":0}},{"line":2195,"address":[14313053],"length":1,"stats":{"Line":0}},{"line":2196,"address":[14313129],"length":1,"stats":{"Line":0}},{"line":2197,"address":[14313136],"length":1,"stats":{"Line":0}},{"line":2198,"address":[14313286],"length":1,"stats":{"Line":0}},{"line":2201,"address":[14313317],"length":1,"stats":{"Line":0}},{"line":2208,"address":[14313293],"length":1,"stats":{"Line":0}},{"line":2210,"address":[14313516,14313605],"length":1,"stats":{"Line":0}},{"line":2211,"address":[14313626],"length":1,"stats":{"Line":0}},{"line":2218,"address":[14313581],"length":1,"stats":{"Line":0}},{"line":2230,"address":[14313969],"length":1,"stats":{"Line":0}},{"line":2231,"address":[14314107,14314055],"length":1,"stats":{"Line":0}},{"line":2235,"address":[14314208],"length":1,"stats":{"Line":0}},{"line":2242,"address":[14314419],"length":1,"stats":{"Line":0}},{"line":2243,"address":[14314505,14314588,14314557],"length":1,"stats":{"Line":0}},{"line":2244,"address":[14314621,14314581],"length":1,"stats":{"Line":0}},{"line":2249,"address":[14245808,14245959,14244544],"length":1,"stats":{"Line":0}},{"line":2250,"address":[14244551],"length":1,"stats":{"Line":0}},{"line":2251,"address":[14244580],"length":1,"stats":{"Line":0}},{"line":2252,"address":[14244646],"length":1,"stats":{"Line":0}},{"line":2255,"address":[14244691],"length":1,"stats":{"Line":0}},{"line":2257,"address":[14244744],"length":1,"stats":{"Line":0}},{"line":2258,"address":[14244768],"length":1,"stats":{"Line":0}},{"line":2259,"address":[14244833],"length":1,"stats":{"Line":0}},{"line":2260,"address":[14244857],"length":1,"stats":{"Line":0}},{"line":2261,"address":[14244935,14244983],"length":1,"stats":{"Line":0}},{"line":2262,"address":[14245124],"length":1,"stats":{"Line":0}},{"line":2264,"address":[14245156],"length":1,"stats":{"Line":0}},{"line":2265,"address":[14245232],"length":1,"stats":{"Line":0}},{"line":2266,"address":[14245239],"length":1,"stats":{"Line":0}},{"line":2267,"address":[14245389],"length":1,"stats":{"Line":0}},{"line":2270,"address":[14245420],"length":1,"stats":{"Line":0}},{"line":2277,"address":[14245396],"length":1,"stats":{"Line":0}},{"line":2279,"address":[14245635],"length":1,"stats":{"Line":0}},{"line":2282,"address":[14245658],"length":1,"stats":{"Line":0}},{"line":2283,"address":[14245665],"length":1,"stats":{"Line":0}},{"line":2284,"address":[14245708,14245760],"length":1,"stats":{"Line":0}},{"line":2773,"address":[14235984,14238149,14238173],"length":1,"stats":{"Line":0}},{"line":2774,"address":[14235991],"length":1,"stats":{"Line":0}},{"line":2775,"address":[14236040],"length":1,"stats":{"Line":0}},{"line":2776,"address":[14236115],"length":1,"stats":{"Line":0}},{"line":2778,"address":[14236163],"length":1,"stats":{"Line":0}},{"line":2779,"address":[14236227],"length":1,"stats":{"Line":0}},{"line":2780,"address":[14236295],"length":1,"stats":{"Line":0}},{"line":2781,"address":[14236335,14236383],"length":1,"stats":{"Line":0}},{"line":2782,"address":[14236524],"length":1,"stats":{"Line":0}},{"line":2785,"address":[14236630],"length":1,"stats":{"Line":0}},{"line":2792,"address":[14236559],"length":1,"stats":{"Line":0}},{"line":2794,"address":[14236845],"length":1,"stats":{"Line":0}},{"line":2797,"address":[14236852],"length":1,"stats":{"Line":0}},{"line":2798,"address":[14236887],"length":1,"stats":{"Line":0}},{"line":2800,"address":[14237006],"length":1,"stats":{"Line":0}},{"line":2803,"address":[14237070],"length":1,"stats":{"Line":0}},{"line":2804,"address":[14237100],"length":1,"stats":{"Line":0}},{"line":2806,"address":[14237212],"length":1,"stats":{"Line":0}},{"line":2807,"address":[14237291,14237235],"length":1,"stats":{"Line":0}},{"line":2809,"address":[14237330],"length":1,"stats":{"Line":0}},{"line":2810,"address":[14237496,14237400],"length":1,"stats":{"Line":0}},{"line":2811,"address":[14237544],"length":1,"stats":{"Line":0}},{"line":2812,"address":[14237648],"length":1,"stats":{"Line":0}},{"line":2813,"address":[14237752],"length":1,"stats":{"Line":0}},{"line":2818,"address":[14321781,14319472,14321757],"length":1,"stats":{"Line":0}},{"line":2819,"address":[14319479],"length":1,"stats":{"Line":0}},{"line":2820,"address":[14319528],"length":1,"stats":{"Line":0}},{"line":2821,"address":[14319603],"length":1,"stats":{"Line":0}},{"line":2823,"address":[14319651],"length":1,"stats":{"Line":0}},{"line":2824,"address":[14319715],"length":1,"stats":{"Line":0}},{"line":2825,"address":[14319783],"length":1,"stats":{"Line":0}},{"line":2826,"address":[14319851],"length":1,"stats":{"Line":0}},{"line":2827,"address":[14319891,14319939],"length":1,"stats":{"Line":0}},{"line":2828,"address":[14320080],"length":1,"stats":{"Line":0}},{"line":2831,"address":[14320186],"length":1,"stats":{"Line":0}},{"line":2838,"address":[14320115],"length":1,"stats":{"Line":0}},{"line":2840,"address":[14320401],"length":1,"stats":{"Line":0}},{"line":2843,"address":[14320408],"length":1,"stats":{"Line":0}},{"line":2844,"address":[14320575],"length":1,"stats":{"Line":0}},{"line":2847,"address":[14320626],"length":1,"stats":{"Line":0}},{"line":2848,"address":[14320661],"length":1,"stats":{"Line":0}},{"line":2850,"address":[14320780],"length":1,"stats":{"Line":0}},{"line":2853,"address":[14320844],"length":1,"stats":{"Line":0}},{"line":2854,"address":[14320874],"length":1,"stats":{"Line":0}},{"line":2856,"address":[14320986],"length":1,"stats":{"Line":0}},{"line":2857,"address":[14321009,14321065],"length":1,"stats":{"Line":0}},{"line":2859,"address":[14321104],"length":1,"stats":{"Line":0}},{"line":2860,"address":[14321270,14321174],"length":1,"stats":{"Line":0}},{"line":2861,"address":[14321318],"length":1,"stats":{"Line":0}},{"line":2862,"address":[14321422],"length":1,"stats":{"Line":0}},{"line":2867,"address":[14340865,14340871,14339504],"length":1,"stats":{"Line":0}},{"line":2868,"address":[14339511],"length":1,"stats":{"Line":0}},{"line":2869,"address":[14339540],"length":1,"stats":{"Line":0}},{"line":2870,"address":[14339606],"length":1,"stats":{"Line":0}},{"line":2872,"address":[14339651],"length":1,"stats":{"Line":0}},{"line":2873,"address":[14339712],"length":1,"stats":{"Line":0}},{"line":2874,"address":[14339777],"length":1,"stats":{"Line":0}},{"line":2875,"address":[14339842],"length":1,"stats":{"Line":0}},{"line":2876,"address":[14339927,14339879],"length":1,"stats":{"Line":0}},{"line":2877,"address":[14340068],"length":1,"stats":{"Line":0}},{"line":2880,"address":[14340168],"length":1,"stats":{"Line":0}},{"line":2887,"address":[14340100],"length":1,"stats":{"Line":0}},{"line":2889,"address":[14340383],"length":1,"stats":{"Line":0}},{"line":2892,"address":[14340390],"length":1,"stats":{"Line":0}},{"line":2893,"address":[14340422],"length":1,"stats":{"Line":0}},{"line":2895,"address":[14340596,14340538],"length":1,"stats":{"Line":0}},{"line":2897,"address":[14340628],"length":1,"stats":{"Line":0}},{"line":2902,"address":[14331840,14333354,14333348],"length":1,"stats":{"Line":0}},{"line":2903,"address":[14331847],"length":1,"stats":{"Line":0}},{"line":2904,"address":[14331876],"length":1,"stats":{"Line":0}},{"line":2905,"address":[14331942],"length":1,"stats":{"Line":0}},{"line":2907,"address":[14331987],"length":1,"stats":{"Line":0}},{"line":2908,"address":[14332048],"length":1,"stats":{"Line":0}},{"line":2909,"address":[14332113],"length":1,"stats":{"Line":0}},{"line":2910,"address":[14332198,14332150],"length":1,"stats":{"Line":0}},{"line":2911,"address":[14332339],"length":1,"stats":{"Line":0}},{"line":2914,"address":[14332439],"length":1,"stats":{"Line":0}},{"line":2921,"address":[14332371],"length":1,"stats":{"Line":0}},{"line":2923,"address":[14332654],"length":1,"stats":{"Line":0}},{"line":2926,"address":[14332661],"length":1,"stats":{"Line":0}},{"line":2927,"address":[14332693],"length":1,"stats":{"Line":0}},{"line":2929,"address":[14332809],"length":1,"stats":{"Line":0}},{"line":2932,"address":[14332857],"length":1,"stats":{"Line":0}},{"line":2933,"address":[14332889],"length":1,"stats":{"Line":0}},{"line":2935,"address":[14333002,14333060],"length":1,"stats":{"Line":0}},{"line":2937,"address":[14333092],"length":1,"stats":{"Line":0}},{"line":2942,"address":[14271693,14271699,14270224],"length":1,"stats":{"Line":0}},{"line":2943,"address":[14270231],"length":1,"stats":{"Line":0}},{"line":2944,"address":[14270260],"length":1,"stats":{"Line":0}},{"line":2945,"address":[14270326],"length":1,"stats":{"Line":0}},{"line":2947,"address":[14270371],"length":1,"stats":{"Line":0}},{"line":2948,"address":[14270432],"length":1,"stats":{"Line":0}},{"line":2949,"address":[14270497],"length":1,"stats":{"Line":0}},{"line":2950,"address":[14270562],"length":1,"stats":{"Line":0}},{"line":2951,"address":[14270647,14270599],"length":1,"stats":{"Line":0}},{"line":2952,"address":[14270788],"length":1,"stats":{"Line":0}},{"line":2955,"address":[14270820],"length":1,"stats":{"Line":0}},{"line":2956,"address":[14270896],"length":1,"stats":{"Line":0}},{"line":2959,"address":[14270927],"length":1,"stats":{"Line":0}},{"line":2966,"address":[14270903],"length":1,"stats":{"Line":0}},{"line":2968,"address":[14271142],"length":1,"stats":{"Line":0}},{"line":2970,"address":[14271149],"length":1,"stats":{"Line":0}},{"line":2971,"address":[14271181],"length":1,"stats":{"Line":0}},{"line":2973,"address":[14271297],"length":1,"stats":{"Line":0}},{"line":2976,"address":[14271369],"length":1,"stats":{"Line":0}},{"line":2979,"address":[14271392],"length":1,"stats":{"Line":0}},{"line":2980,"address":[14271422],"length":1,"stats":{"Line":0}},{"line":2985,"address":[14243142,14243166,14240992],"length":1,"stats":{"Line":0}},{"line":2986,"address":[14240999],"length":1,"stats":{"Line":0}},{"line":2987,"address":[14241039],"length":1,"stats":{"Line":0}},{"line":2988,"address":[14241108],"length":1,"stats":{"Line":0}},{"line":2990,"address":[14241156],"length":1,"stats":{"Line":0}},{"line":2991,"address":[14241217],"length":1,"stats":{"Line":0}},{"line":2992,"address":[14241282],"length":1,"stats":{"Line":0}},{"line":2993,"address":[14241347],"length":1,"stats":{"Line":0}},{"line":2994,"address":[14241384,14241432],"length":1,"stats":{"Line":0}},{"line":2995,"address":[14241573],"length":1,"stats":{"Line":0}},{"line":2998,"address":[14241605],"length":1,"stats":{"Line":0}},{"line":2999,"address":[14241681],"length":1,"stats":{"Line":0}},{"line":3002,"address":[14241712],"length":1,"stats":{"Line":0}},{"line":3009,"address":[14241688],"length":1,"stats":{"Line":0}},{"line":3011,"address":[14241927],"length":1,"stats":{"Line":0}},{"line":3013,"address":[14241934],"length":1,"stats":{"Line":0}},{"line":3014,"address":[14241966],"length":1,"stats":{"Line":0}},{"line":3016,"address":[14242082],"length":1,"stats":{"Line":0}},{"line":3019,"address":[14242154],"length":1,"stats":{"Line":0}},{"line":3026,"address":[14242225],"length":1,"stats":{"Line":0}},{"line":3029,"address":[14242292],"length":1,"stats":{"Line":0}},{"line":3030,"address":[14242322],"length":1,"stats":{"Line":0}},{"line":3032,"address":[14242434],"length":1,"stats":{"Line":0}},{"line":3033,"address":[14242513,14242457],"length":1,"stats":{"Line":0}},{"line":3035,"address":[14242552],"length":1,"stats":{"Line":0}},{"line":3036,"address":[14242622,14242718],"length":1,"stats":{"Line":0}},{"line":3037,"address":[14242766],"length":1,"stats":{"Line":0}},{"line":3038,"address":[14242870],"length":1,"stats":{"Line":0}},{"line":3043,"address":[14321808,14323735,14323741],"length":1,"stats":{"Line":0}},{"line":3044,"address":[14321815],"length":1,"stats":{"Line":0}},{"line":3045,"address":[14321844],"length":1,"stats":{"Line":0}},{"line":3046,"address":[14321910],"length":1,"stats":{"Line":0}},{"line":3048,"address":[14321955],"length":1,"stats":{"Line":0}},{"line":3049,"address":[14322016],"length":1,"stats":{"Line":0}},{"line":3050,"address":[14322081],"length":1,"stats":{"Line":0}},{"line":3051,"address":[14322146],"length":1,"stats":{"Line":0}},{"line":3052,"address":[14322183,14322231],"length":1,"stats":{"Line":0}},{"line":3053,"address":[14322372],"length":1,"stats":{"Line":0}},{"line":3056,"address":[14322472],"length":1,"stats":{"Line":0}},{"line":3063,"address":[14322404],"length":1,"stats":{"Line":0}},{"line":3066,"address":[14322695],"length":1,"stats":{"Line":0}},{"line":3073,"address":[14322671],"length":1,"stats":{"Line":0}},{"line":3076,"address":[14322910],"length":1,"stats":{"Line":0}},{"line":3077,"address":[14322933],"length":1,"stats":{"Line":0}},{"line":3080,"address":[14322940],"length":1,"stats":{"Line":0}},{"line":3081,"address":[14322972],"length":1,"stats":{"Line":0}},{"line":3083,"address":[14323088],"length":1,"stats":{"Line":0}},{"line":3085,"address":[14323176],"length":1,"stats":{"Line":0}},{"line":3088,"address":[14323199],"length":1,"stats":{"Line":0}},{"line":3089,"address":[14323214,14323273],"length":1,"stats":{"Line":0}},{"line":3090,"address":[14323390],"length":1,"stats":{"Line":0}},{"line":3091,"address":[14323460],"length":1,"stats":{"Line":0}},{"line":3096,"address":[14346272,14346266,14343504],"length":1,"stats":{"Line":0}},{"line":3097,"address":[14343511],"length":1,"stats":{"Line":0}},{"line":3098,"address":[14343540],"length":1,"stats":{"Line":0}},{"line":3099,"address":[14343606],"length":1,"stats":{"Line":0}},{"line":3101,"address":[14343651],"length":1,"stats":{"Line":0}},{"line":3102,"address":[14343712],"length":1,"stats":{"Line":0}},{"line":3103,"address":[14343777],"length":1,"stats":{"Line":0}},{"line":3104,"address":[14343842],"length":1,"stats":{"Line":0}},{"line":3105,"address":[14343927,14343879],"length":1,"stats":{"Line":0}},{"line":3106,"address":[14344068],"length":1,"stats":{"Line":0}},{"line":3109,"address":[14344100],"length":1,"stats":{"Line":0}},{"line":3110,"address":[14344176],"length":1,"stats":{"Line":0}},{"line":3113,"address":[14344207],"length":1,"stats":{"Line":0}},{"line":3120,"address":[14344183],"length":1,"stats":{"Line":0}},{"line":3123,"address":[14344422],"length":1,"stats":{"Line":0}},{"line":3125,"address":[14344429],"length":1,"stats":{"Line":0}},{"line":3126,"address":[14344461],"length":1,"stats":{"Line":0}},{"line":3128,"address":[14344577],"length":1,"stats":{"Line":0}},{"line":3131,"address":[14344625],"length":1,"stats":{"Line":0}},{"line":3132,"address":[14344719,14344663],"length":1,"stats":{"Line":0}},{"line":3133,"address":[14344838],"length":1,"stats":{"Line":0}},{"line":3136,"address":[14345060],"length":1,"stats":{"Line":0}},{"line":3139,"address":[14345067],"length":1,"stats":{"Line":0}},{"line":3140,"address":[14345105,14345164],"length":1,"stats":{"Line":0}},{"line":3141,"address":[14345283],"length":1,"stats":{"Line":0}},{"line":3144,"address":[14345481],"length":1,"stats":{"Line":0}},{"line":3145,"address":[14345545],"length":1,"stats":{"Line":0}},{"line":3148,"address":[14345596],"length":1,"stats":{"Line":0}},{"line":3149,"address":[14345690,14345634],"length":1,"stats":{"Line":0}},{"line":3150,"address":[14345809],"length":1,"stats":{"Line":0}},{"line":3155,"address":[14256765,14255152,14256771],"length":1,"stats":{"Line":0}},{"line":3156,"address":[14255159],"length":1,"stats":{"Line":0}},{"line":3157,"address":[14255191],"length":1,"stats":{"Line":0}},{"line":3158,"address":[14255260],"length":1,"stats":{"Line":0}},{"line":3160,"address":[14255308],"length":1,"stats":{"Line":0}},{"line":3161,"address":[14255369],"length":1,"stats":{"Line":0}},{"line":3162,"address":[14255434],"length":1,"stats":{"Line":0}},{"line":3163,"address":[14255519,14255471],"length":1,"stats":{"Line":0}},{"line":3164,"address":[14255660],"length":1,"stats":{"Line":0}},{"line":3167,"address":[14255760],"length":1,"stats":{"Line":0}},{"line":3174,"address":[14255692],"length":1,"stats":{"Line":0}},{"line":3176,"address":[14255975],"length":1,"stats":{"Line":0}},{"line":3179,"address":[14256004],"length":1,"stats":{"Line":0}},{"line":3180,"address":[14256011],"length":1,"stats":{"Line":0}},{"line":3182,"address":[14256185,14256127],"length":1,"stats":{"Line":0}},{"line":3183,"address":[14256217],"length":1,"stats":{"Line":0}},{"line":3186,"address":[14256271],"length":1,"stats":{"Line":0}},{"line":3187,"address":[14256325],"length":1,"stats":{"Line":0}},{"line":3189,"address":[14256416,14256474],"length":1,"stats":{"Line":0}},{"line":3190,"address":[14256506],"length":1,"stats":{"Line":0}}],"covered":3,"coverable":436},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_bid.rs"],"content":"/// Minimized test suite for bid functionality\n/// Coverage: placement/withdrawal, invoice status gating, indexing/query correctness\n///\n/// Test Categories (Core Only):\n/// 1. Status Gating - verify bids only work on verified invoices\n/// 2. Withdrawal - authorize only bid owner can withdraw\n/// 3. Indexing - multiple bids properly indexed and queryable\n/// 4. Ranking - profit-based bid comparison works correctly\nuse super::*;\nuse crate::bid::BidStatus;\nuse crate::invoice::InvoiceCategory;\nuse soroban_sdk::{\n    testutils::{Address as _, Ledger},\n    Address, BytesN, Env, String, Vec,\n};\n\n// Helper: Setup contract with admin\nfn setup() -\u003e (Env, QuickLendXContractClient\u003c'static\u003e) {\n    let env = Env::default();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    (env, client)\n}\n\n// Helper: Create verified investor - using same pattern as test.rs\nfn add_verified_investor(env: \u0026Env, client: \u0026QuickLendXContractClient, limit: i128) -\u003e Address {\n    let investor = Address::generate(env);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(env, \"KYC\"));\n    client.verify_investor(\u0026investor, \u0026limit);\n    investor\n}\n\n// Helper: Create verified invoice\nfn create_verified_invoice(\n    env: \u0026Env,\n    client: \u0026QuickLendXContractClient,\n    _admin: \u0026Address,\n    business: \u0026Address,\n    amount: i128,\n) -\u003e BytesN\u003c32\u003e {\n    let currency = Address::generate(env);\n    let due_date = env.ledger().timestamp() + 86400;\n\n    let invoice_id = client.store_invoice(\n        business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(env, \"Invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(env),\n    );\n\n    let _ = client.try_verify_invoice(\u0026invoice_id);\n    invoice_id\n}\n\n// ============================================================================\n// Category 1: Status Gating - Invoice Verification Required\n// ============================================================================\n\n/// Core Test: Bid on pending (non-verified) invoice fails\n#[test]\nfn test_bid_placement_non_verified_invoice_fails() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n\n    // Create pending invoice (not verified)\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u002610_000,\n        \u0026currency,\n        \u0026(env.ledger().timestamp() + 86400),\n        \u0026String::from_str(\u0026env, \"Pending\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n\n    // Attempt bid on pending invoice should fail\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n    assert!(result.is_err(), \"Bid on pending invoice must fail\");\n}\n\n/// Core Test: Bid on verified invoice succeeds\n#[test]\nfn test_bid_placement_verified_invoice_succeeds() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Bid on verified invoice should succeed\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n    assert!(result.is_ok(), \"Bid on verified invoice must succeed\");\n\n    let bid_id = result.unwrap().unwrap();\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some());\n    assert_eq!(bid.unwrap().status, BidStatus::Placed);\n}\n\n/// Core Test: Investment limit enforced\n#[test]\nfn test_bid_placement_respects_investment_limit() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 1_000); // Low limit\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Bid exceeding limit should fail\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u00262_000, \u00263_000);\n    assert!(result.is_err(), \"Bid exceeding investment limit must fail\");\n}\n\n// ============================================================================\n// Category 2: Withdrawal - Authorization and State Constraints\n// ============================================================================\n\n/// Core Test: Bid owner can withdraw own bid\n#[test]\nfn test_bid_withdrawal_by_owner_succeeds() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n\n    // Withdraw should succeed\n    let result = client.try_withdraw_bid(\u0026bid_id);\n    assert!(result.is_ok(), \"Owner bid withdrawal must succeed\");\n\n    // Verify withdrawn\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some());\n    assert_eq!(bid.unwrap().status, BidStatus::Withdrawn);\n}\n\n/// Core Test: Only Placed bids can be withdrawn\n#[test]\nfn test_bid_withdrawal_only_placed_bids() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n\n    // Withdraw once\n    let _ = client.try_withdraw_bid(\u0026bid_id);\n\n    // Second withdraw attempt should fail\n    let result = client.try_withdraw_bid(\u0026bid_id);\n    assert!(result.is_err(), \"Cannot withdraw non-Placed bid\");\n}\n\n// ============================================================================\n// Category 3: Indexing \u0026 Query Correctness - Multiple Bids\n// ============================================================================\n\n/// Core Test: Multiple bids indexed and queryable by status\n#[test]\nfn test_multiple_bids_indexing_and_query() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor3 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // Place 3 bids\n    let bid_id_1 = client.place_bid(\u0026investor1, \u0026invoice_id, \u002610_000, \u002612_000);\n    let bid_id_2 = client.place_bid(\u0026investor2, \u0026invoice_id, \u002615_000, \u002618_000);\n    let bid_id_3 = client.place_bid(\u0026investor3, \u0026invoice_id, \u002620_000, \u002624_000);\n\n    // Query placed bids\n    let placed_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed_bids.len(), 3, \"Should have 3 placed bids\");\n\n    // Verify all bid IDs present\n    let found_1 = placed_bids.iter().any(|b| b.bid_id == bid_id_1);\n    let found_2 = placed_bids.iter().any(|b| b.bid_id == bid_id_2);\n    let found_3 = placed_bids.iter().any(|b| b.bid_id == bid_id_3);\n    assert!(found_1 \u0026\u0026 found_2 \u0026\u0026 found_3, \"All bid IDs must be indexed\");\n\n    // Withdraw one and verify status filtering\n    let _ = client.try_withdraw_bid(\u0026bid_id_1);\n    let placed_after = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(\n        placed_after.len(),\n        2,\n        \"Should have 2 placed bids after withdrawal\"\n    );\n\n    let withdrawn_bids = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Withdrawn);\n    assert_eq!(withdrawn_bids.len(), 1, \"Should have 1 withdrawn bid\");\n}\n\n/// Core Test: Query by investor works correctly\n#[test]\nfn test_query_bids_by_investor() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id_1 = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n    let invoice_id_2 = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // Investor1 places 2 bids on different invoices\n    let _bid_1a = client.place_bid(\u0026investor1, \u0026invoice_id_1, \u002610_000, \u002612_000);\n    let _bid_1b = client.place_bid(\u0026investor1, \u0026invoice_id_2, \u002615_000, \u002618_000);\n\n    // Investor2 places 1 bid\n    let _bid_2 = client.place_bid(\u0026investor2, \u0026invoice_id_1, \u002620_000, \u002624_000);\n\n    // Query investor1 bids on invoice 1\n    let inv1_bids = client.get_bids_by_investor(\u0026invoice_id_1, \u0026investor1);\n    assert_eq!(\n        inv1_bids.len(),\n        1,\n        \"Investor1 should have 1 bid on invoice 1\"\n    );\n\n    // Query investor2 bids on invoice 1\n    let inv2_bids = client.get_bids_by_investor(\u0026invoice_id_1, \u0026investor2);\n    assert_eq!(\n        inv2_bids.len(),\n        1,\n        \"Investor2 should have 1 bid on invoice 1\"\n    );\n}\n\n// ============================================================================\n// Category 4: Bid Ranking - Profit-Based Comparison Logic\n// ============================================================================\n\n/// Core Test: Best bid selection based on profit margin\n#[test]\nfn test_bid_ranking_by_profit() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor3 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // Place bids with different profit margins\n    // investor1: profit = 12k - 10k = 2k\n    let _bid_1 = client.place_bid(\u0026investor1, \u0026invoice_id, \u002610_000, \u002612_000);\n\n    // investor2: profit = 18k - 15k = 3k (highest)\n    let _bid_2 = client.place_bid(\u0026investor2, \u0026invoice_id, \u002615_000, \u002618_000);\n\n    // investor3: profit = 13k - 12k = 1k (lowest)\n    let _bid_3 = client.place_bid(\u0026investor3, \u0026invoice_id, \u002612_000, \u002613_000);\n\n    // Best bid should be investor2 (highest profit)\n    let best_bid = client.get_best_bid(\u0026invoice_id);\n    assert!(best_bid.is_some());\n    assert_eq!(\n        best_bid.unwrap().investor,\n        investor2,\n        \"Best bid must have highest profit\"\n    );\n\n    // Ranked bids should order by profit descending\n    let ranked = client.get_ranked_bids(\u0026invoice_id);\n    assert_eq!(ranked.len(), 3, \"Should have 3 ranked bids\");\n    assert_eq!(\n        ranked.get(0).unwrap().investor,\n        investor2,\n        \"Rank 1: investor2 (profit 3k)\"\n    );\n    assert_eq!(\n        ranked.get(1).unwrap().investor,\n        investor1,\n        \"Rank 2: investor1 (profit 2k)\"\n    );\n    assert_eq!(\n        ranked.get(2).unwrap().investor,\n        investor3,\n        \"Rank 3: investor3 (profit 1k)\"\n    );\n}\n\n/// Core Test: Best bid ignores withdrawn bids\n#[test]\nfn test_best_bid_excludes_withdrawn() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor1 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let investor2 = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 100_000);\n\n    // investor1: profit = 2k\n    let _bid_1 = client.place_bid(\u0026investor1, \u0026invoice_id, \u002610_000, \u002612_000);\n\n    // investor2: profit = 10k (best initially)\n    let bid_2 = client.place_bid(\u0026investor2, \u0026invoice_id, \u002615_000, \u002625_000);\n\n    // Withdraw best bid\n    let _ = client.try_withdraw_bid(\u0026bid_2);\n\n    // Best bid should now be investor1\n    let best = client.get_best_bid(\u0026invoice_id);\n    assert!(best.is_some());\n    assert_eq!(\n        best.unwrap().investor,\n        investor1,\n        \"Best bid must skip withdrawn bids\"\n    );\n}\n\n/// Core Test: Bid expiration cleanup\n#[test]\nfn test_bid_expiration_and_cleanup() {\n    let (env, client) = setup();\n    env.mock_all_auths();\n    let admin = Address::generate(\u0026env);\n    let _ = client.set_admin(\u0026admin);\n    let investor = add_verified_investor(\u0026env, \u0026client, 100_000);\n    let business = Address::generate(\u0026env);\n\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026admin, \u0026business, 10_000);\n\n    // Place bid\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u00265_000, \u00266_000);\n\n    let placed = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(placed.len(), 1, \"Should have 1 placed bid\");\n\n    // Advance time past expiration (7 days = 604800 seconds)\n    env.ledger()\n        .set_timestamp(env.ledger().timestamp() + 604800 + 1);\n\n    // Query to trigger cleanup\n    let placed_after = client.get_bids_by_status(\u0026invoice_id, \u0026BidStatus::Placed);\n    assert_eq!(\n        placed_after.len(),\n        0,\n        \"Placed bids should be empty after expiration\"\n    );\n\n    // Bid should be marked expired\n    let bid = client.get_bid(\u0026bid_id);\n    assert!(bid.is_some());\n    assert_eq!(\n        bid.unwrap().status,\n        BidStatus::Expired,\n        \"Bid must be marked expired\"\n    );\n}\n","traces":[{"line":18,"address":[15427872,15428269,15428263],"length":1,"stats":{"Line":0}},{"line":19,"address":[15427888],"length":1,"stats":{"Line":0}},{"line":20,"address":[15427933],"length":1,"stats":{"Line":0}},{"line":21,"address":[15427996],"length":1,"stats":{"Line":0}},{"line":22,"address":[15428045],"length":1,"stats":{"Line":0}},{"line":26,"address":[15409488,15409753,15409759],"length":1,"stats":{"Line":0}},{"line":27,"address":[15409540],"length":1,"stats":{"Line":0}},{"line":28,"address":[15409559,15409638],"length":1,"stats":{"Line":0}},{"line":29,"address":[15409713],"length":1,"stats":{"Line":0}},{"line":30,"address":[15409725],"length":1,"stats":{"Line":0}},{"line":34,"address":[15410523,15409776,15410529],"length":1,"stats":{"Line":0}},{"line":41,"address":[15409856],"length":1,"stats":{"Line":0}},{"line":42,"address":[15409931,15409883],"length":1,"stats":{"Line":0}},{"line":44,"address":[15410182],"length":1,"stats":{"Line":0}},{"line":49,"address":[15410077],"length":1,"stats":{"Line":0}},{"line":51,"address":[15410109],"length":1,"stats":{"Line":0}},{"line":54,"address":[15410435],"length":1,"stats":{"Line":0}},{"line":55,"address":[15410481],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":18},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_escrow.rs"],"content":"/// Comprehensive test suite for escrow funding flow\n/// \n/// Test Coverage:\n/// 1. Authorization: Only invoice owner can accept bids\n/// 2. State Validation: Only verified invoices can be funded\n/// 3. Token Transfer: Funds are locked exactly once with correct amounts\n/// 4. Idempotency: Rejects double-accept attempts\n/// 5. Edge Cases: Invalid states, unauthorized access, fund verification\n/// \n/// Security Notes:\n/// - Uses soroban-sdk testutils token patterns for realistic token simulation\n/// - All auth requirements verified via require_auth() checks\n/// - Escrow state transitions validated at each step\n/// - Token balances verified before/after transfers\n\nuse super::*;\nuse crate::bid::BidStatus;\nuse crate::invoice::{InvoiceCategory, InvoiceStatus};\nuse crate::payments::EscrowStatus;\nuse soroban_sdk::{\n    testutils::Address as _,\n    token, Address, BytesN, Env, String, Vec,\n};\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/// Setup test environment with contract and admin\nfn setup() -\u003e (Env, QuickLendXContractClient\u003c'static\u003e, Address) {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = Address::generate(\u0026env);\n    client.set_admin(\u0026admin);\n    (env, client, admin)\n}\n\n/// Create a Stellar Asset Contract token for testing with proper balances\nfn setup_token(env: \u0026Env, business: \u0026Address, investor: \u0026Address, contract_id: \u0026Address) -\u003e Address {\n    let token_admin = Address::generate(env);\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    \n    let token_client = token::Client::new(env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(env, \u0026currency);\n\n    // Mint tokens to business and investor\n    let initial_balance = 100_000i128;\n    sac_client.mint(business, \u0026initial_balance);\n    sac_client.mint(investor, \u0026initial_balance);\n\n    // Approve contract to spend tokens\n    let expiration = env.ledger().sequence() + 10_000;\n    token_client.approve(business, contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(investor, contract_id, \u0026initial_balance, \u0026expiration);\n\n    currency\n}\n\n/// Create and verify a business\nfn setup_verified_business(env: \u0026Env, client: \u0026QuickLendXContractClient, admin: \u0026Address) -\u003e Address {\n    let business = Address::generate(env);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(env, \"Business KYC\"));\n    client.verify_business(admin, \u0026business);\n    business\n}\n\n/// Create and verify an investor with specified limit\nfn setup_verified_investor(env: \u0026Env, client: \u0026QuickLendXContractClient, limit: i128) -\u003e Address {\n    let investor = Address::generate(env);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(env, \"Investor KYC\"));\n    client.verify_investor(\u0026investor, \u0026limit);\n    investor\n}\n\n/// Create a verified invoice ready for bidding\nfn create_verified_invoice(\n    env: \u0026Env,\n    client: \u0026QuickLendXContractClient,\n    business: \u0026Address,\n    amount: i128,\n    currency: \u0026Address,\n) -\u003e BytesN\u003c32\u003e {\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    let invoice_id = client.store_invoice(\n        business,\n        \u0026amount,\n        currency,\n        \u0026due_date,\n        \u0026String::from_str(env, \"Test Invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(env),\n    );\n    client.verify_invoice(\u0026invoice_id);\n    invoice_id\n}\n\n/// Place a bid on an invoice\nfn place_test_bid(\n    client: \u0026QuickLendXContractClient,\n    investor: \u0026Address,\n    invoice_id: \u0026BytesN\u003c32\u003e,\n    bid_amount: i128,\n    expected_return: i128,\n) -\u003e BytesN\u003c32\u003e {\n    client.place_bid(investor, invoice_id, \u0026bid_amount, \u0026expected_return)\n}\n\n// ============================================================================\n// Test Cases\n// ============================================================================\n\n#[test]\nfn test_only_invoice_owner_can_accept_bid() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Business owner should succeed (with mock_all_auths this always succeeds)\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_ok(), \"Invoice owner should be able to accept bid\");\n    \n    // Verify bid was accepted\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n}\n\n#[test]\nfn test_only_verified_invoice_can_be_funded() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create invoice but DON'T verify it (leave in Pending status)\n    let amount = 10_000i128;\n    let due_date = env.ledger().timestamp() + 86400;\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Unverified Invoice\"),\n        \u0026InvoiceCategory::Services,\n        \u0026Vec::new(\u0026env),\n    );\n    \n    // Attempt to place bid on unverified invoice - should fail\n    let result = client.try_place_bid(\u0026investor, \u0026invoice_id, \u0026amount, \u0026(amount + 1000));\n    assert!(result.is_err(), \"Should not be able to bid on unverified invoice\");\n    \n    // Verify the invoice\n    client.verify_invoice(\u0026invoice_id);\n    \n    // Now bidding should work\n    let bid_id = client.place_bid(\u0026investor, \u0026invoice_id, \u0026amount, \u0026(amount + 1000));\n    \n    // Accepting bid should work on verified invoice\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_ok(), \"Should be able to accept bid on verified invoice\");\n}\n\n#[test]\nfn test_funds_locked_exactly_once() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Check initial balances\n    let investor_balance_before = token_client.balance(\u0026investor);\n    let contract_balance_before = token_client.balance(\u0026contract_id);\n    \n    // Place and accept bid\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Check balances after escrow creation\n    let investor_balance_after = token_client.balance(\u0026investor);\n    let contract_balance_after = token_client.balance(\u0026contract_id);\n    \n    // Verify exact amounts transferred\n    assert_eq!(\n        investor_balance_before - investor_balance_after,\n        amount,\n        \"Investor should have paid exactly the bid amount\"\n    );\n    assert_eq!(\n        contract_balance_after - contract_balance_before,\n        amount,\n        \"Contract should hold exactly the bid amount in escrow\"\n    );\n    \n    // Verify escrow details\n    let escrow_details = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow_details.amount, amount, \"Escrow should hold exact bid amount\");\n    assert_eq!(escrow_details.status, EscrowStatus::Held, \"Escrow should be in Held status\");\n    assert_eq!(escrow_details.investor, investor, \"Escrow should reference correct investor\");\n    assert_eq!(escrow_details.business, business, \"Escrow should reference correct business\");\n}\n\n#[test]\nfn test_rejects_double_accept() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Accept bid first time - should succeed\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_ok(), \"First accept should succeed\");\n    \n    // Verify invoice is now funded\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n    \n    // Attempt to accept same bid again - should fail\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_err(), \"Double accept should fail\");\n    \n    // Also verify we can't accept a different bid on same invoice\n    let investor2 = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Need to setup token for second investor\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n    let initial_balance = 100_000i128;\n    sac_client.mint(\u0026investor2, \u0026initial_balance);\n    let expiration = env.ledger().sequence() + 10_000;\n    token_client.approve(\u0026investor2, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    \n    // Try to place another bid on funded invoice\n    let result = client.try_place_bid(\u0026investor2, \u0026invoice_id, \u0026amount, \u0026(amount + 500));\n    assert!(result.is_err(), \"Should not be able to bid on funded invoice\");\n}\n\n#[test]\nfn test_accept_bid_state_transitions() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Initial state: Invoice should be Verified\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Verified);\n    \n    // Place bid\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Bid should be Placed\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Placed);\n    \n    // Accept bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // After accept: Invoice should be Funded\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n    \n    // After accept: Bid should be Accepted\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Accepted);\n    \n    // After accept: Escrow should exist and be Held\n    let escrow = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(escrow.status, EscrowStatus::Held);\n    assert_eq!(escrow.amount, amount);\n}\n\n#[test]\nfn test_cannot_accept_withdrawn_bid() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Withdraw the bid\n    client.withdraw_bid(\u0026bid_id);\n    \n    // Verify bid is withdrawn\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(bid.status, BidStatus::Withdrawn);\n    \n    // Attempt to accept withdrawn bid - should fail\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    assert!(result.is_err(), \"Should not be able to accept withdrawn bid\");\n}\n\n#[test]\nfn test_escrow_creation_validates_amount() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice\n    let invoice_amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, invoice_amount, \u0026currency);\n    \n    // Place bid with exact amount\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, invoice_amount, invoice_amount + 1000);\n    \n    // Accept bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Verify escrow has correct amount\n    let escrow = client.get_escrow_details(\u0026invoice_id);\n    assert_eq!(\n        escrow.amount, invoice_amount,\n        \"Escrow amount should match bid amount\"\n    );\n    \n    // Verify invoice funded amount matches\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(\n        invoice.funded_amount, invoice_amount,\n        \"Invoice funded amount should match bid amount\"\n    );\n}\n\n#[test]\nfn test_multiple_bids_only_one_accepted() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor1 = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    let investor2 = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor1, \u0026contract_id);\n    \n    // Setup token for investor2\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n    let initial_balance = 100_000i128;\n    sac_client.mint(\u0026investor2, \u0026initial_balance);\n    let expiration = env.ledger().sequence() + 10_000;\n    token_client.approve(\u0026investor2, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    \n    // Create verified invoice\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Place multiple bids\n    let bid_id1 = place_test_bid(\u0026client, \u0026investor1, \u0026invoice_id, amount, amount + 1000);\n    let bid_id2 = place_test_bid(\u0026client, \u0026investor2, \u0026invoice_id, amount, amount + 500);\n    \n    // Accept first bid\n    client.accept_bid(\u0026invoice_id, \u0026bid_id1);\n    \n    // Verify first bid is accepted\n    let bid1 = client.get_bid(\u0026bid_id1).unwrap();\n    assert_eq!(bid1.status, BidStatus::Accepted);\n    \n    // Second bid should still be Placed but can't be accepted\n    let bid2 = client.get_bid(\u0026bid_id2).unwrap();\n    assert_eq!(bid2.status, BidStatus::Placed);\n    \n    // Attempt to accept second bid should fail\n    let result = client.try_accept_bid(\u0026invoice_id, \u0026bid_id2);\n    assert!(result.is_err(), \"Should not accept second bid on funded invoice\");\n}\n\n#[test]\nfn test_token_transfer_idempotency() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    \n    // Create verified invoice\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    \n    // Record balances\n    let investor_before = token_client.balance(\u0026investor);\n    let contract_before = token_client.balance(\u0026contract_id);\n    \n    // Place and accept bid\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Record balances after first accept\n    let investor_after_first = token_client.balance(\u0026investor);\n    let contract_after_first = token_client.balance(\u0026contract_id);\n    \n    // Attempt second accept (should fail)\n    let _ = client.try_accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Balances should remain unchanged after failed second accept\n    let investor_after_second = token_client.balance(\u0026investor);\n    let contract_after_second = token_client.balance(\u0026contract_id);\n    \n    assert_eq!(\n        investor_after_first, investor_after_second,\n        \"Investor balance should not change on failed accept\"\n    );\n    assert_eq!(\n        contract_after_first, contract_after_second,\n        \"Contract balance should not change on failed accept\"\n    );\n    \n    // Verify amounts transferred only once\n    assert_eq!(investor_before - investor_after_first, amount);\n    assert_eq!(contract_after_first - contract_before, amount);\n}\n\n#[test]\nfn test_escrow_invariants() {\n    let (env, client, admin) = setup();\n    let contract_id = client.address.clone();\n    \n    // Setup parties\n    let business = setup_verified_business(\u0026env, \u0026client, \u0026admin);\n    let investor = setup_verified_investor(\u0026env, \u0026client, 50_000);\n    \n    // Setup token\n    let currency = setup_token(\u0026env, \u0026business, \u0026investor, \u0026contract_id);\n    \n    // Create verified invoice and bid\n    let amount = 10_000i128;\n    let invoice_id = create_verified_invoice(\u0026env, \u0026client, \u0026business, amount, \u0026currency);\n    let bid_id = place_test_bid(\u0026client, \u0026investor, \u0026invoice_id, amount, amount + 1000);\n    \n    // Accept bid to create escrow\n    client.accept_bid(\u0026invoice_id, \u0026bid_id);\n    \n    // Verify escrow invariants\n    let escrow = client.get_escrow_details(\u0026invoice_id);\n    \n    // Invariant 1: Escrow amount must be positive\n    assert!(escrow.amount \u003e 0, \"Escrow amount must be positive\");\n    \n    // Invariant 2: Escrow invoice_id must match\n    assert_eq!(escrow.invoice_id, invoice_id, \"Escrow invoice_id must match\");\n    \n    // Invariant 3: Escrow investor must match bid investor\n    let bid = client.get_bid(\u0026bid_id).unwrap();\n    assert_eq!(escrow.investor, bid.investor, \"Escrow investor must match bid investor\");\n    \n    // Invariant 4: Escrow business must match invoice business\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(escrow.business, invoice.business, \"Escrow business must match invoice business\");\n    \n    // Invariant 5: Escrow status must be Held after creation\n    assert_eq!(escrow.status, EscrowStatus::Held, \"Escrow status must be Held after creation\");\n    \n    // Invariant 6: Created timestamp must be set (\u003e= 0)\n    assert!(\n        escrow.created_at \u003c= env.ledger().timestamp(),\n        \"Escrow created_at cannot be in future\"\n    );\n}\n","traces":[{"line":30,"address":[14428112,14428865,14428859],"length":1,"stats":{"Line":0}},{"line":31,"address":[14428128],"length":1,"stats":{"Line":0}},{"line":32,"address":[14428168],"length":1,"stats":{"Line":0}},{"line":33,"address":[14428230],"length":1,"stats":{"Line":0}},{"line":34,"address":[14428252],"length":1,"stats":{"Line":0}},{"line":35,"address":[14428297],"length":1,"stats":{"Line":0}},{"line":36,"address":[14428368],"length":1,"stats":{"Line":0}},{"line":37,"address":[14428420],"length":1,"stats":{"Line":0}},{"line":41,"address":[14404856,14404831,14403920],"length":1,"stats":{"Line":0}},{"line":42,"address":[14403989],"length":1,"stats":{"Line":0}},{"line":44,"address":[14404082,14404029],"length":1,"stats":{"Line":0}},{"line":47,"address":[14404247],"length":1,"stats":{"Line":0}},{"line":48,"address":[14404276],"length":1,"stats":{"Line":0}},{"line":51,"address":[14404346],"length":1,"stats":{"Line":0}},{"line":52,"address":[14404370],"length":1,"stats":{"Line":0}},{"line":53,"address":[14404443],"length":1,"stats":{"Line":0}},{"line":56,"address":[14404483],"length":1,"stats":{"Line":0}},{"line":57,"address":[14404636],"length":1,"stats":{"Line":0}},{"line":58,"address":[14404681],"length":1,"stats":{"Line":0}},{"line":60,"address":[14404721],"length":1,"stats":{"Line":0}},{"line":64,"address":[14408287,14408016,14408293],"length":1,"stats":{"Line":0}},{"line":65,"address":[14408072],"length":1,"stats":{"Line":0}},{"line":66,"address":[14408091,14408171],"length":1,"stats":{"Line":0}},{"line":67,"address":[14408247],"length":1,"stats":{"Line":0}},{"line":68,"address":[14408259],"length":1,"stats":{"Line":0}},{"line":72,"address":[14408591,14408320,14408585],"length":1,"stats":{"Line":0}},{"line":73,"address":[14408372],"length":1,"stats":{"Line":0}},{"line":74,"address":[14408391,14408470],"length":1,"stats":{"Line":0}},{"line":75,"address":[14408545],"length":1,"stats":{"Line":0}},{"line":76,"address":[14408557],"length":1,"stats":{"Line":0}},{"line":80,"address":[14408001,14407376,14407995],"length":1,"stats":{"Line":0}},{"line":87,"address":[14407465,14407634],"length":1,"stats":{"Line":0}},{"line":88,"address":[14407713],"length":1,"stats":{"Line":0}},{"line":93,"address":[14407585],"length":1,"stats":{"Line":0}},{"line":95,"address":[14407615],"length":1,"stats":{"Line":0}},{"line":97,"address":[14407952],"length":1,"stats":{"Line":0}},{"line":98,"address":[14407964],"length":1,"stats":{"Line":0}},{"line":102,"address":[14404880],"length":1,"stats":{"Line":0}},{"line":109,"address":[14404927],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":39},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_fees.rs"],"content":"use super::*;\nuse crate::fees::FeeType;\nuse soroban_sdk::{testutils::Address as _, Address, Env, Map, String};\n\n/// Helper function to set up admin for testing\nfn setup_admin(env: \u0026Env, client: \u0026QuickLendXContractClient) -\u003e Address {\n    let admin = Address::generate(env);\n    client.set_admin(\u0026admin);\n    admin\n}\n\n/// Helper function to create and verify a business\nfn setup_business(env: \u0026Env, client: \u0026QuickLendXContractClient, admin: \u0026Address) -\u003e Address {\n    let business = Address::generate(env);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(env, \"Business KYC\"));\n    client.verify_business(admin, \u0026business);\n    business\n}\n\n/// Helper function to create and verify an investor\nfn setup_investor(env: \u0026Env, client: \u0026QuickLendXContractClient, admin: \u0026Address) -\u003e Address {\n    let investor = Address::generate(env);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(env, \"Investor KYC\"));\n    client.verify_investor(\u0026investor, \u00261_000_000); // 1000 XLM limit\n    investor\n}\n\n/// Simple test to verify the module is loaded\n#[test]\nfn test_module_loaded() {\n    assert_eq!(2 + 2, 4);\n}\n\n/// Test default platform fee configuration (2%)\n#[test]\nfn test_default_platform_fee() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Get default platform fee config\n    let fee_config = client.get_platform_fee();\n    assert_eq!(fee_config.fee_bps, 200); // 2%\n    assert_eq!(fee_config.updated_at, 0); // Not updated yet\n}\n\n/// Test custom platform fee BPS configuration\n#[test]\nfn test_custom_platform_fee_bps() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Test setting custom fee BPS\n    let new_fee_bps = 500; // 5%\n    client.set_platform_fee(\u0026new_fee_bps);\n\n    let updated_config = client.get_platform_fee();\n    assert_eq!(updated_config.fee_bps, new_fee_bps);\n    assert_eq!(updated_config.updated_by, admin);\n}\n\n/// Test that only admin can update platform fee configuration\n#[test]\nfn test_only_admin_can_update_platform_fee() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Test invalid fee (too high) - this should fail\n    let result = client.try_set_platform_fee(\u00261200);\n    assert!(result.is_err());\n\n    // Admin should be able to update fee with valid value\n    client.set_platform_fee(\u0026300);\n}\n\n/// Test platform fee calculation accuracy\n#[test]\nfn test_platform_fee_calculation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Test default 2% fee calculation\n    let investment_amount = 1000; // 1000 units\n    let payment_amount = 1100; // 1100 units (100 profit)\n\n    let (investor_return, platform_fee) =\n        client.calculate_profit(\u0026investment_amount, \u0026payment_amount);\n\n    // Expected: 2% of profit (100) = 2 units\n    assert_eq!(platform_fee, 2);\n    assert_eq!(investor_return, 1098); // 1100 - 2\n\n    // Test with custom fee\n    let admin = setup_admin(\u0026env, \u0026client);\n    client.set_platform_fee(\u0026500); // 5%\n\n    let (investor_return, platform_fee) =\n        client.calculate_profit(\u0026investment_amount, \u0026payment_amount);\n\n    // Expected: 5% of profit (100) = 5 units\n    assert_eq!(platform_fee, 5);\n    assert_eq!(investor_return, 1095); // 1100 - 5\n}\n\n/// Test fee calculation edge cases\n#[test]\nfn test_platform_fee_edge_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Test case: no profit (payment \u003c= investment)\n    let investment_amount = 1000;\n    let payment_amount = 900; // Loss\n\n    let (investor_return, platform_fee) =\n        client.calculate_profit(\u0026investment_amount, \u0026payment_amount);\n\n    assert_eq!(platform_fee, 0);\n    assert_eq!(investor_return, 900);\n\n    // Test case: zero payment\n    let (investor_return, platform_fee) = client.calculate_profit(\u0026investment_amount, \u00260);\n\n    assert_eq!(platform_fee, 0);\n    assert_eq!(investor_return, 0);\n}\n\n/// Test fee initialization\n#[test]\nfn test_fee_system_initialization() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Verify fee structures are initialized\n    let platform_fee = client.get_fee_structure(\u0026FeeType::Platform);\n    assert_eq!(platform_fee.base_fee_bps, 200); // 2%\n    assert!(platform_fee.is_active);\n}\n\n/// Test fee structure updates\n#[test]\nfn test_fee_structure_updates() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Update platform fee structure\n    client.update_fee_structure(\n        \u0026admin,\n        \u0026FeeType::Platform,\n        \u0026300,  // 3%\n        \u002650,   // min fee\n        \u00265000, // max fee\n        \u0026true, // active\n    );\n\n    // Verify update\n    let updated_fee = client.get_fee_structure(\u0026FeeType::Platform);\n    assert_eq!(updated_fee.base_fee_bps, 300);\n    assert_eq!(updated_fee.min_fee, 50);\n    assert_eq!(updated_fee.max_fee, 5000);\n    assert!(updated_fee.is_active);\n}\n\n/// Test only admin can update fee structures\n#[test]\nfn test_only_admin_can_update_fee_structure() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let non_admin = Address::generate(\u0026env);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Non-admin should not be able to update (this would require a try_ method which doesn't exist)\n    // For now, we'll just test that admin can update successfully\n    client.update_fee_structure(\u0026admin, \u0026FeeType::Platform, \u0026400, \u002650, \u00265000, \u0026true);\n}\n\n/// Test transaction fee calculation\n#[test]\nfn test_transaction_fee_calculation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    let transaction_amount = 10_000; // 10,000 units\n\n    // Calculate fees for standard transaction\n    let total_fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026false, // not early payment\n        \u0026false, // not late payment\n    );\n\n    // Platform fee should be 2% of 10,000 = 200\n    // Processing fee should be 0.5% of 10,000 = 50\n    // Verification fee should be 1% of 10,000 = 100\n    // Total: 350\n    assert_eq!(total_fees, 350);\n}\n\n/// Test volume tier discounts\n#[test]\nfn test_volume_tier_discounts() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Get initial volume data (should be Standard tier)\n    let volume_data = client.get_user_volume_data(\u0026user);\n    assert_eq!(volume_data.current_tier, crate::fees::VolumeTier::Standard);\n\n    // Simulate high volume to reach Gold tier\n    for _ in 0..6 {\n        client.update_user_transaction_volume(\u0026user, \u0026100_000_000_000); // 100k XLM\n    }\n\n    let volume_data = client.get_user_volume_data(\u0026user);\n    assert_eq!(volume_data.current_tier, crate::fees::VolumeTier::Gold);\n\n    // Calculate fees - should get 10% discount\n    let transaction_amount = 10_000;\n    let total_fees = client.calculate_transaction_fees(\u0026user, \u0026transaction_amount, \u0026false, \u0026false);\n\n    // Standard fee would be 350, Gold tier gets 10% discount = 315\n    assert_eq!(total_fees, 315);\n}\n\n/// Test early payment discounts\n#[test]\nfn test_early_payment_discounts() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    let transaction_amount = 10_000;\n\n    // Calculate fees for early payment\n    let early_payment_fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026true, // early payment\n        \u0026false,\n    );\n\n    // Calculate fees for regular payment\n    let regular_fees =\n        client.calculate_transaction_fees(\u0026user, \u0026transaction_amount, \u0026false, \u0026false);\n\n    // Early payment should have lower fees\n    assert!(early_payment_fees \u003c regular_fees);\n}\n\n/// Test late payment penalties\n#[test]\nfn test_late_payment_penalties() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Add LatePayment fee structure for testing penalties\n    client.update_fee_structure(\n        \u0026admin,\n        \u0026FeeType::LatePayment,\n        \u0026100,  // 1%\n        \u002650,   // min fee\n        \u00261000, // max fee\n        \u0026true, // active\n    );\n\n    let transaction_amount = 10_000;\n\n    // Calculate fees for late payment\n    let late_payment_fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026false,\n        \u0026true, // late payment\n    );\n\n    // Calculate fees for regular payment\n    let regular_fees =\n        client.calculate_transaction_fees(\u0026user, \u0026transaction_amount, \u0026false, \u0026false);\n\n    // Late payment should have higher fees\n    assert!(late_payment_fees \u003e regular_fees);\n}\n\n/// Test revenue distribution configuration\n#[test]\nfn test_revenue_distribution_config() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let treasury = Address::generate(\u0026env);\n\n    // Configure revenue distribution\n    client.configure_revenue_distribution(\n        \u0026admin, \u0026treasury, \u00265000, // 50% treasury\n        \u00263000, // 30% developer\n        \u00262000, // 20% platform\n        \u0026true, // auto distribution\n        \u00261000, // min distribution amount\n    );\n}\n\n/// Test revenue distribution execution\n#[test]\nfn test_revenue_distribution_execution() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n    let treasury = Address::generate(\u0026env);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Configure revenue distribution\n    client.configure_revenue_distribution(\n        \u0026admin, \u0026treasury, \u00266000,  // 60% treasury\n        \u00262000,  // 20% developer\n        \u00262000,  // 20% platform\n        \u0026false, // manual distribution\n        \u0026100,   // min distribution amount\n    );\n\n    // Collect some fees\n    let mut fees_by_type = Map::new(\u0026env);\n    fees_by_type.set(FeeType::Platform, 200);\n    fees_by_type.set(FeeType::Processing, 50);\n\n    client.collect_transaction_fees(\u0026user, \u0026fees_by_type, \u0026250);\n\n    // Get current period\n    let current_period = env.ledger().timestamp() / 2_592_000; // Weeks\n\n    // Distribute revenue\n    let (treasury_amount, developer_amount, platform_amount) =\n        client.distribute_revenue(\u0026admin, \u0026current_period);\n\n    // Verify distribution: 250 total * 60% = 150 treasury\n    assert_eq!(treasury_amount, 150);\n    assert_eq!(developer_amount, 50); // 250 * 20%\n    assert_eq!(platform_amount, 50); // 250 * 20%\n}\n\n/// Test fee analytics\n#[test]\nfn test_fee_analytics() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Collect some fees\n    let mut fees_by_type = Map::new(\u0026env);\n    fees_by_type.set(FeeType::Platform, 200);\n\n    client.collect_transaction_fees(\u0026user, \u0026fees_by_type, \u0026200);\n\n    // Get current period\n    let current_period = env.ledger().timestamp() / 2_592_000;\n\n    // Get analytics\n    let analytics = client.get_fee_analytics(\u0026current_period);\n    assert_eq!(analytics.total_fees, 200);\n    assert_eq!(analytics.total_transactions, 1);\n}\n\n/// Test fee parameter validation\n#[test]\nfn test_fee_parameter_validation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    // Test valid parameters\n    client.validate_fee_parameters(\u0026200, \u002610, \u00261000);\n\n    // Test invalid base fee BPS (too high) - this would need a try_ method\n    // For now, we'll just test the valid case\n    // let result = client.validate_fee_parameters(\u00261500, \u002610, \u00261000);\n    // assert!(result.is_err());\n\n    // Test invalid min/max fees - this would need a try_ method\n    // let result = client.validate_fee_parameters(\u0026200, \u00261000, \u0026500);\n    // assert!(result.is_err()); // min \u003e max\n}\n\n/// Test treasury receives exact amount in distribution\n#[test]\nfn test_treasury_receives_exact_amount() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n    let treasury = Address::generate(\u0026env);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Configure revenue distribution with 70% to treasury\n    client.configure_revenue_distribution(\n        \u0026admin, \u0026treasury, \u00267000, // 70% treasury\n        \u00262000, // 20% developer\n        \u00261000, // 10% platform\n        \u0026false, \u0026100,\n    );\n\n    // Collect fees\n    let mut fees_by_type = Map::new(\u0026env);\n    fees_by_type.set(FeeType::Platform, 1000);\n\n    client.collect_transaction_fees(\u0026user, \u0026fees_by_type, \u00261000);\n\n    // Get current period\n    let current_period = env.ledger().timestamp() / 2_592_000;\n\n    // Distribute revenue\n    let (treasury_amount, _, _) = client.distribute_revenue(\u0026admin, \u0026current_period);\n\n    // Treasury should receive exactly 70% of 1000 = 700\n    assert_eq!(treasury_amount, 700);\n}\n\n/// Test comprehensive fee calculation with all factors\n#[test]\nfn test_comprehensive_fee_calculation() {\n    let env = Env::default();\n    env.mock_all_auths();\n    let contract_id = env.register(crate::QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    let admin = setup_admin(\u0026env, \u0026client);\n    let user = setup_investor(\u0026env, \u0026client, \u0026admin);\n\n    // Initialize fee system\n    client.initialize_fee_system(\u0026admin);\n\n    // Build up user volume to Platinum tier (15% discount)\n    for _ in 0..20 {\n        client.update_user_transaction_volume(\u0026user, \u0026500_000_000_000); // 500k XLM\n    }\n\n    let volume_data = client.get_user_volume_data(\u0026user);\n    assert_eq!(volume_data.current_tier, crate::fees::VolumeTier::Platinum);\n\n    let transaction_amount = 50_000;\n\n    // Test early payment with Platinum tier discount\n    let fees = client.calculate_transaction_fees(\n        \u0026user,\n        \u0026transaction_amount,\n        \u0026true, // early payment\n        \u0026false,\n    );\n\n    // Calculate expected fees:\n    // Platform: 2% of 50k = 1000, minus tier discount (15%) = 850, minus early payment (10%) = 765\n    // Processing: 0.5% = 250, minus tier discount (15%) = 212.5 -\u003e 213\n    // Verification: 1% = 500, minus tier discount (15%) = 425\n    // Total: 765 + 213 + 425 = 1403\n\n    assert_eq!(fees, 1403);\n}\n","traces":[{"line":6,"address":[13825439,13825312,13825445],"length":1,"stats":{"Line":0}},{"line":7,"address":[13825341],"length":1,"stats":{"Line":0}},{"line":8,"address":[13825370],"length":1,"stats":{"Line":0}},{"line":9,"address":[13825414],"length":1,"stats":{"Line":0}},{"line":13,"address":[13825733,13825727,13825456],"length":1,"stats":{"Line":0}},{"line":14,"address":[13825512],"length":1,"stats":{"Line":0}},{"line":15,"address":[13825531,13825611],"length":1,"stats":{"Line":0}},{"line":16,"address":[13825687],"length":1,"stats":{"Line":0}},{"line":17,"address":[13825699],"length":1,"stats":{"Line":0}},{"line":21,"address":[13825760,13826025,13826031],"length":1,"stats":{"Line":0}},{"line":22,"address":[13825810],"length":1,"stats":{"Line":0}},{"line":23,"address":[13825908,13825829],"length":1,"stats":{"Line":0}},{"line":24,"address":[13825973],"length":1,"stats":{"Line":0}},{"line":25,"address":[13825997],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","test_partial_payments.rs"],"content":"use soroban_sdk::{testutils::{Address as _}, Address, String, Vec, Env, vec, token};\nuse crate::{QuickLendXContract, QuickLendXContractClient};\nuse crate::invoice::{InvoiceCategory, InvoiceStatus};\n\n/// Test partial payment tracking, cumulative totals, and full settlement detection\npub fn test_partial_payments_comprehensive() {\n    let env = Env::default();\n    env.mock_all_auths();\n\n    // Register the contract\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    // Set up token contract\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    // Mint tokens and set up approvals\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\"));\n    client.verify_business(\u0026admin, \u0026business);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\"));\n    client.verify_investor(\u0026investor, \u002610000);\n\n    // Test Case 1: Single partial payment\n    let invoice_id_1 = client.store_invoice(\n        \u0026business,\n        \u00261000, // $10.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice 1 - partial payment\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    // Verify and fund invoice 1\n    client.verify_invoice(\u0026invoice_id_1);\n    let bid_id_1 = client.place_bid(\u0026investor, \u0026invoice_id_1, \u00261000, \u00261050);\n    client.accept_bid(\u0026invoice_id_1, \u0026bid_id_1);\n\n    // Single partial payment\n    let tx1 = String::from_str(\u0026env, \"partial-tx-1\");\n    client.process_partial_payment(\u0026invoice_id_1, \u0026400, \u0026tx1);\n\n    // Verify payment tracking\n    let invoice = client.get_invoice(\u0026invoice_id_1);\n    assert_eq!(invoice.total_paid, 400);\n    assert_eq!(invoice.payment_history.len(), 1);\n    assert_eq!(invoice.payment_progress(), 40);\n    assert_eq!(invoice.status, InvoiceStatus::Funded);\n\n    // Test Case 2: Multiple partial payments\n    let invoice_id_2 = client.store_invoice(\n        \u0026business,\n        \u00262000, // $20.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice 2 - multiple payments\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    // Verify and fund invoice 2\n    client.verify_invoice(\u0026invoice_id_2);\n    let bid_id_2 = client.place_bid(\u0026investor, \u0026invoice_id_2, \u00262000, \u00262100);\n    client.accept_bid(\u0026invoice_id_2, \u0026bid_id_2);\n\n    // Multiple partial payments\n    let tx2_1 = String::from_str(\u0026env, \"partial-tx-2-1\");\n    client.process_partial_payment(\u0026invoice_id_2, \u0026500, \u0026tx2_1);\n\n    let tx2_2 = String::from_str(\u0026env, \"partial-tx-2-2\");\n    client.process_partial_payment(\u0026invoice_id_2, \u0026800, \u0026tx2_2);\n\n    let tx2_3 = String::from_str(\u0026env, \"partial-tx-2-3\");\n    client.process_partial_payment(\u0026invoice_id_2, \u0026700, \u0026tx2_3);\n\n    // Verify cumulative totals and settlement\n    let invoice = client.get_invoice(\u0026invoice_id_2);\n    assert_eq!(invoice.total_paid, 2000);\n    assert_eq!(invoice.payment_history.len(), 3);\n    assert_eq!(invoice.payment_progress(), 100);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert!(invoice.is_fully_paid());\n\n    // Test Case 3: Overpayment handling\n    let invoice_id_3 = client.store_invoice(\n        \u0026business,\n        \u00261500, // $15.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice 3 - overpayment\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    // Verify and fund invoice 3\n    client.verify_invoice(\u0026invoice_id_3);\n    let bid_id_3 = client.place_bid(\u0026investor, \u0026invoice_id_3, \u00261500, \u00261575);\n    client.accept_bid(\u0026invoice_id_3, \u0026bid_id_3);\n\n    // Overpayment - pay more than invoice amount\n    let tx3 = String::from_str(\u0026env, \"overpayment-tx-3\");\n    client.process_partial_payment(\u0026invoice_id_3, \u00261800, \u0026tx3);\n\n    // Verify overpayment handling\n    let invoice = client.get_invoice(\u0026invoice_id_3);\n    assert_eq!(invoice.total_paid, 1800);\n    assert_eq!(invoice.payment_history.len(), 1);\n    assert_eq!(invoice.payment_progress(), 100);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert!(invoice.is_fully_paid());\n\n    // Test Case 4: Payment history integrity\n    // Check that payment records are properly stored\n    let invoice = client.get_invoice(\u0026invoice_id_2);\n\n    // Verify cumulative total matches sum of records\n    let mut calculated_total = 0i128;\n    for record in invoice.payment_history.iter() {\n        calculated_total = calculated_total.saturating_add(record.amount);\n    }\n    assert_eq!(calculated_total, invoice.total_paid);\n\n    // Verify transaction IDs are unique and properly stored\n    let mut tx_ids = Vec::new(\u0026env);\n    for record in invoice.payment_history.iter() {\n        assert!(!tx_ids.contains(\u0026record.transaction_id));\n        tx_ids.push_back(record.transaction_id.clone());\n    }\n}\n\n/// Test settlement edge cases and validation\npub fn test_settlement_edge_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n\n    let contract_id = env.register(QuickLendXContract, ());\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let token_admin = Address::generate(\u0026env);\n\n    // Set up token contract\n    let currency = env\n        .register_stellar_asset_contract_v2(token_admin.clone())\n        .address();\n    let token_client = token::Client::new(\u0026env, \u0026currency);\n    let sac_client = token::StellarAssetClient::new(\u0026env, \u0026currency);\n\n    // Mint tokens and set up approvals\n    let initial_balance = 10_000i128;\n    sac_client.mint(\u0026business, \u0026initial_balance);\n    sac_client.mint(\u0026investor, \u0026initial_balance);\n\n    let expiration = env.ledger().sequence() + 1_000;\n    token_client.approve(\u0026business, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n    token_client.approve(\u0026investor, \u0026contract_id, \u0026initial_balance, \u0026expiration);\n\n    let due_date = env.ledger().timestamp() + 86400;\n\n    // Setup\n    client.set_admin(\u0026admin);\n    client.submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"KYC\"));\n    client.verify_business(\u0026admin, \u0026business);\n    client.submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"KYC\"));\n    client.verify_investor(\u0026investor, \u002610000);\n\n    // Test settlement with exact amount\n    let invoice_id_exact = client.store_invoice(\n        \u0026business, \u00261000, \u0026currency, \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Exact settlement\"), \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    client.verify_invoice(\u0026invoice_id_exact);\n    let bid_id_exact = client.place_bid(\u0026investor, \u0026invoice_id_exact, \u00261000, \u00261050);\n    client.accept_bid(\u0026invoice_id_exact, \u0026bid_id_exact);\n\n    client.settle_invoice(\u0026invoice_id_exact, \u00261000);\n\n    let invoice = client.get_invoice(\u0026invoice_id_exact);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert_eq!(invoice.total_paid, 1000);\n    assert!(invoice.is_fully_paid());\n\n    // Test settlement with overpayment\n    let invoice_id_over = client.store_invoice(\n        \u0026business, \u0026800, \u0026currency, \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Over settlement\"), \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    client.verify_invoice(\u0026invoice_id_over);\n    let bid_id_over = client.place_bid(\u0026investor, \u0026invoice_id_over, \u0026800, \u0026840);\n    client.accept_bid(\u0026invoice_id_over, \u0026bid_id_over);\n\n    client.settle_invoice(\u0026invoice_id_over, \u00261000);\n\n    let invoice = client.get_invoice(\u0026invoice_id_over);\n    assert_eq!(invoice.status, InvoiceStatus::Paid);\n    assert_eq!(invoice.total_paid, 1000);\n    assert!(invoice.is_fully_paid());\n\n    // Test settlement validation errors - skipped as Soroban panics on invalid inputs\n    let invoice_id_invalid = client.store_invoice(\n        \u0026business, \u0026500, \u0026currency, \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invalid settlement\"), \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\")]\n    );\n\n    client.verify_invoice(\u0026invoice_id_invalid);\n    // Note: Invalid settlement operations would panic in Soroban\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_partial_payments_validation() {\n        test_partial_payments_comprehensive();\n    }\n\n    #[test]\n    fn test_settlement_validation() {\n        test_settlement_edge_cases();\n    }\n}\n","traces":[{"line":6,"address":[13857881,13850400,13857791],"length":1,"stats":{"Line":1}},{"line":7,"address":[13850422],"length":1,"stats":{"Line":1}},{"line":8,"address":[13850455],"length":1,"stats":{"Line":1}},{"line":11,"address":[13850526],"length":1,"stats":{"Line":1}},{"line":12,"address":[13850557],"length":1,"stats":{"Line":1}},{"line":14,"address":[13850605],"length":1,"stats":{"Line":1}},{"line":15,"address":[13850669],"length":1,"stats":{"Line":1}},{"line":16,"address":[13850737],"length":1,"stats":{"Line":1}},{"line":17,"address":[13850805],"length":1,"stats":{"Line":1}},{"line":21,"address":[13850889,13850937],"length":1,"stats":{"Line":2}},{"line":23,"address":[13851103],"length":1,"stats":{"Line":1}},{"line":24,"address":[13851138],"length":1,"stats":{"Line":1}},{"line":27,"address":[13851217],"length":1,"stats":{"Line":1}},{"line":28,"address":[13851241],"length":1,"stats":{"Line":1}},{"line":29,"address":[13851317],"length":1,"stats":{"Line":1}},{"line":31,"address":[13851368],"length":1,"stats":{"Line":1}},{"line":32,"address":[13851523],"length":1,"stats":{"Line":1}},{"line":33,"address":[13851574],"length":1,"stats":{"Line":1}},{"line":35,"address":[13851641],"length":1,"stats":{"Line":1}},{"line":38,"address":[13851821],"length":1,"stats":{"Line":1}},{"line":39,"address":[13851828],"length":1,"stats":{"Line":1}},{"line":40,"address":[13851981],"length":1,"stats":{"Line":1}},{"line":41,"address":[13851988],"length":1,"stats":{"Line":1}},{"line":42,"address":[13852117],"length":1,"stats":{"Line":1}},{"line":45,"address":[13852340],"length":1,"stats":{"Line":1}},{"line":50,"address":[13852147],"length":1,"stats":{"Line":1}},{"line":52,"address":[13852261,13852182],"length":1,"stats":{"Line":2}},{"line":56,"address":[13852614],"length":1,"stats":{"Line":1}},{"line":57,"address":[13852621],"length":1,"stats":{"Line":1}},{"line":58,"address":[13852698],"length":1,"stats":{"Line":1}},{"line":61,"address":[13852749],"length":1,"stats":{"Line":1}},{"line":62,"address":[13852784],"length":1,"stats":{"Line":1}},{"line":65,"address":[13852890],"length":1,"stats":{"Line":1}},{"line":66,"address":[13852897],"length":1,"stats":{"Line":1}},{"line":67,"address":[13853012,13853081],"length":1,"stats":{"Line":2}},{"line":68,"address":[13853190],"length":1,"stats":{"Line":1}},{"line":69,"address":[13853312],"length":1,"stats":{"Line":1}},{"line":72,"address":[13853615],"length":1,"stats":{"Line":1}},{"line":77,"address":[13853422],"length":1,"stats":{"Line":1}},{"line":79,"address":[13853457,13853536],"length":1,"stats":{"Line":2}},{"line":83,"address":[13853889],"length":1,"stats":{"Line":1}},{"line":84,"address":[13853896],"length":1,"stats":{"Line":1}},{"line":85,"address":[13853973],"length":1,"stats":{"Line":1}},{"line":88,"address":[13854024],"length":1,"stats":{"Line":1}},{"line":89,"address":[13854059],"length":1,"stats":{"Line":1}},{"line":91,"address":[13854141],"length":1,"stats":{"Line":1}},{"line":92,"address":[13854176],"length":1,"stats":{"Line":1}},{"line":94,"address":[13854258],"length":1,"stats":{"Line":1}},{"line":95,"address":[13854293],"length":1,"stats":{"Line":1}},{"line":98,"address":[13854399],"length":1,"stats":{"Line":1}},{"line":99,"address":[13854406],"length":1,"stats":{"Line":1}},{"line":100,"address":[13854521,13854590],"length":1,"stats":{"Line":2}},{"line":101,"address":[13854699],"length":1,"stats":{"Line":1}},{"line":102,"address":[13854821],"length":1,"stats":{"Line":1}},{"line":103,"address":[13854927],"length":1,"stats":{"Line":1}},{"line":106,"address":[13855174],"length":1,"stats":{"Line":1}},{"line":111,"address":[13854981],"length":1,"stats":{"Line":1}},{"line":113,"address":[13855095,13855016],"length":1,"stats":{"Line":2}},{"line":117,"address":[13855448],"length":1,"stats":{"Line":1}},{"line":118,"address":[13855455],"length":1,"stats":{"Line":1}},{"line":119,"address":[13855532],"length":1,"stats":{"Line":1}},{"line":122,"address":[13855583],"length":1,"stats":{"Line":1}},{"line":123,"address":[13855618],"length":1,"stats":{"Line":1}},{"line":126,"address":[13855724],"length":1,"stats":{"Line":1}},{"line":127,"address":[13855731],"length":1,"stats":{"Line":1}},{"line":128,"address":[13855903,13855840],"length":1,"stats":{"Line":2}},{"line":129,"address":[13856012],"length":1,"stats":{"Line":1}},{"line":130,"address":[13856128],"length":1,"stats":{"Line":1}},{"line":131,"address":[13856234],"length":1,"stats":{"Line":1}},{"line":135,"address":[13856312],"length":1,"stats":{"Line":1}},{"line":138,"address":[13856319],"length":1,"stats":{"Line":1}},{"line":139,"address":[13856343,13856422,13856515],"length":1,"stats":{"Line":3}},{"line":140,"address":[13856626,13857847],"length":1,"stats":{"Line":2}},{"line":142,"address":[13856693],"length":1,"stats":{"Line":1}},{"line":145,"address":[13856805],"length":1,"stats":{"Line":1}},{"line":146,"address":[13856832,13857011,13856915],"length":1,"stats":{"Line":3}},{"line":147,"address":[13857713,13857118,13857684],"length":1,"stats":{"Line":2}},{"line":148,"address":[13857690,13857746],"length":1,"stats":{"Line":2}},{"line":153,"address":[13850374,13846000,13850368],"length":1,"stats":{"Line":1}},{"line":154,"address":[13846019],"length":1,"stats":{"Line":1}},{"line":155,"address":[13846043],"length":1,"stats":{"Line":1}},{"line":157,"address":[13846108],"length":1,"stats":{"Line":1}},{"line":158,"address":[13846136],"length":1,"stats":{"Line":1}},{"line":160,"address":[13846184],"length":1,"stats":{"Line":1}},{"line":161,"address":[13846245],"length":1,"stats":{"Line":1}},{"line":162,"address":[13846310],"length":1,"stats":{"Line":1}},{"line":163,"address":[13846375],"length":1,"stats":{"Line":1}},{"line":167,"address":[13846504,13846456],"length":1,"stats":{"Line":2}},{"line":169,"address":[13846667],"length":1,"stats":{"Line":1}},{"line":170,"address":[13846699],"length":1,"stats":{"Line":1}},{"line":173,"address":[13846772],"length":1,"stats":{"Line":1}},{"line":174,"address":[13846796],"length":1,"stats":{"Line":1}},{"line":175,"address":[13846872],"length":1,"stats":{"Line":1}},{"line":177,"address":[13846920],"length":1,"stats":{"Line":1}},{"line":178,"address":[13847063],"length":1,"stats":{"Line":1}},{"line":179,"address":[13847114],"length":1,"stats":{"Line":1}},{"line":181,"address":[13847178],"length":1,"stats":{"Line":1}},{"line":184,"address":[13847346],"length":1,"stats":{"Line":1}},{"line":185,"address":[13847353],"length":1,"stats":{"Line":1}},{"line":186,"address":[13847503],"length":1,"stats":{"Line":1}},{"line":187,"address":[13847510],"length":1,"stats":{"Line":1}},{"line":188,"address":[13847636],"length":1,"stats":{"Line":1}},{"line":191,"address":[13847850],"length":1,"stats":{"Line":1}},{"line":193,"address":[13847666],"length":1,"stats":{"Line":1}},{"line":194,"address":[13847698,13847774],"length":1,"stats":{"Line":2}},{"line":197,"address":[13848124],"length":1,"stats":{"Line":1}},{"line":198,"address":[13848131],"length":1,"stats":{"Line":1}},{"line":199,"address":[13848208],"length":1,"stats":{"Line":1}},{"line":201,"address":[13848259],"length":1,"stats":{"Line":1}},{"line":203,"address":[13848313],"length":1,"stats":{"Line":1}},{"line":204,"address":[13848320,13848411],"length":1,"stats":{"Line":2}},{"line":205,"address":[13848458],"length":1,"stats":{"Line":1}},{"line":206,"address":[13848575],"length":1,"stats":{"Line":1}},{"line":209,"address":[13848813],"length":1,"stats":{"Line":1}},{"line":211,"address":[13848629],"length":1,"stats":{"Line":1}},{"line":212,"address":[13848737,13848661],"length":1,"stats":{"Line":2}},{"line":215,"address":[13849087],"length":1,"stats":{"Line":1}},{"line":216,"address":[13849094],"length":1,"stats":{"Line":1}},{"line":217,"address":[13849171],"length":1,"stats":{"Line":1}},{"line":219,"address":[13849222],"length":1,"stats":{"Line":1}},{"line":221,"address":[13849276],"length":1,"stats":{"Line":1}},{"line":222,"address":[13849374,13849283],"length":1,"stats":{"Line":2}},{"line":223,"address":[13849421],"length":1,"stats":{"Line":1}},{"line":224,"address":[13849538],"length":1,"stats":{"Line":1}},{"line":227,"address":[13849776],"length":1,"stats":{"Line":1}},{"line":229,"address":[13849592],"length":1,"stats":{"Line":1}},{"line":230,"address":[13849700,13849624],"length":1,"stats":{"Line":2}},{"line":233,"address":[13850050],"length":1,"stats":{"Line":1}}],"covered":128,"coverable":128},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","src","verification.rs"],"content":"use crate::bid::{BidStatus, BidStorage};\nuse crate::errors::QuickLendXError;\nuse crate::invoice::{Invoice, InvoiceMetadata};\nuse soroban_sdk::{contracttype, symbol_short, vec, Address, Env, String, Vec};\n\n#[contracttype]\npub enum BusinessVerificationStatus {\n    Pending,\n    Verified,\n    Rejected,\n}\n\n#[contracttype]\npub struct BusinessVerification {\n    pub business: Address,\n    pub status: BusinessVerificationStatus,\n    pub verified_at: Option\u003cu64\u003e,\n    pub verified_by: Option\u003cAddress\u003e,\n    pub kyc_data: String, // Encrypted KYC data\n    pub submitted_at: u64,\n    pub rejection_reason: Option\u003cString\u003e,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, PartialEq)]\npub enum InvestorTier {\n    Basic,\n    Silver,\n    Gold,\n    Platinum,\n    VIP,\n}\n\n#[contracttype]\n#[derive(Clone, Debug, PartialEq)]\npub enum InvestorRiskLevel {\n    Low,\n    Medium,\n    High,\n    VeryHigh,\n}\n\n#[contracttype]\npub struct InvestorVerification {\n    pub investor: Address,\n    pub status: BusinessVerificationStatus,\n    pub verified_at: Option\u003cu64\u003e,\n    pub verified_by: Option\u003cAddress\u003e,\n    pub kyc_data: String,\n    pub investment_limit: i128,\n    pub submitted_at: u64,\n    pub tier: InvestorTier,\n    pub risk_level: InvestorRiskLevel,\n    pub risk_score: u32,\n    pub total_invested: i128,\n    pub total_returns: i128,\n    pub successful_investments: u32,\n    pub defaulted_investments: u32,\n    pub last_activity: u64,\n    pub rejection_reason: Option\u003cString\u003e,\n    pub compliance_notes: Option\u003cString\u003e,\n}\n\nconst MIN_BID_AMOUNT: i128 = 100;\n\npub struct BusinessVerificationStorage;\n\nimpl BusinessVerificationStorage {\n    const VERIFIED_BUSINESSES_KEY: \u0026'static str = \"verified_businesses\";\n    const PENDING_BUSINESSES_KEY: \u0026'static str = \"pending_businesses\";\n    const REJECTED_BUSINESSES_KEY: \u0026'static str = \"rejected_businesses\";\n    const ADMIN_KEY: \u0026'static str = \"admin_address\";\n\n    pub fn store_verification(env: \u0026Env, verification: \u0026BusinessVerification) {\n        env.storage()\n            .instance()\n            .set(\u0026verification.business, verification);\n\n        // Add to status-specific lists\n        match verification.status {\n            BusinessVerificationStatus::Verified =\u003e {\n                Self::add_to_verified_businesses(env, \u0026verification.business);\n            }\n            BusinessVerificationStatus::Pending =\u003e {\n                Self::add_to_pending_businesses(env, \u0026verification.business);\n            }\n            BusinessVerificationStatus::Rejected =\u003e {\n                Self::add_to_rejected_businesses(env, \u0026verification.business);\n            }\n        }\n    }\n\n    pub fn get_verification(env: \u0026Env, business: \u0026Address) -\u003e Option\u003cBusinessVerification\u003e {\n        env.storage().instance().get(business)\n    }\n\n    pub fn update_verification(env: \u0026Env, verification: \u0026BusinessVerification) {\n        let old_verification = Self::get_verification(env, \u0026verification.business);\n\n        // Remove from old status list\n        if let Some(old_ver) = old_verification {\n            match old_ver.status {\n                BusinessVerificationStatus::Verified =\u003e {\n                    Self::remove_from_verified_businesses(env, \u0026verification.business);\n                }\n                BusinessVerificationStatus::Pending =\u003e {\n                    Self::remove_from_pending_businesses(env, \u0026verification.business);\n                }\n                BusinessVerificationStatus::Rejected =\u003e {\n                    Self::remove_from_rejected_businesses(env, \u0026verification.business);\n                }\n            }\n        }\n\n        // Store new verification\n        Self::store_verification(env, verification);\n    }\n\n    pub fn is_business_verified(env: \u0026Env, business: \u0026Address) -\u003e bool {\n        if let Some(verification) = Self::get_verification(env, business) {\n            matches!(verification.status, BusinessVerificationStatus::Verified)\n        } else {\n            false\n        }\n    }\n\n    pub fn get_verified_businesses(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::VERIFIED_BUSINESSES_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_pending_businesses(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::PENDING_BUSINESSES_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_rejected_businesses(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::REJECTED_BUSINESSES_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    fn add_to_verified_businesses(env: \u0026Env, business: \u0026Address) {\n        let mut verified = Self::get_verified_businesses(env);\n        verified.push_back(business.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_BUSINESSES_KEY, \u0026verified);\n    }\n\n    fn add_to_pending_businesses(env: \u0026Env, business: \u0026Address) {\n        let mut pending = Self::get_pending_businesses(env);\n        pending.push_back(business.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_BUSINESSES_KEY, \u0026pending);\n    }\n\n    fn add_to_rejected_businesses(env: \u0026Env, business: \u0026Address) {\n        let mut rejected = Self::get_rejected_businesses(env);\n        rejected.push_back(business.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_BUSINESSES_KEY, \u0026rejected);\n    }\n\n    fn remove_from_verified_businesses(env: \u0026Env, business: \u0026Address) {\n        let verified = Self::get_verified_businesses(env);\n        let mut new_verified = vec![env];\n        for addr in verified.iter() {\n            if addr != *business {\n                new_verified.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_BUSINESSES_KEY, \u0026new_verified);\n    }\n\n    fn remove_from_pending_businesses(env: \u0026Env, business: \u0026Address) {\n        let pending = Self::get_pending_businesses(env);\n        let mut new_pending = vec![env];\n        for addr in pending.iter() {\n            if addr != *business {\n                new_pending.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_BUSINESSES_KEY, \u0026new_pending);\n    }\n\n    fn remove_from_rejected_businesses(env: \u0026Env, business: \u0026Address) {\n        let rejected = Self::get_rejected_businesses(env);\n        let mut new_rejected = vec![env];\n        for addr in rejected.iter() {\n            if addr != *business {\n                new_rejected.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_BUSINESSES_KEY, \u0026new_rejected);\n    }\n\n    pub fn set_admin(env: \u0026Env, admin: \u0026Address) {\n        env.storage().instance().set(\u0026Self::ADMIN_KEY, admin);\n    }\n\n    pub fn get_admin(env: \u0026Env) -\u003e Option\u003cAddress\u003e {\n        env.storage().instance().get(\u0026Self::ADMIN_KEY)\n    }\n\n    pub fn is_admin(env: \u0026Env, address: \u0026Address) -\u003e bool {\n        if let Some(admin) = Self::get_admin(env) {\n            admin == *address\n        } else {\n            false\n        }\n    }\n}\n\npub struct InvestorVerificationStorage;\n\nimpl InvestorVerificationStorage {\n    const VERIFIED_INVESTORS_KEY: \u0026'static str = \"verified_investors\";\n    const PENDING_INVESTORS_KEY: \u0026'static str = \"pending_investors\";\n    const REJECTED_INVESTORS_KEY: \u0026'static str = \"rejected_investors\";\n    const INVESTOR_HISTORY_KEY: \u0026'static str = \"investor_history\";\n    const INVESTOR_ANALYTICS_KEY: \u0026'static str = \"investor_analytics\";\n\n    pub fn submit(env: \u0026Env, investor: \u0026Address, kyc_data: String) -\u003e Result\u003c(), QuickLendXError\u003e {\n        let mut verification = Self::get(env, investor);\n        match verification {\n            Some(ref existing) =\u003e match existing.status {\n                BusinessVerificationStatus::Pending =\u003e {\n                    return Err(QuickLendXError::KYCAlreadyPending)\n                }\n                BusinessVerificationStatus::Verified =\u003e {\n                    return Err(QuickLendXError::KYCAlreadyVerified)\n                }\n                BusinessVerificationStatus::Rejected =\u003e {\n                    verification = Some(InvestorVerification {\n                        investor: investor.clone(),\n                        status: BusinessVerificationStatus::Pending,\n                        verified_at: None,\n                        verified_by: None,\n                        kyc_data,\n                        investment_limit: existing.investment_limit,\n                        submitted_at: env.ledger().timestamp(),\n                        tier: existing.tier.clone(),\n                        risk_level: existing.risk_level.clone(),\n                        risk_score: existing.risk_score,\n                        total_invested: existing.total_invested,\n                        total_returns: existing.total_returns,\n                        successful_investments: existing.successful_investments,\n                        defaulted_investments: existing.defaulted_investments,\n                        last_activity: existing.last_activity,\n                        rejection_reason: None,\n                        compliance_notes: None,\n                    });\n                }\n            },\n            None =\u003e {\n                verification = Some(InvestorVerification {\n                    investor: investor.clone(),\n                    status: BusinessVerificationStatus::Pending,\n                    verified_at: None,\n                    verified_by: None,\n                    kyc_data,\n                    investment_limit: 0,\n                    submitted_at: env.ledger().timestamp(),\n                    tier: InvestorTier::Basic,\n                    risk_level: InvestorRiskLevel::High, // Default to high risk for new investors\n                    risk_score: 100,                     // Default high risk score\n                    total_invested: 0,\n                    total_returns: 0,\n                    successful_investments: 0,\n                    defaulted_investments: 0,\n                    last_activity: env.ledger().timestamp(),\n                    rejection_reason: None,\n                    compliance_notes: None,\n                });\n            }\n        }\n\n        if let Some(v) = verification {\n            Self::store(env, \u0026v);\n            Self::add_to_pending_investors(env, investor);\n        }\n        Ok(())\n    }\n\n    pub fn store(env: \u0026Env, verification: \u0026InvestorVerification) {\n        env.storage()\n            .instance()\n            .set(\u0026verification.investor, verification);\n    }\n\n    pub fn get(env: \u0026Env, investor: \u0026Address) -\u003e Option\u003cInvestorVerification\u003e {\n        env.storage().instance().get(investor)\n    }\n\n    pub fn update(env: \u0026Env, verification: \u0026InvestorVerification) {\n        let old_verification = Self::get(env, \u0026verification.investor);\n\n        // Remove from old status list\n        if let Some(old_ver) = old_verification {\n            match old_ver.status {\n                BusinessVerificationStatus::Verified =\u003e {\n                    Self::remove_from_verified_investors(env, \u0026verification.investor);\n                }\n                BusinessVerificationStatus::Pending =\u003e {\n                    Self::remove_from_pending_investors(env, \u0026verification.investor);\n                }\n                BusinessVerificationStatus::Rejected =\u003e {\n                    Self::remove_from_rejected_investors(env, \u0026verification.investor);\n                }\n            }\n        }\n\n        // Store new verification\n        Self::store(env, verification);\n\n        // Add to new status list\n        match verification.status {\n            BusinessVerificationStatus::Verified =\u003e {\n                Self::add_to_verified_investors(env, \u0026verification.investor);\n            }\n            BusinessVerificationStatus::Pending =\u003e {\n                Self::add_to_pending_investors(env, \u0026verification.investor);\n            }\n            BusinessVerificationStatus::Rejected =\u003e {\n                Self::add_to_rejected_investors(env, \u0026verification.investor);\n            }\n        }\n    }\n\n    pub fn is_investor_verified(env: \u0026Env, investor: \u0026Address) -\u003e bool {\n        if let Some(verification) = Self::get(env, investor) {\n            matches!(verification.status, BusinessVerificationStatus::Verified)\n        } else {\n            false\n        }\n    }\n\n    pub fn get_verified_investors(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::VERIFIED_INVESTORS_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_pending_investors(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::PENDING_INVESTORS_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_rejected_investors(env: \u0026Env) -\u003e Vec\u003cAddress\u003e {\n        env.storage()\n            .instance()\n            .get(\u0026Self::REJECTED_INVESTORS_KEY)\n            .unwrap_or(vec![env])\n    }\n\n    pub fn get_investors_by_tier(env: \u0026Env, tier: InvestorTier) -\u003e Vec\u003cAddress\u003e {\n        let verified_investors = Self::get_verified_investors(env);\n        let mut tier_investors = Vec::new(env);\n\n        for investor in verified_investors.iter() {\n            if let Some(verification) = Self::get(env, \u0026investor) {\n                if verification.tier == tier {\n                    tier_investors.push_back(investor);\n                }\n            }\n        }\n\n        tier_investors\n    }\n\n    pub fn get_investors_by_risk_level(env: \u0026Env, risk_level: InvestorRiskLevel) -\u003e Vec\u003cAddress\u003e {\n        let verified_investors = Self::get_verified_investors(env);\n        let mut risk_investors = Vec::new(env);\n\n        for investor in verified_investors.iter() {\n            if let Some(verification) = Self::get(env, \u0026investor) {\n                if verification.risk_level == risk_level {\n                    risk_investors.push_back(investor);\n                }\n            }\n        }\n\n        risk_investors\n    }\n\n    fn add_to_verified_investors(env: \u0026Env, investor: \u0026Address) {\n        let mut verified = Self::get_verified_investors(env);\n        verified.push_back(investor.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_INVESTORS_KEY, \u0026verified);\n    }\n\n    fn add_to_pending_investors(env: \u0026Env, investor: \u0026Address) {\n        let mut pending = Self::get_pending_investors(env);\n        pending.push_back(investor.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_INVESTORS_KEY, \u0026pending);\n    }\n\n    fn add_to_rejected_investors(env: \u0026Env, investor: \u0026Address) {\n        let mut rejected = Self::get_rejected_investors(env);\n        rejected.push_back(investor.clone());\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_INVESTORS_KEY, \u0026rejected);\n    }\n\n    fn remove_from_verified_investors(env: \u0026Env, investor: \u0026Address) {\n        let verified = Self::get_verified_investors(env);\n        let mut new_verified = vec![env];\n        for addr in verified.iter() {\n            if addr != *investor {\n                new_verified.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::VERIFIED_INVESTORS_KEY, \u0026new_verified);\n    }\n\n    fn remove_from_pending_investors(env: \u0026Env, investor: \u0026Address) {\n        let pending = Self::get_pending_investors(env);\n        let mut new_pending = vec![env];\n        for addr in pending.iter() {\n            if addr != *investor {\n                new_pending.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::PENDING_INVESTORS_KEY, \u0026new_pending);\n    }\n\n    fn remove_from_rejected_investors(env: \u0026Env, investor: \u0026Address) {\n        let rejected = Self::get_rejected_investors(env);\n        let mut new_rejected = vec![env];\n        for addr in rejected.iter() {\n            if addr != *investor {\n                new_rejected.push_back(addr);\n            }\n        }\n        env.storage()\n            .instance()\n            .set(\u0026Self::REJECTED_INVESTORS_KEY, \u0026new_rejected);\n    }\n}\n\npub fn validate_bid(\n    env: \u0026Env,\n    invoice: \u0026Invoice,\n    bid_amount: i128,\n    expected_return: i128,\n    investor: \u0026Address,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if bid_amount \u003c= 0 || bid_amount \u003c MIN_BID_AMOUNT {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    if bid_amount \u003e invoice.amount {\n        return Err(QuickLendXError::InvoiceAmountInvalid);\n    }\n\n    if expected_return \u003c= bid_amount {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    // Validate investor can make this investment\n    validate_investor_investment(env, investor, bid_amount)?;\n\n    BidStorage::cleanup_expired_bids(env, \u0026invoice.id);\n    let existing_bids = BidStorage::get_bids_for_invoice(env, \u0026invoice.id);\n    for bid_id in existing_bids.iter() {\n        if let Some(existing_bid) = BidStorage::get_bid(env, \u0026bid_id) {\n            if existing_bid.investor == *investor \u0026\u0026 existing_bid.status == BidStatus::Placed {\n                return Err(QuickLendXError::OperationNotAllowed);\n            }\n        }\n    }\n\n    Ok(())\n}\n\npub fn submit_kyc_application(\n    env: \u0026Env,\n    business: \u0026Address,\n    kyc_data: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Only the business can submit their own KYC\n    business.require_auth();\n\n    // Check if business already has a verification record\n    if let Some(existing_verification) =\n        BusinessVerificationStorage::get_verification(env, business)\n    {\n        match existing_verification.status {\n            BusinessVerificationStatus::Pending =\u003e {\n                return Err(QuickLendXError::KYCAlreadyPending);\n            }\n            BusinessVerificationStatus::Verified =\u003e {\n                return Err(QuickLendXError::KYCAlreadyVerified);\n            }\n            BusinessVerificationStatus::Rejected =\u003e {\n                // Allow resubmission if previously rejected\n            }\n        }\n    }\n\n    let verification = BusinessVerification {\n        business: business.clone(),\n        status: BusinessVerificationStatus::Pending,\n        verified_at: None,\n        verified_by: None,\n        kyc_data,\n        submitted_at: env.ledger().timestamp(),\n        rejection_reason: None,\n    };\n\n    BusinessVerificationStorage::store_verification(env, \u0026verification);\n    emit_kyc_submitted(env, business);\n    Ok(())\n}\n\npub fn verify_business(\n    env: \u0026Env,\n    admin: \u0026Address,\n    business: \u0026Address,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Only admin can verify businesses\n    admin.require_auth();\n    if !BusinessVerificationStorage::is_admin(env, admin) {\n        return Err(QuickLendXError::NotAdmin);\n    }\n\n    let mut verification = BusinessVerificationStorage::get_verification(env, business)\n        .ok_or(QuickLendXError::KYCNotFound)?;\n\n    if !matches!(verification.status, BusinessVerificationStatus::Pending) {\n        return Err(QuickLendXError::InvalidKYCStatus);\n    }\n\n    verification.status = BusinessVerificationStatus::Verified;\n    verification.verified_at = Some(env.ledger().timestamp());\n    verification.verified_by = Some(admin.clone());\n\n    BusinessVerificationStorage::update_verification(env, \u0026verification);\n    emit_business_verified(env, business, admin);\n    Ok(())\n}\n\npub fn reject_business(\n    env: \u0026Env,\n    admin: \u0026Address,\n    business: \u0026Address,\n    reason: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Only admin can reject businesses\n    admin.require_auth();\n    if !BusinessVerificationStorage::is_admin(env, admin) {\n        return Err(QuickLendXError::NotAdmin);\n    }\n\n    let mut verification = BusinessVerificationStorage::get_verification(env, business)\n        .ok_or(QuickLendXError::KYCNotFound)?;\n\n    if !matches!(verification.status, BusinessVerificationStatus::Pending) {\n        return Err(QuickLendXError::InvalidKYCStatus);\n    }\n\n    verification.status = BusinessVerificationStatus::Rejected;\n    verification.rejection_reason = Some(reason);\n\n    BusinessVerificationStorage::update_verification(env, \u0026verification);\n    emit_business_rejected(env, business, admin);\n    Ok(())\n}\n\npub fn get_business_verification_status(\n    env: \u0026Env,\n    business: \u0026Address,\n) -\u003e Option\u003cBusinessVerification\u003e {\n    BusinessVerificationStorage::get_verification(env, business)\n}\n\npub fn require_business_verification(env: \u0026Env, business: \u0026Address) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if !BusinessVerificationStorage::is_business_verified(env, business) {\n        return Err(QuickLendXError::BusinessNotVerified);\n    }\n    Ok(())\n}\n\n// Keep the existing invoice verification function\npub fn verify_invoice_data(\n    env: \u0026Env,\n    _business: \u0026Address,\n    amount: i128,\n    _currency: \u0026Address,\n    due_date: u64,\n    description: \u0026String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // First check if business is verified (temporarily disabled for debugging)\n    // require_business_verification(env, business)?;\n\n    if amount \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n    let current_timestamp = env.ledger().timestamp();\n    if due_date \u003c= current_timestamp {\n        return Err(QuickLendXError::InvoiceDueDateInvalid);\n    }\n    if description.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n    Ok(())\n}\n\n// Event emission functions (from main)\nfn emit_kyc_submitted(env: \u0026Env, business: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"kyc_sub\"),),\n        (business.clone(), env.ledger().timestamp()),\n    );\n}\n\nfn emit_business_verified(env: \u0026Env, business: \u0026Address, admin: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"bus_ver\"),),\n        (business.clone(), admin.clone(), env.ledger().timestamp()),\n    );\n}\n\nfn emit_business_rejected(env: \u0026Env, business: \u0026Address, admin: \u0026Address) {\n    env.events().publish(\n        (symbol_short!(\"bus_rej\"),),\n        (business.clone(), admin.clone()),\n    );\n}\n\n/// Validate invoice category\npub fn validate_invoice_category(\n    category: \u0026crate::invoice::InvoiceCategory,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // All categories are valid as they are defined in the enum\n    // This function can be extended to add additional validation logic if needed\n    match category {\n        crate::invoice::InvoiceCategory::Services =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Products =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Consulting =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Manufacturing =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Technology =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Healthcare =\u003e Ok(()),\n        crate::invoice::InvoiceCategory::Other =\u003e Ok(()),\n    }\n}\n\n/// Validate invoice tags\npub fn validate_invoice_tags(tags: \u0026Vec\u003cString\u003e) -\u003e Result\u003c(), QuickLendXError\u003e {\n    // Check tag count limit (max 10 tags per invoice)\n    if tags.len() \u003e 10 {\n        return Err(QuickLendXError::TagLimitExceeded);\n    }\n\n    // Validate each tag\n    for tag in tags.iter() {\n        // Check tag length (1-50 characters)\n        if tag.len() \u003c 1 || tag.len() \u003e 50 {\n            return Err(QuickLendXError::InvalidTag);\n        }\n\n        // Check for empty tags (length 0 is already checked above)\n        // Note: Soroban String doesn't have trim() method\n    }\n\n    Ok(())\n}\n\npub fn submit_investor_kyc(\n    env: \u0026Env,\n    investor: \u0026Address,\n    kyc_data: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    investor.require_auth();\n    InvestorVerificationStorage::submit(env, investor, kyc_data)\n}\n\npub fn verify_investor(\n    env: \u0026Env,\n    admin: \u0026Address,\n    investor: \u0026Address,\n    investment_limit: i128,\n) -\u003e Result\u003cInvestorVerification, QuickLendXError\u003e {\n    admin.require_auth();\n\n    if investment_limit \u003c= 0 {\n        return Err(QuickLendXError::InvalidAmount);\n    }\n\n    let mut verification =\n        InvestorVerificationStorage::get(env, investor).ok_or(QuickLendXError::KYCNotFound)?;\n\n    match verification.status {\n        BusinessVerificationStatus::Verified =\u003e return Err(QuickLendXError::KYCAlreadyVerified),\n        BusinessVerificationStatus::Pending | BusinessVerificationStatus::Rejected =\u003e {\n            // Calculate risk score and determine tier\n            let risk_score = calculate_investor_risk_score(env, investor, \u0026verification.kyc_data)?;\n            let tier = determine_investor_tier(env, investor, risk_score)?;\n            let risk_level = determine_risk_level(risk_score);\n\n            // Calculate final investment limit based on tier and risk\n            let calculated_limit = calculate_investment_limit(\u0026tier, \u0026risk_level, investment_limit);\n\n            verification.status = BusinessVerificationStatus::Verified;\n            verification.verified_at = Some(env.ledger().timestamp());\n            verification.verified_by = Some(admin.clone());\n            verification.investment_limit = calculated_limit;\n            verification.tier = tier;\n            verification.risk_level = risk_level;\n            verification.risk_score = risk_score;\n            verification.compliance_notes = Some(String::from_str(env, \"Verified by admin\"));\n\n            InvestorVerificationStorage::update(env, \u0026verification);\n            Ok(verification)\n        }\n    }\n}\n\npub fn reject_investor(\n    env: \u0026Env,\n    admin: \u0026Address,\n    investor: \u0026Address,\n    reason: String,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    admin.require_auth();\n    let mut verification =\n        InvestorVerificationStorage::get(env, investor).ok_or(QuickLendXError::KYCNotFound)?;\n\n    verification.status = BusinessVerificationStatus::Rejected;\n    verification.verified_at = Some(env.ledger().timestamp());\n    verification.verified_by = Some(admin.clone());\n    verification.rejection_reason = Some(reason);\n    verification.compliance_notes = Some(String::from_str(env, \"Rejected by admin\"));\n\n    InvestorVerificationStorage::update(env, \u0026verification);\n    Ok(())\n}\n\npub fn get_investor_verification(env: \u0026Env, investor: \u0026Address) -\u003e Option\u003cInvestorVerification\u003e {\n    InvestorVerificationStorage::get(env, investor)\n}\n\n/// Calculate investor risk score based on various factors\npub fn calculate_investor_risk_score(\n    env: \u0026Env,\n    investor: \u0026Address,\n    kyc_data: \u0026String,\n) -\u003e Result\u003cu32, QuickLendXError\u003e {\n    let mut risk_score = 0u32;\n\n    // Base risk score from KYC data analysis (simplified)\n    // In a real implementation, this would analyze the KYC data\n    let kyc_length = kyc_data.len();\n    if kyc_length \u003c 100 {\n        risk_score += 30; // High risk for incomplete KYC\n    } else if kyc_length \u003c 500 {\n        risk_score += 20; // Medium risk\n    } else {\n        risk_score += 10; // Lower risk for comprehensive KYC\n    }\n\n    // Check investment history if available\n    if let Some(verification) = InvestorVerificationStorage::get(env, investor) {\n        let total_investments =\n            verification.successful_investments + verification.defaulted_investments;\n\n        if total_investments \u003e 0 {\n            let default_rate = (verification.defaulted_investments * 100) / total_investments;\n            risk_score += default_rate;\n        }\n\n        // Adjust based on total invested amount\n        if verification.total_invested \u003e 1000000 {\n            // 1M+ invested\n            risk_score = risk_score.saturating_sub(20);\n        } else if verification.total_invested \u003e 100000 {\n            // 100K+ invested\n            risk_score = risk_score.saturating_sub(10);\n        }\n    }\n\n    // Cap risk score at 100\n    if risk_score \u003e 100 {\n        risk_score = 100;\n    }\n\n    Ok(risk_score)\n}\n\n/// Determine investor tier based on risk score and investment history\npub fn determine_investor_tier(\n    env: \u0026Env,\n    investor: \u0026Address,\n    risk_score: u32,\n) -\u003e Result\u003cInvestorTier, QuickLendXError\u003e {\n    if let Some(verification) = InvestorVerificationStorage::get(env, investor) {\n        let total_invested = verification.total_invested;\n        let successful_investments = verification.successful_investments;\n\n        // VIP tier: Very low risk, high investment volume, many successful investments\n        if risk_score \u003c= 10 \u0026\u0026 total_invested \u003e 5000000 \u0026\u0026 successful_investments \u003e 50 {\n            return Ok(InvestorTier::VIP);\n        }\n\n        // Platinum tier: Low risk, high investment volume\n        if risk_score \u003c= 20 \u0026\u0026 total_invested \u003e 1000000 \u0026\u0026 successful_investments \u003e 20 {\n            return Ok(InvestorTier::Platinum);\n        }\n\n        // Gold tier: Medium-low risk, moderate investment volume\n        if risk_score \u003c= 40 \u0026\u0026 total_invested \u003e 100000 \u0026\u0026 successful_investments \u003e 10 {\n            return Ok(InvestorTier::Gold);\n        }\n\n        // Silver tier: Medium risk, some investment history\n        if risk_score \u003c= 60 \u0026\u0026 total_invested \u003e 10000 \u0026\u0026 successful_investments \u003e 3 {\n            return Ok(InvestorTier::Silver);\n        }\n    }\n\n    // Default to Basic tier\n    Ok(InvestorTier::Basic)\n}\n\n/// Determine risk level based on risk score\npub fn determine_risk_level(risk_score: u32) -\u003e InvestorRiskLevel {\n    match risk_score {\n        0..=25 =\u003e InvestorRiskLevel::Low,\n        26..=50 =\u003e InvestorRiskLevel::Medium,\n        51..=75 =\u003e InvestorRiskLevel::High,\n        _ =\u003e InvestorRiskLevel::VeryHigh,\n    }\n}\n\n/// Calculate investment limit based on tier and risk level\npub fn calculate_investment_limit(\n    tier: \u0026InvestorTier,\n    risk_level: \u0026InvestorRiskLevel,\n    base_limit: i128,\n) -\u003e i128 {\n    let tier_multiplier = match tier {\n        InvestorTier::VIP =\u003e 10,\n        InvestorTier::Platinum =\u003e 5,\n        InvestorTier::Gold =\u003e 3,\n        InvestorTier::Silver =\u003e 2,\n        InvestorTier::Basic =\u003e 1,\n    };\n\n    let risk_multiplier = match risk_level {\n        InvestorRiskLevel::Low =\u003e 100,     // 100% of calculated limit\n        InvestorRiskLevel::Medium =\u003e 75,   // 75% of calculated limit\n        InvestorRiskLevel::High =\u003e 50,     // 50% of calculated limit\n        InvestorRiskLevel::VeryHigh =\u003e 25, // 25% of calculated limit\n    };\n\n    let calculated_limit = base_limit.saturating_mul(tier_multiplier);\n    calculated_limit\n        .saturating_mul(risk_multiplier)\n        .saturating_div(100)\n}\n\n/// Update investor analytics after an investment\npub fn update_investor_analytics(\n    env: \u0026Env,\n    investor: \u0026Address,\n    investment_amount: i128,\n    is_successful: bool,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if let Some(mut verification) = InvestorVerificationStorage::get(env, investor) {\n        verification.total_invested = verification\n            .total_invested\n            .saturating_add(investment_amount);\n        verification.last_activity = env.ledger().timestamp();\n\n        if is_successful {\n            verification.successful_investments =\n                verification.successful_investments.saturating_add(1);\n            // Calculate returns (simplified - would need actual return data)\n            let estimated_return = investment_amount.saturating_mul(110).saturating_div(100); // 10% return\n            verification.total_returns =\n                verification.total_returns.saturating_add(estimated_return);\n        } else {\n            verification.defaulted_investments =\n                verification.defaulted_investments.saturating_add(1);\n        }\n\n        // Recalculate risk score and tier\n        verification.risk_score =\n            calculate_investor_risk_score(env, investor, \u0026verification.kyc_data)?;\n        verification.risk_level = determine_risk_level(verification.risk_score);\n        verification.tier = determine_investor_tier(env, investor, verification.risk_score)?;\n\n        // Update investment limit based on new tier and risk\n        let base_limit = 100000; // Base limit of 100K\n        verification.investment_limit =\n            calculate_investment_limit(\u0026verification.tier, \u0026verification.risk_level, base_limit);\n\n        InvestorVerificationStorage::update(env, \u0026verification);\n    }\n\n    Ok(())\n}\n\n/// Get investor analytics summary\npub fn get_investor_analytics(\n    env: \u0026Env,\n    investor: \u0026Address,\n) -\u003e Result\u003cInvestorVerification, QuickLendXError\u003e {\n    InvestorVerificationStorage::get(env, investor).ok_or(QuickLendXError::KYCNotFound)\n}\n\n/// Validate investor can make investment based on limits and risk\npub fn validate_investor_investment(\n    env: \u0026Env,\n    investor: \u0026Address,\n    investment_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if let Some(verification) = InvestorVerificationStorage::get(env, investor) {\n        // Check if investor is verified\n        if !matches!(verification.status, BusinessVerificationStatus::Verified) {\n            return Err(QuickLendXError::BusinessNotVerified);\n        }\n\n        // Check investment limit\n        if investment_amount \u003e verification.investment_limit {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        // Check risk level restrictions\n        match verification.risk_level {\n            InvestorRiskLevel::VeryHigh =\u003e {\n                // Very high risk investors have additional restrictions\n                if investment_amount \u003e 10000 {\n                    return Err(QuickLendXError::InvalidAmount);\n                }\n            }\n            InvestorRiskLevel::High =\u003e {\n                // High risk investors have moderate restrictions\n                if investment_amount \u003e 50000 {\n                    return Err(QuickLendXError::InvalidAmount);\n                }\n            }\n            _ =\u003e {\n                // Medium and low risk investors can invest up to their limit\n            }\n        }\n\n        Ok(())\n    } else {\n        Err(QuickLendXError::KYCNotFound)\n    }\n}\n\n/// Validate structured invoice metadata against the invoice amount\npub fn validate_invoice_metadata(\n    metadata: \u0026InvoiceMetadata,\n    invoice_amount: i128,\n) -\u003e Result\u003c(), QuickLendXError\u003e {\n    if metadata.customer_name.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    if metadata.customer_address.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    if metadata.tax_id.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    if metadata.line_items.len() == 0 {\n        return Err(QuickLendXError::InvalidDescription);\n    }\n\n    let mut computed_total = 0i128;\n    for record in metadata.line_items.iter() {\n        if record.0.len() == 0 {\n            return Err(QuickLendXError::InvalidDescription);\n        }\n\n        if record.1 \u003c= 0 || record.2 \u003c 0 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        let expected_total = record.1.saturating_mul(record.2);\n        if expected_total != record.3 {\n            return Err(QuickLendXError::InvalidAmount);\n        }\n\n        computed_total = computed_total.saturating_add(record.3);\n    }\n\n    if computed_total != invoice_amount {\n        return Err(QuickLendXError::InvoiceAmountInvalid);\n    }\n\n    Ok(())\n}\n","traces":[{"line":74,"address":[14557115,14556800,14557121],"length":1,"stats":{"Line":1}},{"line":75,"address":[14556846],"length":1,"stats":{"Line":2}},{"line":77,"address":[14556918,14556872],"length":1,"stats":{"Line":1}},{"line":80,"address":[14557010],"length":1,"stats":{"Line":2}},{"line":82,"address":[14557077],"length":1,"stats":{"Line":3}},{"line":85,"address":[14557056],"length":1,"stats":{"Line":1}},{"line":88,"address":[14557098],"length":1,"stats":{"Line":0}},{"line":93,"address":[14556772,14556560,14556778],"length":1,"stats":{"Line":2}},{"line":94,"address":[14556687,14556605],"length":1,"stats":{"Line":3}},{"line":97,"address":[14557423,14557136,14557429],"length":1,"stats":{"Line":2}},{"line":98,"address":[14557175],"length":1,"stats":{"Line":1}},{"line":101,"address":[14557189],"length":1,"stats":{"Line":2}},{"line":102,"address":[14557241,14557297],"length":1,"stats":{"Line":1}},{"line":104,"address":[14557330,14557419],"length":1,"stats":{"Line":0}},{"line":107,"address":[14557399,14557309],"length":1,"stats":{"Line":5}},{"line":110,"address":[14557351,14557421],"length":1,"stats":{"Line":0}},{"line":116,"address":[14557284],"length":1,"stats":{"Line":3}},{"line":119,"address":[14557456],"length":1,"stats":{"Line":0}},{"line":120,"address":[14557485],"length":1,"stats":{"Line":0}},{"line":121,"address":[14557543],"length":1,"stats":{"Line":0}},{"line":123,"address":[14557579],"length":1,"stats":{"Line":0}},{"line":127,"address":[14558690,14558336,14558684],"length":1,"stats":{"Line":3}},{"line":128,"address":[14558366,14558590],"length":1,"stats":{"Line":4}},{"line":130,"address":[14558524,14558457],"length":1,"stats":{"Line":6}},{"line":131,"address":[14558611,14558674,14558551,14558532],"length":1,"stats":{"Line":4}},{"line":134,"address":[14557954,14557948,14557600],"length":1,"stats":{"Line":1}},{"line":135,"address":[14557854,14557630],"length":1,"stats":{"Line":4}},{"line":137,"address":[14557788,14557721],"length":1,"stats":{"Line":3}},{"line":138,"address":[14557875,14557938,14557796,14557815],"length":1,"stats":{"Line":2}},{"line":141,"address":[14558316,14557968,14558322],"length":1,"stats":{"Line":0}},{"line":142,"address":[14558222,14557998],"length":1,"stats":{"Line":0}},{"line":144,"address":[14558156,14558089],"length":1,"stats":{"Line":0}},{"line":145,"address":[14558243,14558164,14558183,14558306],"length":1,"stats":{"Line":0}},{"line":148,"address":[14559737,14559408,14559743],"length":1,"stats":{"Line":3}},{"line":149,"address":[14559452],"length":1,"stats":{"Line":3}},{"line":150,"address":[14559467,14559515],"length":1,"stats":{"Line":3}},{"line":151,"address":[14559549],"length":1,"stats":{"Line":1}},{"line":153,"address":[14559580],"length":1,"stats":{"Line":0}},{"line":156,"address":[14558704,14559039,14559033],"length":1,"stats":{"Line":1}},{"line":157,"address":[14558748],"length":1,"stats":{"Line":2}},{"line":158,"address":[14558811,14558763],"length":1,"stats":{"Line":3}},{"line":159,"address":[14558845],"length":1,"stats":{"Line":1}},{"line":161,"address":[14558876],"length":1,"stats":{"Line":0}},{"line":164,"address":[14559385,14559391,14559056],"length":1,"stats":{"Line":0}},{"line":165,"address":[14559100],"length":1,"stats":{"Line":0}},{"line":166,"address":[14559115,14559163],"length":1,"stats":{"Line":0}},{"line":167,"address":[14559197],"length":1,"stats":{"Line":0}},{"line":169,"address":[14559228],"length":1,"stats":{"Line":0}},{"line":172,"address":[14561488,14562129,14562334],"length":1,"stats":{"Line":0}},{"line":173,"address":[14561527],"length":1,"stats":{"Line":0}},{"line":174,"address":[14561550],"length":1,"stats":{"Line":0}},{"line":175,"address":[14561768,14561678,14561620,14562288],"length":1,"stats":{"Line":0}},{"line":176,"address":[14561856,14562180],"length":1,"stats":{"Line":0}},{"line":177,"address":[14562198],"length":1,"stats":{"Line":0}},{"line":180,"address":[14561910],"length":1,"stats":{"Line":0}},{"line":182,"address":[14561944],"length":1,"stats":{"Line":0}},{"line":185,"address":[14559760,14560401,14560606],"length":1,"stats":{"Line":1}},{"line":186,"address":[14559799],"length":1,"stats":{"Line":2}},{"line":187,"address":[14559822],"length":1,"stats":{"Line":1}},{"line":188,"address":[14559892,14559950,14560560,14560040],"length":1,"stats":{"Line":8}},{"line":189,"address":[14560128,14560452],"length":1,"stats":{"Line":3}},{"line":190,"address":[14560470],"length":1,"stats":{"Line":0}},{"line":193,"address":[14560182],"length":1,"stats":{"Line":3}},{"line":195,"address":[14560216],"length":1,"stats":{"Line":0}},{"line":198,"address":[14561265,14560624,14561470],"length":1,"stats":{"Line":0}},{"line":199,"address":[14560663],"length":1,"stats":{"Line":0}},{"line":200,"address":[14560686],"length":1,"stats":{"Line":0}},{"line":201,"address":[14560814,14560756,14561424,14560904],"length":1,"stats":{"Line":0}},{"line":202,"address":[14560992,14561316],"length":1,"stats":{"Line":0}},{"line":203,"address":[14561334],"length":1,"stats":{"Line":0}},{"line":206,"address":[14561046],"length":1,"stats":{"Line":0}},{"line":208,"address":[14561080],"length":1,"stats":{"Line":0}},{"line":211,"address":[14562977,14562983,14562784],"length":1,"stats":{"Line":1}},{"line":212,"address":[14562822],"length":1,"stats":{"Line":1}},{"line":215,"address":[14562774,14562576,14562768],"length":1,"stats":{"Line":1}},{"line":216,"address":[14562608,14562674],"length":1,"stats":{"Line":2}},{"line":219,"address":[14562352,14562555,14562561],"length":1,"stats":{"Line":1}},{"line":220,"address":[14562480,14562386],"length":1,"stats":{"Line":2}},{"line":221,"address":[14562455,14562524],"length":1,"stats":{"Line":3}},{"line":223,"address":[14562475],"length":1,"stats":{"Line":0}},{"line":237,"address":[14572615,14571205,14570000],"length":1,"stats":{"Line":1}},{"line":238,"address":[14570134,14570054],"length":1,"stats":{"Line":2}},{"line":239,"address":[14570142],"length":1,"stats":{"Line":1}},{"line":240,"address":[14570178],"length":1,"stats":{"Line":0}},{"line":242,"address":[14571355],"length":1,"stats":{"Line":0}},{"line":245,"address":[14571365],"length":1,"stats":{"Line":0}},{"line":248,"address":[14571802],"length":1,"stats":{"Line":0}},{"line":249,"address":[14571388],"length":1,"stats":{"Line":0}},{"line":252,"address":[14571458],"length":1,"stats":{"Line":0}},{"line":253,"address":[14571466],"length":1,"stats":{"Line":0}},{"line":254,"address":[14571509],"length":1,"stats":{"Line":0}},{"line":255,"address":[14571543,14571594],"length":1,"stats":{"Line":0}},{"line":256,"address":[14571662],"length":1,"stats":{"Line":0}},{"line":257,"address":[14571681],"length":1,"stats":{"Line":0}},{"line":258,"address":[14571724],"length":1,"stats":{"Line":0}},{"line":259,"address":[14571732],"length":1,"stats":{"Line":0}},{"line":260,"address":[14571748],"length":1,"stats":{"Line":0}},{"line":261,"address":[14571764],"length":1,"stats":{"Line":0}},{"line":262,"address":[14571771],"length":1,"stats":{"Line":0}},{"line":263,"address":[14571778],"length":1,"stats":{"Line":0}},{"line":264,"address":[14571786],"length":1,"stats":{"Line":0}},{"line":265,"address":[14571794],"length":1,"stats":{"Line":0}},{"line":270,"address":[14570611],"length":1,"stats":{"Line":1}},{"line":271,"address":[14570245],"length":1,"stats":{"Line":1}},{"line":274,"address":[14570319],"length":1,"stats":{"Line":1}},{"line":275,"address":[14570327],"length":1,"stats":{"Line":1}},{"line":277,"address":[14570378,14570429],"length":1,"stats":{"Line":2}},{"line":285,"address":[14570510],"length":1,"stats":{"Line":1}},{"line":286,"address":[14570595],"length":1,"stats":{"Line":1}},{"line":287,"address":[14570603],"length":1,"stats":{"Line":1}},{"line":292,"address":[14571168,14572329],"length":1,"stats":{"Line":2}},{"line":293,"address":[14572382],"length":1,"stats":{"Line":1}},{"line":294,"address":[14572460],"length":1,"stats":{"Line":1}},{"line":296,"address":[14572389],"length":1,"stats":{"Line":1}},{"line":299,"address":[14569975,14569776,14569969],"length":1,"stats":{"Line":1}},{"line":300,"address":[14569814],"length":1,"stats":{"Line":1}},{"line":302,"address":[14569880,14569840],"length":1,"stats":{"Line":1}},{"line":305,"address":[14569536,14569754,14569748],"length":1,"stats":{"Line":1}},{"line":306,"address":[14569581,14569663],"length":1,"stats":{"Line":2}},{"line":309,"address":[14572656,14572985,14572991],"length":1,"stats":{"Line":1}},{"line":310,"address":[14572695],"length":1,"stats":{"Line":1}},{"line":313,"address":[14572709],"length":1,"stats":{"Line":1}},{"line":314,"address":[14572761],"length":1,"stats":{"Line":1}},{"line":316,"address":[14572981,14572892],"length":1,"stats":{"Line":2}},{"line":319,"address":[14572961,14572871],"length":1,"stats":{"Line":4}},{"line":322,"address":[14572913,14572983],"length":1,"stats":{"Line":0}},{"line":328,"address":[14572806],"length":1,"stats":{"Line":2}},{"line":331,"address":[14572816],"length":1,"stats":{"Line":2}},{"line":333,"address":[14573035],"length":1,"stats":{"Line":2}},{"line":336,"address":[14573014],"length":1,"stats":{"Line":0}},{"line":339,"address":[14573056],"length":1,"stats":{"Line":0}},{"line":344,"address":[14563008],"length":1,"stats":{"Line":0}},{"line":345,"address":[14563037],"length":1,"stats":{"Line":0}},{"line":346,"address":[14563095],"length":1,"stats":{"Line":0}},{"line":348,"address":[14563131],"length":1,"stats":{"Line":0}},{"line":352,"address":[14564704,14565058,14565052],"length":1,"stats":{"Line":2}},{"line":353,"address":[14564734,14564958],"length":1,"stats":{"Line":4}},{"line":355,"address":[14564892,14564825],"length":1,"stats":{"Line":4}},{"line":356,"address":[14565042,14564900,14564979,14564919],"length":1,"stats":{"Line":4}},{"line":359,"address":[14564322,14564316,14563968],"length":1,"stats":{"Line":2}},{"line":360,"address":[14563998,14564222],"length":1,"stats":{"Line":3}},{"line":362,"address":[14564089,14564156],"length":1,"stats":{"Line":4}},{"line":363,"address":[14564243,14564183,14564306,14564164],"length":1,"stats":{"Line":2}},{"line":366,"address":[14564336,14564684,14564690],"length":1,"stats":{"Line":0}},{"line":367,"address":[14564366,14564590],"length":1,"stats":{"Line":0}},{"line":369,"address":[14564457,14564524],"length":1,"stats":{"Line":0}},{"line":370,"address":[14564532,14564551,14564674,14564611],"length":1,"stats":{"Line":0}},{"line":373,"address":[14563894,14563954,14563152],"length":1,"stats":{"Line":0}},{"line":374,"address":[14563188],"length":1,"stats":{"Line":0}},{"line":375,"address":[14563211],"length":1,"stats":{"Line":0}},{"line":377,"address":[14563281,14563435,14563342,14563908],"length":1,"stats":{"Line":0}},{"line":378,"address":[14563646,14563539],"length":1,"stats":{"Line":0}},{"line":379,"address":[14563704,14563791],"length":1,"stats":{"Line":0}},{"line":380,"address":[14563812],"length":1,"stats":{"Line":0}},{"line":385,"address":[14563566],"length":1,"stats":{"Line":0}},{"line":388,"address":[14566870,14566930,14566128],"length":1,"stats":{"Line":0}},{"line":389,"address":[14566164],"length":1,"stats":{"Line":0}},{"line":390,"address":[14566187],"length":1,"stats":{"Line":0}},{"line":392,"address":[14566257,14566411,14566884,14566318],"length":1,"stats":{"Line":0}},{"line":393,"address":[14566515,14566622],"length":1,"stats":{"Line":0}},{"line":394,"address":[14566680,14566767],"length":1,"stats":{"Line":0}},{"line":395,"address":[14566788],"length":1,"stats":{"Line":0}},{"line":400,"address":[14566542],"length":1,"stats":{"Line":0}},{"line":403,"address":[14565776,14566105,14566111],"length":1,"stats":{"Line":2}},{"line":404,"address":[14565820],"length":1,"stats":{"Line":2}},{"line":405,"address":[14565835,14565883],"length":1,"stats":{"Line":4}},{"line":406,"address":[14565917],"length":1,"stats":{"Line":2}},{"line":408,"address":[14565948],"length":1,"stats":{"Line":0}},{"line":411,"address":[14565407,14565401,14565072],"length":1,"stats":{"Line":1}},{"line":412,"address":[14565116],"length":1,"stats":{"Line":1}},{"line":413,"address":[14565131,14565179],"length":1,"stats":{"Line":2}},{"line":414,"address":[14565213],"length":1,"stats":{"Line":1}},{"line":416,"address":[14565244],"length":1,"stats":{"Line":0}},{"line":419,"address":[14565753,14565424,14565759],"length":1,"stats":{"Line":0}},{"line":420,"address":[14565468],"length":1,"stats":{"Line":0}},{"line":421,"address":[14565483,14565531],"length":1,"stats":{"Line":0}},{"line":422,"address":[14565565],"length":1,"stats":{"Line":0}},{"line":424,"address":[14565596],"length":1,"stats":{"Line":0}},{"line":427,"address":[14569518,14568672,14569313],"length":1,"stats":{"Line":1}},{"line":428,"address":[14568711],"length":1,"stats":{"Line":1}},{"line":429,"address":[14568734],"length":1,"stats":{"Line":1}},{"line":430,"address":[14568862,14568952,14568804,14569472],"length":1,"stats":{"Line":4}},{"line":431,"address":[14569040,14569364],"length":1,"stats":{"Line":2}},{"line":432,"address":[14569382],"length":1,"stats":{"Line":0}},{"line":435,"address":[14569094],"length":1,"stats":{"Line":1}},{"line":437,"address":[14569128],"length":1,"stats":{"Line":0}},{"line":440,"address":[14567585,14566944,14567790],"length":1,"stats":{"Line":2}},{"line":441,"address":[14566983],"length":1,"stats":{"Line":2}},{"line":442,"address":[14567006],"length":1,"stats":{"Line":2}},{"line":443,"address":[14567076,14567224,14567744,14567134],"length":1,"stats":{"Line":8}},{"line":444,"address":[14567312,14567636],"length":1,"stats":{"Line":4}},{"line":445,"address":[14567654],"length":1,"stats":{"Line":0}},{"line":448,"address":[14567366],"length":1,"stats":{"Line":2}},{"line":450,"address":[14567400],"length":1,"stats":{"Line":0}},{"line":453,"address":[14568654,14567808,14568449],"length":1,"stats":{"Line":0}},{"line":454,"address":[14567847],"length":1,"stats":{"Line":0}},{"line":455,"address":[14567870],"length":1,"stats":{"Line":0}},{"line":456,"address":[14568608,14567998,14567940,14568088],"length":1,"stats":{"Line":0}},{"line":457,"address":[14568176,14568500],"length":1,"stats":{"Line":0}},{"line":458,"address":[14568518],"length":1,"stats":{"Line":0}},{"line":461,"address":[14568230],"length":1,"stats":{"Line":0}},{"line":463,"address":[14568264],"length":1,"stats":{"Line":0}},{"line":467,"address":[14539873,14538832,14539867],"length":1,"stats":{"Line":3}},{"line":474,"address":[14538930],"length":1,"stats":{"Line":3}},{"line":475,"address":[14538969],"length":1,"stats":{"Line":0}},{"line":478,"address":[14538997],"length":1,"stats":{"Line":3}},{"line":479,"address":[14539051],"length":1,"stats":{"Line":0}},{"line":482,"address":[14539041],"length":1,"stats":{"Line":3}},{"line":483,"address":[14539129],"length":1,"stats":{"Line":0}},{"line":487,"address":[14539142,14539084],"length":1,"stats":{"Line":3}},{"line":489,"address":[14539184],"length":1,"stats":{"Line":2}},{"line":490,"address":[14539218],"length":1,"stats":{"Line":1}},{"line":491,"address":[14539236,14539393,14539300],"length":1,"stats":{"Line":8}},{"line":492,"address":[14539489,14539586],"length":1,"stats":{"Line":0}},{"line":493,"address":[14539737,14539648,14539758],"length":1,"stats":{"Line":0}},{"line":494,"address":[14539794],"length":1,"stats":{"Line":0}},{"line":499,"address":[14539511],"length":1,"stats":{"Line":3}},{"line":502,"address":[14552416,14553389,14553282],"length":1,"stats":{"Line":1}},{"line":508,"address":[14552467],"length":1,"stats":{"Line":2}},{"line":511,"address":[14552550],"length":1,"stats":{"Line":1}},{"line":514,"address":[14552664,14552609],"length":1,"stats":{"Line":0}},{"line":516,"address":[14552666],"length":1,"stats":{"Line":0}},{"line":519,"address":[14552676],"length":1,"stats":{"Line":0}},{"line":528,"address":[14552657],"length":1,"stats":{"Line":1}},{"line":533,"address":[14552808,14552859],"length":1,"stats":{"Line":3}},{"line":537,"address":[14553232],"length":1,"stats":{"Line":2}},{"line":538,"address":[14553249],"length":1,"stats":{"Line":2}},{"line":539,"address":[14553256],"length":1,"stats":{"Line":2}},{"line":542,"address":[14542660,14541920,14542666],"length":1,"stats":{"Line":2}},{"line":548,"address":[14541979],"length":1,"stats":{"Line":1}},{"line":549,"address":[14541995],"length":1,"stats":{"Line":2}},{"line":550,"address":[14542004],"length":1,"stats":{"Line":0}},{"line":553,"address":[14542140,14542063,14542024],"length":1,"stats":{"Line":4}},{"line":554,"address":[14542037,14542126],"length":1,"stats":{"Line":2}},{"line":556,"address":[14542207],"length":1,"stats":{"Line":2}},{"line":557,"address":[14542221],"length":1,"stats":{"Line":0}},{"line":560,"address":[14542246],"length":1,"stats":{"Line":1}},{"line":561,"address":[14542306,14542262],"length":1,"stats":{"Line":3}},{"line":562,"address":[14542496,14542422],"length":1,"stats":{"Line":2}},{"line":564,"address":[14542608],"length":1,"stats":{"Line":1}},{"line":565,"address":[14542630],"length":1,"stats":{"Line":2}},{"line":566,"address":[14542637],"length":1,"stats":{"Line":1}},{"line":569,"address":[14540654,14540635,14539888],"length":1,"stats":{"Line":0}},{"line":576,"address":[14539952],"length":1,"stats":{"Line":0}},{"line":577,"address":[14540030],"length":1,"stats":{"Line":0}},{"line":578,"address":[14540051],"length":1,"stats":{"Line":0}},{"line":581,"address":[14540645,14540146,14540195,14540079],"length":1,"stats":{"Line":0}},{"line":582,"address":[14540123,14540181],"length":1,"stats":{"Line":0}},{"line":584,"address":[14540265],"length":1,"stats":{"Line":0}},{"line":585,"address":[14540279],"length":1,"stats":{"Line":0}},{"line":588,"address":[14540307],"length":1,"stats":{"Line":0}},{"line":589,"address":[14540315],"length":1,"stats":{"Line":0}},{"line":591,"address":[14540537],"length":1,"stats":{"Line":0}},{"line":592,"address":[14540596],"length":1,"stats":{"Line":0}},{"line":593,"address":[14540603],"length":1,"stats":{"Line":0}},{"line":596,"address":[14574288],"length":1,"stats":{"Line":0}},{"line":600,"address":[14574309],"length":1,"stats":{"Line":0}},{"line":603,"address":[14574224],"length":1,"stats":{"Line":0}},{"line":604,"address":[14574238],"length":1,"stats":{"Line":0}},{"line":605,"address":[14574247],"length":1,"stats":{"Line":0}},{"line":607,"address":[14574257],"length":1,"stats":{"Line":0}},{"line":611,"address":[14545136,14545405,14545399],"length":1,"stats":{"Line":0}},{"line":622,"address":[14545202],"length":1,"stats":{"Line":0}},{"line":623,"address":[14545255],"length":1,"stats":{"Line":0}},{"line":625,"address":[14545265,14545229],"length":1,"stats":{"Line":0}},{"line":626,"address":[14545337],"length":1,"stats":{"Line":0}},{"line":627,"address":[14545359],"length":1,"stats":{"Line":0}},{"line":629,"address":[14545347],"length":1,"stats":{"Line":0}},{"line":630,"address":[14545379],"length":1,"stats":{"Line":0}},{"line":632,"address":[14545369],"length":1,"stats":{"Line":0}},{"line":636,"address":[14544876,14544384,14544913],"length":1,"stats":{"Line":1}},{"line":637,"address":[14544724,14544423],"length":1,"stats":{"Line":2}},{"line":638,"address":[14544446],"length":1,"stats":{"Line":2}},{"line":639,"address":[14544555,14544498],"length":1,"stats":{"Line":3}},{"line":643,"address":[14552319,14551632,14552260],"length":1,"stats":{"Line":1}},{"line":644,"address":[14552102,14551684],"length":1,"stats":{"Line":4}},{"line":645,"address":[14551707],"length":1,"stats":{"Line":1}},{"line":646,"address":[14551816,14551759,14552266],"length":1,"stats":{"Line":3}},{"line":650,"address":[14551615,14551200,14551581],"length":1,"stats":{"Line":0}},{"line":651,"address":[14551247,14551524],"length":1,"stats":{"Line":0}},{"line":652,"address":[14551270],"length":1,"stats":{"Line":0}},{"line":653,"address":[14551322,14551383],"length":1,"stats":{"Line":0}},{"line":658,"address":[14555232],"length":1,"stats":{"Line":1}},{"line":675,"address":[14551176,14550736,14551170],"length":1,"stats":{"Line":1}},{"line":677,"address":[14550756],"length":1,"stats":{"Line":1}},{"line":678,"address":[14550821],"length":1,"stats":{"Line":0}},{"line":682,"address":[14550771,14550897,14550850],"length":1,"stats":{"Line":3}},{"line":684,"address":[14551125,14550980,14551072],"length":1,"stats":{"Line":3}},{"line":685,"address":[14551095],"length":1,"stats":{"Line":0}},{"line":692,"address":[14551004],"length":1,"stats":{"Line":1}},{"line":695,"address":[14545122,14545096,14544928],"length":1,"stats":{"Line":1}},{"line":700,"address":[14544973],"length":1,"stats":{"Line":1}},{"line":701,"address":[14545037],"length":1,"stats":{"Line":1}},{"line":704,"address":[14542688,14544333,14544317],"length":1,"stats":{"Line":2}},{"line":710,"address":[14542790],"length":1,"stats":{"Line":2}},{"line":712,"address":[14542815],"length":1,"stats":{"Line":2}},{"line":713,"address":[14542935],"length":1,"stats":{"Line":0}},{"line":716,"address":[14542837,14542962],"length":1,"stats":{"Line":1}},{"line":719,"address":[14543063],"length":1,"stats":{"Line":2}},{"line":720,"address":[14543141],"length":1,"stats":{"Line":0}},{"line":723,"address":[14543110,14543221,14544328],"length":1,"stats":{"Line":4}},{"line":724,"address":[14543340,14544323],"length":1,"stats":{"Line":2}},{"line":725,"address":[14543530],"length":1,"stats":{"Line":2}},{"line":728,"address":[14543584],"length":1,"stats":{"Line":2}},{"line":730,"address":[14543632],"length":1,"stats":{"Line":1}},{"line":731,"address":[14543648],"length":1,"stats":{"Line":1}},{"line":732,"address":[14543778,14543852],"length":1,"stats":{"Line":1}},{"line":733,"address":[14543976],"length":1,"stats":{"Line":1}},{"line":734,"address":[14543992],"length":1,"stats":{"Line":1}},{"line":735,"address":[14544006],"length":1,"stats":{"Line":1}},{"line":736,"address":[14544020],"length":1,"stats":{"Line":1}},{"line":737,"address":[14544027,14544121],"length":1,"stats":{"Line":1}},{"line":739,"address":[14544242],"length":1,"stats":{"Line":1}},{"line":740,"address":[14544249],"length":1,"stats":{"Line":2}},{"line":745,"address":[14540688,14541883,14541856],"length":1,"stats":{"Line":0}},{"line":751,"address":[14540752],"length":1,"stats":{"Line":0}},{"line":752,"address":[14540838,14541871],"length":1,"stats":{"Line":0}},{"line":755,"address":[14541031],"length":1,"stats":{"Line":0}},{"line":756,"address":[14541047,14541091],"length":1,"stats":{"Line":0}},{"line":757,"address":[14541207],"length":1,"stats":{"Line":0}},{"line":758,"address":[14541388],"length":1,"stats":{"Line":0}},{"line":759,"address":[14541608],"length":1,"stats":{"Line":0}},{"line":761,"address":[14541817],"length":1,"stats":{"Line":0}},{"line":762,"address":[14541824],"length":1,"stats":{"Line":0}},{"line":765,"address":[14553872],"length":1,"stats":{"Line":2}},{"line":766,"address":[14553893],"length":1,"stats":{"Line":2}},{"line":770,"address":[14574170,14573456,14574176],"length":1,"stats":{"Line":2}},{"line":775,"address":[14573510],"length":1,"stats":{"Line":2}},{"line":779,"address":[14573518],"length":1,"stats":{"Line":2}},{"line":780,"address":[14573534,14573717],"length":1,"stats":{"Line":4}},{"line":781,"address":[14573713,14573719,14573552],"length":1,"stats":{"Line":4}},{"line":782,"address":[14573624,14573694,14573543],"length":1,"stats":{"Line":0}},{"line":783,"address":[14573696,14573690,14573597],"length":1,"stats":{"Line":0}},{"line":785,"address":[14573578,14573620,14573626],"length":1,"stats":{"Line":0}},{"line":789,"address":[14573649,14573732],"length":1,"stats":{"Line":4}},{"line":790,"address":[14573815,14573801,14573755],"length":1,"stats":{"Line":4}},{"line":793,"address":[14574035,14573808],"length":1,"stats":{"Line":3}},{"line":794,"address":[14573915,14574006],"length":1,"stats":{"Line":1}},{"line":795,"address":[14574040,14574031,14573988],"length":1,"stats":{"Line":2}},{"line":799,"address":[14574168,14573875],"length":1,"stats":{"Line":2}},{"line":801,"address":[14574094,14574164],"length":1,"stats":{"Line":0}},{"line":802,"address":[14574158,14574061],"length":1,"stats":{"Line":2}},{"line":804,"address":[14574132],"length":1,"stats":{"Line":0}},{"line":809,"address":[14573781,14574211],"length":1,"stats":{"Line":2}},{"line":810,"address":[14574203],"length":1,"stats":{"Line":0}},{"line":813,"address":[14574189],"length":1,"stats":{"Line":2}},{"line":817,"address":[14553424],"length":1,"stats":{"Line":2}},{"line":822,"address":[14553466],"length":1,"stats":{"Line":2}},{"line":823,"address":[14553532],"length":1,"stats":{"Line":1}},{"line":824,"address":[14553573],"length":1,"stats":{"Line":1}},{"line":827,"address":[14553591,14553633],"length":1,"stats":{"Line":2}},{"line":828,"address":[14553657],"length":1,"stats":{"Line":0}},{"line":832,"address":[14553692,14553617],"length":1,"stats":{"Line":2}},{"line":833,"address":[14553716],"length":1,"stats":{"Line":0}},{"line":837,"address":[14553748,14553676],"length":1,"stats":{"Line":4}},{"line":838,"address":[14553772],"length":1,"stats":{"Line":0}},{"line":842,"address":[14553811,14553732],"length":1,"stats":{"Line":4}},{"line":843,"address":[14553835],"length":1,"stats":{"Line":0}},{"line":848,"address":[14553598],"length":1,"stats":{"Line":2}},{"line":852,"address":[14550624],"length":1,"stats":{"Line":2}},{"line":854,"address":[14550632,14550657],"length":1,"stats":{"Line":4}},{"line":855,"address":[14550642,14550688],"length":1,"stats":{"Line":4}},{"line":856,"address":[14550711,14550673],"length":1,"stats":{"Line":0}},{"line":857,"address":[14550700],"length":1,"stats":{"Line":0}},{"line":862,"address":[14556192],"length":1,"stats":{"Line":2}},{"line":867,"address":[14556234],"length":1,"stats":{"Line":2}},{"line":868,"address":[14556345],"length":1,"stats":{"Line":0}},{"line":869,"address":[14556325],"length":1,"stats":{"Line":0}},{"line":870,"address":[14556305],"length":1,"stats":{"Line":0}},{"line":871,"address":[14556285],"length":1,"stats":{"Line":0}},{"line":872,"address":[14556265],"length":1,"stats":{"Line":2}},{"line":875,"address":[14556368],"length":1,"stats":{"Line":2}},{"line":876,"address":[14556397],"length":1,"stats":{"Line":0}},{"line":877,"address":[14556417],"length":1,"stats":{"Line":2}},{"line":878,"address":[14556437],"length":1,"stats":{"Line":0}},{"line":879,"address":[14556457],"length":1,"stats":{"Line":0}},{"line":882,"address":[14556485],"length":1,"stats":{"Line":1}},{"line":884,"address":[14556516],"length":1,"stats":{"Line":1}},{"line":889,"address":[14555212,14553920,14555206],"length":1,"stats":{"Line":1}},{"line":895,"address":[14554059],"length":1,"stats":{"Line":1}},{"line":896,"address":[14554265,14554146],"length":1,"stats":{"Line":2}},{"line":898,"address":[14554162],"length":1,"stats":{"Line":1}},{"line":899,"address":[14554289],"length":1,"stats":{"Line":1}},{"line":901,"address":[14554688,14554409],"length":1,"stats":{"Line":2}},{"line":902,"address":[14554534],"length":1,"stats":{"Line":1}},{"line":903,"address":[14554438],"length":1,"stats":{"Line":1}},{"line":905,"address":[14554550],"length":1,"stats":{"Line":1}},{"line":906,"address":[14554672],"length":1,"stats":{"Line":1}},{"line":907,"address":[14554629],"length":1,"stats":{"Line":1}},{"line":909,"address":[14554465],"length":1,"stats":{"Line":0}},{"line":910,"address":[14554415],"length":1,"stats":{"Line":0}},{"line":914,"address":[14554802],"length":1,"stats":{"Line":1}},{"line":915,"address":[14554488,14555182,14554701],"length":1,"stats":{"Line":2}},{"line":916,"address":[14554809],"length":1,"stats":{"Line":1}},{"line":917,"address":[14555156,14554854],"length":1,"stats":{"Line":1}},{"line":920,"address":[14554035],"length":1,"stats":{"Line":1}},{"line":921,"address":[14555103],"length":1,"stats":{"Line":1}},{"line":922,"address":[14555051],"length":1,"stats":{"Line":1}},{"line":924,"address":[14555127],"length":1,"stats":{"Line":1}},{"line":927,"address":[14554185],"length":1,"stats":{"Line":1}},{"line":931,"address":[14552336],"length":1,"stats":{"Line":0}},{"line":935,"address":[14552368],"length":1,"stats":{"Line":0}},{"line":939,"address":[14573088],"length":1,"stats":{"Line":3}},{"line":944,"address":[14573146,14573228],"length":1,"stats":{"Line":3}},{"line":946,"address":[14573204],"length":1,"stats":{"Line":2}},{"line":947,"address":[14573233],"length":1,"stats":{"Line":0}},{"line":951,"address":[14573253],"length":1,"stats":{"Line":1}},{"line":952,"address":[14573329],"length":1,"stats":{"Line":0}},{"line":956,"address":[14573297],"length":1,"stats":{"Line":2}},{"line":959,"address":[14573406],"length":1,"stats":{"Line":0}},{"line":960,"address":[14573429],"length":1,"stats":{"Line":0}},{"line":965,"address":[14573379],"length":1,"stats":{"Line":0}},{"line":966,"address":[14573416],"length":1,"stats":{"Line":0}},{"line":974,"address":[14573339],"length":1,"stats":{"Line":1}},{"line":976,"address":[14573220],"length":1,"stats":{"Line":0}},{"line":981,"address":[14556141,14556135,14555248],"length":1,"stats":{"Line":0}},{"line":985,"address":[14555294],"length":1,"stats":{"Line":0}},{"line":986,"address":[14555325],"length":1,"stats":{"Line":0}},{"line":989,"address":[14555309],"length":1,"stats":{"Line":0}},{"line":990,"address":[14555359],"length":1,"stats":{"Line":0}},{"line":993,"address":[14555343],"length":1,"stats":{"Line":0}},{"line":994,"address":[14555396],"length":1,"stats":{"Line":0}},{"line":997,"address":[14555377],"length":1,"stats":{"Line":0}},{"line":998,"address":[14555495],"length":1,"stats":{"Line":0}},{"line":1001,"address":[14555414],"length":1,"stats":{"Line":0}},{"line":1002,"address":[14555571,14555432,14555524],"length":1,"stats":{"Line":0}},{"line":1003,"address":[14555833,14555702],"length":1,"stats":{"Line":0}},{"line":1004,"address":[14555866],"length":1,"stats":{"Line":0}},{"line":1007,"address":[14555879,14555838],"length":1,"stats":{"Line":0}},{"line":1008,"address":[14555894],"length":1,"stats":{"Line":0}},{"line":1011,"address":[14555907],"length":1,"stats":{"Line":0}},{"line":1012,"address":[14555982],"length":1,"stats":{"Line":0}},{"line":1013,"address":[14556054],"length":1,"stats":{"Line":0}},{"line":1016,"address":[14556074,14556011],"length":1,"stats":{"Line":0}},{"line":1019,"address":[14555736],"length":1,"stats":{"Line":0}},{"line":1020,"address":[14555769],"length":1,"stats":{"Line":0}},{"line":1023,"address":[14555759],"length":1,"stats":{"Line":0}}],"covered":226,"coverable":437},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","test.rs"],"content":"#![cfg(test)]\n\nuse super::*;\nuse soroban_sdk::{Address, BytesN, Env, String};\n\n#[test]\nfn test_basic_invoice_creation() {\n    let env = Env::default();\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n\n    let business = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let amount = 1000;\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    let description = String::from_str(\u0026env, \"Test invoice for services\");\n    let category = invoice::InvoiceCategory::Services;\n    let tags = vec![\u0026env, String::from_str(\u0026env, \"test\")];\n\n    let invoice_id = client.store_invoice(\n        \u0026business,\n        \u0026amount,\n        \u0026currency,\n        \u0026due_date,\n        \u0026description,\n        \u0026category,\n        \u0026tags,\n    );\n\n    // Verify invoice was stored\n    let invoice = client.get_invoice(\u0026invoice_id);\n    assert_eq!(invoice.business, business);\n    assert_eq!(invoice.amount, amount);\n    assert_eq!(invoice.currency, currency);\n    assert_eq!(invoice.due_date, due_date);\n    assert_eq!(invoice.description, description);\n    assert_eq!(invoice.status, InvoiceStatus::Pending);\n    assert_eq!(invoice.funded_amount, 0);\n    assert!(invoice.investor.is_none());\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","samaro","issue156","quicklendx-protocol","quicklendx-contracts","test_queries.rs"],"content":"use soroban_sdk::{Address, String, Vec, vec, BytesN, Env};\nuse quicklendx_contracts::{QuickLendXContract, QuickLendXContractClient};\nuse quicklendx_contracts::invoice::{InvoiceCategory, InvoiceStatus};\nuse quicklendx_contracts::verification::{BusinessVerificationStatus, InvestorTier, InvestorRiskLevel};\nuse quicklendx_contracts::analytics::{TimePeriod};\n\n/// Test all documented queries from README.md\npub fn test_all_documented_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    \n    println!(\"=== Testing QuickLendX Protocol Queries ===\");\n    println!(\"Contract ID: {:?}\", contract_id);\n    println!(\"Admin: {:?}\", admin);\n    println!(\"Business: {:?}\", business);\n    println!(\"Investor: {:?}\", investor);\n    println!(\"Currency: {:?}\", currency);\n    println!();\n    \n    // Test 1: Set admin\n    println!(\"1. Setting admin...\");\n    match client.try_set_admin(\u0026admin) {\n        Ok(_) =\u003e println!(\" Admin set successfully\"),\n        Err(e) =\u003e println!(\" Failed to set admin: {:?}\", e),\n    }\n    \n    // Test 2: Business KYC submission\n    println!(\"\\n2. Testing business KYC submission...\");\n    match client.try_submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\")) {\n        Ok(_) =\u003e println!(\" Business KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit business KYC: {:?}\", e),\n    }\n    \n    // Test 3: Business verification\n    println!(\"\\n3. Testing business verification...\");\n    match client.try_verify_business(\u0026admin, \u0026business) {\n        Ok(_) =\u003e println!(\" Business verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify business: {:?}\", e),\n    }\n    \n    // Test 4: Create invoice\n    println!(\"\\n4. Testing invoice creation...\");\n    let invoice_id = match client.try_store_invoice(\n        \u0026business,\n        \u002610000, // $100.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice for services\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\"), String::from_str(\u0026env, \"services\")]\n    ) {\n        Ok(id) =\u003e {\n            println!(\" Invoice created successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to create invoice: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 5: Verify invoice\n    println!(\"\\n5. Testing invoice verification...\");\n    match client.try_verify_invoice(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Invoice verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify invoice: {:?}\", e),\n    }\n    \n    // Test 6: Investor KYC submission\n    println!(\"\\n6. Testing investor KYC submission...\");\n    match client.try_submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\")) {\n        Ok(_) =\u003e println!(\" Investor KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit investor KYC: {:?}\", e),\n    }\n    \n    // Test 7: Investor verification\n    println!(\"\\n7. Testing investor verification...\");\n    match client.try_verify_investor(\u0026investor, \u00261000) {\n        Ok(_) =\u003e println!(\" Investor verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify investor: {:?}\", e),\n    }\n    \n    // Test 8: Place bid\n    println!(\"\\n8. Testing bid placement...\");\n    let bid_id = match client.try_place_bid(\u0026investor, \u0026invoice_id, \u00269500, \u002610000) {\n        Ok(id) =\u003e {\n            println!(\" Bid placed successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to place bid: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 9: Accept bid\n    println!(\"\\n9. Testing bid acceptance...\");\n    match client.try_accept_bid(\u0026invoice_id, \u0026bid_id) {\n        Ok(_) =\u003e println!(\" Bid accepted successfully\"),\n        Err(e) =\u003e println!(\" Failed to accept bid: {:?}\", e),\n    }\n    \n    // Test 10: Release escrow funds\n    println!(\"\\n10. Testing escrow fund release...\");\n    match client.try_release_escrow_funds(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Escrow funds released successfully\"),\n        Err(e) =\u003e println!(\" Failed to release escrow funds: {:?}\", e),\n    }\n    \n    // Test 11: Query functions\n    println!(\"\\n11. Testing query functions...\");\n    \n    // Get invoice\n    match client.try_get_invoice(\u0026invoice_id) {\n        Ok(invoice) =\u003e println!(\" Retrieved invoice: amount={}, status={:?}\", invoice.amount, invoice.status),\n        Err(e) =\u003e println!(\" Failed to get invoice: {:?}\", e),\n    }\n    \n    // Get business invoices\n    let business_invoices = client.get_business_invoices(\u0026business);\n    println!(\" Retrieved {} business invoices\", business_invoices.len());\n    \n    // Get invoices by status\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    let funded_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Funded);\n    println!(\" Retrieved invoices by status - Pending: {}, Verified: {}, Funded: {}\", \n             pending_invoices.len(), verified_invoices.len(), funded_invoices.len());\n    \n    // Get available invoices\n    let available_invoices = client.get_available_invoices();\n    println!(\" Retrieved {} available invoices\", available_invoices.len());\n    \n    // Test 12: Verification queries\n    println!(\"\\n12. Testing verification queries...\");\n    \n    // Get verified businesses\n    let verified_businesses = client.get_verified_businesses();\n    println!(\" Retrieved {} verified businesses\", verified_businesses.len());\n    \n    // Get pending businesses\n    let pending_businesses = client.get_pending_businesses();\n    println!(\" Retrieved {} pending businesses\", pending_businesses.len());\n    \n    // Get business verification status\n    match client.try_get_business_verification_status(\u0026business) {\n        Ok(Some(verification)) =\u003e println!(\" Retrieved business verification: status={:?}\", verification.status),\n        Ok(None) =\u003e println!(\" No business verification found\"),\n        Err(e) =\u003e println!(\" Failed to get business verification: {:?}\", e),\n    }\n    \n    // Test 13: Investor verification queries\n    println!(\"\\n13. Testing investor verification queries...\");\n    \n    // Get verified investors\n    let verified_investors = client.get_verified_investors();\n    println!(\" Retrieved {} verified investors\", verified_investors.len());\n    \n    // Get pending investors\n    let pending_investors = client.get_pending_investors();\n    println!(\" Retrieved {} pending investors\", pending_investors.len());\n    \n    // Get investor verification\n    match client.try_get_investor_verification(\u0026investor) {\n        Ok(Some(verification)) =\u003e {\n            println!(\" Retrieved investor verification: tier={:?}, risk_level={:?}, limit={}\", \n                     verification.tier, verification.risk_level, verification.investment_limit);\n        },\n        Ok(None) =\u003e println!(\" No investor verification found\"),\n        Err(e) =\u003e println!(\" Failed to get investor verification: {:?}\", e),\n    }\n    \n    // Test 14: Analytics queries\n    println!(\"\\n14. Testing analytics queries...\");\n    \n    // Get platform metrics\n    match client.try_get_platform_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved platform metrics: total_invoices={}, total_volume={}\", \n                               metrics.total_invoices, metrics.total_volume),\n        Err(e) =\u003e println!(\" Failed to get platform metrics: {:?}\", e),\n    }\n    \n    // Get performance metrics\n    match client.try_get_performance_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved performance metrics: success_rate={}, satisfaction={}\", \n                               metrics.transaction_success_rate, metrics.user_satisfaction_score),\n        Err(e) =\u003e println!(\" Failed to get performance metrics: {:?}\", e),\n    }\n    \n    // Test 15: Audit queries\n    println!(\"\\n15. Testing audit queries...\");\n    \n    // Get audit trail\n    let audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    println!(\" Retrieved {} audit entries for invoice\", audit_trail.len());\n    \n    // Get audit stats\n    let audit_stats = client.get_audit_stats();\n    println!(\" Retrieved audit stats: total_entries={}\", audit_stats.total_entries);\n    \n    // Test 16: Backup queries\n    println!(\"\\n16. Testing backup queries...\");\n    \n    // Create backup\n    match client.try_create_backup(\u0026String::from_str(\u0026env, \"Test backup\")) {\n        Ok(backup_id) =\u003e {\n            println!(\" Created backup: {:?}\", backup_id);\n            \n            // Get backup details\n            match client.try_get_backup_details(\u0026backup_id) {\n                Ok(Some(backup)) =\u003e println!(\" Retrieved backup details: status={:?}, count={}\", \n                                           backup.status, backup.invoice_count),\n                Ok(None) =\u003e println!(\" No backup found\"),\n                Err(e) =\u003e println!(\" Failed to get backup details: {:?}\", e),\n            }\n        },\n        Err(e) =\u003e println!(\" Failed to create backup: {:?}\", e),\n    }\n    \n    // Get all backups\n    let backups = client.get_backups();\n    println!(\" Retrieved {} backups\", backups.len());\n    \n    // Test 17: Category and tag queries\n    println!(\"\\n17. Testing category and tag queries...\");\n    \n    // Get invoices by category\n    let services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    println!(\" Retrieved {} invoices in Services category\", services_invoices.len());\n    \n    // Get invoices by tag\n    let test_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"test\"));\n    println!(\" Retrieved {} invoices with 'test' tag\", test_tag_invoices.len());\n    \n    // Get all categories\n    let all_categories = client.get_all_categories();\n    println!(\" Retrieved {} categories\", all_categories.len());\n    \n    // Test 18: Rating queries\n    println!(\"\\n18. Testing rating queries...\");\n    \n    // Get invoices with ratings\n    let invoices_with_ratings = client.get_invoices_with_ratings_count();\n    println!(\" Retrieved {} invoices with ratings\", invoices_with_ratings);\n    \n    // Get invoices with rating above threshold\n    let high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    println!(\" Retrieved {} invoices with rating above 4\", high_rated_invoices.len());\n    \n    // Test 19: Notification queries\n    println!(\"\\n19. Testing notification queries...\");\n    \n    // Get user notifications\n    let user_notifications = client.get_user_notifications(\u0026business);\n    println!(\" Retrieved {} notifications for business\", user_notifications.len());\n    \n    // Get notification preferences\n    let preferences = client.get_notification_preferences(\u0026business);\n    println!(\" Retrieved notification preferences: email={}, push={}\", \n             preferences.email_enabled, preferences.push_enabled);\n    \n    // Get notification stats\n    let notification_stats = client.get_user_notification_stats(\u0026business);\n    println!(\" Retrieved notification stats: total_sent={}, total_delivered={}\", \n             notification_stats.total_sent, notification_stats.total_delivered);\n    \n    // Test 20: Advanced analytics queries\n    println!(\"\\n20. Testing advanced analytics queries...\");\n    \n    // Get financial metrics\n    match client.try_get_financial_metrics(\u0026TimePeriod::Monthly) {\n        Ok(metrics) =\u003e println!(\" Retrieved financial metrics: total_volume={}, total_fees={}\", \n                               metrics.total_volume, metrics.total_fees),\n        Err(e) =\u003e println!(\" Failed to get financial metrics: {:?}\", e),\n    }\n    \n    // Get user behavior metrics\n    match client.try_get_user_behavior_metrics(\u0026business) {\n        Ok(metrics) =\u003e println!(\" Retrieved user behavior metrics: invoices_uploaded={}, risk_score={}\", \n                               metrics.total_invoices_uploaded, metrics.risk_score),\n        Err(e) =\u003e println!(\" Failed to get user behavior metrics: {:?}\", e),\n    }\n    \n    // Get analytics summary\n    match client.try_get_analytics_summary() {\n        Ok((platform_metrics, performance_metrics)) =\u003e {\n            println!(\" Retrieved analytics summary: platform_invoices={}, performance_success_rate={}\", \n                     platform_metrics.total_invoices, performance_metrics.transaction_success_rate);\n        },\n        Err(e) =\u003e println!(\" Failed to get analytics summary: {:?}\", e),\n    }\n    \n    // Test 21: Investor analytics queries\n    println!(\"\\n21. Testing investor analytics queries...\");\n    \n    // Get investors by tier\n    let basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    println!(\" Retrieved {} investors in Basic tier\", basic_investors.len());\n    \n    // Get investors by risk level\n    let medium_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Medium);\n    println!(\" Retrieved {} investors with Medium risk\", medium_risk_investors.len());\n    \n    // Calculate investor analytics\n    match client.try_calculate_investor_analytics(\u0026investor) {\n        Ok(analytics) =\u003e println!(\" Calculated investor analytics: tier={:?}, success_rate={}\", \n                                 analytics.tier, analytics.success_rate),\n        Err(e) =\u003e println!(\" Failed to calculate investor analytics: {:?}\", e),\n    }\n    \n    // Get investor performance metrics\n    match client.try_calc_investor_perf_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved investor performance metrics: total_investors={}, verified={}\", \n                               metrics.total_investors, metrics.verified_investors),\n        Err(e) =\u003e println!(\" Failed to get investor performance metrics: {:?}\", e),\n    }\n    \n    println!(\"\\n=== Query Testing Complete ===\");\n    println!(\"All documented queries have been tested.\");\n    println!(\"Some queries may fail due to:\");\n    println!(\"- Insufficient test data\");\n    println!(\"- Missing dependencies\");\n    println!(\"- Contract state requirements\");\n    println!(\"- Network connectivity issues\");\n}\n\nuse soroban_sdk::{Address, String, Vec, vec, BytesN, Env};\nuse quicklendx_contracts::{QuickLendXContract, QuickLendXContractClient};\nuse quicklendx_contracts::invoice::{InvoiceCategory, InvoiceStatus};\nuse quicklendx_contracts::verification::{BusinessVerificationStatus, InvestorTier, InvestorRiskLevel};\nuse quicklendx_contracts::analytics::{TimePeriod};\n\n/// Test all documented queries from README.md\npub fn test_all_documented_queries() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business = Address::generate(\u0026env);\n    let investor = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400; // 1 day from now\n    \n    println!(\"=== Testing QuickLendX Protocol Queries ===\");\n    println!(\"Contract ID: {:?}\", contract_id);\n    println!(\"Admin: {:?}\", admin);\n    println!(\"Business: {:?}\", business);\n    println!(\"Investor: {:?}\", investor);\n    println!(\"Currency: {:?}\", currency);\n    println!();\n    \n    // Test 1: Set admin\n    println!(\"1. Setting admin...\");\n    match client.try_set_admin(\u0026admin) {\n        Ok(_) =\u003e println!(\" Admin set successfully\"),\n        Err(e) =\u003e println!(\" Failed to set admin: {:?}\", e),\n    }\n    \n    // Test 2: Business KYC submission\n    println!(\"\\n2. Testing business KYC submission...\");\n    match client.try_submit_kyc_application(\u0026business, \u0026String::from_str(\u0026env, \"Business KYC Data\")) {\n        Ok(_) =\u003e println!(\" Business KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit business KYC: {:?}\", e),\n    }\n    \n    // Test 3: Business verification\n    println!(\"\\n3. Testing business verification...\");\n    match client.try_verify_business(\u0026admin, \u0026business) {\n        Ok(_) =\u003e println!(\" Business verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify business: {:?}\", e),\n    }\n    \n    // Test 4: Create invoice\n    println!(\"\\n4. Testing invoice creation...\");\n    let invoice_id = match client.try_store_invoice(\n        \u0026business,\n        \u002610000, // $100.00\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Test invoice for services\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"test\"), String::from_str(\u0026env, \"services\")]\n    ) {\n        Ok(id) =\u003e {\n            println!(\" Invoice created successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to create invoice: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 5: Verify invoice\n    println!(\"\\n5. Testing invoice verification...\");\n    match client.try_verify_invoice(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Invoice verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify invoice: {:?}\", e),\n    }\n    \n    // Test 6: Investor KYC submission\n    println!(\"\\n6. Testing investor KYC submission...\");\n    match client.try_submit_investor_kyc(\u0026investor, \u0026String::from_str(\u0026env, \"Investor KYC Data\")) {\n        Ok(_) =\u003e println!(\" Investor KYC submitted successfully\"),\n        Err(e) =\u003e println!(\" Failed to submit investor KYC: {:?}\", e),\n    }\n    \n    // Test 7: Investor verification\n    println!(\"\\n7. Testing investor verification...\");\n    match client.try_verify_investor(\u0026investor, \u00261000) {\n        Ok(_) =\u003e println!(\" Investor verified successfully\"),\n        Err(e) =\u003e println!(\" Failed to verify investor: {:?}\", e),\n    }\n    \n    // Test 8: Place bid\n    println!(\"\\n8. Testing bid placement...\");\n    let bid_id = match client.try_place_bid(\u0026investor, \u0026invoice_id, \u00269500, \u002610000) {\n        Ok(id) =\u003e {\n            println!(\" Bid placed successfully: {:?}\", id);\n            id\n        },\n        Err(e) =\u003e {\n            println!(\" Failed to place bid: {:?}\", e);\n            return;\n        }\n    };\n    \n    // Test 9: Accept bid\n    println!(\"\\n9. Testing bid acceptance...\");\n    match client.try_accept_bid(\u0026invoice_id, \u0026bid_id) {\n        Ok(_) =\u003e println!(\" Bid accepted successfully\"),\n        Err(e) =\u003e println!(\" Failed to accept bid: {:?}\", e),\n    }\n    \n    // Test 10: Release escrow funds\n    println!(\"\\n10. Testing escrow fund release...\");\n    match client.try_release_escrow_funds(\u0026invoice_id) {\n        Ok(_) =\u003e println!(\" Escrow funds released successfully\"),\n        Err(e) =\u003e println!(\" Failed to release escrow funds: {:?}\", e),\n    }\n    \n    // Test 11: Query functions\n    println!(\"\\n11. Testing query functions...\");\n    \n    // Get invoice\n    match client.try_get_invoice(\u0026invoice_id) {\n        Ok(invoice) =\u003e println!(\" Retrieved invoice: amount={}, status={:?}\", invoice.amount, invoice.status),\n        Err(e) =\u003e println!(\" Failed to get invoice: {:?}\", e),\n    }\n    \n    // Get business invoices\n    let business_invoices = client.get_business_invoices(\u0026business);\n    println!(\" Retrieved {} business invoices\", business_invoices.len());\n    \n    // Get invoices by status\n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    let funded_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Funded);\n    println!(\" Retrieved invoices by status - Pending: {}, Verified: {}, Funded: {}\", \n             pending_invoices.len(), verified_invoices.len(), funded_invoices.len());\n    \n    // Get available invoices\n    let available_invoices = client.get_available_invoices();\n    println!(\" Retrieved {} available invoices\", available_invoices.len());\n    \n    // Test 12: Verification queries\n    println!(\"\\n12. Testing verification queries...\");\n    \n    // Get verified businesses\n    let verified_businesses = client.get_verified_businesses();\n    println!(\" Retrieved {} verified businesses\", verified_businesses.len());\n    \n    // Get pending businesses\n    let pending_businesses = client.get_pending_businesses();\n    println!(\" Retrieved {} pending businesses\", pending_businesses.len());\n    \n    // Get business verification status\n    match client.try_get_business_verification_status(\u0026business) {\n        Ok(Some(verification)) =\u003e println!(\" Retrieved business verification: status={:?}\", verification.status),\n        Ok(None) =\u003e println!(\" No business verification found\"),\n        Err(e) =\u003e println!(\" Failed to get business verification: {:?}\", e),\n    }\n    \n    // Test 13: Investor verification queries\n    println!(\"\\n13. Testing investor verification queries...\");\n    \n    // Get verified investors\n    let verified_investors = client.get_verified_investors();\n    println!(\" Retrieved {} verified investors\", verified_investors.len());\n    \n    // Get pending investors\n    let pending_investors = client.get_pending_investors();\n    println!(\" Retrieved {} pending investors\", pending_investors.len());\n    \n    // Get investor verification\n    match client.try_get_investor_verification(\u0026investor) {\n        Ok(Some(verification)) =\u003e {\n            println!(\" Retrieved investor verification: tier={:?}, risk_level={:?}, limit={}\", \n                     verification.tier, verification.risk_level, verification.investment_limit);\n        },\n        Ok(None) =\u003e println!(\" No investor verification found\"),\n        Err(e) =\u003e println!(\" Failed to get investor verification: {:?}\", e),\n    }\n    \n    // Test 14: Analytics queries\n    println!(\"\\n14. Testing analytics queries...\");\n    \n    // Get platform metrics\n    match client.try_get_platform_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved platform metrics: total_invoices={}, total_volume={}\", \n                               metrics.total_invoices, metrics.total_volume),\n        Err(e) =\u003e println!(\" Failed to get platform metrics: {:?}\", e),\n    }\n    \n    // Get performance metrics\n    match client.try_get_performance_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved performance metrics: success_rate={}, satisfaction={}\", \n                               metrics.transaction_success_rate, metrics.user_satisfaction_score),\n        Err(e) =\u003e println!(\" Failed to get performance metrics: {:?}\", e),\n    }\n    \n    // Test 15: Audit queries\n    println!(\"\\n15. Testing audit queries...\");\n    \n    // Get audit trail\n    let audit_trail = client.get_invoice_audit_trail(\u0026invoice_id);\n    println!(\" Retrieved {} audit entries for invoice\", audit_trail.len());\n    \n    // Get audit stats\n    let audit_stats = client.get_audit_stats();\n    println!(\" Retrieved audit stats: total_entries={}\", audit_stats.total_entries);\n    \n    // Test 16: Backup queries\n    println!(\"\\n16. Testing backup queries...\");\n    \n    // Create backup\n    match client.try_create_backup(\u0026String::from_str(\u0026env, \"Test backup\")) {\n        Ok(backup_id) =\u003e {\n            println!(\" Created backup: {:?}\", backup_id);\n            \n            // Get backup details\n            match client.try_get_backup_details(\u0026backup_id) {\n                Ok(Some(backup)) =\u003e println!(\" Retrieved backup details: status={:?}, count={}\", \n                                           backup.status, backup.invoice_count),\n                Ok(None) =\u003e println!(\" No backup found\"),\n                Err(e) =\u003e println!(\" Failed to get backup details: {:?}\", e),\n            }\n        },\n        Err(e) =\u003e println!(\" Failed to create backup: {:?}\", e),\n    }\n    \n    // Get all backups\n    let backups = client.get_backups();\n    println!(\" Retrieved {} backups\", backups.len());\n    \n    // Test 17: Category and tag queries\n    println!(\"\\n17. Testing category and tag queries...\");\n    \n    // Get invoices by category\n    let services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    println!(\" Retrieved {} invoices in Services category\", services_invoices.len());\n    \n    // Get invoices by tag\n    let test_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"test\"));\n    println!(\" Retrieved {} invoices with 'test' tag\", test_tag_invoices.len());\n    \n    // Get all categories\n    let all_categories = client.get_all_categories();\n    println!(\" Retrieved {} categories\", all_categories.len());\n    \n    // Test 18: Rating queries\n    println!(\"\\n18. Testing rating queries...\");\n    \n    // Get invoices with ratings\n    let invoices_with_ratings = client.get_invoices_with_ratings_count();\n    println!(\" Retrieved {} invoices with ratings\", invoices_with_ratings);\n    \n    // Get invoices with rating above threshold\n    let high_rated_invoices = client.get_invoices_with_rating_above(\u00264);\n    println!(\" Retrieved {} invoices with rating above 4\", high_rated_invoices.len());\n    \n    // Test 19: Notification queries\n    println!(\"\\n19. Testing notification queries...\");\n    \n    // Get user notifications\n    let user_notifications = client.get_user_notifications(\u0026business);\n    println!(\" Retrieved {} notifications for business\", user_notifications.len());\n    \n    // Get notification preferences\n    let preferences = client.get_notification_preferences(\u0026business);\n    println!(\" Retrieved notification preferences: email={}, push={}\", \n             preferences.email_enabled, preferences.push_enabled);\n    \n    // Get notification stats\n    let notification_stats = client.get_user_notification_stats(\u0026business);\n    println!(\" Retrieved notification stats: total_sent={}, total_delivered={}\", \n             notification_stats.total_sent, notification_stats.total_delivered);\n    \n    // Test 20: Advanced analytics queries\n    println!(\"\\n20. Testing advanced analytics queries...\");\n    \n    // Get financial metrics\n    match client.try_get_financial_metrics(\u0026TimePeriod::Monthly) {\n        Ok(metrics) =\u003e println!(\" Retrieved financial metrics: total_volume={}, total_fees={}\", \n                               metrics.total_volume, metrics.total_fees),\n        Err(e) =\u003e println!(\" Failed to get financial metrics: {:?}\", e),\n    }\n    \n    // Get user behavior metrics\n    match client.try_get_user_behavior_metrics(\u0026business) {\n        Ok(metrics) =\u003e println!(\" Retrieved user behavior metrics: invoices_uploaded={}, risk_score={}\", \n                               metrics.total_invoices_uploaded, metrics.risk_score),\n        Err(e) =\u003e println!(\" Failed to get user behavior metrics: {:?}\", e),\n    }\n    \n    // Get analytics summary\n    match client.try_get_analytics_summary() {\n        Ok((platform_metrics, performance_metrics)) =\u003e {\n            println!(\" Retrieved analytics summary: platform_invoices={}, performance_success_rate={}\", \n                     platform_metrics.total_invoices, performance_metrics.transaction_success_rate);\n        },\n        Err(e) =\u003e println!(\" Failed to get analytics summary: {:?}\", e),\n    }\n    \n    // Test 21: Investor analytics queries\n    println!(\"\\n21. Testing investor analytics queries...\");\n    \n    // Get investors by tier\n    let basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    println!(\" Retrieved {} investors in Basic tier\", basic_investors.len());\n    \n    // Get investors by risk level\n    let medium_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Medium);\n    println!(\" Retrieved {} investors with Medium risk\", medium_risk_investors.len());\n    \n    // Calculate investor analytics\n    match client.try_calculate_investor_analytics(\u0026investor) {\n        Ok(analytics) =\u003e println!(\" Calculated investor analytics: tier={:?}, success_rate={}\", \n                                 analytics.tier, analytics.success_rate),\n        Err(e) =\u003e println!(\" Failed to calculate investor analytics: {:?}\", e),\n    }\n    \n    // Get investor performance metrics\n    match client.try_calc_investor_perf_metrics() {\n        Ok(metrics) =\u003e println!(\" Retrieved investor performance metrics: total_investors={}, verified={}\", \n                               metrics.total_investors, metrics.verified_investors),\n        Err(e) =\u003e println!(\" Failed to get investor performance metrics: {:?}\", e),\n    }\n    \n    println!(\"\\n=== Query Testing Complete ===\");\n    println!(\"All documented queries have been tested.\");\n    println!(\"Some queries may fail due to:\");\n    println!(\"- Insufficient test data\");\n    println!(\"- Missing dependencies\");\n    println!(\"- Contract state requirements\");\n    println!(\"- Network connectivity issues\");\n}\n\n/// Test query functions with empty results and edge cases\npub fn test_query_edge_cases() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let non_existent_address = Address::generate(\u0026env);\n    let invalid_invoice_id = BytesN::\u003c32\u003e::from_array(\u0026env, \u0026[0u8; 32]);\n    \n    println!(\"=== Testing Query Edge Cases ===\");\n    \n    // Test 1: Empty results - no data in contract\n    println!(\"\\n1. Testing empty results (no data)...\");\n    \n    // Invoice queries with no data\n    let empty_business_invoices = client.get_business_invoices(\u0026non_existent_address);\n    assert_eq!(empty_business_invoices.len(), 0, \"Should return empty vec for non-existent business\");\n    println!(\" get_business_invoices returns empty for non-existent business\");\n    \n    let empty_pending = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(empty_pending.len(), 0, \"Should return empty vec when no invoices exist\");\n    println!(\" get_invoices_by_status returns empty when no invoices exist\");\n    \n    let empty_available = client.get_available_invoices();\n    assert_eq!(empty_available.len(), 0, \"Should return empty vec when no verified invoices exist\");\n    println!(\" get_available_invoices returns empty when no verified invoices exist\");\n    \n    let empty_categories = client.get_all_categories();\n    assert_eq!(empty_categories.len(), 0, \"Should return empty vec when no categories used\");\n    println!(\" get_all_categories returns empty when no categories used\");\n    \n    let empty_ratings_count = client.get_invoices_with_ratings_count();\n    assert_eq!(empty_ratings_count, 0, \"Should return 0 when no invoices have ratings\");\n    println!(\" get_invoices_with_ratings_count returns 0 when no ratings exist\");\n    \n    let empty_high_ratings = client.get_invoices_with_rating_above(\u00263);\n    assert_eq!(empty_high_ratings.len(), 0, \"Should return empty vec when no high ratings exist\");\n    println!(\" get_invoices_with_rating_above returns empty when no high ratings exist\");\n    \n    // Verification queries with no data\n    let empty_verified_businesses = client.get_verified_businesses();\n    assert_eq!(empty_verified_businesses.len(), 0, \"Should return empty vec when no businesses verified\");\n    println!(\" get_verified_businesses returns empty when no businesses verified\");\n    \n    let empty_pending_businesses = client.get_pending_businesses();\n    assert_eq!(empty_pending_businesses.len(), 0, \"Should return empty vec when no businesses pending\");\n    println!(\" get_pending_businesses returns empty when no businesses pending\");\n    \n    let empty_verified_investors = client.get_verified_investors();\n    assert_eq!(empty_verified_investors.len(), 0, \"Should return empty vec when no investors verified\");\n    println!(\" get_verified_investors returns empty when no investors verified\");\n    \n    let empty_pending_investors = client.get_pending_investors();\n    assert_eq!(empty_pending_investors.len(), 0, \"Should return empty vec when no investors pending\");\n    println!(\" get_pending_investors returns empty when no investors pending\");\n    \n    // Bid queries with no data\n    let empty_best_bid = client.get_best_bid(\u0026invalid_invoice_id);\n    assert!(empty_best_bid.is_none(), \"Should return None for non-existent invoice\");\n    println!(\" get_best_bid returns None for non-existent invoice\");\n    \n    let empty_ranked_bids = client.get_ranked_bids(\u0026invalid_invoice_id);\n    assert_eq!(empty_ranked_bids.len(), 0, \"Should return empty vec for non-existent invoice\");\n    println!(\" get_ranked_bids returns empty for non-existent invoice\");\n    \n    // Audit queries with no data\n    let empty_audit_trail = client.get_invoice_audit_trail(\u0026invalid_invoice_id);\n    assert_eq!(empty_audit_trail.len(), 0, \"Should return empty vec for non-existent invoice\");\n    println!(\" get_invoice_audit_trail returns empty for non-existent invoice\");\n    \n    let audit_stats = client.get_audit_stats();\n    assert_eq!(audit_stats.total_entries, 0, \"Should return 0 entries when no audit data exists\");\n    println!(\" get_audit_stats returns 0 entries when no audit data exists\");\n    \n    // Backup queries with no data\n    let empty_backups = client.get_backups();\n    assert_eq!(empty_backups.len(), 0, \"Should return empty vec when no backups exist\");\n    println!(\" get_backups returns empty when no backups exist\");\n    \n    // Notification queries with no data\n    let empty_notifications = client.get_user_notifications(\u0026non_existent_address);\n    assert_eq!(empty_notifications.len(), 0, \"Should return empty vec for user with no notifications\");\n    println!(\" get_user_notifications returns empty for user with no notifications\");\n    \n    let notification_stats = client.get_user_notification_stats(\u0026non_existent_address);\n    assert_eq!(notification_stats.total_sent, 0, \"Should return 0 sent for user with no notifications\");\n    assert_eq!(notification_stats.total_delivered, 0, \"Should return 0 delivered for user with no notifications\");\n    println!(\" get_user_notification_stats returns zeros for user with no notifications\");\n    \n    // Test 2: Invalid parameters\n    println!(\"\\n2. Testing invalid parameters...\");\n    \n    // Try to get non-existent invoice\n    match client.try_get_invoice(\u0026invalid_invoice_id) {\n        Ok(_) =\u003e panic!(\"Should fail for non-existent invoice\"),\n        Err(_) =\u003e println!(\" get_invoice correctly fails for non-existent invoice\"),\n    }\n    \n    // Try to get non-existent bid\n    let non_existent_bid = client.get_bid(\u0026invalid_invoice_id);\n    assert!(non_existent_bid.is_none(), \"Should return None for non-existent bid\");\n    println!(\" get_bid returns None for non-existent bid\");\n    \n    // Try to get business verification for non-existent business\n    match client.try_get_business_verification_status(\u0026non_existent_address) {\n        Ok(None) =\u003e println!(\" get_business_verification_status returns None for non-existent business\"),\n        Ok(Some(_)) =\u003e panic!(\"Should return None for non-existent business\"),\n        Err(e) =\u003e println!(\" Unexpected error: {:?}\", e),\n    }\n    \n    // Try to get investor verification for non-existent investor\n    match client.try_get_investor_verification(\u0026non_existent_address) {\n        Ok(None) =\u003e println!(\" get_investor_verification returns None for non-existent investor\"),\n        Ok(Some(_)) =\u003e panic!(\"Should return None for non-existent investor\"),\n        Err(e) =\u003e println!(\" Unexpected error: {:?}\", e),\n    }\n    \n    // Test 3: Filter combinations and boundary conditions\n    println!(\"\\n3. Testing filter combinations and boundaries...\");\n    \n    // Test with empty tag\n    let empty_tag_results = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"\"));\n    assert_eq!(empty_tag_results.len(), 0, \"Should return empty for empty tag\");\n    println!(\" get_invoices_by_tag returns empty for empty tag\");\n    \n    // Test with non-existent tag\n    let non_existent_tag_results = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"nonexistent\"));\n    assert_eq!(non_existent_tag_results.len(), 0, \"Should return empty for non-existent tag\");\n    println!(\" get_invoices_by_tag returns empty for non-existent tag\");\n    \n    // Test rating threshold boundaries\n    let zero_threshold = client.get_invoices_with_rating_above(\u00260);\n    assert_eq!(zero_threshold.len(), 0, \"Should return empty for threshold 0 (no ratings exist)\");\n    println!(\" get_invoices_with_rating_above returns empty for threshold 0\");\n    \n    let max_threshold = client.get_invoices_with_rating_above(\u00265);\n    assert_eq!(max_threshold.len(), 0, \"Should return empty for threshold 5 (above max possible)\");\n    println!(\" get_invoices_with_rating_above returns empty for threshold 5\");\n    \n    // Test investor tier and risk level filters\n    let basic_tier_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    assert_eq!(basic_tier_investors.len(), 0, \"Should return empty for Basic tier when no investors exist\");\n    println!(\" get_investors_by_tier returns empty for Basic tier\");\n    \n    let low_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Low);\n    assert_eq!(low_risk_investors.len(), 0, \"Should return empty for Low risk level when no investors exist\");\n    println!(\" get_investors_by_risk_level returns empty for Low risk level\");\n    \n    // Test invoice count methods\n    let pending_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_count, 0, \"Should return 0 for Pending status when no invoices exist\");\n    println!(\" get_invoice_count_by_status returns 0 for Pending status\");\n    \n    let total_count = client.get_total_invoice_count();\n    assert_eq!(total_count, 0, \"Should return 0 when no invoices exist\");\n    println!(\" get_total_invoice_count returns 0 when no invoices exist\");\n    \n    // Test analytics queries with no data\n    match client.try_get_platform_metrics() {\n        Ok(metrics) =\u003e {\n            assert_eq!(metrics.total_invoices, 0, \"Platform metrics should show 0 invoices\");\n            assert_eq!(metrics.total_volume, 0, \"Platform metrics should show 0 volume\");\n            println!(\" get_platform_metrics returns zeros when no data exists\");\n        },\n        Err(e) =\u003e println!(\" get_platform_metrics failed: {:?}\", e),\n    }\n    \n    match client.try_get_performance_metrics() {\n        Ok(metrics) =\u003e {\n            // These might have default values, just check they don't panic\n            println!(\" get_performance_metrics succeeds even with no data\");\n        },\n        Err(e) =\u003e println!(\" get_performance_metrics failed: {:?}\", e),\n    }\n    \n    // Test investor analytics with non-existent investor\n    match client.try_calculate_investor_analytics(\u0026non_existent_address) {\n        Ok(_) =\u003e println!(\" calculate_investor_analytics succeeds for non-existent investor\"),\n        Err(e) =\u003e println!(\" calculate_investor_analytics failed for non-existent investor: {:?}\", e),\n    }\n    \n    println!(\"\\n=== Edge Case Testing Complete ===\");\n    println!(\"All edge cases handled correctly:\");\n    println!(\"- Empty results return appropriate empty collections or zeros\");\n    println!(\"- Invalid parameters return None or fail gracefully\");\n    println!(\"- Boundary conditions are handled properly\");\n    println!(\"- No panics or unexpected errors\");\n}\n\n/// Test query functions with populated data to verify correct results\npub fn test_query_correctness_with_data() {\n    let env = Env::default();\n    env.mock_all_auths();\n    \n    // Register the contract\n    let contract_id = env.register_contract(None, QuickLendXContract);\n    let client = QuickLendXContractClient::new(\u0026env, \u0026contract_id);\n    \n    // Create test addresses\n    let admin = Address::generate(\u0026env);\n    let business1 = Address::generate(\u0026env);\n    let business2 = Address::generate(\u0026env);\n    let investor1 = Address::generate(\u0026env);\n    let investor2 = Address::generate(\u0026env);\n    let currency = Address::generate(\u0026env);\n    let due_date = env.ledger().timestamp() + 86400;\n    \n    println!(\"=== Testing Query Correctness with Data ===\");\n    \n    // Set up initial state\n    client.try_set_admin(\u0026admin).unwrap();\n    \n    // Create multiple businesses and verify them\n    client.try_submit_kyc_application(\u0026business1, \u0026String::from_str(\u0026env, \"Business 1 KYC\")).unwrap();\n    client.try_submit_kyc_application(\u0026business2, \u0026String::from_str(\u0026env, \"Business 2 KYC\")).unwrap();\n    client.try_verify_business(\u0026admin, \u0026business1).unwrap();\n    client.try_verify_business(\u0026admin, \u0026business2).unwrap();\n    \n    // Create multiple investors and verify them\n    client.try_submit_investor_kyc(\u0026investor1, \u0026String::from_str(\u0026env, \"Investor 1 KYC\")).unwrap();\n    client.try_submit_investor_kyc(\u0026investor2, \u0026String::from_str(\u0026env, \"Investor 2 KYC\")).unwrap();\n    client.try_verify_investor(\u0026investor1, \u00265000).unwrap();\n    client.try_verify_investor(\u0026investor2, \u002610000).unwrap();\n    \n    // Create multiple invoices with different categories and tags\n    let invoice1_id = client.try_store_invoice(\n        \u0026business1,\n        \u00265000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 1\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"urgent\"), String::from_str(\u0026env, \"services\")]\n    ).unwrap();\n    \n    let invoice2_id = client.try_store_invoice(\n        \u0026business1,\n        \u00267500,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 2\"),\n        \u0026InvoiceCategory::Goods,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"urgent\"), String::from_str(\u0026env, \"goods\")]\n    ).unwrap();\n    \n    let invoice3_id = client.try_store_invoice(\n        \u0026business2,\n        \u002610000,\n        \u0026currency,\n        \u0026due_date,\n        \u0026String::from_str(\u0026env, \"Invoice 3\"),\n        \u0026InvoiceCategory::Services,\n        \u0026vec![\u0026env, String::from_str(\u0026env, \"standard\"), String::from_str(\u0026env, \"services\")]\n    ).unwrap();\n    \n    // Verify invoices\n    client.try_verify_invoice(\u0026invoice1_id).unwrap();\n    client.try_verify_invoice(\u0026invoice2_id).unwrap();\n    client.try_verify_invoice(\u0026invoice3_id).unwrap();\n    \n    // Test correctness\n    println!(\"\\n1. Testing invoice queries correctness...\");\n    \n    // Get business invoices\n    let business1_invoices = client.get_business_invoices(\u0026business1);\n    assert_eq!(business1_invoices.len(), 2, \"Business 1 should have 2 invoices\");\n    assert!(business1_invoices.contains(\u0026invoice1_id), \"Should contain invoice1\");\n    assert!(business1_invoices.contains(\u0026invoice2_id), \"Should contain invoice2\");\n    println!(\" get_business_invoices returns correct invoices for business1\");\n    \n    let business2_invoices = client.get_business_invoices(\u0026business2);\n    assert_eq!(business2_invoices.len(), 1, \"Business 2 should have 1 invoice\");\n    assert!(business2_invoices.contains(\u0026invoice3_id), \"Should contain invoice3\");\n    println!(\" get_business_invoices returns correct invoices for business2\");\n    \n    // Get invoices by status\n    let verified_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_invoices.len(), 3, \"Should have 3 verified invoices\");\n    println!(\" get_invoices_by_status returns correct count for Verified\");\n    \n    let pending_invoices = client.get_invoices_by_status(\u0026InvoiceStatus::Pending);\n    assert_eq!(pending_invoices.len(), 0, \"Should have 0 pending invoices\");\n    println!(\" get_invoices_by_status returns correct count for Pending\");\n    \n    // Get available invoices (verified but not funded)\n    let available_invoices = client.get_available_invoices();\n    assert_eq!(available_invoices.len(), 3, \"Should have 3 available invoices\");\n    println!(\" get_available_invoices returns all verified invoices\");\n    \n    // Get invoices by category\n    let services_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Services);\n    assert_eq!(services_invoices.len(), 2, \"Should have 2 services invoices\");\n    println!(\" get_invoices_by_category returns correct count for Services\");\n    \n    let goods_invoices = client.get_invoices_by_category(\u0026InvoiceCategory::Goods);\n    assert_eq!(goods_invoices.len(), 1, \"Should have 1 goods invoice\");\n    println!(\" get_invoices_by_category returns correct count for Goods\");\n    \n    // Get invoices by tag\n    let urgent_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"urgent\"));\n    assert_eq!(urgent_invoices.len(), 2, \"Should have 2 urgent invoices\");\n    println!(\" get_invoices_by_tag returns correct count for 'urgent'\");\n    \n    let services_tag_invoices = client.get_invoices_by_tag(\u0026String::from_str(\u0026env, \"services\"));\n    assert_eq!(services_tag_invoices.len(), 2, \"Should have 2 services-tagged invoices\");\n    println!(\" get_invoices_by_tag returns correct count for 'services'\");\n    \n    // Get all categories\n    let all_categories = client.get_all_categories();\n    assert!(all_categories.contains(\u0026InvoiceCategory::Services), \"Should contain Services\");\n    assert!(all_categories.contains(\u0026InvoiceCategory::Goods), \"Should contain Goods\");\n    assert_eq!(all_categories.len(), 2, \"Should have 2 unique categories\");\n    println!(\" get_all_categories returns correct categories\");\n    \n    // Get invoice counts\n    let verified_count = client.get_invoice_count_by_status(\u0026InvoiceStatus::Verified);\n    assert_eq!(verified_count, 3, \"Should have 3 verified invoices\");\n    println!(\" get_invoice_count_by_status returns correct count\");\n    \n    let total_count = client.get_total_invoice_count();\n    assert_eq!(total_count, 3, \"Should have 3 total invoices\");\n    println!(\" get_total_invoice_count returns correct total\");\n    \n    println!(\"\\n2. Testing verification queries correctness...\");\n    \n    // Get verified businesses\n    let verified_businesses = client.get_verified_businesses();\n    assert_eq!(verified_businesses.len(), 2, \"Should have 2 verified businesses\");\n    assert!(verified_businesses.contains(\u0026business1), \"Should contain business1\");\n    assert!(verified_businesses.contains(\u0026business2), \"Should contain business2\");\n    println!(\" get_verified_businesses returns correct businesses\");\n    \n    // Get verified investors\n    let verified_investors = client.get_verified_investors();\n    assert_eq!(verified_investors.len(), 2, \"Should have 2 verified investors\");\n    assert!(verified_investors.contains(\u0026investor1), \"Should contain investor1\");\n    assert!(verified_investors.contains(\u0026investor2), \"Should contain investor2\");\n    println!(\" get_verified_investors returns correct investors\");\n    \n    // Get pending businesses/investors (should be empty)\n    let pending_businesses = client.get_pending_businesses();\n    assert_eq!(pending_businesses.len(), 0, \"Should have 0 pending businesses\");\n    println!(\" get_pending_businesses returns empty when all verified\");\n    \n    let pending_investors = client.get_pending_investors();\n    assert_eq!(pending_investors.len(), 0, \"Should have 0 pending investors\");\n    println!(\" get_pending_investors returns empty when all verified\");\n    \n    println!(\"\\n3. Testing investor tier and risk level queries...\");\n    \n    // Get investors by tier (both should be Basic by default)\n    let basic_investors = client.get_investors_by_tier(\u0026InvestorTier::Basic);\n    assert_eq!(basic_investors.len(), 2, \"Should have 2 basic tier investors\");\n    println!(\" get_investors_by_tier returns correct count for Basic tier\");\n    \n    // Get investors by risk level (should be Low by default)\n    let low_risk_investors = client.get_investors_by_risk_level(\u0026InvestorRiskLevel::Low);\n    assert_eq!(low_risk_investors.len(), 2, \"Should have 2 low risk investors\");\n    println!(\" get_investors_by_risk_level returns correct count for Low risk\");\n    \n    println!(\"\\n=== Query Correctness Testing Complete ===\");\n    println!(\"All queries return correct data when populated with test data.\");\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_all_queries() {\n        test_all_documented_queries();\n    }\n    \n    #[test]\n    fn test_edge_cases() {\n        test_query_edge_cases();\n    }\n    \n    #[test]\n    fn test_correctness_with_data() {\n        test_query_correctness_with_data();\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, ''),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '';
    }
  });
})();
</script>
</body>
</html>